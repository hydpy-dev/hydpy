<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydpy.core.netcdftools &#8212; HydPy 6.3dev0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=127cebf3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    
    <script src="../../../_static/documentation_options.js?v=6fd2034b"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 6.3dev0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.core.netcdftools</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/HydPy_Logo.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="../../../index.html">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example_projects.html">Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference_manual.html">Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zbibliography.html">Bibliography</a></li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hydpy.core.netcdftools</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module extends the features of module |filetools| for loading data from and</span>
<span class="sd">storing data to netCDF4 files, consistent with the `NetCDF Climate and Forecast (CF)</span>
<span class="sd">Metadata Conventions &lt;http://cfconventions.org/Data/cf-conventions/cf-conventions-1.8/</span>
<span class="sd">cf-conventions.html&gt;`_.</span>

<span class="sd">.. _`Delft-FEWS`: https://oss.deltares.nl/web/delft-fews</span>

<span class="sd">Usually, we only indirectly apply the features implemented in this module.  Here, we</span>
<span class="sd">demonstrate the underlying functionalities, which can be subsumed by the following</span>
<span class="sd">three steps:</span>

<span class="sd">  1. Call either method |SequenceManager.open_netcdfreader| or method</span>
<span class="sd">     |SequenceManager.open_netcdfwriter| of the |SequenceManager| object available in</span>
<span class="sd">     module |pub| to prepare a |NetCDFInterfaceReader| object for reading or a</span>
<span class="sd">     |NetCDFInterfaceWriter| object for writing.</span>
<span class="sd">  2. Call either the usual reading or writing methods of other HydPy classes like</span>
<span class="sd">     method |HydPy.load_fluxseries| of class |HydPy| or method</span>
<span class="sd">     |Elements.save_stateseries| of class |Elements|.  The prepared interface object</span>
<span class="sd">     collects all requests of those sequences one wants to read from or write to NetCDF</span>
<span class="sd">     files.</span>
<span class="sd">  3. Finalise reading or writing by calling either method</span>
<span class="sd">     |SequenceManager.close_netcdfreader| or |SequenceManager.close_netcdfwriter|.</span>

<span class="sd">Step 2 is a logging process only, telling the interface object which data needs to be</span>
<span class="sd">read or written, while step 3 triggers the actual reading from or writing to NetCDF</span>
<span class="sd">files.</span>

<span class="sd">During step 2, the interface object and its subobjects of type</span>
<span class="sd">|NetCDFVariableFlatReader|, |NetCDFVariableFlatWriter|, or |NetCDFVariableAggregated|</span>
<span class="sd">are accessible, allowing one to inspect their current state or modify their behaviour.</span>

<span class="sd">The following real code examples show how to perform these three steps both for reading</span>
<span class="sd">and writing data, based on the example configuration defined by function</span>
<span class="sd">|prepare_io_example_1|:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">&gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>

<span class="sd">We prepare a |NetCDFInterfaceWriter| object for writing data via method</span>
<span class="sd">|SequenceManager.open_netcdfwriter|:</span>

<span class="sd">&gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">&gt;&gt;&gt; pub.sequencemanager.open_netcdfwriter()</span>

<span class="sd">We tell the |SequenceManager| object to write all the time series data to NetCDF files:</span>

<span class="sd">&gt;&gt;&gt; pub.sequencemanager.filetype = &quot;nc&quot;</span>

<span class="sd">We store all the time series handled by the |Node| and |Element| objects of the example</span>
<span class="sd">dataset by calling |Nodes.save_allseries| of class |Nodes| and</span>
<span class="sd">|Elements.save_allseries| of class |Elements|.  (In real cases, you would not write the</span>
<span class="sd">`with TestIO():` line.  This code block makes sure we pollute the IO testing directory</span>
<span class="sd">instead of our current working directory):</span>

<span class="sd">&gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">&gt;&gt;&gt; with TestIO():</span>
<span class="sd">...     nodes.save_allseries()</span>
<span class="sd">...     elements.save_allseries()</span>

<span class="sd">We again log all sequences, but after telling the |SequenceManager| object to average</span>
<span class="sd">each time series spatially:</span>

<span class="sd">ToDo: Support spatial averaging for sequences of submodels.</span>

<span class="sd">&gt;&gt;&gt; with TestIO(), pub.sequencemanager.aggregation(&quot;mean&quot;):</span>
<span class="sd">...     nodes.save_allseries()</span>
<span class="sd">...     elements.element3.model.aetmodel.prepare_allseries(allocate_ram=False)</span>
<span class="sd">...     elements.save_allseries()</span>
<span class="sd">...     elements.element3.model.aetmodel.prepare_allseries(allocate_ram=True)</span>

<span class="sd">We can now navigate into the details of the logged time series data via the</span>
<span class="sd">|NetCDFInterfaceWriter| object and its |NetCDFVariableFlatReader| and</span>
<span class="sd">|NetCDFVariableAggregated| subobjects.  For example, we can query the logged flux</span>
<span class="sd">sequence objects of type |lland_fluxes.NKor| belonging to application model |lland_dd|</span>
<span class="sd">(those of elements `element1` and `element2`; the trailing numbers are the indices of</span>
<span class="sd">the relevant hydrological response units):</span>

<span class="sd">&gt;&gt;&gt; writer = pub.sequencemanager.netcdfwriter</span>
<span class="sd">&gt;&gt;&gt; writer.lland_dd_flux_nkor.subdevicenames</span>
<span class="sd">(&#39;element1_0&#39;, &#39;element2_0&#39;, &#39;element2_1&#39;)</span>

<span class="sd">In the example discussed here, all sequences belong to the same folder (`default`).</span>
<span class="sd">Storing sequences in separate folders means storing them in separate NetCDF files.  In</span>
<span class="sd">such cases, you must include the folder in the attribute name:</span>

<span class="sd">&gt;&gt;&gt; writer.foldernames</span>
<span class="sd">(&#39;default&#39;,)</span>
<span class="sd">&gt;&gt;&gt; writer.default_lland_dd_flux_nkor.subdevicenames</span>
<span class="sd">(&#39;element1_0&#39;, &#39;element2_0&#39;, &#39;element2_1&#39;)</span>

<span class="sd">We close the |NetCDFInterfaceWriter| object, which is the moment when the writing</span>
<span class="sd">process happens.  After that, the interface object is no longer available:</span>

<span class="sd">&gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">&gt;&gt;&gt; with TestIO():</span>
<span class="sd">...     pub.sequencemanager.close_netcdfwriter()</span>
<span class="sd">&gt;&gt;&gt; pub.sequencemanager.netcdfwriter</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">hydpy.core.exceptiontools.AttributeNotReady: The sequence file manager currently \</span>
<span class="sd">handles no NetCDF writer object. Consider applying the \</span>
<span class="sd">`pub.sequencemanager.netcdfwriting` context manager first (search in the \</span>
<span class="sd">documentation for help).</span>


<span class="sd">We set the time series values of two test sequences to zero to demonstrate that</span>
<span class="sd">reading the data back in actually works:</span>

<span class="sd">&gt;&gt;&gt; nodes.node2.sequences.sim.series = 0.0</span>
<span class="sd">&gt;&gt;&gt; elements.element2.model.sequences.fluxes.nkor.series = 0.0</span>

<span class="sd">We move up a gear and and prepare a |NetCDFInterfaceReader| object for reading data,</span>
<span class="sd">log all |NodeSequence| and |ModelSequence| objects, and read their time series data</span>
<span class="sd">from the created NetCDF file.  We temporarily disable the |Options.checkseries| option</span>
<span class="sd">to prevent raising an exception when reading incomplete data from the files:</span>

<span class="sd">&gt;&gt;&gt; with TestIO(), pub.options.checkseries(False):</span>
<span class="sd">...     pub.sequencemanager.open_netcdfreader()</span>
<span class="sd">...     nodes.load_simseries()</span>
<span class="sd">...     elements.load_allseries()</span>
<span class="sd">...     pub.sequencemanager.close_netcdfreader()</span>

<span class="sd">We check if the data is available via the test sequences again:</span>

<span class="sd">&gt;&gt;&gt; nodes.node2.sequences.sim.series</span>
<span class="sd">InfoArray([64., 65., 66., 67.])</span>
<span class="sd">&gt;&gt;&gt; elements.element2.model.sequences.fluxes.nkor.series</span>
<span class="sd">InfoArray([[16., 17.],</span>
<span class="sd">           [18., 19.],</span>
<span class="sd">           [20., 21.],</span>
<span class="sd">           [22., 23.]])</span>
<span class="sd">&gt;&gt;&gt; pub.sequencemanager.netcdfreader</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">hydpy.core.exceptiontools.AttributeNotReady: The sequence file manager currently \</span>
<span class="sd">handles no NetCDF reader object. Consider applying the \</span>
<span class="sd">`pub.sequencemanager.netcdfreading` context manager first (search in the \</span>
<span class="sd">documentation for help).</span>

<span class="sd">We cannot invert spatial aggregation.  Hence reading averaged time series is left for</span>
<span class="sd">postprocessing tools.  To show that writing the averaged series worked, we access both</span>
<span class="sd">relevant NetCDF files more directly using the underlying NetCDF4 library (note that</span>
<span class="sd">averaging 1-dimensional time series as those of node sequence |Sim| is allowed for the</span>
<span class="sd">sake of consistency):</span>

<span class="sd">&gt;&gt;&gt; from numpy import array</span>
<span class="sd">&gt;&gt;&gt; from hydpy import print_matrix</span>
<span class="sd">&gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">&gt;&gt;&gt; filepath = &quot;project/series/default/sim_q_mean.nc&quot;</span>
<span class="sd">&gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath) as ncfile:</span>
<span class="sd">...     print_matrix(array(ncfile[&quot;sim_q_mean&quot;][:]))</span>
<span class="sd">| 60.0 |</span>
<span class="sd">| 61.0 |</span>
<span class="sd">| 62.0 |</span>
<span class="sd">| 63.0 |</span>

<span class="sd">&gt;&gt;&gt; from hydpy import print_vector</span>
<span class="sd">&gt;&gt;&gt; filepath = &quot;project/series/default/lland_dd_flux_nkor_mean.nc&quot;</span>
<span class="sd">&gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath) as ncfile:</span>
<span class="sd">...         print_vector(array(ncfile[&quot;lland_dd_flux_nkor_mean&quot;][:])[:, 1])</span>
<span class="sd">16.5, 18.5, 20.5, 22.5</span>

<span class="sd">The previous examples relied on &quot;model-specific&quot; file names and variable names.  The</span>
<span class="sd">documentation on class |HydPy| introduces the standard &quot;HydPy&quot; convention as an</span>
<span class="sd">alternative for naming input time series files and demonstrates it for file types that</span>
<span class="sd">store the time series of single sequence instances.  Here, we take the input sequence</span>
<span class="sd">|lland_inputs.Nied| as an example to show that one can use its standard name</span>
<span class="sd">|StandardInputNames.PRECIPITATION| to read and write more generally named NetCDF files</span>
<span class="sd">and variables:</span>

<span class="sd">&gt;&gt;&gt; print_vector(elements.element2.model.sequences.inputs.nied.series)</span>
<span class="sd">4.0, 5.0, 6.0, 7.0</span>

<span class="sd">&gt;&gt;&gt; pub.sequencemanager.convention = &quot;HydPy&quot;</span>
<span class="sd">&gt;&gt;&gt; with TestIO():</span>
<span class="sd">...     elements.save_inputseries()</span>
<span class="sd">&gt;&gt;&gt; filepath = &quot;project/series/default/precipitation.nc&quot;</span>
<span class="sd">&gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath) as ncfile:</span>
<span class="sd">...         print_vector(array(ncfile[&quot;precipitation&quot;][:])[:, 1])</span>
<span class="sd">4.0, 5.0, 6.0, 7.0</span>

<span class="sd">&gt;&gt;&gt; elements.element2.model.sequences.inputs.nied.series = 0.0</span>
<span class="sd">&gt;&gt;&gt; with TestIO(), pub.options.checkseries(False):</span>
<span class="sd">...     elements.load_inputseries()</span>
<span class="sd">&gt;&gt;&gt; print_vector(elements.element2.model.sequences.inputs.nied.series)</span>
<span class="sd">4.0, 5.0, 6.0, 7.0</span>

<span class="sd">In the last example, the methods |Elements.load_inputseries| and</span>
<span class="sd">|Elements.save_inputseries| of class |Elements| opened and closed the required NetCDF</span>
<span class="sd">reader and writer objects automatically by using the context managers</span>
<span class="sd">|SequenceManager.netcdfreading| and |SequenceManager.netcdfwriting|.  Such comfort is</span>
<span class="sd">only available for these and the similar methods of the classes |HydPy|, |Elements|,</span>
<span class="sd">and |Nodes|.  If you, for example, apply the |IOSequence.load_series| or the</span>
<span class="sd">|IOSequence.save_series| method of individual |IOSequence| instances, you must activate</span>
<span class="sd">|SequenceManager.netcdfreading| or |SequenceManager.netcdfwriting| manually.  This</span>
<span class="sd">discomfort is intentional and should help prevent accidentally opening and closing</span>
<span class="sd">the same NetCDF file repeatedly, which could result in an immense waste of computation</span>
<span class="sd">time.  The following example shows how to apply these context managers manually and</span>
<span class="sd">that this does not conflict with using methods that could automatically open and close</span>
<span class="sd">NetCDF reader and writer objects:</span>

<span class="sd">&gt;&gt;&gt; sequences = elements.element2.model.sequences</span>
<span class="sd">&gt;&gt;&gt; sequences.inputs.nied.series = 1.0, 3.0, 5.0, 7.0</span>
<span class="sd">&gt;&gt;&gt; sequences.fluxes.qah.series = 2.0, 4.0, 6.0, 8.0</span>
<span class="sd">&gt;&gt;&gt; sequences.fluxes.qa.series = 3.0, 5.0, 7.0, 9.0</span>
<span class="sd">&gt;&gt;&gt; with TestIO(), pub.sequencemanager.netcdfwriting():</span>
<span class="sd">...     sequences.fluxes.qa.save_series()</span>
<span class="sd">...     elements.save_inputseries()</span>
<span class="sd">...     sequences.fluxes.qah.save_series()</span>

<span class="sd">&gt;&gt;&gt; sequences.inputs.nied.series = 0.0</span>
<span class="sd">&gt;&gt;&gt; sequences.fluxes.qah.series = 0.0</span>
<span class="sd">&gt;&gt;&gt; sequences.fluxes.qa.series = 0.0</span>
<span class="sd">&gt;&gt;&gt; with TestIO(), pub.options.checkseries(False), pub.sequencemanager.netcdfreading():</span>
<span class="sd">...     sequences.fluxes.qah.load_series()</span>
<span class="sd">...     elements.load_inputseries()</span>
<span class="sd">...     sequences.fluxes.qa.load_series()</span>
<span class="sd">&gt;&gt;&gt; print_vector(sequences.inputs.nied.series)</span>
<span class="sd">1.0, 3.0, 5.0, 7.0</span>
<span class="sd">&gt;&gt;&gt; print_vector(sequences.fluxes.qah.series)</span>
<span class="sd">2.0, 4.0, 6.0, 8.0</span>
<span class="sd">&gt;&gt;&gt; print_vector(sequences.fluxes.qa.series)</span>
<span class="sd">3.0, 5.0, 7.0, 9.0</span>

<span class="sd">Besides the testing-related specialities, the described workflow is more or less</span>
<span class="sd">standard but allows for different modifications.  We illustrate them in the</span>
<span class="sd">documentation of the other features implemented in module |netcdftools| and the</span>
<span class="sd">documentation on class |SequenceManager| of module |filetools| and class |IOSequence|</span>
<span class="sd">of module |sequencetools|.</span>

<span class="sd">Using the NetCDF format allows reading or writing data &quot;just in time&quot; during simulation</span>
<span class="sd">runs.  The documentation of class &quot;HydPy&quot; explains how to select and set the relevant</span>
<span class="sd">|IOSequence| objects for this option.  See the documentation on method</span>
<span class="sd">|NetCDFInterfaceJIT.provide_jitaccess| of class |NetCDFInterfaceJIT| for more in-depth</span>
<span class="sd">information.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># import...</span>
<span class="c1"># ...from standard library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="c1"># ...from site-packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">netCDF4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">netcdf4</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>

<span class="c1"># ...from HydPy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hydpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">devicetools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">objecttools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">printtools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">sequencetools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">timetools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core.typingtools</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">dimmapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;nmb_timepoints&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nmb_subdevices&quot;</span><span class="p">:</span> <span class="s2">&quot;stations&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nmb_characters&quot;</span><span class="p">:</span> <span class="s2">&quot;char_leng_name&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Dimension-related terms within NetCDF files.</span>

<span class="sd">You can change this mapping if it does not suit your requirements.  For example, change </span>
<span class="sd">the value of the keyword &quot;nmb_subdevices&quot; if you prefer to call this dimension </span>
<span class="sd">&quot;location&quot; instead of &quot;stations&quot; within NetCDF files:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.core.netcdftools import dimmapping</span>
<span class="sd">&gt;&gt;&gt; dimmapping[&quot;nmb_subdevices&quot;] = &quot;location&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">varmapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;timepoints&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;subdevices&quot;</span><span class="p">:</span> <span class="s2">&quot;station_id&quot;</span><span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Variable-related terms within NetCDF files.</span>

<span class="sd">You can change this mapping if it does not suit your requirements.  For example, change </span>
<span class="sd">the value of the keyword &quot;timepoints&quot; if you prefer to call this variable &quot;period&quot; </span>
<span class="sd">instead of &quot;time&quot; within NetCDF files:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.core.netcdftools import varmapping</span>
<span class="sd">&gt;&gt;&gt; varmapping[&quot;timepoints&quot;] = &quot;period&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">fillvalue</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
<span class="sd">&quot;&quot;&quot;Default fill value for writing NetCDF files.</span>

<span class="sd">You can set another |float| value before writing a NetCDF file:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.core import netcdftools</span>
<span class="sd">&gt;&gt;&gt; netcdftools.fillvalue = -777.0</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">TypeNetCDFVariable</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;TypeNetCDFVariable&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;NetCDFVariable&quot;</span><span class="p">)</span>

<span class="n">FlatUnion</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;NetCDFVariableFlatReader&quot;</span><span class="p">,</span> <span class="s2">&quot;NetCDFVariableFlatWriter&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="summarise_ncfile">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.summarise_ncfile">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">summarise_ncfile</span><span class="p">(</span><span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Give a summary describing (a HydPy-compatible) NetCDF file.</span>

<span class="sd">    You can pass the file path:</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import data, repr_, summarise_ncfile</span>
<span class="sd">    &gt;&gt;&gt; filepath = os.path.join(</span>
<span class="sd">    ...     data.__path__[0], &quot;HydPy-H-Lahn&quot;, &quot;series&quot;, &quot;default&quot;, &quot;hland_96_input_p.nc&quot;</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; print(repr_(summarise_ncfile(filepath)))  # doctest: +ELLIPSIS</span>
<span class="sd">    GENERAL</span>
<span class="sd">        file path = .../hydpy/data/HydPy-H-Lahn/series/default/hland_96_input_p.nc</span>
<span class="sd">        file format = NETCDF4</span>
<span class="sd">        disk format = HDF5</span>
<span class="sd">        Attributes</span>
<span class="sd">            hydts_timeRef = begin</span>
<span class="sd">            title = Daily total precipitation sum HydPy-H-HBV96 model river Lahn</span>
<span class="sd">            ...</span>
<span class="sd">    DIMENSIONS</span>
<span class="sd">        stations = 4</span>
<span class="sd">        time = 11384</span>
<span class="sd">        str_len = 40</span>
<span class="sd">    VARIABLES</span>
<span class="sd">        time</span>
<span class="sd">            dimensions = time</span>
<span class="sd">            shape = 11384</span>
<span class="sd">            data type = float64</span>
<span class="sd">            Attributes</span>
<span class="sd">                units = days since 1900-01-01 00:00:00 +0100</span>
<span class="sd">                long_name = time</span>
<span class="sd">                axis = T</span>
<span class="sd">                calendar = standard</span>
<span class="sd">        hland_96_input_p</span>
<span class="sd">            dimensions = time, stations</span>
<span class="sd">            shape = 11384, 4</span>
<span class="sd">            data type = float64</span>
<span class="sd">            Attributes</span>
<span class="sd">                units = mm</span>
<span class="sd">                _FillValue = -9999.0</span>
<span class="sd">                long_name = Daily Precipitation Sum</span>
<span class="sd">        station_id</span>
<span class="sd">            dimensions = stations, str_len</span>
<span class="sd">            shape = 4, 40</span>
<span class="sd">            data type = |S1</span>
<span class="sd">            Attributes</span>
<span class="sd">                long_name = station or node identification code</span>
<span class="sd">        station_names</span>
<span class="sd">            dimensions = stations, str_len</span>
<span class="sd">            shape = 4, 40</span>
<span class="sd">            data type = |S1</span>
<span class="sd">            Attributes</span>
<span class="sd">                long_name = station or node name</span>
<span class="sd">        river_names</span>
<span class="sd">            dimensions = stations, str_len</span>
<span class="sd">            shape = 4, 40</span>
<span class="sd">            data type = |S1</span>
<span class="sd">            Attributes</span>
<span class="sd">                long_name = river name</span>
<span class="sd">    TIME GRID</span>
<span class="sd">        first date = 1989-11-01 00:00:00+01:00</span>
<span class="sd">        last date = 2021-01-01 00:00:00+01:00</span>
<span class="sd">        step size = 1d</span>

<span class="sd">    Alternatively, you can pass a NetCDF4 `Dataset` object:</span>

<span class="sd">    &gt;&gt;&gt; from netCDF4 import Dataset</span>
<span class="sd">    &gt;&gt;&gt; with Dataset(filepath, &quot;r&quot;) as ncfile:</span>
<span class="sd">    ...     print(repr_(summarise_ncfile(ncfile)))  # doctest: +ELLIPSIS</span>
<span class="sd">    GENERAL</span>
<span class="sd">        file path = ...data/HydPy-H-Lahn/series/default/hland_96_input_p.nc</span>
<span class="sd">    ...</span>
<span class="sd">                _FillValue = -9999.0</span>
<span class="sd">    ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize</span><span class="p">(</span><span class="n">nc</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

        <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>

        <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">append</span><span class="p">(</span><span class="s2">&quot;GENERAL&quot;</span><span class="p">)</span>
        <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">file path = </span><span class="si">{</span><span class="n">nc</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">file format = </span><span class="si">{</span><span class="n">nc</span><span class="o">.</span><span class="n">file_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">disk format = </span><span class="si">{</span><span class="n">nc</span><span class="o">.</span><span class="n">disk_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attrs_file</span> <span class="o">:=</span> <span class="n">nc</span><span class="o">.</span><span class="n">ncattrs</span><span class="p">():</span>
            <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">Attributes&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr_file</span> <span class="ow">in</span> <span class="n">attrs_file</span><span class="p">:</span>
                <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i2</span><span class="si">}{</span><span class="n">attr_file</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">nc</span><span class="o">.</span><span class="n">getncattr</span><span class="p">(</span><span class="n">attr_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dims</span> <span class="o">:=</span> <span class="n">nc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="n">append</span><span class="p">(</span><span class="s2">&quot;DIMENSIONS&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}{</span><span class="n">name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">dim</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vars_</span> <span class="o">:=</span> <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">append</span><span class="p">(</span><span class="s2">&quot;VARIABLES&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i2</span><span class="si">}</span><span class="s2">dimensions = </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i2</span><span class="si">}</span><span class="s2">shape = </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i2</span><span class="si">}</span><span class="s2">data type = </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">datatype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attrs_var</span> <span class="o">:=</span> <span class="n">var</span><span class="o">.</span><span class="n">ncattrs</span><span class="p">():</span>
                    <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i2</span><span class="si">}</span><span class="s2">Attributes&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">attr_var</span> <span class="ow">in</span> <span class="n">attrs_var</span><span class="p">:</span>
                        <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i3</span><span class="si">}{</span><span class="n">attr_var</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">getncattr</span><span class="p">(</span><span class="n">attr_var</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">timereference</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="s2">&quot;timereference&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timereference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">append</span><span class="p">(</span><span class="s2">&quot;TIME GRID&quot;</span><span class="p">)</span>
            <span class="n">tg</span> <span class="o">=</span> <span class="n">_query_timegrid</span><span class="p">(</span><span class="n">ncfile</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">timereference</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">))</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span>
            <span class="n">firstdate</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">firstdate</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;iso2&quot;</span><span class="p">,</span> <span class="n">utcoffset</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">)</span>
            <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">first date = </span><span class="si">{</span><span class="n">firstdate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lastdate</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">lastdate</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;iso2&quot;</span><span class="p">,</span> <span class="n">utcoffset</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">)</span>
            <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">last date = </span><span class="si">{</span><span class="n">lastdate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">step size = </span><span class="si">{</span><span class="n">tg</span><span class="o">.</span><span class="n">stepsize</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile_</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_summarize</span><span class="p">(</span><span class="n">ncfile_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_summarize</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_ncfile">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.write_ncfile">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_ncfile</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VectorInputFloat</span><span class="p">]],</span>
    <span class="n">timegrid</span><span class="p">:</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Timegrid</span><span class="p">,</span>
    <span class="n">timereference</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cfunit</span><span class="p">:</span> <span class="n">timetools</span><span class="o">.</span><span class="n">TypeUnit</span> <span class="o">=</span> <span class="s2">&quot;hours&quot;</span><span class="p">,</span>
    <span class="n">cfconvention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">namingconvention</span><span class="p">:</span> <span class="n">SeriesConventionType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">history</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a NetCDF file that is, depending on your choices, more or less compatible</span>
<span class="sd">    with usual HydPy NetCDF time series files.</span>

<span class="sd">    At least, you need to supply the filepath, the sequence&#39;s name (the name of the</span>
<span class="sd">    NetCDF variable that stores the actual time series data), the time series data (as</span>
<span class="sd">    tuples of names and floating point vectors), and a |Timegrid| instance (for the</span>
<span class="sd">    temporal referencing of the given time series):</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO, Timegrid, write_ncfile</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     write_ncfile(</span>
<span class="sd">    ...         filepath=&quot;my_ncfile.nc&quot;,</span>
<span class="sd">    ...         sequence=&quot;my_sequence&quot;,</span>
<span class="sd">    ...         data=[(&quot;series_1&quot;, [1.0, 2.0, 3.0]), (&quot;series_2&quot;, [2.0, 3.0, 4.0])],</span>
<span class="sd">    ...         timegrid=Timegrid(&quot;2000-01-01&quot;, &quot;2000-01-04&quot;, &quot;1d&quot;),</span>
<span class="sd">    ...     )</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import summarise_ncfile</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     print(summarise_ncfile(&quot;my_ncfile.nc&quot;))</span>
<span class="sd">    GENERAL</span>
<span class="sd">        file path = my_ncfile.nc</span>
<span class="sd">        file format = NETCDF4</span>
<span class="sd">        disk format = HDF5</span>
<span class="sd">        Attributes</span>
<span class="sd">            history = Created ... by HydPy ...</span>
<span class="sd">            sequence = my_sequence</span>
<span class="sd">    DIMENSIONS</span>
<span class="sd">        time = 3</span>
<span class="sd">        stations = 2</span>
<span class="sd">        char_leng_name = 8</span>
<span class="sd">    VARIABLES</span>
<span class="sd">        time</span>
<span class="sd">            dimensions = time</span>
<span class="sd">            shape = 3</span>
<span class="sd">            data type = float64</span>
<span class="sd">            Attributes</span>
<span class="sd">                long_name = time</span>
<span class="sd">                units = hours since 2000-01-01 00:00:00 +01:00</span>
<span class="sd">                standard_name = time</span>
<span class="sd">                calendar = standard</span>
<span class="sd">        station_id</span>
<span class="sd">            dimensions = stations, char_leng_name</span>
<span class="sd">            shape = 2, 8</span>
<span class="sd">            data type = |S1</span>
<span class="sd">            Attributes</span>
<span class="sd">                long_name = station_id</span>
<span class="sd">        my_sequence</span>
<span class="sd">            dimensions = time, stations</span>
<span class="sd">            shape = 3, 2</span>
<span class="sd">            data type = float64</span>
<span class="sd">            Attributes</span>
<span class="sd">                _FillValue = nan</span>
<span class="sd">                long_name = my_sequence</span>

<span class="sd">    &gt;&gt;&gt; from netCDF4 import Dataset</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import chars2str, print_vector</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     with Dataset(&quot;my_ncfile.nc&quot;) as ncfile:</span>
<span class="sd">    ...         Timegrid.from_timepoints(ncfile[&quot;time&quot;][:], &quot;2000-01-01&quot;, &quot;hours&quot;)</span>
<span class="sd">    ...         for i, subdevice in enumerate(chars2str(ncfile[&quot;station_id&quot;])):</span>
<span class="sd">    ...             print(subdevice, end=&quot;: &quot;)</span>
<span class="sd">    ...             print_vector(ncfile[&quot;my_sequence&quot;][:, i])</span>
<span class="sd">    Timegrid(&quot;2000-01-01 00:00:00&quot;,</span>
<span class="sd">             &quot;2000-01-04 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>
<span class="sd">    series_1: 1.0, 2.0, 3.0</span>
<span class="sd">    series_2: 2.0, 3.0, 4.0</span>

<span class="sd">    Function |write_ncfile| checks if all time series fit the given |Timegrid|</span>
<span class="sd">    instance:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     write_ncfile(</span>
<span class="sd">    ...         filepath=&quot;my_ncfile.nc&quot;,</span>
<span class="sd">    ...         sequence=&quot;my_sequence&quot;,</span>
<span class="sd">    ...         data=[(&quot;series_1&quot;, [1.0, 2.0, 3.0]), (&quot;series_2&quot;, [2.0, 3.0])],</span>
<span class="sd">    ...         timegrid=Timegrid(&quot;2000-01-01&quot;, &quot;2000-01-04&quot;, &quot;1d&quot;),</span>
<span class="sd">    ...     )</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: While trying to write the NetCDF file `my_ncfile.nc`, the following \</span>
<span class="sd">error occurred: According to the given timegrid, all given series must have a length \</span>
<span class="sd">of `3`, but the length of series `series_2` is `2`.</span>

<span class="sd">    When creating the following NetCDF file, we use all possible ways to add more</span>
<span class="sd">    metadata and follow one of the available conventions for naming the NetCDF sequence</span>
<span class="sd">    variable, which would make it safely usable in a hypothetical two-basin project:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     write_ncfile(</span>
<span class="sd">    ...         filepath=&quot;air_temperature.nc&quot;,</span>
<span class="sd">    ...         sequence=&quot;air_temperature&quot;,</span>
<span class="sd">    ...         data=[(&quot;basin_1&quot;, [1.0, 2.0, 3.0]), (&quot;basin_2&quot;, [2.0, 3.0, 4.0])],</span>
<span class="sd">    ...         timegrid=Timegrid(&quot;2000-01-01&quot;, &quot;2000-01-04&quot;, &quot;1d&quot;),</span>
<span class="sd">    ...         timereference=&quot;right&quot;,</span>
<span class="sd">    ...         cfunit=&quot;days&quot;,</span>
<span class="sd">    ...         cfconvention=&quot;CF-1.8&quot;,</span>
<span class="sd">    ...         namingconvention=&quot;HydPy&quot;,</span>
<span class="sd">    ...         history=&quot;Created for testing only.&quot;,</span>
<span class="sd">    ...     )</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     print(summarise_ncfile(&quot;air_temperature.nc&quot;))</span>
<span class="sd">    GENERAL</span>
<span class="sd">        file path = air_temperature.nc</span>
<span class="sd">        ...</span>
<span class="sd">        Attributes</span>
<span class="sd">            history = Created for testing only.</span>
<span class="sd">            sequence = air_temperature (naming convention: HydPy)</span>
<span class="sd">            Conventions = CF-1.8</span>
<span class="sd">            timereference = right interval boundary</span>
<span class="sd">    DIMENSIONS</span>
<span class="sd">    ...</span>
<span class="sd">                units = days since 2000-01-01 00:00:00 +01:00</span>
<span class="sd">    ...</span>
<span class="sd">    TIME GRID</span>
<span class="sd">        first date = 2000-01-01 00:00:00+01:00</span>
<span class="sd">        last date = 2000-01-04 00:00:00+01:00</span>
<span class="sd">        step size = 1d</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     with Dataset(&quot;air_temperature.nc&quot;) as nc:</span>
<span class="sd">    ...         with pub.options.timestampleft(False):</span>
<span class="sd">    ...             Timegrid.from_timepoints(nc[&quot;time&quot;][:], &quot;2000-01-01&quot;, &quot;days&quot;)</span>
<span class="sd">    ...         for i, subdevice in enumerate(chars2str(nc[&quot;station_id&quot;])):</span>
<span class="sd">    ...             print(subdevice, end=&quot;: &quot;)</span>
<span class="sd">    ...             print_vector(nc[&quot;air_temperature&quot;][:, i])</span>
<span class="sd">    Timegrid(&quot;2000-01-01 00:00:00&quot;,</span>
<span class="sd">             &quot;2000-01-04 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>
<span class="sd">    basin_1: 1.0, 2.0, 3.0</span>
<span class="sd">    basin_2: 2.0, 3.0, 4.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">subdevicenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdevicenames</span><span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timegrid</span><span class="p">)</span>
        <span class="n">seriesmatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">NP_FLOAT</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">subdevicename</span><span class="p">,</span> <span class="n">seriesvector</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seriesvector</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nrows</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;According to the given timegrid, all given series must have a &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;length of `</span><span class="si">{</span><span class="n">nrows</span><span class="si">}</span><span class="s2">`, but the length of series `</span><span class="si">{</span><span class="n">subdevicename</span><span class="si">}</span><span class="s2">` &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;is `</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">seriesvector</span><span class="p">)</span><span class="si">}</span><span class="s2">`.&quot;</span>
                <span class="p">)</span>
            <span class="n">seriesmatrix</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">seriesvector</span>
        <span class="n">MixinVariableWriter</span><span class="o">.</span><span class="n">__hydpy_write_ncfile__</span><span class="p">(</span>
            <span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
            <span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">,</span>
            <span class="n">subdevicenames</span><span class="o">=</span><span class="n">subdevicenames</span><span class="p">,</span>
            <span class="n">seriesmatrix</span><span class="o">=</span><span class="n">seriesmatrix</span><span class="p">,</span>
            <span class="n">timegrid</span><span class="o">=</span><span class="n">timegrid</span><span class="p">,</span>
            <span class="n">timereference</span><span class="o">=</span><span class="n">timereference</span><span class="p">,</span>
            <span class="n">cfunit</span><span class="o">=</span><span class="n">cfunit</span><span class="p">,</span>
            <span class="n">cfconvention</span><span class="o">=</span><span class="n">cfconvention</span><span class="p">,</span>
            <span class="n">namingconvention</span><span class="o">=</span><span class="n">namingconvention</span><span class="p">,</span>
            <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;While trying to write the NetCDF file `</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">`&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="str2chars">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.str2chars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">str2chars</span><span class="p">(</span><span class="n">strings</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MatrixBytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a |numpy.ndarray| object containing the byte characters (second axis) of</span>
<span class="sd">    all given strings (first axis).</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import str2chars</span>
<span class="sd">    &gt;&gt;&gt; str2chars([&#39;street&#39;, &#39;St.&#39;, &#39;Strae&#39;, &#39;Str.&#39;])</span>
<span class="sd">    array([[b&#39;s&#39;, b&#39;t&#39;, b&#39;r&#39;, b&#39;e&#39;, b&#39;e&#39;, b&#39;t&#39;, b&#39;&#39;],</span>
<span class="sd">           [b&#39;S&#39;, b&#39;t&#39;, b&#39;.&#39;, b&#39;&#39;, b&#39;&#39;, b&#39;&#39;, b&#39;&#39;],</span>
<span class="sd">           [b&#39;S&#39;, b&#39;t&#39;, b&#39;r&#39;, b&#39;a&#39;, b&#39;\xc3&#39;, b&#39;\x9f&#39;, b&#39;e&#39;],</span>
<span class="sd">           [b&#39;S&#39;, b&#39;t&#39;, b&#39;r&#39;, b&#39;.&#39;, b&#39;&#39;, b&#39;&#39;, b&#39;&#39;]], dtype=&#39;|S1&#39;)</span>

<span class="sd">    &gt;&gt;&gt; str2chars([])</span>
<span class="sd">    array([], shape=(0, 0), dtype=&#39;|S1&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;|S1&quot;</span><span class="p">)</span>
    <span class="n">bytess</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">)</span>
    <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span> <span class="k">for</span> <span class="n">bytes_</span> <span class="ow">in</span> <span class="n">bytess</span><span class="p">)</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">),</span> <span class="n">max_length</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;|S1&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">bytes_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bytess</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">int_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bytes_</span><span class="p">):</span>
            <span class="n">chars</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">jdx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">int_</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">chars</span></div>



<div class="viewcode-block" id="chars2str">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.chars2str">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">chars2str</span><span class="p">(</span><span class="n">chars</span><span class="p">:</span> <span class="n">MatrixBytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Inversion function of |str2chars|.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import chars2str</span>

<span class="sd">    &gt;&gt;&gt; chars2str([[b&quot;s&quot;, b&quot;t&quot;, b&quot;r&quot;, b&quot;e&quot;, b&quot;e&quot;, b&quot;t&quot;, b&quot;&quot;],</span>
<span class="sd">    ...            [b&quot;S&quot;, b&quot;t&quot;, b&quot;.&quot;, b&quot;&quot;, b&quot;&quot;, b&quot;&quot;, b&quot;&quot;],</span>
<span class="sd">    ...            [b&quot;S&quot;, b&quot;t&quot;, b&quot;r&quot;, b&quot;a&quot;, b&quot;\xc3&quot;, b&quot;\x9f&quot;, b&quot;e&quot;],</span>
<span class="sd">    ...            [b&quot;S&quot;, b&quot;t&quot;, b&quot;r&quot;, b&quot;.&quot;, b&quot;&quot;, b&quot;&quot;, b&quot;&quot;]])</span>
<span class="sd">    [&#39;street&#39;, &#39;St.&#39;, &#39;Strae&#39;, &#39;Str.&#39;]</span>

<span class="sd">    &gt;&gt;&gt; chars2str([])</span>
<span class="sd">    []</span>

<span class="sd">    &gt;&gt;&gt; chars2str([[b&quot;s&quot;, b&quot;t&quot;, b&quot;r&quot;, b&quot;e&quot;, b&quot;e&quot;, b&quot;t&quot;],</span>
<span class="sd">    ...            [b&quot;S&quot;, b&quot;t&quot;, b&quot;.&quot;, b&quot;&quot;, b&quot;&quot;, b&quot;&quot;],</span>
<span class="sd">    ...            [b&quot;S&quot;, b&quot;t&quot;, b&quot;r&quot;, b&quot;a&quot;, b&quot;\xc3&quot;, b&quot;e&quot;],</span>
<span class="sd">    ...            [b&quot;S&quot;, b&quot;t&quot;, b&quot;r&quot;, b&quot;.&quot;, b&quot;&quot;, b&quot;&quot;]])</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: Cannot decode `b&#39;Stra\xc3e&#39;` (not UTF-8 compliant).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subchars</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bytes_</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subchars</span><span class="p">)</span>
            <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bytes_</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot decode `</span><span class="si">{</span><span class="n">bytes_</span><span class="si">!r}</span><span class="s2">` (not UTF-8 compliant).&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
    <span class="k">return</span> <span class="n">strings</span></div>



<div class="viewcode-block" id="create_dimension">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.create_dimension">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new dimension with the given name and length to the given NetCDF file.</span>

<span class="sd">    Essentially, |create_dimension| only calls the equally named method of the NetCDF</span>
<span class="sd">    library but adds information to possible error messages:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_dimension</span>
<span class="sd">    &gt;&gt;&gt; create_dimension(ncfile, &quot;dim1&quot;, 5)</span>
<span class="sd">    &gt;&gt;&gt; dim = ncfile.dimensions[&quot;dim1&quot;]</span>
<span class="sd">    &gt;&gt;&gt; dim.size if hasattr(dim, &quot;size&quot;) else dim</span>
<span class="sd">    5</span>

<span class="sd">    &gt;&gt;&gt; try:</span>
<span class="sd">    ...     create_dimension(ncfile, &quot;dim1&quot;, 5)</span>
<span class="sd">    ... except BaseException as exc:</span>
<span class="sd">    ...     print(exc)  # doctest: +ELLIPSIS</span>
<span class="sd">    While trying to add dimension `dim1` with length `5` to the NetCDF file \</span>
<span class="sd">`test.nc`, the following error occurred: ...</span>

<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;While trying to add dimension `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` with length `</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">` to the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;NetCDF file `</span><span class="si">{</span><span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span><span class="si">}</span><span class="s2">`&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="create_variable">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.create_variable">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_variable</span><span class="p">(</span>
    <span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">datatype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new variable with the given name, datatype, and dimensions to the given</span>
<span class="sd">    NetCDF file.</span>

<span class="sd">    Essentially, |create_variable| only calls the equally named method of the NetCDF</span>
<span class="sd">    library but adds information to possible error messages:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_variable</span>
<span class="sd">    &gt;&gt;&gt; try:</span>
<span class="sd">    ...     create_variable(ncfile, &quot;var1&quot;, &quot;f8&quot;, (&quot;dim1&quot;,))</span>
<span class="sd">    ... except BaseException as exc:</span>
<span class="sd">    ...     print(str(exc).strip(&#39;&quot;&#39;))  # doctest: +ELLIPSIS</span>
<span class="sd">    While trying to add variable `var1` with datatype `f8` and dimensions `(&#39;dim1&#39;,)` \</span>
<span class="sd">to the NetCDF file `test.nc`, the following error occurred: ...</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_dimension</span>
<span class="sd">    &gt;&gt;&gt; create_dimension(ncfile, &quot;dim1&quot;, 5)</span>
<span class="sd">    &gt;&gt;&gt; create_variable(ncfile, &quot;var1&quot;, &quot;f8&quot;, (&quot;dim1&quot;,))</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import print_vector</span>
<span class="sd">    &gt;&gt;&gt; print_vector(numpy.array(ncfile[&quot;var1&quot;][:]))</span>
<span class="sd">    nan, nan, nan, nan, nan</span>

<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">fillvalue</span> <span class="k">if</span> <span class="p">(</span><span class="n">datatype</span> <span class="o">==</span> <span class="s2">&quot;f8&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>
        <span class="n">ncfile</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;While trying to add variable `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` with datatype `</span><span class="si">{</span><span class="n">datatype</span><span class="si">}</span><span class="s2">` and &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;dimensions `</span><span class="si">{</span><span class="n">dimensions</span><span class="si">}</span><span class="s2">` to the NetCDF file `</span><span class="si">{</span><span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span><span class="si">}</span><span class="s2">`&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="query_variable">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.query_variable">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">query_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Variable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the variable with the given name from the given NetCDF file.</span>

<span class="sd">    Essentially, |query_variable| only queries the variable via keyword access using</span>
<span class="sd">    the NetCDF library but adds information to possible error messages:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import query_variable</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     file_ = netcdf4.Dataset(&quot;model.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; query_variable(file_, &quot;values&quot;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: NetCDF file `model.nc` does not contain variable `values`.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_variable</span>
<span class="sd">    &gt;&gt;&gt; create_variable(file_, &quot;values&quot;, &quot;f8&quot;, ())</span>
<span class="sd">    &gt;&gt;&gt; assert isinstance(query_variable(file_, &quot;values&quot;), netcdf4.Variable)</span>

<span class="sd">    &gt;&gt;&gt; file_.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;NetCDF file `</span><span class="si">{</span><span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span><span class="si">}</span><span class="s2">` does not contain variable `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span></div>



<div class="viewcode-block" id="query_timegrid">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.query_timegrid">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">query_timegrid</span><span class="p">(</span>
    <span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Timegrid</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the |Timegrid| defined by the given NetCDF file.</span>

<span class="sd">    |query_timegrid| relies on the `timereference` attribute of the given NetCDF file,</span>
<span class="sd">    if available, and falls back to the global |Options.timestampleft| option when</span>
<span class="sd">    necessary.  The NetCDF files of the `HydPy-H-Lahn` example project (and all other</span>
<span class="sd">    NetCDF files written by *HydPy*) include such information:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">    &gt;&gt;&gt; from netCDF4 import Dataset</span>
<span class="sd">    &gt;&gt;&gt; filepath = &quot;HydPy-H-Lahn/series/default/hland_96_input_p.nc&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     ncfile.timereference</span>
<span class="sd">    &#39;left interval boundary&#39;</span>

<span class="sd">    We start our examples considering the input sequence |hland_inputs.P|, which</span>
<span class="sd">    handles precipitation sums.  |query_timegrid| requires an instance of</span>
<span class="sd">    |hland_inputs.P| to determine that each value of the time series of the NetCDF file</span>
<span class="sd">    references a time interval and not a time point:</span>

<span class="sd">    &gt;&gt;&gt; p = hp.elements.land_dill_assl.model.sequences.inputs.p</span>

<span class="sd">    If the file-specific setting does not conflict with the current value of</span>
<span class="sd">    |Options.timestampleft|, |query_timegrid| works silently:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import query_timegrid</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, p)</span>
<span class="sd">    Timegrid(&quot;1989-11-01 00:00:00&quot;,</span>
<span class="sd">             &quot;2021-01-01 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>

<span class="sd">    If a file-specific setting is missing, |query_timegrid| applies the current</span>
<span class="sd">    |Options.timestampleft| value:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath, &quot;r+&quot;) as ncfile:</span>
<span class="sd">    ...     del ncfile.timereference</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import warn_later</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, p)</span>
<span class="sd">    Timegrid(&quot;1989-11-01 00:00:00&quot;,</span>
<span class="sd">             &quot;2021-01-01 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath) as ncfile, pub.options.timestampleft(False):</span>
<span class="sd">    ...     query_timegrid(ncfile, p)</span>
<span class="sd">    Timegrid(&quot;1989-10-31 00:00:00&quot;,</span>
<span class="sd">             &quot;2020-12-31 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>

<span class="sd">    If the file-specific setting and |Options.timestampleft| conflict, |query_timegrid|</span>
<span class="sd">    favours the file attribute and warns about this assumption:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath, &quot;r+&quot;) as ncfile:</span>
<span class="sd">    ...     ncfile.timereference = &quot;right interval boundary&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), warn_later(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, p)  # doctest: +ELLIPSIS</span>
<span class="sd">    Timegrid(&quot;1989-10-31 00:00:00&quot;,</span>
<span class="sd">             &quot;2020-12-31 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>
<span class="sd">    UserWarning: The `timereference` attribute (`right interval boundary`) of the \</span>
<span class="sd">NetCDF file `HydPy-H-Lahn/series/default/hland_96_input_p.nc` conflicts with the \</span>
<span class="sd">current value of the global `timestampleft` option (`True`).  The file-specific \</span>
<span class="sd">information is prioritised.</span>


<span class="sd">    State sequences like |hland_states.SM| handle data for specific time points instead</span>
<span class="sd">    of time intervals.  Their |IOSequence.series| vector contains the calculated values</span>
<span class="sd">    for the end of each simulation step.  Hence, without file-specific information,</span>
<span class="sd">    |query_timegrid| ignores the |Options.timestampleft| option and follows the `right</span>
<span class="sd">    interval boundary` convention:</span>

<span class="sd">    &gt;&gt;&gt; sm = hp.elements.land_dill_assl.model.sequences.states.sm</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath, &quot;r+&quot;) as ncfile:</span>
<span class="sd">    ...     del ncfile.timereference</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, sm)</span>
<span class="sd">    Timegrid(&quot;1989-10-31 00:00:00&quot;,</span>
<span class="sd">             &quot;2020-12-31 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>

<span class="sd">    Add a `timereference` attribute with the value `current time` to explicitly include</span>
<span class="sd">    this information in a NetCDF file:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath, &quot;r+&quot;) as ncfile:</span>
<span class="sd">    ...     ncfile.timereference = &quot;current time&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, sm)</span>
<span class="sd">    Timegrid(&quot;1989-10-31 00:00:00&quot;,</span>
<span class="sd">             &quot;2020-12-31 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>

<span class="sd">    |query_timegrid| raises special warnings when a NetCDF file&#39;s `timereference`</span>
<span class="sd">    attribute conflicts with its judgement whether the contained data addresses time</span>
<span class="sd">    intervals or time points:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(), warn_later(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, p)  # doctest: +ELLIPSIS</span>
<span class="sd">    Timegrid(&quot;1989-10-31 00:00:00&quot;,</span>
<span class="sd">             &quot;2020-12-31 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>
<span class="sd">    UserWarning: The `timereference` attribute (`current time`) of the NetCDF file \</span>
<span class="sd">`HydPy-H-Lahn/series/default/hland_96_input_p.nc` conflicts with the type of the \</span>
<span class="sd">relevant sequence (`P`).  The file-specific information is prioritised.</span>


<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath, &quot;r+&quot;) as ncfile:</span>
<span class="sd">    ...     ncfile.timereference = &quot;left interval boundary&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), warn_later(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, sm)  # doctest: +ELLIPSIS</span>
<span class="sd">    Timegrid(&quot;1989-11-01 00:00:00&quot;,</span>
<span class="sd">             &quot;2021-01-01 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>
<span class="sd">    UserWarning: The `timereference` attribute (`left interval boundary`) of the \</span>
<span class="sd">NetCDF file `HydPy-H-Lahn/series/default/hland_96_input_p.nc` conflicts with the type \</span>
<span class="sd">of the relevant sequence (`SM`).  The file-specific information is prioritised.</span>


<span class="sd">    |query_timegrid| also raises specific warnings for misstated `timereference`</span>
<span class="sd">    attributes describing the different fallbacks for data related to time intervals</span>
<span class="sd">    and time points:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(), Dataset(filepath, &quot;r+&quot;) as ncfile:</span>
<span class="sd">    ...     ncfile.timereference = &quot;wrong&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), warn_later(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, p)  # doctest: +ELLIPSIS</span>
<span class="sd">    Timegrid(&quot;1989-11-01 00:00:00&quot;,</span>
<span class="sd">             &quot;2021-01-01 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>
<span class="sd">    UserWarning: The value of the `timereference` attribute (`wrong`) of the NetCDF \</span>
<span class="sd">file `HydPy-H-Lahn/series/default/hland_96_input_p.nc` is not among the accepted \</span>
<span class="sd">values (`left...`, `right...`, `current...`).  Assuming `left interval boundary` \</span>
<span class="sd">according to the current value of the global `timestampleft` option.</span>



<span class="sd">    &gt;&gt;&gt; with TestIO(), warn_later(), Dataset(filepath) as ncfile:</span>
<span class="sd">    ...     query_timegrid(ncfile, sm)  # doctest: +ELLIPSIS</span>
<span class="sd">    Timegrid(&quot;1989-10-31 00:00:00&quot;,</span>
<span class="sd">             &quot;2020-12-31 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>
<span class="sd">    UserWarning: The value of the `timereference` attribute (`wrong`) of the NetCDF \</span>
<span class="sd">file `...hland_96_input_p.nc` is not among the accepted values (`left...`, `right...`, \</span>
<span class="sd">`current...`).  Assuming `current time` according to the type of the relevant \</span>
<span class="sd">sequence (`SM`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">currenttime</span> <span class="o">=</span> <span class="n">_timereference_currenttime</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span>
    <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s2">&quot;timereference&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">timestampleft</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">currenttime</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ref</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">):</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">currenttime</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The `timereference` attribute (`</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">timereference</span><span class="si">}</span><span class="s2">`) of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;NetCDF file `</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span><span class="si">}</span><span class="s2">` conflicts with the type of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;relevant sequence (`</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">`).  The file-specific &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;information is prioritised.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">opts</span><span class="o">.</span><span class="n">timestampleft</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The `timereference` attribute (`</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">timereference</span><span class="si">}</span><span class="s2">`) of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;NetCDF file `</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span><span class="si">}</span><span class="s2">` conflicts with the current value &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;of the global `timestampleft` option (`</span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">timestampleft</span><span class="p">)</span><span class="si">}</span><span class="s2">`). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; The file-specific information is prioritised.&quot;</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;current&quot;</span><span class="p">):</span>
        <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">currenttime</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The `timereference` attribute (`</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">timereference</span><span class="si">}</span><span class="s2">`) of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;NetCDF file `</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span><span class="si">}</span><span class="s2">` conflicts with the type of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;relevant sequence (`</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">`).  The file-specific &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;information is prioritised.&quot;</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">currenttime</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The value of the `timereference` attribute (`</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">timereference</span><span class="si">}</span><span class="s2">`) &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;of the NetCDF file `</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span><span class="si">}</span><span class="s2">` is not among the accepted &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;values (`left...`, `right...`, `current...`).  Assuming `current time` &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;according to the type of the relevant sequence &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(`</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">`).&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">timestampleft</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span> <span class="k">if</span> <span class="n">left</span> <span class="k">else</span> <span class="s2">&quot;right&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The value of the `timereference` attribute (`</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">timereference</span><span class="si">}</span><span class="s2">`) &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;of the NetCDF file `</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span><span class="si">}</span><span class="s2">` is not among the accepted &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;values (`left...`, `right...`, `current...`).  Assuming `</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;interval boundary` according to the current value of the global &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;`timestampleft` option.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">_query_timegrid</span><span class="p">(</span><span class="n">ncfile</span><span class="o">=</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_query_timegrid</span><span class="p">(</span><span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Timegrid</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestampleft</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
        <span class="n">timepoints</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">varmapping</span><span class="p">[</span><span class="s2">&quot;timepoints&quot;</span><span class="p">]]</span>
        <span class="n">refdate</span> <span class="o">=</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">from_cfunits</span><span class="p">(</span><span class="n">timepoints</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Timegrid</span><span class="o">.</span><span class="n">from_timepoints</span><span class="p">(</span>
            <span class="n">timepoints</span><span class="o">=</span><span class="n">timepoints</span><span class="p">[:],</span>
            <span class="n">refdate</span><span class="o">=</span><span class="n">refdate</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">timepoints</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>


<div class="viewcode-block" id="query_array">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.query_array">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">query_array</span><span class="p">(</span><span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the data of the variable with the given name from the given NetCDF file.</span>

<span class="sd">    The following example shows that |query_array| returns |numpy.nan| entries for</span>
<span class="sd">    representing missing values even when the respective NetCDF variable defines a</span>
<span class="sd">    different fill value:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import print_matrix, TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core import netcdftools</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4, create_dimension, create_variable</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;) as ncfile:</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;time&quot;, 2)</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;stations&quot;, 3)</span>
<span class="sd">    ...         netcdftools.fillvalue = -999.0</span>
<span class="sd">    ...         create_variable(ncfile, &quot;var&quot;, &quot;f8&quot;, (&quot;time&quot;, &quot;stations&quot;))</span>
<span class="sd">    ...         netcdftools.fillvalue = numpy.nan</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;test.nc&quot;, &quot;r&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import query_variable, query_array</span>
<span class="sd">    &gt;&gt;&gt; print_matrix(query_variable(ncfile, &quot;var&quot;)[:].data)</span>
<span class="sd">    | -999.0, -999.0, -999.0 |</span>
<span class="sd">    | -999.0, -999.0, -999.0 |</span>
<span class="sd">    &gt;&gt;&gt; print_matrix(query_array(ncfile, &quot;var&quot;))</span>
<span class="sd">    | nan, nan, nan |</span>
<span class="sd">    | nan, nan, nan |</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>

<span class="sd">    Usually, *HydPy* expects all data variables in NetCDF files to be 2-dimensional,</span>
<span class="sd">    with time on the first and location on the second axis.  However, |query_array|</span>
<span class="sd">    allows for an exception for compatibility with `Delft-FEWS`_.  When working with</span>
<span class="sd">    ensembles, `Delft-FEWS`_ defines a third dimension called `realization` and puts it</span>
<span class="sd">    between the first dimension (`time`) and the last dimension (`stations`).  In our</span>
<span class="sd">    experience, this additional dimension is always of length one, meaning we can</span>
<span class="sd">    safely ignore it:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;) as ncfile:</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;time&quot;, 2)</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;realization&quot;, 1)</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;stations&quot;, 3)</span>
<span class="sd">    ...         var = create_variable(ncfile, &quot;var&quot;, &quot;f8&quot;,</span>
<span class="sd">    ...                               (&quot;time&quot;, &quot;realization&quot;, &quot;stations&quot;))</span>
<span class="sd">    ...         ncfile[&quot;var&quot;][:] = [[[1.1, 1.2, 1.3]], [[2.1, 2.2, 2.3]]]</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;test.nc&quot;, &quot;r&quot;)</span>
<span class="sd">    &gt;&gt;&gt; var = query_variable(ncfile, &quot;var&quot;)[:]</span>
<span class="sd">    &gt;&gt;&gt; var.shape</span>
<span class="sd">    (2, 1, 3)</span>
<span class="sd">    &gt;&gt;&gt; query_array(ncfile, &quot;var&quot;).shape</span>
<span class="sd">    (2, 3)</span>
<span class="sd">    &gt;&gt;&gt; print_matrix(query_array(ncfile, &quot;var&quot;))</span>
<span class="sd">    | 1.1, 1.2, 1.3 |</span>
<span class="sd">    | 2.1, 2.2, 2.3 |</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>

<span class="sd">    |query_array| raises errors if dimensionality is smaller than two or larger than</span>
<span class="sd">    three or if there are three dimensions and the length of the second dimension is</span>
<span class="sd">    not one:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;) as ncfile:</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;time&quot;, 2)</span>
<span class="sd">    ...         var = create_variable(ncfile, &quot;var&quot;, &quot;f8&quot;, (&quot;time&quot;,))</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;r&quot;) as ncfile:</span>
<span class="sd">    ...         query_array(ncfile, &quot;var&quot;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: Variable `var` of NetCDF file `test.nc` must be 2-dimensional (or \</span>
<span class="sd">3-dimensional with a length of one on the second axis) but has the shape `(2,)`.</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;) as ncfile:</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;time&quot;, 2)</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;realization&quot;, 2)</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;stations&quot;, 3)</span>
<span class="sd">    ...         var = create_variable(ncfile, &quot;var&quot;, &quot;f8&quot;,</span>
<span class="sd">    ...                               (&quot;time&quot;, &quot;realization&quot;, &quot;stations&quot;))</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;r&quot;) as ncfile:</span>
<span class="sd">    ...         query_array(ncfile, &quot;var&quot;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: Variable `var` of NetCDF file `test.nc` must be 2-dimensional (or \</span>
<span class="sd">3-dimensional with a length of one on the second axis) but has the shape `(2, 2, 3)`.</span>

<span class="sd">    The skipping of the `realization` axis is very specific to `Delft-FEWS`_.  To</span>
<span class="sd">    prevent hiding problems when reading erroneous data from other sources,</span>
<span class="sd">    |query_array| emits the following warning if the name of the second dimension is</span>
<span class="sd">    not `realization`:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import warn_later</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;) as ncfile:</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;time&quot;, 2)</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;realisation&quot;, 1)</span>
<span class="sd">    ...         create_dimension(ncfile, &quot;stations&quot;, 3)</span>
<span class="sd">    ...         var = create_variable(ncfile, &quot;var&quot;, &quot;f8&quot;,</span>
<span class="sd">    ...                               (&quot;time&quot;, &quot;realisation&quot;, &quot;stations&quot;))</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;r&quot;) as ncfile, warn_later():</span>
<span class="sd">    ...         print_matrix(query_array(ncfile, &quot;var&quot;))</span>
<span class="sd">    | nan, nan, nan |</span>
<span class="sd">    | nan, nan, nan |</span>
<span class="sd">    UserWarning: Variable `var` of NetCDF file `test.nc` is 3-dimensional and the \</span>
<span class="sd">length of the second dimension is one, but its name is `realisation` instead of \</span>
<span class="sd">`realization`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="n">query_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_is_realisation</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">):</span>
        <span class="n">maskedarray</span> <span class="o">=</span> <span class="n">variable</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maskedarray</span> <span class="o">=</span> <span class="n">variable</span><span class="p">[:]</span>
    <span class="n">fillvalue_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="s2">&quot;_FillValue&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fillvalue_</span><span class="p">):</span>
        <span class="n">maskedarray</span><span class="p">[</span><span class="n">maskedarray</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">NDArrayFloat</span><span class="p">,</span> <span class="n">maskedarray</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_is_realisation</span><span class="p">(</span><span class="n">variable</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Variable</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;realization&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Variable `</span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` of NetCDF file `</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span><span class="si">}</span><span class="s2">` is &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;3-dimensional and the length of the second dimension is one, but &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;its name is `</span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">` instead of `realization`.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Variable `</span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` of NetCDF file `</span><span class="si">{</span><span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span><span class="si">}</span><span class="s2">` must be &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;2-dimensional (or 3-dimensional with a length of one on the second axis) &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;but has the shape `</span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">`.&quot;</span>
    <span class="p">)</span>


<div class="viewcode-block" id="get_filepath">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.get_filepath">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the path of the given NetCDF file.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import get_filepath</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;) as ncfile:</span>
<span class="sd">    ...         get_filepath(ncfile)</span>
<span class="sd">    &#39;test.nc&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s2">&quot;filepath&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">filename</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_timereference_currenttime</span><span class="p">(</span><span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">StateSequence</span><span class="p">)</span>


<div class="viewcode-block" id="yield_disksequences">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.yield_disksequences">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">yield_disksequences</span><span class="p">(</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span> <span class="o">|</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span> <span class="o">/</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iterate through all sequences of the given devices that could read time series</span>
<span class="sd">    data from or write time series data to NetCDF files &quot;just-in-time&quot; during</span>
<span class="sd">    simulation runs.&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">device</span><span class="o">.</span><span class="n">sequences</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">device</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_submodels</span><span class="p">(</span><span class="n">include_mainmodel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">subseqs</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">iosubsequences</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="n">subseqs</span></div>



<div class="viewcode-block" id="JITAccessInfo">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.JITAccessInfo">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">JITAccessInfo</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class for structuring reading from or writing to a NetCDF file &quot;just in</span>
<span class="sd">    time&quot; during a simulation run for a specific |NetCDFVariableFlat| object.&quot;&quot;&quot;</span>

    <span class="n">ncvariable</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Variable</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Variable for direct access to the relevant section of the NetCDF file.&quot;&quot;&quot;</span>
    <span class="n">realisation</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag that indicates if the relevant |JITAccessInfo.ncvariable| comes with an</span>
<span class="sd">    additional `realization` dimension (explained in the documentation on function</span>
<span class="sd">    |query_array|)&quot;&quot;&quot;</span>
    <span class="n">timedelta</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Difference between the relevant row of the NetCDF file and the current </span>
<span class="sd">    simulation index (as defined by |Idx_Sim|).&quot;&quot;&quot;</span>
    <span class="n">columns</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Indices of the relevant columns of the NetCDF file correctly ordered with </span>
<span class="sd">    respect to |JITAccessInfo.data|.&quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">NDArrayFloat</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bridge to transfer data between the NetCDF file and the (cythonized) </span>
<span class="sd">    hydrological models.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="JITAccessHandler">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.JITAccessHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">JITAccessHandler</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler used by the |SequenceManager| object available in module |pub| for</span>
<span class="sd">    reading data from and/or writing data to NetCDF files at each step of a simulation</span>
<span class="sd">    run.&quot;&quot;&quot;</span>

    <span class="n">readers</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">JITAccessInfo</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All |JITAccessInfo| objects responsible for reading data during the simulation </span>
<span class="sd">    run.&quot;&quot;&quot;</span>
    <span class="n">writers</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">JITAccessInfo</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All |JITAccessInfo| objects responsible for writing data during the simulation </span>
<span class="sd">    run.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="JITAccessHandler.read_slices">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.JITAccessHandler.read_slices">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the time slice of the current simulation step from each NetCDF file</span>
<span class="sd">        selected for reading.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">:</span>
            <span class="n">jdx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">reader</span><span class="o">.</span><span class="n">timedelta</span>
            <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">realisation</span><span class="p">:</span>
                <span class="n">reader</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">ncvariable</span><span class="p">[</span><span class="n">jdx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reader</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">ncvariable</span><span class="p">[</span><span class="n">jdx</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span></div>


<div class="viewcode-block" id="JITAccessHandler.write_slices">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.JITAccessHandler.write_slices">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the time slice of the current simulation step from each NetCDF file</span>
<span class="sd">        selected for writing.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">writer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">:</span>
            <span class="n">jdx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">writer</span><span class="o">.</span><span class="n">timedelta</span>
            <span class="k">if</span> <span class="n">writer</span><span class="o">.</span><span class="n">realisation</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">ncvariable</span><span class="p">[</span><span class="n">jdx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">writer</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">ncvariable</span><span class="p">[</span><span class="n">jdx</span><span class="p">,</span> <span class="n">writer</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">data</span></div>
</div>



<div class="viewcode-block" id="Subdevice2Index">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.Subdevice2Index">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Subdevice2Index</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return type of method |NetCDFVariable.query_subdevice2index|.&quot;&quot;&quot;</span>

    <span class="n">dict_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">name_sequence</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name_ncfile</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">name_ncfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_</span> <span class="o">=</span> <span class="n">dict_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_ncfile</span> <span class="o">=</span> <span class="n">name_ncfile</span>

<div class="viewcode-block" id="Subdevice2Index.get_index">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.Subdevice2Index.get_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_subdevice</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Item access to the wrapped |dict| object with a specialised error message.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_</span><span class="p">[</span><span class="n">name_subdevice</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No data for (sub)device `</span><span class="si">{</span><span class="n">name_subdevice</span><span class="si">}</span><span class="s2">` is available in NetCDF &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;file `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name_ncfile</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="NetCDFVariableInfo">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableInfo">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFVariableInfo</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returned type of |NetCDFVariableFlatWriter| and |NetCDFVariableAggregated| when</span>
<span class="sd">    querying logged data via attribute access.&quot;&quot;&quot;</span>

    <span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span>
    <span class="n">array</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InfoArray</span> <span class="o">|</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="NetCDFVariable">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariable">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFVariable</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for handling single NetCDF variables of a single NetCDF file.&quot;&quot;&quot;</span>

    <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Path to the relevant NetCDF file.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name of the NetCDF file and the NetCDF variable containing the time series</span>
<span class="sd">        data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">subdevicenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The names of all relevant (sub)devices.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NetCDFVariable.query_subdevices">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariable.query_subdevices">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_subdevices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the names of the (sub)devices of the logged sequences from the given</span>
<span class="sd">        NetCDF file.</span>

<span class="sd">        We apply method |NetCDFVariable.query_subdevices| on an empty NetCDF file.  The</span>
<span class="sd">        error message shows that the method tries to query the (sub)device names:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4, NetCDFVariableFlatWriter</span>
<span class="sd">        &gt;&gt;&gt; class Var(NetCDFVariableFlatWriter):</span>
<span class="sd">        ...     pass</span>
<span class="sd">        &gt;&gt;&gt; var = Var(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():</span>
<span class="sd">        ...     ncfile = netcdf4.Dataset(&quot;filename.nc&quot;, &quot;w&quot;)</span>
<span class="sd">        &gt;&gt;&gt; var.query_subdevices(ncfile)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: NetCDF file `filename.nc` does neither contain a variable named \</span>
<span class="sd">`values_station_id` nor `station_id` for defining coordinate locations.</span>

<span class="sd">        After inserting the (sub)device names, they can be queried and returned:</span>

<span class="sd">        &gt;&gt;&gt; var.insert_subdevices(ncfile, [&quot;element1&quot;, &quot;element_2&quot;])</span>
<span class="sd">        &gt;&gt;&gt; Var(&quot;filename.nc&quot;).query_subdevices(ncfile)</span>
<span class="sd">        [&#39;element1&#39;, &#39;element_2&#39;]</span>

<span class="sd">        &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pref</span><span class="si">}{</span><span class="n">varmapping</span><span class="p">[</span><span class="s1">&#39;subdevices&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;values_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">subdevices</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chars</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">subdevices</span><span class="p">][:]</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;NetCDF file `</span><span class="si">{</span><span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span><span class="si">}</span><span class="s2">` does neither contain a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;variable named `</span><span class="si">{</span><span class="n">tests</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">` nor `</span><span class="si">{</span><span class="n">tests</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">` for defining &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;coordinate locations.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">chars2str</span><span class="p">(</span><span class="n">chars</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="NetCDFVariable.query_subdevice2index">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariable.query_subdevice2index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_subdevice2index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Subdevice2Index</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a |Subdevice2Index| object that maps the (sub)device names to their</span>
<span class="sd">        position within the given NetCDF file.</span>

<span class="sd">        Method |NetCDFVariable.query_subdevice2index| relies on</span>
<span class="sd">        |NetCDFVariable.query_subdevices|.  The returned |Subdevice2Index| object</span>
<span class="sd">        remembers the NetCDF file from which the (sub)device names stem, allowing for</span>
<span class="sd">        clear error messages:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import (</span>
<span class="sd">        ...     netcdf4, NetCDFVariableFlatWriter, str2chars)</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():</span>
<span class="sd">        ...     ncfile = netcdf4.Dataset(&quot;filename.nc&quot;, &quot;w&quot;)</span>
<span class="sd">        &gt;&gt;&gt; class Var(NetCDFVariableFlatWriter):</span>
<span class="sd">        ...     pass</span>
<span class="sd">        &gt;&gt;&gt; var = Var(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; var.insert_subdevices(ncfile,</span>
<span class="sd">        ...                       [&quot;element3&quot;, &quot;element1&quot;, &quot;element1_1&quot;, &quot;element2&quot;])</span>
<span class="sd">        &gt;&gt;&gt; subdevice2index = var.query_subdevice2index(ncfile)</span>
<span class="sd">        &gt;&gt;&gt; subdevice2index.get_index(&quot;element1_1&quot;)</span>
<span class="sd">        2</span>
<span class="sd">        &gt;&gt;&gt; subdevice2index.get_index(&quot;element3&quot;)</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; subdevice2index.get_index(&quot;element5&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        OSError: No data for (sub)device `element5` is available in NetCDF file \</span>
<span class="sd">`filename.nc`.</span>

<span class="sd">        Additionally, |NetCDFVariable.query_subdevice2index| checks for duplicates:</span>

<span class="sd">        &gt;&gt;&gt; ncfile[&quot;station_id&quot;][:] = str2chars(</span>
<span class="sd">        ...     [&quot;element3&quot;, &quot;element1&quot;, &quot;element1_1&quot;, &quot;element1&quot;])</span>
<span class="sd">        &gt;&gt;&gt; var.query_subdevice2index(ncfile)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: The NetCDF file `filename.nc` contains duplicate (sub)device \</span>
<span class="sd">names (the first found duplicate is `element1`).</span>

<span class="sd">        &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subdevices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_subdevices</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_duplicate_exists</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">subdevices</span><span class="p">)</span>
        <span class="n">subdev2index</span> <span class="o">=</span> <span class="p">{</span><span class="n">subdev</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">subdev</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subdevices</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">Subdevice2Index</span><span class="p">(</span><span class="n">subdev2index</span><span class="p">,</span> <span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">))</span></div>


    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_anysequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_descr2anysequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_duplicate_exists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">subdevices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdevices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subdevices</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subdevices</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name2</span> <span class="ow">in</span> <span class="n">subdevices</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]:</span>
                    <span class="k">if</span> <span class="n">name1</span> <span class="o">==</span> <span class="n">name2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The NetCDF file `</span><span class="si">{</span><span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span><span class="si">}</span><span class="s2">` contains &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;duplicate (sub)device names (the first found duplicate &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;is `</span><span class="si">{</span><span class="n">name1</span><span class="si">}</span><span class="s2">`).&quot;</span>
                        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_insert_timepoints</span><span class="p">(</span>
        <span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">:</span> <span class="n">NDArrayFloat</span><span class="p">,</span> <span class="n">timeunit</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dim_name</span> <span class="o">=</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_timepoints&quot;</span><span class="p">]</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="n">varmapping</span><span class="p">[</span><span class="s2">&quot;timepoints&quot;</span><span class="p">]</span>
        <span class="n">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timepoints</span><span class="p">))</span>
        <span class="n">create_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">dim_name</span><span class="p">,))</span>
        <span class="n">var_</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">var_</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">timepoints</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">timeunit</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="n">var_name</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="s2">&quot;standard&quot;</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">delncattr</span><span class="p">(</span><span class="s2">&quot;_FillValue&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="NetCDFVariableFlat">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableFlat">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFVariableFlat</span><span class="p">(</span><span class="n">NetCDFVariable</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for handling single &quot;flat&quot; NetCDF variables (which deal with</span>
<span class="sd">    unaggregated time series) of single NetCDF files.</span>

<span class="sd">    The following examples describe the functioning of the subclasses</span>
<span class="sd">    |NetCDFVariableFlatReader| and |NetCDFVariableFlatWriter|, which serve to read and</span>
<span class="sd">    write data, respectively.</span>

<span class="sd">    We prepare some devices handling some sequences by applying the function</span>
<span class="sd">    |prepare_io_example_1|.  We limit our attention to the returned elements, which</span>
<span class="sd">    handle the more diverse sequences:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, (element1, element2, element3, element4) = prepare_io_example_1()</span>

<span class="sd">    We define three |NetCDFVariableFlatWriter| instances with different</span>
<span class="sd">    dimensionalities structures and log the |lland_inputs.Nied| and |lland_fluxes.NKor|</span>
<span class="sd">    instances of the first two elements and the |hland_states.SP| instance of the</span>
<span class="sd">    fourth element:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlatWriter</span>
<span class="sd">    &gt;&gt;&gt; var_nied = NetCDFVariableFlatWriter(&quot;nied.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor = NetCDFVariableFlatWriter(&quot;nkor.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; var_sp = NetCDFVariableFlatWriter(&quot;sp.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element3):</span>
<span class="sd">    ...     seqs = element.model.sequences</span>
<span class="sd">    ...     var_nied.log(seqs.inputs.nied, seqs.inputs.nied.series)</span>
<span class="sd">    ...     var_nkor.log(seqs.fluxes.nkor, seqs.fluxes.nkor.series)</span>
<span class="sd">    &gt;&gt;&gt; sp = element4.model.sequences.states.sp</span>
<span class="sd">    &gt;&gt;&gt; var_sp.log(sp, sp.series)</span>

<span class="sd">    We further try to log the equally named &quot;wind speed&quot; sequences of the main model</span>
<span class="sd">    |lland_knauf| and the submodel |evap_aet_morsim|.  As both models are handled by</span>
<span class="sd">    the same element, which defines the column name, their time series cannot be stored</span>
<span class="sd">    separately in the same NetCDF file.  The |MixinVariableWriter.log| method defined</span>
<span class="sd">    by |MixinVariableWriter| checks for potential conflicts:</span>

<span class="sd">    &gt;&gt;&gt; var_windspeed = NetCDFVariableFlatWriter(&quot;windspeed.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; windspeed_l = element3.model.sequences.inputs.windspeed</span>
<span class="sd">    &gt;&gt;&gt; var_windspeed.log(windspeed_l, windspeed_l.series)</span>
<span class="sd">    &gt;&gt;&gt; windspeed_e = element3.model.aetmodel.sequences.inputs.windspeed</span>
<span class="sd">    &gt;&gt;&gt; var_windspeed.log(windspeed_e, 2.0 * windspeed_e.series)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: When trying to log the time series of sequence `windspeed` of \</span>
<span class="sd">element `element3` of model `evap_aet_morsim` for writing, the following error \</span>
<span class="sd">occurred: Sequence `windspeed` of element `element3` of model `lland_knauf` is \</span>
<span class="sd">already registered under the same column name(s) but with different time series data.</span>

<span class="sd">    If the supplied time series are equal, there is no problem.  So,</span>
<span class="sd">    |MixinVariableWriter.log| neither accepts the new sequence nor raises an error in</span>
<span class="sd">    such cases:</span>

<span class="sd">    ToDo: Should we implement additional checks for just-in-time writing?</span>

<span class="sd">    &gt;&gt;&gt; assert var_windspeed.element3.sequence is windspeed_l</span>
<span class="sd">    &gt;&gt;&gt; var_windspeed.log(windspeed_e, windspeed_e.series)</span>
<span class="sd">    &gt;&gt;&gt; assert var_windspeed.element3.sequence is windspeed_l</span>

<span class="sd">    We write the data of all logged sequences to separate NetCDF files:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     var_nied.write()</span>
<span class="sd">    ...     var_nkor.write()</span>
<span class="sd">    ...     var_sp.write()</span>
<span class="sd">    ...     var_windspeed.write()</span>

<span class="sd">    We set all the values of the selected sequences to -777 and check that they differ</span>
<span class="sd">    from the original values available via the `testarray` attribute:</span>

<span class="sd">    &gt;&gt;&gt; nied = element1.model.sequences.inputs.nied</span>
<span class="sd">    &gt;&gt;&gt; nkor = element3.model.sequences.fluxes.nkor</span>
<span class="sd">    &gt;&gt;&gt; sp = element4.model.sequences.states.sp</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; for seq in (nied, nkor, sp, windspeed_l, windspeed_e):</span>
<span class="sd">    ...     seq.series = -777.0</span>
<span class="sd">    ...     assert numpy.any(seq.series != seq.testarray)</span>

<span class="sd">    Now, we prepare three |NetCDFVariableFlatReader| instances and log the same</span>
<span class="sd">    sequences as above, open the existing NetCDF file for reading, read its data, and</span>
<span class="sd">    confirm that it has been correctly passed to the test sequences:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlatReader</span>
<span class="sd">    &gt;&gt;&gt; var_nied = NetCDFVariableFlatReader(&quot;nied.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor = NetCDFVariableFlatReader(&quot;nkor.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; var_sp = NetCDFVariableFlatReader(&quot;sp.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; var_windspeed = NetCDFVariableFlatReader(&quot;windspeed.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element3):</span>
<span class="sd">    ...     sequences = element.model.sequences</span>
<span class="sd">    ...     var_nied.log(sequences.inputs.nied)</span>
<span class="sd">    ...     var_nkor.log(sequences.fluxes.nkor)</span>
<span class="sd">    &gt;&gt;&gt; var_sp.log(sp)</span>
<span class="sd">    &gt;&gt;&gt; var_windspeed.log(windspeed_l)</span>
<span class="sd">    &gt;&gt;&gt; var_windspeed.log(windspeed_e)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     var_nied.read()</span>
<span class="sd">    ...     var_nkor.read()</span>
<span class="sd">    ...     var_sp.read()</span>
<span class="sd">    ...     var_windspeed.read()</span>
<span class="sd">    &gt;&gt;&gt; for seq in (nied, nkor, sp):</span>
<span class="sd">    ...     assert numpy.all(seq.series == seq.testarray)</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(windspeed_l.series == windspeed_l.testarray)</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(windspeed_e.series == windspeed_l.testarray)</span>

<span class="sd">    Trying to read data that is not stored properly results in error messages like</span>
<span class="sd">    the following:</span>

<span class="sd">    &gt;&gt;&gt; for element in (element1, element2, element3):</span>
<span class="sd">    ...     element.model.sequences.inputs.nied.series = -777.0</span>
<span class="sd">    ...     var_nied.log(element.model.sequences.inputs.nied)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     var_nied.read()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    OSError: While trying to read data from NetCDF file `nied.nc`, the following \</span>
<span class="sd">error occurred: No data for (sub)device `element2` is available in NetCDF file \</span>
<span class="sd">`nied.nc`.</span>

<span class="sd">    Note that method |NetCDFVariableFlatReader.read| does not abort the reading process</span>
<span class="sd">    when missing a time series.  Instead, it sets the entries of the corresponding</span>
<span class="sd">    |IOSequence.series| array to |numpy.nan|, proceeds with the following sequences,</span>
<span class="sd">    and finally re-raises the first encountered exception:</span>

<span class="sd">    &gt;&gt;&gt; element1.model.sequences.inputs.nied.series</span>
<span class="sd">    InfoArray([0., 1., 2., 3.])</span>
<span class="sd">    &gt;&gt;&gt; element2.model.sequences.inputs.nied.series</span>
<span class="sd">    InfoArray([nan, nan, nan, nan])</span>
<span class="sd">    &gt;&gt;&gt; element3.model.sequences.inputs.nied.series</span>
<span class="sd">    InfoArray([ 8.,  9., 10., 11.])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">subdevicenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The names of the (sub)devices.</span>

<span class="sd">        Property |NetCDFVariableFlat.subdevicenames| clarifies which column of NetCDF</span>
<span class="sd">        file contains the series of which (sub)device.  For  0-dimensional series like</span>
<span class="sd">        |lland_inputs.Nied|, we require no subdivision.  Hence, it returns the original</span>
<span class="sd">        device names:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlatReader</span>
<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatReader(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     if element.model.name.startswith(&quot;lland&quot;):</span>
<span class="sd">        ...         var.log(element.model.sequences.inputs.nied)</span>
<span class="sd">        &gt;&gt;&gt; var.subdevicenames</span>
<span class="sd">        (&#39;element1&#39;, &#39;element2&#39;, &#39;element3&#39;)</span>

<span class="sd">        For 1-dimensional sequences like |lland_fluxes.NKor|, a suffix defines the</span>
<span class="sd">        index of the respective subdevice.  For example, the third column of</span>
<span class="sd">        |NetCDFVariableFlatWriter.array| contains the series of the first hydrological</span>
<span class="sd">        response unit of the second element:</span>

<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatReader(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     if element.model.name.startswith(&quot;lland&quot;):</span>
<span class="sd">        ...         var.log( element.model.sequences.fluxes.nkor)</span>
<span class="sd">        &gt;&gt;&gt; var.subdevicenames</span>
<span class="sd">        (&#39;element1_0&#39;, &#39;element2_0&#39;, &#39;element2_1&#39;, &#39;element3_0&#39;, &#39;element3_1&#39;, \</span>
<span class="sd">&#39;element3_2&#39;)</span>

<span class="sd">        2-dimensional sequences like |hland_states.SP| require an additional suffix:</span>

<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatReader(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; var.log(elements.element4.model.sequences.states.sp)</span>
<span class="sd">        &gt;&gt;&gt; var.subdevicenames</span>
<span class="sd">        (&#39;element4_0_0&#39;, &#39;element4_0_1&#39;, &#39;element4_0_2&#39;, &#39;element4_1_0&#39;, \</span>
<span class="sd">&#39;element4_1_1&#39;, &#39;element4_1_2&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">devicename</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2anysequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">devicename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">prod</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">devicename</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Required shape of the NetCDF variable.</span>

<span class="sd">        For 0-dimensional sequences like |lland_inputs.Nied|, the first axis</span>
<span class="sd">        corresponds to the number of timesteps and the second axis to the number of</span>
<span class="sd">        devices:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlatReader</span>
<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatReader(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     if element.model.name.startswith(&quot;lland&quot;):</span>
<span class="sd">        ...         var.log(element.model.sequences.inputs.nied)</span>
<span class="sd">        &gt;&gt;&gt; var.shape</span>
<span class="sd">        (4, 3)</span>

<span class="sd">        For 1-dimensional sequences as |lland_fluxes.NKor|, the second axis corresponds</span>
<span class="sd">        to &quot;subdevices&quot;.  Here, these &quot;subdevices&quot; are hydrological response units of</span>
<span class="sd">        different elements.  The model instances of the three elements define one, two,</span>
<span class="sd">        and three response units, respectively, making up a sum of six subdevices:</span>

<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatReader(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     if element.model.name.startswith(&quot;lland&quot;):</span>
<span class="sd">        ...         var.log(element.model.sequences.fluxes.nkor)</span>
<span class="sd">        &gt;&gt;&gt; var.shape</span>
<span class="sd">        (4, 6)</span>

<span class="sd">        The above statements also hold for 2-dimensional sequences as</span>
<span class="sd">        |hland_states.SP|.  In this specific case, each &quot;subdevice&quot; corresponds to a</span>
<span class="sd">        single snow class (one element times three zones times two snow classes makes</span>
<span class="sd">        six subdevices):</span>

<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatReader( &quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; var.log(elements.element4.model.sequences.states.sp)</span>
<span class="sd">        &gt;&gt;&gt; var.shape</span>
<span class="sd">        (4, 6)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span><span class="p">),</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">numberofvalues</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2anysequence</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_product</span><span class="p">(</span><span class="n">shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Should return all &quot;subdevice index combinations&quot; for sequences with</span>
<span class="sd">        arbitrary dimensions.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlat</span>
<span class="sd">        &gt;&gt;&gt; _product = NetCDFVariableFlat.__dict__[&quot;_product&quot;].__func__</span>
<span class="sd">        &gt;&gt;&gt; for comb in _product([1, 2, 3]):</span>
<span class="sd">        ...     print(comb)</span>
<span class="sd">        (0, 0, 0)</span>
<span class="sd">        (0, 0, 1)</span>
<span class="sd">        (0, 0, 2)</span>
<span class="sd">        (0, 1, 0)</span>
<span class="sd">        (0, 1, 1)</span>
<span class="sd">        (0, 1, 2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nmb</span><span class="p">)</span> <span class="k">for</span> <span class="n">nmb</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">))</span></div>



<div class="viewcode-block" id="NetCDFVariableFlatReader">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableFlatReader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFVariableFlatReader</span><span class="p">(</span><span class="n">NetCDFVariableFlat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Concrete class for reading data of single &quot;flat&quot; NetCDF variables (which deal</span>
<span class="sd">    with unaggregated time series) from single NetCDF files.</span>

<span class="sd">    For a general introduction to using |NetCDFVariableFlatReader|, see the</span>
<span class="sd">    documentation on base class |NetCDFVariableFlat|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_descr2sequences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_anysequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_descr2anysequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<div class="viewcode-block" id="NetCDFVariableFlatReader.log">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableFlatReader.log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log the given |IOSequence| object for reading data.</span>

<span class="sd">        The logged sequence is available via attribute access:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlatReader</span>
<span class="sd">        &gt;&gt;&gt; class Var(NetCDFVariableFlatReader):</span>
<span class="sd">        ...     pass</span>
<span class="sd">        &gt;&gt;&gt; var = Var(&quot;filepath.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; nkor = elements.element1.model.sequences.fluxes.nkor</span>
<span class="sd">        &gt;&gt;&gt; var.log(nkor)</span>
<span class="sd">        &gt;&gt;&gt; assert &quot;element1&quot; in dir(var)</span>
<span class="sd">        &gt;&gt;&gt; assert nkor in var.element1</span>
<span class="sd">        &gt;&gt;&gt; assert &quot;element2&quot; not in dir(var)</span>
<span class="sd">        &gt;&gt;&gt; var.element2  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AttributeError: The selected NetCDFVariableFlatReader object does neither \</span>
<span class="sd">handle a sequence for the (sub)device `element2` nor define a member named \</span>
<span class="sd">`element2`...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">descr_device</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">descr_device</span>
        <span class="k">if</span> <span class="n">descr_device</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span><span class="p">[</span><span class="n">descr_device</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span><span class="p">[</span><span class="n">descr_device</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span></div>


<div class="viewcode-block" id="NetCDFVariableFlatReader.read">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableFlatReader.read">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the data from the relevant NetCDF file.</span>

<span class="sd">        See the general documentation on class |NetCDFVariableFlat| for some examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>
                <span class="n">timegrid</span> <span class="o">=</span> <span class="n">query_timegrid</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anysequence</span><span class="p">)</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">query_array</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">idxs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span>
                <span class="n">subdev2index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_subdevice2index</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
                <span class="n">first_exception</span><span class="p">:</span> <span class="ne">RuntimeError</span> <span class="o">|</span> <span class="ne">OSError</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">devicename</span><span class="p">,</span> <span class="n">seqs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">:</span>
                                <span class="n">subshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span> <span class="o">+</span> <span class="n">seq</span><span class="o">.</span><span class="n">shape</span>
                                <span class="n">subarray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">subshape</span><span class="p">)</span>
                                <span class="n">temp</span> <span class="o">=</span> <span class="n">devicename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                                    <span class="n">station</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">prod</span><span class="p">)</span>
                                    <span class="n">subarray</span><span class="p">[</span><span class="n">idxs</span> <span class="o">+</span> <span class="n">prod</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span>
                                        <span class="p">:,</span> <span class="n">subdev2index</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
                                    <span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">subarray</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:,</span> <span class="n">subdev2index</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">devicename</span><span class="p">)]</span>
                            <span class="n">series</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">adjust_series</span><span class="p">(</span><span class="n">timegrid</span><span class="p">,</span> <span class="n">subarray</span><span class="p">)</span>
                            <span class="n">seq</span><span class="o">.</span><span class="n">apply_adjusted_series</span><span class="p">(</span><span class="n">timegrid</span><span class="p">,</span> <span class="n">series</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">current_exception</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="p">(</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">Sim</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">Obs</span><span class="p">)):</span>
                                <span class="n">seq</span><span class="o">.</span><span class="n">__hydpy__handle_missing_series_error__</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">seq</span><span class="o">.</span><span class="n">series</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
                                <span class="k">if</span> <span class="n">first_exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">first_exception</span> <span class="o">=</span> <span class="n">current_exception</span>
                <span class="k">if</span> <span class="n">first_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">first_exception</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;While trying to read data from NetCDF file `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The selected NetCDFVariableFlatReader object does neither handle a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;sequence for the (sub)device `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` nor define a member named &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequences</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>



<div class="viewcode-block" id="MixinVariableWriter">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.MixinVariableWriter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MixinVariableWriter</span><span class="p">(</span><span class="n">NetCDFVariable</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin class for |NetCDFVariableFlatWriter| and |NetCDFVariableAggregated|.&quot;&quot;&quot;</span>

    <span class="n">_descr2sequence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span>
    <span class="n">_descr2array</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InfoArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NetCDFVariable</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descr2array</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_anysequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_descr2anysequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span>

<div class="viewcode-block" id="MixinVariableWriter.insert_subdevices">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.MixinVariableWriter.insert_subdevices">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_subdevices</span><span class="p">(</span>
        <span class="n">ncfile</span><span class="p">:</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">subdevicenames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert a variable of the names of the (sub)devices of the logged sequences</span>
<span class="sd">        into the given NetCDF file.</span>

<span class="sd">        We prepare a |NetCDFVariableFlatWriter| subclass with fixed (sub)device names:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlatWriter, chars2str</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">        &gt;&gt;&gt; class Var(NetCDFVariableFlatWriter):</span>
<span class="sd">        ...     pass</span>

<span class="sd">        The first dimension of the added variable corresponds to the number of</span>
<span class="sd">        (sub)devices, and the second dimension to the number of characters of the</span>
<span class="sd">        longest (sub)device name:</span>

<span class="sd">        &gt;&gt;&gt; var = Var(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():</span>
<span class="sd">        ...     ncfile = netcdf4.Dataset(&quot;filename.nc&quot;, &quot;w&quot;)</span>
<span class="sd">        &gt;&gt;&gt; var.insert_subdevices(ncfile, (&quot;element1&quot;, &quot;element_2&quot;, &quot;element_&quot;))</span>
<span class="sd">        &gt;&gt;&gt; ncfile[&quot;station_id&quot;].dimensions</span>
<span class="sd">        (&#39;stations&#39;, &#39;char_leng_name&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ncfile[&quot;station_id&quot;].shape</span>
<span class="sd">        (3, 10)</span>
<span class="sd">        &gt;&gt;&gt; chars2str(ncfile[&quot;station_id&quot;][:].data)</span>
<span class="sd">        [&#39;element1&#39;, &#39;element_2&#39;, &#39;element_&#39;]</span>
<span class="sd">        &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmb_subdevices</span> <span class="o">=</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_subdevices&quot;</span><span class="p">]</span>
        <span class="n">nmb_characters</span> <span class="o">=</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_characters&quot;</span><span class="p">]</span>
        <span class="n">subdevices</span> <span class="o">=</span> <span class="n">varmapping</span><span class="p">[</span><span class="s2">&quot;subdevices&quot;</span><span class="p">]</span>
        <span class="n">statchars</span> <span class="o">=</span> <span class="n">str2chars</span><span class="p">(</span><span class="n">subdevicenames</span><span class="p">)</span>
        <span class="n">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">nmb_subdevices</span><span class="p">,</span> <span class="n">statchars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">nmb_characters</span><span class="p">,</span> <span class="n">statchars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">create_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">subdevices</span><span class="p">,</span> <span class="s2">&quot;S1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">nmb_subdevices</span><span class="p">,</span> <span class="n">nmb_characters</span><span class="p">))</span>
        <span class="n">ncfile</span><span class="p">[</span><span class="n">subdevices</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">statchars</span></div>


<div class="viewcode-block" id="MixinVariableWriter.log">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.MixinVariableWriter.log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,</span>
        <span class="n">infoarray</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InfoArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log the given |IOSequence| object for writing data.</span>

<span class="sd">        When writing data &quot;in one step&quot;, the second argument must be an |InfoArray|.</span>
<span class="sd">        Pass |None| when using |NetCDFVariableFlatWriter| to write data &quot;just in time&quot;.</span>
<span class="sd">        The `infoarray` argument allows for passing alternative data that replaces the</span>
<span class="sd">        original series of the |IOSequence| object.</span>

<span class="sd">        The logged time series data is available via attribute access:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlatWriter</span>
<span class="sd">        &gt;&gt;&gt; class Var(NetCDFVariableFlatWriter):</span>
<span class="sd">        ...     pass</span>
<span class="sd">        &gt;&gt;&gt; var = Var(&quot;filepath.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; nkor = elements.element1.model.sequences.fluxes.nkor</span>
<span class="sd">        &gt;&gt;&gt; var.log(nkor, nkor.series)</span>
<span class="sd">        &gt;&gt;&gt; assert &quot;element1&quot; in dir(var)</span>
<span class="sd">        &gt;&gt;&gt; assert var.element1.sequence is nkor</span>
<span class="sd">        &gt;&gt;&gt; import numpy</span>
<span class="sd">        &gt;&gt;&gt; assert numpy.all(var.element1.array == nkor.series)</span>
<span class="sd">        &gt;&gt;&gt; assert &quot;element2&quot; not in dir(var)</span>
<span class="sd">        &gt;&gt;&gt; var.element2  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AttributeError: The selected NetCDFVariable object does neither handle time \</span>
<span class="sd">series data for the (sub)device `element2` nor define a member named `element2`...</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_dp</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">devicephrase</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span><span class="si">}</span><span class="s2"> of model &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">subseqs</span><span class="o">.</span><span class="n">seqs</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span>

        <span class="n">descr_device</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">descr_device</span>
        <span class="n">old_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">descr_device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span><span class="p">[</span><span class="n">descr_device</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descr2array</span><span class="p">[</span><span class="n">descr_device</span><span class="p">]</span> <span class="o">=</span> <span class="n">infoarray</span>
        <span class="k">elif</span> <span class="n">old_sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sequence</span><span class="p">:</span>
            <span class="n">old_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2array</span><span class="p">[</span><span class="n">descr_device</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">infoarray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">old_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">old_array</span><span class="p">,</span> <span class="n">infoarray</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;When trying to log the time series of sequence </span><span class="si">{</span><span class="n">_dp</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;for writing, the following error occurred: Sequence &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_dp</span><span class="p">(</span><span class="n">old_sequence</span><span class="p">)</span><span class="si">}</span><span class="s2"> is already registered under the same column &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;name(s) but with different time series data.&quot;</span>
                <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A |numpy.ndarray| containing the values of all logged sequences.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__hydpy_write_ncfile__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">subdevicenames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">seriesmatrix</span><span class="p">:</span> <span class="n">MatrixFloat</span><span class="p">,</span>
        <span class="n">timegrid</span><span class="p">:</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Timegrid</span><span class="p">,</span>
        <span class="n">timereference</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cfunit</span><span class="p">:</span> <span class="n">timetools</span><span class="o">.</span><span class="n">TypeUnit</span><span class="p">,</span>
        <span class="n">cfconvention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">namingconvention</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">SeriesConventionType</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">history</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">with</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">history</span><span class="p">:</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2"> by HydPy </span><span class="si">{</span><span class="n">hydpy</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ncfile</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span>
            <span class="k">if</span> <span class="n">namingconvention</span><span class="p">:</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (naming convention: </span><span class="si">{</span><span class="n">namingconvention</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="n">cfconvention</span><span class="p">:</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">Conventions</span> <span class="o">=</span> <span class="n">cfconvention</span>

            <span class="n">opts</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span>
            <span class="k">match</span> <span class="n">timereference</span><span class="p">:</span>
                <span class="k">case</span> <span class="s2">&quot;current&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">opts</span><span class="o">.</span><span class="n">timestampleft</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">timepoints</span> <span class="o">=</span> <span class="n">timegrid</span><span class="o">.</span><span class="n">to_timepoints</span><span class="p">(</span><span class="n">cfunit</span><span class="p">)</span>
                    <span class="n">ncfile</span><span class="o">.</span><span class="n">timereference</span> <span class="o">=</span> <span class="s2">&quot;current time&quot;</span>
                <span class="k">case</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">opts</span><span class="o">.</span><span class="n">timestampleft</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">timepoints</span> <span class="o">=</span> <span class="n">timegrid</span><span class="o">.</span><span class="n">to_timepoints</span><span class="p">(</span><span class="n">cfunit</span><span class="p">)</span>
                    <span class="n">ncfile</span><span class="o">.</span><span class="n">timereference</span> <span class="o">=</span> <span class="s2">&quot;left interval boundary&quot;</span>
                <span class="k">case</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">opts</span><span class="o">.</span><span class="n">timestampleft</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">timepoints</span> <span class="o">=</span> <span class="n">timegrid</span><span class="o">.</span><span class="n">to_timepoints</span><span class="p">(</span><span class="n">cfunit</span><span class="p">)</span>
                    <span class="n">ncfile</span><span class="o">.</span><span class="n">timereference</span> <span class="o">=</span> <span class="s2">&quot;right interval boundary&quot;</span>
                <span class="k">case</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">timepoints</span> <span class="o">=</span> <span class="n">timegrid</span><span class="o">.</span><span class="n">to_timepoints</span><span class="p">(</span><span class="n">cfunit</span><span class="p">)</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                    <span class="n">assert_never</span><span class="p">(</span><span class="n">timereference</span><span class="p">)</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_insert_timepoints</span><span class="p">(</span>
                <span class="n">ncfile</span><span class="o">=</span><span class="n">ncfile</span><span class="p">,</span>
                <span class="n">timepoints</span><span class="o">=</span><span class="n">timepoints</span><span class="p">,</span>
                <span class="n">timeunit</span><span class="o">=</span><span class="n">timegrid</span><span class="o">.</span><span class="n">firstdate</span><span class="o">.</span><span class="n">to_cfunits</span><span class="p">(</span><span class="n">cfunit</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">insert_subdevices</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">subdevicenames</span><span class="o">=</span><span class="n">subdevicenames</span><span class="p">)</span>
            <span class="n">dimensions</span> <span class="o">=</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_timepoints&quot;</span><span class="p">],</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_subdevices&quot;</span><span class="p">]</span>
            <span class="n">create_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span>
            <span class="n">ncfile</span><span class="p">[</span><span class="n">sequence</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">seriesmatrix</span>

<div class="viewcode-block" id="MixinVariableWriter.write">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.MixinVariableWriter.write">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the logged data to a new NetCDF file.</span>

<span class="sd">        See the general documentation on classes |NetCDFVariableFlatWriter| and</span>
<span class="sd">        |NetCDFVariableAggregated| for some examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">timereference</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_timereference_currenttime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_anysequence</span><span class="p">):</span>
            <span class="n">timereference</span> <span class="o">=</span> <span class="s2">&quot;current&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timereference</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span> <span class="k">if</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestampleft</span> <span class="k">else</span> <span class="s2">&quot;right&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__hydpy_write_ncfile__</span><span class="p">(</span>
            <span class="n">filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">subdevicenames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subdevicenames</span><span class="p">,</span>
            <span class="n">seriesmatrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
            <span class="n">timegrid</span><span class="o">=</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
            <span class="n">timereference</span><span class="o">=</span><span class="n">timereference</span><span class="p">,</span>
            <span class="n">cfunit</span><span class="o">=</span><span class="s2">&quot;hours&quot;</span><span class="p">,</span>
            <span class="n">cfconvention</span><span class="o">=</span><span class="s2">&quot;CF-1.8&quot;</span><span class="p">,</span>
            <span class="n">namingconvention</span><span class="o">=</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">sequencemanager</span><span class="o">.</span><span class="n">convention</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]  # pylint: disable=line-too-long</span>
            <span class="n">history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NetCDFVariableInfo</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NetCDFVariableInfo</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2array</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The selected NetCDFVariable object does neither handle time series &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;data for the (sub)device `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` nor define a member named &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>



<div class="viewcode-block" id="NetCDFVariableFlatWriter">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableFlatWriter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFVariableFlatWriter</span><span class="p">(</span><span class="n">MixinVariableWriter</span><span class="p">,</span> <span class="n">NetCDFVariableFlat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Concrete class for writing data from single &quot;flat&quot; NetCDF variables (which deal</span>
<span class="sd">    with unaggregated time series) to single NetCDF files.</span>

<span class="sd">    For a general introduction to using |NetCDFVariableFlatWriter|, see the</span>
<span class="sd">    documentation on base class |NetCDFVariableFlat|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The time series data of all logged |IOSequence| objects in one single</span>
<span class="sd">        |numpy.ndarray| object.</span>

<span class="sd">        The documentation on |NetCDFVariableFlat.shape| explains the structure of</span>
<span class="sd">        |NetCDFVariableFlatWriter.array|.  The first example confirms that the first</span>
<span class="sd">        axis corresponds to time while the second corresponds to the location:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlatWriter</span>
<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatWriter(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     if element.model.name.startswith(&quot;lland&quot;):</span>
<span class="sd">        ...         nied1 = element.model.sequences.inputs.nied</span>
<span class="sd">        ...         var.log(nied1, nied1.series)</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import print_matrix</span>
<span class="sd">        &gt;&gt;&gt; print_matrix(var.array)</span>
<span class="sd">        | 0.0, 4.0, 8.0 |</span>
<span class="sd">        | 1.0, 5.0, 9.0 |</span>
<span class="sd">        | 2.0, 6.0, 10.0 |</span>
<span class="sd">        | 3.0, 7.0, 11.0 |</span>

<span class="sd">        The flattening of higher-dimensional sequences spreads the time series of</span>
<span class="sd">        individual &quot;subdevices&quot; over the array&#39;s columns.  For the 1-dimensional</span>
<span class="sd">        sequence |lland_fluxes.NKor|, we find the time series of both zones of the</span>
<span class="sd">        second element in columns two and three:</span>

<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatWriter(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     if element.model.name.startswith(&quot;lland&quot;):</span>
<span class="sd">        ...         nkor = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...         var.log(nkor, nkor.series)</span>
<span class="sd">        &gt;&gt;&gt; print_matrix(var.array[:, 1:3])</span>
<span class="sd">        | 16.0, 17.0 |</span>
<span class="sd">        | 18.0, 19.0 |</span>
<span class="sd">        | 20.0, 21.0 |</span>
<span class="sd">        | 22.0, 23.0 |</span>

<span class="sd">        The above statements also hold for 2-dimensional sequences like</span>
<span class="sd">        |hland_states.SP|.  In this specific case, each column contains the time series</span>
<span class="sd">        of a single snow class:</span>

<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableFlatWriter(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sp = elements.element4.model.sequences.states.sp</span>
<span class="sd">        &gt;&gt;&gt; var.log(sp, sp.series)</span>
<span class="sd">        &gt;&gt;&gt; print_matrix(var.array)</span>
<span class="sd">        | 68.0, 69.0, 70.0, 71.0, 72.0, 73.0 |</span>
<span class="sd">        | 74.0, 75.0, 76.0, 77.0, 78.0, 79.0 |</span>
<span class="sd">        | 80.0, 81.0, 82.0, 83.0, 84.0, 85.0 |</span>
<span class="sd">        | 86.0, 87.0, 88.0, 89.0, 90.0, 91.0 |</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">NP_FLOAT</span><span class="p">)</span>
        <span class="n">idx0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">idxs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">seq</span><span class="p">,</span> <span class="n">subarray</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descr2array</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">subarray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">subsubarray</span> <span class="o">=</span> <span class="n">subarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">idxs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">prod</span><span class="p">))]</span>
                    <span class="n">array</span><span class="p">[:,</span> <span class="n">idx0</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsubarray</span>
                <span class="n">idx0</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">array</span></div>



<div class="viewcode-block" id="NetCDFVariableAggregated">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableAggregated">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFVariableAggregated</span><span class="p">(</span><span class="n">MixinVariableWriter</span><span class="p">,</span> <span class="n">NetCDFVariable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Concrete class for writing data from single &quot;aggregated&quot; NetCDF variables (which</span>
<span class="sd">    deal with aggregated time series) to single NetCDF files.</span>

<span class="sd">    Class |NetCDFVariableAggregated| works very similarly to class</span>
<span class="sd">    |NetCDFVariableFlatWriter|. The following is a selection of the more thoroughly</span>
<span class="sd">    explained examples of the documentation on class |NetCDFVariableFlat|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, (element1, element2, element3, element4) = prepare_io_example_1()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableAggregated</span>
<span class="sd">    &gt;&gt;&gt; var_nied = NetCDFVariableAggregated(&quot;nied.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor = NetCDFVariableAggregated(&quot;nkor.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; var_sp = NetCDFVariableAggregated(&quot;sp.nc&quot;)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element2):</span>
<span class="sd">    ...     nied = element.model.sequences.inputs.nied</span>
<span class="sd">    ...     var_nied.log(nied, nied.average_series())</span>
<span class="sd">    ...     nkor = element.model.sequences.fluxes.nkor</span>
<span class="sd">    ...     var_nkor.log(nkor, nkor.average_series())</span>
<span class="sd">    &gt;&gt;&gt; sp = element4.model.sequences.states.sp</span>
<span class="sd">    &gt;&gt;&gt; var_sp.log(sp, sp.average_series())</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import pub, TestIO</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     var_nied.write()</span>
<span class="sd">    ...     var_nkor.write()</span>
<span class="sd">    ...     var_sp.write()</span>

<span class="sd">    As |NetCDFVariableAggregated| provides no reading functionality, we show that the</span>
<span class="sd">    aggregated values are readily available using the external NetCDF4 library:</span>

<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import print_matrix</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(&quot;nied.nc&quot;, &quot;r&quot;) as ncfile:</span>
<span class="sd">    ...     print_matrix(numpy.array(ncfile[&quot;nied&quot;][:]))</span>
<span class="sd">    | 0.0, 4.0 |</span>
<span class="sd">    | 1.0, 5.0 |</span>
<span class="sd">    | 2.0, 6.0 |</span>
<span class="sd">    | 3.0, 7.0 |</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(&quot;nkor.nc&quot;, &quot;r&quot;) as ncfile:</span>
<span class="sd">    ...     print_matrix(numpy.array(ncfile[&quot;nkor&quot;][:]))</span>
<span class="sd">    | 12.0, 16.5 |</span>
<span class="sd">    | 13.0, 18.5 |</span>
<span class="sd">    | 14.0, 20.5 |</span>
<span class="sd">    | 15.0, 22.5 |</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(&quot;sp.nc&quot;, &quot;r&quot;) as ncfile:</span>
<span class="sd">    ...     print_matrix(numpy.array(ncfile[&quot;sp&quot;][:]))</span>
<span class="sd">    | 70.5 |</span>
<span class="sd">    | 76.5 |</span>
<span class="sd">    | 82.5 |</span>
<span class="sd">    | 88.5 |</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Required shape of |NetCDFVariableAggregated.array|.</span>

<span class="sd">        The first axis corresponds to the number of timesteps and the second axis to</span>
<span class="sd">        the number of devices.  We show this for the 1-dimensional input sequence</span>
<span class="sd">        |lland_fluxes.NKor|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableAggregated</span>
<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableAggregated(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     if element.model.name.startswith(&quot;lland&quot;):</span>
<span class="sd">        ...         var.log(element.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; var.shape</span>
<span class="sd">        (4, 3)</span>

<span class="sd">        There is no difference for 2-dimensional sequences as aggregating their time</span>
<span class="sd">        series also results in 1-dimensional data:</span>

<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableAggregated(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; var.log(elements.element4.model.sequences.states.sp, None)</span>
<span class="sd">        &gt;&gt;&gt; var.shape</span>
<span class="sd">        (4, 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The aggregated time series data of all logged |IOSequence| objects in a</span>
<span class="sd">        single |numpy.ndarray| object.</span>

<span class="sd">        The documentation on |NetCDFVariableAggregated.shape| explains the structure of</span>
<span class="sd">        |NetCDFVariableAggregated.array|.  This first example confirms that the first</span>
<span class="sd">        axis corresponds to time while the second corresponds to the location:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableAggregated</span>
<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableAggregated(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     if element.model.name.startswith(&quot;lland&quot;):</span>
<span class="sd">        ...         nkor = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...         var.log(nkor, nkor.average_series())</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import print_matrix</span>
<span class="sd">        &gt;&gt;&gt; print_matrix(var.array)</span>
<span class="sd">        | 12.0, 16.5, 25.0 |</span>
<span class="sd">        | 13.0, 18.5, 28.0 |</span>
<span class="sd">        | 14.0, 20.5, 31.0 |</span>
<span class="sd">        | 15.0, 22.5, 34.0 |</span>

<span class="sd">        There is no difference for 2-dimensional sequences as aggregating their time</span>
<span class="sd">        series also results in 1-dimensional data:</span>

<span class="sd">        &gt;&gt;&gt; var = NetCDFVariableAggregated(&quot;filename.nc&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sp = elements.element4.model.sequences.states.sp</span>
<span class="sd">        &gt;&gt;&gt; var.log(sp, sp.average_series())</span>
<span class="sd">        &gt;&gt;&gt; print_matrix(var.array)</span>
<span class="sd">        | 70.5 |</span>
<span class="sd">        | 76.5 |</span>
<span class="sd">        | 82.5 |</span>
<span class="sd">        | 88.5 |</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">NP_FLOAT</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">subarray</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descr2array</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">subarray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">array</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">subarray</span>
        <span class="k">return</span> <span class="n">array</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">subdevicenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The names of all relevant devices.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descr2sequence</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>



<div class="viewcode-block" id="NetCDFInterfaceBase">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFInterfaceBase</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">TypeNetCDFVariable</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for interfaces between |SequenceManager| and multiple NetCDF files.</span>

<span class="sd">    The core task of all concrete |NetCDFInterfaceBase| subclasses is to distribute</span>
<span class="sd">    different |IOSequence| objects on multiple instances of the concrete subclasses of</span>
<span class="sd">    |NetCDFVariable|.  The following examples describe the functioning of the</span>
<span class="sd">    subclasses |NetCDFInterfaceReader| and |NetCDFInterfaceWriter|, which serve to read</span>
<span class="sd">    and write data &quot;in one step&quot;, respectively.</span>

<span class="sd">    We prepare a |SequenceManager| object and some devices handling different sequences</span>
<span class="sd">    by applying function |prepare_io_example_1|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>

<span class="sd">    We collect all sequences used in the following examples except |lland_fluxes.NKor|</span>
<span class="sd">    of element `element1`, which we reserve for special tests:</span>

<span class="sd">    &gt;&gt;&gt; sequences = []</span>
<span class="sd">    &gt;&gt;&gt; for node in nodes:</span>
<span class="sd">    ...     sequences.append(node.sequences.sim)</span>
<span class="sd">    &gt;&gt;&gt; for element in elements:</span>
<span class="sd">    ...     if element.model.name == &quot;hland_96&quot;:</span>
<span class="sd">    ...         sequences.append(element.model.sequences.states.sp)</span>
<span class="sd">    ...     else:</span>
<span class="sd">    ...         sequences.append(element.model.sequences.inputs.nied)</span>
<span class="sd">    ...         if element.name != &quot;element1&quot;:</span>
<span class="sd">    ...             sequences.append(element.model.sequences.fluxes.nkor)</span>

<span class="sd">    We prepare a |NetCDFInterfaceWriter| object and log and write all test sequences</span>
<span class="sd">    except |lland_fluxes.NKor| of element `element1`.  |NetCDFInterfaceWriter|</span>
<span class="sd">    initialises one |NetCDFVariableFlatWriter| and one |NetCDFVariableAggregated|</span>
<span class="sd">    object for each |IOSequence| subtype:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFInterfaceWriter</span>
<span class="sd">    &gt;&gt;&gt; writer = NetCDFInterfaceWriter()</span>
<span class="sd">    &gt;&gt;&gt; len(writer)</span>
<span class="sd">    0</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub, TestIO</span>
<span class="sd">    &gt;&gt;&gt; pub.sequencemanager.filetype = &quot;nc&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     for sequence in sequences:</span>
<span class="sd">    ...         _ = writer.log(sequence, sequence.series)</span>
<span class="sd">    ...         with pub.sequencemanager.aggregation(&quot;mean&quot;):</span>
<span class="sd">    ...             _ = writer.log(sequence, sequence.average_series())</span>
<span class="sd">    &gt;&gt;&gt; len(writer)</span>
<span class="sd">    14</span>

<span class="sd">    We change the relevant directory before logging the reserved sequence.</span>
<span class="sd">    |NetCDFInterfaceWriter| initialises two new |NetCDFVariable| objects, despite</span>
<span class="sd">    other |NetCDFVariable| objects related to the same sequence type already being</span>
<span class="sd">    available:</span>

<span class="sd">    &gt;&gt;&gt; nkor = elements.element1.model.sequences.fluxes.nkor</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     pub.sequencemanager.currentdir = &quot;test&quot;</span>
<span class="sd">    ...     _ = writer.log(nkor, nkor.series)</span>
<span class="sd">    ...     with pub.sequencemanager.aggregation(&quot;mean&quot;):</span>
<span class="sd">    ...         _ = writer.log(nkor, nkor.average_series())</span>
<span class="sd">    &gt;&gt;&gt; len(writer)</span>
<span class="sd">    16</span>

<span class="sd">    You can query all relevant folder names and filenames via properties</span>
<span class="sd">    |NetCDFInterfaceBase.foldernames| and |NetCDFInterfaceBase.filenames|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import print_vector</span>
<span class="sd">    &gt;&gt;&gt; print_vector(writer.foldernames)</span>
<span class="sd">    default, test</span>
<span class="sd">    &gt;&gt;&gt; print_vector(writer.filenames)</span>
<span class="sd">    hland_96_state_sp, hland_96_state_sp_mean, lland_dd_flux_nkor,</span>
<span class="sd">    lland_dd_flux_nkor_mean, lland_dd_input_nied,</span>
<span class="sd">    lland_dd_input_nied_mean, lland_knauf_flux_nkor,</span>
<span class="sd">    lland_knauf_flux_nkor_mean, lland_knauf_input_nied,</span>
<span class="sd">    lland_knauf_input_nied_mean, sim_q, sim_q_mean, sim_t, sim_t_mean</span>

<span class="sd">    |NetCDFInterfaceWriter| provides attribute access to its |NetCDFVariable|</span>
<span class="sd">    instances, both via their filenames and the combination of their folder names and</span>
<span class="sd">    filenames:</span>

<span class="sd">    &gt;&gt;&gt; assert writer.sim_q is writer.default_sim_q</span>
<span class="sd">    &gt;&gt;&gt; print_vector(sorted(set(dir(writer)) - set(object.__dir__(writer))))</span>
<span class="sd">    default_hland_96_state_sp, default_hland_96_state_sp_mean,</span>
<span class="sd">    default_lland_dd_flux_nkor, default_lland_dd_flux_nkor_mean,</span>
<span class="sd">    default_lland_dd_input_nied, default_lland_dd_input_nied_mean,</span>
<span class="sd">    default_lland_knauf_flux_nkor, default_lland_knauf_flux_nkor_mean,</span>
<span class="sd">    default_lland_knauf_input_nied, default_lland_knauf_input_nied_mean,</span>
<span class="sd">    default_sim_q, default_sim_q_mean, default_sim_t, default_sim_t_mean,</span>
<span class="sd">    hland_96_state_sp, hland_96_state_sp_mean, lland_dd_input_nied,</span>
<span class="sd">    lland_dd_input_nied_mean, lland_knauf_flux_nkor,</span>
<span class="sd">    lland_knauf_flux_nkor_mean, lland_knauf_input_nied,</span>
<span class="sd">    lland_knauf_input_nied_mean, sim_q, sim_q_mean, sim_t, sim_t_mean,</span>
<span class="sd">    test_lland_dd_flux_nkor, test_lland_dd_flux_nkor_mean</span>

<span class="sd">    If multiple NetCDF files have the same name, you must prefix the relevant folder</span>
<span class="sd">    name:</span>

<span class="sd">    &gt;&gt;&gt; writer.lland_dd_flux_nkor</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: The current NetCDFInterface object handles multiple NetCDF files \</span>
<span class="sd">named `lland_dd_flux_nkor`.  Please be more specific.</span>
<span class="sd">    &gt;&gt;&gt; assert hasattr(writer, &quot;default_lland_dd_flux_nkor&quot;)</span>

<span class="sd">    |NetCDFInterfaceWriter| raises the following error for completely wrong attribute</span>
<span class="sd">    names:</span>

<span class="sd">    &gt;&gt;&gt; writer.lland_dd</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    AttributeError: The current NetCDFInterface object neither handles a NetCDF file \</span>
<span class="sd">named `lland_dd` nor does it define a member named `lland_dd`.</span>

<span class="sd">    We write all NetCDF files into the `default` folder of the testing directory,</span>
<span class="sd">    defined by |prepare_io_example_1|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     writer.write()</span>

<span class="sd">    We define a shorter initialisation period and re-activate the time series of the</span>
<span class="sd">    test sequences:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">    &gt;&gt;&gt; pub.timegrids = &quot;02.01.2000&quot;, &quot;04.01.2000&quot;, &quot;1d&quot;</span>
<span class="sd">    &gt;&gt;&gt; for sequence in sequences:</span>
<span class="sd">    ...     sequence.prepare_series(allocate_ram=False)</span>
<span class="sd">    ...     sequence.prepare_series(allocate_ram=True)</span>
<span class="sd">    &gt;&gt;&gt; nkor.prepare_series(allocate_ram=False)</span>
<span class="sd">    &gt;&gt;&gt; nkor.prepare_series(allocate_ram=True)</span>

<span class="sd">    We now initialise an object of class |NetCDFInterfaceReader|, log all test</span>
<span class="sd">    sequences, and read the test data of the defined subperiod:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFInterfaceReader</span>
<span class="sd">    &gt;&gt;&gt; reader = NetCDFInterfaceReader()</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     _ = reader.log(nkor)</span>
<span class="sd">    ...     pub.sequencemanager.currentdir = &quot;default&quot;</span>
<span class="sd">    ...     for sequence in sequences:</span>
<span class="sd">    ...         _ = reader.log(sequence)</span>
<span class="sd">    ...     reader.read()</span>
<span class="sd">    &gt;&gt;&gt; nodes.node1.sequences.sim.series</span>
<span class="sd">    InfoArray([61., 62.])</span>
<span class="sd">    &gt;&gt;&gt; elements.element2.model.sequences.fluxes.nkor.series</span>
<span class="sd">    InfoArray([[18., 19.],</span>
<span class="sd">               [20., 21.]])</span>
<span class="sd">    &gt;&gt;&gt; elements.element4.model.sequences.states.sp.series</span>
<span class="sd">    InfoArray([[[74., 75., 76.],</span>
<span class="sd">                [77., 78., 79.]],</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">               [[80., 81., 82.],</span>
<span class="sd">                [83., 84., 85.]]])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dir2file2var</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TypeNetCDFVariable</span><span class="p">]]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir2file2var</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_dir2file_stem</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TypeNetCDFVariable</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">dirpath</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file2var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir2file2var</span><span class="p">[</span><span class="n">dirpath</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">file2var</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir2file2var</span><span class="p">[</span><span class="n">dirpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">file2var</span>
        <span class="n">stem</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">file2var</span><span class="p">,</span> <span class="n">stem</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">foldernames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The names of all folders the sequences shall be read from or written to.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">d</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir2file2var</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The base file names of all handled |NetCDFVariable| objects.&quot;&quot;&quot;</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">(</span><span class="n">file2var</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">file2var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir2file2var</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">filenames</span><span class="p">))))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeNetCDFVariable</span><span class="p">:</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">file2var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir2file2var</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">file2var</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">variable</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">memory</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">memory</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The current NetCDFInterface object handles multiple NetCDF files &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.  Please be more specific.&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The current NetCDFInterface object neither handles a NetCDF file named &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` nor does it define a member named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
        <span class="p">)</span>

    <span class="n">__copy__</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">copy_</span>
    <span class="n">__deepcopy__</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">deepcopy_</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ncfiles</span> <span class="k">for</span> <span class="n">ncfiles</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">TypeNetCDFVariable</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">file2var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir2file2var</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="n">file2var</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">adds_long</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">counter</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">file2var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir2file2var</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file2var</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">adds_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">counter</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">adds_short</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">nmb</span> <span class="ow">in</span> <span class="n">counter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">nmb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">())</span> <span class="o">+</span> <span class="n">adds_long</span> <span class="o">+</span> <span class="n">adds_short</span></div>



<div class="viewcode-block" id="NetCDFInterfaceReader">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceReader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFInterfaceReader</span><span class="p">(</span><span class="n">NetCDFInterfaceBase</span><span class="p">[</span><span class="n">NetCDFVariableFlatReader</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface between |SequenceManager| and multiple |NetCDFVariableFlatReader|</span>
<span class="sd">    instances for reading data in one step.</span>

<span class="sd">    For a general introduction to using |NetCDFInterfaceReader|, see the</span>
<span class="sd">    documentation on base class |NetCDFInterfaceBase|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NetCDFInterfaceReader.log">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceReader.log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NetCDFVariableFlatReader</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pass the given |IOSequence| to the log method of an already existing or, if</span>
<span class="sd">        necessary, freshly created |NetCDFVariableFlatReader| object.&quot;&quot;&quot;</span>
        <span class="n">file2var</span><span class="p">,</span> <span class="n">stem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dir2file_stem</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">file2var</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">NetCDFVariableFlatReader</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">file2var</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="n">variable</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variable</span></div>


<div class="viewcode-block" id="NetCDFInterfaceReader.read">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceReader.read">[docs]</a>
    <span class="nd">@printtools</span><span class="o">.</span><span class="n">print_progress</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call method |NetCDFVariableFlatReader.read| of all handled</span>
<span class="sd">        |NetCDFVariableFlatReader| objects.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">printtools</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="NetCDFInterfaceWriter">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceWriter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFInterfaceWriter</span><span class="p">(</span>
    <span class="n">NetCDFInterfaceBase</span><span class="p">[</span><span class="n">NetCDFVariableAggregated</span> <span class="o">|</span> <span class="n">NetCDFVariableFlatWriter</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface between |SequenceManager| and multiple |NetCDFVariableFlatWriter| or</span>
<span class="sd">    |NetCDFVariableAggregated| instances for writing data in one step.</span>

<span class="sd">    For a general introduction to using |NetCDFInterfaceWriter|, see the</span>
<span class="sd">    documentation on base class |NetCDFInterfaceBase|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NetCDFInterfaceWriter.log">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceWriter.log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,</span>
        <span class="n">infoarray</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InfoArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NetCDFVariableAggregated</span> <span class="o">|</span> <span class="n">NetCDFVariableFlatWriter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pass the given |IOSequence| to the log method of an already existing or, if</span>
<span class="sd">        necessary, freshly created |NetCDFVariableFlatWriter| or</span>
<span class="sd">        |NetCDFVariableAggregated| object (depending on the currently active</span>
<span class="sd">        |SequenceManager.aggregation| mode).&quot;&quot;&quot;</span>
        <span class="n">file2var</span><span class="p">,</span> <span class="n">stem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dir2file_stem</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">file2var</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">sequencemanager</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">NetCDFVariableAggregated</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">NetCDFVariableFlatWriter</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">file2var</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="n">variable</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">infoarray</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variable</span></div>


<div class="viewcode-block" id="NetCDFInterfaceWriter.write">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceWriter.write">[docs]</a>
    <span class="nd">@printtools</span><span class="o">.</span><span class="n">print_progress</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call method |MixinVariableWriter.write| of all handled</span>
<span class="sd">        |NetCDFVariableFlatWriter| and |NetCDFVariableAggregated| objects.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">printtools</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="NetCDFInterfaceJIT">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceJIT">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NetCDFInterfaceJIT</span><span class="p">(</span><span class="n">NetCDFInterfaceBase</span><span class="p">[</span><span class="n">FlatUnion</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface between |SequenceManager| and multiple |NetCDFVariableFlatWriter|</span>
<span class="sd">    instances for reading or writing data just in time.</span>

<span class="sd">    See the documentation on method |NetCDFInterfaceJIT.provide_jitaccess| for further</span>
<span class="sd">    information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NetCDFInterfaceJIT.log">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceJIT.log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlatUnion</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pass the given |IOSequence| to the log method of an already existing or, if</span>
<span class="sd">        necessary, freshly created |NetCDFVariableFlatWriter| object.&quot;&quot;&quot;</span>
        <span class="n">file2var</span><span class="p">,</span> <span class="n">stem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dir2file_stem</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">file2var</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sequence</span><span class="o">.</span><span class="n">diskflag_reading</span><span class="p">:</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">NetCDFVariableFlatReader</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">NetCDFVariableFlatWriter</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">file2var</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="n">variable</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variable</span></div>


<div class="viewcode-block" id="NetCDFInterfaceJIT.provide_jitaccess">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterfaceJIT.provide_jitaccess">[docs]</a>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">provide_jitaccess</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">deviceorder</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span> <span class="o">|</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">JITAccessHandler</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allow method |HydPy.simulate| of class |HydPy| to read data from or write</span>
<span class="sd">        data to NetCDF files &quot;just in time&quot; during simulation runs.</span>

<span class="sd">        We consider it unlikely users need ever to call the method</span>
<span class="sd">        |NetCDFInterfaceJIT.provide_jitaccess| directly.  See the documentation on</span>
<span class="sd">        class |HydPy| on applying it indirectly.  However, the following explanations</span>
<span class="sd">        might give some additional insights into the options and limitations of the</span>
<span class="sd">        related functionalities.</span>

<span class="sd">        You can only either read from or write to each NetCDF file.  We think this</span>
<span class="sd">        should rarely be a limitation for the anticipated workflows.  One particular</span>
<span class="sd">        situation where one could eventually try to read and write simultaneously is</span>
<span class="sd">        when trying to overwrite some of the available input data.  The following</span>
<span class="sd">        example tries to read the input data for all &quot;headwater&quot; catchments from</span>
<span class="sd">        specific NetCDF files but defines zero input values for all &quot;non-headwater&quot;</span>
<span class="sd">        catchments and tries to write them into the same files:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import prepare_full_example_1</span>
<span class="sd">        &gt;&gt;&gt; prepare_full_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import HydPy, print_vector, pub, TestIO</span>
<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     hp = HydPy(&quot;HydPy-H-Lahn&quot;)</span>
<span class="sd">        ...     pub.timegrids = &quot;1996-01-01&quot;, &quot;1996-01-05&quot;, &quot;1d&quot;</span>
<span class="sd">        ...     hp.prepare_network()</span>
<span class="sd">        ...     hp.prepare_models()</span>
<span class="sd">        ...     hp.load_conditions()</span>
<span class="sd">        ...     headwaters = pub.selections[&quot;headwaters&quot;].elements</span>
<span class="sd">        ...     nonheadwaters = pub.selections[&quot;nonheadwaters&quot;].elements</span>
<span class="sd">        ...     headwaters.prepare_inputseries(allocate_ram=False, read_jit=True)</span>
<span class="sd">        ...     nonheadwaters.prepare_inputseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     for element in nonheadwaters:</span>
<span class="sd">        ...         for sequence in element.model.sequences.inputs:</span>
<span class="sd">        ...             sequence.series = 0.0</span>
<span class="sd">        ...     hp.simulate()  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: While trying to prepare NetCDF files for reading or writing \</span>
<span class="sd">data &quot;just in time&quot; during the current simulation run, the following error occurred: \</span>
<span class="sd">For a specific NetCDF file, you can either read or write data during a simulation run \</span>
<span class="sd">but for file `...hland_96_input_p.nc` both is requested.</span>

<span class="sd">        Clearly, each NetCDF file we want to read data from needs to span the current</span>
<span class="sd">        simulation period:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     pub.timegrids.init.firstdate = &quot;1987-01-01&quot;</span>
<span class="sd">        ...     pub.timegrids.sim.firstdate = &quot;1988-01-01&quot;</span>
<span class="sd">        ...     hp.prepare_inputseries(allocate_ram=False, read_jit=True)</span>
<span class="sd">        ...     hp.simulate()  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: While trying to prepare NetCDF files for reading or writing \</span>
<span class="sd">data &quot;just in time&quot; during the current simulation run, the following error occurred: \</span>
<span class="sd">The data of the NetCDF `...hland_96_input_p.nc` (Timegrid(&quot;1989-11-01 00:00:00&quot;, \</span>
<span class="sd">&quot;2021-01-01 00:00:00&quot;, &quot;1d&quot;)) does not correctly cover the current simulation period \</span>
<span class="sd">(Timegrid(&quot;1988-01-01 00:00:00&quot;, &quot;1996-01-05 00:00:00&quot;, &quot;1d&quot;)).</span>

<span class="sd">        However, each NetCDF file selected for writing must also cover the complete</span>
<span class="sd">        initialisation period.  If there is no adequately named NetCDF file,</span>
<span class="sd">        |NetCDFInterfaceJIT.provide_jitaccess| creates a new one for the current</span>
<span class="sd">        initialisation period.  If an adequately named file exists,</span>
<span class="sd">        |NetCDFInterfaceJIT.provide_jitaccess| uses it without any attempt to extend it</span>
<span class="sd">        temporally or spatially.  The following example shows the insertion of the</span>
<span class="sd">        output data of two subsequent simulation runs into the same NetCDF files:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     pub.timegrids = &quot;1996-01-01&quot;, &quot;1996-01-05&quot;, &quot;1d&quot;</span>
<span class="sd">        ...     hp.prepare_inputseries(allocate_ram=False, read_jit=True)</span>
<span class="sd">        ...     hp.prepare_factorseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     pub.timegrids.sim.lastdate = &quot;1996-01-03&quot;</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        ...     pub.timegrids.sim.firstdate = &quot;1996-01-03&quot;</span>
<span class="sd">        ...     pub.timegrids.sim.lastdate = &quot;1996-01-05&quot;</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        &gt;&gt;&gt; print_vector(</span>
<span class="sd">        ...     hp.elements[&quot;land_dill_assl&quot;].model.sequences.factors.contriarea.series)</span>
<span class="sd">        0.497067, 0.496728, 0.496461, 0.496361</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">        &gt;&gt;&gt; filepath = &quot;HydPy-H-Lahn/series/default/hland_96_factor_contriarea.nc&quot;</span>
<span class="sd">        &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath, &quot;r&quot;) as ncfile:</span>
<span class="sd">        ...     print_vector(ncfile[&quot;hland_96_factor_contriarea&quot;][:, 0])</span>
<span class="sd">        0.497067, 0.496728, 0.496461, 0.496361</span>

<span class="sd">        Under particular circumstances, the data variable of a NetCDF file can be</span>
<span class="sd">        3-dimensional.  The documentation on function |query_array| explains this in</span>
<span class="sd">        detail.  The following example demonstrates that reading and writing such</span>
<span class="sd">        3-dimensional variables &quot;just in time&quot; works correctly.  Therefore, we add a</span>
<span class="sd">        `realization` dimension to the input file `hland_96_input_t.nc` (part of the</span>
<span class="sd">        example project data) and the output file `hland_96_factor_contriarea.nc`</span>
<span class="sd">        (written in the previous example) and use them for redefining their data</span>
<span class="sd">        variables with this additional dimension.  As expected, the results are the</span>
<span class="sd">        same as in the previous example:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     for name in (&quot;hland_96_input_t&quot;, &quot;hland_96_factor_contriarea&quot;):</span>
<span class="sd">        ...         filepath = f&quot;HydPy-H-Lahn/series/default/{name}.nc&quot;</span>
<span class="sd">        ...         with netcdf4.Dataset(filepath, &quot;r+&quot;) as ncfile:</span>
<span class="sd">        ...             ncfile.renameVariable(name, &quot;old&quot;)</span>
<span class="sd">        ...             _ = ncfile.createDimension(&quot;realization&quot;, 1)</span>
<span class="sd">        ...             var = ncfile.createVariable(name, &quot;f8&quot;,</span>
<span class="sd">        ...                     dimensions=(&quot;time&quot;, &quot;realization&quot;, &quot;stations&quot;))</span>
<span class="sd">        ...             if name == &quot;hland_96_input_t&quot;:</span>
<span class="sd">        ...                 var[:] = ncfile[&quot;old&quot;][:]</span>
<span class="sd">        ...             else:</span>
<span class="sd">        ...                 var[:] = -999.0</span>
<span class="sd">        ...     pub.timegrids = &quot;1996-01-01&quot;, &quot;1996-01-05&quot;, &quot;1d&quot;</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath, &quot;r&quot;) as ncfile:</span>
<span class="sd">        ...     print_vector(ncfile[&quot;hland_96_factor_contriarea&quot;][:, 0, 0])</span>
<span class="sd">        0.496003, 0.495664, 0.495398, 0.495298</span>

<span class="sd">        If we try to write the output of a simulation run beyond the original</span>
<span class="sd">        initial initialisation period into the same files,</span>
<span class="sd">        |NetCDFInterfaceJIT.provide_jitaccess| raises an equal error as above:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     pub.timegrids = &quot;1996-01-05&quot;, &quot;1996-01-10&quot;, &quot;1d&quot;</span>
<span class="sd">        ...     hp.prepare_inputseries(allocate_ram=True, read_jit=False)</span>
<span class="sd">        ...     hp.prepare_factorseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     hp.simulate()  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: While trying to prepare NetCDF files for reading or writing \</span>
<span class="sd">data &quot;just in time&quot; during the current simulation run, the following error occurred: \</span>
<span class="sd">The data of the NetCDF `...hland_96_factor_tc.nc` (Timegrid(&quot;1996-01-01 00:00:00&quot;, \</span>
<span class="sd">&quot;1996-01-05 00:00:00&quot;, &quot;1d&quot;)) does not correctly cover the current simulation period \</span>
<span class="sd">(Timegrid(&quot;1996-01-05 00:00:00&quot;, &quot;1996-01-10 00:00:00&quot;, &quot;1d&quot;)).</span>

<span class="sd">        &gt;&gt;&gt; hp.prepare_factorseries(allocate_ram=False, write_jit=False)</span>

<span class="sd">        Regarding the spatial dimension, things are similar.  You can write data for</span>
<span class="sd">        different sequences in subsequent simulation runs, but you need to ensure all</span>
<span class="sd">        required data columns are available right from the start.  Hence, relying on</span>
<span class="sd">        the automatic file generation of |NetCDFInterfaceJIT.provide_jitaccess| fails</span>
<span class="sd">        in the following example:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     pub.timegrids = &quot;1996-01-01&quot;, &quot;1996-01-05&quot;, &quot;1d&quot;</span>
<span class="sd">        ...     hp.prepare_inputseries(allocate_ram=False, read_jit=True)</span>
<span class="sd">        ...     headwaters.prepare_fluxseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        ...     nonheadwaters.prepare_fluxseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     hp.simulate()  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        OSError: While trying to prepare NetCDF files for reading or writing data \</span>
<span class="sd">&quot;just in time&quot; during the current simulation run, the following error occurred: No \</span>
<span class="sd">data for (sub)device `land_lahn_kalk_0` is available in NetCDF file \</span>
<span class="sd">`...hland_96_flux_pc.nc`.</span>

<span class="sd">        Of course, one way to prepare complete HydPy-compatible NetCDF files is to let</span>
<span class="sd">        HydPy do it:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0), pub.sequencemanager.filetype(&quot;nc&quot;):</span>
<span class="sd">        ...     hp.prepare_fluxseries(allocate_ram=False, write_jit=False)</span>
<span class="sd">        ...     hp.prepare_fluxseries(allocate_ram=True, write_jit=False)</span>
<span class="sd">        ...     hp.save_fluxseries()</span>
<span class="sd">        ...     headwaters.prepare_fluxseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     hp.load_conditions()</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.search_keywords(&quot;catchment&quot;):</span>
<span class="sd">        ...     print_vector(element.model.sequences.fluxes.qt.series)</span>
<span class="sd">        11.757526, 8.865079, 7.101815, 5.994195</span>
<span class="sd">        11.672862, 10.100089, 8.984317, 8.202706</span>
<span class="sd">        20.588949, 8.644722, 7.265526, 6.385012</span>
<span class="sd">        9.64767, 8.513649, 7.777628, 7.343314</span>
<span class="sd">        &gt;&gt;&gt; filepath_qt = &quot;HydPy-H-Lahn/series/default/hland_96_flux_qt.nc&quot;</span>
<span class="sd">        &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath_qt, &quot;r&quot;) as ncfile:</span>
<span class="sd">        ...     for jdx in range(4):</span>
<span class="sd">        ...         print_vector(ncfile[&quot;hland_96_flux_qt&quot;][:, jdx])</span>
<span class="sd">        11.757526, 8.865079, 7.101815, 5.994195</span>
<span class="sd">        0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        9.64767, 8.513649, 7.777628, 7.343314</span>
<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     headwaters.prepare_fluxseries(allocate_ram=True, write_jit=False)</span>
<span class="sd">        ...     nonheadwaters.prepare_fluxseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     hp.load_conditions()</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath_qt, &quot;r&quot;) as ncfile:</span>
<span class="sd">        ...         for jdx in range(4):</span>
<span class="sd">        ...             print_vector(ncfile[&quot;hland_96_flux_qt&quot;][:, jdx])</span>
<span class="sd">        11.757526, 8.865079, 7.101815, 5.994195</span>
<span class="sd">        11.672862, 10.100089, 8.984317, 8.202706</span>
<span class="sd">        20.588949, 8.644722, 7.265526, 6.385012</span>
<span class="sd">        9.64767, 8.513649, 7.777628, 7.343314</span>

<span class="sd">        &gt;&gt;&gt; hp.prepare_fluxseries(allocate_ram=False, write_jit=False)</span>

<span class="sd">        There should be no limitation for reading data &quot;just in time&quot; and using</span>
<span class="sd">        different |Node.deploymode| options.  For demonstration, we first calculate the</span>
<span class="sd">        time series of the |Sim| sequences of all nodes, assign them to the</span>
<span class="sd">        corresponding |Obs| sequences afterwards, and then start another simulation to</span>
<span class="sd">        (again) write both the simulated and the observed values to NetCDF files:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     hp.prepare_simseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     hp.prepare_obsseries(allocate_ram=True, write_jit=True)</span>
<span class="sd">        ...     hp.load_conditions()</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        ...     for idx, node in enumerate(hp.nodes):</span>
<span class="sd">        ...         node.sequences.obs.series = node.sequences.sim.series</span>
<span class="sd">        ...     hp.load_conditions()</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        &gt;&gt;&gt; for node in hp.nodes:</span>
<span class="sd">        ...     print_vector(node.sequences.sim.series)</span>
<span class="sd">        11.757526, 8.865079, 7.101815, 5.994195</span>
<span class="sd">        54.019337, 37.257561, 31.865308, 28.359542</span>
<span class="sd">        42.346475, 27.157472, 22.88099, 20.156836</span>
<span class="sd">        9.64767, 8.513649, 7.777628, 7.343314</span>
<span class="sd">        &gt;&gt;&gt; for node in hp.nodes:</span>
<span class="sd">        ...     print_vector(node.sequences.obs.series)</span>
<span class="sd">        11.757526, 8.865079, 7.101815, 5.994195</span>
<span class="sd">        54.019337, 37.257561, 31.865308, 28.359542</span>
<span class="sd">        42.346475, 27.157472, 22.88099, 20.156836</span>
<span class="sd">        9.64767, 8.513649, 7.777628, 7.343314</span>
<span class="sd">        &gt;&gt;&gt; filepath_sim = &quot;HydPy-H-Lahn/series/default/sim_q.nc&quot;</span>
<span class="sd">        &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath_sim, &quot;r&quot;) as ncfile:</span>
<span class="sd">        ...     for jdx in range(4):</span>
<span class="sd">        ...         print_vector(ncfile[&quot;sim_q&quot;][:, jdx])</span>
<span class="sd">        11.757526, 8.865079, 7.101815, 5.994195</span>
<span class="sd">        9.64767, 8.513649, 7.777628, 7.343314</span>
<span class="sd">        42.346475, 27.157472, 22.88099, 20.156836</span>
<span class="sd">        54.019337, 37.257561, 31.865308, 28.359542</span>
<span class="sd">        &gt;&gt;&gt; filepath_obs = &quot;HydPy-H-Lahn/series/default/obs_q.nc&quot;</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import query_timegrid</span>
<span class="sd">        &gt;&gt;&gt; with TestIO(), netcdf4.Dataset(filepath_obs, &quot;r&quot;) as ncfile:</span>
<span class="sd">        ...     tg = query_timegrid(ncfile, hp.nodes.dill_assl.sequences.obs)</span>
<span class="sd">        ...     i0 = tg[pub.timegrids.sim.firstdate]</span>
<span class="sd">        ...     i1 = tg[pub.timegrids.sim.lastdate]</span>
<span class="sd">        ...     for jdx in range(4):</span>
<span class="sd">        ...         print_vector(ncfile[&quot;obs_q&quot;][i0:i1, jdx])</span>
<span class="sd">        9.64767, 8.513649, 7.777628, 7.343314</span>
<span class="sd">        11.757526, 8.865079, 7.101815, 5.994195</span>
<span class="sd">        42.346475, 27.157472, 22.88099, 20.156836</span>
<span class="sd">        54.019337, 37.257561, 31.865308, 28.359542</span>

<span class="sd">        Now we stop all sequences from writing to NetCDF files, remove the two</span>
<span class="sd">        headwater elements from the currently active selection, and start another</span>
<span class="sd">        simulation run.  The time series of both headwater nodes are zero due to the</span>
<span class="sd">        missing inflow from their inlet headwater sub-catchments.  The non-headwater</span>
<span class="sd">        nodes only receive inflow from the two non-headwater sub-catchments:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     hp.prepare_simseries(allocate_ram=True, write_jit=False)</span>
<span class="sd">        ...     hp.prepare_obsseries(allocate_ram=True, write_jit=False)</span>
<span class="sd">        ...     hp.update_devices(nodes=hp.nodes, elements=hp.elements - headwaters)</span>
<span class="sd">        ...     hp.load_conditions()</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        &gt;&gt;&gt; for node in hp.nodes:</span>
<span class="sd">        ...     print_vector(node.sequences.sim.series)</span>
<span class="sd">        0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        42.261811, 18.744811, 16.249844, 14.587718</span>
<span class="sd">        30.588949, 8.644722, 7.265526, 6.385012</span>
<span class="sd">        0.0, 0.0, 0.0, 0.0</span>

<span class="sd">        Finally, we set the |Node.deploymode| of the headwater nodes `dill_assl` and</span>
<span class="sd">        `lahn_marb` to `oldsim` and `obs`, respectively, and read their previously</span>
<span class="sd">        written time series &quot;just in time&quot;.  As expected, the values of the two</span>
<span class="sd">        non-headwater nodes are identical to those of our initial example:</span>

<span class="sd">        &gt;&gt;&gt; with TestIO(), pub.options.threads(0):</span>
<span class="sd">        ...     hp.nodes[&quot;dill_assl&quot;].prepare_simseries(allocate_ram=True,</span>
<span class="sd">        ...                                             read_jit=True)</span>
<span class="sd">        ...     hp.nodes[&quot;dill_assl&quot;].deploymode = &quot;oldsim&quot;</span>
<span class="sd">        ...     hp.nodes[&quot;lahn_marb&quot;].prepare_obsseries(allocate_ram=True,</span>
<span class="sd">        ...                                             read_jit=True)</span>
<span class="sd">        ...     hp.nodes[&quot;lahn_marb&quot;].deploymode = &quot;obs&quot;</span>
<span class="sd">        ...     hp.load_conditions()</span>
<span class="sd">        ...     hp.simulate()</span>
<span class="sd">        &gt;&gt;&gt; for node in hp.nodes:</span>
<span class="sd">        ...     print_vector(node.sequences.sim.series)</span>
<span class="sd">        11.757526, 8.865079, 7.101815, 5.994195</span>
<span class="sd">        54.019337, 37.257561, 31.865308, 28.359542</span>
<span class="sd">        42.346475, 27.157472, 22.88099, 20.156836</span>
<span class="sd">        0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">readers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">JITAccessInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">writers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">JITAccessInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">variable2readmode</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">FlatUnion</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">variable2ncfile</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">FlatUnion</span><span class="p">,</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">variable2infos</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">FlatUnion</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">JITAccessInfo</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">variable2sequences</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">[</span>
            <span class="n">FlatUnion</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">disabled</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">SeriesMode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-many-nested-blocks</span>

            <span class="c1"># just-in-time calculations only work with NetCDF files</span>
            <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">sequencemanager</span><span class="o">.</span><span class="n">filetype</span><span class="p">(</span><span class="s2">&quot;nc&quot;</span><span class="p">):</span>

                <span class="c1"># collect the relevant sequences:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>
                <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">yield_disksequences</span><span class="p">(</span><span class="n">deviceorder</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sequence</span><span class="o">.</span><span class="n">diskflag</span><span class="p">:</span>
                        <span class="n">variable</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
                        <span class="n">readmode</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">diskflag_reading</span>
                        <span class="n">variable2readmode</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">readmode</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">variable2readmode</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">!=</span> <span class="n">readmode</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;For a specific NetCDF file, you can either read or &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;write data during a simulation run but for file &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">` both is requested.&quot;</span>
                            <span class="p">)</span>
                        <span class="n">variable2infos</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">readers</span> <span class="k">if</span> <span class="n">readmode</span> <span class="k">else</span> <span class="n">writers</span>
                        <span class="n">variable2sequences</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">variable2sequences</span><span class="p">:</span>
                    <span class="c1"># prepare NetCDF files:</span>
                    <span class="n">variable2timedelta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">FlatUnion</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">tg_init</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span>
                    <span class="n">tg_sim</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">sim</span>
                    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">variable2readmode</span><span class="p">):</span>
                        <span class="n">filepath</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">filepath</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">NetCDFVariableFlatReader</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">checkseries</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;No file `</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">` available for reading.&quot;</span>
                                    <span class="p">)</span>
                                <span class="k">del</span> <span class="n">variable2readmode</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
                                <span class="k">del</span> <span class="n">variable2infos</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">sequences</span> <span class="o">:=</span> <span class="n">variable2sequences</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
                                    <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                                        <span class="n">sequence</span><span class="o">.</span><span class="n">prepare_series</span><span class="p">(</span><span class="n">read_jit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                        <span class="n">disabled</span><span class="p">[</span><span class="n">sequence</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">seriesmode</span>
                                <span class="k">continue</span>
                            <span class="n">variable</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span>
                        <span class="n">variable2ncfile</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncfile</span>
                        <span class="n">sequence</span> <span class="o">=</span> <span class="n">variable2sequences</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">tg_variable</span> <span class="o">=</span> <span class="n">query_timegrid</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tg_sim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tg_variable</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The data of the NetCDF `</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">` (</span><span class="si">{</span><span class="n">tg_variable</span><span class="si">}</span><span class="s2">) &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;does not correctly cover the current simulation &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;period (</span><span class="si">{</span><span class="n">tg_sim</span><span class="si">}</span><span class="s2">).&quot;</span>
                            <span class="p">)</span>
                        <span class="n">variable2timedelta</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">tg_variable</span><span class="p">[</span><span class="n">tg_init</span><span class="o">.</span><span class="n">firstdate</span><span class="p">]</span>

                    <span class="c1"># make information for reading and writing temporarily available:</span>
                    <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">sequences</span> <span class="ow">in</span> <span class="n">variable2sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">variable2ncfile</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
                        <span class="k">assert</span> <span class="n">ncfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="n">get</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">query_subdevice2index</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span><span class="o">.</span><span class="n">get_index</span>
                        <span class="n">data</span><span class="p">:</span> <span class="n">NDArrayFloat</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                            <span class="n">variable</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">NP_FLOAT</span>
                        <span class="p">)</span>
                        <span class="n">variable2infos</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">JITAccessInfo</span><span class="p">(</span>
                                <span class="n">ncvariable</span><span class="o">=</span><span class="p">(</span><span class="n">ncvariable</span> <span class="o">:=</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">]),</span>
                                <span class="n">realisation</span><span class="o">=</span><span class="n">_is_realisation</span><span class="p">(</span><span class="n">ncvariable</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">),</span>
                                <span class="n">timedelta</span><span class="o">=</span><span class="n">variable2timedelta</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span>
                                <span class="n">columns</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">subdevicenames</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="c1"># the following algorithm relies on the iteration order defined</span>
                        <span class="c1"># by method _yield_disksequences:</span>
                        <span class="n">i0</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">descr_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">descr_new</span> <span class="o">:=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">descr_device</span><span class="p">)</span> <span class="o">!=</span> <span class="n">descr_old</span><span class="p">:</span>
                                <span class="n">descr_old</span> <span class="o">=</span> <span class="n">descr_new</span>
                                <span class="n">i0</span> <span class="o">+=</span> <span class="n">delta</span>
                                <span class="n">delta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                            <span class="n">sequence</span><span class="o">.</span><span class="n">connect_netcdf</span><span class="p">(</span><span class="n">ncarray</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">i0</span> <span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">delta</span><span class="p">])</span>

                    <span class="k">yield</span> <span class="n">JITAccessHandler</span><span class="p">(</span>
                        <span class="n">readers</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">readers</span><span class="p">),</span> <span class="n">writers</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">writers</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># return without useless efforts:</span>
                    <span class="k">yield</span> <span class="n">JITAccessHandler</span><span class="p">(</span><span class="n">readers</span><span class="o">=</span><span class="p">(),</span> <span class="n">writers</span><span class="o">=</span><span class="p">())</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="s2">&quot;While trying to prepare NetCDF files for reading or writing data &quot;</span>
                <span class="s1">&#39;&quot;just in time&quot; during the current simulation run&#39;</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">seriesmode</span> <span class="ow">in</span> <span class="n">disabled</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sequence</span><span class="o">.</span><span class="n">seriesmode</span> <span class="o">=</span> <span class="n">seriesmode</span>
            <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">variable2ncfile</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="add_netcdfreading">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.add_netcdfreading">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_netcdfreading</span><span class="p">(</span><span class="n">wrapped</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable a function or method that can read time series from NetCDF files to</span>
<span class="sd">    automatically activate the |SequenceManager.netcdfreading| mode if not already</span>
<span class="sd">    done.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">sequencemanager</span>
        <span class="k">if</span> <span class="n">sm</span><span class="o">.</span><span class="n">_netcdfreader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="k">with</span> <span class="n">sm</span><span class="o">.</span><span class="n">netcdfreading</span><span class="p">():</span>
                <span class="n">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="o">=</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">=</span><span class="n">wrapped</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>



<div class="viewcode-block" id="add_netcdfwriting">
<a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.add_netcdfwriting">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_netcdfwriting</span><span class="p">(</span><span class="n">wrapped</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable a function or method that can write time series to NetCDF files to</span>
<span class="sd">    automatically activate the |SequenceManager.netcdfwriting| mode if not already</span>
<span class="sd">    done.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">sequencemanager</span>
        <span class="k">if</span> <span class="n">sm</span><span class="o">.</span><span class="n">_netcdfwriter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="k">with</span> <span class="n">sm</span><span class="o">.</span><span class="n">netcdfwriting</span><span class="p">():</span>
                <span class="n">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="o">=</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">=</span><span class="n">wrapped</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 6.3dev0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.core.netcdftools</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2013-2026, HydPy Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.1.0.
    </div>
  </body>
</html>