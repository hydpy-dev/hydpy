<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydpy.auxs.calibtools &#8212; HydPy 5.0.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=127cebf3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    
    <script src="../../../_static/documentation_options.js?v=f98c4cc8"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 5.0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.auxs.calibtools</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/HydPy_Logo.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="../../../index.html">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to.html">How toâ€¦</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework.html">Framework Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modelcollection.html">Model Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zbibliography.html">Bibliography</a></li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hydpy.auxs.calibtools</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;This module implements features for calibrating model parameters.</span>

<span class="sd">.. _`NLopt`: https://nlopt.readthedocs.io/en/latest/</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># import...</span>
<span class="c1"># ...from standard library</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TextIO</span>

<span class="c1"># ...from site-packages</span>
<span class="kn">import</span> <span class="nn">black</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># ...from hydpy</span>
<span class="kn">import</span> <span class="nn">hydpy</span>
<span class="kn">from</span> <span class="nn">hydpy</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">devicetools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">hydpytools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">masktools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">objecttools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">parametertools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">selectiontools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">timetools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">variabletools</span>
<span class="kn">from</span> <span class="nn">hydpy.auxs</span> <span class="kn">import</span> <span class="n">iuhtools</span>
<span class="kn">from</span> <span class="nn">hydpy.core.typingtools</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">hydpy.models.arma</span> <span class="kn">import</span> <span class="n">arma_control</span>

<span class="n">TypeParameter</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;TypeParameter&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">)</span>
<span class="n">TypeRule1</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span>
    <span class="s2">&quot;TypeRule1&quot;</span><span class="p">,</span>
    <span class="n">bound</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Replace&quot;</span><span class="p">,</span> <span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiply&quot;</span><span class="p">,</span> <span class="s2">&quot;ReplaceIUH&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiplyIUH&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">TypeRule2</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span>
    <span class="s2">&quot;TypeRule2&quot;</span><span class="p">,</span>
    <span class="n">bound</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Replace&quot;</span><span class="p">,</span> <span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiply&quot;</span><span class="p">,</span> <span class="s2">&quot;ReplaceIUH&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiplyIUH&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">TypeRule</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;TypeRule&quot;</span><span class="p">,</span> <span class="s2">&quot;Replace&quot;</span><span class="p">,</span> <span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiply&quot;</span><span class="p">)</span>
<span class="n">Target</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>


<div class="viewcode-block" id="TargetFunction">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.TargetFunction">[docs]</a>
<span class="k">class</span> <span class="nc">TargetFunction</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol class for the target function required by class |CalibrationInterface|.</span>

<span class="sd">    The target functions must calculate and return a floating-point number reflecting</span>
<span class="sd">    the quality of the current parameterisation of the models of the current project.</span>
<span class="sd">    Often, as in the following example, the target function relies on objective</span>
<span class="sd">    functions as |nse|, applied on the time series of the |Sim| and |Obs| sequences</span>
<span class="sd">    handled by the |HydPy| object:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import HydPy, nse, TargetFunction</span>
<span class="sd">    &gt;&gt;&gt; class Target(TargetFunction):</span>
<span class="sd">    ...     def __init__(self, hp):</span>
<span class="sd">    ...         self.hp = hp</span>
<span class="sd">    ...     def __call__(self):</span>
<span class="sd">    ...         return sum(nse(node=node) for node in self.hp.nodes)</span>
<span class="sd">    &gt;&gt;&gt; target = Target(HydPy())</span>

<span class="sd">    See the documentation on class |CalibrationInterface| for more information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return some kind of efficience criterion.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="Adaptor">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Adaptor">[docs]</a>
<span class="k">class</span> <span class="nc">Adaptor</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol class for defining adoptors required by |Replace| objects.</span>

<span class="sd">    Often, one calibration parameter (represented by one |Replace| object) depends on</span>
<span class="sd">    other calibration parameters (represented by other |Replace| objects) or other</span>
<span class="sd">    &quot;real&quot; parameter values.  Please select an existing or define a new adaptor and</span>
<span class="sd">    assign it to a |Replace| object to introduce such dependencies.</span>

<span class="sd">    See class |SumAdaptor| or class |FactorAdaptor| for concrete examples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify the value(s) of the given target |Parameter| object.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="SumAdaptor">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.SumAdaptor">[docs]</a>
<span class="k">class</span> <span class="nc">SumAdaptor</span><span class="p">(</span><span class="n">Adaptor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adaptor, which calculates the sum of the values of multiple |Rule| objects and</span>
<span class="sd">    assigns it to the value(s) of the target |Parameter| object.</span>

<span class="sd">    Class |SumAdaptor| helps to introduce &quot;larger than&quot; relationships between</span>
<span class="sd">    calibration parameters.  A common use case is the time of concentration of</span>
<span class="sd">    different runoff components.  For example, the time of concentration of base flow</span>
<span class="sd">    should be larger than the one of direct runoff.  Accordingly, when modelling runoff</span>
<span class="sd">    concentration with linear storages, the recession coefficient of direct runoff</span>
<span class="sd">    should be larger. Principally, we could ensure this during a calibration process by</span>
<span class="sd">    defining two |Rule| objects with fixed non-overlapping parameter ranges.  For</span>
<span class="sd">    example, we could search for the best direct runoff delay between 1 and 5 days and</span>
<span class="sd">    the base flow delay between 5 and 100 days.  We demonstrate this for the recession</span>
<span class="sd">    coefficient parameters |hland_control.K| and |hland_control.K4| of application</span>
<span class="sd">    model |hland_v1| (assuming the nonlinearity parameter |hland_control.Alpha| to be</span>
<span class="sd">    zero):</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import Replace, SumAdaptor</span>
<span class="sd">    &gt;&gt;&gt; k = Replace(name=&quot;k&quot;,</span>
<span class="sd">    ...             parameter=&quot;k&quot;,</span>
<span class="sd">    ...             value=2.0**-1,</span>
<span class="sd">    ...             lower=5.0**-1,</span>
<span class="sd">    ...             upper=1.0**-1,</span>
<span class="sd">    ...             parameterstep=&quot;1d&quot;,</span>
<span class="sd">    ...             model=&quot;hland_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; k4 = Replace(name=&quot;k4&quot;,</span>
<span class="sd">    ...             parameter=&quot;k4&quot;,</span>
<span class="sd">    ...             value=10.0**-1,</span>
<span class="sd">    ...             lower=100.0**-1,</span>
<span class="sd">    ...             upper=5.0**-1,</span>
<span class="sd">    ...             parameterstep=&quot;1d&quot;,</span>
<span class="sd">    ...             model=&quot;hland_v1&quot;)</span>

<span class="sd">    To allow for non-fixed non-overlapping ranges, we can prepare a |SumAdaptor| object,</span>
<span class="sd">    knowing both our |Rule| objects, assign it the direct runoff-related |Rule| object,</span>
<span class="sd">    and, for example, set its lower boundary to zero:</span>

<span class="sd">    &gt;&gt;&gt; k.adaptor = SumAdaptor(k, k4)</span>
<span class="sd">    &gt;&gt;&gt; k.lower = 0.0</span>

<span class="sd">    Calling method |Replace.apply_value| of the |Replace| objects makes our</span>
<span class="sd">    |SumAdaptor| object apply the sum of the values of all of its |Rule| objects:</span>

<span class="sd">    &gt;&gt;&gt; control = hp.elements.land_dill.model.parameters.control</span>
<span class="sd">    &gt;&gt;&gt; k.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; with pub.options.parameterstep(&quot;1d&quot;):</span>
<span class="sd">    ...     control.k</span>
<span class="sd">    k(0.6)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_rules</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Rule</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">rules</span><span class="p">:</span> <span class="n">Rule</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">))</span></div>



<div class="viewcode-block" id="FactorAdaptor">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.FactorAdaptor">[docs]</a>
<span class="k">class</span> <span class="nc">FactorAdaptor</span><span class="p">(</span><span class="n">Adaptor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adaptor, which calculates the product of the value of the parent |Replace|</span>
<span class="sd">    object and the value(s) of a given reference |Parameter| object and assigns it to</span>
<span class="sd">    the value(s) of the target |Parameter| object.</span>

<span class="sd">    Class |FactorAdaptor| helps to respect dependencies between model parameters.  If</span>
<span class="sd">    you, for example, aim at calibrating the permanent wilting point</span>
<span class="sd">    (|lland_control.PWP|) of model |lland_v1|, you need to make sure it always agrees</span>
<span class="sd">    with the maximum soil water storage (|lland_control.WMax|).  Especially, one should</span>
<span class="sd">    avoid permanent wilting points larger than total porosity.  Due to the high</span>
<span class="sd">    variability of soil properties within most catchments, it is no real option to</span>
<span class="sd">    define a fixed upper threshold for |lland_control.PWP|.  By using class</span>
<span class="sd">    |FactorAdaptor|, you can instead calibrate a multiplication factor.  Setting the</span>
<span class="sd">    bounds of such a factor to 0.0 and 0.5, for example, would result in</span>
<span class="sd">    |lland_control.PWP| values ranging from zero up to half of |lland_control.WMax| for</span>
<span class="sd">    each respective response unit.</span>

<span class="sd">    To show how class |FactorAdaptor| works, we select another use-case based on the</span>
<span class="sd">    `Lahn` example project prepared by function |prepare_full_example_2|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>

<span class="sd">    |hland_v1| calculates the &quot;normal&quot; potential snow-melt with the degree-day factor</span>
<span class="sd">    |hland_control.CFMax|.  For glacial zones, it also calculates a separate potential</span>
<span class="sd">    glacier-melt with the additional degree-day factor |hland_control.GMelt|.  Suppose</span>
<span class="sd">    we have |hland_control.CFMax| readily available for the different hydrological</span>
<span class="sd">    response units of the Lahn catchment.  We might find it useful to calibrate</span>
<span class="sd">    |hland_control.GMelt| based on the spatial pattern of |hland_control.CFMax|.</span>
<span class="sd">    Therefore, we first define an |Replace| rule for parameter |hland_control.GMelt|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import Replace, FactorAdaptor</span>
<span class="sd">    &gt;&gt;&gt; gmelt = Replace(name=&quot;gmelt&quot;,</span>
<span class="sd">    ...                 parameter=&quot;gmelt&quot;,</span>
<span class="sd">    ...                 value=2.0,</span>
<span class="sd">    ...                 lower=0.5,</span>
<span class="sd">    ...                 upper=2.0,</span>
<span class="sd">    ...                 parameterstep=&quot;1d&quot;,</span>
<span class="sd">    ...                 model=&quot;hland_v1&quot;)</span>

<span class="sd">    Second, we initialise a |FactorAdaptor| object based on target rule `gmelt` and our</span>
<span class="sd">    reference parameter |hland_control.CFMax| and assign it our rule object:</span>

<span class="sd">    &gt;&gt;&gt; gmelt.adaptor = FactorAdaptor(gmelt, &quot;cfmax&quot;)</span>

<span class="sd">    The `Dill` subcatchment, like the whole `Lahn` basin, does not contain any</span>
<span class="sd">    glaciers.  Hence it defines (identical) |hland_control.CFMax| values for the zones</span>
<span class="sd">    of type |hland_constants.FIELD| and |hland_constants.FOREST| but must not specify</span>
<span class="sd">    any value for |hland_control.GMelt|:</span>

<span class="sd">    &gt;&gt;&gt; control = hp.elements.land_dill.model.parameters.control</span>
<span class="sd">    &gt;&gt;&gt; control.cfmax</span>
<span class="sd">    cfmax(field=4.55853, forest=2.735118)</span>
<span class="sd">    &gt;&gt;&gt; control.gmelt</span>
<span class="sd">    gmelt(nan)</span>

<span class="sd">    Next, we call method |Replace.apply_value| of the |Replace| object to apply the</span>
<span class="sd">    |FactorAdaptor| object on all relevant |hland_control.GMelt| instances of the `Lahn`</span>
<span class="sd">    catchment:</span>

<span class="sd">    &gt;&gt;&gt; gmelt.adaptor(control.gmelt)</span>

<span class="sd">    The string representation of the |hland_control.GMelt| instance of the Dill</span>
<span class="sd">    catchment indicates nothing happened:</span>

<span class="sd">    &gt;&gt;&gt; control.gmelt</span>
<span class="sd">    gmelt(nan)</span>

<span class="sd">    However, inspecting the individual values of the respective response units reveals</span>
<span class="sd">    the multiplication was successful:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import print_values</span>
<span class="sd">    &gt;&gt;&gt; print_values(control.gmelt.values)</span>
<span class="sd">    9.11706, 5.470236, 9.11706, 5.470236, 9.11706, 5.470236, 9.11706,</span>
<span class="sd">    5.470236, 9.11706, 5.470236, 9.11706, 5.470236</span>

<span class="sd">    Calculating values for response units that do not require these values can be</span>
<span class="sd">    misleading.  We can improve the situation by using the masks provided by the</span>
<span class="sd">    respective model; in our example, mask |hland_masks.Glacier|.  To make this</span>
<span class="sd">    clearer, we set the  first six response units to |hland_control.ZoneType|</span>
<span class="sd">    |hland_constants.GLACIER|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.hland_v1 import *</span>
<span class="sd">    &gt;&gt;&gt; control.zonetype(GLACIER, GLACIER, GLACIER, GLACIER, GLACIER, GLACIER,</span>
<span class="sd">    ...                  FIELD, FOREST, ILAKE, FIELD, FOREST, ILAKE)</span>

<span class="sd">    We now can assign the |SumAdaptor| object to the direct runoff-related |Replace|</span>
<span class="sd">    object and, for example, set its lower boundary to zero:</span>

<span class="sd">    Now we create a new |FactorAdaptor| object, handling the same parameters but also</span>
<span class="sd">    the |hland_masks.Glacier| mask:</span>

<span class="sd">    &gt;&gt;&gt; gmelt.adaptor = FactorAdaptor(gmelt, &quot;cfmax&quot;, &quot;glacier&quot;)</span>

<span class="sd">    To see the results of our new adaptor object, we change the values both of our</span>
<span class="sd">    reference parameter and our rule object:</span>

<span class="sd">    &gt;&gt;&gt; control.cfmax(field=5.0, forest=3.0, glacier=6.0)</span>
<span class="sd">    &gt;&gt;&gt; gmelt.value = 0.5</span>

<span class="sd">    The string representation of our target parameter shows that the glacier-related</span>
<span class="sd">    day degree factor of all glacier zones is now half as large as the snow-related one:</span>

<span class="sd">    &gt;&gt;&gt; gmelt.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; control.gmelt</span>
<span class="sd">    gmelt(3.0)</span>

<span class="sd">    Note that all remaining values (for zone types |hland_constants.FIELD|,</span>
<span class="sd">    |hland_constants.FOREST|, and |hland_constants.ILAKE| are still the same.  This</span>
<span class="sd">    intended behaviour allows calibrating, for example, hydrological response units of</span>
<span class="sd">    different types with different rule objects:</span>

<span class="sd">    &gt;&gt;&gt; print_values(control.gmelt.values)</span>
<span class="sd">    3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 9.11706, 5.470236, 9.11706, 5.470236,</span>
<span class="sd">    9.11706, 5.470236</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_rule</span><span class="p">:</span> <span class="n">Rule</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]</span>
    <span class="n">_reference</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rule</span><span class="p">:</span> <span class="n">Rule</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">],</span>
        <span class="n">reference</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">],</span> <span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">masktools</span><span class="o">.</span><span class="n">BaseMask</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span> <span class="o">=</span> <span class="n">rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">reference</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="k">else</span> <span class="n">mask</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">subpars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_reference</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">get_submask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">NDIM</span> <span class="k">else</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span>
            <span class="n">target</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span></div>



<div class="viewcode-block" id="Rule">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Rule">[docs]</a>
<span class="k">class</span> <span class="nc">Rule</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">TypeParameter</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for defining calibration rules.</span>

<span class="sd">    Each |Rule| object relates one calibration parameter with some model parameters.</span>
<span class="sd">    We select the class |Replace| as a concrete example for the following explanations</span>
<span class="sd">    and use the `Lahn` example project, which we prepare by calling function</span>
<span class="sd">    |prepare_full_example_2|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>

<span class="sd">    We define a |Rule| object supposed to replace the values of parameter</span>
<span class="sd">    |hland_control.FC| of application model |lland_v1|.  Note that argument `name` is</span>
<span class="sd">    the rule&#39;s name, whereas the argument `parameter` is the parameter&#39;s name:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import Replace</span>
<span class="sd">    &gt;&gt;&gt; rule = Replace(name=&quot;fc&quot;,</span>
<span class="sd">    ...                parameter=&quot;fc&quot;,</span>
<span class="sd">    ...                value=100.0,</span>
<span class="sd">    ...                model=&quot;hland_v1&quot;)</span>

<span class="sd">    The following string representation shows us the complete list of available</span>
<span class="sd">    arguments:</span>

<span class="sd">    &gt;&gt;&gt; rule</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;fc&quot;,</span>
<span class="sd">        parameter=&quot;fc&quot;,</span>
<span class="sd">        value=100.0,</span>
<span class="sd">        lower=-inf,</span>
<span class="sd">        upper=inf,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=None,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>

<span class="sd">    The initial value of parameter |hland_control.FC| is 206 mm:</span>

<span class="sd">    &gt;&gt;&gt; fc = hp.elements.land_lahn_1.model.parameters.control.fc</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(206.0)</span>

<span class="sd">    We can modify it by calling method |Rule.apply_value|:</span>

<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(100.0)</span>

<span class="sd">    You can change and apply the value at any time:</span>

<span class="sd">    &gt;&gt;&gt; rule.value = 200.0</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(200.0)</span>

<span class="sd">    Sometimes, one must differentiate between the original value to be calibrated and</span>
<span class="sd">    the actually applied value.  Therefore, (only) the |Replace| class allows for</span>
<span class="sd">    defining custom &quot;adaptors&quot;. Prepare an |Adaptor| function and assign it to the</span>
<span class="sd">    relevant |Replace| object (see the documentation on class |SumAdaptor| or</span>
<span class="sd">    |FactorAdaptor| for more realistic examples):</span>

<span class="sd">    &gt;&gt;&gt; rule.adaptor = lambda target: target(2.0 * rule.value)</span>

<span class="sd">    Now, our rule does not apply the original but the adapted calibration parameter</span>
<span class="sd">    value:</span>

<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(400.0)</span>

<span class="sd">    Use method |Rule.reset_parameters| to restore the original states of the affected</span>
<span class="sd">    parameters (&quot;original&quot; here means at the time of initialisation of the |Rule|</span>
<span class="sd">    object):</span>

<span class="sd">    &gt;&gt;&gt; rule.reset_parameters()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(206.0)</span>

<span class="sd">    Some parameter types support defining their values via custom keywords.</span>
<span class="sd">    |hland_control.FC|, for example, allows setting the values of multiple zones of</span>
<span class="sd">    the same land-use type via keyword arguments such as `forest`:</span>

<span class="sd">    &gt;&gt;&gt; rule = Replace(name=&quot;fc&quot;,</span>
<span class="sd">    ...                parameter=&quot;fc&quot;,</span>
<span class="sd">    ...                value=100.0,</span>
<span class="sd">    ...                keyword=&quot;forest&quot;,</span>
<span class="sd">    ...                model=&quot;hland_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(field=206.0, forest=100.0)</span>

<span class="sd">    The value of parameter |hland_control.FC| is not time-dependent.  Therefore, any</span>
<span class="sd">    |Options.parameterstep| information given to its |Rule| object is ignored (note</span>
<span class="sd">    that we pass an example parameter object of type |hland_control.FC| instead of the</span>
<span class="sd">    string `fc` this time):</span>

<span class="sd">    &gt;&gt;&gt; Replace(name=&quot;fc&quot;,</span>
<span class="sd">    ...         parameter=fc,</span>
<span class="sd">    ...         value=100.0,</span>
<span class="sd">    ...         model=&quot;hland_v1&quot;,</span>
<span class="sd">    ...         parameterstep=&quot;1d&quot;)</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;fc&quot;,</span>
<span class="sd">        parameter=&quot;fc&quot;,</span>
<span class="sd">        value=100.0,</span>
<span class="sd">        lower=-inf,</span>
<span class="sd">        upper=inf,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=None,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>

<span class="sd">    For time-dependent parameters, the rule queries the current global</span>
<span class="sd">    |Options.parameterstep| value if you do not specify one explicitly (note that we</span>
<span class="sd">    pass the parameter type |hland_control.PercMax| and the module |hland_v1| this</span>
<span class="sd">    time):</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models import hland_v1</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.models.hland.hland_control import PercMax</span>
<span class="sd">    &gt;&gt;&gt; rule = Replace(name=&quot;percmax&quot;,</span>
<span class="sd">    ...                parameter=PercMax,</span>
<span class="sd">    ...                value=5.0,</span>
<span class="sd">    ...                model=hland_v1)</span>

<span class="sd">    The |Rule| object internally handles, to avoid confusion, a copy of</span>
<span class="sd">    |Options.parameterstep|.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">    &gt;&gt;&gt; pub.options.parameterstep = None</span>
<span class="sd">    &gt;&gt;&gt; rule</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;percmax&quot;,</span>
<span class="sd">        parameter=&quot;percmax&quot;,</span>
<span class="sd">        value=5.0,</span>
<span class="sd">        lower=-inf,</span>
<span class="sd">        upper=inf,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=&quot;1d&quot;,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; percmax = hp.elements.land_lahn_1.model.parameters.control.percmax</span>
<span class="sd">    &gt;&gt;&gt; with pub.options.parameterstep(&quot;1d&quot;):</span>
<span class="sd">    ...     percmax</span>
<span class="sd">    percmax(5.0)</span>

<span class="sd">    Alternatively, you can pass a parameter step size yourself:</span>

<span class="sd">    &gt;&gt;&gt; rule = Replace(name=&quot;percmax&quot;,</span>
<span class="sd">    ...                parameter=&quot;percmax&quot;,</span>
<span class="sd">    ...                value=5.0,</span>
<span class="sd">    ...                model=&quot;hland_v1&quot;,</span>
<span class="sd">    ...                parameterstep=&quot;2d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; with pub.options.parameterstep(&quot;1d&quot;):</span>
<span class="sd">    ...     percmax</span>
<span class="sd">    percmax(2.5)</span>

<span class="sd">    Missing parameter step-size information results in the following error:</span>

<span class="sd">    &gt;&gt;&gt; Replace(name=&quot;percmax&quot;,</span>
<span class="sd">    ...         parameter=&quot;percmax&quot;,</span>
<span class="sd">    ...         value=5.0,</span>
<span class="sd">    ...         model=&quot;hland_v1&quot;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: While trying to initialise the `Replace` rule object `percmax`, the \</span>
<span class="sd">following error occurred: Rules which handle time-dependent parameters require \</span>
<span class="sd">information on the parameter timestep size.  Either assign it directly or define it \</span>
<span class="sd">via option `parameterstep`.</span>

<span class="sd">    With the following definition, the |Rule| object queries all |Element| objects</span>
<span class="sd">    handling |hland_v1| instances from the global |Selections| object `pub.selections`:</span>

<span class="sd">    &gt;&gt;&gt; rule = Replace(name=&quot;fc&quot;,</span>
<span class="sd">    ...                parameter=&quot;fc&quot;,</span>
<span class="sd">    ...                value=100.0,</span>
<span class="sd">    ...                model=&quot;hland_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; rule.elements</span>
<span class="sd">    Elements(&quot;land_dill&quot;, &quot;land_lahn_1&quot;, &quot;land_lahn_2&quot;, &quot;land_lahn_3&quot;)</span>

<span class="sd">    Alternatively, you can specify selections by passing themselves or their names (the</span>
<span class="sd">    latter requires them to be a member of `pub.selections`):</span>

<span class="sd">    &gt;&gt;&gt; rule = Replace(name=&quot;fc&quot;,</span>
<span class="sd">    ...                parameter=&quot;fc&quot;,</span>
<span class="sd">    ...                value=100.0,</span>
<span class="sd">    ...                selections=[pub.selections.headwaters, &quot;nonheadwaters&quot;])</span>
<span class="sd">    &gt;&gt;&gt; rule.elements</span>
<span class="sd">    Elements(&quot;land_dill&quot;, &quot;land_lahn_1&quot;, &quot;land_lahn_2&quot;, &quot;land_lahn_3&quot;)</span>

<span class="sd">    Without using the `model` argument, you must ensure the selected elements handle</span>
<span class="sd">    the correct model instance yourself:</span>

<span class="sd">    &gt;&gt;&gt; Replace(name=&quot;fc&quot;,</span>
<span class="sd">    ...         parameter=&quot;fc&quot;,</span>
<span class="sd">    ...         value=100.0)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: While trying to initialise the `Replace` rule object `fc`, the \</span>
<span class="sd">following error occurred: Model `musk_classic` of element `stream_dill_lahn_2` does \</span>
<span class="sd">not define a control parameter named `fc`.</span>

<span class="sd">    &gt;&gt;&gt; Replace(name=&quot;fc&quot;,</span>
<span class="sd">    ...         parameter=&quot;fc&quot;,</span>
<span class="sd">    ...         value=100.0,</span>
<span class="sd">    ...         model=&quot;musk_classic&quot;,</span>
<span class="sd">    ...         selections=[pub.selections.headwaters, &quot;nonheadwaters&quot;])</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: While trying to initialise the `Replace` rule object `fc`, the \</span>
<span class="sd">following error occurred: Object `Selections(&quot;headwaters&quot;, &quot;nonheadwaters&quot;)` does not \</span>
<span class="sd">handle any `musk_classic` model instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the |Rule| object.&quot;&quot;&quot;</span>

    <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lower boundary value.</span>

<span class="sd">    No lower boundary corresponds to minus |numpy.inf|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Upper boundary value.</span>

<span class="sd">    No upper boundary corresponds to plus |numpy.inf|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parametername</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the addressed |Parameter| objects.&quot;&quot;&quot;</span>

    <span class="n">parametertype</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TypeParameter</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The type of the addressed |Parameter| objects.&quot;&quot;&quot;</span>

    <span class="n">keyword</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the addressed keyword argument or, for a positional argument, </span>
<span class="sd">    |None|.&quot;&quot;&quot;</span>

    <span class="n">elements</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Elements</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The |Element| objects, which handle the relevant target |Parameter| instances.&quot;&quot;&quot;</span>

    <span class="n">selections</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The names of all relevant |Selection| objects.&quot;&quot;&quot;</span>

    <span class="n">_value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">_parameterstep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">]</span>
    <span class="n">_original_parameter_values</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Vector</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Matrix</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="o">...</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parameter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">TypeParameter</span><span class="p">],</span> <span class="n">TypeParameter</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">keyword</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parameterstep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">PeriodConstrArg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">selections</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">selectiontools</span><span class="o">.</span><span class="n">Selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parametername</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">parameter</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="o">=</span> <span class="n">keyword</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">selections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">selections</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">selections</span>
                <span class="k">if</span> <span class="s2">&quot;complete&quot;</span> <span class="ow">in</span> <span class="n">selections</span><span class="p">:</span>
                    <span class="n">selections</span> <span class="o">=</span> <span class="n">selectiontools</span><span class="o">.</span><span class="n">Selections</span><span class="p">(</span><span class="n">selections</span><span class="o">.</span><span class="n">complete</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selections</span> <span class="o">=</span> <span class="n">selectiontools</span><span class="o">.</span><span class="n">Selections</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">(</span>
                        <span class="n">sel</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">selectiontools</span><span class="o">.</span><span class="n">Selection</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">selections</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selections</span> <span class="o">=</span> <span class="n">selections</span><span class="o">.</span><span class="n">names</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">selections</span><span class="o">.</span><span class="n">elements</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Elements</span><span class="p">(</span>
                    <span class="n">element</span>
                    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">selections</span><span class="o">.</span><span class="n">elements</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Object `</span><span class="si">{</span><span class="n">selections</span><span class="si">}</span><span class="s2">` does not handle any `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="si">}</span><span class="s2">` model &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;instances.&quot;</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                <span class="n">control</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametername</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">elementphrase</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;define a control parameter named `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parametername</span><span class="si">}</span><span class="s2">`.&quot;</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parametertype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>  <span class="c1"># type: ignore[assignment]</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parametername</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span> <span class="o">=</span> <span class="n">parameterstep</span>  <span class="c1"># type: ignore[assignment]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_parameter_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_parameter_values</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;While trying to initialise the `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` rule object &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_original_parameter_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Vector</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Matrix</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="o">...</span><span class="p">]:</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">revert_timefactor</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">keywordarguments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The calibration parameter value.</span>

<span class="sd">        Property |Rule.value| ensures that the given value adheres to the defined lower</span>
<span class="sd">        and upper boundaries:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import Replace</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; rule = Replace(name=&quot;fc&quot;,</span>
<span class="sd">        ...                parameter=&quot;fc&quot;,</span>
<span class="sd">        ...                value=100.0,</span>
<span class="sd">        ...                lower=50.0,</span>
<span class="sd">        ...                upper=200.0,</span>
<span class="sd">        ...                model=&quot;hland_v1&quot;)</span>

<span class="sd">        &gt;&gt;&gt; rule.value = 0.0</span>
<span class="sd">        &gt;&gt;&gt; rule.value</span>
<span class="sd">        50.0</span>

<span class="sd">        With option |Options.warntrim| enabled (the default), property |Rule.value|</span>
<span class="sd">        also emits a warning like the following:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import warn_later</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.warntrim(True), warn_later():</span>
<span class="sd">        ...     rule.value = 300.0</span>
<span class="sd">        UserWarning: The value of the `Replace` object `fc` must not be smaller than \</span>
<span class="sd">`50.0` or larger than `200.0`, but the given value is `300.0`.  Applying the trimmed \</span>
<span class="sd">value `200.0` instead.</span>
<span class="sd">        &gt;&gt;&gt; rule.value</span>
<span class="sd">        200.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">warntrim</span><span class="p">:</span>
                <span class="n">repr_</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The value of the `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` object `</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">` must &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;not be smaller than `</span><span class="si">{</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span><span class="si">}</span><span class="s2">` or larger than &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span><span class="si">}</span><span class="s2">`, but the given value is `</span><span class="si">{</span><span class="n">repr_</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">`.  &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Applying the trimmed value `</span><span class="si">{</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span><span class="si">}</span><span class="s2">` instead.&quot;</span>
                <span class="p">)</span>

<div class="viewcode-block" id="Rule.apply_value">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Rule.apply_value">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">apply_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the current value to the relevant |Parameter| objects.</span>

<span class="sd">        To be overridden by the concrete subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


    <span class="k">def</span> <span class="nf">_update_parameter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parameter</span><span class="p">:</span> <span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Vector</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Matrix</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keywordarguments</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">keywordarguments</span>
            <span class="n">keywordarguments</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">keywordarguments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">parameter</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">keywordarguments</span><span class="p">))</span>

<div class="viewcode-block" id="Rule.reset_parameters">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Rule.reset_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all relevant parameter objects to their original states.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import Replace</span>
<span class="sd">        &gt;&gt;&gt; rule = Replace(name=&quot;fc&quot;,</span>
<span class="sd">        ...                parameter=&quot;fc&quot;,</span>
<span class="sd">        ...                value=100.0,</span>
<span class="sd">        ...                model=&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; fc = hp.elements.land_lahn_1.model.parameters.control.fc</span>
<span class="sd">        &gt;&gt;&gt; fc</span>
<span class="sd">        fc(206.0)</span>
<span class="sd">        &gt;&gt;&gt; fc(100.0)</span>
<span class="sd">        &gt;&gt;&gt; fc</span>
<span class="sd">        fc(100.0)</span>
<span class="sd">        &gt;&gt;&gt; rule.reset_parameters()</span>
<span class="sd">        &gt;&gt;&gt; fc</span>
<span class="sd">        fc(206.0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">orig</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_parameter_values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_parameter</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameterstep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The parameter step size relevant to the related model parameter.</span>

<span class="sd">        For non-time-dependent parameters, property |Rule.parameterstep| is (usually)</span>
<span class="sd">        |None|.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameterstep</span>

    <span class="nd">@parameterstep</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">parameterstep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">PeriodConstrArg</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametertype</span><span class="o">.</span><span class="n">TIME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametertype</span><span class="o">.</span><span class="n">KEYWORDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">time_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametertype</span><span class="o">.</span><span class="n">TIME</span> <span class="k">if</span> <span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">keyword</span><span class="o">.</span><span class="n">time</span>
        <span class="k">if</span> <span class="n">time_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parameterstep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Rules which handle time-dependent parameters require &quot;</span>
                        <span class="s2">&quot;information on the parameter timestep size.  Either assign &quot;</span>
                        <span class="s2">&quot;it directly or define it via option `parameterstep`.&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parameterstep</span> <span class="o">=</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Rule.assignrepr">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Rule.assignrepr">[docs]</a>
    <span class="k">def</span> <span class="nf">assignrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the actual |Rule| object prefixed with the</span>
<span class="sd">        given string.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_none_or_string</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">if</span> <span class="n">obj</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">blanks</span> <span class="o">=</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
        <span class="n">selprefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">selections=&quot;</span>
        <span class="n">selline</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">assignrepr_tuple</span><span class="p">(</span>
            <span class="n">values</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">sel</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">),</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">selprefix</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1">name=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1">&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1">parameter=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parametername</span><span class="si">}</span><span class="s1">&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">value=</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">lower=</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">upper=</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">keyword=</span><span class="si">{</span><span class="n">_none_or_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">parameterstep=</span><span class="si">{</span><span class="n">_none_or_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">model=</span><span class="si">{</span><span class="n">_none_or_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">selline</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignrepr</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">TypeParameter</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parametername</span><span class="p">]</span></div>



<div class="viewcode-block" id="Replace">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Replace">[docs]</a>
<span class="k">class</span> <span class="nc">Replace</span><span class="p">(</span><span class="n">Rule</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;|Rule| class, which simply replaces the current model parameter value(s) with</span>
<span class="sd">    the current calibration parameter value.</span>

<span class="sd">    See the documentation on class |Rule| for further information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">adaptor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Adaptor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An optional function object for customising individual calibration strategies.</span>

<span class="sd">    See the documentation on the classes |Rule|, |SumAdaptor|, and |FactorAdaptor| for </span>
<span class="sd">    further information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Replace.apply_value">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Replace.apply_value">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the current value to the relevant |Parameter| objects.</span>

<span class="sd">        See the documentation on class |Rule| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span>
        <span class="k">with</span> <span class="n">opt</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptor</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adaptor</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_parameter</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Add">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Add">[docs]</a>
<span class="k">class</span> <span class="nc">Add</span><span class="p">(</span><span class="n">Rule</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;|Rule| class, which adds its calibration delta to the original model parameter</span>
<span class="sd">    value(s).</span>

<span class="sd">    Please read the examples of the documentation on class |Rule| first.  Here, we</span>
<span class="sd">    modify some of these examples to show the unique features of class |Add|.</span>

<span class="sd">    The first example deals with the non-time-dependent parameter |hland_control.FC|.</span>
<span class="sd">    The following |Add| object adds its current value to the parameter&#39;s original</span>
<span class="sd">    values:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import Add</span>
<span class="sd">    &gt;&gt;&gt; rule = Add(name=&quot;fc&quot;,</span>
<span class="sd">    ...            parameter=&quot;fc&quot;,</span>
<span class="sd">    ...            value=100.0,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; fc = hp.elements.land_lahn_1.model.parameters.control.fc</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(206.0)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(306.0)</span>

<span class="sd">    When specifying the keyword `field`, the |Add| rule modifies the field capacity of</span>
<span class="sd">    zones of type |hland_constants.FIELD| only:</span>

<span class="sd">    &gt;&gt;&gt; fc(206.0)</span>
<span class="sd">    &gt;&gt;&gt; rule = Add(name=&quot;fc&quot;,</span>
<span class="sd">    ...            parameter=&quot;fc&quot;,</span>
<span class="sd">    ...            value=100.0,</span>
<span class="sd">    ...            keyword=&quot;field&quot;,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(field=306.0, forest=206.0)</span>

<span class="sd">    The second example deals with the time-dependent parameter |hland_control.CFMax|</span>
<span class="sd">    and shows that everything works even when the actual |Options.parameterstep|</span>
<span class="sd">    (2 days) differs from the current |Options.simulationstep| (1 day):</span>

<span class="sd">    &gt;&gt;&gt; rule = Add(name=&quot;cfmax&quot;,</span>
<span class="sd">    ...            parameter=&quot;cfmax&quot;,</span>
<span class="sd">    ...            value=2.0,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;,</span>
<span class="sd">    ...            parameterstep=&quot;2d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; cfmax = hp.elements.land_lahn_1.model.parameters.control.cfmax</span>
<span class="sd">    &gt;&gt;&gt; cfmax</span>
<span class="sd">    cfmax(field=5.0, forest=3.0)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; cfmax</span>
<span class="sd">    cfmax(field=6.0, forest=4.0)</span>

<span class="sd">    This time, we modify the |hland_constants.FOREST| zones only:</span>

<span class="sd">    &gt;&gt;&gt; cfmax(field=5.0, forest=3.0)</span>
<span class="sd">    &gt;&gt;&gt; rule = Add(name=&quot;cfmax&quot;,</span>
<span class="sd">    ...            parameter=&quot;cfmax&quot;,</span>
<span class="sd">    ...            value=2.0,</span>
<span class="sd">    ...            keyword=&quot;forest&quot;,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;,</span>
<span class="sd">    ...            parameterstep=&quot;2d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; cfmax</span>
<span class="sd">    cfmax(field=5.0, forest=4.0)</span>

<span class="sd">    In the third example, we modify the scalar parameter |musk_control.NmbSegments| by</span>
<span class="sd">    its optional keyword argument `lag`:</span>

<span class="sd">    &gt;&gt;&gt; rule = Add(name=&quot;lag&quot;,</span>
<span class="sd">    ...            parameter=&quot;nmbsegments&quot;,</span>
<span class="sd">    ...            value=1.0,</span>
<span class="sd">    ...            keyword=&quot;lag&quot;,</span>
<span class="sd">    ...            model=&quot;musk_classic&quot;,</span>
<span class="sd">    ...            parameterstep=&quot;2d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; nmbsegments = \</span>
<span class="sd">hp.elements.stream_lahn_1_lahn_2.model.parameters.control.nmbsegments</span>
<span class="sd">    &gt;&gt;&gt; nmbsegments</span>
<span class="sd">    nmbsegments(lag=0.583)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; nmbsegments</span>
<span class="sd">    nmbsegments(lag=2.583)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Add.apply_value">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Add.apply_value">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the current (adapted) value to the relevant |Parameter| objects.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">orig</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_parameter_values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_parameter</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">orig</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Multiply">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Multiply">[docs]</a>
<span class="k">class</span> <span class="nc">Multiply</span><span class="p">(</span><span class="n">Rule</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;|Rule| class for multiplying the original model parameter value(s) by its</span>
<span class="sd">    calibration factor.</span>

<span class="sd">    Please read the examples of the documentation on class |Rule| first.  Here, we</span>
<span class="sd">    modify some of these examples to show the unique features of class |Multiply|.</span>

<span class="sd">    The first example deals with the non-time-dependent parameter |hland_control.FC|.</span>
<span class="sd">    The following |Multiply| object multiplies the parameter&#39;s original values by its</span>
<span class="sd">    current calibration factor:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import Add</span>
<span class="sd">    &gt;&gt;&gt; rule = Multiply(name=&quot;fc&quot;,</span>
<span class="sd">    ...                 parameter=&quot;fc&quot;,</span>
<span class="sd">    ...                 value=2.0,</span>
<span class="sd">    ...                 model=&quot;hland_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; fc = hp.elements.land_lahn_1.model.parameters.control.fc</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(206.0)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(412.0)</span>

<span class="sd">    When specifying the keyword `field`, the |Multiply| rule modifies the field</span>
<span class="sd">    capacity of zones of type |hland_constants.FIELD| only:</span>

<span class="sd">    &gt;&gt;&gt; fc(206.0)</span>
<span class="sd">    &gt;&gt;&gt; rule = Multiply(name=&quot;fc&quot;,</span>
<span class="sd">    ...            parameter=&quot;fc&quot;,</span>
<span class="sd">    ...            value=2.0,</span>
<span class="sd">    ...            keyword=&quot;field&quot;,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; fc</span>
<span class="sd">    fc(field=412.0, forest=206.0)</span>

<span class="sd">    The second example deals with the time-dependent parameter |hland_control.CFMax|</span>
<span class="sd">    and shows that everything works even when the actual |Options.parameterstep|</span>
<span class="sd">    (2 days) differs from the current |Options.simulationstep| (1 day):</span>

<span class="sd">    &gt;&gt;&gt; rule = Multiply(name=&quot;cfmax&quot;,</span>
<span class="sd">    ...                 parameter=&quot;cfmax&quot;,</span>
<span class="sd">    ...                 value=2.0,</span>
<span class="sd">    ...                 model=&quot;hland_v1&quot;,</span>
<span class="sd">    ...                 parameterstep=&quot;2d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; cfmax = hp.elements.land_lahn_1.model.parameters.control.cfmax</span>
<span class="sd">    &gt;&gt;&gt; cfmax</span>
<span class="sd">    cfmax(field=5.0, forest=3.0)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; cfmax</span>
<span class="sd">    cfmax(field=10.0, forest=6.0)</span>

<span class="sd">    This time, we modify the |hland_constants.FOREST| zones only:</span>

<span class="sd">    &gt;&gt;&gt; cfmax(field=5.0, forest=3.0)</span>
<span class="sd">    &gt;&gt;&gt; rule = Multiply(name=&quot;cfmax&quot;,</span>
<span class="sd">    ...                 parameter=&quot;cfmax&quot;,</span>
<span class="sd">    ...                 value=2.0,</span>
<span class="sd">    ...                 keyword=&quot;forest&quot;,</span>
<span class="sd">    ...                 model=&quot;hland_v1&quot;,</span>
<span class="sd">    ...                 parameterstep=&quot;2d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; cfmax</span>
<span class="sd">    cfmax(field=5.0, forest=3.0)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; cfmax</span>
<span class="sd">    cfmax(field=5.0, forest=6.0)</span>

<span class="sd">    In the third example, we modify the scalar parameter |musk_control.NmbSegments| by</span>
<span class="sd">    its optional keyword argument `lag`:</span>

<span class="sd">    &gt;&gt;&gt; rule = Multiply(name=&quot;lag&quot;,</span>
<span class="sd">    ...            parameter=&quot;nmbsegments&quot;,</span>
<span class="sd">    ...            value=2.0,</span>
<span class="sd">    ...            keyword=&quot;lag&quot;,</span>
<span class="sd">    ...            model=&quot;musk_classic&quot;,</span>
<span class="sd">    ...            parameterstep=&quot;2d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; nmbsegments = \</span>
<span class="sd">hp.elements.stream_lahn_1_lahn_2.model.parameters.control.nmbsegments</span>
<span class="sd">    &gt;&gt;&gt; nmbsegments</span>
<span class="sd">    nmbsegments(lag=0.583)</span>
<span class="sd">    &gt;&gt;&gt; rule.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; nmbsegments</span>
<span class="sd">    nmbsegments(lag=1.166)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Multiply.apply_value">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.Multiply.apply_value">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the current (adapted) value to the relevant |Parameter| objects.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">orig</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_parameter_values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_parameter</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">orig</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CalibrationInterface">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface">[docs]</a>
<span class="k">class</span> <span class="nc">CalibrationInterface</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">TypeRule1</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface for the coupling of *HydPy* to optimisation libraries like `NLopt`_.</span>

<span class="sd">    Essentially, class |CalibrationInterface| is supposed for the structured handling</span>
<span class="sd">    of multiple objects of the different |Rule| subclasses.  Hence, please read the</span>
<span class="sd">    documentation on class |Rule| before continuing, on which we base the following</span>
<span class="sd">    explanations.</span>

<span class="sd">    We work with the `Lahn` example project again:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>

<span class="sd">    First, we create a |CalibrationInterface| object.  Initially, it needs to know the</span>
<span class="sd">    relevant |HydPy| object and the target or objective function (here, we define the</span>
<span class="sd">    target function sloppily via the `lambda` statement; see the documentation on the</span>
<span class="sd">    protocol class |TargetFunction| for a more formal definition and further</span>
<span class="sd">    explanations):</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import CalibrationInterface, nse</span>
<span class="sd">    &gt;&gt;&gt; ci = CalibrationInterface(</span>
<span class="sd">    ...     hp=hp,</span>
<span class="sd">    ...     targetfunction=lambda: sum(nse(node=node) for node in hp.nodes))</span>

<span class="sd">    Next, we use function |make_rules|, which creates one |Replace| rule related to</span>
<span class="sd">    parameter |hland_control.FC| and another one related to parameter</span>
<span class="sd">    |hland_control.PercMax| in one step, and add them via method</span>
<span class="sd">    |CalibrationInterface.add_rules|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import Replace</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.auxs.calibtools import make_rules</span>
<span class="sd">    &gt;&gt;&gt; ci.add_rules(*make_rules(rule=Replace,</span>
<span class="sd">    ...                          names=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">    ...                          parameters=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">    ...                          values=[100.0, 5.0],</span>
<span class="sd">    ...                          keywords=[None, None],</span>
<span class="sd">    ...                          lowers=[50.0, 1.0],</span>
<span class="sd">    ...                          uppers=[200.0, 10.0],</span>
<span class="sd">    ...                          parametersteps=&quot;1d&quot;,</span>
<span class="sd">    ...                          model=&quot;hland_v1&quot;))</span>

<span class="sd">    &gt;&gt;&gt; print(ci)</span>
<span class="sd">    CalibrationInterface</span>
<span class="sd">    &gt;&gt;&gt; ci</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;fc&quot;,</span>
<span class="sd">        parameter=&quot;fc&quot;,</span>
<span class="sd">        value=100.0,</span>
<span class="sd">        lower=50.0,</span>
<span class="sd">        upper=200.0,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=None,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;percmax&quot;,</span>
<span class="sd">        parameter=&quot;percmax&quot;,</span>
<span class="sd">        value=5.0,</span>
<span class="sd">        lower=1.0,</span>
<span class="sd">        upper=10.0,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=&quot;1d&quot;,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>

<span class="sd">    Adding rules later does not remove already available ones.  For demonstration, we</span>
<span class="sd">    add one for calibrating parameter |musk_control.Coefficients| of application model</span>
<span class="sd">    |musk_classic| via its keyword `damp`:</span>

<span class="sd">    &gt;&gt;&gt; len(ci)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; ci.add_rules(Replace(name=&quot;damp&quot;,</span>
<span class="sd">    ...                      parameter=&quot;coefficients&quot;,</span>
<span class="sd">    ...                      value=0.2,</span>
<span class="sd">    ...                      lower=0.0,</span>
<span class="sd">    ...                      upper=0.5,</span>
<span class="sd">    ...                      keyword=&quot;damp&quot;,</span>
<span class="sd">    ...                      selections=[&quot;complete&quot;],</span>
<span class="sd">    ...                      model=&quot;musk_classic&quot;))</span>
<span class="sd">    &gt;&gt;&gt; len(ci)</span>
<span class="sd">    3</span>

<span class="sd">    All rules are available via attribute and keyword access:</span>

<span class="sd">    &gt;&gt;&gt; ci.fc</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;fc&quot;,</span>
<span class="sd">        parameter=&quot;fc&quot;,</span>
<span class="sd">        value=100.0,</span>
<span class="sd">        lower=50.0,</span>
<span class="sd">        upper=200.0,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=None,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>

<span class="sd">    &gt;&gt;&gt; ci.FC</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    AttributeError: The actual calibration interface does neither handle a normal \</span>
<span class="sd">attribute nor a rule object named `FC`.</span>

<span class="sd">    &gt;&gt;&gt; ci[&quot;damp&quot;]</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;damp&quot;,</span>
<span class="sd">        parameter=&quot;coefficients&quot;,</span>
<span class="sd">        value=0.2,</span>
<span class="sd">        lower=0.0,</span>
<span class="sd">        upper=0.5,</span>
<span class="sd">        keyword=&quot;damp&quot;,</span>
<span class="sd">        parameterstep=None,</span>
<span class="sd">        model=&quot;musk_classic&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>

<span class="sd">    &gt;&gt;&gt; ci[&quot;Damp&quot;]</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    KeyError: &#39;The actual calibration interface does not handle a rule object named \</span>
<span class="sd">`Damp`.&#39;</span>

<span class="sd">    The following properties return consistently sorted information on the handles</span>
<span class="sd">    |Rule| objects:</span>

<span class="sd">    &gt;&gt;&gt; ci.names</span>
<span class="sd">    (&#39;fc&#39;, &#39;percmax&#39;, &#39;damp&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ci.keywords</span>
<span class="sd">    (None, None, &#39;damp&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ci.values</span>
<span class="sd">    (100.0, 5.0, 0.2)</span>
<span class="sd">    &gt;&gt;&gt; ci.lowers</span>
<span class="sd">    (50.0, 1.0, 0.0)</span>
<span class="sd">    &gt;&gt;&gt; ci.uppers</span>
<span class="sd">    (200.0, 10.0, 0.5)</span>

<span class="sd">    All tuples reflect the current state of all rules:</span>

<span class="sd">    &gt;&gt;&gt; ci.damp.value = 0.3</span>
<span class="sd">    &gt;&gt;&gt; ci.values</span>
<span class="sd">    (100.0, 5.0, 0.3)</span>

<span class="sd">    For the following examples, we perform a simulation run and assign the values of</span>
<span class="sd">    the simulated time series to the observed series:</span>

<span class="sd">    &gt;&gt;&gt; conditions = hp.conditions</span>
<span class="sd">    &gt;&gt;&gt; hp.simulate()</span>
<span class="sd">    &gt;&gt;&gt; for node in hp.nodes:</span>
<span class="sd">    ...     node.sequences.obs.series = node.sequences.sim.series</span>
<span class="sd">    &gt;&gt;&gt; hp.conditions = conditions</span>

<span class="sd">    As the agreement between the simulated and the &quot;observed&quot; time series is perfect</span>
<span class="sd">    for all four gauges, method |CalibrationInterface.calculate_likelihood| returns the</span>
<span class="sd">    highest possible sum of four |nse| values and also stores it under the attribute</span>
<span class="sd">    `result`:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">    &gt;&gt;&gt; round_(ci.calculate_likelihood())</span>
<span class="sd">    4.0</span>
<span class="sd">    &gt;&gt;&gt; round_(ci.result)</span>
<span class="sd">    4.0</span>

<span class="sd">    When performing a manual calibration, it might be convenient to use method</span>
<span class="sd">    |CalibrationInterface.apply_values|.  To explain how it works, we first show the</span>
<span class="sd">    values of the relevant parameters of some randomly selected model instances:</span>

<span class="sd">    &gt;&gt;&gt; stream = hp.elements.stream_lahn_1_lahn_2.model</span>
<span class="sd">    &gt;&gt;&gt; stream.parameters.control</span>
<span class="sd">    nmbsegments(lag=0.583)</span>
<span class="sd">    coefficients(damp=0.0)</span>
<span class="sd">    &gt;&gt;&gt; land = hp.elements.land_lahn_1.model</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.fc</span>
<span class="sd">    fc(206.0)</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.percmax</span>
<span class="sd">    percmax(1.02978)</span>

<span class="sd">    Method |CalibrationInterface.apply_values| of class |CalibrationInterface| calls</span>
<span class="sd">    method |Rule.apply_value| of all handled |Rule| objects, performs some preparations</span>
<span class="sd">    (for example, it derives the values of the secondary parameters), executes a</span>
<span class="sd">    simulation run, calls method |CalibrationInterface.calculate_likelihood|, and</span>
<span class="sd">    returns the result:</span>

<span class="sd">    &gt;&gt;&gt; result = ci.apply_values()</span>
<span class="sd">    &gt;&gt;&gt; stream.parameters.control</span>
<span class="sd">    nmbsegments(lag=0.583)</span>
<span class="sd">    coefficients(damp=0.3)</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.fc</span>
<span class="sd">    fc(100.0)</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.percmax</span>
<span class="sd">    percmax(5.0)</span>

<span class="sd">    Due to the changes in our parameter values, our simulation is not &quot;perfect&quot;</span>
<span class="sd">    anymore:</span>

<span class="sd">    &gt;&gt;&gt; round_(ci.result)</span>
<span class="sd">    1.605136</span>

<span class="sd">    Use method |CalibrationInterface.reset_parameters| to restore the initial states of</span>
<span class="sd">    all affected parameters:</span>

<span class="sd">    &gt;&gt;&gt; ci.reset_parameters()</span>
<span class="sd">    &gt;&gt;&gt; stream.parameters.control</span>
<span class="sd">    nmbsegments(lag=0.583)</span>
<span class="sd">    coefficients(damp=0.0)</span>
<span class="sd">    &gt;&gt;&gt; land = hp.elements.land_lahn_1.model</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.fc</span>
<span class="sd">    fc(206.0)</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.percmax</span>
<span class="sd">    percmax(1.02978)</span>

<span class="sd">    Now we get the same &quot;perfect&quot; efficiency again:</span>

<span class="sd">    &gt;&gt;&gt; hp.simulate()</span>
<span class="sd">    &gt;&gt;&gt; round_(ci.calculate_likelihood())</span>
<span class="sd">    4.0</span>
<span class="sd">    &gt;&gt;&gt; hp.conditions = conditions</span>

<span class="sd">    Note the `perform_simulation` argument of method</span>
<span class="sd">    |CalibrationInterface.apply_values|, which allows changing the model parameter</span>
<span class="sd">    values and updating the |HydPy| object only without triggering a simulation run</span>
<span class="sd">    (and to calculate and return a new likelihood value):</span>

<span class="sd">    &gt;&gt;&gt; ci.apply_values(perform_simulation=False)</span>
<span class="sd">    &gt;&gt;&gt; stream.parameters.control</span>
<span class="sd">    nmbsegments(lag=0.583)</span>
<span class="sd">    coefficients(damp=0.3)</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.fc</span>
<span class="sd">    fc(100.0)</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.percmax</span>
<span class="sd">    percmax(5.0)</span>

<span class="sd">    Optimisers, like those implemented in `NLopt`_, often provide their new parameter</span>
<span class="sd">    estimates via vectors.  Method |CalibrationInterface.perform_calibrationstep|</span>
<span class="sd">    accepts such vectors and updates the handled |Rule| objects accordingly.  After</span>
<span class="sd">    that, it performs the same steps as described for method</span>
<span class="sd">    |CalibrationInterface.apply_values|:</span>

<span class="sd">    &gt;&gt;&gt; round_(ci.perform_calibrationstep([100.0, 5.0, 0.3]))</span>
<span class="sd">    1.605136</span>

<span class="sd">    &gt;&gt;&gt; stream.parameters.control</span>
<span class="sd">    nmbsegments(lag=0.583)</span>
<span class="sd">    coefficients(damp=0.3)</span>

<span class="sd">    &gt;&gt;&gt; land.parameters.control.fc</span>
<span class="sd">    fc(100.0)</span>
<span class="sd">    &gt;&gt;&gt; land.parameters.control.percmax</span>
<span class="sd">    percmax(5.0)</span>

<span class="sd">    Method |CalibrationInterface.perform_calibrationstep| writes intermediate results</span>
<span class="sd">    into a log file, if available.  Prepare it beforehand via method</span>
<span class="sd">    |CalibrationInterface.prepare_logfile|:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ci.prepare_logfile(logfilepath=&quot;example_calibration.log&quot;,</span>
<span class="sd">    ...                        objectivefunction=&quot;NSE&quot;,</span>
<span class="sd">    ...                        documentation=&quot;Just a doctest example.&quot;)</span>

<span class="sd">    To continue &quot;manually&quot;, we now can call method</span>
<span class="sd">    |CalibrationInterface.update_logfile| to write the lastly calculated efficiency and</span>
<span class="sd">    the corresponding calibration parameter values to the log file:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():   # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    ...     ci.update_logfile()</span>
<span class="sd">    ...     with open(&quot;example_calibration.log&quot;) as file_:</span>
<span class="sd">    ...         print(file_.read())</span>
<span class="sd">    # Just a doctest example.</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    NSE           fc    percmax damp</span>
<span class="sd">    parameterstep None	1d      None</span>
<span class="sd">    1.605136      100.0 5.0     0.3</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    To prevent (automatic) calibration runs from crashing due to IO problems, method</span>
<span class="sd">    |CalibrationInterface.update_logfile| raises warnings instead of errors in such</span>
<span class="sd">    cases and logs the inwritten data internally:</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import warn_later</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), warn_later():</span>
<span class="sd">    ...     ci._logfilepath = &quot;dirname1/filename.log&quot;</span>
<span class="sd">    ...     ci.update_logfile()</span>
<span class="sd">    UserWarning: While trying to update the logfile `dirname1/filename.log`, the \</span>
<span class="sd">following problem occured: [Errno 2] No such file or directory: &#39;dirname1/filename.log&#39;.</span>

<span class="sd">    On subsequent calls, it tries to write both the previously logged and the new data:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():   # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    ...     os.makedirs(&quot;dirname1&quot;, exist_ok=True)</span>
<span class="sd">    ...     ci.update_logfile()</span>
<span class="sd">    ...     with open(&quot;dirname1/filename.log&quot;) as file_:</span>
<span class="sd">    ...         print(file_.read())</span>
<span class="sd">    1.605136 100.0 5.0 0.3</span>
<span class="sd">    1.605136 100.0 5.0 0.3</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    Call method |CalibrationInterface.finalise_logfile| to ensure the</span>
<span class="sd">    |CalibrationInterface| object does not withhold data after the end of a calibration</span>
<span class="sd">    run.  If you do so, it sleeps until it gets the chance to write the logged data and</span>
<span class="sd">    warns you about this problem from time to time (we demonstrate this by mocking the</span>
<span class="sd">    |warnings.warn| function and, to keep our test example awake, the |time.sleep|</span>
<span class="sd">    function):</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ci._logfilepath = &quot;dirname2/filename.log&quot;</span>
<span class="sd">    ...     ci.update_logfile()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    UserWarning: While trying to update the logfile `dirname2/filename.log`, the \</span>
<span class="sd">following problem occured: [Errno 2] No such file or directory: &#39;dirname2/filename.log&#39;.</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with mock.patch(&quot;time.sleep&quot;) as mocked:</span>
<span class="sd">    ...         mocked.side_effect = Exception(&quot;time.sleep actually called&quot;)</span>
<span class="sd">    ...         ci.finalise_logfile()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    UserWarning: Trying to finalise logfile `dirname2/filename.log` failed 1 times.</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with mock.patch(&quot;warnings.warn&quot;), mock.patch(&quot;time.sleep&quot;) as mocked:</span>
<span class="sd">    ...         mocked.side_effect = Exception(&quot;time.sleep actually called&quot;)</span>
<span class="sd">    ...         ci.finalise_logfile()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    Exception: time.sleep actually called</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():   # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    ...     os.makedirs(&quot;dirname2&quot;, exist_ok=True)</span>
<span class="sd">    ...     ci.finalise_logfile()</span>
<span class="sd">    ...     with open(&quot;dirname2/filename.log&quot;) as file_:</span>
<span class="sd">    ...         print(file_.read())</span>
<span class="sd">    1.605136 100.0 5.0 0.3</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    &gt;&gt;&gt; ci._logfilepath = &quot;example_calibration.log&quot;</span>

<span class="sd">    For automatic calibration, one needs a calibration algorithm like the following,</span>
<span class="sd">    which checks the lower and upper boundaries and the initial values of all |Rule|</span>
<span class="sd">    objects:</span>

<span class="sd">    &gt;&gt;&gt; def find_max(function, lowers, uppers, inits):</span>
<span class="sd">    ...     best_result = -999.0</span>
<span class="sd">    ...     best_parameters = None</span>
<span class="sd">    ...     for values in (lowers, uppers, inits):</span>
<span class="sd">    ...         result = function(values)</span>
<span class="sd">    ...         if result &gt; best_result:</span>
<span class="sd">    ...             best_result = result</span>
<span class="sd">    ...             best_parameters = values</span>
<span class="sd">    ...     return best_parameters</span>

<span class="sd">    Now we can assign method |CalibrationInterface.perform_calibrationstep| to this</span>
<span class="sd">    oversimplified optimiser, which then returns the best examined calibration</span>
<span class="sd">    parameter values:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     find_max(function=ci.perform_calibrationstep,</span>
<span class="sd">    ...              lowers=ci.lowers,</span>
<span class="sd">    ...              uppers=ci.uppers,</span>
<span class="sd">    ...              inits=ci.values)</span>
<span class="sd">    (200.0, 10.0, 0.5)</span>

<span class="sd">    The log file now contains one line for our old result and three lines for the</span>
<span class="sd">    results of our optimiser:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():   # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    ...     with open(&quot;example_calibration.log&quot;) as file_:</span>
<span class="sd">    ...         print(file_.read())</span>
<span class="sd">    # Just a doctest example.</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    NSE           fc    percmax damp</span>
<span class="sd">    parameterstep None  1d      None</span>
<span class="sd">    1.605136      100.0 5.0     0.3</span>
<span class="sd">    -0.710211     50.0  1.0     0.0</span>
<span class="sd">    2.313934      200.0 10.0    0.5</span>
<span class="sd">    1.605136      100.0 5.0     0.3</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    Class |CalibrationInterface| also provides method</span>
<span class="sd">    |CalibrationInterface.read_logfile|, which automatically selects the best</span>
<span class="sd">    calibration result.  Therefore, it needs to know that the highest result is the</span>
<span class="sd">    best, which we indicate by setting argument `maximisation` to |True|:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ci.read_logfile(logfilepath=&quot;example_calibration.log&quot;, maximisation=True)</span>
<span class="sd">    &gt;&gt;&gt; ci.fc.value</span>
<span class="sd">    200.0</span>
<span class="sd">    &gt;&gt;&gt; ci.percmax.value</span>
<span class="sd">    10.0</span>
<span class="sd">    &gt;&gt;&gt; ci.damp.value</span>
<span class="sd">    0.5</span>
<span class="sd">    &gt;&gt;&gt; round_(ci.result)</span>
<span class="sd">    2.313934</span>
<span class="sd">    &gt;&gt;&gt; round_(ci.apply_values())</span>
<span class="sd">    2.313934</span>

<span class="sd">    On the contrary, if we set argument `maximisation` to |False|, method</span>
<span class="sd">    |CalibrationInterface.read_logfile| returns the worst result in our example:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ci.read_logfile(logfilepath=&quot;example_calibration.log&quot;, maximisation=False)</span>
<span class="sd">    &gt;&gt;&gt; ci.fc.value</span>
<span class="sd">    50.0</span>
<span class="sd">    &gt;&gt;&gt; ci.percmax.value</span>
<span class="sd">    1.0</span>
<span class="sd">    &gt;&gt;&gt; ci.damp.value</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; round_(ci.result)</span>
<span class="sd">    -0.710211</span>
<span class="sd">    &gt;&gt;&gt; round_(ci.apply_values())</span>
<span class="sd">    -0.710211</span>

<span class="sd">    To prevent errors due to different parameter step-sizes, method</span>
<span class="sd">    |CalibrationInterface.read_logfile| raises the following error whenever it detects</span>
<span class="sd">    inconsistencies:</span>

<span class="sd">    &gt;&gt;&gt; ci.percmax.parameterstep = &quot;2d&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ci.read_logfile(logfilepath=&quot;example_calibration.log&quot;,maximisation=True)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: The current parameterstep of the `Replace` rule `percmax` (`2d`) \</span>
<span class="sd">does not agree with the one documentated in log file `example_calibration.log` (`1d`).</span>

<span class="sd">    Method |CalibrationInterface.read_logfile| reports inconsistent rule names as</span>
<span class="sd">    follows:</span>

<span class="sd">    &gt;&gt;&gt; ci.remove_rules(ci.percmax)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ci.read_logfile(logfilepath=&quot;example_calibration.log&quot;,maximisation=True)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: The names of the rules handled by the actual calibration interface \</span>
<span class="sd">(damp and fc) do not agree with the names in the header of logfile \</span>
<span class="sd">`example_calibration.log` (damp, fc, and percmax).</span>

<span class="sd">    The last consistency check is optional.  Set argument `check` to |False| to force</span>
<span class="sd">    method |CalibrationInterface.read_logfile| to query all available data instead of</span>
<span class="sd">    raising an error:</span>

<span class="sd">    &gt;&gt;&gt; ci.add_rules(Replace(name=&quot;beta&quot;,</span>
<span class="sd">    ...                      parameter=&quot;beta&quot;,</span>
<span class="sd">    ...                      value=2.0,</span>
<span class="sd">    ...                      lower=1.0,</span>
<span class="sd">    ...                      upper=4.0,</span>
<span class="sd">    ...                      selections=[&quot;complete&quot;],</span>
<span class="sd">    ...                      model=&quot;hland_v1&quot;))</span>
<span class="sd">    &gt;&gt;&gt; ci.fc.value = 0.0</span>
<span class="sd">    &gt;&gt;&gt; ci.damp.value = 0.0</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ci.read_logfile(</span>
<span class="sd">    ...         logfilepath=&quot;example_calibration.log&quot;,</span>
<span class="sd">    ...         maximisation=True,</span>
<span class="sd">    ...         check=False,</span>
<span class="sd">    ...     )</span>
<span class="sd">    &gt;&gt;&gt; ci.beta.value</span>
<span class="sd">    2.0</span>
<span class="sd">    &gt;&gt;&gt; ci.fc.value</span>
<span class="sd">    200.0</span>
<span class="sd">    &gt;&gt;&gt; ci.damp.value</span>
<span class="sd">    0.5</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The last result, as calculated by the target function.&quot;&quot;&quot;</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">hydpytools</span><span class="o">.</span><span class="n">ConditionsType</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The |HydPy.conditions| of the given |HydPy| object.</span>

<span class="sd">    |CalibrationInterface| queries the conditions during its initialisation and uses </span>
<span class="sd">    them later to reset all relevant conditions before each new simulation run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logfilepath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">_logfilelines</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">_hp</span><span class="p">:</span> <span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span>
    <span class="n">_targetfunction</span><span class="p">:</span> <span class="n">TargetFunction</span>
    <span class="n">_rules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TypeRule1</span><span class="p">]</span>
    <span class="n">_elements</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Elements</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hp</span><span class="p">:</span> <span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">,</span> <span class="n">targetfunction</span><span class="p">:</span> <span class="n">TargetFunction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hp</span> <span class="o">=</span> <span class="n">hp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_targetfunction</span> <span class="o">=</span> <span class="n">targetfunction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Elements</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logfilelines</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CalibrationInterface.add_rules">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.add_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">add_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">rules</span><span class="p">:</span> <span class="n">TypeRule1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add some |Rule| objects to the actual |CalibrationInterface| object.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import CalibrationInterface</span>
<span class="sd">        &gt;&gt;&gt; ci = CalibrationInterface(hp=hp, targetfunction=lambda: None)</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import Replace</span>
<span class="sd">        &gt;&gt;&gt; ci.add_rules(Replace(name=&quot;fc&quot;,</span>
<span class="sd">        ...                      parameter=&quot;fc&quot;,</span>
<span class="sd">        ...                      value=100.0,</span>
<span class="sd">        ...                      model=&quot;hland_v1&quot;),</span>
<span class="sd">        ...              Replace(name=&quot;percmax&quot;,</span>
<span class="sd">        ...                      parameter=&quot;percmax&quot;,</span>
<span class="sd">        ...                      value=5.0,</span>
<span class="sd">        ...                      model=&quot;hland_v1&quot;))</span>

<span class="sd">        Note that method |CalibrationInterface.add_rules| might change the number of</span>
<span class="sd">        |Element| objects relevant for the |CalibrationInterface| object:</span>

<span class="sd">        &gt;&gt;&gt; damp = Replace(name=&quot;damp&quot;,</span>
<span class="sd">        ...                parameter=&quot;coefficients&quot;,</span>
<span class="sd">        ...                value=0.2,</span>
<span class="sd">        ...                keyword=&quot;damp&quot;,</span>
<span class="sd">        ...                model=&quot;musk_classic&quot;)</span>
<span class="sd">        &gt;&gt;&gt; len(ci._elements)</span>
<span class="sd">        4</span>
<span class="sd">        &gt;&gt;&gt; ci.add_rules(damp)</span>
<span class="sd">        &gt;&gt;&gt; len(ci._elements)</span>
<span class="sd">        7</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_elements_when_adding_a_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span></div>


    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeRule1</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TypeRule2</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TypeRule2</span><span class="p">:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="CalibrationInterface.get_rule">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.get_rule">[docs]</a>
    <span class="k">def</span> <span class="nf">get_rule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">TypeRule2</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TypeRule1</span><span class="p">,</span> <span class="n">TypeRule2</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a |Rule| object (of a specific type).</span>

<span class="sd">        Method |CalibrationInterface.get_rule| is a more typesafe alternative to simple</span>
<span class="sd">        keyword access. Besides the name of the required |Rule| object, pass its</span>
<span class="sd">        subclass to convince your IDE (and yourself) that the returned rule follows</span>
<span class="sd">        this more specific type:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import Add, CalibrationInterface, make_rules, nse, Replace</span>
<span class="sd">        &gt;&gt;&gt; ci = CalibrationInterface(</span>
<span class="sd">        ...     hp=hp,</span>
<span class="sd">        ...     targetfunction=lambda: sum(nse(node=node) for node in hp.nodes))</span>
<span class="sd">        &gt;&gt;&gt; ci.add_rules(*make_rules(rule=Replace,</span>
<span class="sd">        ...                          names=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">        ...                          parameters=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">        ...                          values=[100.0, 5.0],</span>
<span class="sd">        ...                          keywords=[&quot;forest&quot;, None],</span>
<span class="sd">        ...                          lowers=[50.0, 1.0],</span>
<span class="sd">        ...                          uppers=[200.0, 10.0],</span>
<span class="sd">        ...                          parametersteps=&quot;1d&quot;,</span>
<span class="sd">        ...                          model=&quot;hland_v1&quot;))</span>

<span class="sd">        &gt;&gt;&gt; ci.get_rule(&quot;fc&quot;, Replace).name</span>
<span class="sd">        &#39;fc&#39;</span>

<span class="sd">        &gt;&gt;&gt; ci.get_rule(&quot;Fc&quot;, Replace).name</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: The actual calibration interface does not handle a rule object \</span>
<span class="sd">named `Fc`.</span>

<span class="sd">        &gt;&gt;&gt; ci.get_rule(&quot;fc&quot;, Replace).name</span>
<span class="sd">        &#39;fc&#39;</span>

<span class="sd">        &gt;&gt;&gt; ci.get_rule(&quot;fc&quot;, Add).name</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: The actual calibration interface does not handle a rule object \</span>
<span class="sd">named `fc` of type `Add`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The actual calibration interface does not handle a rule object &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rule</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The actual calibration interface does not handle a rule object named &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` of type `</span><span class="si">{</span><span class="n">type_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">`.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CalibrationInterface.remove_rules">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.remove_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">rules</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TypeRule1</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove some |Rule| objects from the actual |CalibrationInterface| object.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import CalibrationInterface</span>
<span class="sd">        &gt;&gt;&gt; ci = CalibrationInterface(hp=hp, targetfunction=lambda: None)</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import Replace</span>
<span class="sd">        &gt;&gt;&gt; ci.add_rules(Replace(name=&quot;fc&quot;,</span>
<span class="sd">        ...                      parameter=&quot;fc&quot;,</span>
<span class="sd">        ...                      value=100.0,</span>
<span class="sd">        ...                      model=&quot;hland_v1&quot;),</span>
<span class="sd">        ...              Replace(name=&quot;percmax&quot;,</span>
<span class="sd">        ...                      parameter=&quot;percmax&quot;,</span>
<span class="sd">        ...                      value=5.0,</span>
<span class="sd">        ...                      model=&quot;hland_v1&quot;),</span>
<span class="sd">        ...              Replace(name=&quot;damp&quot;,</span>
<span class="sd">        ...                      parameter=&quot;coefficients&quot;,</span>
<span class="sd">        ...                      value=0.2,</span>
<span class="sd">        ...                      keyword=&quot;damp&quot;,</span>
<span class="sd">        ...                      model=&quot;musk_classic&quot;))</span>

<span class="sd">        You can remove each rule either by passing itself or its name (note that method</span>
<span class="sd">        |CalibrationInterface.remove_rules| might change the number of |Element|</span>
<span class="sd">        objects relevant for the |CalibrationInterface| object):</span>

<span class="sd">        &gt;&gt;&gt; len(ci._elements)</span>
<span class="sd">        7</span>
<span class="sd">        &gt;&gt;&gt; fc = ci.fc</span>
<span class="sd">        &gt;&gt;&gt; fc in ci</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; &quot;damp&quot; in ci</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; ci.remove_rules(fc, &quot;damp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; fc in ci</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; &quot;damp&quot; in ci</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; len(ci._elements)</span>
<span class="sd">        4</span>

<span class="sd">        Trying to remove a non-existing rule results in the following error:</span>

<span class="sd">        &gt;&gt;&gt; ci.remove_rules(&quot;fc&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: The actual calibration interface object does not handle a rule \</span>
<span class="sd">object named `fc`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The actual calibration interface object does not handle a rule &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;object named `</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">`.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_elements_when_deleting_a_rule</span><span class="p">()</span></div>


<div class="viewcode-block" id="CalibrationInterface.prepare_logfile">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.prepare_logfile">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_logfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">logfilepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">objectivefunction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span>
        <span class="n">documentation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare a log file.</span>

<span class="sd">        Use argument `objectivefunction` to describe the |TargetFunction| used for</span>
<span class="sd">        calculating the efficiency and argument `documentation` to add some information</span>
<span class="sd">        to the header of the logfile.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span> <span class="o">=</span> <span class="n">logfilepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logfilelines</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfilepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ENCODING</span><span class="p">)</span> <span class="k">as</span> <span class="n">logfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">documentation</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">documentation</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
                <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objectivefunction</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">)</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;parameterstep&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">steps</span><span class="p">))</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CalibrationInterface.update_logfile">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.update_logfile">[docs]</a>
    <span class="k">def</span> <span class="nf">update_logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the current log file, if available.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logfilelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_data_into_logfile</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;While trying to update the logfile `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span><span class="si">}</span><span class="s2">`, the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;following problem occured: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="CalibrationInterface.finalise_logfile">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.finalise_logfile">[docs]</a>
    <span class="k">def</span> <span class="nf">finalise_logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the current log file if method |CalibrationInterface.update_logfile|</span>
<span class="sd">        was not entirely successful in doing so.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logfilelines</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_data_into_logfile</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Trying to finalise logfile `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span><span class="si">}</span><span class="s2">` failed &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2"> times.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_write_data_into_logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ENCODING</span><span class="p">)</span> <span class="k">as</span> <span class="n">logfile</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logfilelines</span><span class="p">:</span>
                <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logfilelines</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>

<div class="viewcode-block" id="CalibrationInterface.read_logfile">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.read_logfile">[docs]</a>
    <span class="k">def</span> <span class="nf">read_logfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">logfilepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">maximisation</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the log file with the given file path.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfilepath</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ENCODING</span><span class="p">)</span> <span class="k">as</span> <span class="n">logfile</span><span class="p">:</span>
            <span class="c1"># pylint: disable=not-an-iterable</span>
            <span class="c1"># because pylint is sometimes wrong about this</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">logfile</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="c1"># pylint: enable=not-an-iterable</span>
        <span class="n">idx2name</span><span class="p">,</span> <span class="n">idx2rule</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">parameterstep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parameterstep</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">:</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">parameterstep</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="n">parameterstep</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parameterstep</span> <span class="o">=</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="n">parameterstep</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parameterstep</span> <span class="o">!=</span> <span class="n">rule</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The current parameterstep of the `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;rule `</span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` (`</span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">parameterstep</span><span class="si">}</span><span class="s2">`) does not agree &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;with the one documentated in log file `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span><span class="si">}</span><span class="s2">` &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(`</span><span class="si">{</span><span class="n">parameterstep</span><span class="si">}</span><span class="s2">`).&quot;</span>
                    <span class="p">)</span>
                <span class="n">idx2rule</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span>
            <span class="n">idx2name</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="n">names_int</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="n">names_ext</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">idx2name</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">names_int</span> <span class="o">!=</span> <span class="n">names_ext</span><span class="p">:</span>
                <span class="n">enumeration</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">enumeration</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The names of the rules handled by the actual calibration &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;interface (</span><span class="si">{</span><span class="n">enumeration</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">names_int</span><span class="p">))</span><span class="si">}</span><span class="s2">) do not agree with &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;the names in the header of logfile `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_logfilepath</span><span class="si">}</span><span class="s2">` &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">enumeration</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">names_ext</span><span class="p">))</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
        <span class="n">jdx_best</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">result_best</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">maximisation</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">maximisation</span> <span class="ow">and</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">result_best</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="n">maximisation</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">result_best</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">jdx_best</span> <span class="o">=</span> <span class="n">jdx</span>
                <span class="n">result_best</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">jdx_best</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx2rule</span><span class="p">:</span>
                <span class="n">idx2rule</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result_best</span></div>


    <span class="k">def</span> <span class="nf">_update_elements_when_adding_a_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">TypeRule1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">+=</span> <span class="n">rule</span><span class="o">.</span><span class="n">elements</span>

    <span class="k">def</span> <span class="nf">_update_elements_when_deleting_a_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Elements</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">+=</span> <span class="n">rule</span><span class="o">.</span><span class="n">elements</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The names of all handled |Rule| objects.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The values of all handled |Rule| objects.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The (optional) target keywords of all handled |Rule| objects.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lowers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The lower boundaries of all handled |Rule| objects.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">lower</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uppers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The upper boundaries of all handled |Rule| objects.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">upper</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selections</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The names of all |Selection| objects addressed at least one of the handled</span>
<span class="sd">        |Rule| objects.</span>

<span class="sd">        See the documentation on function |make_rules| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">selections</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)))</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parametertypes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">],</span> <span class="n">Target</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The types of all |Parameter| objects addressed by at least one of the</span>
<span class="sd">        handled |Rule| objects.</span>

<span class="sd">        See the documentation on function |make_rules| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parametertypes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">],</span> <span class="n">Target</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">RuleIUH</span><span class="p">):</span>
                <span class="n">parametertypes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rule</span><span class="o">.</span><span class="n">parametertype</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parametertypes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rule</span><span class="o">.</span><span class="n">parametertype</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">sort_variables</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">parametertypes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_update_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rule</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_refresh_hp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">:</span>
            <span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hp</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">apply_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perform_simulation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">apply_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perform_simulation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="CalibrationInterface.apply_values">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.apply_values">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perform_simulation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply all current calibration parameter values on all relevant parameters.</span>

<span class="sd">        Set argument `perform_simulation` to |False| to only change the actual</span>
<span class="sd">        parameter values and update the |HydPy| object without performing a simulation</span>
<span class="sd">        run.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">apply_value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_hp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">perform_simulation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hp</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_likelihood</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="CalibrationInterface.reset_parameters">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.reset_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all relevant parameters to their original states.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">         information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_hp</span><span class="p">()</span></div>


<div class="viewcode-block" id="CalibrationInterface.calculate_likelihood">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.calculate_likelihood">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the defined |TargetFunction| and return the result.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_targetfunction</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span></div>


<div class="viewcode-block" id="CalibrationInterface.perform_calibrationstep">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.perform_calibrationstep">[docs]</a>
    <span class="k">def</span> <span class="nf">perform_calibrationstep</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="c1"># for optimisers that pass additional informative data</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update all calibration parameters with the given values, update the |HydPy|</span>
<span class="sd">        object, perform a simulation run, and calculate and return the achieved</span>
<span class="sd">        efficiency.</span>

<span class="sd">        See the main documentation on class |CalibrationInterface| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_values</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">likelihood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_logfile</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">likelihood</span></div>


<div class="viewcode-block" id="CalibrationInterface.print_table">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibrationInterface.print_table">[docs]</a>
    <span class="k">def</span> <span class="nf">print_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parametertypes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Sequence</span><span class="p">[</span>
                <span class="n">Union</span><span class="p">[</span>
                    <span class="n">Type</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">],</span>
                    <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">],</span> <span class="n">Target</span><span class="p">],</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">selections</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">),</span>
        <span class="n">fillvalue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
        <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">file_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TextIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the current calibration parameter values in a table format.</span>

<span class="sd">        The following examples combine the base examples of the documentation on class</span>
<span class="sd">        |CalibrationInterface| and class |ReplaceIUH|, so please make sure to</span>
<span class="sd">        understand them before proceeding.</span>

<span class="sd">        We again use the `Lahn` example project but replace the |musk_classic| model</span>
<span class="sd">        instances with those of application model |arma_v1|, which allows discussing</span>
<span class="sd">        some special cases concerning the handling of |RuleIUH|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.river:</span>
<span class="sd">        ...     element.model = prepare_model(&quot;arma_v1&quot;)</span>
<span class="sd">        ...     element.model.parameters.control.responses([[], [1.0]])</span>
<span class="sd">        ...     element.model.parameters.update()</span>

<span class="sd">        We pass a (useless) dummy target function to the |CalibrationInterface| object:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibrationInterface</span>
<span class="sd">        &gt;&gt;&gt; ci = CalibrationInterface(hp=hp, targetfunction=lambda: 1.0)</span>

<span class="sd">        Regarding |hland_v1|, we intend to calibrate the parameters |hland_control.FC|</span>
<span class="sd">        and |hland_control.PercMax| with different values for the selections</span>
<span class="sd">        `headwaters` and `nonheadwaters`:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs, make_rules, Replace</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs(</span>
<span class="sd">        ...     CalibSpec(name=&quot;fc&quot;, default=100.0, lower=50.0, upper=200.0),</span>
<span class="sd">        ...     CalibSpec(name=&quot;percmax&quot;, default=5.0, lower=1.0, upper=10.0, \</span>
<span class="sd">parameterstep=&quot;1d&quot;))</span>
<span class="sd">        &gt;&gt;&gt; ci.add_rules(*make_rules(rule=Replace,</span>
<span class="sd">        ...                          calibspecs=calibspecs,</span>
<span class="sd">        ...                          model=&quot;hland_v1&quot;,</span>
<span class="sd">        ...                          selections=(&quot;headwaters&quot;, &quot;nonheadwaters&quot;),</span>
<span class="sd">        ...                          product=True))</span>

<span class="sd">        Regarding |arma_v1|, we cannot calibrate the values of parameter</span>
<span class="sd">        |arma_control.Responses| in a meaningful way.  So instead, we use the</span>
<span class="sd">        |LinearStorageCascade| as a meta-model and calibrate its parameters</span>
<span class="sd">        |LinearStorageCascade.k| and |LinearStorageCascade.n|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import LinearStorageCascade, ReplaceIUH</span>
<span class="sd">        &gt;&gt;&gt; k = ReplaceIUH(name=&quot;k_global&quot;,</span>
<span class="sd">        ...                target=&quot;k&quot;,</span>
<span class="sd">        ...                parameter=&quot;responses&quot;,</span>
<span class="sd">        ...                value=2.0,</span>
<span class="sd">        ...                lower=1.0,</span>
<span class="sd">        ...                parameterstep=&quot;1d&quot;,</span>
<span class="sd">        ...                selections=(&quot;streams&quot;,))</span>
<span class="sd">        &gt;&gt;&gt; n = ReplaceIUH(name=&quot;n_global&quot;,</span>
<span class="sd">        ...                target=&quot;n&quot;,</span>
<span class="sd">        ...                parameter=&quot;responses&quot;,</span>
<span class="sd">        ...                value=4.0,</span>
<span class="sd">        ...                lower=1.0,</span>
<span class="sd">        ...                upper=100.0,</span>
<span class="sd">        ...                selections=(&quot;streams&quot;,))</span>
<span class="sd">        &gt;&gt;&gt; name2lsc = {element.name: LinearStorageCascade(k=1.0, n=1.0)</span>
<span class="sd">        ...             for element in hp.elements.river}</span>
<span class="sd">        &gt;&gt;&gt; k.add_iuhs(**name2lsc)</span>
<span class="sd">        &gt;&gt;&gt; n.add_iuhs(**name2lsc)</span>
<span class="sd">        &gt;&gt;&gt; ci.add_rules(k, n)</span>

<span class="sd">        We change the values of two |Rule| objects related to |hland_v1| to clarify</span>
<span class="sd">        that all values appear in the correct table cells:</span>

<span class="sd">        &gt;&gt;&gt; ci[&quot;fc_headwaters&quot;].value = 200.0</span>
<span class="sd">        &gt;&gt;&gt; ci[&quot;percmax_nonheadwaters&quot;].value = 10.0</span>

<span class="sd">        By default, method |CalibrationInterface.print_table| prints the values of all</span>
<span class="sd">        handled |Rule| objects.  It varies the target control parameters on the first</span>
<span class="sd">        axis and the target selections on the second axis.  Row two and three contain</span>
<span class="sd">        the (identical) lower and upper boundary values corresponding to the respective</span>
<span class="sd">        control parameters:</span>

<span class="sd">        &gt;&gt;&gt; ci.print_table()  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    	              lower  upper  headwaters  nonheadwaters  streams</span>
<span class="sd">        k-&gt;Responses  1.0   inf     /           /              2.0</span>
<span class="sd">        n-&gt;Responses  1.0   100.0   /           /              4.0</span>
<span class="sd">        FC            50.0   200.0  200.0       100.0          /</span>
<span class="sd">        PercMax       1.0    10.0   5.0         10.0           /</span>

<span class="sd">        For non-identical boundary values, method |CalibrationInterface.print_table|</span>
<span class="sd">        prints fill values in the relevant cells.  Besides this, the following example</span>
<span class="sd">        shows how to define alternative titles for the boundary value columns:</span>

<span class="sd">        &gt;&gt;&gt; ci[&quot;fc_headwaters&quot;].lower = 60.0</span>
<span class="sd">        &gt;&gt;&gt; ci[&quot;percmax_nonheadwaters&quot;].upper = 20.0</span>
<span class="sd">        &gt;&gt;&gt; ci.print_table(bounds=(&quot;min&quot;, &quot;max&quot;))  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    	              min    max    headwaters  nonheadwaters  streams</span>
<span class="sd">        k-&gt;Responses  1.0    inf    /          /               2.0</span>
<span class="sd">        n-&gt;Responses  1.0    100.0  /          /               4.0</span>
<span class="sd">        FC              /    200.0  200.0      100.0           /</span>
<span class="sd">        PercMax       1.0    /      5.0        10.0            /</span>

<span class="sd">        Pass |None| to argument `bounds` to omit writing any boundary value column:</span>

<span class="sd">        &gt;&gt;&gt; ci.print_table(bounds=None)  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">                      headwaters  nonheadwaters  streams</span>
<span class="sd">        k-&gt;Responses  /           /              2.0</span>
<span class="sd">        n-&gt;Responses  /           /              4.0</span>
<span class="sd">        FC            200.0       100.0          /</span>
<span class="sd">        PercMax       5.0         10.0           /</span>

<span class="sd">        The next example shows how to change the tabulated target parameters and</span>
<span class="sd">        selections.  Method |CalibrationInterface.print_table| uses the (given</span>
<span class="sd">        alternative) fill value for each parameter-selection-combination not met by any</span>
<span class="sd">        of the available |Rule| objects.  For |RuleIUH|-related parameters, we must</span>
<span class="sd">        specify both the control parameter (as a type, in our example</span>
<span class="sd">        |arma_control.Responses|) and the meta-parameter (as a string, in our example</span>
<span class="sd">        |LinearStorageCascade.k|) within a |tuple|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland.hland_control import CFlux, PercMax</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.models.arma.arma_control import Responses</span>
<span class="sd">        &gt;&gt;&gt; ci.print_table(  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        ...     parametertypes=(PercMax, CFlux, (Responses, &quot;k&quot;)),</span>
<span class="sd">        ...     selections=(&quot;streams&quot;, &quot;headwaters&quot;),</span>
<span class="sd">        ...     bounds=None,</span>
<span class="sd">        ...     fillvalue=&quot;-&quot;)</span>
<span class="sd">    	              streams  headwaters</span>
<span class="sd">        PercMax       -        5.0</span>
<span class="sd">        CFlux         -        -</span>
<span class="sd">        k-&gt;Responses  2.0      -</span>

<span class="sd">        Note that the value of the same calibration parameter might appear multiple</span>
<span class="sd">        times when targeting multiple |Selection| objects:</span>

<span class="sd">        &gt;&gt;&gt; ci[&quot;fc_headwaters&quot;].selections = (&quot;headwaters&quot;, &quot;streams&quot;)</span>
<span class="sd">        &gt;&gt;&gt; ci.print_table(bounds=None)  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    	              headwaters  nonheadwaters  streams</span>
<span class="sd">        k-&gt;Responses  /           /              2.0</span>
<span class="sd">        n-&gt;Responses  /           /              4.0</span>
<span class="sd">        FC            200.0       100.0	         200.0</span>
<span class="sd">        PercMax       5.0	      10.0	         /</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">none</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;_None&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})()</span>
        <span class="k">if</span> <span class="n">parametertypes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parametertypes_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametertypes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parametertypes_</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">item</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parametertypes</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">selections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">selections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">bounds</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parametertypes_</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">))</span> <span class="o">+</span> <span class="n">delta</span><span class="p">),</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">fillvalue</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">par</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">target</span> <span class="k">else</span> <span class="n">par</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">parametertypes_</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="p">:]</span> <span class="o">=</span> <span class="n">selections</span>
        <span class="n">par2idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">par</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parametertypes_</span><span class="p">)}</span>
        <span class="n">sel2jdx</span> <span class="o">=</span> <span class="p">{</span><span class="n">sel</span><span class="p">:</span> <span class="n">jdx</span> <span class="o">+</span> <span class="n">delta</span> <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">sel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selections</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">RuleIUH</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">par2idx</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">rule</span><span class="o">.</span><span class="n">parametertype</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">par2idx</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">rule</span><span class="o">.</span><span class="n">parametertype</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bounds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">fillvalue</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
                        <span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">lower</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">none</span>
                    <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">fillvalue</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">upper</span><span class="p">):</span>
                        <span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">upper</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">none</span>
                <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">selections</span><span class="p">:</span>
                    <span class="n">jdx</span> <span class="o">=</span> <span class="n">sel2jdx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">jdx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">jdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">value</span>
        <span class="n">table</span><span class="p">[</span><span class="n">table</span> <span class="o">==</span> <span class="n">none</span><span class="p">]</span> <span class="o">=</span> <span class="n">fillvalue</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file_</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">TypeRule1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">rule</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeRule1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The actual calibration interface does neither handle a normal &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;attribute nor a rule object named `</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeRule1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The actual calibration interface does not handle a rule object &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;named `</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Rule</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import CalibrationInterface, make_rules, Replace</span>
<span class="sd">        &gt;&gt;&gt; ci = CalibrationInterface[Replace](hp=hp, targetfunction=lambda: None)</span>
<span class="sd">        &gt;&gt;&gt; ci.add_rules(*make_rules(rule=Replace,</span>
<span class="sd">        ...                          names=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">        ...                          parameters=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">        ...                          values=[100.0, 5.0],</span>
<span class="sd">        ...                          keywords=[&quot;forest&quot;, None],</span>
<span class="sd">        ...                          lowers=[50.0, 1.0],</span>
<span class="sd">        ...                          uppers=[200.0, 10.0],</span>
<span class="sd">        ...                          parametersteps=&quot;1d&quot;,</span>
<span class="sd">        ...                          model=&quot;hland_v1&quot;))</span>
<span class="sd">        &gt;&gt;&gt; sorted(set(dir(ci)) - set(object.__dir__(ci)))</span>
<span class="sd">        [&#39;fc&#39;, &#39;percmax&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>



<div class="viewcode-block" id="RuleIUH">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.RuleIUH">[docs]</a>
<span class="k">class</span> <span class="nc">RuleIUH</span><span class="p">(</span><span class="n">Rule</span><span class="p">[</span><span class="s2">&quot;arma_control.Responses&quot;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A |Rule|, class specialised for |IUH| parameters.</span>

<span class="sd">    |RuleIUH| serves as a base class only.  Please see the concrete implementation</span>
<span class="sd">    |ReplaceIUH| for further information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">target</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of the addressed property of the relevant |IUH| subclass.&quot;&quot;&quot;</span>

    <span class="n">update_parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag indicating whether method |ReplaceIUH.apply_value| should calculate the </span>
<span class="sd">    |ARMA.coefs| and pass them to the relevant model parameter or not.</span>

<span class="sd">    Set this flag to |False| for the first |ReplaceIUH| object when another handles the </span>
<span class="sd">    same elements and is applied afterwards.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_element2iuh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">iuhtools</span><span class="o">.</span><span class="n">IUH</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parameter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">arma_control</span><span class="o">.</span><span class="n">Responses</span><span class="p">],</span> <span class="n">arma_control</span><span class="o">.</span><span class="n">Responses</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">parameterstep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">PeriodConstrArg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">selections</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">selectiontools</span><span class="o">.</span><span class="n">Selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">parameter</span><span class="o">=</span><span class="n">parameter</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span>
            <span class="n">parameterstep</span><span class="o">=</span><span class="n">parameterstep</span><span class="p">,</span>
            <span class="n">selections</span><span class="o">=</span><span class="n">selections</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">_get_original_parameter_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Vector</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Vector</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="o">...</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">ar_coefs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">par</span><span class="o">.</span><span class="n">ma_coefs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span>
        <span class="p">)</span>

<div class="viewcode-block" id="RuleIUH.add_iuhs">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.RuleIUH.add_iuhs">[docs]</a>
    <span class="k">def</span> <span class="nf">add_iuhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">iuhs</span><span class="p">:</span> <span class="n">iuhtools</span><span class="o">.</span><span class="n">IUH</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add one |IUH| object for each relevant |Element| object.</span>

<span class="sd">        See the main documentation on class |ReplaceIUH| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">names_int</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="n">names_ext</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">iuhs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">names_int</span> <span class="o">!=</span> <span class="n">names_ext</span><span class="p">:</span>
                <span class="n">enumeration</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">enumeration</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The given elements (</span><span class="si">{</span><span class="n">enumeration</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">names_ext</span><span class="p">))</span><span class="si">}</span><span class="s2">) do not &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;agree with the complete set of relevant elements &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">enumeration</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">names_int</span><span class="p">))</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
            <span class="n">element2iuh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element2iuh</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                <span class="n">element2iuh</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">iuhs</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;While trying to add `IUH` objects to the `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;rule `</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_iuhs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">iuhtools</span><span class="o">.</span><span class="n">IUH</span><span class="p">]:</span>
        <span class="n">element2iuh</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element2iuh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element2iuh</span>
        <span class="k">for</span> <span class="n">iuh</span> <span class="ow">in</span> <span class="n">element2iuh</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">iuh</span>

<div class="viewcode-block" id="RuleIUH.reset_parameters">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.RuleIUH.reset_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all relevant parameter objects to their original states.</span>

<span class="sd">        See the main documentation on class |ReplaceIUH| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">orig</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_parameter_values</span><span class="p">):</span>
            <span class="n">parameter</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ReplaceIUH">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.ReplaceIUH">[docs]</a>
<span class="k">class</span> <span class="nc">ReplaceIUH</span><span class="p">(</span><span class="n">RuleIUH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A |RuleIUH| class for replacing |IUH| parameter values with the current</span>
<span class="sd">    calibration parameter values.</span>

<span class="sd">    Usually, it is not a good idea to calibrate the AR and MA coefficients of</span>
<span class="sd">    parameters like |arma_control.Responses| of model |arma_v1| individually.  Instead,</span>
<span class="sd">    we need to calibrate the few coefficients of the underlying |IUH| objects, which</span>
<span class="sd">    calculate the ARMA coefficients.  Class |ReplaceIUH| helps to accomplish this task.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Class |ReplaceIUH| is still under development.  For example, it does not</span>
<span class="sd">        address the possibility of different ARMA coefficients related to different</span>
<span class="sd">        discharge thresholds.  Hence, the usage of class |ReplaceIUH| might change in</span>
<span class="sd">        the future.</span>

<span class="sd">    So far, there is no example project containing |arma_v1| models instances.</span>
<span class="sd">    Therefore, we generate a simple one consisting of two |Element| objects only:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import Element, prepare_model, Selection</span>
<span class="sd">    &gt;&gt;&gt; element1 = Element(&quot;element1&quot;, inlets=&quot;in1&quot;, outlets=&quot;out1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; element2 = Element(&quot;element2&quot;, inlets=&quot;in2&quot;, outlets=&quot;out2&quot;)</span>
<span class="sd">    &gt;&gt;&gt; complete = Selection(&quot;complete&quot;, elements=[element1, element2])</span>
<span class="sd">    &gt;&gt;&gt; element1.model = prepare_model(&quot;arma_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; element2.model = prepare_model(&quot;arma_v1&quot;)</span>

<span class="sd">    We focus on class |TranslationDiffusionEquation| in the following.  First, we</span>
<span class="sd">    create two separate instances and use them to calculate the response coefficients</span>
<span class="sd">    of both |arma_v1| instances:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TranslationDiffusionEquation</span>
<span class="sd">    &gt;&gt;&gt; tde1 = TranslationDiffusionEquation(u=5.0, d=15.0, x=1.0)</span>
<span class="sd">    &gt;&gt;&gt; tde2 = TranslationDiffusionEquation(u=5.0, d=15.0, x=2.0)</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses(tde1.arma.coefs)</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.906536, -0.197555, 0.002128, 0.000276),</span>
<span class="sd">                      (0.842788, -0.631499, 0.061685, 0.015639, 0.0, 0.0, 0.0,</span>
<span class="sd">                       -0.000001, 0.0, 0.0, 0.0, 0.0)))</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses(tde2.arma.coefs)</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((1.298097, -0.536702, 0.072903, -0.001207, -0.00004),</span>
<span class="sd">                      (0.699212, -0.663835, 0.093935, 0.046177, -0.00854)))</span>

<span class="sd">    Next, we define one |ReplaceIUH| for modifying parameter</span>
<span class="sd">    |TranslationDiffusionEquation.u| and another one for changing</span>
<span class="sd">    |TranslationDiffusionEquation.d|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import ReplaceIUH</span>
<span class="sd">    &gt;&gt;&gt; u = ReplaceIUH(name=&quot;U&quot;,</span>
<span class="sd">    ...                target=&quot;u&quot;,</span>
<span class="sd">    ...                parameter=&quot;responses&quot;,</span>
<span class="sd">    ...                value=5.0,</span>
<span class="sd">    ...                lower=1.0,</span>
<span class="sd">    ...                upper=10.0,</span>
<span class="sd">    ...                selections=[complete])</span>
<span class="sd">    &gt;&gt;&gt; d = ReplaceIUH(name=&quot;D&quot;,</span>
<span class="sd">    ...                target=&quot;d&quot;,</span>
<span class="sd">    ...                parameter=&quot;responses&quot;,</span>
<span class="sd">    ...                value=15.0,</span>
<span class="sd">    ...                lower=5.0,</span>
<span class="sd">    ...                upper=50.0,</span>
<span class="sd">    ...                selections=[complete])</span>

<span class="sd">    We add and thereby connect the |Element| and |TranslationDiffusionEquation| objects</span>
<span class="sd">    to both |ReplaceIUH| objects via method |RuleIUH.add_iuhs|:</span>

<span class="sd">    &gt;&gt;&gt; u.add_iuhs(element1=tde1, element2=tde2)</span>
<span class="sd">    &gt;&gt;&gt; d.add_iuhs(element1=tde1, element2=tde2)</span>

<span class="sd">    Note that method |RuleIUH.add_iuhs| enforces to add all |IUH| objects at ones to</span>
<span class="sd">    avoid inconsistencies that might be hard to track later:</span>

<span class="sd">    &gt;&gt;&gt; d.add_iuhs(element1=tde1)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    RuntimeError: While trying to add `IUH` objects to the `ReplaceIUH` rule `D`, the \</span>
<span class="sd">following error occurred: The given elements (element1) do not agree with the \</span>
<span class="sd">complete set of relevant elements (element1 and element2).</span>

<span class="sd">    By default, each |ReplaceIUH| object triggers the calculation of the ARMA</span>
<span class="sd">    coefficients during the execution of its method |ReplaceIUH.apply_value|, which can</span>
<span class="sd">    be a waste of computation time if we want to calibrate multiple |IUH| coefficients.</span>
<span class="sd">    To save computation time in such cases, set option |RuleIUH.update_parameters|</span>
<span class="sd">    to |False| for all except the lastly executed |ReplaceIUH| objects:</span>

<span class="sd">    &gt;&gt;&gt; u.update_parameters = False</span>

<span class="sd">    Now, changing the value of rule `U` and calling method |ReplaceIUH.apply_value|</span>
<span class="sd">    does not affect the coefficients of both |arma_control.Responses| parameters:</span>

<span class="sd">    &gt;&gt;&gt; u.value = 10.0</span>
<span class="sd">    &gt;&gt;&gt; u.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; tde1</span>
<span class="sd">    TranslationDiffusionEquation(d=15.0, u=10.0, x=1.0)</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.906536, -0.197555, 0.002128, 0.000276),</span>
<span class="sd">                      (0.842788, -0.631499, 0.061685, 0.015639, 0.0, 0.0, 0.0,</span>
<span class="sd">                       -0.000001, 0.0, 0.0, 0.0, 0.0)))</span>
<span class="sd">    &gt;&gt;&gt; tde2</span>
<span class="sd">    TranslationDiffusionEquation(d=15.0, u=10.0, x=2.0)</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((1.298097, -0.536702, 0.072903, -0.001207, -0.00004),</span>
<span class="sd">                      (0.699212, -0.663835, 0.093935, 0.046177, -0.00854)))</span>

<span class="sd">    On the other side, calling method |ReplaceIUH.apply_value| of rule `D` does</span>
<span class="sd">    activate the freshly set value of rule `D` and the previously set value of rule</span>
<span class="sd">    `U`, as well:</span>

<span class="sd">    &gt;&gt;&gt; d.value = 50.0</span>
<span class="sd">    &gt;&gt;&gt; d.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; tde1</span>
<span class="sd">    TranslationDiffusionEquation(d=50.0, u=10.0, x=1.0)</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.811473, -0.15234, -0.000256, 0.000177),</span>
<span class="sd">                      (0.916619, -0.670781, 0.087185, 0.007923)))</span>
<span class="sd">    &gt;&gt;&gt; tde2</span>
<span class="sd">    TranslationDiffusionEquation(d=50.0, u=10.0, x=2.0)</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.832237, -0.167205, 0.002007, 0.000184),</span>
<span class="sd">                      (0.836513, -0.555399, 0.037628, 0.014035)))</span>

<span class="sd">    Use method |RuleIUH.reset_parameters| to restore the original ARMA coefficients:</span>

<span class="sd">    &gt;&gt;&gt; d.reset_parameters()</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.906536, -0.197555, 0.002128, 0.000276),</span>
<span class="sd">                      (0.842788, -0.631499, 0.061685, 0.015639, 0.0, 0.0, 0.0,</span>
<span class="sd">                       -0.000001, 0.0, 0.0, 0.0, 0.0)))</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((1.298097, -0.536702, 0.072903, -0.001207, -0.00004),</span>
<span class="sd">                      (0.699212, -0.663835, 0.093935, 0.046177, -0.00854)))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReplaceIUH.apply_value">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.ReplaceIUH.apply_value">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply all current calibration parameter values to all relevant |IUH| objects</span>
<span class="sd">        and eventually update the related parameter&#39;s ARMA coefficients.</span>

<span class="sd">        See the main documentation on class |ReplaceIUH| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">iuh</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iuhs</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">iuh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">:</span>
                <span class="n">parameter</span><span class="p">(</span><span class="n">iuh</span><span class="o">.</span><span class="n">arma</span><span class="o">.</span><span class="n">coefs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MultiplyIUH">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.MultiplyIUH">[docs]</a>
<span class="k">class</span> <span class="nc">MultiplyIUH</span><span class="p">(</span><span class="n">RuleIUH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A |RuleIUH| class for replacing |IUH| parameter values with the current</span>
<span class="sd">    calibration parameter values, applied on the original |IUH| values as factors.</span>

<span class="sd">    Please read the documentation on class |ReplaceIUH| first, from which we take the</span>
<span class="sd">    following test configuration:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import Element, prepare_model, Selection</span>
<span class="sd">    &gt;&gt;&gt; element1 = Element(&quot;element1&quot;, inlets=&quot;in1&quot;, outlets=&quot;out1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; element2 = Element(&quot;element2&quot;, inlets=&quot;in2&quot;, outlets=&quot;out2&quot;)</span>
<span class="sd">    &gt;&gt;&gt; complete = Selection(&quot;complete&quot;, elements=[element1, element2])</span>
<span class="sd">    &gt;&gt;&gt; element1.model = prepare_model(&quot;arma_v1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; element2.model = prepare_model(&quot;arma_v1&quot;)</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TranslationDiffusionEquation</span>
<span class="sd">    &gt;&gt;&gt; tde1 = TranslationDiffusionEquation(u=5.0, d=15.0, x=1.0)</span>
<span class="sd">    &gt;&gt;&gt; tde2 = TranslationDiffusionEquation(u=5.0, d=15.0, x=2.0)</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses(tde1.arma.coefs)</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.906536, -0.197555, 0.002128, 0.000276),</span>
<span class="sd">                      (0.842788, -0.631499, 0.061685, 0.015639, 0.0, 0.0, 0.0,</span>
<span class="sd">                       -0.000001, 0.0, 0.0, 0.0, 0.0)))</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses(tde2.arma.coefs)</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((1.298097, -0.536702, 0.072903, -0.001207, -0.00004),</span>
<span class="sd">                      (0.699212, -0.663835, 0.093935, 0.046177, -0.00854)))</span>

<span class="sd">    Initialising |MultiplyIUH| works exactly as for |ReplaceIUH|, except for the</span>
<span class="sd">    semantic difference that `value`, `lower`, and `upper` now represent factors:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import MultiplyIUH</span>
<span class="sd">    &gt;&gt;&gt; u = MultiplyIUH(name=&quot;U&quot;,</span>
<span class="sd">    ...                 target=&quot;u&quot;,</span>
<span class="sd">    ...                 parameter=&quot;responses&quot;,</span>
<span class="sd">    ...                 value=2.0,</span>
<span class="sd">    ...                 lower=1.0,</span>
<span class="sd">    ...                 upper=4.0,</span>
<span class="sd">    ...                 selections=[complete])</span>
<span class="sd">    &gt;&gt;&gt; d = MultiplyIUH(name=&quot;D&quot;,</span>
<span class="sd">    ...                 target=&quot;d&quot;,</span>
<span class="sd">    ...                 parameter=&quot;responses&quot;,</span>
<span class="sd">    ...                 value=0.5,</span>
<span class="sd">    ...                 lower=0.2,</span>
<span class="sd">    ...                 upper=2.0,</span>
<span class="sd">    ...                 selections=[complete])</span>

<span class="sd">    &gt;&gt;&gt; u.add_iuhs(element1=tde1, element2=tde2)</span>
<span class="sd">    &gt;&gt;&gt; d.add_iuhs(element1=tde1, element2=tde2)</span>
<span class="sd">    &gt;&gt;&gt; u.update_parameters = False</span>

<span class="sd">    The following examples demonstrate that the current calibration values actually</span>
<span class="sd">    as factors, applied to the original  values of the relevant |IUH| properties:</span>

<span class="sd">    &gt;&gt;&gt; u.value = 3.0</span>
<span class="sd">    &gt;&gt;&gt; u.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; d.value = 1.0/3.0</span>
<span class="sd">    &gt;&gt;&gt; d.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; tde1</span>
<span class="sd">    TranslationDiffusionEquation(d=5.0, u=15.0, x=1.0)</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.0, 0.0),</span>
<span class="sd">                      (0.933333, 0.066667)))</span>
<span class="sd">    &gt;&gt;&gt; tde2</span>
<span class="sd">    TranslationDiffusionEquation(d=5.0, u=15.0, x=2.0)</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.0, 0.0),</span>
<span class="sd">                      (0.866667, 0.133333)))</span>

<span class="sd">    &gt;&gt;&gt; u.value = 1.0</span>
<span class="sd">    &gt;&gt;&gt; u.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; d.value = 1.0</span>
<span class="sd">    &gt;&gt;&gt; d.apply_value()</span>
<span class="sd">    &gt;&gt;&gt; tde1</span>
<span class="sd">    TranslationDiffusionEquation(d=15.0, u=5.0, x=1.0)</span>
<span class="sd">    &gt;&gt;&gt; element1.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((0.906536, -0.197555, 0.002128, 0.000276),</span>
<span class="sd">                      (0.842788, -0.631499, 0.061685, 0.015639, 0.0, 0.0, 0.0,</span>
<span class="sd">                       -0.000001, 0.0, 0.0, 0.0, 0.0)))</span>
<span class="sd">    &gt;&gt;&gt; tde2</span>
<span class="sd">    TranslationDiffusionEquation(d=15.0, u=5.0, x=2.0)</span>
<span class="sd">    &gt;&gt;&gt; element2.model.parameters.control.responses</span>
<span class="sd">    responses(th_0_0=((1.298097, -0.536702, 0.072903, -0.001207, -0.00004),</span>
<span class="sd">                      (0.699212, -0.663835, 0.093935, 0.046177, -0.00854)))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_original_iuh_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>

<div class="viewcode-block" id="MultiplyIUH.add_iuhs">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.MultiplyIUH.add_iuhs">[docs]</a>
    <span class="k">def</span> <span class="nf">add_iuhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">iuhs</span><span class="p">:</span> <span class="n">iuhtools</span><span class="o">.</span><span class="n">IUH</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add one |IUH| object for each relevant |Element| object.</span>

<span class="sd">        See the main documentation on class |ReplaceIUH| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_iuhs</span><span class="p">(</span><span class="o">**</span><span class="n">iuhs</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="n">original_iuh_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element2iuh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># ensured by `RuleIUH.add_iuhs`</span>
        <span class="k">for</span> <span class="n">iuh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element2iuh</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">original_iuh_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">iuh</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_iuh_values</span> <span class="o">=</span> <span class="n">original_iuh_values</span></div>


<div class="viewcode-block" id="MultiplyIUH.apply_value">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.MultiplyIUH.apply_value">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply all current calibration parameter values to all relevant |IUH| objects</span>
<span class="sd">        and eventually update the related parameter&#39;s ARMA coefficients.</span>

<span class="sd">        See the main documentation on class |MultiplyIUH| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">iuh</span><span class="p">,</span> <span class="n">orig</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iuhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_iuh_values</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">iuh</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">orig</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">:</span>
                <span class="n">parameter</span><span class="p">(</span><span class="n">iuh</span><span class="o">.</span><span class="n">arma</span><span class="o">.</span><span class="n">coefs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CalibSpec">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibSpec">[docs]</a>
<span class="k">class</span> <span class="nc">CalibSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class for specifying the properties of a single calibration parameter.</span>

<span class="sd">    So far, class |CalibSpec| does not provide much functionality besides checking upon</span>
<span class="sd">    initialisation that the given default and boundary values are consistent:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import CalibSpec</span>
<span class="sd">    &gt;&gt;&gt; CalibSpec(name=&quot;par1&quot;, default=1.0)</span>
<span class="sd">    CalibSpec(name=&quot;par1&quot;, default=1.0)</span>

<span class="sd">    &gt;&gt;&gt; CalibSpec(name=&quot;par1&quot;, default=1.0, keyword=&quot;key1&quot;)</span>
<span class="sd">    CalibSpec(name=&quot;par1&quot;, default=1.0, keyword=&quot;key1&quot;)</span>

<span class="sd">    &gt;&gt;&gt; CalibSpec(name=&quot;par1&quot;, default=1.0, lower=2.0)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: The following values given for calibration parameter `par1` are not \</span>
<span class="sd">consistent: default=1.0, lower=2.0, upper=inf.</span>

<span class="sd">    &gt;&gt;&gt; CalibSpec(name=&quot;par1&quot;, default=1.0, upper=0.5)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: The following values given for calibration parameter `par1` are not \</span>
<span class="sd">consistent: default=1.0, lower=-inf, upper=0.5.</span>

<span class="sd">    &gt;&gt;&gt; CalibSpec(name=&quot;par1&quot;, default=1.0, lower=0.0, upper=2.0)</span>
<span class="sd">    CalibSpec(name=&quot;par1&quot;, default=1.0, lower=0.0, upper=2.0)</span>

<span class="sd">    Use the `parameterstep` argument for time-dependent calibration parameters:</span>

<span class="sd">    &gt;&gt;&gt; CalibSpec(name=&quot;par1&quot;, default=1.0/3.0, lower=1.0/3.0, upper=1.0/3.0,</span>
<span class="sd">    ...           parameterstep=&quot;1d&quot;)</span>
<span class="sd">    CalibSpec(</span>
<span class="sd">        name=&quot;par1&quot;, default=0.333333, lower=0.333333, upper=0.333333, \</span>
<span class="sd">parameterstep=&quot;1d&quot;</span>
<span class="sd">    )</span>

<span class="sd">    See the documentation on class |CalibSpecs| for further information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of the calibration parameter.&quot;&quot;&quot;</span>
    <span class="n">default</span><span class="p">:</span> <span class="nb">float</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The default value of the calibration parameter.&quot;&quot;&quot;</span>
    <span class="n">keyword</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The (optional) target keyword of the calibration parameter.&quot;&quot;&quot;</span>
    <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lower bound of the allowed calibration parameter value.&quot;&quot;&quot;</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Upper bound of the allowed calibration parameter value.&quot;&quot;&quot;</span>
    <span class="n">parameterstep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The parameter step size to be set before applying the defined calibration </span>
<span class="sd">    parameter values.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">keyword</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">parameterstep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">PeriodConstrArg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">default</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The following values given for calibration parameter `</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">` are &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not consistent: default=</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="si">}</span><span class="s2">, lower=&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span><span class="si">}</span><span class="s2">, upper=</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="o">=</span> <span class="n">keyword</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="k">if</span> <span class="n">parameterstep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span> <span class="o">=</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="n">parameterstep</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;name=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;default=</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;keyword=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lower=</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">):</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;upper=</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;parameterstep=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterstep</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">black</span><span class="o">.</span><span class="n">format_str</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">black</span><span class="o">.</span><span class="n">FileMode</span><span class="p">(),</span>
        <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>



<div class="viewcode-block" id="CalibSpecs">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibSpecs">[docs]</a>
<span class="k">class</span> <span class="nc">CalibSpecs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collection class for handling |CalibSpec| objects.</span>

<span class="sd">    The primary purpose of class |CalibSpecs| is to handle multiple |CalibSpec| objects</span>
<span class="sd">    and to make all their attributes accessible in the same order. See property</span>
<span class="sd">    |CalibSpecs.names| as one example.  Note that all such properties are sorted in the</span>
<span class="sd">    order or the attachment of the different |CalibSpec| objects:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">    &gt;&gt;&gt; calibspecs = CalibSpecs(</span>
<span class="sd">    ...     CalibSpec(</span>
<span class="sd">    ...         name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, parameterstep=&quot;1d&quot;</span>
<span class="sd">    ...     ),</span>
<span class="sd">    ...     CalibSpec(name=&quot;second&quot;, default=1.0, keyword=&quot;kw2&quot;, lower=0.0),</span>
<span class="sd">    ...     CalibSpec(name=&quot;first&quot;,default=2.0, upper=2.0))</span>
<span class="sd">    &gt;&gt;&gt; calibspecs</span>
<span class="sd">    CalibSpecs(</span>
<span class="sd">        CalibSpec(name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, \</span>
<span class="sd">parameterstep=&quot;1d&quot;),</span>
<span class="sd">        CalibSpec(name=&quot;second&quot;, default=1.0, keyword=&quot;kw2&quot;, lower=0.0),</span>
<span class="sd">        CalibSpec(name=&quot;first&quot;, default=2.0, upper=2.0),</span>
<span class="sd">    )</span>

<span class="sd">    You can query and remove |CalibSpec| objects via keyword and attribute access:</span>

<span class="sd">    &gt;&gt;&gt; print(calibspecs)</span>
<span class="sd">    CalibSpecs(&quot;third&quot;, &quot;second&quot;, &quot;first&quot;)</span>

<span class="sd">    &gt;&gt;&gt; third = calibspecs[&quot;third&quot;]</span>
<span class="sd">    &gt;&gt;&gt; third in calibspecs</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; del calibspecs[&quot;third&quot;]</span>
<span class="sd">    &gt;&gt;&gt; third in calibspecs</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; calibspecs[&quot;third&quot;]</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    KeyError: &#39;The current `CalibSpecs` object does not handle a `CalibSpec` object \</span>
<span class="sd">named `third`.&#39;</span>
<span class="sd">    &gt;&gt;&gt; del calibspecs[&quot;third&quot;]</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    KeyError: &#39;The current `CalibSpecs` object does not handle a `CalibSpec` object \</span>
<span class="sd">named `third`.&#39;</span>

<span class="sd">    &gt;&gt;&gt; second = calibspecs.second</span>
<span class="sd">    &gt;&gt;&gt; &quot;second&quot; in calibspecs</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; del calibspecs.second</span>
<span class="sd">    &gt;&gt;&gt; &quot;second&quot; in calibspecs</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; calibspecs.second</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    AttributeError: The current `CalibSpecs` object does neither handle a `CalibSpec` \</span>
<span class="sd">object nor a normal attribute named `second`.</span>
<span class="sd">    &gt;&gt;&gt; del calibspecs.second</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    AttributeError: The current `CalibSpecs` object does not handle a `CalibSpec` \</span>
<span class="sd">object named `second`.</span>

<span class="sd">    &gt;&gt;&gt; len(calibspecs)</span>
<span class="sd">    1</span>

<span class="sd">    Now we can re-append the previously removed |CalibSpec| objects (and thereby bring</span>
<span class="sd">    the order of attachment in agreement with the |CalibSpec| names):</span>

<span class="sd">    &gt;&gt;&gt; calibspecs.append(second, third)</span>
<span class="sd">    &gt;&gt;&gt; for calibspec in calibspecs:</span>
<span class="sd">    ...     print(calibspec)</span>
<span class="sd">    first</span>
<span class="sd">    second</span>
<span class="sd">    third</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_name2parspec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CalibSpec</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">parspecs</span><span class="p">:</span> <span class="n">CalibSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span> <span class="o">=</span> <span class="p">{</span><span class="n">parspec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">parspec</span> <span class="k">for</span> <span class="n">parspec</span> <span class="ow">in</span> <span class="n">parspecs</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CalibSpec</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The current `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` object does not handle a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`CalibSpec` object named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The current `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` object does not handle a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`CalibSpec` object named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CalibSpec</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The current `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` object does neither handle a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`CalibSpec` object nor a normal attribute named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The current `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` object does not handle a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`CalibSpec` object named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CalibSpec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CalibSpec</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">value</span>

<div class="viewcode-block" id="CalibSpecs.append">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.CalibSpecs.append">[docs]</a>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">calibspecs</span><span class="p">:</span> <span class="n">CalibSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append one or more |CalibSpec| objects.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">        &gt;&gt;&gt; third = CalibSpec(</span>
<span class="sd">        ...     name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, parameterstep=&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; first = CalibSpec(name=&quot;first&quot;, default=1.0, lower=0.0)</span>
<span class="sd">        &gt;&gt;&gt; second = CalibSpec(name=&quot;second&quot;,default=2.0, keyword=&quot;kw2&quot;, upper=2.0)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs()</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.append(first)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.append(second, third)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs</span>
<span class="sd">        CalibSpecs(</span>
<span class="sd">            CalibSpec(name=&quot;first&quot;, default=1.0, lower=0.0),</span>
<span class="sd">            CalibSpec(name=&quot;second&quot;, default=2.0, keyword=&quot;kw2&quot;, upper=2.0),</span>
<span class="sd">            CalibSpec(name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, \</span>
<span class="sd">parameterstep=&quot;1d&quot;),</span>
<span class="sd">        )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">calibspec</span> <span class="ow">in</span> <span class="n">calibspecs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="p">[</span><span class="n">calibspec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibspec</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The names of all |CalibSpec| objects in the order of attachment.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">        &gt;&gt;&gt; third = CalibSpec(</span>
<span class="sd">        ...     name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, parameterstep=&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs(CalibSpec(name=&quot;first&quot;, default=1.0, lower=0.0),</span>
<span class="sd">        ...                         CalibSpec(name=&quot;second&quot;,default=2.0, upper=2.0))</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.append(third)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.names</span>
<span class="sd">        (&#39;first&#39;, &#39;second&#39;, &#39;third&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parspec</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">parspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The default values of all |CalibSpec| objects in the order of attachment.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">        &gt;&gt;&gt; third = CalibSpec(</span>
<span class="sd">        ...     name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, parameterstep=&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs(</span>
<span class="sd">        ...     CalibSpec(name=&quot;first&quot;, default=1.0, lower=0.0),</span>
<span class="sd">        ...     CalibSpec(name=&quot;second&quot;, default=2.0, keyword=&quot;kw2&quot;, upper=2.0))</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.append(third)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.defaults</span>
<span class="sd">        (1.0, 2.0, 3.0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parspec</span><span class="o">.</span><span class="n">default</span> <span class="k">for</span> <span class="n">parspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The (optional) target keywords of all |CalibSpec| objects in the order of</span>
<span class="sd">        attachment.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">        &gt;&gt;&gt; third = CalibSpec(</span>
<span class="sd">        ...     name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, parameterstep=&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs(</span>
<span class="sd">        ...     CalibSpec(name=&quot;first&quot;, default=1.0, lower=0.0),</span>
<span class="sd">        ...     CalibSpec(name=&quot;second&quot;, default=2.0, keyword=&quot;kw2&quot;, upper=2.0))</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.append(third)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.keywords</span>
<span class="sd">        (None, &#39;kw2&#39;, None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parspec</span><span class="o">.</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">parspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lowers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The lower boundary values of all |CalibSpec| objects in the order of</span>
<span class="sd">        attachment.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">        &gt;&gt;&gt; third = CalibSpec(</span>
<span class="sd">        ...     name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, parameterstep=&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs(</span>
<span class="sd">        ...     CalibSpec(name=&quot;first&quot;, default=1.0, lower=0.0),</span>
<span class="sd">        ...     CalibSpec(name=&quot;second&quot;, default=2.0, keyword=&quot;kw2&quot;, upper=2.0))</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.append(third)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.lowers</span>
<span class="sd">        (0.0, -inf, -10.0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parspec</span><span class="o">.</span><span class="n">lower</span> <span class="k">for</span> <span class="n">parspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uppers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The upper boundary values of all |CalibSpec| objects in the order of</span>
<span class="sd">        attachment.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">        &gt;&gt;&gt; third = CalibSpec(</span>
<span class="sd">        ...     name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, parameterstep=&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs(</span>
<span class="sd">        ...     CalibSpec(name=&quot;first&quot;, default=1.0, lower=0.0),</span>
<span class="sd">        ...     CalibSpec(name=&quot;second&quot;, default=2.0, keyword=&quot;kw2&quot;, upper=2.0))</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.append(third)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.uppers</span>
<span class="sd">        (inf, 2.0, 10.0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parspec</span><span class="o">.</span><span class="n">upper</span> <span class="k">for</span> <span class="n">parspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parametersteps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The parameter steps of all |CalibSpec| objects in the order of attachment.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">        &gt;&gt;&gt; third = CalibSpec(</span>
<span class="sd">        ...     name=&quot;third&quot;, default=3.0, lower=-10.0, upper=10.0, parameterstep=&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs(</span>
<span class="sd">        ...     CalibSpec(name=&quot;first&quot;, default=1.0, lower=0.0),</span>
<span class="sd">        ...     CalibSpec(name=&quot;second&quot;, default=2.0, keyword=&quot;kw2&quot;, upper=2.0))</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.append(third)</span>
<span class="sd">        &gt;&gt;&gt; calibspecs.parametersteps</span>
<span class="sd">        (None, None, Period(&quot;1d&quot;))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parspec</span><span class="o">.</span><span class="n">parameterstep</span> <span class="k">for</span> <span class="n">parspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">black</span><span class="o">.</span><span class="n">format_str</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">black</span><span class="o">.</span><span class="n">FileMode</span><span class="p">(),</span>
        <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2parspec</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">black</span><span class="o">.</span><span class="n">format_str</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">black</span><span class="o">.</span><span class="n">FileMode</span><span class="p">(),</span>
        <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs, print_values</span>
<span class="sd">        &gt;&gt;&gt; calibspecs = CalibSpecs(CalibSpec(name=&quot;first&quot;, default=1.0),</span>
<span class="sd">        ...                         CalibSpec(name=&quot;second&quot;,default=2.0))</span>
<span class="sd">        &gt;&gt;&gt; sorted(set(dir(calibspecs)) - set(object.__dir__(calibspecs)))</span>
<span class="sd">        [&#39;first&#39;, &#39;second&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">)</span></div>



<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">make_rules</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rule</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">],</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">lowers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">uppers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">parametersteps</span><span class="p">:</span> <span class="n">Sequence1</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">PeriodConstrArg</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">selections</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">make_rules</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rule</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">],</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">keywords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lowers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">uppers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">parametersteps</span><span class="p">:</span> <span class="n">Sequence1</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">PeriodConstrArg</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">selections</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">selectiontools</span><span class="o">.</span><span class="n">Selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="n">product</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">make_rules</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rule</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">],</span>
    <span class="n">calibspecs</span><span class="p">:</span> <span class="n">CalibSpecs</span><span class="p">,</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keywords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lowers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">uppers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">selections</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">make_rules</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rule</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">],</span>
    <span class="n">calibspecs</span><span class="p">:</span> <span class="n">CalibSpecs</span><span class="p">,</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keywords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lowers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">uppers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">selections</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">selectiontools</span><span class="o">.</span><span class="n">Selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="n">product</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">]:</span>
    <span class="o">...</span>


<div class="viewcode-block" id="make_rules">
<a class="viewcode-back" href="../../../calibtools.html#hydpy.auxs.calibtools.make_rules">[docs]</a>
<span class="k">def</span> <span class="nf">make_rules</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rule</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">],</span>
    <span class="n">calibspecs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CalibSpecs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keywords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lowers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">uppers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parametersteps</span><span class="p">:</span> <span class="n">Sequence1</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">timetools</span><span class="o">.</span><span class="n">PeriodConstrArg</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">selections</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">selectiontools</span><span class="o">.</span><span class="n">Selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">product</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TypeRule</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Conveniently create multiple |Rule| objects at once.</span>

<span class="sd">    Please see the main documentation on class |CalibrationInterface| first, from</span>
<span class="sd">    which we borrow the general setup:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import CalibrationInterface, make_rules, nse</span>
<span class="sd">    &gt;&gt;&gt; ci = CalibrationInterface(</span>
<span class="sd">    ...     hp=hp,</span>
<span class="sd">    ...     targetfunction=lambda: sum(nse(node=node) for node in hp.nodes))</span>

<span class="sd">    Here, we show only the supplemental features of function |make_rules| in some</span>
<span class="sd">    brevity.</span>

<span class="sd">    Function |make_rules| checks that all given sequences have the same length:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import Replace</span>
<span class="sd">    &gt;&gt;&gt; make_rules(rule=Replace,</span>
<span class="sd">    ...            names=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">    ...            parameters=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">    ...            values=[100.0, 5.0],</span>
<span class="sd">    ...            keywords=[&quot;forest&quot;, None],</span>
<span class="sd">    ...            lowers=[50.0, 1.0],</span>
<span class="sd">    ...            uppers=[200.0],</span>
<span class="sd">    ...            parametersteps=&quot;1d&quot;,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: When creating rules via function `make_rules`, all given sequences \</span>
<span class="sd">must be of equal length.</span>

<span class="sd">    The separate handling of the specifications of all calibration parameters is</span>
<span class="sd">    error-prone.  You can bundle all specifications within a |CalibSpecs| object</span>
<span class="sd">    instead and pass them at once for more safety and convenience:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import CalibSpec, CalibSpecs</span>
<span class="sd">    &gt;&gt;&gt; calibspecs = CalibSpecs(</span>
<span class="sd">    ...     CalibSpec(name=&quot;fc&quot;, default=100.0, keyword=&quot;forest&quot;, lower=50.0, \</span>
<span class="sd">upper=200.0),</span>
<span class="sd">    ...     CalibSpec(name=&quot;percmax&quot;, default=5.0, lower=1.0, upper=10.0, \</span>
<span class="sd">parameterstep=&quot;1d&quot;))</span>
<span class="sd">    &gt;&gt;&gt; make_rules(rule=Replace,</span>
<span class="sd">    ...            calibspecs=calibspecs,</span>
<span class="sd">    ...            parametersteps=&quot;1d&quot;,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;)[1]</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;percmax&quot;,</span>
<span class="sd">        parameter=&quot;percmax&quot;,</span>
<span class="sd">        value=5.0,</span>
<span class="sd">        lower=1.0,</span>
<span class="sd">        upper=10.0,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=&quot;1d&quot;,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>

<span class="sd">    You are free also to use the individual arguments (e.g. `names`) to override the</span>
<span class="sd">    related specifications defined by the |CalibSpecs| object:</span>

<span class="sd">    &gt;&gt;&gt; make_rules(rule=Replace,</span>
<span class="sd">    ...            calibspecs=calibspecs,</span>
<span class="sd">    ...            names=[name.upper() for name in calibspecs.names],</span>
<span class="sd">    ...            parametersteps=&quot;1d&quot;,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;)[1]</span>
<span class="sd">    Replace(</span>
<span class="sd">        name=&quot;PERCMAX&quot;,</span>
<span class="sd">        parameter=&quot;percmax&quot;,</span>
<span class="sd">        value=5.0,</span>
<span class="sd">        lower=1.0,</span>
<span class="sd">        upper=10.0,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=&quot;1d&quot;,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;complete&quot;,),</span>
<span class="sd">    )</span>

<span class="sd">    Function |make_rules| raises the following error if you neither pass a |CalibSpecs|</span>
<span class="sd">    object nor the complete list of individual calibration parameter specifications:</span>

<span class="sd">    &gt;&gt;&gt; make_rules(rule=Replace,</span>
<span class="sd">    ...            names=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">    ...            parameters=[&quot;fc&quot;, &quot;percmax&quot;],</span>
<span class="sd">    ...            values=[100.0, 5.0],</span>
<span class="sd">    ...            keywords=[&quot;forest&quot;, None],</span>
<span class="sd">    ...            lowers=[50.0, 1.0],</span>
<span class="sd">    ...            parametersteps=&quot;1d&quot;,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    TypeError: When creating rules via function `make_rules`, you must pass a \</span>
<span class="sd">`CalibSpecs` object or provide complete information for the following arguments: \</span>
<span class="sd">names, parameters, values, keywords, lowers, and uppers.</span>

<span class="sd">    You can run function |make_rules| in &quot;product mode&quot;, meaning that its execution</span>
<span class="sd">    results in distinct |Rule| objects for all combinations of the given calibration</span>
<span class="sd">    parameters and selections:</span>

<span class="sd">    &gt;&gt;&gt; make_rules(rule=Replace,</span>
<span class="sd">    ...            calibspecs=calibspecs,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;,</span>
<span class="sd">    ...            selections=(&quot;headwaters&quot;, &quot;nonheadwaters&quot;),</span>
<span class="sd">    ...            product=True)</span>
<span class="sd">    [Replace(</span>
<span class="sd">        name=&quot;fc_headwaters&quot;,</span>
<span class="sd">        parameter=&quot;fc&quot;,</span>
<span class="sd">        value=100.0,</span>
<span class="sd">        lower=50.0,</span>
<span class="sd">        upper=200.0,</span>
<span class="sd">        keyword=&quot;forest&quot;,</span>
<span class="sd">        parameterstep=None,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;headwaters&quot;,),</span>
<span class="sd">    ), Replace(</span>
<span class="sd">        name=&quot;percmax_headwaters&quot;,</span>
<span class="sd">        parameter=&quot;percmax&quot;,</span>
<span class="sd">        value=5.0,</span>
<span class="sd">        lower=1.0,</span>
<span class="sd">        upper=10.0,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=&quot;1d&quot;,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;headwaters&quot;,),</span>
<span class="sd">    ), Replace(</span>
<span class="sd">        name=&quot;fc_nonheadwaters&quot;,</span>
<span class="sd">        parameter=&quot;fc&quot;,</span>
<span class="sd">        value=100.0,</span>
<span class="sd">        lower=50.0,</span>
<span class="sd">        upper=200.0,</span>
<span class="sd">        keyword=&quot;forest&quot;,</span>
<span class="sd">        parameterstep=None,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;nonheadwaters&quot;,),</span>
<span class="sd">    ), Replace(</span>
<span class="sd">        name=&quot;percmax_nonheadwaters&quot;,</span>
<span class="sd">        parameter=&quot;percmax&quot;,</span>
<span class="sd">        value=5.0,</span>
<span class="sd">        lower=1.0,</span>
<span class="sd">        upper=10.0,</span>
<span class="sd">        keyword=None,</span>
<span class="sd">        parameterstep=&quot;1d&quot;,</span>
<span class="sd">        model=&quot;hland_v1&quot;,</span>
<span class="sd">        selections=(&quot;nonheadwaters&quot;,),</span>
<span class="sd">    )]</span>

<span class="sd">    Trying to run in &quot;product mode&quot; without defining the target selections results in</span>
<span class="sd">    the following error message:</span>

<span class="sd">    &gt;&gt;&gt; make_rules(rule=Replace,</span>
<span class="sd">    ...            calibspecs=calibspecs,</span>
<span class="sd">    ...            parametersteps=&quot;1d&quot;,</span>
<span class="sd">    ...            model=&quot;hland_v1&quot;,</span>
<span class="sd">    ...            product=True)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    TypeError: When creating rules via function `make_rules` in &quot;product mode&quot; (with \</span>
<span class="sd">the argument `product` being `True`), you must supply all target selection objects \</span>
<span class="sd">via argument `selections`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calibspecs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># pylint: disable=too-many-boolean-expressions</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">keywords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">lowers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">uppers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;When creating rules via function `make_rules`, you must pass a &quot;</span>
                <span class="s2">&quot;`CalibSpecs` object or provide complete information for the &quot;</span>
                <span class="s2">&quot;following arguments: names, parameters, values, keywords, lowers, &quot;</span>
                <span class="s2">&quot;and uppers.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">calibspecs</span><span class="o">.</span><span class="n">names</span>
        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">calibspecs</span><span class="o">.</span><span class="n">names</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">calibspecs</span><span class="o">.</span><span class="n">defaults</span>
        <span class="k">if</span> <span class="n">keywords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="n">calibspecs</span><span class="o">.</span><span class="n">keywords</span>
        <span class="k">if</span> <span class="n">lowers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lowers</span> <span class="o">=</span> <span class="n">calibspecs</span><span class="o">.</span><span class="n">lowers</span>
        <span class="k">if</span> <span class="n">uppers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">uppers</span> <span class="o">=</span> <span class="n">calibspecs</span><span class="o">.</span><span class="n">uppers</span>
        <span class="k">if</span> <span class="n">parametersteps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parametersteps</span> <span class="o">=</span> <span class="n">calibspecs</span><span class="o">.</span><span class="n">parametersteps</span>
    <span class="n">parameters_</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="n">objecttools</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">types_</span><span class="o">=</span><span class="p">(</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parametersteps</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parametersteps</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
        <span class="n">parametersteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">parametersteps</span><span class="p">,)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters_</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lowers</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uppers</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">parametersteps</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;When creating rules via function `make_rules`, all given sequences must &quot;</span>
            <span class="s2">&quot;be of equal length.&quot;</span>
        <span class="p">)</span>
    <span class="n">nmb_parameters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters_</span><span class="p">)</span>
    <span class="n">selections2</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">selectiontools</span><span class="o">.</span><span class="n">Selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">selections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;When creating rules via function `make_rules` in &quot;product mode&quot; &#39;</span>
                <span class="s2">&quot;(with the argument `product` being `True`), you must supply all &quot;</span>
                <span class="s2">&quot;target selection objects via argument `selections`.&quot;</span>
            <span class="p">)</span>
        <span class="n">selections</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">par</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sel</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">sel</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">selections</span><span class="p">,</span> <span class="n">parameters_</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">nmb_selections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span>
        <span class="n">parameters_</span> <span class="o">=</span> <span class="n">nmb_selections</span> <span class="o">*</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parameters_</span><span class="p">)</span>
        <span class="n">lowers</span> <span class="o">=</span> <span class="n">nmb_selections</span> <span class="o">*</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lowers</span><span class="p">)</span>
        <span class="n">uppers</span> <span class="o">=</span> <span class="n">nmb_selections</span> <span class="o">*</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">uppers</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">nmb_selections</span> <span class="o">*</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">nmb_selections</span> <span class="o">*</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
        <span class="n">parametersteps</span> <span class="o">=</span> <span class="n">nmb_selections</span> <span class="o">*</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parametersteps</span><span class="p">)</span>
        <span class="n">selections2</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="n">sel</span><span class="p">,),</span> <span class="n">nmb_parameters</span><span class="p">)</span> <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">selections</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selections2</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">selections</span><span class="p">,</span> <span class="n">nmb_parameters</span><span class="p">)</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">parameter</span><span class="p">,</span>
        <span class="n">lower</span><span class="p">,</span>
        <span class="n">upper</span><span class="p">,</span>
        <span class="n">value</span><span class="p">,</span>
        <span class="n">keyword</span><span class="p">,</span>
        <span class="n">parameterstep</span><span class="p">,</span>
        <span class="n">selections_</span><span class="p">,</span>
    <span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">names</span><span class="p">,</span>
        <span class="n">parameters_</span><span class="p">,</span>
        <span class="n">lowers</span><span class="p">,</span>
        <span class="n">uppers</span><span class="p">,</span>
        <span class="n">values</span><span class="p">,</span>
        <span class="n">keywords</span><span class="p">,</span>
        <span class="n">parametersteps</span><span class="p">,</span>
        <span class="n">selections2</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">rule</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">parameter</span><span class="o">=</span><span class="n">parameter</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">keyword</span><span class="o">=</span><span class="n">keyword</span><span class="p">,</span>
                <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span>
                <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span>
                <span class="n">parameterstep</span><span class="o">=</span><span class="n">parameterstep</span><span class="p">,</span>
                <span class="n">selections</span><span class="o">=</span><span class="n">selections_</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">rules</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 5.0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.auxs.calibtools</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2023, HydPy Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>