<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydpy.core.itemtools &#8212; HydPy 5.0.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=127cebf3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    
    <script src="../../../_static/documentation_options.js?v=f98c4cc8"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 5.0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.core.itemtools</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/HydPy_Logo.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="../../../index.html">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to.html">How toâ€¦</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework.html">Framework Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modelcollection.html">Model Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zbibliography.html">Bibliography</a></li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hydpy.core.itemtools</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;This module implements so-called exchange items, simplifying modifying the values of</span>
<span class="sd">|Parameter| and |Sequence_| objects.&quot;&quot;&quot;</span>
<span class="c1"># import...</span>
<span class="c1"># ...from standard library</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># ...from site-packages</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># ...from HydPy</span>
<span class="kn">import</span> <span class="nn">hydpy</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">devicetools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">exceptiontools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">objecttools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">parametertools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">selectiontools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">sequencetools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">variabletools</span>
<span class="kn">from</span> <span class="nn">hydpy.core.typingtools</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">Device2Target</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span>
    <span class="n">Union</span><span class="p">[</span><span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span>
<span class="p">]</span>
<span class="n">Selection2Targets</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
<span class="n">LevelType</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;selection&quot;</span><span class="p">,</span> <span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="s2">&quot;subunit&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="ExchangeSpecification">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.ExchangeSpecification">[docs]</a>
<span class="k">class</span> <span class="nc">ExchangeSpecification</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Specification of a concrete |Parameter| or |Sequence_| type.</span>

<span class="sd">    |ExchangeSpecification| is a helper class for |ExchangeItem| and its subclasses.</span>
<span class="sd">    Its constructor interprets two strings and one optional string (without any</span>
<span class="sd">    plausibility checks) and makes their information available as attributes.  The</span>
<span class="sd">    following tests list the expected cases:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.itemtools import ExchangeSpecification</span>
<span class="sd">    &gt;&gt;&gt; ExchangeSpecification(&quot;musk_classic&quot;, &quot;control.nmbsequences&quot;, &quot;lag&quot;)</span>
<span class="sd">    ExchangeSpecification(&quot;musk_classic&quot;, &quot;control.nmbsequences&quot;, &quot;lag&quot;)</span>
<span class="sd">    &gt;&gt;&gt; ExchangeSpecification(&quot;hland_v1&quot;, &quot;fluxes.qt&quot;, None)</span>
<span class="sd">    ExchangeSpecification(&quot;hland_v1&quot;, &quot;fluxes.qt&quot;, None)</span>
<span class="sd">    &gt;&gt;&gt; ExchangeSpecification(&quot;hland_v1&quot;, &quot;fluxes.qt.series&quot;, None)</span>
<span class="sd">    ExchangeSpecification(&quot;hland_v1&quot;, &quot;fluxes.qt.series&quot;, None)</span>
<span class="sd">    &gt;&gt;&gt; ExchangeSpecification(&quot;node&quot;, &quot;sim&quot;, None)</span>
<span class="sd">    ExchangeSpecification(&quot;node&quot;, &quot;sim&quot;, None)</span>
<span class="sd">    &gt;&gt;&gt; ExchangeSpecification(&quot;node&quot;, &quot;sim.series&quot;, None)</span>
<span class="sd">    ExchangeSpecification(&quot;node&quot;, &quot;sim.series&quot;, None)</span>

<span class="sd">    The following attributes are accessible:</span>

<span class="sd">    &gt;&gt;&gt; spec = ExchangeSpecification(&quot;musk_classic&quot;, &quot;control.nmbsequences&quot;, &quot;lag&quot;)</span>
<span class="sd">    &gt;&gt;&gt; spec.master</span>
<span class="sd">    &#39;musk_classic&#39;</span>
<span class="sd">    &gt;&gt;&gt; spec.subgroup</span>
<span class="sd">    &#39;control&#39;</span>
<span class="sd">    &gt;&gt;&gt; spec.variable</span>
<span class="sd">    &#39;nmbsequences&#39;</span>
<span class="sd">    &gt;&gt;&gt; spec.series</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; spec.keyword</span>
<span class="sd">    &#39;lag&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">master</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Either &quot;node&quot; or the name of the relevant base or application model (e. g. </span>
<span class="sd">    &quot;hland_v1&quot;).&quot;&quot;&quot;</span>
    <span class="n">variable</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of the target or base variable.&quot;&quot;&quot;</span>
    <span class="n">keyword</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;(Optional) name of the target keyword argument of the target or base variable.&quot;&quot;&quot;</span>
    <span class="n">series</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag indicating whether to tackle the target variable&#39;s actual values (|False|)</span>
<span class="sd">    or complete time-series (|True|).&quot;&quot;&quot;</span>
    <span class="n">subgroup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For model variables, the name of the parameter or sequence subgroup of the</span>
<span class="sd">    target or base variable; for node sequences, |None|.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keyword</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;series&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span> <span class="o">=</span> <span class="n">entries</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="o">=</span> <span class="n">keyword</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">specstring</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The string corresponding to the current values of `subgroup`, `state`, and</span>
<span class="sd">        `variable`.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.itemtools import ExchangeSpecification</span>
<span class="sd">        &gt;&gt;&gt; spec = ExchangeSpecification(&quot;hland_v1&quot;, &quot;fluxes.qt&quot;, None)</span>
<span class="sd">        &gt;&gt;&gt; spec.specstring</span>
<span class="sd">        &#39;fluxes.qt&#39;</span>
<span class="sd">        &gt;&gt;&gt; spec.series = True</span>
<span class="sd">        &gt;&gt;&gt; spec.specstring</span>
<span class="sd">        &#39;fluxes.qt.series&#39;</span>
<span class="sd">        &gt;&gt;&gt; spec.subgroup = None</span>
<span class="sd">        &gt;&gt;&gt; spec.specstring</span>
<span class="sd">        &#39;qt.series&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">.series&quot;</span>
        <span class="k">return</span> <span class="n">variable</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ExchangeSpecification(&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">specstring</span><span class="si">}</span><span class="s1">&quot;, </span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1">)&#39;</span></div>



<div class="viewcode-block" id="ExchangeItem">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.ExchangeItem">[docs]</a>
<span class="k">class</span> <span class="nc">ExchangeItem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for exchanging values with multiple |Parameter| or |Sequence_|</span>
<span class="sd">    objects of a concrete type.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Name</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the exchange item.&quot;&quot;&quot;</span>
    <span class="n">targetspecs</span><span class="p">:</span> <span class="n">ExchangeSpecification</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The exchange specification for the chosen target variable.&quot;&quot;&quot;</span>
    <span class="n">device2target</span><span class="p">:</span> <span class="n">Device2Target</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A target variable object for each device.&quot;&quot;&quot;</span>
    <span class="n">selection2targets</span><span class="p">:</span> <span class="n">Selection2Targets</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A tuple of target variable objects for each selection.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of dimensions of the handled value vector.</span>

<span class="sd">        Property |ExchangeItem.ndim| needs to be overwritten by the concrete</span>
<span class="sd">        subclasses:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.itemtools import ExchangeItem</span>
<span class="sd">        &gt;&gt;&gt; ExchangeItem().ndim</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_iter_relevantelements</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">selectiontools</span><span class="o">.</span><span class="n">Selection</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">selection</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="n">name1</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="n">name2</span> <span class="o">=</span> <span class="n">name1</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">master</span> <span class="ow">in</span> <span class="p">(</span><span class="n">name1</span><span class="p">,</span> <span class="n">name2</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">element</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_query_elementvariable</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">ExchangeSpecification</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">properties</span><span class="o">.</span><span class="n">subgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">subgroup</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">properties</span><span class="o">.</span><span class="n">subgroup</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">variable_</span> <span class="o">=</span> <span class="n">subgroup</span><span class="p">[</span><span class="n">properties</span><span class="o">.</span><span class="n">variable</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_</span><span class="p">,</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">variable_</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">elementphrase</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s2"> does neither handle a &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;parameter nor a sequence subgroup named `</span><span class="si">{</span><span class="n">properties</span><span class="o">.</span><span class="n">subgroup</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_query_nodevariable</span><span class="p">(</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">ExchangeSpecification</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">NodeSequence</span><span class="p">:</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">sequences</span><span class="p">,</span> <span class="n">properties</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">NodeSequence</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sequence</span>

<div class="viewcode-block" id="ExchangeItem.collect_variables">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.ExchangeItem.collect_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selections</span><span class="p">:</span> <span class="n">selectiontools</span><span class="o">.</span><span class="n">Selections</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect the relevant target variables handled by the devices of the given</span>
<span class="sd">        |Selections| object.</span>

<span class="sd">        We prepare the `LahnH` example project to be able to use its |Selections|</span>
<span class="sd">        object:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>

<span class="sd">        We change the type of a specific application model to the type of its base</span>
<span class="sd">        model for reasons explained later:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland import Model</span>
<span class="sd">        &gt;&gt;&gt; hp.elements.land_lahn_3.model.__class__ = Model</span>

<span class="sd">        We prepare an |ExchangeItem| as an example, handling all |hland_states.Ic|</span>
<span class="sd">        sequences corresponding to any application models derived from |hland|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.itemtools import ExchangeItem, ExchangeSpecification</span>
<span class="sd">        &gt;&gt;&gt; item = ExchangeItem()</span>

<span class="sd">        |ExchangeItem| is only a base class.  Hence we need to prepare some missing</span>
<span class="sd">        attributes manually:</span>

<span class="sd">        &gt;&gt;&gt; item.targetspecs = ExchangeSpecification(&quot;hland&quot;, &quot;states.ic&quot;, None)</span>
<span class="sd">        &gt;&gt;&gt; item.level = &quot;global&quot;</span>
<span class="sd">        &gt;&gt;&gt; item.device2target = {}</span>
<span class="sd">        &gt;&gt;&gt; item.selection2targets = {}</span>

<span class="sd">        Applying method |ExchangeItem.collect_variables| connects the |ExchangeItem|</span>
<span class="sd">        object with all four relevant |hland_states.Ic| objects:</span>

<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; land_dill = hp.elements.land_dill</span>
<span class="sd">        &gt;&gt;&gt; for element in sorted(item.device2target, key=lambda x: x.name):</span>
<span class="sd">        ...     print(element)</span>
<span class="sd">        land_dill</span>
<span class="sd">        land_lahn_1</span>
<span class="sd">        land_lahn_2</span>
<span class="sd">        land_lahn_3</span>
<span class="sd">        &gt;&gt;&gt; item.device2target[land_dill] is land_dill.model.sequences.states.ic</span>
<span class="sd">        True</span>

<span class="sd">        Asking for |hland_states.Ic| objects corresponding to application model</span>
<span class="sd">        |hland_v1| only results in skipping the |Element| `land_lahn_3` (handling</span>
<span class="sd">        the |hland| base model due to the hack above):</span>

<span class="sd">        &gt;&gt;&gt; item.targetspecs.master = &quot;hland_v1&quot;</span>
<span class="sd">        &gt;&gt;&gt; item.device2target.clear()</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; for element in sorted(item.device2target, key=lambda x: x.name):</span>
<span class="sd">        ...     print(element)</span>
<span class="sd">        land_dill</span>
<span class="sd">        land_lahn_1</span>
<span class="sd">        land_lahn_2</span>
<span class="sd">        &gt;&gt;&gt; item.device2target[land_dill] is land_dill.model.sequences.states.ic</span>
<span class="sd">        True</span>

<span class="sd">        The value of sub-attribute |ExchangeSpecification.series| of attribute</span>
<span class="sd">        |ExchangeItem.targetspecs| does not affect the results obtained with method</span>
<span class="sd">        |ExchangeItem.collect_variables|:</span>

<span class="sd">        &gt;&gt;&gt; item.targetspecs.series = True</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.device2target[land_dill] is land_dill.model.sequences.states.ic</span>
<span class="sd">        True</span>

<span class="sd">        An ill-defined subgroup name results in the following error:</span>

<span class="sd">        &gt;&gt;&gt; item.targetspecs.subgroup = &quot;wrong_group&quot;</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: Model `hland_v1` of element `land_dill` does neither \</span>
<span class="sd">handle a parameter nor a sequence subgroup named `wrong_group.</span>

<span class="sd">        Collecting the |Sim| or |Obs| sequences of |Node| objects works similarly:</span>

<span class="sd">        &gt;&gt;&gt; item.targetspecs.master = &quot;node&quot;</span>
<span class="sd">        &gt;&gt;&gt; item.targetspecs.variable = &quot;sim&quot;</span>
<span class="sd">        &gt;&gt;&gt; item.targetspecs.subgroup = None</span>
<span class="sd">        &gt;&gt;&gt; item.targetspecs.series = False</span>
<span class="sd">        &gt;&gt;&gt; item.device2target.clear()</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; dill = hp.nodes.dill</span>
<span class="sd">        &gt;&gt;&gt; for node in sorted(item.device2target, key=lambda x: x.name):</span>
<span class="sd">        ...  print(node)</span>
<span class="sd">        dill</span>
<span class="sd">        lahn_1</span>
<span class="sd">        lahn_2</span>
<span class="sd">        lahn_3</span>
<span class="sd">        &gt;&gt;&gt; item.device2target[dill] is dill.sequences.sim</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variable</span><span class="p">:</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span>
        <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">master</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">selections</span><span class="p">:</span>
                <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">selection</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                    <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_nodevariable</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
                    <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">variables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">selection2targets</span><span class="p">[</span><span class="n">selection</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">selections</span><span class="p">:</span>
                <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_relevantelements</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
                    <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_elementvariable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
                    <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">variables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">selection2targets</span><span class="p">[</span><span class="n">selection</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span></div>
</div>



<span class="k">def</span> <span class="nf">_make_subunit_name</span><span class="p">(</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Device</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mayberable1</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.itemtools import _make_subunit_name as make</span>
<span class="sd">    &gt;&gt;&gt; device = type(&quot;D&quot;, (), {&quot;name&quot;: &quot;dev&quot;})()</span>
<span class="sd">    &gt;&gt;&gt; make(device, type(&quot;V&quot;, (), {&quot;NDIM&quot;: 0, &quot;shape&quot;: 0})())</span>
<span class="sd">    &#39;dev&#39;</span>
<span class="sd">    &gt;&gt;&gt; print(*make(device, type(&quot;V&quot;, (), {&quot;NDIM&quot;: 1, &quot;shape&quot;: (2,)})()))</span>
<span class="sd">    dev_0 dev_1</span>
<span class="sd">    &gt;&gt;&gt; print(*make(device, type(&quot;V&quot;, (), {&quot;NDIM&quot;: 3, &quot;shape&quot;: (1, 2, 3)})()))</span>
<span class="sd">    dev_0_0_0 dev_0_0_1 dev_0_0_2 dev_0_1_0 dev_0_1_1 dev_0_1_2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">idxs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">ranges</span><span class="p">)</span>
    <span class="p">)</span>


<div class="viewcode-block" id="ChangeItem">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.ChangeItem">[docs]</a>
<span class="k">class</span> <span class="nc">ChangeItem</span><span class="p">(</span><span class="n">ExchangeItem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for changing the values of multiple |Parameter| or |Sequence_|</span>
<span class="sd">    objects of a specific type.&quot;&quot;&quot;</span>

    <span class="n">level</span><span class="p">:</span> <span class="n">LevelType</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The level at which the values of the change item are valid.&quot;&quot;&quot;</span>
    <span class="n">_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span>
    <span class="n">_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NDArrayFloat</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of dimensions of the handled value vector.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="s2">&quot;global&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">series</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The shape of the target variables.</span>

<span class="sd">        Trying to access property |ChangeItem.shape| before calling method</span>
<span class="sd">        |ChangeItem.collect_variables| results in the following error:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import SetItem</span>
<span class="sd">        &gt;&gt;&gt; SetItem(&quot;name&quot;, &quot;master&quot;, &quot;target&quot;, None, &quot;global&quot;).shape</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: The shape of SetItem `name` has not been determined so far.</span>

<span class="sd">        See method |ChangeItem.collect_variables| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The shape of </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` has not been &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;determined so far.&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">seriesshape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The shape of the target variables&#39; whole time series.</span>

<span class="sd">        |ChangeItem.seriesshape| extends the |ChangeItem.shape| tuple by the length of</span>
<span class="sd">        the current simulation period:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; del pub.selections[&quot;complete&quot;]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import SetItem</span>
<span class="sd">        &gt;&gt;&gt; for level in (&quot;global&quot;, &quot;selection&quot;, &quot;device&quot;,  &quot;subunit&quot;):</span>
<span class="sd">        ...     item = SetItem(&quot;t&quot;, &quot;hland&quot;, &quot;inputs.t.series&quot;, None, level)</span>
<span class="sd">        ...     item.collect_variables(pub.selections)</span>
<span class="sd">        ...     print(level, item.shape, item.seriesshape)</span>
<span class="sd">        global () (4,)</span>
<span class="sd">        selection (2,) (2, 4)</span>
<span class="sd">        device (4,) (4, 4)</span>
<span class="sd">        subunit (4,) (4, 4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">sim</span><span class="p">),)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Artificial subnames of all values of all target variables.</span>

<span class="sd">        Property |ChangeItem.subnames| offers a way to identify specific entries of the</span>
<span class="sd">        vector returned by property |ChangeItem.value|.  See method</span>
<span class="sd">        |ChangeItem.collect_variables| for further information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;selection&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection2targets</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;device&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;subunit&quot;</span><span class="p">:</span>
            <span class="n">subnames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">device</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">subsubnames</span> <span class="o">=</span> <span class="n">_make_subunit_name</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subsubnames</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">subnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subsubnames</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subnames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subsubnames</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">subnames</span><span class="p">)</span>
        <span class="n">objecttools</span><span class="o">.</span><span class="n">assert_never</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The item value(s) changing the values of target variables through applying</span>
<span class="sd">        method |ChangeItem.update_variables| of class |ChangeItem|.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; del pub.selections[&quot;complete&quot;]</span>

<span class="sd">        The first example deals with &quot;global&quot; state values:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import SetItem</span>
<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;ic&quot;, &quot;hland&quot;, &quot;states.ic&quot;, None, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        hydpy.core.exceptiontools.AttributeNotReady: The value(s) of the SetItem \</span>
<span class="sd">`ic` has/have not been prepared so far.</span>

<span class="sd">        &gt;&gt;&gt; item.value = 1.0</span>
<span class="sd">        &gt;&gt;&gt; item.value</span>
<span class="sd">        array(1.)</span>

<span class="sd">        &gt;&gt;&gt; item.value = 1.0, 2.0</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ValueError: When trying to convert the value(s) `(1.0, 2.0)` assigned to \</span>
<span class="sd">SetItem `ic` to a numpy array of shape `()` and type `float`, the following error \</span>
<span class="sd">occurred: could not broadcast input array from shape (2,) into shape ()</span>

<span class="sd">        The second example deals with &quot;selection-wide&quot; input time series values:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;t&quot;, &quot;hland&quot;, &quot;inputs.t.series&quot;, None, &quot;selection&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>

<span class="sd">        &gt;&gt;&gt; item.value = [1.0, 2.0, 3.0, 4.0], [5.0, 6.0, 7.0, 8.0]</span>
<span class="sd">        &gt;&gt;&gt; item.value</span>
<span class="sd">        array([[1., 2., 3., 4.],</span>
<span class="sd">               [5., 6., 7., 8.]])</span>

<span class="sd">        &gt;&gt;&gt; item.value = 1.0, 2.0</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ValueError: When trying to convert the value(s) `(1.0, 2.0)` assigned to \</span>
<span class="sd">SetItem `t` to a numpy array of shape `(2, 4)` and type `float`, the following error \</span>
<span class="sd">occurred: could not broadcast input array from shape (2,) into shape (2,4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">AttributeNotReady</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The value(s) of the </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` has/have &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not been prepared so far.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">NDArrayFloat</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seriesshape</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">series</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;When trying to convert the value(s) `</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">` assigned to &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` to a numpy array of shape &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">` and type `float`&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="ChangeItem.collect_variables">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.ChangeItem.collect_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selections</span><span class="p">:</span> <span class="n">selectiontools</span><span class="o">.</span><span class="n">Selections</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply method |ExchangeItem.collect_variables| of the base class</span>
<span class="sd">        |ExchangeItem| and determine the |ChangeItem.shape| of the current |ChangeItem|</span>
<span class="sd">        object afterwards.</span>

<span class="sd">        For the following examples, we prepare the `LahnH` example project and remove</span>
<span class="sd">        the &quot;complete&quot; selection from the |Selections| object available in module |pub|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; del pub.selections[&quot;complete&quot;]</span>

<span class="sd">        After calling method |ChangeItem.collect_variables|, attribute</span>
<span class="sd">        |ExchangeItem.device2target| assigns all relevant devices to the chosen target</span>
<span class="sd">        variables:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import SetItem</span>
<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;ic&quot;, &quot;hland&quot;, &quot;states.ic&quot;, None, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; for device, target in item.device2target.items():</span>
<span class="sd">        ...     print(device, target)  # doctest: +ELLIPSIS</span>
<span class="sd">        land_dill ic(0.9694, ..., 1.47487)</span>
<span class="sd">        land_lahn_1 ic(0.96404, ..., 1.46719)</span>
<span class="sd">        land_lahn_2 ic(0.96159, ..., 1.46393)</span>
<span class="sd">        land_lahn_3 ic(0.96064, ..., 1.46444)</span>

<span class="sd">        Similarly, attribute |ExchangeItem.selection2targets| maps all relevant</span>
<span class="sd">        selections to the chosen target variables:</span>

<span class="sd">        &gt;&gt;&gt; for selection, targets in item.selection2targets.items():</span>
<span class="sd">        ...     print(selection, targets)  # doctest: +ELLIPSIS</span>
<span class="sd">        headwaters (ic(0.9694, ..., 1.47487), ic(0.96404, ..., 1.46719))</span>
<span class="sd">        nonheadwaters (ic(0.96159, ..., 1.46393), ic(0.96064, ..., 1.46444))</span>

<span class="sd">        The properties |ChangeItem.shape| and |ChangeItem.subnames| of a |ChangeItem|</span>
<span class="sd">        object depend on the intended aggregation |ChangeItem.level|.  For the &quot;global&quot;</span>
<span class="sd">        level, we need only one scalar value for all target variables.  Property</span>
<span class="sd">        |ChangeItem.shape| indicates this by returning an empty tuple and property</span>
<span class="sd">        |ChangeItem.subnames| by returning |None|:</span>

<span class="sd">        &gt;&gt;&gt; item.shape</span>
<span class="sd">        ()</span>
<span class="sd">        &gt;&gt;&gt; item.subnames</span>

<span class="sd">        For the &quot;selection&quot; level, we need one value for each relevant selection.</span>
<span class="sd">        Therefore, we use the plain selection names as sub names:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;ic&quot;, &quot;hland&quot;, &quot;states.ic&quot;, None, &quot;selection&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.shape</span>
<span class="sd">        (2,)</span>
<span class="sd">        &gt;&gt;&gt; item.subnames</span>
<span class="sd">        (&#39;headwaters&#39;, &#39;nonheadwaters&#39;)</span>

<span class="sd">        For the &quot;device&quot; level, we need one value for each relevant device.  Therefore,</span>
<span class="sd">        we use the plain device names as sub names:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;ic&quot;, &quot;hland&quot;, &quot;states.ic&quot;, None, &quot;device&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.shape</span>
<span class="sd">        (4,)</span>
<span class="sd">        &gt;&gt;&gt; item.subnames</span>
<span class="sd">        (&#39;land_dill&#39;, &#39;land_lahn_1&#39;, &#39;land_lahn_2&#39;, &#39;land_lahn_3&#39;)</span>

<span class="sd">        For the &quot;subunit&quot; level, we need one value for each vector entry of all target</span>
<span class="sd">        variables. When using the 1-dimensional parameter |hland_states.IC| of the base</span>
<span class="sd">        model |hland| as an example, property |ChangeItem.shape| agrees with the total</span>
<span class="sd">        number of hydrological response units.  Property |ChangeItem.subnames| combines</span>
<span class="sd">        the device names with the zero-based index numbers of the vector entries of the</span>
<span class="sd">        respective target variables:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;ic&quot;, &quot;hland&quot;, &quot;states.ic&quot;, None, &quot;subunit&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.shape</span>
<span class="sd">        (49,)</span>
<span class="sd">        &gt;&gt;&gt; item.subnames  # doctest: +ELLIPSIS</span>
<span class="sd">        (&#39;land_dill_0&#39;, &#39;land_dill_1&#39;, ..., &#39;land_lahn_3_12&#39;, &#39;land_lahn_3_13&#39;)</span>

<span class="sd">        For 2-dimensional sequences, |ChangeItem.shape| returns the total number</span>
<span class="sd">        of matrix entries and each sub name indicates the row and the column of a</span>
<span class="sd">        specific matrix entry:</span>

<span class="sd">        &gt;&gt;&gt; dill = hp.elements.land_dill.model</span>
<span class="sd">        &gt;&gt;&gt; dill.parameters.control.sclass(2)</span>
<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;sp&quot;, &quot;hland&quot;, &quot;states.sp&quot;, None, &quot;subunit&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.shape</span>
<span class="sd">        (61,)</span>
<span class="sd">        &gt;&gt;&gt; item.subnames  # doctest: +ELLIPSIS</span>
<span class="sd">        (&#39;land_dill_0_0&#39;, &#39;land_dill_0_1&#39;, ..., \</span>
<span class="sd">&#39;land_dill_1_10&#39;, &#39;land_dill_1_11&#39;, ..., &#39;land_lahn_3_0_12&#39;, &#39;land_lahn_3_0_13&#39;)</span>

<span class="sd">        Everything works as explained above when specifying a keyword argument for</span>
<span class="sd">        defining values, except there is no support for the `subunit` level.  We show</span>
<span class="sd">        this for the parameter |musk_control.NmbSegments| of base model |musk|, which</span>
<span class="sd">        accepts a custom keyword argument named `lag`:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;lag&quot;, &quot;musk&quot;, &quot;control.nmbsegments&quot;, &quot;lag&quot;, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.shape</span>
<span class="sd">        ()</span>
<span class="sd">        &gt;&gt;&gt; item.subnames</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;lag&quot;, &quot;musk&quot;, &quot;control.nmbsegments&quot;, &quot;lag&quot;, &quot;selection&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.shape</span>
<span class="sd">        (1,)</span>
<span class="sd">        &gt;&gt;&gt; item.subnames</span>
<span class="sd">        (&#39;streams&#39;,)</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;lag&quot;, &quot;musk&quot;, &quot;control.nmbsegments&quot;, &quot;lag&quot;, &quot;device&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.shape</span>
<span class="sd">        (3,)</span>
<span class="sd">        &gt;&gt;&gt; item.subnames</span>
<span class="sd">        (&#39;stream_dill_lahn_2&#39;, &#39;stream_lahn_1_lahn_2&#39;, &#39;stream_lahn_2_lahn_3&#39;)</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;lag&quot;, &quot;musk&quot;, &quot;control.nmbsegments&quot;, &quot;lag&quot;, &quot;subunit&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ValueError: Incorrect configuration for exchange item `lag`: When defining a \</span>
<span class="sd">keyword for an exchange item, its aggregation level cannot be `subunit`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect_variables</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;selection&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection2targets</span><span class="p">),)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;device&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="p">),)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;subunit&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Incorrect configuration for exchange item `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">`: When &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;defining a keyword for an exchange item, its aggregation level &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;cannot be `subunit`.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">sum</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">numberofvalues</span> <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">assert_never</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChangeItem.update_variable">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.ChangeItem.update_variable">[docs]</a>
    <span class="k">def</span> <span class="nf">update_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">NDArrayFloat</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign the given value(s) to the given target or base variable.</span>

<span class="sd">        If the assignment fails, |ChangeItem.update_variable| raises an error like the</span>
<span class="sd">        following:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.itemtools import ChangeItem, ExchangeSpecification</span>
<span class="sd">        &gt;&gt;&gt; item = ChangeItem()</span>
<span class="sd">        &gt;&gt;&gt; item.name = &quot;alpha&quot;</span>
<span class="sd">        &gt;&gt;&gt; item.targetspecs = ExchangeSpecification(&quot;hland_v1&quot;, &quot;control.alpha&quot;, None)</span>
<span class="sd">        &gt;&gt;&gt; item.level = &quot;global&quot;</span>
<span class="sd">        &gt;&gt;&gt; item.device2target = {}</span>
<span class="sd">        &gt;&gt;&gt; item.selection2targets = {}</span>
<span class="sd">        &gt;&gt;&gt; item._value = &quot;wrong&quot;</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        TypeError: When trying to update a target variable of ChangeItem `alpha` with \</span>
<span class="sd">the value(s) `wrong`, the following error occurred: While trying to set the value(s) \</span>
<span class="sd">of variable `alpha` of element `land_dill`, the following error occurred: The given \</span>
<span class="sd">value `wrong` cannot be converted to type `float`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">series</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">simseries</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">variable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">)</span>
                <span class="n">keywordarguments</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">keywordarguments</span>
                <span class="n">keywordarguments</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">keywordarguments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">variable</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">keywordarguments</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;When trying to update a target variable of </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` with the value(s) `</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ChangeItem.update_variables">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.ChangeItem.update_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">update_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign the current |ChangeItem.value| to the values or time series of the</span>
<span class="sd">        target variables.</span>

<span class="sd">        For the following examples, we prepare the `LahnH` example project and remove</span>
<span class="sd">        the &quot;complete&quot; selection from the |Selections| object available in module |pub|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; del pub.selections[&quot;complete&quot;]</span>

<span class="sd">        &quot;Global&quot; |SetItem| objects assign the same value to all chosen 0-dimensional</span>
<span class="sd">        target variables (we use parameter |hland_control.Alpha| as an example):</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import SetItem</span>
<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;alpha&quot;, &quot;hland_v1&quot;, &quot;control.alpha&quot;, None, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item</span>
<span class="sd">        SetItem(&quot;alpha&quot;, &quot;hland_v1&quot;, &quot;control.alpha&quot;, None, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; land_dill = hp.elements.land_dill</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.alpha</span>
<span class="sd">        alpha(1.0)</span>
<span class="sd">        &gt;&gt;&gt; item.value = 2.0</span>
<span class="sd">        &gt;&gt;&gt; item.value</span>
<span class="sd">        array(2.)</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.alpha</span>
<span class="sd">        alpha(1.0)</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:</span>
<span class="sd">        ...     print(element, element.model.parameters.control.alpha)</span>
<span class="sd">        land_dill alpha(2.0)</span>
<span class="sd">        land_lahn_1 alpha(2.0)</span>
<span class="sd">        land_lahn_2 alpha(2.0)</span>
<span class="sd">        land_lahn_3 alpha(2.0)</span>

<span class="sd">        Similar holds for &quot;Global&quot; |SetItem| objects that modify the time series of</span>
<span class="sd">        their target variables, which we demonstrate for the input time series</span>
<span class="sd">        |hland_inputs.T|:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;t&quot;, &quot;hland_v1&quot;, &quot;inputs.t.series&quot;, None, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = 0.5, 1.0, 1.5, 2.0</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import print_values</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:</span>
<span class="sd">        ...     print(element, end=&quot;: &quot;)</span>
<span class="sd">        ...     print_values(element.model.sequences.inputs.t.series)</span>
<span class="sd">        land_dill: 0.5, 1.0, 1.5, 2.0</span>
<span class="sd">        land_lahn_1: 0.5, 1.0, 1.5, 2.0</span>
<span class="sd">        land_lahn_2: 0.5, 1.0, 1.5, 2.0</span>
<span class="sd">        land_lahn_3: 0.5, 1.0, 1.5, 2.0</span>

<span class="sd">        Some |Parameter| subclasses support setting their values via custom keyword</span>
<span class="sd">        arguments.  &quot;Global&quot; |SetItem| objects can use such keyword arguments.  We show</span>
<span class="sd">        this for the parameter |musk_control.NmbSegments| of base model |musk|, which</span>
<span class="sd">        accepts a custom keyword argument named `lag`:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;lag&quot;, &quot;musk&quot;, &quot;control.nmbsegments&quot;, &quot;lag&quot;, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item</span>
<span class="sd">        SetItem(&quot;lag&quot;, &quot;musk&quot;, &quot;control.nmbsegments&quot;, &quot;lag&quot;, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; stream_lahn_1_lahn_2 = hp.elements.stream_lahn_1_lahn_2</span>
<span class="sd">        &gt;&gt;&gt; stream_lahn_1_lahn_2.model.parameters.control.nmbsegments</span>
<span class="sd">        nmbsegments(lag=0.583)</span>
<span class="sd">        &gt;&gt;&gt; item.value = 2.0</span>
<span class="sd">        &gt;&gt;&gt; item.value</span>
<span class="sd">        array(2.)</span>
<span class="sd">        &gt;&gt;&gt; stream_lahn_1_lahn_2.model.parameters.control.nmbsegments</span>
<span class="sd">        nmbsegments(lag=0.583)</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.river:</span>
<span class="sd">        ...     print(element, element.model.parameters.control.nmbsegments)</span>
<span class="sd">        stream_dill_lahn_2 nmbsegments(lag=2.0)</span>
<span class="sd">        stream_lahn_1_lahn_2 nmbsegments(lag=2.0)</span>
<span class="sd">        stream_lahn_2_lahn_3 nmbsegments(lag=2.0)</span>

<span class="sd">        For 1-dimensional target variables like the parameter |hland_control.FC|, a</span>
<span class="sd">        &quot;global&quot; |SetItem| assigns the same value to each vector entry or the selected</span>
<span class="sd">        keyword argument:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;fc&quot;, &quot;hland_v1&quot;, &quot;control.fc&quot;, None, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = 200.0</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.fc</span>
<span class="sd">        fc(278.0)</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.fc</span>
<span class="sd">        fc(200.0)</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;fc&quot;, &quot;hland_v1&quot;, &quot;control.fc&quot;, &quot;forest&quot;, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = 300.0</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.fc</span>
<span class="sd">        fc(200.0)</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.fc</span>
<span class="sd">        fc(field=200.0, forest=300.0)</span>

<span class="sd">        The same holds for 2-dimensional target variables like the sequence</span>
<span class="sd">        |hland_states.SP| (we increase the number of snow classes and thus the length</span>
<span class="sd">        of the first axis for demonstration purposes):</span>

<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.sclass(2)</span>
<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;sp&quot;, &quot;hland_v1&quot;, &quot;states.sp&quot;, None, &quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = 5.0</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.sequences.states.sp</span>
<span class="sd">        sp([[nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan],</span>
<span class="sd">            [nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan]])</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.sequences.states.sp</span>
<span class="sd">        sp([[5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0],</span>
<span class="sd">            [5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0]])</span>

<span class="sd">        When working on the &quot;selection&quot; level, a |SetItem| object assigns one specific</span>
<span class="sd">        value to the target variables of each relevant selection, regardless of target</span>
<span class="sd">        variable&#39;s dimensionality:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;ic&quot;, &quot;hland_v1&quot;, &quot;states.ic&quot;, None, &quot;selection&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.sequences.states.ic  # doctest: +ELLIPSIS</span>
<span class="sd">        ic(0.9694, ..., 1.47487)</span>
<span class="sd">        &gt;&gt;&gt; item.value = 0.5, 1.0</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print(element, element.model.sequences.states.ic)</span>
<span class="sd">        land_dill ic(0.5, 0.5, ..., 0.5, 0.5)</span>
<span class="sd">        land_lahn_1 ic(0.5, 0.5, ..., 0.5, 0.5)</span>
<span class="sd">        land_lahn_2 ic(1.0, 1.0, ..., 1.0, 1.0)</span>
<span class="sd">        land_lahn_3 ic(1.0, 1.0, ..., 1.0, 1.0)</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;t&quot;, &quot;hland_v1&quot;, &quot;inputs.t.series&quot;, None, &quot;selection&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = [0.5, 1.0, 1.5, 2.0], [2.5, 3.0, 3.5, 4.0]</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:</span>
<span class="sd">        ...     print(element, end=&quot;: &quot;)</span>
<span class="sd">        ...     print_values(element.model.sequences.inputs.t.series)</span>
<span class="sd">        land_dill: 0.5, 1.0, 1.5, 2.0</span>
<span class="sd">        land_lahn_1: 0.5, 1.0, 1.5, 2.0</span>
<span class="sd">        land_lahn_2: 2.5, 3.0, 3.5, 4.0</span>
<span class="sd">        land_lahn_3: 2.5, 3.0, 3.5, 4.0</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;tt&quot;, &quot;hland_v1&quot;, &quot;control.tt&quot;, &quot;field&quot;, &quot;selection&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = [0.0, 1.0]</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.tt</span>
<span class="sd">        tt(0.55824)</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print(element, element.model.parameters.control.tt)</span>
<span class="sd">        land_dill tt(field=0.0, forest=0.55824)</span>
<span class="sd">        land_lahn_1 tt(field=0.0, forest=0.59365)</span>
<span class="sd">        land_lahn_2 tt(field=1.0, forest=0.0)</span>
<span class="sd">        land_lahn_3 tt(field=1.0, forest=0.0)</span>

<span class="sd">        In contrast, when working on the &quot;device&quot; level, each device receives one</span>
<span class="sd">        specific value (note that the final values of element `land_lahn_2` are partly</span>
<span class="sd">        affected and that those of element `land_lahn_3` are all affected by the</span>
<span class="sd">        |hland_states.Ic.trim| method of sequence |hland_states.IC|):</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;ic&quot;, &quot;hland_v1&quot;, &quot;states.ic&quot;, None, &quot;device&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = 0.5, 1.0, 1.5, 2.0</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print(element, element.model.sequences.states.ic)</span>
<span class="sd">        land_dill ic(0.5, 0.5, ..., 0.5, 0.5)</span>
<span class="sd">        land_lahn_1 ic(1.0, 1.0, ... 1.0, 1.0)</span>
<span class="sd">        land_lahn_2 ic(1.0, 1.5, ..., 1.0, 1.5)</span>
<span class="sd">        land_lahn_3 ic(1.0, 1.5, ..., 1.5, 1.5)</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;t&quot;, &quot;hland_v1&quot;, &quot;inputs.t.series&quot;, None, &quot;device&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = [[0.5, 1.0, 1.5, 2.0], [2.5, 3.0, 3.5, 4.0],</span>
<span class="sd">        ...               [4.5, 5.0, 5.5, 6.0], [6.5, 7.0, 7.5, 8.0]]</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:</span>
<span class="sd">        ...     print(element, end=&quot;: &quot;)</span>
<span class="sd">        ...     print_values(element.model.sequences.inputs.t.series)</span>
<span class="sd">        land_dill: 0.5, 1.0, 1.5, 2.0</span>
<span class="sd">        land_lahn_1: 2.5, 3.0, 3.5, 4.0</span>
<span class="sd">        land_lahn_2: 4.5, 5.0, 5.5, 6.0</span>
<span class="sd">        land_lahn_3: 6.5, 7.0, 7.5, 8.0</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;beta&quot;, &quot;hland_v1&quot;, &quot;control.beta&quot;, &quot;forest&quot;, &quot;device&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = [1.0, 2.0, 3.0, 4.0]</span>
<span class="sd">        &gt;&gt;&gt; land_dill.model.parameters.control.beta</span>
<span class="sd">        beta(2.54011)</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print(element, element.model.parameters.control.beta)</span>
<span class="sd">        land_dill beta(field=2.54011, forest=1.0)</span>
<span class="sd">        land_lahn_1 beta(field=1.45001, forest=2.0)</span>
<span class="sd">        land_lahn_2 beta(field=2.5118, forest=3.0)</span>
<span class="sd">        land_lahn_3 beta(field=1.51551, forest=4.0)</span>

<span class="sd">        For the most detailed &quot;subunit&quot; level and 1-dimensional variables as</span>
<span class="sd">        |hland_states.IC|, the |SetItem| object handles one value for each of the 49</span>
<span class="sd">        hydrological response units of the complete `Lahn` river basin:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;ic&quot;, &quot;hland_v1&quot;, &quot;states.ic&quot;, None, &quot;subunit&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = [value/100 for value in range(49)]</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print(element, element.model.sequences.states.ic)</span>
<span class="sd">        land_dill ic(0.0, 0.01, ..., 0.1, 0.11)</span>
<span class="sd">        land_lahn_1 ic(0.12, 0.13, ... 0.23, 0.24)</span>
<span class="sd">        land_lahn_2 ic(0.25, 0.26, ..., 0.33, 0.34)</span>
<span class="sd">        land_lahn_3 ic(0.35, 0.36, ..., 0.47, 0.48)</span>

<span class="sd">        We increased the number of snow classes per zone to two for element `land_dill`.</span>
<span class="sd">        Hence, its snow-related |hland_states.SP| object handles 22 instead of 11</span>
<span class="sd">        values, and we need to assign 61 instead of 49 values to the |SetItem|</span>
<span class="sd">        object.  Each item value relates to a specific matrix entry of a specific</span>
<span class="sd">        target variable:</span>

<span class="sd">        &gt;&gt;&gt; item = SetItem(&quot;sp&quot;, &quot;hland_v1&quot;, &quot;states.sp&quot;, None, &quot;subunit&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item.value = [value/100 for value in range(61)]</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">        &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print(element, element.model.sequences.states.sp)</span>
<span class="sd">        land_dill sp([[0.0, ...0.11],</span>
<span class="sd">            [0.12, ...0.23]])</span>
<span class="sd">        land_lahn_1 sp(0.24, ...0.36)</span>
<span class="sd">        land_lahn_2 sp(0.37, ...0.46)</span>
<span class="sd">        land_lahn_3 sp(0.47, ...0.6)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;selection&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variables</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection2targets</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">values</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;device&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;subunit&quot;</span><span class="p">:</span>
            <span class="n">idx0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">idx1</span> <span class="o">=</span> <span class="n">idx0</span> <span class="o">+</span> <span class="n">variable</span><span class="o">.</span><span class="n">numberofvalues</span>
                <span class="n">subvalues</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">subvalues</span> <span class="o">=</span> <span class="n">subvalues</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">subvalues</span><span class="p">)</span>
                <span class="n">idx0</span> <span class="o">=</span> <span class="n">idx1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">assert_never</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SetItem">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.SetItem">[docs]</a>
<span class="k">class</span> <span class="nc">SetItem</span><span class="p">(</span><span class="n">ChangeItem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exchange item for assigning |ChangeItem.value| to multiple |Parameter| or</span>
<span class="sd">    |Sequence_| objects of a specific type.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">master</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">keyword</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">LevelType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span> <span class="o">=</span> <span class="n">ExchangeSpecification</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection2targets</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="SetItem.extract_values">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.SetItem.extract_values">[docs]</a>
    <span class="k">def</span> <span class="nf">extract_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract the target variables&#39; values.</span>

<span class="sd">        Method |SetItem.extract_values| implements the inverse functionality of method</span>
<span class="sd">        |ChangeItem.update_variables|.  It queries the values of the target variables,</span>
<span class="sd">        aggregates them when necessary, and assigns them to the current |SetItem|</span>
<span class="sd">        object.  Please read the documentation on method |ChangeItem.update_variables|</span>
<span class="sd">        first, explaining the &quot;aggregation level&quot; concept.</span>

<span class="sd">        For the following examples, we prepare the `LahnH` example project:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, _ = prepare_full_example_2()</span>

<span class="sd">        We define three |SetItem| objects, which handle states of different</span>
<span class="sd">        dimensionality.  `lz` addresses the 0-dimensional sequence |hland_states.LZ|,</span>
<span class="sd">        `sm` the 1-dimensional sequence |hland_states.SM|, and `sp` the 2-dimensional</span>
<span class="sd">        sequence |hland_states.SP|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import print_values, round_, SetItem</span>
<span class="sd">        &gt;&gt;&gt; lz = SetItem(&quot;lz&quot;, &quot;hland_v1&quot;, &quot;states.lz&quot;, None, &quot;to be defined&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sm = SetItem(&quot;sm&quot;, &quot;hland_v1&quot;, &quot;states.sm&quot;, None, &quot;to be defined&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sp = SetItem(&quot;sp&quot;, &quot;hland_v1&quot;, &quot;states.sp&quot;, None, &quot;to be defined&quot;)</span>

<span class="sd">        The additional |SetItem| objects `uz`, `ic`, and `wc` address the time series</span>
<span class="sd">        of the 0-dimensional sequence |hland_states.UZ|, the 1-dimensional sequence</span>
<span class="sd">        |hland_states.Ic|, and 2-dimensional sequence |hland_states.WC|:</span>

<span class="sd">        &gt;&gt;&gt; uz = SetItem(&quot;uz&quot;, &quot;hland_v1&quot;, &quot;states.uz.series&quot;, None, &quot;to be defined&quot;)</span>
<span class="sd">        &gt;&gt;&gt; ic = SetItem(&quot;ic&quot;, &quot;hland_v1&quot;, &quot;states.ic.series&quot;, None, &quot;to be defined&quot;)</span>
<span class="sd">        &gt;&gt;&gt; wc = SetItem(&quot;wc&quot;, &quot;hland_v1&quot;, &quot;states.wc.series&quot;, None, &quot;to be defined&quot;)</span>

<span class="sd">        The following test function updates the aggregation level and calls</span>
<span class="sd">        |SetItem.extract_values| for all six items:</span>

<span class="sd">        &gt;&gt;&gt; def test(level):</span>
<span class="sd">        ...     for item in (lz, sm, sp, uz, ic, wc):</span>
<span class="sd">        ...         item.level = level</span>
<span class="sd">        ...         item.collect_variables(pub.selections)</span>
<span class="sd">        ...         item.extract_values()</span>

<span class="sd">        We mainly focus on the sequences of the application model of element</span>
<span class="sd">        `land_dill` when comparing results:</span>

<span class="sd">        &gt;&gt;&gt; dill = hp.elements.land_dill.model</span>

<span class="sd">        For rigorous testing, we increase the number of snow classes of this model</span>
<span class="sd">        instance and thus the length of the first axis of its |hland_states.SP| and its</span>
<span class="sd">        |hland_states.WC| object:</span>

<span class="sd">        &gt;&gt;&gt; import numpy</span>
<span class="sd">        &gt;&gt;&gt; dill.parameters.control.sclass(2)</span>

<span class="sd">        After this change, we must define new test data for the current state of the</span>
<span class="sd">        |hland_states.SP| object of element `land_dill`:</span>

<span class="sd">        &gt;&gt;&gt; dill.sequences.states.sp = numpy.arange(2*12).reshape(2, 12)</span>

<span class="sd">        Also, we must prepare test data for all considered time series:</span>

<span class="sd">        &gt;&gt;&gt; dill.sequences.states.uz.series = numpy.arange(4).reshape(4)</span>
<span class="sd">        &gt;&gt;&gt; dill.sequences.states.ic.series = numpy.arange(4*12).reshape(4, 12)</span>
<span class="sd">        &gt;&gt;&gt; dill.sequences.states.wc.series = numpy.arange(4*2*12).reshape(4, 2, 12)</span>

<span class="sd">        For all aggregation levels except `subunit`, |SetItem.extract_values| relies on</span>
<span class="sd">        the (spatial) aggregation of data, which is not possible beyond the `device`</span>
<span class="sd">        level.  Therefore, until the implementation of a more general spatial data</span>
<span class="sd">        concept into *HydPy*, |SetItem.extract_values| raises the following error when</span>
<span class="sd">        being applied on items working on the `global` or `selection` level:</span>

<span class="sd">        &gt;&gt;&gt; test(&quot;global&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        NotImplementedError: HydPy does not support averaging values across different \</span>
<span class="sd">elements so far.  So, it is not possible to aggregate to the global level.</span>

<span class="sd">        &gt;&gt;&gt; test(&quot;selection&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        NotImplementedError: HydPy does not support averaging values across different \</span>
<span class="sd">elements so far.  So, it is not possible to aggregate to the selection level.</span>

<span class="sd">        For the `device` level and non-scalar variables, |SetItem.extract_values| uses</span>
<span class="sd">        the |Variable.average_values| method of class |Variable| or the</span>
<span class="sd">        |IOSequence.average_series| method of class |IOSequence| for calculating the</span>
<span class="sd">        individual exchange item values:</span>

<span class="sd">        &gt;&gt;&gt; test(&quot;device&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print_values(lz.value)</span>
<span class="sd">        8.70695, 8.18711, 10.14007, 7.52648</span>
<span class="sd">        &gt;&gt;&gt; dill.sequences.states.lz</span>
<span class="sd">        lz(8.70695)</span>
<span class="sd">        &gt;&gt;&gt; print_values(sm.value)</span>
<span class="sd">        211.47288, 115.77717, 147.057048, 114.733823</span>
<span class="sd">        &gt;&gt;&gt; round_(dill.sequences.states.sm.average_values())</span>
<span class="sd">        211.47288</span>
<span class="sd">        &gt;&gt;&gt; print_values(sp.value)</span>
<span class="sd">        11.103987, 0.0, 0.0, 0.0</span>
<span class="sd">        &gt;&gt;&gt; round_(dill.sequences.states.sp.average_values())</span>
<span class="sd">        11.103987</span>
<span class="sd">        &gt;&gt;&gt; for series in uz.value:</span>
<span class="sd">        ...     print_values(series)</span>
<span class="sd">        0.0, 1.0, 2.0, 3.0</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        &gt;&gt;&gt; print_values(dill.sequences.states.uz.series)</span>
<span class="sd">        0.0, 1.0, 2.0, 3.0</span>
<span class="sd">        &gt;&gt;&gt; for series in ic.value:</span>
<span class="sd">        ...     print_values(series)</span>
<span class="sd">        5.103987, 17.103987, 29.103987, 41.103987</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        &gt;&gt;&gt; print_values(dill.sequences.states.ic.average_series())</span>
<span class="sd">        5.103987, 17.103987, 29.103987, 41.103987</span>
<span class="sd">        &gt;&gt;&gt; for series in wc.value:</span>
<span class="sd">        ...     print_values(series)</span>
<span class="sd">        11.103987, 35.103987, 59.103987, 83.103987</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        &gt;&gt;&gt; print_values(dill.sequences.states.wc.average_series())</span>
<span class="sd">        11.103987, 35.103987, 59.103987, 83.103987</span>

<span class="sd">        For the `subunit` level, no aggregation is necessary:</span>

<span class="sd">        &gt;&gt;&gt; test(&quot;subunit&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print_values(lz.value)</span>
<span class="sd">        8.70695, 8.18711, 10.14007, 7.52648</span>
<span class="sd">        &gt;&gt;&gt; dill.sequences.states.lz</span>
<span class="sd">        lz(8.70695)</span>
<span class="sd">        &gt;&gt;&gt; print_values(sm.value)  # doctest: +ELLIPSIS</span>
<span class="sd">        185.13164, 181.18755, 199.80432, 196.55888, 212.04018, 209.48859,</span>
<span class="sd">        222.12115, 220.12671, 230.30756, 228.70779, 236.91943, 235.64427,</span>
<span class="sd">        99.27505, ... 164.63255, 101.31248,</span>
<span class="sd">        97.225, 111.3861, 107.64977, 120.59559, 117.26499, 129.01711,</span>
<span class="sd">        126.0465, 136.66663, 134.01408, 143.59799, 141.24428, 147.75786,</span>
<span class="sd">        153.54053</span>
<span class="sd">        &gt;&gt;&gt; dill.sequences.states.sm</span>
<span class="sd">        sm(185.13164, 181.18755, 199.80432, 196.55888, 212.04018, 209.48859,</span>
<span class="sd">           222.12115, 220.12671, 230.30756, 228.70779, 236.91943, 235.64427)</span>
<span class="sd">        &gt;&gt;&gt; hp.elements.land_lahn_3.model.sequences.states.sm</span>
<span class="sd">        sm(101.31248, 97.225, 111.3861, 107.64977, 120.59559, 117.26499,</span>
<span class="sd">           129.01711, 126.0465, 136.66663, 134.01408, 143.59799, 141.24428,</span>
<span class="sd">           147.75786, 153.54053)</span>
<span class="sd">        &gt;&gt;&gt; print_values(sp.value)</span>
<span class="sd">        0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0,</span>
<span class="sd">        13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0, 21.0, 22.0, 23.0, 0.0,</span>
<span class="sd">        0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,</span>
<span class="sd">        0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,</span>
<span class="sd">        0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        &gt;&gt;&gt; for series in uz.value:</span>
<span class="sd">        ...     print_values(series)</span>
<span class="sd">        0.0, 1.0, 2.0, 3.0</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        &gt;&gt;&gt; print_values(dill.sequences.states.uz.series)</span>
<span class="sd">        0.0, 1.0, 2.0, 3.0</span>
<span class="sd">        &gt;&gt;&gt; for series in ic.value:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print_values(series)</span>
<span class="sd">        0.0, 12.0, 24.0, 36.0</span>
<span class="sd">        1.0, 13.0, 25.0, 37.0</span>
<span class="sd">        ...</span>
<span class="sd">        10.0, 22.0, 34.0, 46.0</span>
<span class="sd">        11.0, 23.0, 35.0, 47.0</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; for idx in range(12):  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print_values(dill.sequences.states.ic.series[:, idx])</span>
<span class="sd">        0.0, 12.0, 24.0, 36.0</span>
<span class="sd">        1.0, 13.0, 25.0, 37.0</span>
<span class="sd">        ...</span>
<span class="sd">        10.0, 22.0, 34.0, 46.0</span>
<span class="sd">        11.0, 23.0, 35.0, 47.0</span>
<span class="sd">        &gt;&gt;&gt; for series in wc.value:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print_values(series)</span>
<span class="sd">        0.0, 24.0, 48.0, 72.0</span>
<span class="sd">        12.0, 36.0, 60.0, 84.0</span>
<span class="sd">        1.0, 25.0, 49.0, 73.0</span>
<span class="sd">        13.0, 37.0, 61.0, 85.0</span>
<span class="sd">        ...</span>
<span class="sd">        10.0, 34.0, 58.0, 82.0</span>
<span class="sd">        22.0, 46.0, 70.0, 94.0</span>
<span class="sd">        11.0, 35.0, 59.0, 83.0</span>
<span class="sd">        23.0, 47.0, 71.0, 95.0</span>
<span class="sd">        nan, nan, nan, nan</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; for jdx in range(12):  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     for idx in range(2):</span>
<span class="sd">        ...         print_values(dill.sequences.states.wc.series[:, idx, jdx])</span>
<span class="sd">        0.0, 24.0, 48.0, 72.0</span>
<span class="sd">        12.0, 36.0, 60.0, 84.0</span>
<span class="sd">        1.0, 25.0, 49.0, 73.0</span>
<span class="sd">        13.0, 37.0, 61.0, 85.0</span>
<span class="sd">        ...</span>
<span class="sd">        10.0, 34.0, 58.0, 82.0</span>
<span class="sd">        22.0, 46.0, 70.0, 94.0</span>
<span class="sd">        11.0, 35.0, 59.0, 83.0</span>
<span class="sd">        23.0, 47.0, 71.0, 95.0</span>

<span class="sd">        Due to the current limitation regarding the `global` and the `selection` level</span>
<span class="sd">        and the circumstance that parameter-specific keyword arguments hardly ever</span>
<span class="sd">        resolve the `subunit` level, extracting the values of keyword arguments works</span>
<span class="sd">        only for the `device` level:</span>

<span class="sd">        &gt;&gt;&gt; cfmax = SetItem(&quot;lag&quot;, &quot;hland_v1&quot;, &quot;control.cfmax&quot;, &quot;forest&quot;, &quot;device&quot;)</span>
<span class="sd">        &gt;&gt;&gt; cfmax.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; cfmax.extract_values()</span>
<span class="sd">        &gt;&gt;&gt; dill.parameters.control.cfmax</span>
<span class="sd">        cfmax(field=4.55853, forest=2.735118)</span>
<span class="sd">        &gt;&gt;&gt; print_values(cfmax.value)</span>
<span class="sd">        2.735118, 3.0, 2.1, 2.1</span>

<span class="sd">        Method |SetItem.extract_values| cannot extract its complete data if the time</span>
<span class="sd">        series of any relevant variable is missing.  We disable the |IOSequence.series|</span>
<span class="sd">        attribute of the considered sequences to show how things work then:</span>

<span class="sd">        &gt;&gt;&gt; dill.sequences.states.uz.prepare_series(False)</span>
<span class="sd">        &gt;&gt;&gt; dill.sequences.states.ic.prepare_series(False)</span>
<span class="sd">        &gt;&gt;&gt; dill.sequences.states.wc.prepare_series(False)</span>

<span class="sd">        Method |SetItem.extract_values| emits a warning when encountering the first</span>
<span class="sd">        unprepared |IOSequence.series| attribute and, if existing, deletes already</span>
<span class="sd">        available data:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import warn_later</span>
<span class="sd">        &gt;&gt;&gt; with warn_later():</span>
<span class="sd">        ...     test(&quot;device&quot;)</span>
<span class="sd">        AttributeNotReadyWarning: While trying to query the values of exchange item \</span>
<span class="sd">`uz`, the following error occured: While trying to calculate the mean value of the \</span>
<span class="sd">internal time-series of sequence `uz` of element `land_dill`, the following error \</span>
<span class="sd">occurred: Sequence `uz` of element `land_dill` is not requested to make any \</span>
<span class="sd">time-series data available.</span>
<span class="sd">        AttributeNotReadyWarning: While trying to query the values of exchange item \</span>
<span class="sd">`ic`, the following error occured: While trying to calculate the mean value of the \</span>
<span class="sd">internal time-series of sequence `ic` of element `land_dill`, the following error \</span>
<span class="sd">occurred: Sequence `ic` of element `land_dill` is not requested to make any \</span>
<span class="sd">time-series data available.</span>
<span class="sd">        AttributeNotReadyWarning: While trying to query the values of exchange item \</span>
<span class="sd">`wc`, the following error occured: While trying to calculate the mean value of the \</span>
<span class="sd">internal time-series of sequence `wc` of element `land_dill`, the following error \</span>
<span class="sd">occurred: Sequence `wc` of element `land_dill` is not requested to make any \</span>
<span class="sd">time-series data available.</span>

<span class="sd">        &gt;&gt;&gt; for series in uz.value:</span>
<span class="sd">        ...     print_values(series)  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        hydpy.core.exceptiontools.AttributeNotReady: The value(s) of the SetItem `uz` \</span>
<span class="sd">has/have not been prepared so far.</span>
<span class="sd">        &gt;&gt;&gt; for series in ic.value:</span>
<span class="sd">        ...     print_values(series)  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        hydpy.core.exceptiontools.AttributeNotReady: The value(s) of the SetItem `ic` \</span>
<span class="sd">has/have not been prepared so far.</span>
<span class="sd">        &gt;&gt;&gt; for series in wc.value:</span>
<span class="sd">        ...     print_values(series)  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        hydpy.core.exceptiontools.AttributeNotReady: The value(s) of the SetItem `wc` \</span>
<span class="sd">has/have not been prepared so far.</span>

<span class="sd">        &gt;&gt;&gt; with warn_later():</span>
<span class="sd">        ...     test(&quot;subunit&quot;)</span>
<span class="sd">        AttributeNotReadyWarning: While trying to query the values of exchange item \</span>
<span class="sd">`uz`, the following error occured: Sequence `uz` of element `land_dill` is not \</span>
<span class="sd">requested to make any time-series data available.</span>
<span class="sd">        AttributeNotReadyWarning: While trying to query the values of exchange item \</span>
<span class="sd">`ic`, the following error occured: Sequence `ic` of element `land_dill` is not \</span>
<span class="sd">requested to make any time-series data available.</span>
<span class="sd">        AttributeNotReadyWarning: While trying to query the values of exchange item \</span>
<span class="sd">`wc`, the following error occured: Sequence `wc` of element `land_dill` is not \</span>
<span class="sd">requested to make any time-series data available.</span>

<span class="sd">        &gt;&gt;&gt; for series in uz.value:</span>
<span class="sd">        ...     print_values(series)  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        hydpy.core.exceptiontools.AttributeNotReady: The value(s) of the SetItem `uz` \</span>
<span class="sd">has/have not been prepared so far.</span>
<span class="sd">        &gt;&gt;&gt; for series in ic.value:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print_values(series)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        hydpy.core.exceptiontools.AttributeNotReady: The value(s) of the SetItem `ic` \</span>
<span class="sd">has/have not been prepared so far.</span>
<span class="sd">        &gt;&gt;&gt; for series in wc.value:  # doctest: +ELLIPSIS</span>
<span class="sd">        ...     print_values(series)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        hydpy.core.exceptiontools.AttributeNotReady: The value(s) of the SetItem `wc` \</span>
<span class="sd">has/have not been prepared so far.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">series</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seriesshape</span> <span class="k">if</span> <span class="n">series</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">itemvalues</span><span class="p">:</span> <span class="n">NDArrayFloat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">jdx0</span><span class="p">,</span> <span class="n">jdx1</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">simindices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;device&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">targetvalues</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">average_series</span><span class="p">()[</span><span class="n">jdx0</span><span class="p">:</span><span class="n">jdx1</span><span class="p">]</span>
                    <span class="k">except</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">AttributeNotReady</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;While trying to query the values of exchange item &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">`, the following error occured: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">exceptiontools</span><span class="o">.</span><span class="n">AttributeNotReadyWarning</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">targetvalues</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">average_values</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">parametertools</span><span class="o">.</span><span class="n">Parameter</span><span class="p">)</span>
                    <span class="n">targetvalues</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">keywordarguments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">keyword</span><span class="p">]</span>
                <span class="n">itemvalues</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">targetvalues</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;subunit&quot;</span><span class="p">:</span>
            <span class="n">idx0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">idx1</span> <span class="o">=</span> <span class="n">idx0</span> <span class="o">+</span> <span class="n">variable</span><span class="o">.</span><span class="n">numberofvalues</span>
                <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">targetvalues</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">simseries</span><span class="o">.</span><span class="n">T</span>
                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">targetvalues</span> <span class="o">=</span> <span class="n">targetvalues</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">targetvalues</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">)</span>
                    <span class="k">except</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">AttributeNotReady</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;While trying to query the values of exchange item &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">`, the following error occured: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">exceptiontools</span><span class="o">.</span><span class="n">AttributeNotReadyWarning</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">targetvalues</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">targetvalues</span> <span class="o">=</span> <span class="n">targetvalues</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">itemvalues</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">targetvalues</span>
                <span class="n">idx0</span> <span class="o">=</span> <span class="n">idx1</span>
        <span class="c1"># pylint: disable=consider-using-in</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;selection&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;HydPy does not support averaging values across different elements so &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;far.  So, it is not possible to aggregate to the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2"> level.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">assert_never</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">itemvalues</span>
        <span class="k">return</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">keyword</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">master</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">specstring</span><span class="si">}</span><span class="s1">&quot;, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1">, &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="MathItem">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.MathItem">[docs]</a>
<span class="k">class</span> <span class="nc">MathItem</span><span class="p">(</span><span class="n">ChangeItem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This base class performs some mathematical operations on the given values before</span>
<span class="sd">    assigning them to the handled target variables.</span>

<span class="sd">    Subclasses of |MathItem| like |AddItem| handle not only target variables but also</span>
<span class="sd">    base variables:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.itemtools import MathItem</span>
<span class="sd">    &gt;&gt;&gt; item = MathItem(&quot;sfcf&quot;, &quot;hland_v1&quot;, &quot;control.sfcf&quot;, &quot;control.rfcf&quot;, &quot;global&quot;)</span>
<span class="sd">    &gt;&gt;&gt; item</span>
<span class="sd">    MathItem(&quot;sfcf&quot;, &quot;hland_v1&quot;, &quot;control.sfcf&quot;, &quot;control.rfcf&quot;, &quot;global&quot;)</span>
<span class="sd">    &gt;&gt;&gt; item.targetspecs</span>
<span class="sd">    ExchangeSpecification(&quot;hland_v1&quot;, &quot;control.sfcf&quot;, None)</span>
<span class="sd">    &gt;&gt;&gt; item.basespecs</span>
<span class="sd">    ExchangeSpecification(&quot;hland_v1&quot;, &quot;control.rfcf&quot;, None)</span>

<span class="sd">    Generally, each |MathItem| object calculates the value of the target variable of</span>
<span class="sd">    a |Device| object by using its current |ChangeItem.value| and the value(s) of the</span>
<span class="sd">    base variable of the same |Device|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">basespecs</span><span class="p">:</span> <span class="n">ExchangeSpecification</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The exchange specification for the chosen base variable.&quot;&quot;&quot;</span>
    <span class="n">target2base</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">,</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All target variable objects and their related base variable objects.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">master</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">LevelType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span> <span class="o">=</span> <span class="n">ExchangeSpecification</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basespecs</span> <span class="o">=</span> <span class="n">ExchangeSpecification</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection2targets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target2base</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="MathItem.collect_variables">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.MathItem.collect_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_variables</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selections</span><span class="p">:</span> <span class="n">selectiontools</span><span class="o">.</span><span class="n">Selections</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply method |ChangeItem.collect_variables| of the base class |ChangeItem|</span>
<span class="sd">        and also prepare the dictionary |MathItem.target2base|, which maps each target</span>
<span class="sd">        variable object to its base variable object.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import AddItem</span>
<span class="sd">        &gt;&gt;&gt; item = AddItem(name=&quot;alpha&quot;, master=&quot;hland_v1&quot;, target=&quot;control.sfcf&quot;,</span>
<span class="sd">        ...                base=&quot;control.rfcf&quot;, level=&quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; land_dill = hp.elements.land_dill</span>
<span class="sd">        &gt;&gt;&gt; control = land_dill.model.parameters.control</span>
<span class="sd">        &gt;&gt;&gt; item.device2target[land_dill] is control.sfcf</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; item.target2base[control.sfcf] is control.rfcf</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; len(item.target2base)</span>
<span class="sd">        4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect_variables</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basespecs</span><span class="o">.</span><span class="n">variable</span>
        <span class="n">basegroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basespecs</span><span class="o">.</span><span class="n">subgroup</span>
        <span class="k">assert</span> <span class="n">basegroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">allowed_bases</span> <span class="o">=</span> <span class="p">(</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameters</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">Sequences</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">vars_</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">subvars</span><span class="o">.</span><span class="n">vars</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_</span><span class="p">,</span> <span class="n">allowed_bases</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target2base</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">vars_</span><span class="p">[</span><span class="n">basegroup</span><span class="p">][</span><span class="n">basename</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">master</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">specstring</span><span class="si">}</span><span class="s1">&quot;, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">basespecs</span><span class="o">.</span><span class="n">specstring</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="AddItem">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.AddItem">[docs]</a>
<span class="k">class</span> <span class="nc">AddItem</span><span class="p">(</span><span class="n">MathItem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;|MathItem| subclass performing additions.</span>

<span class="sd">    The following examples relate closely to the ones explained in the documentation of</span>
<span class="sd">    the method |ChangeItem.update_variables| of class |ChangeItem|.  Therefore, we</span>
<span class="sd">    similarly repeat them all to show that our |AddItem| always uses the sum of its own</span>
<span class="sd">    value(s) and the value(s) of the related base variable to update the value(s) of</span>
<span class="sd">    the target variable.</span>

<span class="sd">    We prepare the `LahnH` example project and remove the &quot;complete&quot; selection from</span>
<span class="sd">    the |Selections| object available in module |pub|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">    &gt;&gt;&gt; del pub.selections[&quot;complete&quot;]</span>

<span class="sd">    We use the rainfall correction parameter (|hland_control.RfCF|) of the application</span>
<span class="sd">    model |hland_v1| as the base variable.  Defining a different correction factor for</span>
<span class="sd">    each of the 49 hydrological response units allows strict testing:</span>

<span class="sd">    &gt;&gt;&gt; value = 0.8</span>
<span class="sd">    &gt;&gt;&gt; for element in hp.elements.catchment:</span>
<span class="sd">    ...     rfcf = element.model.parameters.control.rfcf</span>
<span class="sd">    ...     for idx in range(len(rfcf)):</span>
<span class="sd">    ...         rfcf[idx] = value</span>
<span class="sd">    ...         value += 0.01</span>
<span class="sd">    ...     print(element, rfcf)  # doctest: +ELLIPSIS</span>
<span class="sd">    land_dill rfcf(0.8, ... 0.91)</span>
<span class="sd">    land_lahn_1 rfcf(0.92, ... 1.04)</span>
<span class="sd">    land_lahn_2 rfcf(1.05, ... 1.14)</span>
<span class="sd">    land_lahn_3 rfcf(1.15, ... 1.28)</span>

<span class="sd">    We choose the snowfall correction parameter (|hland_control.SfCF|) as the target</span>
<span class="sd">    variable.  The following test calculations show the expected results for all</span>
<span class="sd">    available aggregation levels:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.itemtools import AddItem</span>
<span class="sd">    &gt;&gt;&gt; item = AddItem(name=&quot;sfcf&quot;, master=&quot;hland_v1&quot;, target=&quot;control.sfcf&quot;,</span>
<span class="sd">    ...                base=&quot;control.rfcf&quot;, level=&quot;global&quot;)</span>
<span class="sd">    &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">    &gt;&gt;&gt; item.value = 0.1</span>
<span class="sd">    &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">    &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     print(element, element.model.parameters.control.sfcf)</span>
<span class="sd">    land_dill sfcf(0.9, ... 1.01)</span>
<span class="sd">    land_lahn_1 sfcf(1.02, ... 1.14)</span>
<span class="sd">    land_lahn_2 sfcf(1.15, ... 1.24)</span>
<span class="sd">    land_lahn_3 sfcf(1.25, ... 1.38)</span>

<span class="sd">    &gt;&gt;&gt; item.level = &quot;selection&quot;</span>
<span class="sd">    &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">    &gt;&gt;&gt; item.value = -0.1, 0.0</span>
<span class="sd">    &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">    &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     print(element, element.model.parameters.control.sfcf)</span>
<span class="sd">    land_dill sfcf(0.7, ... 0.81)</span>
<span class="sd">    land_lahn_1 sfcf(0.82, ... 0.94)</span>
<span class="sd">    land_lahn_2 sfcf(1.05, ... 1.14)</span>
<span class="sd">    land_lahn_3 sfcf(1.15, ... 1.28)</span>

<span class="sd">    &gt;&gt;&gt; item = AddItem(name=&quot;sfcf&quot;, master=&quot;hland_v1&quot;, target=&quot;control.sfcf&quot;,</span>
<span class="sd">    ...                base=&quot;control.rfcf&quot;, level=&quot;device&quot;)</span>
<span class="sd">    &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">    &gt;&gt;&gt; item.value = -0.1, 0.0, 0.1, 0.2</span>
<span class="sd">    &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">    &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     print(element, element.model.parameters.control.sfcf)</span>
<span class="sd">    land_dill sfcf(0.7, ... 0.81)</span>
<span class="sd">    land_lahn_1 sfcf(0.92, ... 1.04)</span>
<span class="sd">    land_lahn_2 sfcf(1.15, ... 1.24)</span>
<span class="sd">    land_lahn_3 sfcf(1.35, ... 1.48)</span>

<span class="sd">    &gt;&gt;&gt; item = AddItem(name=&quot;sfcf&quot;, master=&quot;hland_v1&quot;, target=&quot;control.sfcf&quot;,</span>
<span class="sd">    ...                base=&quot;control.rfcf&quot;, level=&quot;subunit&quot;)</span>
<span class="sd">    &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">    &gt;&gt;&gt; item.value = [idx/100 for idx in range(-20, 29)]</span>
<span class="sd">    &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">    &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     print(element, element.model.parameters.control.sfcf)</span>
<span class="sd">    land_dill sfcf(0.6, ... 0.82)</span>
<span class="sd">    land_lahn_1 sfcf(0.84, ... 1.08)</span>
<span class="sd">    land_lahn_2 sfcf(1.1, ... 1.28)</span>
<span class="sd">    land_lahn_3 sfcf(1.3, ... 1.56)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AddItem.update_variable">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.AddItem.update_variable">[docs]</a>
    <span class="k">def</span> <span class="nf">update_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">NDArrayFloat</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign the sum of the given value(s) and the value(s) of the base variable</span>
<span class="sd">        to the given target variable.</span>

<span class="sd">        If the addition fails, |AddItem.update_variable| raises an error like the</span>
<span class="sd">        following:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.itemtools import AddItem</span>
<span class="sd">        &gt;&gt;&gt; item = AddItem(name=&quot;sfcf&quot;, master=&quot;hland_v1&quot;, target=&quot;control.sfcf&quot;,</span>
<span class="sd">        ...                base=&quot;control.rfcf&quot;, level=&quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item._value = 0.1, 0.2</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ValueError: When trying to add the value(s) `(0.1, 0.2)` of AddItem `sfcf` \</span>
<span class="sd">and the value(s) `[1.04283 ... 1.04283]` of variable `rfcf` of element `land_dill`, \</span>
<span class="sd">the following error occurred: operands could not be broadcast together with shapes \</span>
<span class="sd">(12,) (2,)...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target2base</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;When trying to add the value(s) `</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">` of AddItem &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` and the value(s) `</span><span class="si">{</span><span class="n">base</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">` of variable &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">devicephrase</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MultiplyItem">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.MultiplyItem">[docs]</a>
<span class="k">class</span> <span class="nc">MultiplyItem</span><span class="p">(</span><span class="n">MathItem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;|MathItem| subclass performing multiplications.</span>

<span class="sd">    Besides performing a multiplication instead of an addition, class |MultiplyItem|</span>
<span class="sd">    behaves exactly like class |AddItem|.  We adopt a single example of the</span>
<span class="sd">    documentation on class |AddItem| to demonstrate this difference:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">    &gt;&gt;&gt; del pub.selections[&quot;complete&quot;]</span>

<span class="sd">    &gt;&gt;&gt; value = 0.8</span>
<span class="sd">    &gt;&gt;&gt; for element in hp.elements.catchment:</span>
<span class="sd">    ...     rfcf = element.model.parameters.control.rfcf</span>
<span class="sd">    ...     for idx in range(len(rfcf)):</span>
<span class="sd">    ...         rfcf[idx] = value</span>
<span class="sd">    ...         value += 0.01</span>
<span class="sd">    ...     print(element, rfcf)  # doctest: +ELLIPSIS</span>
<span class="sd">    land_dill rfcf(0.8, ... 0.91)</span>
<span class="sd">    land_lahn_1 rfcf(0.92, ... 1.04)</span>
<span class="sd">    land_lahn_2 rfcf(1.05, ... 1.14)</span>
<span class="sd">    land_lahn_3 rfcf(1.15, ... 1.28)</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.itemtools import MultiplyItem</span>
<span class="sd">    &gt;&gt;&gt; item = MultiplyItem(name=&quot;sfcf&quot;, master=&quot;hland_v1&quot;, target=&quot;control.sfcf&quot;,</span>
<span class="sd">    ...                     base=&quot;control.rfcf&quot;, level=&quot;global&quot;)</span>
<span class="sd">    &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">    &gt;&gt;&gt; item.value = 2.0</span>
<span class="sd">    &gt;&gt;&gt; item.update_variables()</span>
<span class="sd">    &gt;&gt;&gt; for element in hp.elements.catchment:  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     print(element, element.model.parameters.control.sfcf)</span>
<span class="sd">    land_dill sfcf(1.6, ... 1.82)</span>
<span class="sd">    land_lahn_1 sfcf(1.84, ... 2.08)</span>
<span class="sd">    land_lahn_2 sfcf(2.1, ... 2.28)</span>
<span class="sd">    land_lahn_3 sfcf(2.3, ... 2.56)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultiplyItem.update_variable">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.MultiplyItem.update_variable">[docs]</a>
    <span class="k">def</span> <span class="nf">update_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">NDArrayFloat</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign the product of the given value(s) and the value(s) of the base</span>
<span class="sd">        variable to the given target variable.</span>

<span class="sd">        If the multiplication fails, |MultiplyItem.update_variable| raises an error</span>
<span class="sd">        like the following:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.itemtools import MultiplyItem</span>
<span class="sd">        &gt;&gt;&gt; item = MultiplyItem(name=&quot;sfcf&quot;, master=&quot;hland_v1&quot;, target=&quot;control.sfcf&quot;,</span>
<span class="sd">        ...                     base=&quot;control.rfcf&quot;, level=&quot;global&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; item._value = 0.1, 0.2</span>
<span class="sd">        &gt;&gt;&gt; item.update_variables()  # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ValueError: When trying to multiply the value(s) `(0.1, 0.2)` of AddItem \</span>
<span class="sd">`sfcf` and the value(s) `[1.04283 ... 1.04283]` of variable `rfcf` of element \</span>
<span class="sd">`land_dill`, the following error occurred: operands could not be broadcast together \</span>
<span class="sd">with shapes (12,) (2,)...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target2base</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;When trying to multiply the value(s) `</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">` of AddItem &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` and the value(s) `</span><span class="si">{</span><span class="n">base</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">` of variable &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">devicephrase</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GetItem">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.GetItem">[docs]</a>
<span class="k">class</span> <span class="nc">GetItem</span><span class="p">(</span><span class="n">ExchangeItem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for querying the values of multiple |Parameter| or |Sequence_|</span>
<span class="sd">    objects of a specific type.&quot;&quot;&quot;</span>

    <span class="n">_device2name</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span> <span class="n">Name</span><span class="p">]</span>
    <span class="n">_ndim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span> <span class="o">=</span> <span class="n">ExchangeSpecification</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection2targets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device2name</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of dimensions of the handled value vector.</span>

<span class="sd">        Trying to access property |GetItem.ndim| before calling method</span>
<span class="sd">        |GetItem.collect_variables| results in the following error message:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.itemtools import GetItem</span>
<span class="sd">        &gt;&gt;&gt; GetItem(&quot;temp&quot;, &quot;hland_v1&quot;, &quot;states.lz&quot;).ndim</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        hydpy.core.exceptiontools.AttributeNotReady: Attribute `ndim` of GetItem \</span>
<span class="sd">`temp` is not ready.</span>

<span class="sd">        See the documentation of the method |GetItem.collect_variables| for further</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">AttributeNotReady</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Attribute `ndim` of </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` is not ready.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span>

<div class="viewcode-block" id="GetItem.collect_variables">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.GetItem.collect_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selections</span><span class="p">:</span> <span class="n">selectiontools</span><span class="o">.</span><span class="n">Selections</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply method |ExchangeItem.collect_variables| of the base class</span>
<span class="sd">        |ExchangeItem| and determine the |GetItem.ndim| attribute of the current</span>
<span class="sd">        |GetItem| object afterwards.</span>

<span class="sd">        The value of |GetItem.ndim| depends on whether the target variable&#39;s values or</span>
<span class="sd">        time series are of interest:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.itemtools import GetItem</span>
<span class="sd">        &gt;&gt;&gt; for target in (&quot;states.lz&quot;, &quot;states.lz.series&quot;,</span>
<span class="sd">        ...                &quot;states.sm&quot;, &quot;states.sm.series&quot;):</span>
<span class="sd">        ...     item = GetItem(&quot;temp&quot;, &quot;hland_v1&quot;, target)</span>
<span class="sd">        ...     item.collect_variables(pub.selections)</span>
<span class="sd">        ...     print(item, item.ndim)</span>
<span class="sd">        GetItem(&quot;temp&quot;, &quot;hland_v1&quot;, &quot;states.lz&quot;) 0</span>
<span class="sd">        GetItem(&quot;temp&quot;, &quot;hland_v1&quot;, &quot;states.lz.series&quot;) 1</span>
<span class="sd">        GetItem(&quot;temp&quot;, &quot;hland_v1&quot;, &quot;states.sm&quot;) 1</span>
<span class="sd">        GetItem(&quot;temp&quot;, &quot;hland_v1&quot;, &quot;states.sm.series&quot;) 2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect_variables</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device2name</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">NDIM</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">series</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">break</span></div>


<div class="viewcode-block" id="GetItem.yield_name2subnames">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.GetItem.yield_name2subnames">[docs]</a>
    <span class="k">def</span> <span class="nf">yield_name2subnames</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Name</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[()],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sequentially return pairs of the item name and its artificial sub names.</span>

<span class="sd">        The purpose and definition of the sub names are similar to those returned by</span>
<span class="sd">        property |ChangeItem.subnames| of class |ChangeItem| described in the</span>
<span class="sd">        documentation on method |ChangeItem.collect_variables|.  However, class</span>
<span class="sd">        |GetItem| does not support different aggregation levels and each |GetItem|</span>
<span class="sd">        object operates on the device level.  Therefore, the returned sub names rely on</span>
<span class="sd">        the device names; and, for non-scalar target variables, additionally on the</span>
<span class="sd">        individual vector or matrix indices.</span>

<span class="sd">        Each item name is automatically generated and contains the name of the</span>
<span class="sd">        respective |Variable| object&#39;s |Device| and the target description.</span>

<span class="sd">        For 0-dimensional variables, there is only one sub name that is identical to</span>
<span class="sd">        the device name:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import SetItem</span>
<span class="sd">        &gt;&gt;&gt; item = GetItem(&quot;lz&quot;, &quot;hland_v1&quot;, &quot;states.lz&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; for name, subnames in item.yield_name2subnames():</span>
<span class="sd">        ...     print(name, subnames)</span>
<span class="sd">        land_dill_states_lz land_dill</span>
<span class="sd">        land_lahn_1_states_lz land_lahn_1</span>
<span class="sd">        land_lahn_2_states_lz land_lahn_2</span>
<span class="sd">        land_lahn_3_states_lz land_lahn_3</span>

<span class="sd">        &gt;&gt;&gt; item = GetItem(&quot;sim&quot;, &quot;nodes&quot;, &quot;sim.series&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; for name, subnames in item.yield_name2subnames():</span>
<span class="sd">        ...     print(name, subnames)</span>
<span class="sd">        dill_sim_series dill</span>
<span class="sd">        lahn_1_sim_series lahn_1</span>
<span class="sd">        lahn_2_sim_series lahn_2</span>
<span class="sd">        lahn_3_sim_series lahn_3</span>

<span class="sd">        For non-scalar variables, the sub names combine the device name and all</span>
<span class="sd">        possible index combinations for the current shape of the target variable:</span>

<span class="sd">        &gt;&gt;&gt; item = GetItem(&quot;sm&quot;, &quot;hland_v1&quot;, &quot;states.sm&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; for name, subnames in item.yield_name2subnames():</span>
<span class="sd">        ...     print(name, subnames)  # doctest: +ELLIPSIS</span>
<span class="sd">        land_dill_states_sm (&#39;land_dill_0&#39;, ..., &#39;land_dill_11&#39;)</span>
<span class="sd">        land_lahn_1_states_sm (&#39;land_lahn_1_0&#39;, ..., &#39;land_lahn_1_12&#39;)</span>
<span class="sd">        land_lahn_2_states_sm (&#39;land_lahn_2_0&#39;, ..., &#39;land_lahn_2_9&#39;)</span>
<span class="sd">        land_lahn_3_states_sm (&#39;land_lahn_3_0&#39;, ..., &#39;land_lahn_3_13&#39;)</span>

<span class="sd">        &gt;&gt;&gt; item = GetItem(&quot;sp&quot;, &quot;hland_v1&quot;, &quot;states.sp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; for name, subnames in item.yield_name2subnames():</span>
<span class="sd">        ...     print(name, subnames)  # doctest: +ELLIPSIS</span>
<span class="sd">        land_dill_states_sp (&#39;land_dill_0_0&#39;, ..., &#39;land_dill_0_11&#39;)</span>
<span class="sd">        land_lahn_1_states_sp (&#39;land_lahn_1_0_0&#39;, ..., &#39;land_lahn_1_0_12&#39;)</span>
<span class="sd">        land_lahn_2_states_sp (&#39;land_lahn_2_0_0&#39;, ..., &#39;land_lahn_2_0_9&#39;)</span>
<span class="sd">        land_lahn_3_states_sp (&#39;land_lahn_3_0_0&#39;, ..., &#39;land_lahn_3_0_13&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">device</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device2name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">subnames</span> <span class="o">=</span> <span class="n">_make_subunit_name</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="p">[</span><span class="n">device</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnames</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">subnames</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">subnames</span><span class="p">)</span></div>


<div class="viewcode-block" id="GetItem.yield_name2value">
<a class="viewcode-back" href="../../../itemtools.html#hydpy.core.itemtools.GetItem.yield_name2value">[docs]</a>
    <span class="k">def</span> <span class="nf">yield_name2value</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">idx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">idx2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Name</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sequentially return name-value pairs describing the current state of the</span>
<span class="sd">        target variables.</span>

<span class="sd">        The item names are automatically generated and contain both the name of the</span>
<span class="sd">        |Device| of the respective |Variable| object and the target description:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_full_example_2</span>
<span class="sd">        &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import SetItem</span>
<span class="sd">        &gt;&gt;&gt; item = GetItem(&quot;lz&quot;, &quot;hland_v1&quot;, &quot;states.lz&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; hp.elements.land_dill.model.sequences.states.lz = 100.0</span>
<span class="sd">        &gt;&gt;&gt; for name, value in item.yield_name2value():</span>
<span class="sd">        ...     print(name, value)</span>
<span class="sd">        land_dill_states_lz 100.0</span>
<span class="sd">        land_lahn_1_states_lz 8.18711</span>
<span class="sd">        land_lahn_2_states_lz 10.14007</span>
<span class="sd">        land_lahn_3_states_lz 7.52648</span>
<span class="sd">        &gt;&gt;&gt; item = GetItem(&quot;sm&quot;, &quot;hland_v1&quot;, &quot;states.sm&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; hp.elements.land_dill.model.sequences.states.sm = 2.0</span>
<span class="sd">        &gt;&gt;&gt; for name, value in item.yield_name2value():</span>
<span class="sd">        ...     print(name, value)  # doctest: +ELLIPSIS</span>
<span class="sd">        land_dill_states_sm [2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, \</span>
<span class="sd">2.0, 2.0, 2.0, 2.0]</span>
<span class="sd">        land_lahn_1_states_sm [99.27505, ..., 142.84148]</span>
<span class="sd">        ...</span>

<span class="sd">        When querying time series, one can restrict the span of interest by passing</span>
<span class="sd">        index values:</span>

<span class="sd">        &gt;&gt;&gt; item = GetItem(&quot;sim&quot;, &quot;nodes&quot;, &quot;sim.series&quot;)</span>
<span class="sd">        &gt;&gt;&gt; item.collect_variables(pub.selections)</span>
<span class="sd">        &gt;&gt;&gt; hp.nodes.dill.sequences.sim.series = 1.0, 2.0, 3.0, 4.0</span>
<span class="sd">        &gt;&gt;&gt; for name, value in item.yield_name2value():</span>
<span class="sd">        ...     print(name, value)  # doctest: +ELLIPSIS</span>
<span class="sd">        dill_sim_series [1.0, 2.0, 3.0, 4.0]</span>
<span class="sd">        lahn_1_sim_series [nan, ...</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; for name, value in item.yield_name2value(2, 3):</span>
<span class="sd">        ...     print(name, value)  # doctest: +ELLIPSIS</span>
<span class="sd">        dill_sim_series [3.0]</span>
<span class="sd">        lahn_1_sim_series [nan]</span>
<span class="sd">        ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">device</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device2name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device2target</span><span class="p">[</span><span class="n">device</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">series</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">idx1</span><span class="p">:</span><span class="n">idx2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">repr_list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(&quot;</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">master</span><span class="si">}</span><span class="s1">&quot;, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">targetspecs</span><span class="o">.</span><span class="n">specstring</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
        <span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 5.0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.core.itemtools</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2023, HydPy Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>