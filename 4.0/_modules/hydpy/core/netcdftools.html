
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydpy.core.netcdftools &#8212; HydPy 4.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 4.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.core.netcdftools</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hydpy.core.netcdftools</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module extends the features of module |filetools| for loading data</span>
<span class="sd">from and storing data to netCDF4 files, consistent with the `NetCDF Climate</span>
<span class="sd">and Forecast (CF) Metadata Conventions &lt;http://cfconventions.org/Data/</span>
<span class="sd">cf-conventions/cf-conventions-1.7/cf-conventions.html&gt;`_.</span>

<span class="sd">Usually, the features implemented in this module are applied only</span>
<span class="sd">indirectly in three steps:</span>

<span class="sd">  1. Call either method |SequenceManager.open_netcdfreader| or method</span>
<span class="sd">     |SequenceManager.open_netcdfwriter| of the |SequenceManager| object</span>
<span class="sd">     available in module |pub| to prepare a |NetCDFInterface| object</span>
<span class="sd">     for reading or writing.</span>
<span class="sd">  2. Call either the usual reading or writing methods of other HydPy</span>
<span class="sd">     classes (e.g. method |HydPy.load_fluxseries| of class |HydPy|</span>
<span class="sd">     or method |Elements.save_stateseries| of class |Elements|).</span>
<span class="sd">     The prepared |NetCDFInterface| object collects all read or write</span>
<span class="sd">     requests of those sequences that are supposed to be read from or</span>
<span class="sd">     written to NetCDF files.</span>
<span class="sd">  3. Finalize reading or writing by calling either method</span>
<span class="sd">     |SequenceManager.close_netcdfreader| or method</span>
<span class="sd">     |SequenceManager.close_netcdfwriter|.</span>

<span class="sd">Step 2 is a logging process only, telling the |NetCDFInterface| object</span>
<span class="sd">which data needs to be read or written.  The actual reading from or</span>
<span class="sd">writing to NetCDF files is triggered by step 3.</span>

<span class="sd">During step 2, the |NetCDFInterface| object, as well as its subobjects,</span>
<span class="sd">are accessible, allowing to inspect their current state or to modify</span>
<span class="sd">their behaviour.</span>

<span class="sd">The following real code examples show how to perform these three steps</span>
<span class="sd">both for reading and writing data, based on the example configuration</span>
<span class="sd">defined by function |prepare_io_example_1|:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">&gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>

<span class="sd">(1) We prepare a |NetCDFInterface| object for writing data by</span>
<span class="sd">calling method |SequenceManager.open_netcdfwriter|:</span>

<span class="sd">&gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">&gt;&gt;&gt; pub.sequencemanager.open_netcdfwriter()</span>

<span class="sd">(2) We tell the |SequenceManager| to read and write all time series</span>
<span class="sd">data from and to NetCDF files placed within a folder called `example`</span>
<span class="sd">(In real cases you would not write the &quot;with |TestIO|:&quot; line.  This</span>
<span class="sd">code block makes sure we are polluting the IO testing directory</span>
<span class="sd">instead of our current working directory):</span>

<span class="sd">&gt;&gt;&gt; pub.sequencemanager.generalfiletype = &quot;nc&quot;</span>
<span class="sd">&gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">&gt;&gt;&gt; with TestIO():</span>
<span class="sd">...     pub.sequencemanager.generaldirpath = &quot;example&quot;</span>

<span class="sd">(3) We store all the time series handled by the |Node| and |Element|</span>
<span class="sd">objects of the example dataset by calling |Nodes.save_allseries| of</span>
<span class="sd">class |Nodes| and |Elements.save_allseries| of class |Elements|:</span>

<span class="sd">&gt;&gt;&gt; nodes.save_allseries()</span>
<span class="sd">&gt;&gt;&gt; elements.save_allseries()</span>

<span class="sd">(4) We again log all sequences, but this time after telling the</span>
<span class="sd">|SequenceManager| to average each time series spatially:</span>

<span class="sd">&gt;&gt;&gt; pub.sequencemanager.generalaggregation = &quot;mean&quot;</span>
<span class="sd">&gt;&gt;&gt; nodes.save_allseries()</span>
<span class="sd">&gt;&gt;&gt; elements.save_allseries()</span>

<span class="sd">(5) We can now navigate into the details of the logged time series</span>
<span class="sd">data via the |NetCDFInterface| object and its subobjects.  For example,</span>
<span class="sd">we can find out which flux sequence objects of type |lland_fluxes.NKor|</span>
<span class="sd">belonging to application model |lland_v1| have been logged (those of</span>
<span class="sd">elements `element1` and `element2`):</span>


<span class="sd">&gt;&gt;&gt; writer = pub.sequencemanager.netcdfwriter</span>
<span class="sd">&gt;&gt;&gt; writer.lland_v1.flux_nkor.subdevicenames</span>
<span class="sd">(&#39;element1&#39;, &#39;element2&#39;)</span>

<span class="sd">(6) In the example discussed here, all sequences are stored within</span>
<span class="sd">the same folder (`example`).  Storing sequences in separate folders</span>
<span class="sd">goes hand in hand with storing them in separate NetCDF files, of</span>
<span class="sd">course.  In such cases, you have to include the folder into the</span>
<span class="sd">attribute name:</span>

<span class="sd">&gt;&gt;&gt; writer.foldernames</span>
<span class="sd">(&#39;example&#39;,)</span>
<span class="sd">&gt;&gt;&gt; writer.example_lland_v1.flux_nkor.subdevicenames</span>
<span class="sd">(&#39;element1&#39;, &#39;element2&#39;)</span>

<span class="sd">(7) We close the |NetCDFInterface| object, which is the moment</span>
<span class="sd">where the writing process happens.  After that, the interface object</span>
<span class="sd">is not available anymore:</span>

<span class="sd">&gt;&gt;&gt; with TestIO():</span>
<span class="sd">...     pub.sequencemanager.close_netcdfwriter()</span>
<span class="sd">&gt;&gt;&gt; pub.sequencemanager.netcdfwriter</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">RuntimeError: The sequence file manager does currently handle no NetCDF \</span>
<span class="sd">writer object.</span>

<span class="sd">(8) We set the time series values of two test sequences to zero,</span>
<span class="sd">which serves the purpose to demonstrate that reading the data back in</span>
<span class="sd">actually works:</span>

<span class="sd">&gt;&gt;&gt; nodes.node2.sequences.sim.series = 0.0</span>
<span class="sd">&gt;&gt;&gt; elements.element2.model.sequences.fluxes.nkor.series = 0.0</span>

<span class="sd">(9) We move up a gear and and prepare a |NetCDFInterface| object for</span>
<span class="sd">reading data, log all |NodeSequence| and |ModelSequence| objects,</span>
<span class="sd">and read their time series data from the created NetCDF file (note</span>
<span class="sd">that we disable option |Options.checkseries| temporarily, to prevent</span>
<span class="sd">from raising an exception when reading incomplete data from file):</span>

<span class="sd">&gt;&gt;&gt; pub.sequencemanager.open_netcdfreader()</span>
<span class="sd">&gt;&gt;&gt; nodes.load_simseries()</span>
<span class="sd">&gt;&gt;&gt; elements.load_allseries()</span>
<span class="sd">&gt;&gt;&gt; with TestIO():</span>
<span class="sd">...     with pub.options.checkseries(False):</span>
<span class="sd">...         pub.sequencemanager.close_netcdfreader()</span>

<span class="sd">(10) We check if the data is available via the test sequences again:</span>

<span class="sd">&gt;&gt;&gt; nodes.node2.sequences.sim.series</span>
<span class="sd">InfoArray([ 64.,  65.,  66.,  67.])</span>
<span class="sd">&gt;&gt;&gt; elements.element2.model.sequences.fluxes.nkor.series</span>
<span class="sd">InfoArray([[ 16.,  17.],</span>
<span class="sd">           [ 18.,  19.],</span>
<span class="sd">           [ 20.,  21.],</span>
<span class="sd">           [ 22.,  23.]])</span>
<span class="sd">&gt;&gt;&gt; pub.sequencemanager.netcdfreader</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">RuntimeError: The sequence file manager does currently handle no \</span>
<span class="sd">NetCDF reader object.</span>

<span class="sd">(11) The process of spatial aggregation  cannot be inverted.  Hence</span>
<span class="sd">reading averaged time series is left for postprocessing tools.</span>
<span class="sd">To show that writing the averaged series worked, we access</span>
<span class="sd">both relevant NetCDF files more directly using the underlying NetCDF4</span>
<span class="sd">library (note that averaging 1-dimensional time series as those of</span>
<span class="sd">node sequence |Sim| is allowed for the sake of consistency):</span>

<span class="sd">&gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">&gt;&gt;&gt; from numpy import array</span>
<span class="sd">&gt;&gt;&gt; with TestIO():</span>
<span class="sd">...     with netcdf4.Dataset(&quot;example/node.nc&quot;) as ncfile:</span>
<span class="sd">...         array(ncfile[&quot;sim_q_mean&quot;][:])</span>
<span class="sd">array([[ 60.,  61.,  62.,  63.]])</span>
<span class="sd">&gt;&gt;&gt; with TestIO():</span>
<span class="sd">...     with netcdf4.Dataset(&quot;example/lland_v1.nc&quot;) as ncfile:</span>
<span class="sd">...         array(ncfile[&quot;flux_nkor_mean&quot;][:])[1]</span>
<span class="sd">array([ 16.5,  18.5,  20.5,  22.5])</span>

<span class="sd">The described workflow is, besides the testing related specialities,</span>
<span class="sd">more or less standard and can be modified in many ways, which are</span>
<span class="sd">described in the documentation of the different features implemented</span>
<span class="sd">in module |netcdftools|, but also in the documentation on class</span>
<span class="sd">|SequenceManager| of module |filetools| and class |IOSequence| of</span>
<span class="sd">module |sequencetools|.</span>

<span class="sd">The examples above give little insight into the resulting/required</span>
<span class="sd">structure of NetCDF files. One should at least be aware of the</span>
<span class="sd">optional arguments `flatten`, `isolate`, and `timeaxis`. When</span>
<span class="sd">&quot;flattening&quot; data, multidimensional time series are handled as a</span>
<span class="sd">larger number of 1-dimensional time series. When &quot;isolating&quot; data,</span>
<span class="sd">all |IOSequence| objects of a specific subclass belong to one single</span>
<span class="sd">NetCDF file.  When selecting the first axis as the time axis (by</span>
<span class="sd">setting `timeaxis` to zero), we increase the speed of &quot;spatial access&quot;,</span>
<span class="sd">but decrease the speed of &quot;time series access&quot;, which is the focus</span>
<span class="sd">of the default configuration (where `timeaxis` is one). When reading</span>
<span class="sd">a NetCDF file, one has to choose the same options used for writing.</span>

<span class="sd">The following test shows that both |SequenceManager.open_netcdfwriter|</span>
<span class="sd">and |SequenceManager.open_netcdfreader| pass the mentioned arguments</span>
<span class="sd">correctly to the constructor of |NetCDFInterface|:</span>

<span class="sd">&gt;&gt;&gt; from unittest.mock import patch</span>
<span class="sd">&gt;&gt;&gt; with patch(&quot;hydpy.core.netcdftools.NetCDFInterface&quot;) as mock:</span>
<span class="sd">...     pub.sequencemanager.open_netcdfwriter(</span>
<span class="sd">...         flatten=True, isolate=True, timeaxis=0)</span>
<span class="sd">...     mock.assert_called_with(flatten=True, isolate=True, timeaxis=0)</span>
<span class="sd">...     pub.sequencemanager.open_netcdfreader(</span>
<span class="sd">...         flatten=True, isolate=True, timeaxis=0)</span>
<span class="sd">...     mock.assert_called_with(flatten=True, isolate=True, timeaxis=0)</span>

<span class="sd">Both methods take the current values of the options |Options.flattennetcdf|,</span>
<span class="sd">|Options.isolatenetcdf|, and |Options.timeaxisnetcdf| as default arguments:</span>

<span class="sd">&gt;&gt;&gt; with patch(&quot;hydpy.core.netcdftools.NetCDFInterface&quot;) as mock:</span>
<span class="sd">...     pub.sequencemanager.open_netcdfwriter()</span>
<span class="sd">...     mock.assert_called_with(</span>
<span class="sd">...         flatten=pub.options.flattennetcdf,</span>
<span class="sd">...         isolate=pub.options.isolatenetcdf,</span>
<span class="sd">...         timeaxis=pub.options.timeaxisnetcdf)</span>
<span class="sd">...     pub.sequencemanager.open_netcdfreader()</span>
<span class="sd">...     mock.assert_called_with(</span>
<span class="sd">...         flatten=pub.options.flattennetcdf,</span>
<span class="sd">...         isolate=pub.options.isolatenetcdf,</span>
<span class="sd">...         timeaxis=pub.options.timeaxisnetcdf)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># import...</span>
<span class="c1"># ...from standard library</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># ...from site-packages</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># ...from HydPy</span>
<span class="kn">import</span> <span class="nn">hydpy</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">exceptiontools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">objecttools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">sequencetools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">timetools</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">netcdf4</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">netcdf4</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">OptionalImport</span><span class="p">(</span><span class="s2">&quot;netcdf4&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;netCDF4&quot;</span><span class="p">],</span> <span class="nb">locals</span><span class="p">())</span>

<span class="n">IntOrSlice</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;IntOrSlice&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span>

<span class="n">dimmapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;nmb_timepoints&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nmb_subdevices&quot;</span><span class="p">:</span> <span class="s2">&quot;stations&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nmb_characters&quot;</span><span class="p">:</span> <span class="s2">&quot;char_leng_name&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Maps dimension name terms from HydPy terms NetCDF.</span>

<span class="sd">You can change this mapping if it does not suit your requirements.  For</span>
<span class="sd">example, change the value of the keyword &quot;nmb_subdevices&quot;, if you prefer to</span>
<span class="sd">call this dimension &quot;location&quot; instead of &quot;stations&quot; within NetCDF files:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.core.netcdftools import dimmapping</span>
<span class="sd">&gt;&gt;&gt; dimmapping[&quot;nmb_subdevices&quot;] = &quot;location&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">varmapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;timepoints&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;subdevices&quot;</span><span class="p">:</span> <span class="s2">&quot;station_id&quot;</span><span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Maps variable name terms from HydPy terms NetCDF.</span>

<span class="sd">You can change this mapping if it does not suit your requirements.  For </span>
<span class="sd">example, change the value of the keyword &quot;timepoints&quot;, if you prefer to </span>
<span class="sd">call this variable &quot;period&quot; instead of &quot;time&quot; within NetCDF files:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.core.netcdftools import varmapping</span>
<span class="sd">&gt;&gt;&gt; varmapping[&quot;timepoints&quot;] = &quot;period&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">fillvalue</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
<span class="sd">&quot;&quot;&quot;Default fill value for writing NetCDF files.</span>

<span class="sd">You can set another |float| value before writing a NetCDF file:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.core import netcdftools</span>
<span class="sd">&gt;&gt;&gt; netcdftools.fillvalue = -777.0</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="str2chars"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.str2chars">[docs]</a><span class="k">def</span> <span class="nf">str2chars</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return |numpy.ndarray| containing the byte characters (second axis)</span>
<span class="sd">    of all given strings (first axis).</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import str2chars</span>
<span class="sd">    &gt;&gt;&gt; str2chars([&quot;zeros&quot;, &quot;ones&quot;])</span>
<span class="sd">    array([[b&#39;z&#39;, b&#39;e&#39;, b&#39;r&#39;, b&#39;o&#39;, b&#39;s&#39;],</span>
<span class="sd">           [b&#39;o&#39;, b&#39;n&#39;, b&#39;e&#39;, b&#39;s&#39;, b&#39;&#39;]],</span>
<span class="sd">          dtype=&#39;|S1&#39;)</span>

<span class="sd">    &gt;&gt;&gt; str2chars([])</span>
<span class="sd">    array([], shape=(0, 0),</span>
<span class="sd">          dtype=&#39;|S1&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxlen</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">:</span>
        <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="c1"># noinspection PyTypeChecker</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">),</span> <span class="n">maxlen</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;|S1&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">strings</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">chars</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">jdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chars</span></div>


<div class="viewcode-block" id="chars2str"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.chars2str">[docs]</a><span class="k">def</span> <span class="nf">chars2str</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Inversion function of function |str2chars|.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import chars2str</span>

<span class="sd">    &gt;&gt;&gt; chars2str([[b&quot;z&quot;, b&quot;e&quot;, b&quot;r&quot;, b&quot;o&quot;, b&quot;s&quot;],</span>
<span class="sd">    ...            [b&quot;o&quot;, b&quot;n&quot;, b&quot;e&quot;, b&quot;s&quot;, b&quot;&quot;]])</span>
<span class="sd">    [&#39;zeros&#39;, &#39;ones&#39;]</span>

<span class="sd">    &gt;&gt;&gt; chars2str([])</span>
<span class="sd">    []</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strings</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subchars</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
        <span class="n">substrings</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">subchars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">char</span><span class="p">:</span>
                <span class="n">substrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">substrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substrings</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_dimension"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.create_dimension">[docs]</a><span class="k">def</span> <span class="nf">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Add a new dimension with the given name and length to the given</span>
<span class="sd">    NetCDF file.</span>

<span class="sd">    Essentially, |create_dimension| just calls the equally named method</span>
<span class="sd">    of the NetCDF library, but adds information to possible error messages:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_dimension</span>
<span class="sd">    &gt;&gt;&gt; create_dimension(ncfile, &quot;dim1&quot;, 5)</span>
<span class="sd">    &gt;&gt;&gt; dim = ncfile.dimensions[&quot;dim1&quot;]</span>
<span class="sd">    &gt;&gt;&gt; dim.size if hasattr(dim, &quot;size&quot;) else dim</span>
<span class="sd">    5</span>

<span class="sd">    &gt;&gt;&gt; try:</span>
<span class="sd">    ...     create_dimension(ncfile, &quot;dim1&quot;, 5)</span>
<span class="sd">    ... except BaseException as exc:</span>
<span class="sd">    ...     print(exc)    # doctest: +ELLIPSIS</span>
<span class="sd">    While trying to add dimension `dim1` with length `5` \</span>
<span class="sd">to the NetCDF file `test.nc`, the following error occurred: ...</span>

<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
            <span class="s2">&quot;While trying to add dimension `</span><span class="si">%s</span><span class="s2">` with length `</span><span class="si">%d</span><span class="s2">` &quot;</span>
            <span class="s2">&quot;to the NetCDF file `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">))</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="create_variable"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.create_variable">[docs]</a><span class="k">def</span> <span class="nf">create_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Add a new variable with the given name, datatype, and dimensions</span>
<span class="sd">    to the given NetCDF file.</span>

<span class="sd">    Essentially, |create_variable| just calls the equally named method</span>
<span class="sd">    of the NetCDF library, but adds information to possible error messages:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_variable</span>
<span class="sd">    &gt;&gt;&gt; try:</span>
<span class="sd">    ...     create_variable(ncfile, &quot;var1&quot;, &quot;f8&quot;, (&quot;dim1&quot;,))</span>
<span class="sd">    ... except BaseException as exc:</span>
<span class="sd">    ...     print(str(exc).strip(&#39;&quot;&#39;))    # doctest: +ELLIPSIS</span>
<span class="sd">    While trying to add variable `var1` with datatype `f8` and \</span>
<span class="sd">dimensions `(&#39;dim1&#39;,)` to the NetCDF file `test.nc`, the following error \</span>
<span class="sd">occurred: ...</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_dimension</span>
<span class="sd">    &gt;&gt;&gt; create_dimension(ncfile, &quot;dim1&quot;, 5)</span>
<span class="sd">    &gt;&gt;&gt; create_variable(ncfile, &quot;var1&quot;, &quot;f8&quot;, (&quot;dim1&quot;,))</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; numpy.array(ncfile[&quot;var1&quot;][:])</span>
<span class="sd">    array([ nan,  nan,  nan,  nan,  nan])</span>

<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">fillvalue</span> <span class="k">if</span> <span class="p">(</span><span class="n">datatype</span> <span class="o">==</span> <span class="s2">&quot;f8&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>
        <span class="n">ncfile</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
            <span class="s2">&quot;While trying to add variable `</span><span class="si">%s</span><span class="s2">` with datatype `</span><span class="si">%s</span><span class="s2">` &quot;</span>
            <span class="s2">&quot;and dimensions `</span><span class="si">%s</span><span class="s2">` to the NetCDF file `</span><span class="si">%s</span><span class="s2">`&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">))</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="query_variable"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.query_variable">[docs]</a><span class="k">def</span> <span class="nf">query_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;netcdf4.Variable&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the variable with the given name from the given NetCDF file.</span>

<span class="sd">    Essentially, |query_variable| just performs a key assess via the</span>
<span class="sd">    used NetCDF library, but adds information to possible error messages:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import query_variable</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     file_ = netcdf4.Dataset(&quot;model.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; query_variable(file_, &quot;flux_prec&quot;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    OSError: NetCDF file `model.nc` does not contain variable `flux_prec`.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_variable</span>
<span class="sd">    &gt;&gt;&gt; create_variable(file_, &quot;flux_prec&quot;, &quot;f8&quot;, ())</span>
<span class="sd">    &gt;&gt;&gt; isinstance(query_variable(file_, &quot;flux_prec&quot;), netcdf4.Variable)</span>
<span class="sd">    True</span>

<span class="sd">    &gt;&gt;&gt; file_.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;NetCDF file `</span><span class="si">{</span><span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span><span class="si">}</span><span class="s2">` does not contain &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;variable `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span></div>


<div class="viewcode-block" id="query_timegrid"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.query_timegrid">[docs]</a><span class="k">def</span> <span class="nf">query_timegrid</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Timegrid</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the |Timegrid| defined by the given NetCDF file.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_full_example_1</span>
<span class="sd">    &gt;&gt;&gt; prepare_full_example_1()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import query_timegrid</span>
<span class="sd">    &gt;&gt;&gt; filepath = &quot;LahnH/series/input/hland_v1_input_t.nc&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(filepath) as ncfile:</span>
<span class="sd">    ...         query_timegrid(ncfile)</span>
<span class="sd">    Timegrid(&quot;1996-01-01 00:00:00&quot;,</span>
<span class="sd">             &quot;2007-01-01 00:00:00&quot;,</span>
<span class="sd">             &quot;1d&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timepoints</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">varmapping</span><span class="p">[</span><span class="s2">&quot;timepoints&quot;</span><span class="p">]]</span>
    <span class="n">refdate</span> <span class="o">=</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">from_cfunits</span><span class="p">(</span><span class="n">timepoints</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Timegrid</span><span class="o">.</span><span class="n">from_timepoints</span><span class="p">(</span>
        <span class="n">timepoints</span><span class="o">=</span><span class="n">timepoints</span><span class="p">[:],</span>
        <span class="n">refdate</span><span class="o">=</span><span class="n">refdate</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="n">timepoints</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="query_array"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.query_array">[docs]</a><span class="k">def</span> <span class="nf">query_array</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the data of the variable with the given name from the given</span>
<span class="sd">    NetCDF file.</span>

<span class="sd">    The following example shows that |query_array| returns |numpy.nan|</span>
<span class="sd">    entries to represent missing values even when the respective NetCDF</span>
<span class="sd">    variable defines a different fill value:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core import netcdftools</span>
<span class="sd">    &gt;&gt;&gt; netcdftools.fillvalue = -999.0</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;) as ncfile:</span>
<span class="sd">    ...         netcdftools.create_dimension(ncfile, &quot;dim1&quot;, 5)</span>
<span class="sd">    ...         netcdftools.create_variable(ncfile, &quot;var1&quot;, &quot;f8&quot;, (&quot;dim1&quot;,))</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;test.nc&quot;, &quot;r&quot;)</span>
<span class="sd">    &gt;&gt;&gt; netcdftools.query_variable(ncfile, &quot;var1&quot;)[:].data</span>
<span class="sd">    array([-999., -999., -999., -999., -999.])</span>
<span class="sd">    &gt;&gt;&gt; netcdftools.query_array(ncfile, &quot;var1&quot;)</span>
<span class="sd">    array([ nan,  nan,  nan,  nan,  nan])</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; netcdftools.fillvalue = numpy.nan</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="n">query_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">maskedarray</span> <span class="o">=</span> <span class="n">variable</span><span class="p">[:]</span>
    <span class="n">fillvalue_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="s2">&quot;_FillValue&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fillvalue_</span><span class="p">):</span>
        <span class="n">maskedarray</span><span class="p">[</span><span class="n">maskedarray</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">maskedarray</span><span class="o">.</span><span class="n">data</span></div>


<div class="viewcode-block" id="get_filepath"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.get_filepath">[docs]</a><span class="k">def</span> <span class="nf">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the filepath of the given NetCDF file.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import get_filepath</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     with netcdf4.Dataset(&quot;test.nc&quot;, &quot;w&quot;) as ncfile:</span>
<span class="sd">    ...         get_filepath(ncfile)</span>
<span class="sd">    &#39;test.nc&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s2">&quot;filepath&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">filename</span></div>


<div class="viewcode-block" id="NetCDFInterface"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterface">[docs]</a><span class="k">class</span> <span class="nc">NetCDFInterface</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Interface between |SequenceManager| and multiple NetCDF files.</span>

<span class="sd">    The core task of class |NetCDFInterface| is to distribute different</span>
<span class="sd">    |IOSequence| objects on different instances of class |NetCDFFile|.</span>

<span class="sd">    (1) We prepare a |SequenceManager| object and some devices handling</span>
<span class="sd">    different sequences by applying function |prepare_io_example_1|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>

<span class="sd">    (2) We collect all sequences to be used in the following examples:</span>

<span class="sd">    &gt;&gt;&gt; sequences = []</span>
<span class="sd">    &gt;&gt;&gt; for node in nodes:</span>
<span class="sd">    ...     sequences.append(node.sequences.sim)</span>
<span class="sd">    &gt;&gt;&gt; for element in elements:</span>
<span class="sd">    ...     sequences.append(element.model.sequences.inputs.nied)</span>
<span class="sd">    ...     sequences.append(element.model.sequences.fluxes.nkor)</span>

<span class="sd">    (3) We prepare a |NetCDFInterface| object and log and write all test</span>
<span class="sd">    sequences.  Due to setting `flatten` to |False|, |NetCDFInterface|</span>
<span class="sd">    initialises one |NetCDFFile| object for handling the |NodeSequence|</span>
<span class="sd">    objects, two |NetCDFFile| objects for handling the |InputSequence|</span>
<span class="sd">    objects of application models |lland_v1| and |lland_v2|, respectively,</span>
<span class="sd">    and two |NetCDFFile| objects for handling the |FluxSequence| objects</span>
<span class="sd">    of application models |lland_v1| and |lland_v2|, respectively.</span>
<span class="sd">    Sequences of a specific type of model and nodes are always handled</span>
<span class="sd">    in separate NetCDF files, to avoid name conflicts. |InputSequence|</span>
<span class="sd">    and |FluxSequence| objects can only be stored in the same NetCDF file</span>
<span class="sd">    when one wants to store them in the same folder, of course, which is</span>
<span class="sd">    not the case in the given example.  This should become clear when</span>
<span class="sd">    looking at the following attempts to query the |NetCDFFile| objects</span>
<span class="sd">    related to |lland_v2|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFInterface</span>
<span class="sd">    &gt;&gt;&gt; interface = NetCDFInterface(flatten=False, isolate=False, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; for sequence in sequences:</span>
<span class="sd">    ...     interface.log(sequence, sequence.series)</span>
<span class="sd">    ...     interface.log(sequence, sequence.average_series())</span>
<span class="sd">    &gt;&gt;&gt; interface.filenames</span>
<span class="sd">    (&#39;lland_v1&#39;, &#39;lland_v2&#39;, &#39;node&#39;)</span>
<span class="sd">    &gt;&gt;&gt; interface.node.variablenames</span>
<span class="sd">    (&#39;sim_q&#39;, &#39;sim_q_mean&#39;, &#39;sim_t&#39;, &#39;sim_t_mean&#39;)</span>
<span class="sd">    &gt;&gt;&gt; interface.node == interface.nodepath_node</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; interface.lland_v2</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    AttributeError: The current NetCDFInterface object does handle \</span>
<span class="sd">multiple NetCDFFile objects named `lland_v2`.  Please be more specific.</span>
<span class="sd">    &gt;&gt;&gt; hasattr(interface, &quot;outputpath_lland_v2&quot;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; &quot;outputpath_lland_v2&quot; in dir(interface)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; interface.lland_v3</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    AttributeError: The current NetCDFInterface object does neither \</span>
<span class="sd">handle a NetCDFFile object named `lland_v3` nor does it define \</span>
<span class="sd">a member named `lland_v3`.</span>

<span class="sd">    (4) We store all NetCDF files into the `inputpath`, `outputpath`,</span>
<span class="sd">    and `nodepath` folders of the testing directory, define by</span>
<span class="sd">    |prepare_io_example_1|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     interface.write()</span>

<span class="sd">    (5) We define a shorter initialisation period and re-activate the</span>
<span class="sd">    time series of the test sequences:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">    &gt;&gt;&gt; pub.timegrids = &quot;02.01.2000&quot;, &quot;04.01.2000&quot;, &quot;1d&quot;</span>
<span class="sd">    &gt;&gt;&gt; for sequence in sequences:</span>
<span class="sd">    ...     sequence.activate_ram()</span>

<span class="sd">    (6) We again initialise class |NetCDFInterface|, log all</span>
<span class="sd">    test sequences, and read the test data of the defined subperiod:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFInterface</span>
<span class="sd">    &gt;&gt;&gt; interface = NetCDFInterface(flatten=False, isolate=False, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; for sequence in sequences:</span>
<span class="sd">    ...     interface.log(sequence, None)</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     interface.read()</span>
<span class="sd">    &gt;&gt;&gt; nodes.node1.sequences.sim.series</span>
<span class="sd">    InfoArray([ 61.,  62.])</span>
<span class="sd">    &gt;&gt;&gt; elements.element2.model.sequences.fluxes.nkor.series</span>
<span class="sd">    InfoArray([[ 18.,  19.],</span>
<span class="sd">               [ 20.,  21.]])</span>

<span class="sd">    (7) We repeat the above steps, except that we set both</span>
<span class="sd">    `flatten` and `isolate` to |True|.  The relevant difference is</span>
<span class="sd">    that |NetCDFInterface| now initialises a new |NetCDFFile| object</span>
<span class="sd">    for each sequence type, resulting in a larger number separate</span>
<span class="sd">    NetCDF files containing only one NetCDF variable:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>

<span class="sd">    &gt;&gt;&gt; sequences = []</span>
<span class="sd">    &gt;&gt;&gt; for node in nodes:</span>
<span class="sd">    ...     sequences.append(node.sequences.sim)</span>
<span class="sd">    &gt;&gt;&gt; for element in elements:</span>
<span class="sd">    ...     sequences.append(element.model.sequences.inputs.nied)</span>
<span class="sd">    ...     sequences.append(element.model.sequences.fluxes.nkor)</span>

<span class="sd">    &gt;&gt;&gt; interface = NetCDFInterface(flatten=True, isolate=True, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; for sequence in sequences:</span>
<span class="sd">    ...     interface.log(sequence, sequence.series)</span>
<span class="sd">    ...     interface.log(sequence, sequence.average_series())</span>
<span class="sd">    &gt;&gt;&gt; from pprint import pprint</span>
<span class="sd">    &gt;&gt;&gt; pprint(interface.filenames)</span>
<span class="sd">    (&#39;lland_v1_flux_nkor&#39;,</span>
<span class="sd">     &#39;lland_v1_flux_nkor_mean&#39;,</span>
<span class="sd">     &#39;lland_v1_input_nied&#39;,</span>
<span class="sd">     &#39;lland_v1_input_nied_mean&#39;,</span>
<span class="sd">     &#39;lland_v2_flux_nkor&#39;,</span>
<span class="sd">     &#39;lland_v2_flux_nkor_mean&#39;,</span>
<span class="sd">     &#39;lland_v2_input_nied&#39;,</span>
<span class="sd">     &#39;lland_v2_input_nied_mean&#39;,</span>
<span class="sd">     &#39;node_sim_q&#39;,</span>
<span class="sd">     &#39;node_sim_q_mean&#39;,</span>
<span class="sd">     &#39;node_sim_t&#39;,</span>
<span class="sd">     &#39;node_sim_t_mean&#39;)</span>
<span class="sd">    &gt;&gt;&gt; interface.lland_v1_input_nied_mean.variablenames</span>
<span class="sd">    (&#39;input_nied_mean&#39;,)</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub, TestIO</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     pub.sequencemanager.outputpath = &quot;&quot;</span>
<span class="sd">    ...     interface.write()</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">    &gt;&gt;&gt; pub.timegrids = &quot;02.01.2000&quot;, &quot;04.01.2000&quot;, &quot;1d&quot;</span>
<span class="sd">    &gt;&gt;&gt; for sequence in sequences:</span>
<span class="sd">    ...     sequence.activate_ram()</span>

<span class="sd">    &gt;&gt;&gt; interface = NetCDFInterface(flatten=True, isolate=True, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; for sequence in sequences:</span>
<span class="sd">    ...     interface.log(sequence, None)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     interface.read()</span>
<span class="sd">    &gt;&gt;&gt; nodes.node1.sequences.sim.series</span>
<span class="sd">    InfoArray([ 61.,  62.])</span>
<span class="sd">    &gt;&gt;&gt; elements.element2.model.sequences.fluxes.nkor.series</span>
<span class="sd">    InfoArray([[ 18.,  19.],</span>
<span class="sd">               [ 20.,  21.]])</span>

<span class="sd">    (8) We technically confirm that the `isolate` and `timeaxis` arguments</span>
<span class="sd">    are passed to the constructor of class |NetCDFFile| correctly:</span>

<span class="sd">    &gt;&gt;&gt; from unittest.mock import patch</span>
<span class="sd">    &gt;&gt;&gt; with patch(&quot;hydpy.core.netcdftools.NetCDFFile&quot;) as mock:</span>
<span class="sd">    ...     interface = NetCDFInterface(</span>
<span class="sd">    ...         flatten=True, isolate=False, timeaxis=0)</span>
<span class="sd">    ...     interface.log(sequences[0], sequences[0].series)</span>
<span class="sd">    ...     mock.assert_called_once_with(</span>
<span class="sd">    ...         name=&quot;node&quot;,</span>
<span class="sd">    ...         flatten=True, isolate=False, timeaxis=0,</span>
<span class="sd">    ...         dirpath=&quot;nodepath&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">timeaxis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flatten</span> <span class="o">=</span> <span class="n">flatten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isolate</span> <span class="o">=</span> <span class="n">isolate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeaxis</span> <span class="o">=</span> <span class="n">timeaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">:</span> <span class="s2">&quot;Dict[str, Dict[str, NetCDFFile]]&quot;</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

<div class="viewcode-block" id="NetCDFInterface.log"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterface.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">infoarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Prepare a |NetCDFFile| object suitable for the given |IOSequence|</span>
<span class="sd">        object, when necessary, and pass the given arguments to its</span>
<span class="sd">        |NetCDFFile.log| method.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">ModelSequence</span><span class="p">):</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">descr_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isolate</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="n">sequence</span><span class="o">.</span><span class="n">descr_sequence</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">infoarray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">infoarray</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;unmodified&quot;</span><span class="p">):</span>
                <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="n">infoarray</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">dirpath_ext</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">[</span><span class="n">dirpath</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;NetCDFFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">[</span><span class="n">dirpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">descr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">file_</span> <span class="o">=</span> <span class="n">NetCDFFile</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">descr</span><span class="p">,</span>
                <span class="n">flatten</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_flatten</span><span class="p">,</span>
                <span class="n">isolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_isolate</span><span class="p">,</span>
                <span class="n">timeaxis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeaxis</span><span class="p">,</span>
                <span class="n">dirpath</span><span class="o">=</span><span class="n">dirpath</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">files</span><span class="p">[</span><span class="n">descr</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">infoarray</span><span class="p">)</span></div>

<div class="viewcode-block" id="NetCDFInterface.read"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterface.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call method |NetCDFFile.read| of all handled |NetCDFFile| objects.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">file_</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

<div class="viewcode-block" id="NetCDFInterface.write"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFInterface.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call method |NetCDFFile.write| of all handled |NetCDFFile| objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">:</span>
            <span class="n">init</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span>
            <span class="n">timeunits</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">firstdate</span><span class="o">.</span><span class="n">to_cfunits</span><span class="p">(</span><span class="s2">&quot;hours&quot;</span><span class="p">)</span>
            <span class="n">timepoints</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">to_timepoints</span><span class="p">(</span><span class="s2">&quot;hours&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">timeunits</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">foldernames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;A |tuple| of names of all folders the sequences shall be</span>
<span class="sd">        read from or written to.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;A |tuple| of names of all handled |NetCDFFile| objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">foldername</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">foldername</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">file_</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">memory</span> <span class="o">=</span> <span class="n">file_</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">memory</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The current NetCDFInterface object does handle &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;multiple NetCDFFile objects named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please be more specific.&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The current NetCDFInterface object does neither handle &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;a NetCDFFile object named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` nor does it define a &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;member named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
        <span class="p">)</span>

    <span class="n">__copy__</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">copy_</span>
    <span class="n">__deepcopy__</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">deepcopy_</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">adds_long</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">foldername</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">adds_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">foldername</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">counter</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">adds_short</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">nmb</span> <span class="ow">in</span> <span class="n">counter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">nmb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">dir_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">adds_long</span> <span class="o">+</span> <span class="n">adds_short</span></div>


<div class="viewcode-block" id="NetCDFFile"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFFile">[docs]</a><span class="k">class</span> <span class="nc">NetCDFFile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Handles a single NetCDF file.</span>

<span class="sd">    The core task of class |NetCDFFile| is to distribute different</span>
<span class="sd">    |IOSequence| objects on different instances of |NetCDFVariableBase|</span>
<span class="sd">    subclasses.  The documentation on the method |NetCDFFile.log|</span>
<span class="sd">    explains this in detail.  Here we focus on how a |NetCDFFile| object</span>
<span class="sd">    triggers the reading and writing functionalities of its subobjects.</span>

<span class="sd">    (1) We prepare a |SequenceManager| object and some devices handling</span>
<span class="sd">    different sequences by applying function |prepare_io_example_1|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, (element1, element2, element3) = prepare_io_example_1()</span>

<span class="sd">    (2) We define two shortcuts for the sequences used in the following</span>
<span class="sd">    examples:</span>

<span class="sd">    &gt;&gt;&gt; nied = element1.model.sequences.inputs.nied</span>
<span class="sd">    &gt;&gt;&gt; nkor = element1.model.sequences.fluxes.nkor</span>

<span class="sd">    (3) We prepare a |NetCDFFile| object and log the |lland_inputs.Nied|</span>
<span class="sd">    sequence:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFFile</span>
<span class="sd">    &gt;&gt;&gt; ncfile = NetCDFFile(</span>
<span class="sd">    ...     &quot;model&quot;, flatten=False, isolate=False, timeaxis=1, dirpath=&quot;&quot;)</span>
<span class="sd">    &gt;&gt;&gt; ncfile.log(nied, nied.series)</span>

<span class="sd">    (4) We store the NetCDF file directly into the testing directory:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub, TestIO</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     init = pub.timegrids.init</span>
<span class="sd">    ...     ncfile.write(timeunit=init.firstdate.to_cfunits(&quot;hours&quot;),</span>
<span class="sd">    ...                  timepoints=init.to_timepoints(&quot;hours&quot;))</span>

<span class="sd">    (5) We set the time series values of the test sequence to zero,</span>
<span class="sd">    log the sequence to a new |NetCDFFile| instance, read the data</span>
<span class="sd">    from the NetCDF file, and check that test sequence `nied`</span>
<span class="sd">    in fact contains the read data:</span>

<span class="sd">    &gt;&gt;&gt; nied.series = 0.0</span>
<span class="sd">    &gt;&gt;&gt; ncfile = NetCDFFile(</span>
<span class="sd">    ...     &quot;model&quot;, flatten=True, isolate=False, timeaxis=1, dirpath=&quot;&quot;)</span>
<span class="sd">    &gt;&gt;&gt; ncfile.log(nied, nied.series)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile.read()</span>
<span class="sd">    &gt;&gt;&gt; nied.series</span>
<span class="sd">    InfoArray([ 0.,  1.,  2.,  3.])</span>

<span class="sd">    (6) We show that IO errors and trying to access variables we have not</span>
<span class="sd">    logged so far should result in clear error messages:</span>

<span class="sd">    &gt;&gt;&gt; ncfile.log(nkor, nkor.series)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile.read()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    OSError: While trying to read data from NetCDF file `model.nc`, \</span>
<span class="sd">the following error occurred: NetCDF file `model.nc` does not \</span>
<span class="sd">contain variable `flux_nkor`.</span>

<span class="sd">    &gt;&gt;&gt; &quot;flux_nkor&quot; in dir(ncfile)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; ncfile.flux_nkor.name</span>
<span class="sd">    &#39;flux_nkor&#39;</span>
<span class="sd">    &gt;&gt;&gt; &#39;state_bowa&#39; in dir(ncfile)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; ncfile.state_bowa</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    AttributeError: The NetCDFFile object `model` does neither handle \</span>
<span class="sd">a NetCDF variable named `state_bowa` nor does it define a member \</span>
<span class="sd">named `state_bowa`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">timeaxis</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flatten</span> <span class="o">=</span> <span class="n">flatten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isolate</span> <span class="o">=</span> <span class="n">isolate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeaxis</span> <span class="o">=</span> <span class="n">timeaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirpath</span> <span class="o">=</span> <span class="n">dirpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span> <span class="s2">&quot;Dict[str, NetCDFVariableBase]&quot;</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

<div class="viewcode-block" id="NetCDFFile.log"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFFile.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">infoarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pass the given |IoSequence| to a suitable instance of</span>
<span class="sd">        a |NetCDFVariableBase| subclass.</span>

<span class="sd">        When writing data, the second argument should be an |InfoArray|.</span>
<span class="sd">        When reading data, this argument is ignored. Simply pass |None|.</span>

<span class="sd">        (1) We prepare some devices handling some sequences by applying</span>
<span class="sd">        function |prepare_io_example_1|.  We limit our attention to the</span>
<span class="sd">        returned elements, which handle the more diverse sequences:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, (element1, element2, element3) = prepare_io_example_1()</span>

<span class="sd">        (2) We define some shortcuts for the sequences used in the</span>
<span class="sd">        following examples:</span>

<span class="sd">        &gt;&gt;&gt; nied1 = element1.model.sequences.inputs.nied</span>
<span class="sd">        &gt;&gt;&gt; nied2 = element2.model.sequences.inputs.nied</span>
<span class="sd">        &gt;&gt;&gt; nkor2 = element2.model.sequences.fluxes.nkor</span>
<span class="sd">        &gt;&gt;&gt; nkor3 = element3.model.sequences.fluxes.nkor</span>

<span class="sd">        (3) We define a function that logs these example sequences</span>
<span class="sd">        to a given |NetCDFFile| object and prints some information</span>
<span class="sd">        about the resulting object structure.  Note that sequence</span>
<span class="sd">        `nkor2` is logged twice, the first time with its original</span>
<span class="sd">        time series data, the second time with averaged values:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import classname</span>
<span class="sd">        &gt;&gt;&gt; def test(ncfile):</span>
<span class="sd">        ...     ncfile.log(nied1, nied1.series)</span>
<span class="sd">        ...     ncfile.log(nied2, nied2.series)</span>
<span class="sd">        ...     ncfile.log(nkor2, nkor2.series)</span>
<span class="sd">        ...     ncfile.log(nkor2, nkor2.average_series())</span>
<span class="sd">        ...     ncfile.log(nkor3, nkor3.average_series())</span>
<span class="sd">        ...     for name, variable in ncfile.variables.items():</span>
<span class="sd">        ...         print(name, classname(variable), variable.subdevicenames)</span>

<span class="sd">        (4) We prepare a |NetCDFFile| object with both options</span>
<span class="sd">        `flatten` and `isolate` being disabled:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFFile</span>
<span class="sd">        &gt;&gt;&gt; ncfile = NetCDFFile(</span>
<span class="sd">        ...     &quot;model&quot;, flatten=False, isolate=False, timeaxis=1, dirpath=&quot;&quot;)</span>

<span class="sd">        (5) We log all test sequences results in two |NetCDFVariableDeep|</span>
<span class="sd">        and one |NetCDFVariableAgg| objects.  To keep both NetCDF variables</span>
<span class="sd">        related to |lland_fluxes.NKor| distinguishable, the name</span>
<span class="sd">        `flux_nkor_mean` includes information about the kind of aggregation</span>
<span class="sd">        performed:</span>

<span class="sd">        &gt;&gt;&gt; test(ncfile)</span>
<span class="sd">        input_nied NetCDFVariableDeep (&#39;element1&#39;, &#39;element2&#39;)</span>
<span class="sd">        flux_nkor NetCDFVariableDeep (&#39;element2&#39;,)</span>
<span class="sd">        flux_nkor_mean NetCDFVariableAgg (&#39;element2&#39;, &#39;element3&#39;)</span>

<span class="sd">        (6) We confirm that the |NetCDFVariableBase| objects received</span>
<span class="sd">        the required information:</span>

<span class="sd">        &gt;&gt;&gt; ncfile.flux_nkor.element2.sequence.descr_device</span>
<span class="sd">        &#39;element2&#39;</span>
<span class="sd">        &gt;&gt;&gt; ncfile.flux_nkor.element2.array</span>
<span class="sd">        InfoArray([[ 16.,  17.],</span>
<span class="sd">                   [ 18.,  19.],</span>
<span class="sd">                   [ 20.,  21.],</span>
<span class="sd">                   [ 22.,  23.]])</span>
<span class="sd">        &gt;&gt;&gt; ncfile.flux_nkor_mean.element2.sequence.descr_device</span>
<span class="sd">        &#39;element2&#39;</span>
<span class="sd">        &gt;&gt;&gt; ncfile.flux_nkor_mean.element2.array</span>
<span class="sd">        InfoArray([ 16.5,  18.5,  20.5,  22.5])</span>

<span class="sd">        (7) We again prepare a |NetCDFFile| object, but now with both</span>
<span class="sd">        options `flatten` and `isolate` being enabled.  To log test</span>
<span class="sd">        sequences with their original time series data does now trigger</span>
<span class="sd">        the initialisation of class |NetCDFVariableFlat|.  When passing</span>
<span class="sd">        aggregated data, nothing changes:</span>

<span class="sd">        &gt;&gt;&gt; ncfile = NetCDFFile(</span>
<span class="sd">        ...     &quot;model&quot;, flatten=True, isolate=True, timeaxis=1, dirpath=&quot;&quot;)</span>
<span class="sd">        &gt;&gt;&gt; test(ncfile)</span>
<span class="sd">        input_nied NetCDFVariableFlat (&#39;element1&#39;, &#39;element2&#39;)</span>
<span class="sd">        flux_nkor NetCDFVariableFlat (&#39;element2_0&#39;, &#39;element2_1&#39;)</span>
<span class="sd">        flux_nkor_mean NetCDFVariableAgg (&#39;element2&#39;, &#39;element3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ncfile.flux_nkor.element2.sequence.descr_device</span>
<span class="sd">        &#39;element2&#39;</span>
<span class="sd">        &gt;&gt;&gt; ncfile.flux_nkor.element2.array</span>
<span class="sd">        InfoArray([[ 16.,  17.],</span>
<span class="sd">                   [ 18.,  19.],</span>
<span class="sd">                   [ 20.,  21.],</span>
<span class="sd">                   [ 22.,  23.]])</span>
<span class="sd">        &gt;&gt;&gt; ncfile.flux_nkor_mean.element2.sequence.descr_device</span>
<span class="sd">        &#39;element2&#39;</span>
<span class="sd">        &gt;&gt;&gt; ncfile.flux_nkor_mean.element2.array</span>
<span class="sd">        InfoArray([ 16.5,  18.5,  20.5,  22.5])</span>

<span class="sd">        (8) We technically confirm that the `isolate` argument is passed</span>
<span class="sd">        to the constructor of subclasses of |NetCDFVariableBase| correctly:</span>

<span class="sd">        &gt;&gt;&gt; from unittest.mock import patch</span>
<span class="sd">        &gt;&gt;&gt; with patch(&quot;hydpy.core.netcdftools.NetCDFVariableFlat&quot;) as mock:</span>
<span class="sd">        ...     ncfile = NetCDFFile(</span>
<span class="sd">        ...         &quot;model&quot;, flatten=True, isolate=False, timeaxis=0,</span>
<span class="sd">        ...         dirpath=&quot;&quot;)</span>
<span class="sd">        ...     ncfile.log(nied1, nied1.series)</span>
<span class="sd">        ...     mock.assert_called_once_with(</span>
<span class="sd">        ...         name=&quot;input_nied&quot;, timeaxis=0, isolate=False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="p">(</span><span class="n">infoarray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">infoarray</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;unmodified&quot;</span>
        <span class="p">)</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">descr_sequence</span>
        <span class="k">if</span> <span class="n">aggregated</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">descr</span><span class="p">,</span> <span class="n">infoarray</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">descr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">var_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">descr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aggregated</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">NetCDFVariableAgg</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">NetCDFVariableFlat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">NetCDFVariableDeep</span>
            <span class="n">var_</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">descr</span><span class="p">,</span> <span class="n">isolate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_isolate</span><span class="p">,</span> <span class="n">timeaxis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeaxis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">descr</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">infoarray</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The NetCDF file path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dirpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="NetCDFFile.read"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFFile.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Open an existing NetCDF file temporarily and call method</span>
<span class="sd">        |NetCDFVariableDeep.read| of all handled |NetCDFVariableBase|</span>
<span class="sd">        objects.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>
                <span class="n">timegrid</span> <span class="o">=</span> <span class="n">query_timegrid</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">variable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">timegrid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;While trying to read data from NetCDF file `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="NetCDFFile.write"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFFile.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeunit</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Open a new NetCDF file temporarily and call method</span>
<span class="sd">        |NetCDFVariableBase.write| of all handled |NetCDFVariableBase|</span>
<span class="sd">        objects.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">netcdf4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>
            <span class="n">ncfile</span><span class="o">.</span><span class="n">Conventions</span> <span class="o">=</span> <span class="s2">&quot;CF-1.6&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_timepoints</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">,</span> <span class="n">timeunit</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_insert_timepoints</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">,</span> <span class="n">timeunit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dim_name</span> <span class="o">=</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_timepoints&quot;</span><span class="p">]</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="n">varmapping</span><span class="p">[</span><span class="s2">&quot;timepoints&quot;</span><span class="p">]</span>
        <span class="n">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timepoints</span><span class="p">))</span>
        <span class="n">create_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">dim_name</span><span class="p">,))</span>
        <span class="n">var_</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">var_</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">timepoints</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">timeunit</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="n">var_name</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="s2">&quot;standard&quot;</span>
        <span class="n">var_</span><span class="o">.</span><span class="n">delncattr</span><span class="p">(</span><span class="s2">&quot;_FillValue&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variablenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The names of all handled |IOSequence| objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The NetCDFFile object `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` does &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;neither handle a NetCDF variable named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;nor does it define a member named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

    <span class="n">__copy__</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">copy_</span>
    <span class="n">__deepcopy__</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">deepcopy_</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">dir_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variablenames</span><span class="p">)</span></div>


<span class="n">_NetCDFVariableInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;_NetCDFVariableInfo&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">]</span>
<span class="p">)</span>


<div class="viewcode-block" id="Subdevice2Index"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.Subdevice2Index">[docs]</a><span class="k">class</span> <span class="nc">Subdevice2Index</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return type of method |NetCDFVariableBase.query_subdevice2index|.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">name_sequence</span><span class="p">,</span> <span class="n">name_ncfile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_</span> <span class="o">=</span> <span class="n">dict_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_sequence</span> <span class="o">=</span> <span class="n">name_sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_ncfile</span> <span class="o">=</span> <span class="n">name_ncfile</span>

<div class="viewcode-block" id="Subdevice2Index.get_index"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.Subdevice2Index.get_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_subdevice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Item access to the wrapped |dict| object with a specialized</span>
<span class="sd">        error message.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_</span><span class="p">[</span><span class="n">name_subdevice</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No data for sequence `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name_sequence</span><span class="si">}</span><span class="s2">` and &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(sub)device `</span><span class="si">{</span><span class="n">name_subdevice</span><span class="si">}</span><span class="s2">` in NetCDF file &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name_ncfile</span><span class="si">}</span><span class="s2">` available.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span></div></div>


<div class="viewcode-block" id="NetCDFVariableBase"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase">[docs]</a><span class="k">class</span> <span class="nc">NetCDFVariableBase</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for |NetCDFVariableDeep|, |NetCDFVariableAgg|, and</span>
<span class="sd">    |NetCDFVariableFlat|.</span>

<span class="sd">    The initialisation of |NetCDFVariableBase| subclasses requires the</span>
<span class="sd">    arguments `name`, `isolate`, and `timeaxis`. Only the last one is</span>
<span class="sd">    checked to be valid:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableBase</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import make_abc_testable</span>
<span class="sd">    &gt;&gt;&gt; NCVar = make_abc_testable(NetCDFVariableBase)</span>
<span class="sd">    &gt;&gt;&gt; ncvar = NCVar(&quot;flux_nkor&quot;, isolate=True, timeaxis=2)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: The argument `timeaxis` must be either `0` (the first axis \</span>
<span class="sd">handles time) or `1` (the second axis handles time), but for variable \</span>
<span class="sd">`flux_nkor` of class NetCDFVariableBase_ the value `2` is given.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">timeaxis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isolate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">isolate</span>
        <span class="n">_timeaxis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_timeaxis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The argument `timeaxis` must be either `0` &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(the first axis handles time) or `1` (the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;second axis handles time), but for variable &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` of class </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the value `</span><span class="si">{</span><span class="n">timeaxis</span><span class="si">}</span><span class="s2">` is given.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeaxis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_timeaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InfoArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

<div class="viewcode-block" id="NetCDFVariableBase.log"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">infoarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Log the given |IOSequence| object either for reading or writing</span>
<span class="sd">        data.</span>

<span class="sd">        The optional `array` argument allows for passing alternative data</span>
<span class="sd">        in an |InfoArray| object replacing the series of the |IOSequence|</span>
<span class="sd">        object, which is useful for writing modified (e.g. spatially</span>
<span class="sd">        averaged) time series.</span>

<span class="sd">        Logged time series data is available via attribute access:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableBase</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import make_abc_testable</span>
<span class="sd">        &gt;&gt;&gt; NCVar = make_abc_testable(NetCDFVariableBase)</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NCVar(&quot;flux_nkor&quot;, isolate=True, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; nkor = elements.element1.model.sequences.fluxes.nkor</span>
<span class="sd">        &gt;&gt;&gt; ncvar.log(nkor, nkor.series)</span>
<span class="sd">        &gt;&gt;&gt; &quot;element1&quot; in dir(ncvar)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; ncvar.element1.sequence is nkor</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; &quot;element2&quot; in dir(ncvar)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; ncvar.element2</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AttributeError: The NetCDFVariable object `flux_nkor` does \</span>
<span class="sd">neither handle time series data under the (sub)device name `element2` \</span>
<span class="sd">nor does it define a member named `element2`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">descr_device</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">descr_device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="n">descr_device</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="n">descr_device</span><span class="p">]</span> <span class="o">=</span> <span class="n">infoarray</span></div>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">subdevicenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;A |tuple| containing the (sub)device names.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;A |tuple| containing the dimension names.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;A |numpy.ndarray| containing the values of all logged sequences.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;A prefix for names of dimensions and associated variables.</span>

<span class="sd">        &quot;Isolated&quot; variables do not require a prefix:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableBase</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import make_abc_testable</span>
<span class="sd">        &gt;&gt;&gt; NetCDFVariableBase_ = make_abc_testable(NetCDFVariableBase)</span>
<span class="sd">        &gt;&gt;&gt; NetCDFVariableBase_(&quot;name&quot;, isolate=True, timeaxis=1).prefix</span>
<span class="sd">        &#39;&#39;</span>

<span class="sd">        When storing different types of sequences in the same NetCDF</span>
<span class="sd">        file, there is a risk of name conflicts.  We solve this by</span>
<span class="sd">        using the variables name as a prefix:</span>

<span class="sd">        &gt;&gt;&gt; NetCDFVariableBase_(&quot;name&quot;, isolate=False, timeaxis=1).prefix</span>
<span class="sd">        &#39;name_&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isolate</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="NetCDFVariableBase.insert_subdevices"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase.insert_subdevices">[docs]</a>    <span class="k">def</span> <span class="nf">insert_subdevices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Insert a variable of the names of the (sub)devices of the logged</span>
<span class="sd">        sequences into the given NetCDF file</span>

<span class="sd">        (1) We prepare a |NetCDFVariableBase| subclass with fixed</span>
<span class="sd">        (sub)device names:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableBase, chars2str</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import make_abc_testable, TestIO</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">        &gt;&gt;&gt; Var = make_abc_testable(NetCDFVariableBase)</span>
<span class="sd">        &gt;&gt;&gt; Var.subdevicenames = &quot;element1&quot;, &quot;element_2&quot;</span>

<span class="sd">        (2) Without isolating variables,</span>
<span class="sd">        |NetCDFVariableBase.insert_subdevices| prefixes the name of the</span>
<span class="sd">        |NetCDFVariableBase| object to the name of the inserted variable</span>
<span class="sd">        and its dimensions.  The first dimension corresponds to the</span>
<span class="sd">        number of (sub)devices, the second dimension to the number of</span>
<span class="sd">        characters of the longest (sub)device name:</span>

<span class="sd">        &gt;&gt;&gt; var1 = Var(&quot;var1&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():</span>
<span class="sd">        ...     file1 = netcdf4.Dataset(&quot;model1.nc&quot;, &quot;w&quot;)</span>
<span class="sd">        &gt;&gt;&gt; var1.insert_subdevices(file1)</span>
<span class="sd">        &gt;&gt;&gt; file1[&quot;var1_station_id&quot;].dimensions</span>
<span class="sd">        (&#39;var1_stations&#39;, &#39;var1_char_leng_name&#39;)</span>
<span class="sd">        &gt;&gt;&gt; file1[&quot;var1_station_id&quot;].shape</span>
<span class="sd">        (2, 9)</span>
<span class="sd">        &gt;&gt;&gt; chars2str(file1[&quot;var1_station_id&quot;][:])</span>
<span class="sd">        [&#39;element1&#39;, &#39;element_2&#39;]</span>
<span class="sd">        &gt;&gt;&gt; file1.close()</span>

<span class="sd">        (3) When isolating variables, we omit the prefix:</span>

<span class="sd">        &gt;&gt;&gt; var2 = Var(&quot;var2&quot;, isolate=True, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():</span>
<span class="sd">        ...     file2 = netcdf4.Dataset(&quot;model2.nc&quot;, &quot;w&quot;)</span>
<span class="sd">        &gt;&gt;&gt; var2.insert_subdevices(file2)</span>
<span class="sd">        &gt;&gt;&gt; file2[&quot;station_id&quot;].dimensions</span>
<span class="sd">        (&#39;stations&#39;, &#39;char_leng_name&#39;)</span>
<span class="sd">        &gt;&gt;&gt; file2[&quot;station_id&quot;].shape</span>
<span class="sd">        (2, 9)</span>
<span class="sd">        &gt;&gt;&gt; chars2str(file2[&quot;station_id&quot;][:])</span>
<span class="sd">        [&#39;element1&#39;, &#39;element_2&#39;]</span>
<span class="sd">        &gt;&gt;&gt; file2.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span>
        <span class="n">nmb_subdevices</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_subdevices&quot;</span><span class="p">])</span>
        <span class="n">nmb_characters</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_characters&quot;</span><span class="p">])</span>
        <span class="n">subdevices</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">varmapping</span><span class="p">[</span><span class="s2">&quot;subdevices&quot;</span><span class="p">])</span>
        <span class="n">statchars</span> <span class="o">=</span> <span class="n">str2chars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdevicenames</span><span class="p">)</span>
        <span class="n">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">nmb_subdevices</span><span class="p">,</span> <span class="n">statchars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">nmb_characters</span><span class="p">,</span> <span class="n">statchars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">create_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">subdevices</span><span class="p">,</span> <span class="s2">&quot;S1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">nmb_subdevices</span><span class="p">,</span> <span class="n">nmb_characters</span><span class="p">))</span>
        <span class="n">ncfile</span><span class="p">[</span><span class="n">subdevices</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">statchars</span></div>

<div class="viewcode-block" id="NetCDFVariableBase.query_subdevices"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase.query_subdevices">[docs]</a>    <span class="k">def</span> <span class="nf">query_subdevices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Query the names of the (sub)devices of the logged sequences</span>
<span class="sd">        from the given NetCDF file</span>

<span class="sd">        (1) We apply function |NetCDFVariableBase.query_subdevices| on</span>
<span class="sd">        an empty NetCDF file.  The error message shows that the method</span>
<span class="sd">        tries to query the (sub)device names both under the assumptions</span>
<span class="sd">        that variables have been isolated or not:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableBase</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import make_abc_testable, TestIO</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():</span>
<span class="sd">        ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;w&quot;)</span>
<span class="sd">        &gt;&gt;&gt; Var = make_abc_testable(NetCDFVariableBase)</span>
<span class="sd">        &gt;&gt;&gt; Var.subdevicenames = &quot;element1&quot;, &quot;element_2&quot;</span>
<span class="sd">        &gt;&gt;&gt; var = Var(&quot;flux_prec&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; var.query_subdevices(ncfile)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        OSError: NetCDF file `model.nc` does neither contain a variable \</span>
<span class="sd">named `flux_prec_station_id` nor `station_id` for defining the \</span>
<span class="sd">coordinate locations of variable `flux_prec`.</span>

<span class="sd">        (2) After inserting the (sub)device name, they can be queried</span>
<span class="sd">        and returned:</span>

<span class="sd">        &gt;&gt;&gt; var.insert_subdevices(ncfile)</span>
<span class="sd">        &gt;&gt;&gt; Var(&quot;flux_prec&quot;, isolate=False, timeaxis=1).query_subdevices(ncfile)</span>
<span class="sd">        [&#39;element1&#39;, &#39;element_2&#39;]</span>
<span class="sd">        &gt;&gt;&gt; Var(&#39;flux_prec&#39;, isolate=True, timeaxis=1).query_subdevices(ncfile)</span>
<span class="sd">        [&#39;element1&#39;, &#39;element_2&#39;]</span>

<span class="sd">        &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">varmapping</span><span class="p">[</span><span class="s1">&#39;subdevices&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">subdevices</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chars</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="n">subdevices</span><span class="p">][:]</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;NetCDF file `</span><span class="si">{</span><span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span><span class="si">}</span><span class="s2">` does neither contain a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;variable named `</span><span class="si">{</span><span class="n">tests</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">` nor `</span><span class="si">{</span><span class="n">tests</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">` for defining &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the coordinate locations of variable `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">chars2str</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span></div>

<div class="viewcode-block" id="NetCDFVariableBase.query_subdevice2index"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase.query_subdevice2index">[docs]</a>    <span class="k">def</span> <span class="nf">query_subdevice2index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Subdevice2Index</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a |Subdevice2Index| that maps the (sub)device names to</span>
<span class="sd">        their position within the given NetCDF file.</span>

<span class="sd">        Method |NetCDFVariableBase.query_subdevice2index| is based on</span>
<span class="sd">        |NetCDFVariableBase.query_subdevices|.  The returned</span>
<span class="sd">        |Subdevice2Index| object remembers the NetCDF file the</span>
<span class="sd">        (sub)device names stem from, allowing for clear error messages:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableBase, str2chars</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import make_abc_testable, TestIO</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():</span>
<span class="sd">        ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;w&quot;)</span>
<span class="sd">        &gt;&gt;&gt; Var = make_abc_testable(NetCDFVariableBase)</span>
<span class="sd">        &gt;&gt;&gt; Var.subdevicenames = [&quot;element3&quot;, &quot;element1&quot;, &quot;element1_1&quot;, &quot;element2&quot;]</span>
<span class="sd">        &gt;&gt;&gt; var = Var(&quot;flux_prec&quot;, isolate=True, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; var.insert_subdevices(ncfile)</span>
<span class="sd">        &gt;&gt;&gt; subdevice2index = var.query_subdevice2index(ncfile)</span>
<span class="sd">        &gt;&gt;&gt; subdevice2index.get_index(&quot;element1_1&quot;)</span>
<span class="sd">        2</span>
<span class="sd">        &gt;&gt;&gt; subdevice2index.get_index(&quot;element3&quot;)</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; subdevice2index.get_index(&quot;element5&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        OSError: No data for sequence `flux_prec` and (sub)device \</span>
<span class="sd">`element5` in NetCDF file `model.nc` available.</span>

<span class="sd">        Additionally, |NetCDFVariableBase.query_subdevice2index|</span>
<span class="sd">        checks for duplicates:</span>

<span class="sd">        &gt;&gt;&gt; ncfile[&quot;station_id&quot;][:] = str2chars(</span>
<span class="sd">        ...     [&quot;element3&quot;, &quot;element1&quot;, &quot;element1_1&quot;, &quot;element1&quot;])</span>
<span class="sd">        &gt;&gt;&gt; var.query_subdevice2index(ncfile)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        OSError: The NetCDF file `model.nc` contains duplicate (sub)device \</span>
<span class="sd">names for variable `flux_prec` (the first found duplicate is `element1`).</span>

<span class="sd">        &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subdevices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_subdevices</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_duplicate_exists</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">subdevices</span><span class="p">)</span>
        <span class="n">subdev2index</span> <span class="o">=</span> <span class="p">{</span><span class="n">subdev</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">subdev</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subdevices</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">Subdevice2Index</span><span class="p">(</span><span class="n">subdev2index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_test_duplicate_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">subdevices</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdevices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subdevices</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subdevices</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name2</span> <span class="ow">in</span> <span class="n">subdevices</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]:</span>
                    <span class="k">if</span> <span class="n">name1</span> <span class="o">==</span> <span class="n">name2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                            <span class="s2">&quot;The NetCDF file `</span><span class="si">%s</span><span class="s2">` contains duplicate &quot;</span>
                            <span class="s2">&quot;(sub)device names for variable `</span><span class="si">%s</span><span class="s2">` (the &quot;</span>
                            <span class="s2">&quot;first found duplicate is `</span><span class="si">%s</span><span class="s2">`).&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">get_filepath</span><span class="p">(</span><span class="n">ncfile</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name1</span><span class="p">)</span>
                        <span class="p">)</span>

<div class="viewcode-block" id="NetCDFVariableBase.sort_timeplaceentries"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase.sort_timeplaceentries">[docs]</a>    <span class="k">def</span> <span class="nf">sort_timeplaceentries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeentry</span><span class="p">,</span> <span class="n">placeentry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a |tuple| containing the given `timeentry` and `placeentry`</span>
<span class="sd">        sorted in agreement with the currently selected `timeaxis`.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableBase</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import make_abc_testable</span>
<span class="sd">        &gt;&gt;&gt; NCVar = make_abc_testable(NetCDFVariableBase)</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NCVar(&quot;flux_nkor&quot;, isolate=True, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.sort_timeplaceentries(&quot;time&quot;, &quot;place&quot;)</span>
<span class="sd">        (&#39;place&#39;, &#39;time&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;test&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.sort_timeplaceentries(&quot;time&quot;, &quot;place&quot;)</span>
<span class="sd">        (&#39;time&#39;, &#39;place&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeaxis</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">placeentry</span><span class="p">,</span> <span class="n">timeentry</span>
        <span class="k">return</span> <span class="n">timeentry</span><span class="p">,</span> <span class="n">placeentry</span></div>

<div class="viewcode-block" id="NetCDFVariableBase.get_timeplaceslice"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase.get_timeplaceslice">[docs]</a>    <span class="k">def</span> <span class="nf">get_timeplaceslice</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">placeindex</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Return a |tuple| for indexing a complete time series of a certain</span>
<span class="sd">        location available in |NetCDFVariableBase.array|.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableBase</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import make_abc_testable</span>
<span class="sd">        &gt;&gt;&gt; NCVar = make_abc_testable(NetCDFVariableBase)</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NCVar(&quot;flux_nkor&quot;, isolate=True, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.get_timeplaceslice(2)</span>
<span class="sd">        (2, slice(None, None, None))</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;test&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.get_timeplaceslice(2)</span>
<span class="sd">        (slice(None, None, None), 2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_timeplaceentries</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">placeindex</span><span class="p">))</span></div>

<div class="viewcode-block" id="NetCDFVariableBase.read"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase.read">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">timegrid_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read the data from the given NetCDF file.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="NetCDFVariableBase.write"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableBase.write">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write the data to the given NetCDF file.&quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_NetCDFVariableInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The NetCDFVariable object `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` does neither &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;handle time series data under the (sub)device name &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` nor does it define a member named `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">dir_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="DeepAndAggMixin"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.DeepAndAggMixin">[docs]</a><span class="k">class</span> <span class="nc">DeepAndAggMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mixin class for |NetCDFVariableDeep| and |NetCDFVariableAgg|&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subdevicenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;A |tuple| containing the device names.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">NetCDFVariableBase</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="DeepAndAggMixin.write"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.DeepAndAggMixin.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write the data to the given NetCDF file.</span>

<span class="sd">        See the general documentation on classes |NetCDFVariableDeep|</span>
<span class="sd">        and |NetCDFVariableAgg| for some examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">NetCDFVariableBase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_subdevices</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span>
        <span class="k">for</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
            <span class="n">create_dimension</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">create_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span>
        <span class="n">ncfile</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">array</span></div></div>


<div class="viewcode-block" id="AggAndFlatMixin"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.AggAndFlatMixin">[docs]</a><span class="k">class</span> <span class="nc">AggAndFlatMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mixin class for |NetCDFVariableAgg| and |NetCDFVariableFlat|.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The dimension names of the NetCDF variable.</span>

<span class="sd">        Usually, the string defined by property |IOSequence.descr_sequence|</span>
<span class="sd">        prefixes the first dimension name related to the location, which</span>
<span class="sd">        allows storing different sequences types in one NetCDF file:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableAgg</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableAgg(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.log(elements.element1.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.dimensions</span>
<span class="sd">        (&#39;flux_nkor_stations&#39;, &#39;time&#39;)</span>

<span class="sd">        But when isolating variables into separate NetCDF files, the</span>
<span class="sd">        variable specific suffix is omitted:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableAgg(&quot;flux_nkor&quot;, isolate=True, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.log(elements.element1.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.dimensions</span>
<span class="sd">        (&#39;stations&#39;, &#39;time&#39;)</span>

<span class="sd">        When using the first axis as the &quot;timeaxis&quot;, the order of the</span>
<span class="sd">        dimension names turns:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableAgg(&quot;flux_nkor&quot;, isolate=True, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.log(elements.element1.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.dimensions</span>
<span class="sd">        (&#39;time&#39;, &#39;stations&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">NetCDFVariableBase</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_timeplaceentries</span><span class="p">(</span>
            <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_timepoints&quot;</span><span class="p">],</span>
            <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_subdevices&quot;</span><span class="p">]),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NetCDFVariableDeep"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableDeep">[docs]</a><span class="k">class</span> <span class="nc">NetCDFVariableDeep</span><span class="p">(</span><span class="n">DeepAndAggMixin</span><span class="p">,</span> <span class="n">NetCDFVariableBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Relates some objects of a specific |IOSequence| subclass with</span>
<span class="sd">    a single NetCDF variable without modifying dimensionality.</span>

<span class="sd">    Suitable both for reading and writing time series of sequences of</span>
<span class="sd">    arbitrary dimensionality; performs no flattening.</span>

<span class="sd">    (1) We prepare some devices handling some sequences by applying</span>
<span class="sd">    function |prepare_io_example_1|.  We limit our attention to the</span>
<span class="sd">    returned elements, which handle the more diverse sequences:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, (element1, element2, element3) = prepare_io_example_1()</span>

<span class="sd">    (2) We define two |NetCDFVariableDeep| instances with different</span>
<span class="sd">    |NetCDFVariableDeep.array| structures and log the |lland_inputs.Nied|</span>
<span class="sd">    and |lland_fluxes.NKor| sequences of the first two elements:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableDeep</span>
<span class="sd">    &gt;&gt;&gt; var_nied = NetCDFVariableDeep(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element2):</span>
<span class="sd">    ...     seqs = element.model.sequences</span>
<span class="sd">    ...     var_nied.log(seqs.inputs.nied, seqs.inputs.nied.series)</span>
<span class="sd">    ...     var_nkor.log(seqs.fluxes.nkor, seqs.fluxes.nkor.series)</span>

<span class="sd">    (3) We prepare a (nearly) empty NetCDF file. &quot;Nearly&quot;, because</span>
<span class="sd">    all sequences have to be related to the same period, which is why</span>
<span class="sd">    usually a central instance of class |NetCDFFile| prepares and</span>
<span class="sd">    passes time information:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_dimension</span>
<span class="sd">    &gt;&gt;&gt; create_dimension(ncfile, &quot;time&quot;, 4)</span>

<span class="sd">    (4) We store the data of all logged sequences in the NetCDF file:</span>

<span class="sd">    &gt;&gt;&gt; var_nied.write(ncfile)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor.write(ncfile)</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>

<span class="sd">    (5) We set all values of the series of both selected sequences</span>
<span class="sd">    to -777 and check that they are in fact different from the original</span>
<span class="sd">    values available via attribute `testarray`:</span>

<span class="sd">    &gt;&gt;&gt; seq1 = element1.model.sequences.inputs.nied</span>
<span class="sd">    &gt;&gt;&gt; seq2 = element2.model.sequences.fluxes.nkor</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; for seq in (seq1, seq2):</span>
<span class="sd">    ...     seq.series = -777.0</span>
<span class="sd">    ...     print(numpy.any(seq.series == seq.testarray))</span>
<span class="sd">    False</span>
<span class="sd">    False</span>

<span class="sd">    (6) We again prepare two |NetCDFVariableDeep| instances and</span>
<span class="sd">    log the same sequences as above, open the existing NetCDF file</span>
<span class="sd">    for reading, read its data, and confirm that this data has been</span>
<span class="sd">    passed to both test sequences properly:</span>

<span class="sd">    &gt;&gt;&gt; nied1 = NetCDFVariableDeep(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; nkor1 = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element2):</span>
<span class="sd">    ...     sequences = element.model.sequences</span>
<span class="sd">    ...     nied1.log(sequences.inputs.nied, None)</span>
<span class="sd">    ...     nkor1.log(sequences.fluxes.nkor, None)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;r&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">    &gt;&gt;&gt; nied1.read(ncfile, pub.timegrids.init)</span>
<span class="sd">    &gt;&gt;&gt; nkor1.read(ncfile, pub.timegrids.init)</span>
<span class="sd">    &gt;&gt;&gt; for seq in (seq1, seq2):</span>
<span class="sd">    ...     print(numpy.all(seq.series == seq.testarray))</span>
<span class="sd">    True</span>
<span class="sd">    True</span>

<span class="sd">    (6) We confirm that trying to read data that has not been stored</span>
<span class="sd">    properly results in error messages like the following one:</span>

<span class="sd">    &gt;&gt;&gt; nied1.log(element3.model.sequences.inputs.nied, None)</span>
<span class="sd">    &gt;&gt;&gt; nied1.read(ncfile, pub.timegrids.init)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    OSError: No data for sequence `input_nied` and (sub)device `element3` \</span>
<span class="sd">in NetCDF file `model.nc` available.</span>

<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>

<span class="sd">    (7) We repeat the first few steps, but pass True to the constructor</span>
<span class="sd">    of |NetCDFVariableDeep| to indicate that we want to write each type</span>
<span class="sd">    of sequence into a separate NetCDF file.  Nevertheless, we try to</span>
<span class="sd">    store two different types of sequences into the same NetCDF file,</span>
<span class="sd">    which works for the first sequence (|lland_inputs.Nied|) but not</span>
<span class="sd">    for the second one (|lland_fluxes.NKor|):</span>


<span class="sd">    &gt;&gt;&gt; var_nied = NetCDFVariableDeep(&quot;input_nied&quot;, isolate=True, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=True, timeaxis=0)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element2):</span>
<span class="sd">    ...     seqs = element.model.sequences</span>
<span class="sd">    ...     var_nied.log(seqs.inputs.nied, seqs.inputs.nied.series)</span>
<span class="sd">    ...     var_nkor.log(seqs.fluxes.nkor, seqs.fluxes.nkor.series)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; create_dimension(ncfile, &quot;time&quot;, 4)</span>
<span class="sd">    &gt;&gt;&gt; var_nied.write(ncfile)</span>
<span class="sd">    &gt;&gt;&gt; try:</span>
<span class="sd">    ...     var_nkor.write(ncfile)</span>
<span class="sd">    ... except BaseException as exc:</span>
<span class="sd">    ...     print(exc)   # doctest: +ELLIPSIS</span>
<span class="sd">    While trying to add dimension `stations` with length `2` \</span>
<span class="sd">to the NetCDF file `model.nc`, the following error occurred: ...</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;r&quot;)</span>
<span class="sd">    &gt;&gt;&gt; seq1.series = 0.0</span>
<span class="sd">    &gt;&gt;&gt; var_nied.read(ncfile, pub.timegrids.init)</span>
<span class="sd">    &gt;&gt;&gt; seq1.series</span>
<span class="sd">    InfoArray([ 0.,  1.,  2.,  3.])</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NetCDFVariableDeep.get_slices"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableDeep.get_slices">[docs]</a>    <span class="k">def</span> <span class="nf">get_slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">IntOrSlice</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a |tuple| of one |int| and some |slice| objects to</span>
<span class="sd">        accesses all values of a certain device within</span>
<span class="sd">        |NetCDFVariableDeep.array|.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableDeep</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;test&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.get_slices(2, [3])</span>
<span class="sd">        (2, slice(None, None, None), slice(0, 3, None))</span>
<span class="sd">        &gt;&gt;&gt; ncvar.get_slices(4, (1, 2))</span>
<span class="sd">        (4, slice(None, None, None), slice(0, 1, None), slice(0, 2, None))</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;test&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.get_slices(4, (1, 2))</span>
<span class="sd">        (slice(None, None, None), 4, slice(0, 1, None), slice(0, 2, None))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeplaceslice</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">:</span>
            <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Required shape of |NetCDFVariableDeep.array|.</span>

<span class="sd">        For the default configuration, the first axis corresponds to the</span>
<span class="sd">        number of devices, and the second one to the number of timesteps.</span>
<span class="sd">        We show this for the 0-dimensional input sequence |lland_inputs.Nied|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableDeep</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     ncvar.log(element.model.sequences.inputs.nied, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.shape</span>
<span class="sd">        (3, 4)</span>

<span class="sd">        For higher dimensional sequences, each new entry corresponds</span>
<span class="sd">        to the maximum number of fields the respective sequences require.</span>
<span class="sd">        In the next example, we select the 1-dimensional sequence</span>
<span class="sd">        |lland_fluxes.NKor|.  The maximum number 3 (last value of the</span>
<span class="sd">        returned |tuple|) is due to the third element defining three</span>
<span class="sd">        hydrological response units:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     ncvar.log(element.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.shape</span>
<span class="sd">        (3, 4, 3)</span>

<span class="sd">        When using the first axis for time (`timeaxis=0`) the order of the</span>
<span class="sd">        first two |tuple| entries turns:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     ncvar.log(element.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.shape</span>
<span class="sd">        (4, 3, 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmb_place</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)</span>
        <span class="n">nmb_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
        <span class="n">nmb_others</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">nmb_others</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">nmb_others_max</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nmb_others</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_timeplaceentries</span><span class="p">(</span><span class="n">nmb_time</span><span class="p">,</span> <span class="n">nmb_place</span><span class="p">)</span> <span class="o">+</span> <span class="n">nmb_others_max</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The series data of all logged |IOSequence| objects contained</span>
<span class="sd">        in one single |numpy.ndarray|.</span>

<span class="sd">        The documentation on |NetCDFVariableDeep.shape| explains how</span>
<span class="sd">        |NetCDFVariableDeep.array| is structured.  The first example</span>
<span class="sd">        confirms that, for the default configuration, the first axis</span>
<span class="sd">        definces the location, while the second one defines time:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableDeep</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nied1 = element.model.sequences.inputs.nied</span>
<span class="sd">        ...     ncvar.log(nied1, nied1.series)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.array</span>
<span class="sd">        array([[  0.,   1.,   2.,   3.],</span>
<span class="sd">               [  4.,   5.,   6.,   7.],</span>
<span class="sd">               [  8.,   9.,  10.,  11.]])</span>

<span class="sd">        For higher dimensional sequences, |NetCDFVariableDeep.array|</span>
<span class="sd">        can contain missing values.  Such missing values show up for</span>
<span class="sd">        some fiels of the second example element, which defines only</span>
<span class="sd">        two hydrological response units instead of three:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nkor1 = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...     ncvar.log(nkor1, nkor1.series)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.array[1]</span>
<span class="sd">        array([[ 16.,  17.,  nan],</span>
<span class="sd">               [ 18.,  19.,  nan],</span>
<span class="sd">               [ 20.,  21.,  nan],</span>
<span class="sd">               [ 22.,  23.,  nan]])</span>

<span class="sd">        When using the first axis for time (`timeaxis=0`) the same data</span>
<span class="sd">        can be accessed with slightly different indexing:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nkor1 = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...     ncvar.log(nkor1, nkor1.series)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.array[:, 1]</span>
<span class="sd">        array([[ 16.,  17.,  nan],</span>
<span class="sd">               [ 18.,  19.,  nan],</span>
<span class="sd">               [ 20.,  21.,  nan],</span>
<span class="sd">               [ 22.,  23.,  nan]])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="n">subarray</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="n">descr</span><span class="p">]</span>
            <span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_slices</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span> <span class="o">=</span> <span class="n">subarray</span>
        <span class="k">return</span> <span class="n">array</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The dimension names of the NetCDF variable.</span>

<span class="sd">        Usually, the string defined by property |IOSequence.descr_sequence|</span>
<span class="sd">        prefixes all dimension names except the second one related to time,</span>
<span class="sd">        which allows storing different sequences in one NetCDF file:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableDeep</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.log(elements.element1.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.dimensions</span>
<span class="sd">        (&#39;flux_nkor_stations&#39;, &#39;time&#39;, &#39;flux_nkor_axis3&#39;)</span>

<span class="sd">        However, when isolating variables into separate NetCDF files, the</span>
<span class="sd">        sequence-specific suffix is omitted:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=True, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.log(elements.element1.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.dimensions</span>
<span class="sd">        (&#39;stations&#39;, &#39;time&#39;, &#39;axis3&#39;)</span>

<span class="sd">        When using the first axis as the &quot;timeaxis&quot;, the order of the</span>
<span class="sd">        first two dimension names turns:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableDeep(&quot;flux_nkor&quot;, isolate=True, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.log(elements.element1.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.dimensions</span>
<span class="sd">        (&#39;time&#39;, &#39;stations&#39;, &#39;axis3&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmb_timepoints</span> <span class="o">=</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_timepoints&quot;</span><span class="p">]</span>
        <span class="n">nmb_subdevices</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">dimmapping</span><span class="p">[</span><span class="s2">&quot;nmb_subdevices&quot;</span><span class="p">])</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_timeplaceentries</span><span class="p">(</span><span class="n">nmb_timepoints</span><span class="p">,</span> <span class="n">nmb_subdevices</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NDIM</span><span class="p">):</span>
            <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">axis</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span>

<div class="viewcode-block" id="NetCDFVariableDeep.read"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableDeep.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">timegrid_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read the data from the given NetCDF file.</span>

<span class="sd">        The argument `timegrid_data` defines the data period of the</span>
<span class="sd">        given NetCDF file.</span>

<span class="sd">        See the general documentation on class |NetCDFVariableDeep|</span>
<span class="sd">        for some examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">query_array</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">subdev2index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_subdevice2index</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subdevice</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">subdev2index</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">subdevice</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_slices</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">adjust_series</span><span class="p">(</span><span class="n">timegrid_data</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NetCDFVariableAgg"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableAgg">[docs]</a><span class="k">class</span> <span class="nc">NetCDFVariableAgg</span><span class="p">(</span><span class="n">DeepAndAggMixin</span><span class="p">,</span> <span class="n">AggAndFlatMixin</span><span class="p">,</span> <span class="n">NetCDFVariableBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Relates some objects of a specific |IOSequence| subclass with</span>
<span class="sd">    a single NetCDF variable when aggregation of data is required.</span>

<span class="sd">    Suitable for writing time series data only; performs no flattening.</span>

<span class="sd">    Essentially, class |NetCDFVariableAgg| is very similar to class</span>
<span class="sd">    |NetCDFVariableDeep| but a little bit simpler, as it handles</span>
<span class="sd">    arrays with fixed dimensionality and provides no functionality</span>
<span class="sd">    for reading data from NetCDF files.  Hence, the following examples</span>
<span class="sd">    are a selection of the of the more thoroughly explained examples</span>
<span class="sd">    of the documentation on class |NetCDFVariableDeep|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, (element1, element2, element3) = prepare_io_example_1()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableAgg</span>
<span class="sd">    &gt;&gt;&gt; var_nied = NetCDFVariableAgg(&quot;input_nied_mean&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor = NetCDFVariableAgg(&quot;flux_nkor_mean&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element2):</span>
<span class="sd">    ...     nied1 = element.model.sequences.inputs.nied</span>
<span class="sd">    ...     var_nied.log(nied1, nied1.average_series())</span>
<span class="sd">    ...     nkor1 = element.model.sequences.fluxes.nkor</span>
<span class="sd">    ...     var_nkor.log(nkor1, nkor1.average_series())</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_dimension</span>
<span class="sd">    &gt;&gt;&gt; create_dimension(ncfile, &quot;time&quot;, 4)</span>
<span class="sd">    &gt;&gt;&gt; var_nied.write(ncfile)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor.write(ncfile)</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>

<span class="sd">    As |NetCDFVariableAgg| provides no reading functionality, we</span>
<span class="sd">    show that the aggregated values are readily available by using</span>
<span class="sd">    the external NetCDF4 library directly.  Note the different shapes</span>
<span class="sd">    due to using the second axis for time (`timeaxis=1`, default) and</span>
<span class="sd">    using the first axis for time (`timeaxis=0`) for |lland_inputs.Nied|</span>
<span class="sd">    and |lland_fluxes.NKor|, respectively:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;r&quot;)</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; numpy.array(ncfile[&quot;input_nied_mean&quot;][:])</span>
<span class="sd">    array([[ 0.,  1.,  2.,  3.],</span>
<span class="sd">           [ 4.,  5.,  6.,  7.]])</span>

<span class="sd">    &gt;&gt;&gt; numpy.array(ncfile[&quot;flux_nkor_mean&quot;][:])</span>
<span class="sd">    array([[ 12. ,  16.5],</span>
<span class="sd">           [ 13. ,  18.5],</span>
<span class="sd">           [ 14. ,  20.5],</span>
<span class="sd">           [ 15. ,  22.5]])</span>

<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Required shape of |NetCDFVariableAgg.array|.</span>

<span class="sd">        For the default configuration, the first axis corresponds to the</span>
<span class="sd">        number of devices, and the second one to the number of timesteps.</span>
<span class="sd">        We show this for the 1-dimensional input sequence |lland_fluxes.NKor|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableAgg</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableAgg(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     ncvar.log(element.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.shape</span>
<span class="sd">        (3, 4)</span>

<span class="sd">        When using the first axis as the &quot;timeaxis&quot;, the order of |tuple|</span>
<span class="sd">        entries turns:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableAgg(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     ncvar.log(element.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.shape</span>
<span class="sd">        (4, 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_timeplaceentries</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The aggregated data of all logged |IOSequence| objects contained</span>
<span class="sd">        in one single |numpy.ndarray| object.</span>

<span class="sd">        The documentation on |NetCDFVariableAgg.shape| explains how</span>
<span class="sd">        |NetCDFVariableAgg.array| is structured.  This first example</span>
<span class="sd">        confirms that, under default configuration (`timeaxis=1`),</span>
<span class="sd">        the first axis corresponds to the location, while the second</span>
<span class="sd">        one corresponds to time:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableAgg</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableAgg(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nkor1 = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...     ncvar.log(nkor1, nkor1.average_series())</span>
<span class="sd">        &gt;&gt;&gt; ncvar.array</span>
<span class="sd">        array([[ 12. ,  13. ,  14. ,  15. ],</span>
<span class="sd">               [ 16.5,  18.5,  20.5,  22.5],</span>
<span class="sd">               [ 25. ,  28. ,  31. ,  34. ]])</span>

<span class="sd">        When using the first axis as the &quot;timeaxis&quot;, the resulting</span>
<span class="sd">        |NetCDFVariableAgg.array| is the transposed:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableAgg(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nkor1 = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...     ncvar.log(nkor1, nkor1.average_series())</span>
<span class="sd">        &gt;&gt;&gt; ncvar.array</span>
<span class="sd">        array([[ 12. ,  16.5,  25. ],</span>
<span class="sd">               [ 13. ,  18.5,  28. ],</span>
<span class="sd">               [ 14. ,  20.5,  31. ],</span>
<span class="sd">               [ 15. ,  22.5,  34. ]])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">subarray</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeplaceslice</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">subarray</span>
        <span class="k">return</span> <span class="n">array</span>

<div class="viewcode-block" id="NetCDFVariableAgg.read"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableAgg.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">timegrid_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Raise a |RuntimeError| in any case.</span>

<span class="sd">        This method always raises the following exception, to tell</span>
<span class="sd">        users why implementing a real reading functionality is not</span>
<span class="sd">        possible:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableAgg</span>
<span class="sd">        &gt;&gt;&gt; var_ = NetCDFVariableAgg(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; var_.read(None, None)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        RuntimeError: The process of aggregating values (of sequence \</span>
<span class="sd">`flux_nkor` and other sequences as well) is not invertible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;The process of aggregating values (of sequence `</span><span class="si">%s</span><span class="s2">` and &quot;</span>
            <span class="s2">&quot;other sequences as well) is not invertible.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="NetCDFVariableFlat"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableFlat">[docs]</a><span class="k">class</span> <span class="nc">NetCDFVariableFlat</span><span class="p">(</span><span class="n">AggAndFlatMixin</span><span class="p">,</span> <span class="n">NetCDFVariableBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Relates some objects of a specific |IOSequence| subclass with</span>
<span class="sd">    a single NetCDF variable when flattening of data is required.</span>

<span class="sd">    Suitable both for reading and writing time series of sequences of</span>
<span class="sd">    arbitrary dimensionality.</span>

<span class="sd">    The following examples on the usage of class |NetCDFVariableFlat|</span>
<span class="sd">    are identical to the ones on the usage of class |NetCDFVariableDeep|.</span>
<span class="sd">    We repeat the examples for testing purposes but refrain from repeating</span>
<span class="sd">    the explanations. The relevant difference in the NetCDF file</span>
<span class="sd">    structure should become clear when comparing the documentation on</span>
<span class="sd">    the different members of both classes.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, (element1, element2, element3) = prepare_io_example_1()</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlat</span>
<span class="sd">    &gt;&gt;&gt; var_nied = NetCDFVariableFlat(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor = NetCDFVariableFlat(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element2):</span>
<span class="sd">    ...     seqs = element.model.sequences</span>
<span class="sd">    ...     var_nied.log(seqs.inputs.nied, seqs.inputs.nied.series)</span>
<span class="sd">    ...     var_nkor.log(seqs.fluxes.nkor, seqs.fluxes.nkor.series)</span>


<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import netcdf4</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;w&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import create_dimension</span>
<span class="sd">    &gt;&gt;&gt; create_dimension(ncfile, &quot;time&quot;, 4)</span>

<span class="sd">    &gt;&gt;&gt; var_nied.write(ncfile)</span>
<span class="sd">    &gt;&gt;&gt; var_nkor.write(ncfile)</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>

<span class="sd">    &gt;&gt;&gt; seq1 = element1.model.sequences.inputs.nied</span>
<span class="sd">    &gt;&gt;&gt; seq2 = element2.model.sequences.fluxes.nkor</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; for seq in (seq1, seq2):</span>
<span class="sd">    ...     seq.series = -777.0</span>
<span class="sd">    ...     print(numpy.any(seq.series == seq.testarray))</span>
<span class="sd">    False</span>
<span class="sd">    False</span>

<span class="sd">    &gt;&gt;&gt; nied1 = NetCDFVariableFlat(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">    &gt;&gt;&gt; nkor1 = NetCDFVariableFlat(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">    &gt;&gt;&gt; for element in (element1, element2):</span>
<span class="sd">    ...     sequences = element.model.sequences</span>
<span class="sd">    ...     nied1.log(sequences.inputs.nied, None)</span>
<span class="sd">    ...     nkor1.log(sequences.fluxes.nkor, None)</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     ncfile = netcdf4.Dataset(&quot;model.nc&quot;, &quot;r&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">    &gt;&gt;&gt; nied1.read(ncfile, pub.timegrids.init)</span>
<span class="sd">    &gt;&gt;&gt; nkor1.read(ncfile, pub.timegrids.init)</span>
<span class="sd">    &gt;&gt;&gt; for seq in (seq1, seq2):</span>
<span class="sd">    ...     print(numpy.all(seq.series == seq.testarray))</span>
<span class="sd">    True</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; ncfile.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Required shape of |NetCDFVariableFlat.array|.</span>

<span class="sd">        For 0-dimensional sequences like |lland_inputs.Nied| and for the</span>
<span class="sd">        default configuration (`timeaxis=1`), the first axis corresponds</span>
<span class="sd">        to the number of devices, and the second one two the number of</span>
<span class="sd">        timesteps:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlat</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableFlat(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     ncvar.log(element.model.sequences.inputs.nied, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.shape</span>
<span class="sd">        (3, 4)</span>

<span class="sd">        For higher dimensional sequences, the first axis corresponds</span>
<span class="sd">        to &quot;subdevices&quot;, e.g. hydrological response units within</span>
<span class="sd">        different elements.  The 1-dimensional sequence |lland_fluxes.NKor|</span>
<span class="sd">        is logged for three elements with one, two, and three response</span>
<span class="sd">        units respectively, making up a sum of six subdevices:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableFlat(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     ncvar.log(element.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.shape</span>
<span class="sd">        (6, 4)</span>

<span class="sd">        When using the first axis as the &quot;timeaxis&quot;, the order of |tuple|</span>
<span class="sd">        entries turns:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableFlat(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     ncvar.log(element.model.sequences.fluxes.nkor, None)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.shape</span>
<span class="sd">        (4, 6)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_timeplaceentries</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span><span class="p">),</span>
            <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The series data of all logged |IOSequence| objects contained in</span>
<span class="sd">        one single |numpy.ndarray| object.</span>

<span class="sd">        The documentation on |NetCDFVariableAgg.shape| explains how</span>
<span class="sd">        |NetCDFVariableAgg.array| is structured.  The first example</span>
<span class="sd">        confirms that, under default configuration (`timeaxis=1`), the</span>
<span class="sd">        first axis corresponds to the location, while the second one</span>
<span class="sd">        corresponds to time:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlat</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableFlat(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nied1 = element.model.sequences.inputs.nied</span>
<span class="sd">        ...     ncvar.log(nied1, nied1.series)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.array</span>
<span class="sd">        array([[  0.,   1.,   2.,   3.],</span>
<span class="sd">               [  4.,   5.,   6.,   7.],</span>
<span class="sd">               [  8.,   9.,  10.,  11.]])</span>

<span class="sd">        Due to the flattening of higher dimensional sequences,</span>
<span class="sd">        their individual time series (e.g. of different hydrological</span>
<span class="sd">        response units) are spread over the rows of the array.</span>
<span class="sd">        For the 1-dimensional sequence |lland_fluxes.NKor|, the</span>
<span class="sd">        individual time series of the second element are stored</span>
<span class="sd">        in row two and three:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableFlat(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nkor1 = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...     ncvar.log(nkor1, nkor1.series)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.array[1:3]</span>
<span class="sd">        array([[ 16.,  18.,  20.,  22.],</span>
<span class="sd">               [ 17.,  19.,  21.,  23.]])</span>

<span class="sd">        When using the first axis as the &quot;timeaxis&quot;, the individual time</span>
<span class="sd">        series of the second element are stored in column two and three:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableFlat(&quot;flux_nkor&quot;, isolate=False, timeaxis=0)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nkor1 = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...     ncvar.log(nkor1, nkor1.series)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.array[:, 1:3]</span>
<span class="sd">        array([[ 16.,  17.],</span>
<span class="sd">               [ 18.,  19.],</span>
<span class="sd">               [ 20.,  21.],</span>
<span class="sd">               [ 22.,  23.]])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">idx0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">idxs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">seq</span><span class="p">,</span> <span class="n">subarray</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="n">subsubarray</span> <span class="o">=</span> <span class="n">subarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">idxs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">prod</span><span class="p">))]</span>
                <span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeplaceslice</span><span class="p">(</span><span class="n">idx0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">subsubarray</span>
                <span class="n">idx0</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">array</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subdevicenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;A |tuple| containing the (sub)device names.</span>

<span class="sd">        Property |NetCDFVariableFlat.subdevicenames| clarifies which</span>
<span class="sd">        row of |NetCDFVariableAgg.array| contains which time series.</span>
<span class="sd">        For 0-dimensional series like |lland_inputs.Nied|, the plain</span>
<span class="sd">        device names are returned</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.examples import prepare_io_example_1</span>
<span class="sd">        &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlat</span>
<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableFlat(&quot;input_nied&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nied1 = element.model.sequences.inputs.nied</span>
<span class="sd">        ...     ncvar.log(nied1, nied1.series)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.subdevicenames</span>
<span class="sd">        (&#39;element1&#39;, &#39;element2&#39;, &#39;element3&#39;)</span>

<span class="sd">        For higher dimensional sequences like |lland_fluxes.NKor|, an</span>
<span class="sd">        additional suffix defines the index of the respective subdevice.</span>
<span class="sd">        For example contains the third row of |NetCDFVariableAgg.array|</span>
<span class="sd">        the time series of the first hydrological response unit of the</span>
<span class="sd">        second element:</span>

<span class="sd">        &gt;&gt;&gt; ncvar = NetCDFVariableFlat(&quot;flux_nkor&quot;, isolate=False, timeaxis=1)</span>
<span class="sd">        &gt;&gt;&gt; for element in elements:</span>
<span class="sd">        ...     nkor1 = element.model.sequences.fluxes.nkor</span>
<span class="sd">        ...     ncvar.log(nkor1, nkor1.series)</span>
<span class="sd">        &gt;&gt;&gt; ncvar.subdevicenames[1:3]</span>
<span class="sd">        (&#39;element2_0&#39;, &#39;element2_1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">devicename</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">devicename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">prod</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">devicename</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Should return all &quot;subdevice index combinations&quot; for sequences</span>
<span class="sd">        with arbitrary dimensions:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariableFlat</span>
<span class="sd">        &gt;&gt;&gt; _product = NetCDFVariableFlat.__dict__[&quot;_product&quot;].__func__</span>
<span class="sd">        &gt;&gt;&gt; for comb in _product([1, 2, 3]):</span>
<span class="sd">        ...     print(comb)</span>
<span class="sd">        (0, 0, 0)</span>
<span class="sd">        (0, 0, 1)</span>
<span class="sd">        (0, 0, 2)</span>
<span class="sd">        (0, 1, 0)</span>
<span class="sd">        (0, 1, 1)</span>
<span class="sd">        (0, 1, 2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nmb</span><span class="p">)</span> <span class="k">for</span> <span class="n">nmb</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">))</span>

<div class="viewcode-block" id="NetCDFVariableFlat.read"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableFlat.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">timegrid_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read the data from the given NetCDF file.</span>

<span class="sd">        The argument `timegrid_data` defines the data period of the</span>
<span class="sd">        given NetCDF file.</span>

<span class="sd">        See the general documentation on class |NetCDFVariableFlat|</span>
<span class="sd">        for some examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">query_array</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">idxs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span>
        <span class="n">subdev2index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_subdevice2index</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">devicename</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeaxis</span><span class="p">:</span>
                    <span class="n">subshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span> <span class="o">+</span> <span class="n">seq</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span> <span class="o">+</span> <span class="n">seq</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">subarray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">subshape</span><span class="p">)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">devicename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="n">station</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">prod</span><span class="p">)</span>
                    <span class="n">idx0</span> <span class="o">=</span> <span class="n">subdev2index</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
                    <span class="n">subarray</span><span class="p">[</span><span class="n">idxs</span> <span class="o">+</span> <span class="n">prod</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeplaceslice</span><span class="p">(</span><span class="n">idx0</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">subdev2index</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">devicename</span><span class="p">)</span>
                <span class="n">subarray</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timeplaceslice</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">adjust_series</span><span class="p">(</span><span class="n">timegrid_data</span><span class="p">,</span> <span class="n">subarray</span><span class="p">)</span></div>

<div class="viewcode-block" id="NetCDFVariableFlat.write"><a class="viewcode-back" href="../../../netcdftools.html#hydpy.core.netcdftools.NetCDFVariableFlat.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write the data to the given NetCDF file.</span>

<span class="sd">        See the general documentation on class |NetCDFVariableFlat|</span>
<span class="sd">        for some examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_subdevices</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
        <span class="n">create_variable</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="n">ncfile</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/HydPy_Logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to.html">How to…</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework.html">Framework Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modelcollection.html">Model Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zbibliography.html">Bibliography</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 4.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.core.netcdftools</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, HydPy Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.2.
    </div>
  </body>
</html>