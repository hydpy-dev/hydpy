<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydpy.models.ga.ga_model &#8212; HydPy 6.2dev6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css?v=127cebf3" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
    
    <script src="../../../../_static/documentation_options.js?v=fd5328d9"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">HydPy 6.2dev6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.models.ga.ga_model</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/HydPy_Logo.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="../../../../index.html">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../example_projects.html">Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference_manual.html">Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zbibliography.html">Bibliography</a></li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hydpy.models.ga.ga_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. _`issue 89`: https://github.com/hydpy-dev/hydpy/issues/89</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># imports...</span>
<span class="c1"># ...from site-packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>

<span class="c1"># ...from HydPy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">importtools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">modeltools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core.typingtools</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.cythons</span><span class="w"> </span><span class="kn">import</span> <span class="n">modelutils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">soilinterfaces</span>

<span class="c1"># ...from hland</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models.ga</span><span class="w"> </span><span class="kn">import</span> <span class="n">ga_control</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models.ga</span><span class="w"> </span><span class="kn">import</span> <span class="n">ga_derived</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models.ga</span><span class="w"> </span><span class="kn">import</span> <span class="n">ga_inputs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models.ga</span><span class="w"> </span><span class="kn">import</span> <span class="n">ga_fluxes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models.ga</span><span class="w"> </span><span class="kn">import</span> <span class="n">ga_states</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models.ga</span><span class="w"> </span><span class="kn">import</span> <span class="n">ga_logs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models.ga</span><span class="w"> </span><span class="kn">import</span> <span class="n">ga_aides</span>


<div class="viewcode-block" id="Calc_SurfaceWaterSupply_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Calc_SurfaceWaterSupply_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calc_SurfaceWaterSupply_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Take rainfall as the possible supply for infiltration through the soil&#39;s</span>
<span class="sd">    surface.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`SurfaceWaterSupply = Rainfall`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; inputs.rainfall = 2.0</span>
<span class="sd">        &gt;&gt;&gt; model.calc_surfacewatersupply_v1()</span>
<span class="sd">        &gt;&gt;&gt; fluxes.surfacewatersupply</span>
<span class="sd">        surfacewatersupply(2.0, 2.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_inputs</span><span class="o">.</span><span class="n">Rainfall</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SurfaceWaterSupply</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">surfacewatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">rainfall</span></div>



<div class="viewcode-block" id="Calc_SoilWaterSupply_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Calc_SoilWaterSupply_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calc_SoilWaterSupply_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Take capillary rise as the possible supply for water additions through the</span>
<span class="sd">    soil&#39;s bottom.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`SoilWaterSupply = CapillaryRise`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; inputs.capillaryrise = 2.0</span>
<span class="sd">        &gt;&gt;&gt; model.calc_soilwatersupply_v1()</span>
<span class="sd">        &gt;&gt;&gt; fluxes.soilwatersupply</span>
<span class="sd">        soilwatersupply(2.0, 2.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_inputs</span><span class="o">.</span><span class="n">CapillaryRise</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterSupply</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">soilwatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">capillaryrise</span></div>



<div class="viewcode-block" id="Calc_Demand_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Calc_Demand_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calc_Demand_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Take evaporation as the demand for extracting water from the soil&#39;s surface and</span>
<span class="sd">     body.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`Demand = Evaporation`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; inputs.evaporation = 2.0</span>
<span class="sd">        &gt;&gt;&gt; model.calc_demand_v1()</span>
<span class="sd">        &gt;&gt;&gt; fluxes.demand</span>
<span class="sd">        demand(2.0, 2.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_inputs</span><span class="o">.</span><span class="n">Evaporation</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Demand</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">evaporation</span></div>



<div class="viewcode-block" id="Return_RelativeMoisture_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Return_RelativeMoisture_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Return_RelativeMoisture_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate and return the relative soil water content for the given bin-soil</span>
<span class="sd">    combination.</span>

<span class="sd">    Basic equation (:cite:t:`ref-Lai2015`, equation 11):</span>
<span class="sd">      :math:`RelativeMoisture =</span>
<span class="sd">      \frac{FrontMoisture - ResidualMoisture}{SaturationMoisture - ResidualMoisture}`</span>

<span class="sd">    Method |Return_RelativeMoisture_V1| prevents returning values smaller than zero or</span>
<span class="sd">    larger than one that might arise due to violations of the residualor saturation</span>
<span class="sd">    water content.</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(5)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5, 0.8)</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = [[0.0, 0.0],</span>
<span class="sd">        ...                    [0.1, 0.2],</span>
<span class="sd">        ...                    [0.3, 0.65],</span>
<span class="sd">        ...                    [0.5, 0.8],</span>
<span class="sd">        ...                    [1.0, 1.0]]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; for soil in range(2):</span>
<span class="sd">        ...     for bin_ in range(5):</span>
<span class="sd">        ...         print(f&quot;soil: {soil}, bin: {bin_} -&gt; relativemoisture &quot;, end=&quot;&quot;)</span>
<span class="sd">        ...         round_(model.return_relativemoisture_v1(bin_, soil))</span>
<span class="sd">        soil: 0, bin: 0 -&gt; relativemoisture 0.0</span>
<span class="sd">        soil: 0, bin: 1 -&gt; relativemoisture 0.0</span>
<span class="sd">        soil: 0, bin: 2 -&gt; relativemoisture 0.5</span>
<span class="sd">        soil: 0, bin: 3 -&gt; relativemoisture 1.0</span>
<span class="sd">        soil: 0, bin: 4 -&gt; relativemoisture 1.0</span>
<span class="sd">        soil: 1, bin: 0 -&gt; relativemoisture 0.0</span>
<span class="sd">        soil: 1, bin: 1 -&gt; relativemoisture 0.0</span>
<span class="sd">        soil: 1, bin: 2 -&gt; relativemoisture 0.75</span>
<span class="sd">        soil: 1, bin: 3 -&gt; relativemoisture 1.0</span>
<span class="sd">        soil: 1, bin: 4 -&gt; relativemoisture 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span> <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">moisture</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="n">moisture</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">moisture</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">residualmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">moisture</span> <span class="o">-</span> <span class="n">con</span><span class="o">.</span><span class="n">residualmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">con</span><span class="o">.</span><span class="n">residualmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="Return_Conductivity_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Return_Conductivity_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Return_Conductivity_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Based on the Brooks-Corey soil moisture characteristic model</span>
<span class="sd">    :cite:p:`ref-Brooks1966`, calculate and return the conductivity for the given</span>
<span class="sd">    bin-soil combination.</span>

<span class="sd">    Basic equation (:cite:t:`ref-Lai2015`, equation 11):</span>
<span class="sd">      :math:`Conductivity = SaturatedConductivity \cdot</span>
<span class="sd">      RelativeMoisture^{3 + 2 / PoreSizeDistribution}`</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(3)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5, 0.8)</span>
<span class="sd">        &gt;&gt;&gt; poresizedistribution(0.3, 0.4)</span>
<span class="sd">        &gt;&gt;&gt; saturatedconductivity(10.0, 20.0)</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = [[0.1, 0.0],</span>
<span class="sd">        ...                    [0.3, 0.5],</span>
<span class="sd">        ...                    [0.5, 1.0]]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; for soil in range(2):</span>
<span class="sd">        ...     for bin_ in range(3):</span>
<span class="sd">        ...         print(f&quot;soil: {soil}, bin: {bin_} -&gt; conductivity &quot;, end=&quot;&quot;)</span>
<span class="sd">        ...         round_(model.return_conductivity_v1(bin_, soil))</span>
<span class="sd">        soil: 0, bin: 0 -&gt; conductivity 0.0</span>
<span class="sd">        soil: 0, bin: 1 -&gt; conductivity 0.012304</span>
<span class="sd">        soil: 0, bin: 2 -&gt; conductivity 10.0</span>
<span class="sd">        soil: 1, bin: 0 -&gt; conductivity 0.0</span>
<span class="sd">        soil: 1, bin: 1 -&gt; conductivity 0.078125</span>
<span class="sd">        soil: 1, bin: 2 -&gt; conductivity 20.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span><span class="n">Return_RelativeMoisture_V1</span><span class="p">,)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">PoreSizeDistribution</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">return</span> <span class="n">con</span><span class="o">.</span><span class="n">saturatedconductivity</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">return_relativemoisture_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="o">**</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">con</span><span class="o">.</span><span class="n">poresizedistribution</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="Return_CapillaryDrive_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Return_CapillaryDrive_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Return_CapillaryDrive_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Based on the Brooks-Corey soil moisture characteristic model</span>
<span class="sd">    :cite:p:`ref-Brooks1966`, calculate and return the capillary drive between the</span>
<span class="sd">    water contents of the given bins for the defined soil.</span>

<span class="sd">    Basic equation (:cite:t:`ref-Lai2015`, equation 11):</span>
<span class="sd">      :math:`CapillaryDrive_{bin1,bin2} =</span>
<span class="sd">      \frac{AirEntryPotential}{3 \cdot PoreSizeDistribution + 1} \cdot</span>
<span class="sd">      \begin{cases}</span>
<span class="sd">      RelativeMoisture_{bin2}^{3 + 1 / PoreSizeDistribution} -</span>
<span class="sd">      RelativeMoisture_{bin1}^{3 + 1 / PoreSizeDistribution}</span>
<span class="sd">      &amp;|\ Moisture_{bin2} &lt; SaturationMoisture</span>
<span class="sd">      \\</span>
<span class="sd">      3 \cdot PoreSizeDistribution + 2 -</span>
<span class="sd">      RelativeMoisture_{bin1}^{3 + 1 / PoreSizeDistribution}</span>
<span class="sd">      &amp;|\ Moisture_{bin2} = SaturationMoisture</span>
<span class="sd">      \end{cases}`</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(3)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5, 0.8)</span>
<span class="sd">        &gt;&gt;&gt; airentrypotential(0.1, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; poresizedistribution(0.3, 0.4)</span>
<span class="sd">        &gt;&gt;&gt; saturatedconductivity(10.0, 20.0)</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = [[0.1, 0.0],</span>
<span class="sd">        ...                    [0.3, 0.5],</span>
<span class="sd">        ...                    [0.5, 1.0]]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; for soil in range(2):</span>
<span class="sd">        ...     for bin_ in range(2):</span>
<span class="sd">        ...         print(f&quot;soil: {soil}, bin: {bin_} -&gt; capillarydrive &quot;, end=&quot;&quot;)</span>
<span class="sd">        ...         round_(model.return_capillarydrive_v1(bin_, bin_ + 1, soil))</span>
<span class="sd">        soil: 0, bin: 0 -&gt; capillarydrive 0.000653</span>
<span class="sd">        soil: 0, bin: 1 -&gt; capillarydrive 0.151979</span>
<span class="sd">        soil: 1, bin: 0 -&gt; capillarydrive 0.002009</span>
<span class="sd">        soil: 1, bin: 1 -&gt; capillarydrive 0.2889</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span><span class="n">Return_RelativeMoisture_V1</span><span class="p">,)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">AirEntryPotential</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">PoreSizeDistribution</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">b1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">con</span><span class="o">.</span><span class="n">poresizedistribution</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3.0</span>
        <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b2</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
            <span class="n">subtrahend</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_relativemoisture_v1</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">**</span> <span class="n">exp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subtrahend</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">poresizedistribution</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">con</span><span class="o">.</span><span class="n">airentrypotential</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">subtrahend</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">return_relativemoisture_v1</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">**</span> <span class="n">exp</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">poresizedistribution</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="Percolate_FilledBin_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Percolate_FilledBin_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Percolate_FilledBin_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the percolation of water through the filled first bin due to</span>
<span class="sd">    gravitational forcing.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`Percolation = DT \cdot Conductivity`</span>

<span class="sd">    Example:</span>

<span class="sd">        For simplicity, we make each soil compartment&#39;s first (and only) bin saturated</span>
<span class="sd">        so that actual conductivity equals saturated conductivity:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(3)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(2)</span>
<span class="sd">        &gt;&gt;&gt; dt(0.5)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(100.0, 200.0, 300.0)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5)</span>
<span class="sd">        &gt;&gt;&gt; poresizedistribution(0.3)</span>
<span class="sd">        &gt;&gt;&gt; saturatedconductivity(6.0, 8.0, 10.0)</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = 0.5</span>
<span class="sd">        &gt;&gt;&gt; aides.actualsurfacewater = 2.0, 4.0, 6.0</span>
<span class="sd">        &gt;&gt;&gt; fluxes.percolation = 1.0</span>
<span class="sd">        &gt;&gt;&gt; for soil in range(3):</span>
<span class="sd">        ...     model.percolate_filledbin_v1(soil)</span>
<span class="sd">        &gt;&gt;&gt; aides.actualsurfacewater</span>
<span class="sd">        actualsurfacewater(0.0, 0.0, 1.0)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.percolation</span>
<span class="sd">        percolation(3.0, 5.0, 6.0)</span>

<span class="sd">        By the way, |Percolate_FilledBin_V1| sets the first bin&#39;s front depth to the</span>
<span class="sd">        respective soil compartment&#39;s depth:</span>

<span class="sd">        &gt;&gt;&gt; states.frontdepth</span>
<span class="sd">        frontdepth([[100.0, 200.0, 300.0],</span>
<span class="sd">                    [nan, nan, nan]])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span><span class="n">Return_RelativeMoisture_V1</span><span class="p">,</span> <span class="n">Return_Conductivity_V1</span><span class="p">)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">PoreSizeDistribution</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Percolation</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">potinfiltration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">return_conductivity_v1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">potinfiltration</span> <span class="o">&lt;</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">potinfiltration</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">percolation</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">potinfiltration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">percolation</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span></div>



<div class="viewcode-block" id="Return_DryDepth_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Return_DryDepth_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Return_DryDepth_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate and return the &quot;dry depth&quot;.</span>

<span class="sd">    Basic equations (:cite:t:`ref-Lai2015`, equation 7, modified, see `issue 89`_):</span>
<span class="sd">      :math:`</span>
<span class="sd">      \frac{\tau + \sqrt{\tau^2 + 4 \cdot \tau \cdot EffectiveCapillarySuction}}{2}`</span>

<span class="sd">      :math:`</span>
<span class="sd">      \tau = DT \cdot \frac{SaturatedConductivity}{SaturationMoisture - FrontMoisture}`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(3)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(2)</span>
<span class="sd">        &gt;&gt;&gt; dt(0.5)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1, 0.2, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5, 0.8, 0.8)</span>
<span class="sd">        &gt;&gt;&gt; poresizedistribution(0.3, 0.4, 0.4)</span>
<span class="sd">        &gt;&gt;&gt; saturatedconductivity(10.0, 20.0, 20.0)</span>
<span class="sd">        &gt;&gt;&gt; airentrypotential(0.1, 0.2, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; derived.effectivecapillarysuction.update()</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = [[0.3, 0.5, 0.8], [nan, nan, nan]]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; for soil in range(3):</span>
<span class="sd">        ...     round_(model.return_drydepth_v1(soil))</span>
<span class="sd">        25.151711</span>
<span class="sd">        33.621747</span>
<span class="sd">        inf</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">EffectiveCapillarySuction</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
            <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">con</span><span class="o">.</span><span class="n">dt</span>
                <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">saturatedconductivity</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">tau</span> <span class="o">+</span> <span class="p">(</span><span class="n">tau</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">der</span><span class="o">.</span><span class="n">effectivecapillarysuction</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">modelutils</span><span class="o">.</span><span class="n">inf</span></div>



<div class="viewcode-block" id="Return_LastActiveBin_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Return_LastActiveBin_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Return_LastActiveBin_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Find the index of the last active bin (that either contains a wetting front or</span>
<span class="sd">    uniform moisture over the complete soil depth).</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(3)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(3)</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = [[0.1, 0.1, 0.1],</span>
<span class="sd">        ...                    [0.1, 0.5, 0.5],</span>
<span class="sd">        ...                    [0.1, 1.0, 0.1]]</span>
<span class="sd">        &gt;&gt;&gt; for soil in range(3):</span>
<span class="sd">        ...     print(f&quot;soil: {soil} -&gt; bin: {model.return_lastactivebin_v1(soil)}&quot;)</span>
<span class="sd">        soil: 0 -&gt; bin: 0</span>
<span class="sd">        soil: 1 -&gt; bin: 2</span>
<span class="sd">        soil: 2 -&gt; bin: 1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">b</span>
        <span class="k">return</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="Active_Bin_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Active_Bin_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Active_Bin_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Activate a bin to the right of the bin with the given index.</span>

<span class="sd">    We need to activate another bin if the current last bin&#39;s moisture decreases and</span>
<span class="sd">    rainfall intensity exceeds saturated conductivity.</span>

<span class="sd">    Basic equations (related to :cite:t:`ref-Lai2015`):</span>
<span class="sd">      :math:`MoistureChange_{bin+1} =</span>
<span class="sd">      \frac{ActualSurfaceWater - DT \cdot 2 \cdot Conductivity_{bin}}{DryDepth}`</span>

<span class="sd">      :math:`Moisture_{bin+1} = Moisture_{bin} + MoistureChange_{bin+1}`</span>

<span class="sd">      :math:`Infiltration_{bin+1} = DT \cdot SaturatedConductivity \cdot</span>
<span class="sd">      \left( \frac{EffectiveCapillarySuction}{DryDepth} + 1 \right)`</span>

<span class="sd">      :math:`FrontDepth_{bin+1} = \frac{Infiltration_{bin+1}}{MoistureChange_{bin+1}}`</span>

<span class="sd">    The calculation of infiltration and the new front depth follows equation 4 of</span>
<span class="sd">    :cite:t:`ref-Lai2015`, except for using :math:`Moisture_{bin}` instead of</span>
<span class="sd">    :math:`ResidualMoisture` and :math:`Moisture_{bin+1}` instead of</span>
<span class="sd">    :math:`SaturationMoisture`.  Regarding the moisture change, :cite:t:`ref-Lai2015`</span>
<span class="sd">    does not seem to mention the given basic equation explicitly.</span>

<span class="sd">    Examples:</span>

<span class="sd">        Method |Active_Bin_V1| is a little complicated, so we perform multiple test</span>
<span class="sd">        calculations considering different special cases.  We use the following setting</span>
<span class="sd">        for all these test calculations.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(1)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(3)</span>
<span class="sd">        &gt;&gt;&gt; dt(0.25)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(1000.0)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5)</span>
<span class="sd">        &gt;&gt;&gt; airentrypotential(0.1)</span>
<span class="sd">        &gt;&gt;&gt; poresizedistribution(0.3)</span>
<span class="sd">        &gt;&gt;&gt; saturatedconductivity(10.0)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>
<span class="sd">        &gt;&gt;&gt; derived.effectivecapillarysuction.update()</span>

<span class="sd">        We define a test function that applies |Active_Bin_V1| for a definable initial</span>
<span class="sd">        surface water depth.  The function checks that the water volume remains</span>
<span class="sd">        unchanged, prints the moisture change, the resulting moisture state, and the</span>
<span class="sd">        depth of the new active front (as calculated by |Active_Bin_V1|), and</span>
<span class="sd">        additionally prints the related infiltration (which |Active_Bin_V1| does not</span>
<span class="sd">        calculate on its own):</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.objecttools import repr_, repr_values</span>
<span class="sd">        &gt;&gt;&gt; def check(actualsurfacewater):</span>
<span class="sd">        ...     states.moisture = [[0.1], [0.3], [0.1]]</span>
<span class="sd">        ...     states.frontdepth = [[1000.0], [500.0], [0.0]]</span>
<span class="sd">        ...     logs.moisturechange = [[nan], [-inf], [nan]]</span>
<span class="sd">        ...     aides.actualsurfacewater = actualsurfacewater</span>
<span class="sd">        ...     old_volume = round(model.watercontent + aides.actualsurfacewater[0], 12)</span>
<span class="sd">        ...     model.active_bin_v1(1, 0)</span>
<span class="sd">        ...     new_volume = round(model.watercontent + aides.actualsurfacewater[0], 12)</span>
<span class="sd">        ...     assert old_volume == new_volume</span>
<span class="sd">        ...     infiltration = actualsurfacewater - aides.actualsurfacewater[0]</span>
<span class="sd">        ...     print(f&quot;moisturechange: {repr_values(logs.moisturechange[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisture: {repr_values(states.moisture[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;infiltration: {repr_(infiltration)}&quot;)</span>
<span class="sd">        ...     print(f&quot;frontdepth: {repr_values(states.frontdepth[:, 0])}&quot;)</span>

<span class="sd">        The first example deals with a moderate rainfall intensity (a relatively small</span>
<span class="sd">        surface water depth), where everything works as described by the basic</span>
<span class="sd">        equations defined above:</span>

<span class="sd">        &gt;&gt;&gt; check(actualsurfacewater=1.0)</span>
<span class="sd">        moisturechange: nan, -inf, 0.155311</span>
<span class="sd">        moisture: 0.1, 0.3, 0.455311</span>
<span class="sd">        infiltration: 1.0</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 6.438686</span>

<span class="sd">        For high rainfall intensities, the calculated moisture change could result in</span>
<span class="sd">        the actual moisture exceeding the saturation moisture.  In such cases,</span>
<span class="sd">        |Active_Bin_V1| corrects the moisture but leaves the moisture change as is:</span>

<span class="sd">        ToDo: clip the moisture change?</span>

<span class="sd">        &gt;&gt;&gt; check(actualsurfacewater=5.0)</span>
<span class="sd">        moisturechange: nan, -inf, 0.780401</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5</span>
<span class="sd">        infiltration: 2.55963</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 12.798152</span>

<span class="sd">        A particularity of method |Active_Bin_V1| is to set the moisture change to its</span>
<span class="sd">        highest possible value if the original moisture change (following the basic</span>
<span class="sd">        equation) is negative.  Such situations can arise when the pre-existing active</span>
<span class="sd">        fronts have already infiltrated a significant amount of the rainfall available</span>
<span class="sd">        for the given numerical timestep:</span>

<span class="sd">        ToDo: set the moisture change to zero?</span>

<span class="sd">        &gt;&gt;&gt; check(actualsurfacewater=0.001)</span>
<span class="sd">        moisturechange: nan, -inf, 0.2</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5</span>
<span class="sd">        infiltration: 0.001</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 0.005</span>


<span class="sd">        Even for zero remaining surface water, |Active_Bin_V1| activates a bin and sets</span>
<span class="sd">        its moisture value to the saturation value (without calculating any</span>
<span class="sd">        infiltration):</span>

<span class="sd">        &gt;&gt;&gt; check(actualsurfacewater=0.0)</span>
<span class="sd">        moisturechange: nan, -inf, 0.2</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5</span>
<span class="sd">        infiltration: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 0.0</span>

<span class="sd">        A very special case is when the initially calculated moisture change (following</span>
<span class="sd">        the basic equation) is zero.  Only then, |Active_Bin_V1| refrains from</span>
<span class="sd">        activating another bin:</span>

<span class="sd">        |Active_Bin_V1| checks if the initially calculated moisture change (following</span>
<span class="sd">        the basic equation) is zero.  Only then does it refrain from activating another</span>
<span class="sd">        bin:</span>

<span class="sd">        &gt;&gt;&gt; actualsurfacewater=control.dt * 2.0 * model.return_conductivity_v1(1, 0)</span>
<span class="sd">        &gt;&gt;&gt; check(actualsurfacewater=actualsurfacewater)</span>
<span class="sd">        moisturechange: nan, -inf, 0.0</span>
<span class="sd">        moisture: 0.1, 0.3, 0.1</span>
<span class="sd">        infiltration: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 0.0</span>

<span class="sd">        The following two examples illustrate highly deviating ways of front activation</span>
<span class="sd">        around the &quot;zero moisture change&quot; case (the second example also shows that</span>
<span class="sd">        infiltration becomes restricted when the front depth would otherwise overshoot</span>
<span class="sd">        the soil depth):</span>

<span class="sd">        &gt;&gt;&gt; check(actualsurfacewater=actualsurfacewater-1e-5)</span>
<span class="sd">        moisturechange: nan, -inf, 0.2</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5</span>
<span class="sd">        infiltration: 0.006142</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 0.03071</span>

<span class="sd">        &gt;&gt;&gt; check(actualsurfacewater=actualsurfacewater+1e-5)</span>
<span class="sd">        moisturechange: nan, -inf, 0.000002</span>
<span class="sd">        moisture: 0.1, 0.3, 0.300002</span>
<span class="sd">        infiltration: 0.001563</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 1000.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">EffectiveCapillarySuction</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">drydepth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_drydepth_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">conductivity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_conductivity_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">conductivity</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">drydepth</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span>
                <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">deltamoisture</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="n">potinfiltration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">con</span><span class="o">.</span><span class="n">dt</span>
                <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">saturatedconductivity</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">der</span><span class="o">.</span><span class="n">effectivecapillarysuction</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">drydepth</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltamoisture</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">potinfiltration</span><span class="p">:</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">potinfiltration</span> <span class="o">/</span> <span class="n">deltamoisture</span>
                <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">potinfiltration</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">deltamoisture</span>
                <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span></div>



<div class="viewcode-block" id="Shift_Front_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Shift_Front_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Shift_Front_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Increase the selected bin&#39;s wetting front depth without modifying its relative</span>
<span class="sd">    moisture following a variation of the Talbot-Ogden equation</span>
<span class="sd">    :cite:p:`ref-Talbot2008`.</span>

<span class="sd">    Method |Shift_Front_V1| applies for active wetting front bins that are not the last</span>
<span class="sd">    active bin or that are saturated (|Moisture| equals |SaturationMoisture|).  The</span>
<span class="sd">    latter holds only for periods with rainfall intensity exceeding saturated</span>
<span class="sd">    conductivity.</span>

<span class="sd">    Basic equation (:cite:t:`ref-Lai2015`, equation 8, modified):</span>
<span class="sd">      :math:`FrontDepth_{bin, new} = FrontDepth_{bin, old} + DT \cdot</span>
<span class="sd">      \frac{Conductivity_{bin-1} - Conductivity_{bin}}</span>
<span class="sd">      {Moisture_{bin} - Moisture_{bin-1}} \cdot \left(1 +</span>
<span class="sd">      \frac{CapillaryDrive_{0, LastActiveBin} + InitialSurfaceWater}{FrontDepth_{bin}}</span>
<span class="sd">      \right)`</span>

<span class="sd">    Note the used equation deviates from equation 8 of :cite:t:`ref-Lai2015` in adding</span>
<span class="sd">    the initial surface water depth to the effective capillary drive, which increases</span>
<span class="sd">    infiltration.  Using |InitialSurfaceWater| instead of |ActualSurfaceWater| assures</span>
<span class="sd">    the bin processing order does not affect the individual infiltration rates.</span>

<span class="sd">    Examples:</span>

<span class="sd">        For comparison, we perform the following examples similar to those of method</span>
<span class="sd">        |Active_Bin_V1|.  The general setting is identical, except that we initialise</span>
<span class="sd">        one more bin:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(1)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(4)</span>
<span class="sd">        &gt;&gt;&gt; dt(0.25)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(1000.0)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5)</span>
<span class="sd">        &gt;&gt;&gt; airentrypotential(0.1)</span>
<span class="sd">        &gt;&gt;&gt; poresizedistribution(0.3)</span>
<span class="sd">        &gt;&gt;&gt; saturatedconductivity(10.0)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>
<span class="sd">        &gt;&gt;&gt; derived.effectivecapillarysuction.update()</span>

<span class="sd">        The test function also behaves similarly but allows for more modifications</span>
<span class="sd">        of the initial states, supports selecting the considered bin, and applies</span>
<span class="sd">        |Shift_Front_V1| instead of |Active_Bin_V1|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.objecttools import repr_, repr_values</span>
<span class="sd">        &gt;&gt;&gt; def check(</span>
<span class="sd">        ...         bin_, initialsurfacewater, actualsurfacewater, frontdepth, moisture</span>
<span class="sd">        ...     ):</span>
<span class="sd">        ...     states.moisture = [[m] for m in moisture]</span>
<span class="sd">        ...     states.frontdepth = [[fd] for fd in frontdepth]</span>
<span class="sd">        ...     logs.moisturechange = nan</span>
<span class="sd">        ...     aides.initialsurfacewater = initialsurfacewater</span>
<span class="sd">        ...     aides.actualsurfacewater = actualsurfacewater</span>
<span class="sd">        ...     old_volume = round(model.watercontent + aides.actualsurfacewater[0], 12)</span>
<span class="sd">        ...     model.shift_front_v1(bin_, 0)</span>
<span class="sd">        ...     new_volume = round(model.watercontent + aides.actualsurfacewater[0], 12)</span>
<span class="sd">        ...     assert old_volume == new_volume</span>
<span class="sd">        ...     infiltration = actualsurfacewater - aides.actualsurfacewater[0]</span>
<span class="sd">        ...     print(f&quot;moisturechange: {repr_values(logs.moisturechange[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisture: {repr_values(states.moisture[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;infiltration: {repr_(infiltration)}&quot;)</span>
<span class="sd">        ...     print(f&quot;frontdepth: {repr_values(states.frontdepth[:, 0])}&quot;)</span>

<span class="sd">        |Shift_Front_V1| is to be applied on non-last active wetting front bins and the</span>
<span class="sd">        last bin if it is saturated. We start with demonstrating its functionality for</span>
<span class="sd">        the latter case.</span>

<span class="sd">        The first example is standard so far that the given basic equation applies</span>
<span class="sd">        without additional restrictions and initial and actual surface water depths are</span>
<span class="sd">        identical.  2.75 mm of the available surface water infiltrate and shift the</span>
<span class="sd">        wetting front by about 13.75 mm:</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=2, initialsurfacewater=10.0, actualsurfacewater=10.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 500.0, 100.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.5, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, nan, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5, 0.1</span>
<span class="sd">        infiltration: 2.750428</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 113.752138, 0.0</span>

<span class="sd">        Next, we decrease the amount of available surface water to 1 mm but let the</span>
<span class="sd">        initial surface water depth at 10 mm.  Thus, the potential infiltration stays</span>
<span class="sd">        as is, but the actual infiltration reduces to 1 mm (and the front shift to</span>
<span class="sd">        5 mm):</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=2, initialsurfacewater=10.0, actualsurfacewater=1.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 500.0, 100.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.5, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, nan, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5, 0.1</span>
<span class="sd">        infiltration: 1.0</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 105.0, 0.0</span>

<span class="sd">        For small or zero initial front depths, |Shift_Front_V1| uses the method</span>
<span class="sd">        |Return_DryDepth_V1| to advance the front instead of the basic equation:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; round_(model.return_drydepth_v1(0))</span>
<span class="sd">        6.399076</span>
<span class="sd">        &gt;&gt;&gt; check(bin_=2, initialsurfacewater=10.0, actualsurfacewater=10.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 500.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.5, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, nan, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5, 0.1</span>
<span class="sd">        infiltration: 1.279815</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 6.399076, 0.0</span>

<span class="sd">        |Shift_Front_V1| prevents a wetting front from overshooting the soil depth but</span>
<span class="sd">        not the depth of other fronts:</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=2, initialsurfacewater=10.0, actualsurfacewater=10.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 999.0, 998.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.5, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, nan, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5, 0.1</span>
<span class="sd">        infiltration: 0.4</span>
<span class="sd">        frontdepth: 1000.0, 999.0, 1000.0, 0.0</span>

<span class="sd">        In principle, |Shift_Front_V1| works for the active, non-last bins as described</span>
<span class="sd">        above:</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=1, initialsurfacewater=10.0, actualsurfacewater=1.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 300.0, 200.0, 100.0],</span>
<span class="sd">        ...       moisture=[0.2, 0.3, 0.4, 0.5])</span>
<span class="sd">        moisturechange: nan, nan, nan, nan</span>
<span class="sd">        moisture: 0.2, 0.3, 0.4, 0.5</span>
<span class="sd">        infiltration: 0.003176</span>
<span class="sd">        frontdepth: 1000.0, 300.031762, 200.0, 100.0</span>

<span class="sd">        However, for these bins, it also applies to rain-free periods.  Then, its front</span>
<span class="sd">        shifts as usual while keeping its relative moisture.  As the considered bin</span>
<span class="sd">        cannot (completely) take the corrensponding absolute moisture decrease from the</span>
<span class="sd">        surface, it takes water from the last active bin instead, decreasing its depth</span>
<span class="sd">        but not its relative moisture:</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=1, initialsurfacewater=0.0, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 300.0, 200.0, 100.0],</span>
<span class="sd">        ...       moisture=[0.2, 0.3, 0.4, 0.5])</span>
<span class="sd">        moisturechange: nan, nan, nan, nan</span>
<span class="sd">        moisture: 0.2, 0.3, 0.4, 0.5</span>
<span class="sd">        infiltration: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 300.030738, 200.0, 99.969262</span>

<span class="sd">        If the last active bin does not contain enough water, the second-last bin must</span>
<span class="sd">        help out:</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=1, initialsurfacewater=0.0, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 300.0, 200.0, 0.01],</span>
<span class="sd">        ...       moisture=[0.2, 0.3, 0.4, 0.5])</span>
<span class="sd">        moisturechange: nan, nan, nan, 0.0</span>
<span class="sd">        moisture: 0.2, 0.3, 0.4, 0.2</span>
<span class="sd">        infiltration: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 300.030738, 199.979262, 0.0</span>

<span class="sd">        If all bins that possess higher relative moisture than the considered bin do</span>
<span class="sd">        not contain enough water, the shift of the wetting front becomes restricted:</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=1, initialsurfacewater=0.0, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 300.0, 0.02, 0.01],</span>
<span class="sd">        ...       moisture=[0.2, 0.3, 0.4, 0.5])</span>
<span class="sd">        moisturechange: nan, nan, 0.0, 0.0</span>
<span class="sd">        moisture: 0.2, 0.3, 0.2, 0.2</span>
<span class="sd">        infiltration: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 300.03, 0.0, 0.0</span>

<span class="sd">        All examples above show that |Shift_Front_V1| never modifies |MoistureChange|,</span>
<span class="sd">        except when deactivating a bin.  Then, it sets the moisture change to zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Return_RelativeMoisture_V1</span><span class="p">,</span>
        <span class="n">Return_LastActiveBin_V1</span><span class="p">,</span>
        <span class="n">Return_DryDepth_V1</span><span class="p">,</span>
        <span class="n">Return_Conductivity_V1</span><span class="p">,</span>
        <span class="n">Return_CapillaryDrive_V1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">AirEntryPotential</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">PoreSizeDistribution</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">EffectiveCapillarySuction</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_aides</span><span class="o">.</span><span class="n">InitialSurfaceWater</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">b_last</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_lastactivebin_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">drydepth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_drydepth_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">drydepth</span><span class="p">:</span>
            <span class="n">frontshift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">drydepth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cond1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_conductivity_v1</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">cond2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_conductivity_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">drive</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_capillarydrive_v1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b_last</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">frontshift</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">cond2</span> <span class="o">-</span> <span class="n">cond1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">drive</span> <span class="o">+</span> <span class="n">aid</span><span class="o">.</span><span class="n">initialsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">/</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>
        <span class="n">frontshift</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">frontshift</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>

        <span class="n">deltamoisture_b</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
        <span class="n">required</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">frontshift</span> <span class="o">*</span> <span class="n">deltamoisture_b</span>
        <span class="k">if</span> <span class="n">required</span> <span class="o">&lt;</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">frontshift</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">required</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">required</span> <span class="o">-=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">deltamoisture_b</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">b_last</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b_last</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">deltamoisture_bb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b_last</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b_last</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">available</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">deltamoisture_bb</span> <span class="o">*</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b_last</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">available</span> <span class="o">&lt;</span> <span class="n">required</span><span class="p">:</span>
                    <span class="n">required</span> <span class="o">-=</span> <span class="n">available</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">available</span> <span class="o">/</span> <span class="n">deltamoisture_b</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b_last</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b_last</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b_last</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b_last</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">required</span> <span class="o">/</span> <span class="n">deltamoisture_bb</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">required</span> <span class="o">/</span> <span class="n">deltamoisture_b</span>
                    <span class="k">break</span></div>



<div class="viewcode-block" id="Redistribute_Front_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Redistribute_Front_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Redistribute_Front_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Modify the selected bin&#39;s wetting front depth and relative moisture content</span>
<span class="sd">    based on a Green &amp; Ampt redistribution equation.</span>

<span class="sd">    |Redistribute_Front_V1| applies for the last active wetting front bin when rainfall</span>
<span class="sd">    intensity does not exceed saturated conductivity.</span>

<span class="sd">    Basic equations (:cite:t:`ref-Lai2015`, equation 6)</span>
<span class="sd">      :math:`p = \cases{1.7 &amp;| ActualSurfaceWater = 0 \\ 1.0 &amp;| ActualSurfaceWater &gt; 0}`</span>

<span class="sd">      :math:`MoistureChange_{bin} = \frac{1}{FrontDepth_{bin}} \cdot</span>
<span class="sd">      \left( ActualSurfaceWater - DT \cdot \left( Conductivity_{bin} -</span>
<span class="sd">      \frac{p \cdot SaturatedConductivity \cdot CapillaryDrive_{bin-1,bin}}</span>
<span class="sd">      {FrontDepth_{bin}} \right) \right)`</span>

<span class="sd">      :math:`Moisture_{bin,old} = Moisture_{bin,new} + MoistureChange_{bin}`</span>

<span class="sd">      :math:`Infiltration_{bin} = DT \cdot SaturatedConductivity \cdot</span>
<span class="sd">      \left( 1 + \frac{EffectiveCapillarySuction}{FrontDepth_{bin}} \right)`</span>

<span class="sd">      :math:`FrontDepth_{bin,new} = \frac{Infiltration_{bin} +</span>
<span class="sd">      FrontDepth_{bin,old} \cdot (Moisture_{bin,old} - Moisture_{bin-1})}</span>
<span class="sd">      {Moisture_{bin,new} - Moisture_{bin-1}}`</span>

<span class="sd">    :cite:t:`ref-Lai2015` define only the calculation of the moisture change</span>
<span class="sd">    explicitly.  The infiltration calculation and the corresponding shift of the</span>
<span class="sd">    wetting front depth rest on the GARTO source code provided by the authors.  One</span>
<span class="sd">    might have expected to use :math:`Conductivity_{bin}` and</span>
<span class="sd">    :math:`CapillaryDrive_{bin-1,bin}` instead of :math:`SaturatedConductivity` and</span>
<span class="sd">    :math:`EffectiveCapillarySuction`.  There is a remark of the authors (possibly</span>
<span class="sd">    concerning the :math:`CapillaryDrive_{bin-1,bin}` vs</span>
<span class="sd">    :math:`EffectiveCapillarySuction` issue only) that oscillations in infiltration</span>
<span class="sd">    rates might show up otherwise.  Maybe we can discuss this with the authors or</span>
<span class="sd">    investigate ourselves in more detail later.</span>

<span class="sd">    If the bin&#39;s initial front depth is zero, the basic equations for calculating</span>
<span class="sd">    moisture change and infiltration become obsolete.  |Redistribute_Front_V1| then</span>
<span class="sd">    proceeds as follows:</span>

<span class="sd">      :math:`MoistureChange_{bin} =</span>
<span class="sd">      (ActualSurfaceWater - DT \cdot  Conductivity_{bin-1}) / DryDepth`</span>

<span class="sd">      :math:`Infiltration_{bin} = DT \cdot SaturatedConductivity \cdot</span>
<span class="sd">      \left( 1 + \frac{EffectiveCapillarySuction}{DryDepth} \right)`</span>


<span class="sd">    Examples:</span>

<span class="sd">        For comparison, we perform the following examples similar to those of method</span>
<span class="sd">        |Shift_Front_V1|.  The general setting is identical:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1h&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(1)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(4)</span>
<span class="sd">        &gt;&gt;&gt; dt(0.25)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(1000.0)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5)</span>
<span class="sd">        &gt;&gt;&gt; airentrypotential(0.1)</span>
<span class="sd">        &gt;&gt;&gt; poresizedistribution(0.3)</span>
<span class="sd">        &gt;&gt;&gt; saturatedconductivity(10.0)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>
<span class="sd">        &gt;&gt;&gt; derived.effectivecapillarysuction.update()</span>

<span class="sd">        The test function behaves similarly.  However it neglects the initial surface</span>
<span class="sd">        water depth, which is not a relevant input to |Redistribute_Front_V1|, and</span>
<span class="sd">        considers percolation, which |Redistribute_Front_V1| might update when</span>
<span class="sd">        deactivating surface wetting fronts:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.objecttools import repr_, repr_values</span>
<span class="sd">        &gt;&gt;&gt; def check(bin_, actualsurfacewater, frontdepth, moisture):</span>
<span class="sd">        ...     states.moisture = [[m] for m in moisture]</span>
<span class="sd">        ...     states.frontdepth = [[fd] for fd in frontdepth]</span>
<span class="sd">        ...     logs.moisturechange = nan</span>
<span class="sd">        ...     aides.actualsurfacewater = actualsurfacewater</span>
<span class="sd">        ...     fluxes.percolation[0] = 0.0</span>
<span class="sd">        ...     old_volume = round(model.watercontent + aides.actualsurfacewater[0], 12)</span>
<span class="sd">        ...     model.redistribute_front_v1(bin_, 0)</span>
<span class="sd">        ...     new_volume = round(model.watercontent + aides.actualsurfacewater[0], 12)</span>
<span class="sd">        ...     assert old_volume == new_volume + fluxes.percolation[0]</span>
<span class="sd">        ...     infiltration = actualsurfacewater - aides.actualsurfacewater[0]</span>
<span class="sd">        ...     print(f&quot;moisturechange: {repr_values(logs.moisturechange[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisture: {repr_values(states.moisture[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;infiltration: {repr_(infiltration)}&quot;)</span>
<span class="sd">        ...     print(f&quot;percolation: {repr_(fluxes.percolation[0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;frontdepth: {repr_values(states.frontdepth[:, 0])}&quot;)</span>

<span class="sd">        In the first example, the given basic equations apply without modifications.</span>
<span class="sd">        Due to missing surface water, relative moisture decreases.  Consequently, the</span>
<span class="sd">        front&#39;s depth increases to keep the bin&#39;s total water volume:</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=2, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 500.0, 100.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.4, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, -0.001553, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.398447, 0.1</span>
<span class="sd">        infiltration: 0.0</span>
<span class="sd">        percolation: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 101.57736, 0.0</span>

<span class="sd">        With enough available surface water, the bin&#39;s relative soil moisture</span>
<span class="sd">        increases.  In the following example, this moisture increase outweighs the</span>
<span class="sd">        actual infiltration.  So the front depth must must decrease to keep the</span>
<span class="sd">        absolute water volume.</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=2, actualsurfacewater=5.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 500.0, 100.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.4, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, 0.048449, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.448449, 0.1</span>
<span class="sd">        infiltration: 2.503816</span>
<span class="sd">        percolation: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 84.229985, 0.0</span>

<span class="sd">        For zero initial front depth, |Redistribute_Front_V1| prefers the alternative</span>
<span class="sd">        equations for calculating moisture change and infiltration defined above:</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=2, actualsurfacewater=0.5,</span>
<span class="sd">        ...       frontdepth=[1000.0, 500.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.4, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, 0.077656, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.477656, 0.1</span>
<span class="sd">        infiltration: 0.5</span>
<span class="sd">        percolation: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 2.814434, 0.0</span>

<span class="sd">        |Redistribute_Front_V1| ensures the updated moisture content does not exceed</span>
<span class="sd">        the saturation content, even if the calculated moisture change suggests so:</span>

<span class="sd">        ToDo: clip moisture change?</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=2, actualsurfacewater=20.0,</span>
<span class="sd">        ...       frontdepth=[1000.0, 500.0, 100.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.4, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, 0.198449, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5, 0.1</span>
<span class="sd">        infiltration: 2.503816</span>
<span class="sd">        percolation: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 62.519079, 0.0</span>

<span class="sd">        A moisture decrease that would result in falling below the moisture value of</span>
<span class="sd">        the left neighbour bin causes the deactivation of the affected bin.  If the</span>
<span class="sd">        left neighbour contains an active wetting front, |Redistribute_Front_V1| adds</span>
<span class="sd">        the remaining soil water and infiltration to this bin by increasing its front</span>
<span class="sd">        depth:</span>

<span class="sd">        ToDo: What if the front depth of the left neigbour bin exceeds soil depth</span>
<span class="sd">              afterwards?</span>

<span class="sd">        &gt;&gt;&gt; check(bin_=2, actualsurfacewater=0.001,</span>
<span class="sd">        ...       frontdepth=[1000.0, 500.0, 100.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.30001, 0.1])</span>
<span class="sd">        moisturechange: nan, nan, 0.0, nan</span>
<span class="sd">        moisture: 0.1, 0.3, 0.1, 0.1</span>
<span class="sd">        infiltration: 0.001</span>
<span class="sd">        percolation: 0.0</span>
<span class="sd">        frontdepth: 1000.0, 500.01, 0.0, 0.0</span>

<span class="sd">        If the left neighbour is the first, completely &quot;filled&quot; bin, the remaining soil</span>
<span class="sd">        water and infiltration increase its moisture content:</span>

<span class="sd">        &gt;&gt;&gt; soildepth(500.0)</span>
<span class="sd">        &gt;&gt;&gt; check(bin_=1, actualsurfacewater=0.001,</span>
<span class="sd">        ...       frontdepth=[500.0, 100.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.3, 0.30001, 0.1, 0.1])</span>
<span class="sd">        moisturechange: nan, 0.0, nan, nan</span>
<span class="sd">        moisture: 0.300004, 0.300004, 0.300004, 0.300004</span>
<span class="sd">        infiltration: 0.001</span>
<span class="sd">        percolation: 0.0</span>
<span class="sd">        frontdepth: 500.0, 0.0, 0.0, 0.0</span>

<span class="sd">        ToDo: In the original GARTO code, the remaining soil water and infiltration</span>
<span class="sd">              become percolation.  However, when evaporation interferes with the</span>
<span class="sd">              original equations, this simplification can result in percolation rates</span>
<span class="sd">              larger than saturated conductivity.  We observed this in the</span>
<span class="sd">              :ref:`ga_garto_24h_1000mm_evap_continuous` example, where percolation was</span>
<span class="sd">              20 mm/h (the rainfall rate) in the 21st hour despite a saturated</span>
<span class="sd">              conductivity of 13.2 mm/h.  For our assumption, the percolation rate is</span>
<span class="sd">              12.8 mm/h.  Nevertheless, we should keep this deviation from the original</span>
<span class="sd">              implementation in mind for a while;  in case it brings unexpected side</span>
<span class="sd">              effects in future applications.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Return_RelativeMoisture_V1</span><span class="p">,</span>
        <span class="n">Return_DryDepth_V1</span><span class="p">,</span>
        <span class="n">Return_Conductivity_V1</span><span class="p">,</span>
        <span class="n">Return_CapillaryDrive_V1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">AirEntryPotential</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">PoreSizeDistribution</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">EffectiveCapillarySuction</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">conductivity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_conductivity_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">capillarydrive</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_capillarydrive_v1</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="mf">1.7</span>
            <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span>
                <span class="o">-</span> <span class="n">conductivity</span>
                <span class="o">-</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">saturatedconductivity</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">capillarydrive</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">potinfiltration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">con</span><span class="o">.</span><span class="n">dt</span>
                <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">saturatedconductivity</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">der</span><span class="o">.</span><span class="n">effectivecapillarysuction</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drydepth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_drydepth_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">conductivity</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_conductivity_v1</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">conductivity</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">drydepth</span>
            <span class="n">potinfiltration</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">con</span><span class="o">.</span><span class="n">dt</span>
                <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">saturatedconductivity</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">der</span><span class="o">.</span><span class="n">effectivecapillarysuction</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">drydepth</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">initialcontent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
        <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">potinfiltration</span><span class="p">:</span>
            <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">potinfiltration</span> <span class="o">+</span> <span class="n">initialcontent</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">potinfiltration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">initialcontent</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">volume</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">volume</span> <span class="o">/</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span><span class="p">):</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span></div>



<div class="viewcode-block" id="Infiltrate_WettingFrontBins_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Infiltrate_WettingFrontBins_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Infiltrate_WettingFrontBins_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Process infiltration into the wetting front bins.</span>

<span class="sd">    |Infiltrate_WettingFrontBins_V1| does not perform any calculations itself but</span>
<span class="sd">    selects the proper submethods to do so.  It either does nothing (if the filled bin</span>
<span class="sd">    is saturated) or calls |Redistribute_Front_V1|, |Shift_Front_V1|, or</span>
<span class="sd">    |Active_Bin_V1| (primarily depending on the initial surface water depth and the</span>
<span class="sd">    current moisture contents).</span>

<span class="sd">    |Infiltrate_WettingFrontBins_V1| is specifically designed for |ga_garto|.</span>

<span class="sd">    Examples:</span>

<span class="sd">        Instead of triggering actual calculations, we try to show how</span>
<span class="sd">        |Infiltrate_WettingFrontBins_V1| selects the mentioned methods based on mocking</span>
<span class="sd">        them.  Therefore, we must import the model in pure Python mode:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.importtools import reverse_model_wildcard_import</span>
<span class="sd">        &gt;&gt;&gt; reverse_model_wildcard_import()</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import pub, print_vector</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     from hydpy.models.ga import *</span>
<span class="sd">        ...     simulationstep(&quot;1h&quot;)</span>
<span class="sd">        ...     parameterstep(&quot;1h&quot;)</span>

<span class="sd">        We define only those parameters required for selecting the proper methods:</span>

<span class="sd">        &gt;&gt;&gt; nmbsoils(1)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(5)</span>
<span class="sd">        &gt;&gt;&gt; dt(0.25)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.6)</span>
<span class="sd">        &gt;&gt;&gt; saturatedconductivity(10.0)</span>

<span class="sd">        The following test function prepares the initial surface water depth, the</span>
<span class="sd">        (current) relative moisture, and the (previous) moisture change.  Afterwards,</span>
<span class="sd">        it replaces the mentioned methods with mocks, invokes</span>
<span class="sd">        |Infiltrate_WettingFrontBins_V1|, and prints the passed arguments of all mock</span>
<span class="sd">        calls:</span>

<span class="sd">        &gt;&gt;&gt; from unittest.mock import patch</span>
<span class="sd">        &gt;&gt;&gt; def check(initialsurfacewater, moisture, moisturechange):</span>
<span class="sd">        ...     states.moisture = [[m] for m in moisture]</span>
<span class="sd">        ...     logs.moisturechange = [[mc] for mc in moisturechange]</span>
<span class="sd">        ...     aides.initialsurfacewater = initialsurfacewater</span>
<span class="sd">        ...     with patch.object(</span>
<span class="sd">        ...         model, &quot;redistribute_front_v1&quot;</span>
<span class="sd">        ...     ) as redistribute_front_v1, patch.object(</span>
<span class="sd">        ...         model, &quot;shift_front_v1&quot;</span>
<span class="sd">        ...     ) as shift_front_v1, patch.object(</span>
<span class="sd">        ...         model, &quot;active_bin_v1&quot;</span>
<span class="sd">        ...     ) as active_bin_v1:</span>
<span class="sd">        ...         model.infiltrate_wettingfrontbins_v1(0)</span>
<span class="sd">        ...     for mock in (shift_front_v1, redistribute_front_v1, active_bin_v1):</span>
<span class="sd">        ...         if mock.called:</span>
<span class="sd">        ...             print(mock._extract_mock_name(), end=&quot;: &quot;)</span>
<span class="sd">        ...             print_vector([str(call)[4:] for call in mock.mock_calls])</span>

<span class="sd">        If the first (filled) bin is saturated, |Infiltrate_WettingFrontBins_V1| does</span>
<span class="sd">        nothing:</span>

<span class="sd">        &gt;&gt;&gt; check(initialsurfacewater=20.0,</span>
<span class="sd">        ...       moisture=[0.6, 0.6, 0.6, 0.6, 0.6],</span>
<span class="sd">        ...       moisturechange=[0.0, 0.0, 0.0, 0.0, 0.0])</span>

<span class="sd">        If a wetting front bin is saturated, |Infiltrate_WettingFrontBins_V1| calls</span>
<span class="sd">        either |Shift_Front_V1| or |Redistribute_Front_V1|, depending on whether</span>
<span class="sd">        the surface water depth (rainfall intensity) exceeds saturated conductivity or</span>
<span class="sd">        not:</span>

<span class="sd">        &gt;&gt;&gt; check(initialsurfacewater=20.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.6, 0.6, 0.6, 0.6],</span>
<span class="sd">        ...       moisturechange=[0.0, 0.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        shift_front_v1: (1, 0)</span>

<span class="sd">        &gt;&gt;&gt; check(initialsurfacewater=2.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.6, 0.6, 0.6, 0.6],</span>
<span class="sd">        ...       moisturechange=[0.0, 0.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        redistribute_front_v1: (1, 0)</span>

<span class="sd">        If all bins are active, |Infiltrate_WettingFrontBins_V1| calls |Shift_Front_V1|</span>
<span class="sd">        for all bins except for the last one, for which it calls</span>
<span class="sd">        |Redistribute_Front_V1|:</span>

<span class="sd">        &gt;&gt;&gt; check(initialsurfacewater=2.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.5],</span>
<span class="sd">        ...       moisturechange=[0.0, 0.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        shift_front_v1: (1, 0), (2, 0), (3, 0)</span>
<span class="sd">        redistribute_front_v1: (4, 0)</span>

<span class="sd">        If there is at least one inactivated bin and the last active bin is not</span>
<span class="sd">        saturated, |Infiltrate_WettingFrontBins_V1| either calls |Active_Bin_V1| to</span>
<span class="sd">        activate a new bin right to it or calls |Redistribute_Front_V1|, depending on</span>
<span class="sd">        whether rainfall intensity exceeds saturated conductivity and the active bin&#39;s</span>
<span class="sd">        relative moisture decreased previously or not:</span>

<span class="sd">        &gt;&gt;&gt; check(initialsurfacewater=20.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.0, 0.0, 0.0, -1.0, 0.0])</span>
<span class="sd">        shift_front_v1: (1, 0), (2, 0)</span>
<span class="sd">        active_bin_v1: (3, 0)</span>

<span class="sd">        &gt;&gt;&gt; check(initialsurfacewater=2.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.0, 0.0, 0.0, -1.0, 0.0])</span>
<span class="sd">        shift_front_v1: (1, 0), (2, 0)</span>
<span class="sd">        redistribute_front_v1: (3, 0)</span>

<span class="sd">        &gt;&gt;&gt; check(initialsurfacewater=20.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.0, 0.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        shift_front_v1: (1, 0), (2, 0)</span>
<span class="sd">        redistribute_front_v1: (3, 0)</span>

<span class="sd">        &gt;&gt;&gt; check(initialsurfacewater=2.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.0, 0.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        shift_front_v1: (1, 0), (2, 0)</span>
<span class="sd">        redistribute_front_v1: (3, 0)</span>

<span class="sd">        &gt;&gt;&gt; reverse_model_wildcard_import()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Return_RelativeMoisture_V1</span><span class="p">,</span>
        <span class="n">Return_DryDepth_V1</span><span class="p">,</span>
        <span class="n">Return_Conductivity_V1</span><span class="p">,</span>
        <span class="n">Return_CapillaryDrive_V1</span><span class="p">,</span>
        <span class="n">Active_Bin_V1</span><span class="p">,</span>
        <span class="n">Shift_Front_V1</span><span class="p">,</span>
        <span class="n">Redistribute_Front_V1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">AirEntryPotential</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">PoreSizeDistribution</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">EffectiveCapillarySuction</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_aides</span><span class="o">.</span><span class="n">InitialSurfaceWater</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">aid</span><span class="o">.</span><span class="n">initialsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">saturatedconductivity</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">redistribute_front_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">shift_front_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">redistribute_front_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">model</span><span class="o">.</span><span class="n">shift_front_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">aid</span><span class="o">.</span><span class="n">initialsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">con</span><span class="o">.</span><span class="n">saturatedconductivity</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">model</span><span class="o">.</span><span class="n">active_bin_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">redistribute_front_v1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">break</span></div>



<div class="viewcode-block" id="Merge_FrontDepthOvershootings_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Merge_FrontDepthOvershootings_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Merge_FrontDepthOvershootings_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Merge those neighbour bins where the wetting front&#39;s depth of the right</span>
<span class="sd">    neighbour exceeds the wetting front&#39;s depth of the left neighbour.</span>

<span class="sd">    Examples:</span>

<span class="sd">        For comparison, we perform the following examples similar to those of method</span>
<span class="sd">        |Active_Bin_V1|.  However, in contrast to |Active_Bin_V1|,</span>
<span class="sd">        |Merge_FrontDepthOvershootings_V1| only needs to know the number of available</span>
<span class="sd">        bins and their current states only, making the general set-up much shorter:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(1)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(5)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(1000.0)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>

<span class="sd">        Instead of accepting different values for the actual surface water depth, the</span>
<span class="sd">        test function here allows defining the respective front&#39;s depth, moisture and</span>
<span class="sd">        moisture change:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.objecttools import repr_, repr_values</span>
<span class="sd">        &gt;&gt;&gt; def check(frontdepth, moisture, moisturechange):</span>
<span class="sd">        ...     states.frontdepth = [[fd] for fd in frontdepth]</span>
<span class="sd">        ...     states.moisture = [[m] for m in moisture]</span>
<span class="sd">        ...     logs.moisturechange = [[mc] for mc in moisturechange]</span>
<span class="sd">        ...     old_volume = round(model.watercontent, 12)</span>
<span class="sd">        ...     model.merge_frontdepthovershootings_v1(0)</span>
<span class="sd">        ...     new_volume = round(model.watercontent, 12)</span>
<span class="sd">        ...     assert old_volume == new_volume</span>
<span class="sd">        ...     print(f&quot;frontdepth: {repr_values(states.frontdepth[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisture: {repr_values(states.moisture[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisturechange: {repr_values(logs.moisturechange[:, 0])}&quot;)</span>

<span class="sd">        Nothing happens as long as all bins have smaller front depths than their left</span>
<span class="sd">        neighbours.  Note that |Merge_FrontDepthOvershootings_V1| also becomes active</span>
<span class="sd">        only if relative moisture increases from left to right.  Hence, in the</span>
<span class="sd">        following example, there is no merging of the two inactive bins, which (as</span>
<span class="sd">        usual) both have zero front depths:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 500.0, 100.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.5, 0.1, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.2, 0.4, 0.6, 0.0, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 100.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5, 0.1, 0.1</span>
<span class="sd">        moisturechange: 0.2, 0.4, 0.6, 0.0, 0.0</span>

<span class="sd">        For equal depths, |Merge_FrontDepthOvershootings_V1| deactivates the left</span>
<span class="sd">        neighbour bin and sets the moisture change of the left neighbour to zero:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 500.0, 500.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.5, 0.1, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.2, 0.4, 0.6, 0.0, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 500.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.1, 0.5, 0.1, 0.1, 0.1</span>
<span class="sd">        moisturechange: 0.2, 0.0, 0.0, 0.0, 0.0</span>

<span class="sd">        In case of an overshooting, |Merge_FrontDepthOvershootings_V1| must add the</span>
<span class="sd">        (additional) water content of the (deactivated) right neighbour to the</span>
<span class="sd">        (preserved) left neighbour:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 500.0, 600.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.5, 0.1, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.2, 0.4, 0.6, 0.0, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 550.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.1, 0.5, 0.1, 0.1, 0.1</span>
<span class="sd">        moisturechange: 0.2, 0.0, 0.0, 0.0, 0.0</span>

<span class="sd">        All right neighbours of a deactivated bin move (at least) one place to the</span>
<span class="sd">        left:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 500.0, 600.0, 400.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.2, 0.4, 0.6, 0.8, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 550.0, 400.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.1, 0.3, 0.4, 0.1, 0.1</span>
<span class="sd">        moisturechange: 0.2, 0.0, 0.8, 0.0, 0.0</span>

<span class="sd">        If the last bin is active, it gets properly deactivated:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 500.0, 600.0, 400.0, 300.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.5],</span>
<span class="sd">        ...       moisturechange=[0.2, 0.4, 0.6, 0.8, 1.0])</span>
<span class="sd">        frontdepth: 1000.0, 550.0, 400.0, 300.0, 0.0</span>
<span class="sd">        moisture: 0.1, 0.3, 0.4, 0.5, 0.1</span>
<span class="sd">        moisturechange: 0.2, 0.0, 0.8, 1.0, 0.0</span>

<span class="sd">        The two last examples demonstrate that the underlying algorithm works stably in</span>
<span class="sd">        case multiple mergings are necessary:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 500.0, 600.0, 700.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.2, 0.4, 0.6, 0.8, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 600.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.1, 0.4, 0.1, 0.1, 0.1</span>
<span class="sd">        moisturechange: 0.2, 0.0, 0.0, 0.0, 0.0</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 500.0, 600.0, 400.0, 500.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.5],</span>
<span class="sd">        ...       moisturechange=[0.2, 0.4, 0.6, 0.8, 1.0])</span>
<span class="sd">        frontdepth: 1000.0, 550.0, 450.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.1, 0.3, 0.5, 0.1, 0.1</span>
<span class="sd">        moisturechange: 0.2, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">content_thisbin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">content_lastbin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">content_thisbin</span> <span class="o">+</span> <span class="n">content_lastbin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
                        <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                        <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                        <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">bb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                        <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">bb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">b</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">b</span> <span class="o">-=</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="Merge_SoilDepthOvershootings_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Merge_SoilDepthOvershootings_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Merge_SoilDepthOvershootings_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Merge bins with wetting front depth larger than soil depth with their</span>
<span class="sd">    left neighbour bins and add their water excess to percolation.</span>

<span class="sd">    |Merge_SoilDepthOvershootings_V1| assumes proper sorting of wetting front depths</span>
<span class="sd">    (decreasing from left to right), as ensured by |Merge_FrontDepthOvershootings_V1|.</span>

<span class="sd">    Examples:</span>

<span class="sd">        For comparison, we perform the following examples similar to those of the</span>
<span class="sd">        related method |Merge_FrontDepthOvershootings_V1|.  The general setting is</span>
<span class="sd">        identical:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(1)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(5)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(1000.0)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>

<span class="sd">        The test function is similar but must also consider percolation:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.objecttools import repr_, repr_values</span>
<span class="sd">        &gt;&gt;&gt; def check(frontdepth, moisture, moisturechange):</span>
<span class="sd">        ...     states.frontdepth = [[fd] for fd in frontdepth]</span>
<span class="sd">        ...     states.moisture = [[m] for m in moisture]</span>
<span class="sd">        ...     logs.moisturechange = [[mc] for mc in moisturechange]</span>
<span class="sd">        ...     fluxes.percolation = 0.0</span>
<span class="sd">        ...     old_volume = round(model.watercontent, 12)</span>
<span class="sd">        ...     model.merge_soildepthovershootings_v1(0)</span>
<span class="sd">        ...     new_volume = round(model.watercontent + fluxes.percolation[0], 12)</span>
<span class="sd">        ...     assert old_volume == new_volume</span>
<span class="sd">        ...     print(f&quot;frontdepth: {repr_values(states.frontdepth[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisture: {repr_values(states.moisture[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisturechange: {repr_values(logs.moisturechange[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;percolation: {repr_(fluxes.percolation[0])}&quot;)</span>

<span class="sd">        Nothing happens as long as all bins have smaller front depths than their left</span>
<span class="sd">        neighbours.  Note that |Merge_SoilDepthOvershootings_V1| also becomes active</span>
<span class="sd">        only if relative moisture increases from left to right.  Hence, in the</span>
<span class="sd">        following example, there is no merging of the two inactive bins, which (as</span>
<span class="sd">        usual) both have zero front depths:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 900.0, 800.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.1, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.0, 1.0, 2.0, 0.0, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 900.0, 800.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.1, 0.2, 0.3, 0.1, 0.1</span>
<span class="sd">        moisturechange: 0.0, 1.0, 2.0, 0.0, 0.0</span>
<span class="sd">        percolation: 0.0</span>

<span class="sd">        If a single front&#39;s depth reaches the soil bottom exactly,</span>
<span class="sd">        |Merge_SoilDepthOvershootings_V1| deactivates the affected bin and takes its</span>
<span class="sd">        relative moisture value as the new initial moisture:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 1000.0, 0.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.1, 0.1, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.0, 1.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.2, 0.2, 0.2, 0.2, 0.2</span>
<span class="sd">        moisturechange: 0.0, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        percolation: 0.0</span>

<span class="sd">        Parts of the front lying below the soil&#39;s bottom become percolation:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 1100.0, 0.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.1, 0.1, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.0, 1.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.2, 0.2, 0.2, 0.2, 0.2</span>
<span class="sd">        moisturechange: 0.0, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        percolation: 10.0</span>

<span class="sd">        All remaining active wetting front bins move (at least) one place to the left:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 1100.0, 800.0, 700.0, 600.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.5],</span>
<span class="sd">        ...       moisturechange=[0.0, 1.0, 2.0, 3.0, 4.0])</span>
<span class="sd">        frontdepth: 1000.0, 800.0, 700.0, 600.0, 0.0</span>
<span class="sd">        moisture: 0.2, 0.3, 0.4, 0.5, 0.2</span>
<span class="sd">        moisturechange: 0.0, 2.0, 3.0, 4.0, 0.0</span>
<span class="sd">        percolation: 10.0</span>

<span class="sd">        The two last examples demonstrate that the underlying algorithm works stably in</span>
<span class="sd">        case multiple mergings are necessary:</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 1200.0, 1100.0, 700.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.1],</span>
<span class="sd">        ...       moisturechange=[0.0, 1.0, 2.0, 3.0, 0.0])</span>
<span class="sd">        frontdepth: 1000.0, 700.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.3, 0.4, 0.3, 0.3, 0.3</span>
<span class="sd">        moisturechange: 0.0, 3.0, 0.0, 0.0, 0.0</span>
<span class="sd">        percolation: 30.0</span>

<span class="sd">        &gt;&gt;&gt; check(frontdepth=[1000.0, 1200.0, 1200.0, 1100.0, 1100.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4, 0.5],</span>
<span class="sd">        ...       moisturechange=[0.0, 1.0, 2.0, 3.0, 4.0])</span>
<span class="sd">        frontdepth: 1000.0, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisture: 0.5, 0.5, 0.5, 0.5, 0.5</span>
<span class="sd">        moisturechange: 0.0, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        percolation: 60.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span> <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Percolation</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">percolation</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Water_AllBins_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Water_AllBins_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Water_AllBins_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Water the soil&#39;s body by (potentially) adding water to all active bins.</span>

<span class="sd">    The soil water addition calculated by |Water_AllBins_V1| equals the defined soil</span>
<span class="sd">    water supply, except adding the complete supply would exceed the saturation water</span>
<span class="sd">    content.</span>

<span class="sd">    Note that the caller needs to pass the supply as a method parameter, which allows</span>
<span class="sd">    him to decide whether to add everything in one simulation step or multiple</span>
<span class="sd">    numerical substeps.</span>

<span class="sd">    Examples:</span>

<span class="sd">        We prepare a single shallow soil compartment divided into four bins:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(1)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(4)</span>
<span class="sd">        &gt;&gt;&gt; dt(0.5)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(100.0)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>

<span class="sd">        The following test function works similar to the one defined for demonstrating</span>
<span class="sd">        |Active_Bin_V1| but considers the soil water addition instead of infiltration:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.objecttools import repr_, repr_values</span>
<span class="sd">        &gt;&gt;&gt; def check(soilwatersupply, moisture, frontdepth):</span>
<span class="sd">        ...     fluxes.soilwatersupply[0] = soilwatersupply</span>
<span class="sd">        ...     states.moisture = [[m] for m in moisture]</span>
<span class="sd">        ...     states.frontdepth = [[fd] for fd in frontdepth]</span>
<span class="sd">        ...     logs.moisturechange = [[1.0], [2.0], [3.0], [4.0]]</span>
<span class="sd">        ...     fluxes.soilwateraddition[0] = 0.0</span>
<span class="sd">        ...     old_volume = round(model.watercontent, 12)</span>
<span class="sd">        ...     model.water_allbins_v1(0, soilwatersupply)</span>
<span class="sd">        ...     new_volume = round(model.watercontent, 12)</span>
<span class="sd">        ...     assert old_volume + fluxes.soilwateraddition[0] == new_volume</span>
<span class="sd">        ...     print(f&quot;soilwatersupply: {repr_(fluxes.soilwatersupply[0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisture: {repr_values(states.moisture[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;frontdepth: {repr_values(states.frontdepth[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisturechange: {repr_values(logs.moisturechange[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;soilwateraddition: {repr_(fluxes.soilwateraddition[0])}&quot;)</span>

<span class="sd">        For zero soil water supply, |Water_AllBins_V1| does nothing:</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=0.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1],</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0])</span>
<span class="sd">        soilwatersupply: 0.0</span>
<span class="sd">        moisture: 0.1, 0.3, 0.1, 0.1</span>
<span class="sd">        frontdepth: 100.0, 50.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 1.0, 2.0, 3.0, 4.0</span>
<span class="sd">        soilwateraddition: 0.0</span>

<span class="sd">        |Water_AllBins_V1| tries to add the supply to the dryest bin by increasing its</span>
<span class="sd">        relative moisture content:</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=5.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1],</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0])</span>
<span class="sd">        soilwatersupply: 5.0</span>
<span class="sd">        moisture: 0.2, 0.3, 0.2, 0.2</span>
<span class="sd">        frontdepth: 100.0, 50.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 2.0, 3.0, 4.0</span>
<span class="sd">        soilwateraddition: 5.0</span>

<span class="sd">        If a bin is not the last active bin, its highest possible moisture content is</span>
<span class="sd">        restricted by the relative moisture value of its right neighbour bin.  If two</span>
<span class="sd">        bins get the same moisture, one of them becomes obsolete, so we can remove it</span>
<span class="sd">        and shift all its right neighbours one place to the left:</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=10.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1],</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0])</span>
<span class="sd">        soilwatersupply: 10.0</span>
<span class="sd">        moisture: 0.3, 0.3, 0.3, 0.3</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 3.0, 4.0, 0.0</span>
<span class="sd">        soilwateraddition: 10.0</span>

<span class="sd">        If the first bin cannot take enough water, |Water_AllBins_V1| updates the front</span>
<span class="sd">        depth and increases the water content of the second bin:</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=20.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1],</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0])</span>
<span class="sd">        soilwatersupply: 20.0</span>
<span class="sd">        moisture: 0.4, 0.4, 0.4, 0.4</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 3.0, 4.0, 0.0</span>
<span class="sd">        soilwateraddition: 20.0</span>

<span class="sd">        However, no bin can possess relative moisture higher than indicated by</span>
<span class="sd">        saturation moisture:</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=40.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1],</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0])</span>
<span class="sd">        soilwatersupply: 40.0</span>
<span class="sd">        moisture: 0.5, 0.5, 0.5, 0.5</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 3.0, 4.0, 0.0</span>
<span class="sd">        soilwateraddition: 30.0</span>

<span class="sd">        |Water_AllBins_V1| deactivates multiple bins when necessary:</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=40.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.5, 0.1],</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0])</span>
<span class="sd">        soilwatersupply: 40.0</span>
<span class="sd">        moisture: 0.5, 0.5, 0.5, 0.5</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 4.0, 0.0, 0.0</span>
<span class="sd">        soilwateraddition: 30.0</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=10.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4],</span>
<span class="sd">        ...       frontdepth=[100.0, 75.0, 50.0, 25.0])</span>
<span class="sd">        soilwatersupply: 10.0</span>
<span class="sd">        moisture: 0.333333, 0.4, 0.333333, 0.333333</span>
<span class="sd">        frontdepth: 100.0, 25.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 4.0, 0.0, 0.0</span>
<span class="sd">        soilwateraddition: 10.0</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=30.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4],</span>
<span class="sd">        ...       frontdepth=[100.0, 75.0, 50.0, 25.0])</span>
<span class="sd">        soilwatersupply: 30.0</span>
<span class="sd">        moisture: 0.5, 0.5, 0.5, 0.5</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">        soilwateraddition: 25.0</span>

<span class="sd">        The last two examples demonstrate, similar to the first example, that</span>
<span class="sd">        |Water_AllBins_V1| adjusts the relative moisture value of all non-active bins</span>
<span class="sd">        after increasing the moisture of the first bin:</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=10.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.1, 0.1, 0.1],</span>
<span class="sd">        ...       frontdepth=[100.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        soilwatersupply: 10.0</span>
<span class="sd">        moisture: 0.2, 0.2, 0.2, 0.2</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 2.0, 3.0, 4.0</span>
<span class="sd">        soilwateraddition: 10.0</span>

<span class="sd">        &gt;&gt;&gt; check(soilwatersupply=50.0,</span>
<span class="sd">        ...       moisture=[0.1, 0.1, 0.1, 0.1],</span>
<span class="sd">        ...       frontdepth=[100.0, 0.0, 0.0, 0.0])</span>
<span class="sd">        soilwatersupply: 50.0</span>
<span class="sd">        moisture: 0.5, 0.5, 0.5, 0.5</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>
<span class="sd">        moisturechange: 0.0, 2.0, 3.0, 4.0</span>
<span class="sd">        soilwateraddition: 40.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterAddition</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">supply</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">if</span> <span class="n">supply</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">rest</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">supply</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">return_lastactivebin_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bl</span><span class="p">):</span>
            <span class="n">freedepth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="n">freecontent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">freedepth</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">rest</span> <span class="o">&lt;=</span> <span class="n">freecontent</span><span class="p">:</span>
                <span class="n">flu</span><span class="o">.</span><span class="n">soilwateraddition</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">supply</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rest</span> <span class="o">/</span> <span class="n">freedepth</span>
                <span class="n">rest</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">initmoisture</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="n">rest</span> <span class="o">-=</span> <span class="n">freecontent</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">initmoisture</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rest</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">freecontent</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bl</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">rest</span> <span class="o">&lt;=</span> <span class="n">freecontent</span><span class="p">:</span>
                <span class="n">flu</span><span class="o">.</span><span class="n">soilwateraddition</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">supply</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bl</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rest</span> <span class="o">/</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rest</span> <span class="o">-=</span> <span class="n">freecontent</span>
                <span class="n">flu</span><span class="o">.</span><span class="n">soilwateraddition</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">supply</span> <span class="o">-</span> <span class="n">rest</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bl</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">saturationmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">initmoisture</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bl</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">initmoisture</span><span class="p">:</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">initmoisture</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bl</span><span class="p">):</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
            <span class="p">):</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">bb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">bb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">bb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">log</span><span class="o">.</span><span class="n">moisturechange</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">return</span></div>



<div class="viewcode-block" id="Withdraw_AllBins_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Withdraw_AllBins_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Withdraw_AllBins_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Take withdrawal from the available surface water and (potentially) from all</span>
<span class="sd">    active bins.</span>

<span class="sd">    The withdrawal calculated by |Withdraw_AllBins_V1| equals the defined demand,</span>
<span class="sd">    except no water exceeding the residual moisture is left.  Hence, for example,</span>
<span class="sd">    actual evaporation is more suitable for specifying the demand than potential</span>
<span class="sd">    evaporation.</span>

<span class="sd">    Note that the caller needs to pass the demand as a method parameter, which allows</span>
<span class="sd">    him to decide whether to subtract everything in one simulation step or multiple</span>
<span class="sd">    numerical substeps.</span>

<span class="sd">    Examples:</span>

<span class="sd">        We prepare a single shallow soil compartment divided into four bins:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; simulationstep(&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; parameterstep(&quot;1d&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(1)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(4)</span>
<span class="sd">        &gt;&gt;&gt; dt(0.5)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(100.0)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>

<span class="sd">        The following test function works similar to the one defined for demonstrating</span>
<span class="sd">        |Active_Bin_V1| but considers the withdrawal instead of infiltration:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.core.objecttools import repr_, repr_values</span>
<span class="sd">        &gt;&gt;&gt; def check(demand, actualsurfacewater, frontdepth, moisture):</span>
<span class="sd">        ...     states.moisture = [[m] for m in moisture]</span>
<span class="sd">        ...     states.frontdepth = [[fd] for fd in frontdepth]</span>
<span class="sd">        ...     logs.moisturechange = nan</span>
<span class="sd">        ...     aides.actualsurfacewater = actualsurfacewater</span>
<span class="sd">        ...     fluxes.withdrawal[0] = 0.0</span>
<span class="sd">        ...     old_volume = round(model.watercontent + aides.actualsurfacewater[0], 12)</span>
<span class="sd">        ...     model.withdraw_allbins_v1(0, control.dt * demand)</span>
<span class="sd">        ...     new_volume = round(model.watercontent + aides.actualsurfacewater[0], 12)</span>
<span class="sd">        ...     assert old_volume == new_volume + fluxes.withdrawal[0]</span>
<span class="sd">        ...     print(f&quot;withdrawal: {repr_(fluxes.withdrawal[0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;actualsurfacewater: {repr_(aides.actualsurfacewater[0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;moisture: {repr_values(states.moisture[:, 0])}&quot;)</span>
<span class="sd">        ...     print(f&quot;frontdepth: {repr_values(states.frontdepth[:, 0])}&quot;)</span>

<span class="sd">        For zero demand, |Withdraw_AllBins_V1| does nothing:</span>

<span class="sd">        &gt;&gt;&gt; check(demand=0.0, actualsurfacewater=20.0,</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1])</span>
<span class="sd">        withdrawal: 0.0</span>
<span class="sd">        actualsurfacewater: 20.0</span>
<span class="sd">        moisture: 0.1, 0.3, 0.1, 0.1</span>
<span class="sd">        frontdepth: 100.0, 50.0, 0.0, 0.0</span>

<span class="sd">        If possible, |Withdraw_AllBins_V1| withdraws only surface water:</span>

<span class="sd">        &gt;&gt;&gt; check(demand=10.0, actualsurfacewater=20.0,</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1])</span>
<span class="sd">        withdrawal: 5.0</span>
<span class="sd">        actualsurfacewater: 15.0</span>
<span class="sd">        moisture: 0.1, 0.3, 0.1, 0.1</span>
<span class="sd">        frontdepth: 100.0, 50.0, 0.0, 0.0</span>

<span class="sd">        If no surface water is available, |Withdraw_AllBins_V1| tries to take all</span>
<span class="sd">        withdrawal from the wettest bin by reducing its relative moisture content:</span>

<span class="sd">        &gt;&gt;&gt; check(demand=10.0, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1])</span>
<span class="sd">        withdrawal: 5.0</span>
<span class="sd">        actualsurfacewater: 0.0</span>
<span class="sd">        moisture: 0.1, 0.2, 0.1, 0.1</span>
<span class="sd">        frontdepth: 100.0, 50.0, 0.0, 0.0</span>

<span class="sd">        The following example shows that |Withdraw_AllBins_V1| still prefers surface</span>
<span class="sd">        water over soil water if the demand exceeds the available surface water:</span>

<span class="sd">        &gt;&gt;&gt; check(demand=10.0, actualsurfacewater=2.5,</span>
<span class="sd">        ...       frontdepth=[100.0, 50.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.3, 0.1, 0.1])</span>
<span class="sd">        withdrawal: 5.0</span>
<span class="sd">        actualsurfacewater: 0.0</span>
<span class="sd">        moisture: 0.1, 0.25, 0.1, 0.1</span>
<span class="sd">        frontdepth: 100.0, 50.0, 0.0, 0.0</span>

<span class="sd">        If the wettest bin does not contain enough water, |Withdraw_AllBins_V1|</span>
<span class="sd">        proceeds from right to left in taking the remaining demand:</span>

<span class="sd">        &gt;&gt;&gt; check(demand=10.0, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[100.0, 75.0, 50.0, 25.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4])</span>
<span class="sd">        withdrawal: 5.0</span>
<span class="sd">        actualsurfacewater: 0.0</span>
<span class="sd">        moisture: 0.1, 0.2, 0.25, 0.1</span>
<span class="sd">        frontdepth: 100.0, 75.0, 50.0, 0.0</span>

<span class="sd">        However, |Withdraw_AllBins_V1| never takes more water than indicated by soil&#39;s</span>
<span class="sd">        residual moisture:</span>

<span class="sd">        &gt;&gt;&gt; check(demand=40.0, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[100.0, 75.0, 50.0, 25.0],</span>
<span class="sd">        ...       moisture=[0.1, 0.2, 0.3, 0.4])</span>
<span class="sd">        withdrawal: 15.0</span>
<span class="sd">        actualsurfacewater: 0.0</span>
<span class="sd">        moisture: 0.1, 0.1, 0.1, 0.1</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>

<span class="sd">        The last two examples show that |Withdraw_AllBins_V1| can also take water from</span>
<span class="sd">        the filled bin (if it is not already dry, as in the previous example):</span>

<span class="sd">        &gt;&gt;&gt; check(demand=10.0, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[100.0, 0.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.2, 0.2, 0.2, 0.2])</span>
<span class="sd">        withdrawal: 5.0</span>
<span class="sd">        actualsurfacewater: 0.0</span>
<span class="sd">        moisture: 0.15, 0.2, 0.2, 0.2</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>

<span class="sd">        &gt;&gt;&gt; check(demand=40.0, actualsurfacewater=0.0,</span>
<span class="sd">        ...       frontdepth=[100.0, 0.0, 0.0, 0.0],</span>
<span class="sd">        ...       moisture=[0.2, 0.2, 0.2, 0.2])</span>
<span class="sd">        withdrawal: 10.0</span>
<span class="sd">        actualsurfacewater: 0.0</span>
<span class="sd">        moisture: 0.1, 0.2, 0.2, 0.2</span>
<span class="sd">        frontdepth: 100.0, 0.0, 0.0, 0.0</span>

<span class="sd">        As the last examples show, |Withdraw_AllBins_V1| does not update the other</span>
<span class="sd">        bins&#39; moisture after removing water from the filled bin, which is surprising</span>
<span class="sd">        but agrees with the author&#39;s GARTO source code and gave better results for</span>
<span class="sd">        shallow soils in some comparisons.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Withdrawal</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">demand</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">if</span> <span class="n">demand</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">demand</span> <span class="o">&lt;</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">demand</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">demand</span>
            <span class="k">return</span>
        <span class="n">demand</span> <span class="o">-=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
                <span class="n">available</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">demand</span> <span class="o">&lt;=</span> <span class="n">available</span><span class="p">:</span>
                    <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">demand</span> <span class="o">/</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">demand</span>
                    <span class="k">return</span>
                <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">available</span>
                <span class="n">demand</span> <span class="o">-=</span> <span class="n">available</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">con</span><span class="o">.</span><span class="n">residualmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="n">available</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">con</span><span class="o">.</span><span class="n">residualmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">demand</span> <span class="o">&lt;=</span> <span class="n">available</span><span class="p">:</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">demand</span> <span class="o">/</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">demand</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">available</span>
            <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">residualmoisture</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="Perform_GARTO_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Perform_GARTO_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Perform_GARTO_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Perform the GARTO algorithm for the numerical substeps and aggregate their</span>
<span class="sd">    results.</span>

<span class="sd">    Method |Perform_GARTO_V1| executes its submethods |Percolate_FilledBin_V1|,</span>
<span class="sd">    |Infiltrate_WettingFrontBins_V1|, |Merge_FrontDepthOvershootings_V1|,</span>
<span class="sd">    |Merge_SoilDepthOvershootings_V1|, |Water_AllBins_V1|, and |Withdraw_AllBins_V1| in</span>
<span class="sd">    the order of mentioning on all non-sealed soil compartments.  Additionally, it</span>
<span class="sd">    converts surface water that cannot infiltrate (or evaporate) during a numerical</span>
<span class="sd">    substep immediately to surface runoff (no ponding).  So, it provides all core</span>
<span class="sd">    functionalities of application model |ga_garto|, and the explanations and test</span>
<span class="sd">    results for |ga_garto| essentially apply to |Perform_GARTO_V1|, too.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Return_LastActiveBin_V1</span><span class="p">,</span>
        <span class="n">Return_Conductivity_V1</span><span class="p">,</span>
        <span class="n">Return_DryDepth_V1</span><span class="p">,</span>
        <span class="n">Return_CapillaryDrive_V1</span><span class="p">,</span>
        <span class="n">Percolate_FilledBin_V1</span><span class="p">,</span>
        <span class="n">Infiltrate_WettingFrontBins_V1</span><span class="p">,</span>
        <span class="n">Merge_FrontDepthOvershootings_V1</span><span class="p">,</span>
        <span class="n">Merge_SoilDepthOvershootings_V1</span><span class="p">,</span>
        <span class="n">Water_AllBins_V1</span><span class="p">,</span>
        <span class="n">Withdraw_AllBins_V1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">Sealed</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">AirEntryPotential</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">PoreSizeDistribution</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">NmbSubsteps</span><span class="p">,</span> <span class="n">ga_derived</span><span class="o">.</span><span class="n">EffectiveCapillarySuction</span><span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SurfaceWaterSupply</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterSupply</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Demand</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">InitialSurfaceWater</span><span class="p">,</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Infiltration</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Percolation</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterAddition</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Withdrawal</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SurfaceRunoff</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">percolation</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">infiltration</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">soilwateraddition</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">con</span><span class="o">.</span><span class="n">sealed</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">flu</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">flu</span><span class="o">.</span><span class="n">surfacewatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                    <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">flu</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                    <span class="n">flu</span><span class="o">.</span><span class="n">surfacerunoff</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">flu</span><span class="o">.</span><span class="n">surfacewatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">flu</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">flu</span><span class="o">.</span><span class="n">surfacewatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                    <span class="n">flu</span><span class="o">.</span><span class="n">surfacerunoff</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aid</span><span class="o">.</span><span class="n">initialsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">flu</span><span class="o">.</span><span class="n">surfacewatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">flu</span><span class="o">.</span><span class="n">surfacerunoff</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">der</span><span class="o">.</span><span class="n">nmbsubsteps</span><span class="p">):</span>
                    <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">aid</span><span class="o">.</span><span class="n">initialsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">percolate_filledbin_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">infiltrate_wettingfrontbins_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">flu</span><span class="o">.</span><span class="n">infiltration</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">aid</span><span class="o">.</span><span class="n">initialsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">merge_frontdepthovershootings_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">merge_soildepthovershootings_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">water_allbins_v1</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">flu</span><span class="o">.</span><span class="n">soilwatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">withdraw_allbins_v1</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">flu</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                    <span class="n">flu</span><span class="o">.</span><span class="n">surfacerunoff</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Calc_TotalInfiltration_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Calc_TotalInfiltration_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calc_TotalInfiltration_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the average infiltration from all soil compartments.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`TotalInfiltration =</span>
<span class="sd">      \sum_{i=1}^{NmbSoils} SoilAreaFraction_i \cdot Infiltration_i`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction(0.8, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.infiltration = 1.0, 2.0</span>
<span class="sd">        &gt;&gt;&gt; model.calc_totalinfiltration_v1()</span>
<span class="sd">        &gt;&gt;&gt; fluxes.totalinfiltration</span>
<span class="sd">        totalinfiltration(1.2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">SoilAreaFraction</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Infiltration</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">TotalInfiltration</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">flu</span><span class="o">.</span><span class="n">totalinfiltration</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">totalinfiltration</span> <span class="o">+=</span> <span class="n">der</span><span class="o">.</span><span class="n">soilareafraction</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">flu</span><span class="o">.</span><span class="n">infiltration</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Calc_TotalPercolation_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Calc_TotalPercolation_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calc_TotalPercolation_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the average percolation from all soil compartments.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`TotalPercolation =</span>
<span class="sd">      \sum_{i=1}^{NmbSoils} SoilAreaFraction_i \cdot Percolation_i`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction(0.8, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.percolation = 1.0, 2.0</span>
<span class="sd">        &gt;&gt;&gt; model.calc_totalpercolation_v1()</span>
<span class="sd">        &gt;&gt;&gt; fluxes.totalpercolation</span>
<span class="sd">        totalpercolation(1.2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">SoilAreaFraction</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Percolation</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">TotalPercolation</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">flu</span><span class="o">.</span><span class="n">totalpercolation</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">totalpercolation</span> <span class="o">+=</span> <span class="n">der</span><span class="o">.</span><span class="n">soilareafraction</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">flu</span><span class="o">.</span><span class="n">percolation</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Calc_TotalSoilWaterAddition_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Calc_TotalSoilWaterAddition_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calc_TotalSoilWaterAddition_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the average soil water addition to all soil compartments.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`TotalSoilWaterAddition =</span>
<span class="sd">      \sum_{i=1}^{NmbSoils} SoilAreaFraction_i \cdot SoilWaterAddition_i`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction(0.8, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.soilwateraddition = 1.0, 2.0</span>
<span class="sd">        &gt;&gt;&gt; model.calc_totalsoilwateraddition_v1()</span>
<span class="sd">        &gt;&gt;&gt; fluxes.totalsoilwateraddition</span>
<span class="sd">        totalsoilwateraddition(1.2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">SoilAreaFraction</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterAddition</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">TotalSoilWaterAddition</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">flu</span><span class="o">.</span><span class="n">totalsoilwateraddition</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">totalsoilwateraddition</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">der</span><span class="o">.</span><span class="n">soilareafraction</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">flu</span><span class="o">.</span><span class="n">soilwateraddition</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="Calc_TotalWithdrawal_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Calc_TotalWithdrawal_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calc_TotalWithdrawal_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the average withdrawal from all soil compartments.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`TotalWithdrawal =</span>
<span class="sd">      \sum_{i=1}^{NmbSoils} SoilAreaFraction_i \cdot Withdrawal_i`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction(0.8, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.withdrawal = 1.0, 2.0</span>
<span class="sd">        &gt;&gt;&gt; model.calc_totalwithdrawal_v1()</span>
<span class="sd">        &gt;&gt;&gt; fluxes.totalwithdrawal</span>
<span class="sd">        totalwithdrawal(1.2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">SoilAreaFraction</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Withdrawal</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">TotalWithdrawal</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">flu</span><span class="o">.</span><span class="n">totalwithdrawal</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">totalwithdrawal</span> <span class="o">+=</span> <span class="n">der</span><span class="o">.</span><span class="n">soilareafraction</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Calc_TotalSurfaceRunoff_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Calc_TotalSurfaceRunoff_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calc_TotalSurfaceRunoff_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the average surface runoff from all soil compartments.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`TotalSurfaceRunoff =</span>
<span class="sd">      \sum_{i=1}^{NmbSoils} SoilAreaFraction_i \cdot SurfaceRunoff_i`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction(0.8, 0.2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.surfacerunoff = 1.0, 2.0</span>
<span class="sd">        &gt;&gt;&gt; model.calc_totalsurfacerunoff_v1()</span>
<span class="sd">        &gt;&gt;&gt; fluxes.totalsurfacerunoff</span>
<span class="sd">        totalsurfacerunoff(1.2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">,)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">SoilAreaFraction</span><span class="p">,)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SurfaceRunoff</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">TotalSurfaceRunoff</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">flu</span><span class="o">.</span><span class="n">totalsurfacerunoff</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">):</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">totalsurfacerunoff</span> <span class="o">+=</span> <span class="n">der</span><span class="o">.</span><span class="n">soilareafraction</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">flu</span><span class="o">.</span><span class="n">surfacerunoff</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Set_InitialSurfaceWater_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Set_InitialSurfaceWater_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Set_InitialSurfaceWater_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the given initial surface water depth for the selected soil compartment.</span>

<span class="sd">    Example:</span>

<span class="sd">        Note that |Set_InitialSurfaceWater_V1| multiplies the given value with |DT| to</span>
<span class="sd">        adjust it to the numerical substep width:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; dt.value = 0.5</span>
<span class="sd">        &gt;&gt;&gt; model.set_initialsurfacewater_v1(0, 2.0)</span>
<span class="sd">        &gt;&gt;&gt; model.set_initialsurfacewater_v1(1, 4.0)</span>
<span class="sd">        &gt;&gt;&gt; aides.initialsurfacewater</span>
<span class="sd">        initialsurfacewater(1.0, 2.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_aides</span><span class="o">.</span><span class="n">InitialSurfaceWater</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">aid</span><span class="o">.</span><span class="n">initialsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">v</span></div>



<div class="viewcode-block" id="Set_ActualSurfaceWater_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Set_ActualSurfaceWater_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Set_ActualSurfaceWater_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the given actual surface water depth for the selected soil compartment.</span>

<span class="sd">    Example:</span>

<span class="sd">        Note that |Set_ActualSurfaceWater_V1| multiplies the given value with |DT| to</span>
<span class="sd">        adjust it to the numerical substep width:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; dt.value = 0.5</span>
<span class="sd">        &gt;&gt;&gt; model.set_actualsurfacewater_v1(0, 2.0)</span>
<span class="sd">        &gt;&gt;&gt; model.set_actualsurfacewater_v1(1, 4.0)</span>
<span class="sd">        &gt;&gt;&gt; aides.actualsurfacewater</span>
<span class="sd">        actualsurfacewater(1.0, 2.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">v</span></div>



<div class="viewcode-block" id="Set_SoilWaterSupply_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Set_SoilWaterSupply_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Set_SoilWaterSupply_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the (potential) water supply to the soil&#39;s body.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; model.set_soilwatersupply_v1(0, 2.0)</span>
<span class="sd">        &gt;&gt;&gt; model.set_soilwatersupply_v1(1, 4.0)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.soilwatersupply</span>
<span class="sd">        soilwatersupply(2.0, 4.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterSupply</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">flu</span><span class="o">.</span><span class="n">soilwatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span></div>



<div class="viewcode-block" id="Set_SoilWaterDemand_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Set_SoilWaterDemand_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Set_SoilWaterDemand_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the (potential) water withdrawal from the soil&#39;s surface and body.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; model.set_soilwaterdemand_v1(0, 2.0)</span>
<span class="sd">        &gt;&gt;&gt; model.set_soilwaterdemand_v1(1, 4.0)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.demand</span>
<span class="sd">        demand(2.0, 4.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Demand</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">flu</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span></div>



<div class="viewcode-block" id="Execute_Infiltration_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Execute_Infiltration_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Execute_Infiltration_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate infiltration (and percolation).</span>

<span class="sd">    The interface method |Execute_Infiltration_V1| subsequently executes the GARTO</span>
<span class="sd">    methods |Percolate_FilledBin_V1|, |Infiltrate_WettingFrontBins_V1|,</span>
<span class="sd">    |Merge_FrontDepthOvershootings_V1|, and |Merge_SoilDepthOvershootings_V1| for all</span>
<span class="sd">    numerical substeps.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Return_LastActiveBin_V1</span><span class="p">,</span>
        <span class="n">Return_Conductivity_V1</span><span class="p">,</span>
        <span class="n">Return_DryDepth_V1</span><span class="p">,</span>
        <span class="n">Return_CapillaryDrive_V1</span><span class="p">,</span>
        <span class="n">Percolate_FilledBin_V1</span><span class="p">,</span>
        <span class="n">Infiltrate_WettingFrontBins_V1</span><span class="p">,</span>
        <span class="n">Merge_FrontDepthOvershootings_V1</span><span class="p">,</span>
        <span class="n">Merge_SoilDepthOvershootings_V1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">DT</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturatedConductivity</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">AirEntryPotential</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">PoreSizeDistribution</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DERIVEDPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_derived</span><span class="o">.</span><span class="n">NmbSubsteps</span><span class="p">,</span> <span class="n">ga_derived</span><span class="o">.</span><span class="n">EffectiveCapillarySuction</span><span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_aides</span><span class="o">.</span><span class="n">InitialSurfaceWater</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Infiltration</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Percolation</span><span class="p">,</span>
        <span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SurfaceRunoff</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">initialactualsurfacewater</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">flu</span><span class="o">.</span><span class="n">infiltration</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">flu</span><span class="o">.</span><span class="n">percolation</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">flu</span><span class="o">.</span><span class="n">surfacerunoff</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">der</span><span class="o">.</span><span class="n">nmbsubsteps</span><span class="p">):</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialactualsurfacewater</span>
            <span class="n">model</span><span class="o">.</span><span class="n">percolate_filledbin_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">infiltrate_wettingfrontbins_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">infiltration</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">initialactualsurfacewater</span> <span class="o">-</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">merge_frontdepthovershootings_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">merge_soildepthovershootings_v1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">flu</span><span class="o">.</span><span class="n">surfacerunoff</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span></div>



<div class="viewcode-block" id="Add_SoilWater_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Add_SoilWater_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Add_SoilWater_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the (direct) soil water supply to the soil&#39;s body.</span>

<span class="sd">    The interface method |Add_SoilWater_V1| only calls |Withdraw_AllBins_V1|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span><span class="n">Water_AllBins_V1</span><span class="p">,)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SaturationMoisture</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterSupply</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
        <span class="n">ga_logs</span><span class="o">.</span><span class="n">MoistureChange</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterAddition</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">flu</span><span class="o">.</span><span class="n">soilwateraddition</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">water_allbins_v1</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">flu</span><span class="o">.</span><span class="n">soilwatersupply</span><span class="p">[</span><span class="n">s</span><span class="p">])</span></div>



<div class="viewcode-block" id="Remove_SoilWater_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Remove_SoilWater_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Remove_SoilWater_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the water demand from the soil&#39;s body and eventually from the soil&#39;s</span>
<span class="sd">    surface.</span>

<span class="sd">    The interface method |Remove_SoilWater_V1| only calls |Withdraw_AllBins_V1|.</span>
<span class="sd">    Hence, whether |Remove_SoilWater_V1| can remove surface water depends on the order</span>
<span class="sd">    the different interface methods are applied and is thus a decision of the calling</span>
<span class="sd">    model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMETHODS</span> <span class="o">=</span> <span class="p">(</span><span class="n">Withdraw_AllBins_V1</span><span class="p">,)</span>
    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">,</span>
        <span class="n">ga_control</span><span class="o">.</span><span class="n">ResidualMoisture</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Demand</span><span class="p">,)</span>
    <span class="n">UPDATEDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ga_aides</span><span class="o">.</span><span class="n">ActualSurfaceWater</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">,</span>
        <span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Withdrawal</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">aides</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="n">aid</span><span class="o">.</span><span class="n">actualsurfacewater</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">withdraw_allbins_v1</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">flu</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">s</span><span class="p">])</span></div>



<div class="viewcode-block" id="Get_Infiltration_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Get_Infiltration_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Get_Infiltration_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the current infiltration to the selected soil compartment.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.infiltration = 2.0, 4.0</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_infiltration_v1(0))</span>
<span class="sd">        2.0</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_infiltration_v1(1))</span>
<span class="sd">        4.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Infiltration</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">return</span> <span class="n">flu</span><span class="o">.</span><span class="n">infiltration</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Get_Percolation_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Get_Percolation_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Get_Percolation_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the current percolation from the selected soil compartment.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.percolation = 2.0, 4.0</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_percolation_v1(0))</span>
<span class="sd">        2.0</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_percolation_v1(1))</span>
<span class="sd">        4.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Percolation</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">return</span> <span class="n">flu</span><span class="o">.</span><span class="n">percolation</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Get_SoilWaterAddition_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Get_SoilWaterAddition_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Get_SoilWaterAddition_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the current soil water addition to the selected soil compartment.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.soilwateraddition = 2.0, 4.0</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_soilwateraddition_v1(0))</span>
<span class="sd">        2.0</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_soilwateraddition_v1(1))</span>
<span class="sd">        4.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">SoilWaterAddition</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">return</span> <span class="n">flu</span><span class="o">.</span><span class="n">soilwateraddition</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Get_SoilWaterRemoval_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Get_SoilWaterRemoval_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Get_SoilWaterRemoval_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the current soil (and surface water) withdrawal from the selected soil</span>
<span class="sd">    compartment.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(2)</span>
<span class="sd">        &gt;&gt;&gt; fluxes.withdrawal = 2.0, 4.0</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_soilwaterremoval_v1(0))</span>
<span class="sd">        2.0</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_soilwaterremoval_v1(1))</span>
<span class="sd">        4.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RESULTSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_fluxes</span><span class="o">.</span><span class="n">Withdrawal</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">flu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">return</span> <span class="n">flu</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>



<div class="viewcode-block" id="Get_SoilWaterContent_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Get_SoilWaterContent_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Get_SoilWaterContent_V1</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the current soil water content of the selected soil compartment.</span>

<span class="sd">    Basic equation:</span>
<span class="sd">      :math:`SoilWaterContent = Moisture_1 \cdot SoilDepth +</span>
<span class="sd">      \sum_{i=2}^{NmbBins} (Moisture_i - Moisture_{i-1}) \cdot FrontDepth_i`</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(3)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(4)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False, False, True)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0, 2.0, 3.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(100.0, 200, nan)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1, 0.2, nan)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5, 0.8, nan)</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = [[0.3, 0.2, nan],</span>
<span class="sd">        ...                    [0.3, 0.3, nan],</span>
<span class="sd">        ...                    [0.3, 0.5, nan],</span>
<span class="sd">        ...                    [0.3, 0.8, nan]]</span>
<span class="sd">        &gt;&gt;&gt; states.frontdepth = [[100.0, 200.0, nan],</span>
<span class="sd">        ...                      [0.0, 150.0, nan],</span>
<span class="sd">        ...                      [0.0, 100.0, nan],</span>
<span class="sd">        ...                      [0.0, 50.0, nan]]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_soilwatercontent_v1(0))</span>
<span class="sd">        30.0</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_soilwatercontent_v1(1))</span>
<span class="sd">        90.0</span>
<span class="sd">        &gt;&gt;&gt; round_(model.get_soilwatercontent_v1(2))</span>
<span class="sd">        0.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTROLPARAMETERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbBins</span><span class="p">,</span> <span class="n">ga_control</span><span class="o">.</span><span class="n">Sealed</span><span class="p">,</span> <span class="n">ga_control</span><span class="o">.</span><span class="n">SoilDepth</span><span class="p">)</span>
    <span class="n">REQUIREDSEQUENCES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ga_states</span><span class="o">.</span><span class="n">Moisture</span><span class="p">,</span> <span class="n">ga_states</span><span class="o">.</span><span class="n">FrontDepth</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">fastaccess</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">fastaccess</span>

        <span class="k">if</span> <span class="n">con</span><span class="o">.</span><span class="n">sealed</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">wc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">soildepth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">nmbbins</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="n">wc</span> <span class="o">+=</span> <span class="n">sta</span><span class="o">.</span><span class="n">frontdepth</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta</span><span class="o">.</span><span class="n">moisture</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">wc</span></div>



<div class="viewcode-block" id="Model">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Model">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">AdHocModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;|ga.DOCNAME.complete|.&quot;&quot;&quot;</span>

    <span class="n">DOCNAME</span> <span class="o">=</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">DocName</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s2">&quot;GA&quot;</span><span class="p">)</span>
    <span class="n">__HYDPY_ROOTMODEL__</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">INLET_METHODS</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">OBSERVER_METHODS</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">RECEIVER_METHODS</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">RUN_METHODS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Calc_SurfaceWaterSupply_V1</span><span class="p">,</span>
        <span class="n">Calc_SoilWaterSupply_V1</span><span class="p">,</span>
        <span class="n">Calc_Demand_V1</span><span class="p">,</span>
        <span class="n">Perform_GARTO_V1</span><span class="p">,</span>
        <span class="n">Calc_TotalInfiltration_V1</span><span class="p">,</span>
        <span class="n">Calc_TotalPercolation_V1</span><span class="p">,</span>
        <span class="n">Calc_TotalSoilWaterAddition_V1</span><span class="p">,</span>
        <span class="n">Calc_TotalWithdrawal_V1</span><span class="p">,</span>
        <span class="n">Calc_TotalSurfaceRunoff_V1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">INTERFACE_METHODS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Set_InitialSurfaceWater_V1</span><span class="p">,</span>
        <span class="n">Set_ActualSurfaceWater_V1</span><span class="p">,</span>
        <span class="n">Set_SoilWaterSupply_V1</span><span class="p">,</span>
        <span class="n">Set_SoilWaterDemand_V1</span><span class="p">,</span>
        <span class="n">Execute_Infiltration_V1</span><span class="p">,</span>
        <span class="n">Add_SoilWater_V1</span><span class="p">,</span>
        <span class="n">Remove_SoilWater_V1</span><span class="p">,</span>
        <span class="n">Get_Infiltration_V1</span><span class="p">,</span>
        <span class="n">Get_Percolation_V1</span><span class="p">,</span>
        <span class="n">Get_SoilWaterAddition_V1</span><span class="p">,</span>
        <span class="n">Get_SoilWaterRemoval_V1</span><span class="p">,</span>
        <span class="n">Get_SoilWaterContent_V1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ADD_METHODS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Return_RelativeMoisture_V1</span><span class="p">,</span>
        <span class="n">Return_Conductivity_V1</span><span class="p">,</span>
        <span class="n">Return_CapillaryDrive_V1</span><span class="p">,</span>
        <span class="n">Return_DryDepth_V1</span><span class="p">,</span>
        <span class="n">Return_LastActiveBin_V1</span><span class="p">,</span>
        <span class="n">Active_Bin_V1</span><span class="p">,</span>
        <span class="n">Percolate_FilledBin_V1</span><span class="p">,</span>
        <span class="n">Shift_Front_V1</span><span class="p">,</span>
        <span class="n">Redistribute_Front_V1</span><span class="p">,</span>
        <span class="n">Infiltrate_WettingFrontBins_V1</span><span class="p">,</span>
        <span class="n">Merge_FrontDepthOvershootings_V1</span><span class="p">,</span>
        <span class="n">Merge_SoilDepthOvershootings_V1</span><span class="p">,</span>
        <span class="n">Water_AllBins_V1</span><span class="p">,</span>
        <span class="n">Withdraw_AllBins_V1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">OUTLET_METHODS</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">SENDER_METHODS</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">SUBMODELINTERFACES</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">SUBMODELS</span> <span class="o">=</span> <span class="p">()</span></div>



<div class="viewcode-block" id="BaseModel">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.BaseModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseModel</span><span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">AdHocModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;General base class for GARTO-like Green-Ampt models.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BaseModel.check_waterbalance">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.BaseModel.check_waterbalance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_waterbalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_conditions</span><span class="p">:</span> <span class="n">ConditionsModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine the water balance error of the previous simulation run in mm.</span>

<span class="sd">        Method |ga_model.BaseModel.check_waterbalance| calculates the balance error as</span>
<span class="sd">        follows:</span>

<span class="sd">        :math:`\sum_{t=t0}^{t1} \big(</span>
<span class="sd">        Rainfall_t - TotalPercolation_t  + TotalSoilWaterAddition_t - TotalWithdrawal_t</span>
<span class="sd">        - Percolation_t \big) +b\big( WaterVolume_{t0} - WaterVolume_{t1} \big)`</span>

<span class="sd">        The returned error should always be in scale with numerical precision so that</span>
<span class="sd">        it does not affect the simulation results in any relevant manner.</span>

<span class="sd">        Pick the required initial conditions before starting the simulation via</span>
<span class="sd">        property |Sequences.conditions|.  See the integration tests of the application</span>
<span class="sd">        model |ga_garto| for some examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span>
        <span class="n">fluxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">initial_conditions</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;states&quot;</span><span class="p">]</span>
        <span class="n">old_watercontent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_watercontent</span><span class="p">(</span>
            <span class="n">frontdepth</span><span class="o">=</span><span class="n">first</span><span class="p">[</span><span class="s2">&quot;frontdepth&quot;</span><span class="p">],</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">moisture</span><span class="o">=</span><span class="n">first</span><span class="p">[</span><span class="s2">&quot;moisture&quot;</span><span class="p">],</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">rainfall</span><span class="o">.</span><span class="n">evalseries</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fluxes</span><span class="o">.</span><span class="n">totalsoilwateraddition</span><span class="o">.</span><span class="n">evalseries</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fluxes</span><span class="o">.</span><span class="n">totalpercolation</span><span class="o">.</span><span class="n">evalseries</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fluxes</span><span class="o">.</span><span class="n">totalwithdrawal</span><span class="o">.</span><span class="n">evalseries</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fluxes</span><span class="o">.</span><span class="n">totalsurfacerunoff</span><span class="o">.</span><span class="n">evalseries</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">old_watercontent</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">watercontent</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">watercontents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The unique water content of each soil compartment in mm.</span>

<span class="sd">        Property |ga_model.BaseModel.watercontents| generally returns zero values for</span>
<span class="sd">        sealed soil compartments:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(3)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(4)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False, False, True)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0, 2.0, 3.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(100.0, 200, nan)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1, 0.2, nan)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5, 0.8, nan)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = [[0.3, 0.2, nan],</span>
<span class="sd">        ...                    [0.3, 0.3, nan],</span>
<span class="sd">        ...                    [0.3, 0.5, nan],</span>
<span class="sd">        ...                    [0.3, 0.8, nan]]</span>
<span class="sd">        &gt;&gt;&gt; states.frontdepth = [[100.0, 200.0, nan],</span>
<span class="sd">        ...                      [0.0, 150.0, nan],</span>
<span class="sd">        ...                      [0.0, 100.0, nan],</span>
<span class="sd">        ...                      [0.0, 50.0, nan]]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import print_vector</span>
<span class="sd">        &gt;&gt;&gt; print_vector(model.watercontents)</span>
<span class="sd">        30.0, 90.0, 0.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_watercontents</span><span class="p">(</span>
            <span class="n">frontdepth</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">frontdepth</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">moisture</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">moisture</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">watercontent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The average water content of all soil compartments in mm.</span>

<span class="sd">        Property |ga_model.BaseModel.watercontent| includes sealed soil compartments in</span>
<span class="sd">        the average, which is why the presence of sealing reduces the returned value:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils(3)</span>
<span class="sd">        &gt;&gt;&gt; nmbbins(4)</span>
<span class="sd">        &gt;&gt;&gt; sealed(False, False, True)</span>
<span class="sd">        &gt;&gt;&gt; soilarea(1.0, 2.0, 3.0)</span>
<span class="sd">        &gt;&gt;&gt; soildepth(100.0, 200, nan)</span>
<span class="sd">        &gt;&gt;&gt; residualmoisture(0.1, 0.2, nan)</span>
<span class="sd">        &gt;&gt;&gt; saturationmoisture(0.5, 0.8, nan)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>
<span class="sd">        &gt;&gt;&gt; states.moisture = [[0.3, 0.2, nan],</span>
<span class="sd">        ...                    [0.3, 0.3, nan],</span>
<span class="sd">        ...                    [0.3, 0.5, nan],</span>
<span class="sd">        ...                    [0.3, 0.8, nan]]</span>
<span class="sd">        &gt;&gt;&gt; states.frontdepth = [[100.0, 200.0, nan],</span>
<span class="sd">        ...                      [0.0, 150.0, nan],</span>
<span class="sd">        ...                      [0.0, 100.0, nan],</span>
<span class="sd">        ...                      [0.0, 50.0, nan]]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import round_</span>
<span class="sd">        &gt;&gt;&gt; round_(model.watercontent)</span>
<span class="sd">        35.0</span>

<span class="sd">        &gt;&gt;&gt; soilarea(1.0, 2.0, 0.0)</span>
<span class="sd">        &gt;&gt;&gt; derived.soilareafraction.update()</span>
<span class="sd">        &gt;&gt;&gt; round_(model.watercontent)</span>
<span class="sd">        70.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_watercontent</span><span class="p">(</span>
            <span class="n">frontdepth</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">frontdepth</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">moisture</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">moisture</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_watercontents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">frontdepth</span><span class="p">:</span> <span class="n">NDArrayFloat</span><span class="p">,</span> <span class="n">moisture</span><span class="p">:</span> <span class="n">NDArrayFloat</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
        <span class="n">frontdepth</span> <span class="o">=</span> <span class="n">frontdepth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">frontdepth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">soildepth</span><span class="o">.</span><span class="n">values</span>
        <span class="n">deltamoisture</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">moisture</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">deltamoisture</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">deltamoisture</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">watercontents</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">frontdepth</span> <span class="o">*</span> <span class="n">deltamoisture</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">watercontents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">sealed</span><span class="o">.</span><span class="n">values</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">watercontents</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_watercontent</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">frontdepth</span><span class="p">:</span> <span class="n">NDArrayFloat</span><span class="p">,</span> <span class="n">moisture</span><span class="p">:</span> <span class="n">NDArrayFloat</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">soilareafraction</span><span class="o">.</span><span class="n">values</span>
        <span class="n">watercontents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_watercontents</span><span class="p">(</span>
            <span class="n">frontdepth</span><span class="o">=</span><span class="n">frontdepth</span><span class="p">,</span> <span class="n">moisture</span><span class="o">=</span><span class="n">moisture</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">watercontents</span><span class="p">)</span></div>



<div class="viewcode-block" id="Base_SoilModel_V1">
<a class="viewcode-back" href="../../../../ga.html#hydpy.models.ga.ga_model.Base_SoilModel_V1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Base_SoilModel_V1</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">soilinterfaces</span><span class="o">.</span><span class="n">SoilModel_V1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for |ga.DOCNAME.long| models that comply with the |SoilModel_V1|</span>
<span class="sd">    submodel interface.&quot;&quot;&quot;</span>

    <span class="nd">@importtools</span><span class="o">.</span><span class="n">define_targetparameter</span><span class="p">(</span><span class="n">ga_control</span><span class="o">.</span><span class="n">NmbSoils</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_nmbzones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmbzones</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the number of soil compartments.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.ga_garto_submodel1 import *</span>
<span class="sd">        &gt;&gt;&gt; parameterstep()</span>
<span class="sd">        &gt;&gt;&gt; model.prepare_nmbzones(2)</span>
<span class="sd">        &gt;&gt;&gt; nmbsoils</span>
<span class="sd">        nmbsoils(2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">nmbsoils</span><span class="p">(</span><span class="n">nmbzones</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">HydPy 6.2dev6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.models.ga.ga_model</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2013-2025, HydPy Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>