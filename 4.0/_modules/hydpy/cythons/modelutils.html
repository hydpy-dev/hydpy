
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydpy.cythons.modelutils &#8212; HydPy 4.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 4.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.cythons.modelutils</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hydpy.cythons.modelutils</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; This module provides utilities to build Cython models based on</span>
<span class="sd">Python models automatically.</span>

<span class="sd">.. _`issue`: https://github.com/hydpy-dev/hydpy/issues</span>

<span class="sd">Most model developers do not need to be aware of the features</span>
<span class="sd">implemented in module |modelutils|, except that they need to</span>
<span class="sd">initialise class |Cythonizer| within the main modules of their base</span>
<span class="sd">and application models (see, for example, the source code of base</span>
<span class="sd">model |hland| and application model |hland_v1|).</span>

<span class="sd">However, when implementing models with functionalities not envisaged</span>
<span class="sd">so far, problems might arise.  Please contact the *HydPy*</span>
<span class="sd">developer team then, preferably by opening an `issue`_ on GitHub.</span>
<span class="sd">Potentially, problems could occur when defining parameters or sequences</span>
<span class="sd">with larger dimensionality than anticipated.  The following</span>
<span class="sd">example shows the Cython code lines for the |ELSModel.get_point_states|</span>
<span class="sd">method of class |ELSModel|, used for deriving the |test| model.  By</span>
<span class="sd">now, we did only implement 0-dimensional and 1-dimensional sequences</span>
<span class="sd">requiring this method.  After hackishly changing the dimensionality of</span>
<span class="sd">sequences |test_states.S|, we still seem to get  plausible results, but</span>
<span class="sd">these are untested in model applications:</span>

<span class="sd">&gt;&gt;&gt; from hydpy.models.test import cythonizer</span>
<span class="sd">&gt;&gt;&gt; pyxwriter = cythonizer.pyxwriter</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.get_point_states</span>
<span class="sd">            . get_point_states</span>
<span class="sd">    cpdef inline void get_point_states(self) nogil:</span>
<span class="sd">        cdef int idx0</span>
<span class="sd">        self.sequences.states.s = \</span>
<span class="sd">self.sequences.states._s_points[self.numvars.idx_stage]</span>
<span class="sd">        for idx0 in range(self.sequences.states._sv_length):</span>
<span class="sd">            self.sequences.states.sv[idx0] = \</span>
<span class="sd">self.sequences.states._sv_points[self.numvars.idx_stage][idx0]</span>
<span class="sd">&lt;BLANKLINE&gt;</span>


<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.states.s.NDIM = 2</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.get_point_states</span>
<span class="sd">            . get_point_states</span>
<span class="sd">    cpdef inline void get_point_states(self) nogil:</span>
<span class="sd">        cdef int idx0, idx1</span>
<span class="sd">        for idx0 in range(self.sequences.states._s_length0):</span>
<span class="sd">            for idx1 in range(self.sequences.states._s_length1):</span>
<span class="sd">                self.sequences.states.s[idx0, idx1] = \</span>
<span class="sd">self.sequences.states._s_points[self.numvars.idx_stage][idx0, idx1]</span>
<span class="sd">        for idx0 in range(self.sequences.states._sv_length):</span>
<span class="sd">            self.sequences.states.sv[idx0] = \</span>
<span class="sd">self.sequences.states._sv_points[self.numvars.idx_stage][idx0]</span>
<span class="sd">&lt;BLANKLINE&gt;</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.states.s.NDIM = 3</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.get_point_states</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">NotImplementedError: NDIM of sequence `s` is higher than expected.</span>

<span class="sd">The following examples show the results for some methods which are also</span>
<span class="sd">related to numerical integration but deal with |FluxSequence| objects.</span>
<span class="sd">We start with the method |ELSModel.integrate_fluxes|:</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.integrate_fluxes</span>
<span class="sd">            . integrate_fluxes</span>
<span class="sd">    cpdef inline void integrate_fluxes(self) nogil:</span>
<span class="sd">        cdef int jdx, idx0</span>
<span class="sd">        self.sequences.fluxes.q = 0.</span>
<span class="sd">        for jdx in range(self.numvars.idx_method):</span>
<span class="sd">            self.sequences.fluxes.q = \</span>
<span class="sd">self.sequences.fluxes.q +self.numvars.dt * \</span>
<span class="sd">self.numconsts.a_coefs[self.numvars.idx_method-1, \</span>
<span class="sd">self.numvars.idx_stage, jdx]*self.sequences.fluxes._q_points[jdx]</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._qv_length):</span>
<span class="sd">            self.sequences.fluxes.qv[idx0] = 0.</span>
<span class="sd">            for jdx in range(self.numvars.idx_method):</span>
<span class="sd">                self.sequences.fluxes.qv[idx0] = \</span>
<span class="sd">self.sequences.fluxes.qv[idx0] + self.numvars.dt * \</span>
<span class="sd">self.numconsts.a_coefs[self.numvars.idx_method-1, self.numvars.idx_stage, jdx]*\</span>
<span class="sd">self.sequences.fluxes._qv_points[jdx, idx0]</span>
<span class="sd">&lt;BLANKLINE&gt;</span>


<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 2</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.integrate_fluxes</span>
<span class="sd">            . integrate_fluxes</span>
<span class="sd">    cpdef inline void integrate_fluxes(self) nogil:</span>
<span class="sd">        cdef int jdx, idx0, idx1</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._q_length0):</span>
<span class="sd">            for idx1 in range(self.sequences.fluxes._q_length1):</span>
<span class="sd">                self.sequences.fluxes.q[idx0, idx1] = 0.</span>
<span class="sd">                for jdx in range(self.numvars.idx_method):</span>
<span class="sd">                    self.sequences.fluxes.q[idx0, idx1] = \</span>
<span class="sd">self.sequences.fluxes.q[idx0, idx1] + self.numvars.dt * \</span>
<span class="sd">self.numconsts.a_coefs[self.numvars.idx_method-1, self.numvars.idx_stage, jdx]*\</span>
<span class="sd">self.sequences.fluxes._q_points[jdx, idx0, idx1]</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._qv_length):</span>
<span class="sd">            self.sequences.fluxes.qv[idx0] = 0.</span>
<span class="sd">            for jdx in range(self.numvars.idx_method):</span>
<span class="sd">                self.sequences.fluxes.qv[idx0] = \</span>
<span class="sd">self.sequences.fluxes.qv[idx0] + self.numvars.dt * \</span>
<span class="sd">self.numconsts.a_coefs[self.numvars.idx_method-1, self.numvars.idx_stage, jdx]\</span>
<span class="sd">*self.sequences.fluxes._qv_points[jdx, idx0]</span>
<span class="sd">&lt;BLANKLINE&gt;</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 3</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.integrate_fluxes</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">NotImplementedError: NDIM of sequence `q` is higher than expected.</span>

<span class="sd">Method |ELSModel.reset_sum_fluxes|:</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 0</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.reset_sum_fluxes</span>
<span class="sd">            . reset_sum_fluxes</span>
<span class="sd">    cpdef inline void reset_sum_fluxes(self) nogil:</span>
<span class="sd">        cdef int idx0</span>
<span class="sd">        self.sequences.fluxes._q_sum = 0.</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._qv_length):</span>
<span class="sd">            self.sequences.fluxes._qv_sum[idx0] = 0.</span>
<span class="sd">&lt;BLANKLINE&gt;</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 2</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.reset_sum_fluxes</span>
<span class="sd">            . reset_sum_fluxes</span>
<span class="sd">    cpdef inline void reset_sum_fluxes(self) nogil:</span>
<span class="sd">        cdef int idx0, idx1</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._q_length0):</span>
<span class="sd">            for idx1 in range(self.sequences.fluxes._q_length1):</span>
<span class="sd">                self.sequences.fluxes._q_sum[idx0, idx1] = 0.</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._qv_length):</span>
<span class="sd">            self.sequences.fluxes._qv_sum[idx0] = 0.</span>
<span class="sd">&lt;BLANKLINE&gt;</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 3</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.reset_sum_fluxes</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">NotImplementedError: NDIM of sequence `q` is higher than expected.</span>

<span class="sd">Method |ELSModel.addup_fluxes|:</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 0</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.addup_fluxes</span>
<span class="sd">            . addup_fluxes</span>
<span class="sd">    cpdef inline void addup_fluxes(self) nogil:</span>
<span class="sd">        cdef int idx0</span>
<span class="sd">        self.sequences.fluxes._q_sum = \</span>
<span class="sd">self.sequences.fluxes._q_sum + self.sequences.fluxes.q</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._qv_length):</span>
<span class="sd">            self.sequences.fluxes._qv_sum[idx0] = \</span>
<span class="sd">self.sequences.fluxes._qv_sum[idx0] + self.sequences.fluxes.qv[idx0]</span>
<span class="sd">&lt;BLANKLINE&gt;</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 2</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.addup_fluxes</span>
<span class="sd">            . addup_fluxes</span>
<span class="sd">    cpdef inline void addup_fluxes(self) nogil:</span>
<span class="sd">        cdef int idx0, idx1</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._q_length0):</span>
<span class="sd">            for idx1 in range(self.sequences.fluxes._q_length1):</span>
<span class="sd">                self.sequences.fluxes._q_sum[idx0, idx1] = \</span>
<span class="sd">self.sequences.fluxes._q_sum[idx0, idx1] + self.sequences.fluxes.q[idx0, idx1]</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._qv_length):</span>
<span class="sd">            self.sequences.fluxes._qv_sum[idx0] = \</span>
<span class="sd">self.sequences.fluxes._qv_sum[idx0] + self.sequences.fluxes.qv[idx0]</span>
<span class="sd">&lt;BLANKLINE&gt;</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 3</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.addup_fluxes</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">NotImplementedError: NDIM of sequence `q` is higher than expected.</span>

<span class="sd">Method |ELSModel.calculate_error|:</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 0</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.calculate_error</span>
<span class="sd">            . calculate_error</span>
<span class="sd">    cpdef inline void calculate_error(self) nogil:</span>
<span class="sd">        cdef int idx0</span>
<span class="sd">        cdef double abserror</span>
<span class="sd">        self.numvars.abserror = 0.</span>
<span class="sd">        if self.numvars.use_relerror:</span>
<span class="sd">            self.numvars.relerror = 0.</span>
<span class="sd">        else:</span>
<span class="sd">            self.numvars.relerror = inf</span>
<span class="sd">        abserror = fabs(\</span>
<span class="sd">self.sequences.fluxes._q_results[self.numvars.idx_method]-\</span>
<span class="sd">self.sequences.fluxes._q_results[self.numvars.idx_method-1])</span>
<span class="sd">        self.numvars.abserror = max(self.numvars.abserror, abserror)</span>
<span class="sd">        if self.numvars.use_relerror:</span>
<span class="sd">            if self.sequences.fluxes._q_results[self.numvars.idx_method] == 0.:</span>
<span class="sd">                self.numvars.relerror = inf</span>
<span class="sd">            else:</span>
<span class="sd">                self.numvars.relerror = max(\</span>
<span class="sd">self.numvars.relerror, \</span>
<span class="sd">fabs(abserror/self.sequences.fluxes._q_results[self.numvars.idx_method]))</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._qv_length):</span>
<span class="sd">            abserror = fabs(\</span>
<span class="sd">self.sequences.fluxes._qv_results[self.numvars.idx_method, idx0]-\</span>
<span class="sd">self.sequences.fluxes._qv_results[self.numvars.idx_method-1, idx0])</span>
<span class="sd">            self.numvars.abserror = max(self.numvars.abserror, abserror)</span>
<span class="sd">            if self.numvars.use_relerror:</span>
<span class="sd">                if self.sequences.fluxes._qv_results\</span>
<span class="sd">[self.numvars.idx_method, idx0] == 0.:</span>
<span class="sd">                    self.numvars.relerror = inf</span>
<span class="sd">                else:</span>
<span class="sd">                    self.numvars.relerror = max(\</span>
<span class="sd">self.numvars.relerror, \</span>
<span class="sd">fabs(abserror/self.sequences.fluxes._qv_results[self.numvars.idx_method, idx0]))</span>
<span class="sd">&lt;BLANKLINE&gt;</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 2</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.calculate_error</span>
<span class="sd">            . calculate_error</span>
<span class="sd">    cpdef inline void calculate_error(self) nogil:</span>
<span class="sd">        cdef int idx0, idx1</span>
<span class="sd">        cdef double abserror</span>
<span class="sd">        self.numvars.abserror = 0.</span>
<span class="sd">        if self.numvars.use_relerror:</span>
<span class="sd">            self.numvars.relerror = 0.</span>
<span class="sd">        else:</span>
<span class="sd">            self.numvars.relerror = inf</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._q_length0):</span>
<span class="sd">            for idx1 in range(self.sequences.fluxes._q_length1):</span>
<span class="sd">                abserror = fabs(\</span>
<span class="sd">self.sequences.fluxes._q_results[self.numvars.idx_method, idx0, idx1]-\</span>
<span class="sd">self.sequences.fluxes._q_results[self.numvars.idx_method-1, idx0, idx1])</span>
<span class="sd">                self.numvars.abserror = max(self.numvars.abserror, abserror)</span>
<span class="sd">                if self.numvars.use_relerror:</span>
<span class="sd">                    if self.sequences.fluxes._q_results\</span>
<span class="sd">[self.numvars.idx_method, idx0, idx1] == 0.:</span>
<span class="sd">                        self.numvars.relerror = inf</span>
<span class="sd">                    else:</span>
<span class="sd">                        self.numvars.relerror = max(\</span>
<span class="sd">self.numvars.relerror, fabs(\</span>
<span class="sd">abserror/self.sequences.fluxes._q_results[self.numvars.idx_method, idx0, idx1]))</span>
<span class="sd">        for idx0 in range(self.sequences.fluxes._qv_length):</span>
<span class="sd">            abserror = fabs(\</span>
<span class="sd">self.sequences.fluxes._qv_results[self.numvars.idx_method, idx0]-\</span>
<span class="sd">self.sequences.fluxes._qv_results[self.numvars.idx_method-1, idx0])</span>
<span class="sd">            self.numvars.abserror = max(self.numvars.abserror, abserror)</span>
<span class="sd">            if self.numvars.use_relerror:</span>
<span class="sd">                if self.sequences.fluxes._qv_results\</span>
<span class="sd">[self.numvars.idx_method, idx0] == 0.:</span>
<span class="sd">                    self.numvars.relerror = inf</span>
<span class="sd">                else:</span>
<span class="sd">                    self.numvars.relerror = max(\</span>
<span class="sd">self.numvars.relerror, \</span>
<span class="sd">fabs(abserror/self.sequences.fluxes._qv_results[self.numvars.idx_method, idx0]))</span>
<span class="sd">&lt;BLANKLINE&gt;</span>

<span class="sd">&gt;&gt;&gt; pyxwriter.model.sequences.fluxes.q.NDIM = 3</span>
<span class="sd">&gt;&gt;&gt; pyxwriter.calculate_error</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">...</span>
<span class="sd">NotImplementedError: NDIM of sequence `q` is higher than expected.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># import...</span>
<span class="c1"># ...from standard library</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">distutils.core</span>
<span class="kn">import</span> <span class="nn">distutils.extension</span>

<span class="c1"># pylint: enable=no-name-in-module</span>
<span class="c1"># pylint: enable=import-error</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># ...third party modules</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">inf</span>  <span class="c1"># pylint: disable=unused-import</span>

<span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">nan</span>  <span class="c1"># pylint: disable=unused-import</span>

<span class="c1"># ...from HydPy</span>
<span class="kn">import</span> <span class="nn">hydpy</span>
<span class="kn">from</span> <span class="nn">hydpy</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">hydpy</span> <span class="kn">import</span> <span class="n">cythons</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">exceptiontools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">importtools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">modeltools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">objecttools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">parametertools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">printtools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">sequencetools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">testtools</span>
<span class="kn">from</span> <span class="nn">hydpy.core</span> <span class="kn">import</span> <span class="n">typingtools</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Cython.Build</span> <span class="k">as</span> <span class="nn">build</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">build</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">OptionalImport</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Cython.Build&quot;</span><span class="p">],</span> <span class="nb">locals</span><span class="p">())</span>


<div class="viewcode-block" id="get_dllextension"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.get_dllextension">[docs]</a><span class="k">def</span> <span class="nf">get_dllextension</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the DLL file extension for the current operating system.</span>

<span class="sd">    The returned value depends on the response of function |platform.system|</span>
<span class="sd">    of module |platform|.  |get_dllextension| returns `.pyd` if</span>
<span class="sd">    |platform.system| returns the string &quot;windows&quot; and `.so` for</span>
<span class="sd">    all other strings:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import get_dllextension</span>
<span class="sd">    &gt;&gt;&gt; import platform</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch.object(</span>
<span class="sd">    ...     platform, &quot;system&quot;, side_effect=lambda: &quot;Windows&quot;) as mocked:</span>
<span class="sd">    ...     get_dllextension()</span>
<span class="sd">    &#39;.pyd&#39;</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch.object(</span>
<span class="sd">    ...     platform, &quot;system&quot;, side_effect=lambda: &quot;Linux&quot;) as mocked:</span>
<span class="sd">    ...     get_dllextension()</span>
<span class="sd">    &#39;.so&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;.pyd&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;.so&quot;</span></div>


<span class="n">_dllextension</span> <span class="o">=</span> <span class="n">get_dllextension</span><span class="p">()</span>

<span class="n">_int</span> <span class="o">=</span> <span class="s2">&quot;numpy.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_t&quot;</span>

<span class="n">TYPE2STR</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">bool</span><span class="p">:</span> <span class="s2">&quot;bint&quot;</span><span class="p">,</span>
    <span class="nb">int</span><span class="p">:</span> <span class="n">_int</span><span class="p">,</span>
    <span class="n">parametertools</span><span class="o">.</span><span class="n">IntConstant</span><span class="p">:</span> <span class="n">_int</span><span class="p">,</span>
    <span class="nb">float</span><span class="p">:</span> <span class="s2">&quot;double&quot;</span><span class="p">,</span>
    <span class="nb">str</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;void&quot;</span><span class="p">,</span>
    <span class="n">typingtools</span><span class="o">.</span><span class="n">Vector</span><span class="p">:</span> <span class="s2">&quot;double[:]&quot;</span><span class="p">,</span>  <span class="c1"># to be removed as soon as possible</span>
    <span class="n">typingtools</span><span class="o">.</span><span class="n">Vector</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span> <span class="s2">&quot;double[:]&quot;</span><span class="p">,</span>  <span class="c1"># This works because the `__getitem__`</span>
    <span class="c1"># of `_ProtocolMeta` is decorated by `_tp_cache`.  I don&#39;t know if this caching</span>
    <span class="c1"># is documented behaviour, so this might cause (little) trouble in the future.</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Maps Python types to Cython compatible type declarations.</span>

<span class="sd">The Cython type belonging to Python&#39;s |int| is selected to agree</span>
<span class="sd">with numpy&#39;s default integer type on the current platform/system.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">_checkable_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">maybe_a_type</span> <span class="ow">in</span> <span class="n">TYPE2STR</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maybe_a_type</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maybe_a_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
    <span class="n">_checkable_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maybe_a_type</span><span class="p">)</span>
<span class="n">CHECKABLE_TYPES</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_checkable_types</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;&quot;Real types&quot; of |TYPE2STR| allowed as second arguments of function |isinstance|.&quot;&quot;&quot;</span>
<span class="k">del</span> <span class="n">_checkable_types</span>

<span class="n">NDIM2STR</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;[:]&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;[:,:]&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;[:,:,:]&quot;</span><span class="p">}</span>

<span class="n">_nogil</span> <span class="o">=</span> <span class="s2">&quot; nogil&quot;</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">FASTCYTHON</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>


<div class="viewcode-block" id="Lines"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.Lines">[docs]</a><span class="k">class</span> <span class="nc">Lines</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles code lines for `.pyx` file.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="Lines.add"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.Lines.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">Mayberable1</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Append the given text line with prefixed spaces following</span>
<span class="sd">        the given number of indentation levels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subline</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">subline</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="get_methodheader"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.get_methodheader">[docs]</a><span class="k">def</span> <span class="nf">get_methodheader</span><span class="p">(</span><span class="n">methodname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nogil</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">idxarg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns the Cython method header for methods without arguments except</span>
<span class="sd">    `self`.</span>

<span class="sd">    Note the influence of the configuration flag `FASTCYTHON`:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import get_methodheader</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import config</span>
<span class="sd">    &gt;&gt;&gt; config.FASTCYTHON = False</span>
<span class="sd">    &gt;&gt;&gt; print(get_methodheader(methodname=&quot;test&quot;, nogil=True, idxarg=False))</span>
<span class="sd">    cpdef inline void test(self):</span>
<span class="sd">    &gt;&gt;&gt; config.FASTCYTHON = True</span>
<span class="sd">    &gt;&gt;&gt; print(get_methodheader(methodname=&quot;test&quot;, nogil=True, idxarg=True))</span>
<span class="sd">    cpdef inline void test(self, int idx) nogil:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">FASTCYTHON</span><span class="p">:</span>
        <span class="n">nogil</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cpdef inline void </span><span class="si">{</span><span class="n">methodname</span><span class="si">}</span><span class="s2">(self&quot;</span>
    <span class="n">header</span> <span class="o">+=</span> <span class="s2">&quot;, int idx)&quot;</span> <span class="k">if</span> <span class="n">idxarg</span> <span class="k">else</span> <span class="s2">&quot;)&quot;</span>
    <span class="n">header</span> <span class="o">+=</span> <span class="s2">&quot; nogil:&quot;</span> <span class="k">if</span> <span class="n">nogil</span> <span class="k">else</span> <span class="s2">&quot;:&quot;</span>
    <span class="k">return</span> <span class="n">header</span></div>


<div class="viewcode-block" id="decorate_method"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.decorate_method">[docs]</a><span class="k">def</span> <span class="nf">decorate_method</span><span class="p">(</span><span class="n">wrapped</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">property</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The decorated method returns a |Lines| object including</span>
<span class="sd">    a method header.  However, the |Lines| object is empty if</span>
<span class="sd">    the respective model does not implement a method with the</span>
<span class="sd">    same name as the wrapped method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            . </span><span class="si">{</span><span class="n">wrapped</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_methodheader</span><span class="p">(</span><span class="n">wrapped</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">)</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Lines of model method </span><span class="si">{</span><span class="n">wrapped</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cythonizer"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.Cythonizer">[docs]</a><span class="k">class</span> <span class="nc">Cythonizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Handles the writing, compiling and initialisation of Cython models.&quot;&quot;&quot;</span>

    <span class="n">Model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;modeltools.Model&quot;</span><span class="p">]</span>
    <span class="n">Parameters</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">parametertools</span><span class="o">.</span><span class="n">Parameters</span><span class="p">]</span>
    <span class="n">Sequences</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">Sequences</span><span class="p">]</span>
    <span class="n">tester</span><span class="p">:</span> <span class="n">testtools</span><span class="o">.</span><span class="n">Tester</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cymodule</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pymodule</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="s2">&quot;__name__&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Cythonizer.finalise"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.Cythonizer.finalise">[docs]</a>    <span class="k">def</span> <span class="nf">finalise</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="sd">&quot;&quot;&quot;Test and cythonize the relevant model eventually.</span>

<span class="sd">        Method |Cythonizer.finalise| might call method |Cythonizer.cythonize|</span>
<span class="sd">        and method |Tester.perform_tests| depending on the actual values</span>
<span class="sd">        of the options |Options.autocompile|, |Options.usecython|, and</span>
<span class="sd">        |Options.skipdoctests| as well the value currently returned</span>
<span class="sd">        by property |Cythonizer.outdated|.  To explain and test the</span>
<span class="sd">        considerable amount of relevant combinations, we make use of Python&#39;s</span>
<span class="sd">        |unittest| `mock` library.</span>

<span class="sd">        First, we import the |Cythonizer| instance responsible for</span>
<span class="sd">        application model |hland_v1|, the classes |Cythonizer| and</span>
<span class="sd">        |Tester|, module |pub|, and the |unittest| `mock` library:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import Cythonizer</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.testtools import Tester</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">        &gt;&gt;&gt; from unittest import mock</span>

<span class="sd">        Second, we memorise the relevant settings to restore them later:</span>

<span class="sd">        &gt;&gt;&gt; autocompile = pub.options.autocompile</span>
<span class="sd">        &gt;&gt;&gt; skipdoctests = pub.options.skipdoctests</span>
<span class="sd">        &gt;&gt;&gt; usecython = pub.options.usecython</span>
<span class="sd">        &gt;&gt;&gt; outdated = Cythonizer.outdated</span>

<span class="sd">        Third, we define a test function mocking methods</span>
<span class="sd">        |Cythonizer.cythonize| and |Tester.perform_tests|, printing</span>
<span class="sd">        when the mocks are called and providing information on the</span>
<span class="sd">        current value of option |Options.usecython|:</span>

<span class="sd">        &gt;&gt;&gt; def test():</span>
<span class="sd">        ...     sc = lambda: print(</span>
<span class="sd">        ...         f&quot;calling method `cythonize` &quot;</span>
<span class="sd">        ...         f&quot;(usecython={bool(pub.options.usecython)})&quot;)</span>
<span class="sd">        ...     se = lambda: print(</span>
<span class="sd">        ...         f&quot;calling method `perform_tests` &quot;</span>
<span class="sd">        ...         f&quot;(usecython={bool(pub.options.usecython)})&quot;)</span>
<span class="sd">        ...     with mock.patch.object(</span>
<span class="sd">        ...                 Cythonizer, &quot;cythonize&quot;, side_effect=sc) as mc,\\</span>
<span class="sd">        ...             mock.patch.object(</span>
<span class="sd">        ...                 Tester, &quot;perform_tests&quot;, side_effect=se) as mt:</span>
<span class="sd">        ...         cythonizer.finalise()</span>

<span class="sd">        With either option |Options.autocompile| or property</span>
<span class="sd">        |Cythonizer.outdated| being |False|, nothing happens:</span>

<span class="sd">        &gt;&gt;&gt; pub.options.autocompile = False</span>
<span class="sd">        &gt;&gt;&gt; Cythonizer.outdated = True</span>
<span class="sd">        &gt;&gt;&gt; test()</span>

<span class="sd">        &gt;&gt;&gt; pub.options.autocompile = True</span>
<span class="sd">        &gt;&gt;&gt; Cythonizer.outdated = False</span>
<span class="sd">        &gt;&gt;&gt; test()</span>

<span class="sd">        Option |Options.usecython| enables/disables the actual cythonization</span>
<span class="sd">        and option |Options.skipdoctests| enables/disables the testing</span>
<span class="sd">        of the Python model and, if available, of the Cython model:</span>

<span class="sd">        &gt;&gt;&gt; Cythonizer.outdated = True</span>
<span class="sd">        &gt;&gt;&gt; pub.options.usecython = False</span>
<span class="sd">        &gt;&gt;&gt; pub.options.skipdoctests = True</span>
<span class="sd">        &gt;&gt;&gt; test()</span>

<span class="sd">        &gt;&gt;&gt; pub.options.skipdoctests = False</span>
<span class="sd">        &gt;&gt;&gt; test()</span>
<span class="sd">        calling method `perform_tests` (usecython=False)</span>

<span class="sd">        &gt;&gt;&gt; pub.options.usecython = True</span>
<span class="sd">        &gt;&gt;&gt; pub.options.skipdoctests = True</span>
<span class="sd">        &gt;&gt;&gt; test()</span>
<span class="sd">        calling method `cythonize` (usecython=True)</span>

<span class="sd">        &gt;&gt;&gt; pub.options.skipdoctests = False</span>
<span class="sd">        &gt;&gt;&gt; test()</span>
<span class="sd">        calling method `perform_tests` (usecython=False)</span>
<span class="sd">        calling method `cythonize` (usecython=False)</span>
<span class="sd">        calling method `perform_tests` (usecython=True)</span>

<span class="sd">        &gt;&gt;&gt; pub.options.autocompile = autocompile</span>
<span class="sd">        &gt;&gt;&gt; Cythonizer.outdated = outdated</span>
<span class="sd">        &gt;&gt;&gt; pub.options.skipdoctests = skipdoctests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">autocompile</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdated</span><span class="p">:</span>
            <span class="n">usecython</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">usecython</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">skipdoctests</span><span class="p">:</span>
                    <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">usecython</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tester</span><span class="o">.</span><span class="n">perform_tests</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">usecython</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cythonize</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">skipdoctests</span><span class="p">:</span>
                        <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">usecython</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tester</span><span class="o">.</span><span class="n">perform_tests</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">usecython</span> <span class="o">=</span> <span class="n">usecython</span></div>

<div class="viewcode-block" id="Cythonizer.cythonize"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.Cythonizer.cythonize">[docs]</a>    <span class="k">def</span> <span class="nf">cythonize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Translate Python source code of the relevant model first into</span>
<span class="sd">        Cython and then into C, compile it, and move the resulting dll</span>
<span class="sd">        file to the `autogen` subfolder of subpackage `cythons`.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">printtools</span><span class="o">.</span><span class="n">PrintStyle</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Translate module/package </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pyname</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">printtools</span><span class="o">.</span><span class="n">PrintStyle</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pyxwriter</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">printtools</span><span class="o">.</span><span class="n">PrintStyle</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compile module </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cyname</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">printtools</span><span class="o">.</span><span class="n">PrintStyle</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_dll</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pyname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Name of the original Python module or package.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; cythonizer.pyname</span>
<span class="sd">        &#39;hland&#39;</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; cythonizer.pyname</span>
<span class="sd">        &#39;hland_v1&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pymodule</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cyname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Name of the compiled module.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; cythonizer.cyname</span>
<span class="sd">        &#39;c_hland&#39;</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; cythonizer.cyname</span>
<span class="sd">        &#39;c_hland_v1&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;c_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyname</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cydirpath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The absolute path of the directory containing the compiled modules.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import repr_</span>
<span class="sd">        &gt;&gt;&gt; repr_(cythonizer.cydirpath)   # doctest: +ELLIPSIS</span>
<span class="sd">        &#39;.../hydpy/cythons/autogen&#39;</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; os.path.exists(cythonizer.cydirpath)</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cythons</span><span class="o">.</span><span class="n">autogen</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore[attr-defined, name-defined]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cymodule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The compiled module.</span>

<span class="sd">        Property |Cythonizer.cymodule| returns the relevant DLL module:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.autogen import c_hland_v1</span>
<span class="sd">        &gt;&gt;&gt; c_hland_v1 is cythonizer.cymodule</span>
<span class="sd">        True</span>

<span class="sd">        However, if this module is missing for some reasons, it tries to</span>
<span class="sd">        create the module first and returns it afterwards.  For demonstration</span>
<span class="sd">        purposes, we define a wrong |Cythonizer.cyname|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import Cythonizer</span>
<span class="sd">        &gt;&gt;&gt; cyname = Cythonizer.cyname</span>
<span class="sd">        &gt;&gt;&gt; Cythonizer.cyname = &quot;wrong&quot;</span>
<span class="sd">        &gt;&gt;&gt; cythonizer._cymodule = None</span>
<span class="sd">        &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">        &gt;&gt;&gt; with mock.patch.object(Cythonizer, &quot;cythonize&quot;) as mock:</span>
<span class="sd">        ...     cythonizer.cymodule</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ModuleNotFoundError: No module named &#39;hydpy.cythons.autogen.wrong&#39;</span>
<span class="sd">        &gt;&gt;&gt; mock.call_args_list</span>
<span class="sd">        [call()]</span>

<span class="sd">        &gt;&gt;&gt; Cythonizer.cyname = cyname</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cymodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cymodule</span>
        <span class="k">if</span> <span class="n">cymodule</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cymodule</span>
        <span class="n">modulepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;hydpy.cythons.autogen.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cyname</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cymodule</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modulepath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cythonize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cymodule</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modulepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cymodule</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pyxfilepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The absolute path of the compiled module.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import repr_</span>
<span class="sd">        &gt;&gt;&gt; repr_(cythonizer.pyxfilepath)   # doctest: +ELLIPSIS</span>
<span class="sd">        &#39;.../hydpy/cythons/autogen/c_hland_v1.pyx&#39;</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; os.path.exists(cythonizer.pyxfilepath)</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cydirpath</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cyname</span><span class="si">}</span><span class="s2">.pyx&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dllfilepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The absolute path of the compiled module.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import repr_</span>
<span class="sd">        &gt;&gt;&gt; repr_(cythonizer.dllfilepath)   # doctest: +ELLIPSIS</span>
<span class="sd">        &#39;.../hydpy/cythons/autogen/c_hland_v1...&#39;</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; os.path.exists(cythonizer.dllfilepath)</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cydirpath</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cyname</span><span class="si">}{</span><span class="n">_dllextension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">buildpath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The absolute path for temporarily build files.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import repr_</span>
<span class="sd">        &gt;&gt;&gt; repr_(cythonizer.buildpath)   # doctest: +ELLIPSIS</span>
<span class="sd">        &#39;.../hydpy/cythons/autogen/_build&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cydirpath</span><span class="p">,</span> <span class="s2">&quot;_build&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pyxwriter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PyxWriter&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;A new |PyxWriter| instance.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter = cythonizer.pyxwriter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import classname</span>
<span class="sd">        &gt;&gt;&gt; classname(pyxwriter)</span>
<span class="sd">        &#39;PyxWriter&#39;</span>
<span class="sd">        &gt;&gt;&gt; cythonizer.pyxwriter is pyxwriter</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">dict_</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_parameters</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">sequences</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_sequences</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyxWriter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyxfilepath</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pysourcefiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="sd">&quot;&quot;&quot;All relevant source files of the actual model.</span>

<span class="sd">        We consider source files to be relevant if they are part of the</span>
<span class="sd">        *HydPy* package and if they define ancestors of the classes of</span>
<span class="sd">        the considered model.</span>

<span class="sd">        For the base model |hland|, all relevant modules seem to be covered:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; import os, pprint</span>
<span class="sd">        &gt;&gt;&gt; pprint.pprint([fn.split(os.path.sep)[-1] for fn in</span>
<span class="sd">        ...                sorted(cythonizer.pysourcefiles)])</span>
<span class="sd">        [&#39;masktools.py&#39;,</span>
<span class="sd">         &#39;modeltools.py&#39;,</span>
<span class="sd">         &#39;parametertools.py&#39;,</span>
<span class="sd">         &#39;sequencetools.py&#39;,</span>
<span class="sd">         &#39;testtools.py&#39;,</span>
<span class="sd">         &#39;variabletools.py&#39;,</span>
<span class="sd">         &#39;modelutils.py&#39;,</span>
<span class="sd">         &#39;__init__.py&#39;,</span>
<span class="sd">         &#39;hland_masks.py&#39;,</span>
<span class="sd">         &#39;hland_model.py&#39;]</span>

<span class="sd">        However, this is not the case for application model |hland_v1|,</span>
<span class="sd">        where the base model files are missing.  Hence, relevant</span>
<span class="sd">        changes in its base model might not be detected, resulting in</span>
<span class="sd">        an outdated application model.  This issue is relevant for</span>
<span class="sd">        developers only, but we should fix it someday:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; import os, pprint</span>
<span class="sd">        &gt;&gt;&gt; pprint.pprint([fn.split(os.path.sep)[-1] for fn in</span>
<span class="sd">        ...                sorted(cythonizer.pysourcefiles)])</span>
<span class="sd">        [&#39;masktools.py&#39;,</span>
<span class="sd">         &#39;modeltools.py&#39;,</span>
<span class="sd">         &#39;parametertools.py&#39;,</span>
<span class="sd">         &#39;sequencetools.py&#39;,</span>
<span class="sd">         &#39;testtools.py&#39;,</span>
<span class="sd">         &#39;variabletools.py&#39;,</span>
<span class="sd">         &#39;modelutils.py&#39;,</span>
<span class="sd">         &#39;hland_v1.py&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore[attr-defined, name-defined]</span>
        <span class="n">filepaths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parents</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">basepath</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
                    <span class="n">filepaths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outdated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;True/False flag indicating whether a |Cythonizer| object</span>
<span class="sd">        should renew its Cython model or not.</span>

<span class="sd">        With option |Options.forcecompiling| being |True|, property</span>
<span class="sd">        |Cythonizer.outdated| also return |True| under all circumstances:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">        &gt;&gt;&gt; forcecompiling = pub.options.forcecompiling</span>
<span class="sd">        &gt;&gt;&gt; pub.options.forcecompiling = True</span>
<span class="sd">        &gt;&gt;&gt; cythonizer.outdated</span>
<span class="sd">        True</span>

<span class="sd">        With option |Options.forcecompiling| being |False|, property</span>
<span class="sd">        |Cythonizer.outdated| generally return |False| if *HydPy* is</span>
<span class="sd">        a site-package (under the assumption the user does not modify</span>
<span class="sd">        his site-package files and for reasons of efficiency due to</span>
<span class="sd">        skipping the following tests):</span>

<span class="sd">        &gt;&gt;&gt; pub.options.forcecompiling = False</span>
<span class="sd">        &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">        &gt;&gt;&gt; with mock.patch(&quot;hydpy.__path__&quot;, [&quot;folder/somename-packages/hydpy&quot;]):</span>
<span class="sd">        ...     cythonizer.outdated</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; with mock.patch(&quot;hydpy.__path__&quot;, [&quot;folder/pkgs/hydpy&quot;]):</span>
<span class="sd">        ...     cythonizer.outdated</span>
<span class="sd">        False</span>

<span class="sd">        When working with a &quot;local&quot; *HydPy* package (that is not part</span>
<span class="sd">        of the site-packages directory) property |Cythonizer.outdated|</span>
<span class="sd">        returns |True| if the required DLL file is not available at all:</span>

<span class="sd">        &gt;&gt;&gt; with mock.patch(&quot;hydpy.__path__&quot;, [&quot;folder/local_dir/hydpy&quot;]):</span>
<span class="sd">        ...     with mock.patch.object(</span>
<span class="sd">        ...             type(cythonizer), &quot;dllfilepath&quot;,</span>
<span class="sd">        ...             new_callable=mock.PropertyMock) as dllfilepath:</span>
<span class="sd">        ...         dllfilepath.return_value = &quot;missing&quot;</span>
<span class="sd">        ...         cythonizer.outdated</span>
<span class="sd">        True</span>

<span class="sd">        If the DLL file is available, property |Cythonizer.outdated|</span>
<span class="sd">        returns |True| or |False| depending on the timestamp of the</span>
<span class="sd">        DLL file itself and the timestamp of the newest file returned</span>
<span class="sd">        by property |Cythonizer.pysourcefiles|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():</span>
<span class="sd">        ...     with open(&quot;new.txt&quot;, &quot;w&quot;):</span>
<span class="sd">        ...         pass</span>
<span class="sd">        ...     with mock.patch(&quot;hydpy.__path__&quot;, [&quot;folder/local_dir/hydpy&quot;]):</span>
<span class="sd">        ...         with mock.patch.object(</span>
<span class="sd">        ...                 type(cythonizer), &quot;dllfilepath&quot;,</span>
<span class="sd">        ...                 new_callable=mock.PropertyMock) as mocked:</span>
<span class="sd">        ...             mocked.return_value = &quot;new.txt&quot;</span>
<span class="sd">        ...             cythonizer.outdated</span>
<span class="sd">        ...         with mock.patch.object(</span>
<span class="sd">        ...                 type(cythonizer), &quot;pysourcefiles&quot;,</span>
<span class="sd">        ...                 new_callable=mock.PropertyMock) as mocked:</span>
<span class="sd">        ...             mocked.return_value = [&quot;new.txt&quot;]</span>
<span class="sd">        ...             cythonizer.outdated</span>
<span class="sd">        False</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt;&gt; pub.options.forcecompiling = forcecompiling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">forcecompiling</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">hydpypath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore[attr-defined, name-defined]</span>
        <span class="n">foldername</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hydpypath</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">testname</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pkgs&quot;</span><span class="p">,</span> <span class="s2">&quot;packages&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dllfilepath</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">cydate</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dllfilepath</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="k">for</span> <span class="n">pysourcefile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pysourcefiles</span><span class="p">:</span>
            <span class="n">pydate</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">pysourcefile</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
            <span class="k">if</span> <span class="n">pydate</span> <span class="o">&gt;</span> <span class="n">cydate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Cythonizer.compile_"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.Cythonizer.compile_">[docs]</a>    <span class="k">def</span> <span class="nf">compile_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Translate Cython code to C code and compile it.&quot;&quot;&quot;</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;build_ext&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--build-lib=&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildpath</span><span class="p">,</span>
            <span class="s2">&quot;--build-temp=&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildpath</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">exc_modules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">distutils</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">Extension</span><span class="p">(</span>
                <span class="s2">&quot;hydpy.cythons.autogen.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cyname</span><span class="p">,</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pyxfilepath</span><span class="p">],</span>
                <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-O2&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">distutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span>
            <span class="n">ext_modules</span><span class="o">=</span><span class="n">build</span><span class="o">.</span><span class="n">cythonize</span><span class="p">(</span><span class="n">exc_modules</span><span class="p">),</span> <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">argv</span></div>

<div class="viewcode-block" id="Cythonizer.move_dll"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.Cythonizer.move_dll">[docs]</a>    <span class="k">def</span> <span class="nf">move_dll</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Try to find the DLL file created my method |Cythonizer.compile_|</span>
<span class="sd">        and to move it into the `autogen` folder of the `cythons` subpackage.</span>

<span class="sd">        Usually, one does not need to apply the |Cythonizer.move_dll| method</span>
<span class="sd">        directly.  However, if you are a model developer, you might</span>
<span class="sd">        see one of the following error messages from time to time:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; cythonizer.move_dll()   # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        OSError: After trying to cythonize model `hland_v1`, the resulting \</span>
<span class="sd">file `c_hland_v1...` could not be found in directory \</span>
<span class="sd">`.../hydpy/cythons/autogen/_build` nor any of its subdirectories.  \</span>
<span class="sd">The distutil report should tell whether the file has been stored \</span>
<span class="sd">somewhere else, is named somehow else, or could not be build at all.</span>

<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">        &gt;&gt;&gt; with TestIO():   # doctest: +ELLIPSIS</span>
<span class="sd">        ...     with mock.patch.object(</span>
<span class="sd">        ...             type(cythonizer), &quot;buildpath&quot;, new_callable=mock.PropertyMock</span>
<span class="sd">        ...     ) as mocked_buildpath:</span>
<span class="sd">        ...         mocked_buildpath.return_value = &quot;_build&quot;</span>
<span class="sd">        ...         os.makedirs(&quot;_build/subdir&quot;, exist_ok=True)</span>
<span class="sd">        ...         filepath = f&quot;_build/subdir/c_hland_v1{get_dllextension()}&quot;</span>
<span class="sd">        ...         with open(filepath, &quot;w&quot;):</span>
<span class="sd">        ...             pass</span>
<span class="sd">        ...         with mock.patch(</span>
<span class="sd">        ...                 &quot;shutil.move&quot;,</span>
<span class="sd">        ...                 side_effect=PermissionError(&quot;Denied!&quot;)):</span>
<span class="sd">        ...             cythonizer.move_dll()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        PermissionError: After trying to cythonize module `hland_v1`, \</span>
<span class="sd">when trying to move the final cython module `c_hland_v1...` from \</span>
<span class="sd">directory `_build` to directory `.../hydpy/cythons/autogen`, the \</span>
<span class="sd">following error occurred: Denied! A likely error cause is that the \</span>
<span class="sd">cython module `c_hland_v1...` does already exist in this directory \</span>
<span class="sd">and is currently blocked by another Python process.  Maybe it helps \</span>
<span class="sd">to close all Python processes and restart the cythonization afterwards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dirinfos</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildpath</span><span class="p">)</span>
        <span class="n">system_dependent_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">dirinfo</span> <span class="ow">in</span> <span class="n">dirinfos</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">dirinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cyname</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
                    <span class="n">_dllextension</span>
                <span class="p">):</span>
                    <span class="n">system_dependent_filename</span> <span class="o">=</span> <span class="n">filename</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">system_dependent_filename</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">system_dependent_filename</span><span class="p">),</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cydirpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cyname</span> <span class="o">+</span> <span class="n">_dllextension</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">objecttools</span><span class="o">.</span><span class="n">augment_excmessage</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;After trying to cythonize module `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pyname</span><span class="si">}</span><span class="s2">`, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;when trying to move the final cython module &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">system_dependent_filename</span><span class="si">}</span><span class="s2">` from directory &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buildpath</span><span class="si">}</span><span class="s2">` to directory &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cydirpath</span><span class="p">)</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;A likely error cause is that the cython module &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cyname</span><span class="si">}{</span><span class="n">_dllextension</span><span class="si">}</span><span class="s2">` does already exist &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;in this directory and is currently blocked by &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;another Python process.  Maybe it helps to close &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;all Python processes and restart the cythonization &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;afterwards.&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;After trying to cythonize model `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pyname</span><span class="si">}</span><span class="s2">`, the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;resulting file `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cyname</span><span class="si">}{</span><span class="n">_dllextension</span><span class="si">}</span><span class="s2">` could &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not be found in directory &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildpath</span><span class="p">)</span><span class="si">}</span><span class="s2">` nor any of its &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;subdirectories.  The distutil report should tell &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;whether the file has been stored somewhere else, is &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;named somehow else, or could not be build at all.&quot;</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="PyxWriter"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter">[docs]</a><span class="k">class</span> <span class="nc">PyxWriter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Translates the source code of Python models into Cython source code.</span>

<span class="sd">    Method |PyxWriter| serves as a master method, which triggers the</span>
<span class="sd">    complete writing process.  The other properties and methods supply</span>
<span class="sd">    the required code lines.  Their names are selected to match the</span>
<span class="sd">    names of the original Python models as close as possible.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cythonizer</span><span class="p">:</span> <span class="n">Cythonizer</span>
    <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;modeltools.Model&quot;</span>
    <span class="n">pyxpath</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cythonizer</span><span class="p">:</span> <span class="n">Cythonizer</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;modeltools.Model&quot;</span><span class="p">,</span> <span class="n">pyxpath</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cythonizer</span> <span class="o">=</span> <span class="n">cythonizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyxpath</span> <span class="o">=</span> <span class="n">pyxpath</span>

<div class="viewcode-block" id="PyxWriter.write"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Collect the source code and write it into a Cython extension</span>
<span class="sd">        file (&quot;pyx&quot;).&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pyxpath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pxf</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    * cython options&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cythondistutilsoptions</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    * C imports&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cimports</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    * constants (if defined)&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    * parameter classes&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    * sequence classes&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    * numerical parameters&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numericalparameters</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    * submodel classes&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submodels</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    * model class&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        - model attributes&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modeldeclarations</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        - standard functions&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelstandardfunctions</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        - numeric functions&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelnumericfunctions</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        - additional functions&quot;</span><span class="p">)</span>
            <span class="n">pxf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modeluserfunctions</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cythondistutilsoptions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;Cython and Distutils option lines.</span>

<span class="sd">        Use the configuration options &quot;FASTCYTHON&quot; and &quot;PROFILECYTHON&quot; to</span>
<span class="sd">        configure the cythonization processes as follows:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import PyxWriter</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter = PyxWriter(None, None, None)</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter.cythondistutilsoptions</span>
<span class="sd">        #!python</span>
<span class="sd">        # cython: language_level=3</span>
<span class="sd">        # cython: boundscheck=False</span>
<span class="sd">        # cython: wraparound=False</span>
<span class="sd">        # cython: initializedcheck=False</span>
<span class="sd">        # cython: cdivision=True</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import config</span>
<span class="sd">        &gt;&gt;&gt; config.FASTCYTHON = False</span>
<span class="sd">        &gt;&gt;&gt; config.PROFILECYTHON = True</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter.cythondistutilsoptions</span>
<span class="sd">        #!python</span>
<span class="sd">        # cython: language_level=3</span>
<span class="sd">        # cython: boundscheck=True</span>
<span class="sd">        # cython: wraparound=True</span>
<span class="sd">        # cython: initializedcheck=True</span>
<span class="sd">        # cython: cdivision=False</span>
<span class="sd">        # cython: linetrace=True</span>
<span class="sd">        # distutils: define_macros=CYTHON_TRACE=1</span>
<span class="sd">        # distutils: define_macros=CYTHON_TRACE_NOGIL=1</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        &gt;&gt;&gt; config.FASTCYTHON = True</span>
<span class="sd">        &gt;&gt;&gt; config.PROFILECYTHON = False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">FASTCYTHON</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">(</span>
                <span class="s2">&quot;#!python&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: language_level=3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: boundscheck=False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: wraparound=False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: initializedcheck=False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: cdivision=True&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">(</span>
                <span class="s2">&quot;#!python&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: language_level=3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: boundscheck=True&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: wraparound=True&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: initializedcheck=True&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# cython: cdivision=False&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">PROFILECYTHON</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;# cython: linetrace=True&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;# distutils: define_macros=CYTHON_TRACE=1&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;# distutils: define_macros=CYTHON_TRACE_NOGIL=1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cimports</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Import command lines.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Lines</span><span class="p">(</span>
            <span class="s2">&quot;import numpy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cimport numpy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from libc.math cimport exp, fabs, log, &quot;</span>
            <span class="s2">&quot;sin, cos, tan, asin, acos, atan, isnan, isinf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from libc.math cimport NAN as nan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from libc.math cimport INFINITY as inf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from libc.stdio cimport *&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from libc.stdlib cimport *&quot;</span><span class="p">,</span>
            <span class="s2">&quot;import cython&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from cpython.mem cimport PyMem_Malloc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from cpython.mem cimport PyMem_Realloc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from cpython.mem cimport PyMem_Free&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from hydpy.cythons.autogen cimport annutils&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from hydpy.cythons.autogen cimport configutils&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from hydpy.cythons.autogen import pointerutils&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from hydpy.cythons.autogen cimport pointerutils&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from hydpy.cythons.autogen cimport quadutils&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from hydpy.cythons.autogen cimport rootutils&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from hydpy.cythons.autogen cimport smoothutils&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">constants</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Constants declaration lines.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cythonizer</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">name</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">CHECKABLE_TYPES</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">member</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span>
                <span class="n">ctype</span> <span class="o">=</span> <span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">member</span><span class="p">)]</span> <span class="o">+</span> <span class="n">NDIM2STR</span><span class="p">[</span><span class="n">ndim</span><span class="p">]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">member</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Parameter declaration lines.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;@cython.final&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cdef class Parameters:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subpars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">subpars</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">subpars</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subpars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        - </span><span class="si">{</span><span class="n">subpars</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;@cython.final&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef class </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">subpars</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">subpars</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ctype</span> <span class="o">=</span> <span class="n">TYPE2STR</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">TYPE</span><span class="p">]</span> <span class="o">+</span> <span class="n">NDIM2STR</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">NDIM</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">ctype</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">TYPE</span> <span class="o">+</span> <span class="n">NDIM2STR</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">NDIM</span><span class="p">]</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Sequence declaration lines.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;@cython.final&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cdef class Sequences:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subseqs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">subseqs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public StateSequences old_states&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public StateSequences new_states&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subseqs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        - </span><span class="si">{</span><span class="n">subseqs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;@cython.final&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef class </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
                <span class="n">ctype</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;double</span><span class="si">{</span><span class="n">NDIM2STR</span><span class="p">[</span><span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef double *</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef double **</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public int len_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="si">}</span><span class="s2">[:] _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ready&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public int _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ndim&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public int _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public int _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NUMERIC</span><span class="p">:</span>
                    <span class="n">ctype_numeric</span> <span class="o">=</span> <span class="s2">&quot;double&quot;</span> <span class="o">+</span> <span class="n">NDIM2STR</span><span class="p">[</span><span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">ctype_numeric</span><span class="si">}</span><span class="s2"> _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_points&quot;</span><span class="p">)</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">ctype_numeric</span><span class="si">}</span><span class="s2"> _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_results&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">FluxSequences</span><span class="p">):</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">ctype_numeric</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_integrals&quot;</span>
                        <span class="p">)</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s2"> _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_sum&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequences</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iosequence</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequences</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_files</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close_files</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_pointer</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">subseqs</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">sequencetools</span><span class="o">.</span><span class="n">InputSequences</span><span class="p">,</span>
                    <span class="n">sequencetools</span><span class="o">.</span><span class="n">OutputSequences</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_pointer</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">OutputSequences</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_outputs</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lines</span>

<div class="viewcode-block" id="PyxWriter.iosequence"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.iosequence">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">iosequence</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Declaration lines for the given |IOSequence| object.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public bint _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_diskflag&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public str _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_path&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef FILE *_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public bint _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ramflag&quot;</span><span class="p">)</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;double</span><span class="si">{</span><span class="n">NDIM2STR</span><span class="p">[</span><span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s2"> _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InputSequence</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public bint _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inputflag&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef double *_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inputpointer&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">OutputSequence</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public bint _</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_outputflag&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef double *_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_outputpointer&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.open_files"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.open_files">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">open_files</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Open file statements.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . open_files&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cpdef open_files(self, int idx):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;if self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_diskflag:&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="mi">3</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file = &quot;</span>
                <span class="sa">f</span><span class="s1">&#39;fopen(str(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_path).encode(), &quot;rb+&quot;)&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fseek(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file, idx*8, SEEK_SET)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;fseek(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;idx*self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length*8, SEEK_SET)&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.close_files"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.close_files">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">close_files</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Close file statements.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . close_files&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cpdef inline close_files(self):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;if self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_diskflag:&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fclose(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.load_data"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.load_data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Load data statements.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . load_data&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cpdef inline void load_data(self, int idx) </span><span class="si">{</span><span class="n">_nogil</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;cdef int jdx0, jdx1, jdx2, jdx3, jdx4, jdx5&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InputSequence</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;if self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inputflag:&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inputpointer[0]&quot;</span><span class="p">)</span>
                <span class="n">if_or_elif</span> <span class="o">=</span> <span class="s2">&quot;elif&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">if_or_elif</span> <span class="o">=</span> <span class="s2">&quot;if&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">if_or_elif</span><span class="si">}</span><span class="s2"> self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_diskflag:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fread(&amp;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, 8, 1, self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;fread(&amp;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[0], 8, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length, self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file)&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;elif self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ramflag:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_array[idx]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indexing</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="mi">3</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;for jdx</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> in &quot;</span> <span class="sa">f</span><span class="s2">&quot;range(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">indexing</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;jdx</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="n">indexing</span> <span class="o">=</span> <span class="n">indexing</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="mi">3</span> <span class="o">+</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">indexing</span><span class="si">}</span><span class="s2">] = &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_array[idx, </span><span class="si">{</span><span class="n">indexing</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.save_data"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.save_data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Save data statements.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . save_data&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cpdef inline void save_data(self, int idx) </span><span class="si">{</span><span class="n">_nogil</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;cdef int jdx0, jdx1, jdx2, jdx3, jdx4, jdx5&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InputSequence</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;if self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inputflag:&quot;</span><span class="p">)</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;if self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_diskflag:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fwrite(&amp;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, 8, 1, self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;fwrite(&amp;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[0], 8, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length, self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_file)&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;elif self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ramflag:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_array[idx] = self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indexing</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;for jdx</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> in &quot;</span> <span class="sa">f</span><span class="s2">&quot;range(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">indexing</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;jdx</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">,&quot;</span>
                <span class="n">indexing</span> <span class="o">=</span> <span class="n">indexing</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="mi">3</span> <span class="o">+</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_array[idx, </span><span class="si">{</span><span class="n">indexing</span><span class="si">}</span><span class="s2">] = &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">indexing</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.set_pointer"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.set_pointer">[docs]</a>    <span class="k">def</span> <span class="nf">set_pointer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subseqs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">sequencetools</span><span class="o">.</span><span class="n">InputSequences</span><span class="p">,</span>
            <span class="n">sequencetools</span><span class="o">.</span><span class="n">OutputSequences</span><span class="p">,</span>
            <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set pointer statements for all input, output, and link sequences.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InputSequences</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_pointerinput</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">OutputSequences</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_pointeroutput</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_pointer0d</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dealloc</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_pointer1d</span><span class="p">(</span><span class="n">subseqs</span><span class="p">))</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.set_pointer0d"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.set_pointer0d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_pointer0d</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set pointer statements for 0-dimensional link sequences.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . set_pointer0d&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;cpdef inline set_pointer0d&quot;</span> <span class="s2">&quot;(self, str name, pointerutils.Double value):&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;cdef pointerutils.PDouble pointer = &quot;</span> <span class="s2">&quot;pointerutils.PDouble(value)&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if name == &quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = pointer.p_value&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.get_value"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.get_value">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get value statements for link sequences.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . get_value&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cpdef get_value(self, str name):&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;cdef int idx&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if name == &quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;return self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[0]&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;values = numpy.empty(self.len_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;for idx in range(self.len_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
                <span class="n">PyxWriter</span><span class="o">.</span><span class="n">_check_pointer</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;values[idx] = self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[idx][0]&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;return values&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.set_value"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.set_value">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set value statements for link sequences.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . set_value&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cpdef set_value(self, str name, value):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if name == &quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[0] = value&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;for idx in range(self.len_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
                <span class="n">PyxWriter</span><span class="o">.</span><span class="n">_check_pointer</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[idx][0] = value[idx]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_pointer</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">Lines</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;pointerutils.check0(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length_0)&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;if self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ready[idx] == 0:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;pointerutils.check1(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length_0, idx)&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;pointerutils.check2(self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ready, idx)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PyxWriter.alloc"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.alloc">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Allocate memory statements for 1-dimensional link sequences.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . setlength&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cpdef inline alloc(self, name, </span><span class="si">{</span><span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="si">}</span><span class="s2"> length):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if name == &quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length_0 = length&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="mi">3</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ready = &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;numpy.full(length, 0, dtype=</span><span class="si">{</span> <span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="mi">3</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&lt;double**&gt; PyMem_Malloc(length * sizeof(double*))&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.dealloc"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.dealloc">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dealloc</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Deallocate memory statements for 1-dimensional link sequences.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . dealloc&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cpdef inline dealloc(self, name):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if name == &quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;PyMem_Free(self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.set_pointer1d"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.set_pointer1d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_pointer1d</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">LinkSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set_pointer statements for 1-dimensional link sequences.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . set_pointer1d&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;cpdef inline set_pointer1d&quot;</span>
            <span class="s2">&quot;(self, str name, pointerutils.Double value, int idx):&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;cdef pointerutils.PDouble pointer = &quot;</span> <span class="s2">&quot;pointerutils.PDouble(value)&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if name == &quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[idx] = pointer.p_value&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_ready[idx] = 1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.set_pointerinput"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.set_pointerinput">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_pointerinput</span><span class="p">(</span><span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">InputSequences</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set pointer statements for input sequences.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . set_pointerinput&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;cpdef inline set_pointerinput&quot;</span>
            <span class="s2">&quot;(self, str name, pointerutils.PDouble value):&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if name == &quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inputpointer = value.p_value&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.set_pointeroutput"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.set_pointeroutput">[docs]</a>    <span class="k">def</span> <span class="nf">set_pointeroutput</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subseqs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">OutputSequences</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set pointer statements for output sequences.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . set_pointeroutput&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;cpdef inline set_pointeroutput&quot;</span>
            <span class="s2">&quot;(self, str name, pointerutils.PDouble value):&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">subseqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_outputsequences</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if name == &quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_outputpointer = value.p_value&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;pass&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_filter_outputsequences</span><span class="p">(</span><span class="n">subseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">subseq</span> <span class="k">for</span> <span class="n">subseq</span> <span class="ow">in</span> <span class="n">subseqs</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">subseq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">numericalparameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Numeric parameter declaration lines.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">SolverModel</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;@cython.final&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cdef class NumConsts:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nmb_methods&quot;</span><span class="p">,</span> <span class="s2">&quot;nmb_stages&quot;</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dt_increase&quot;</span><span class="p">,</span> <span class="s2">&quot;dt_decrease&quot;</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public configutils.Config pub&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public double[:, :, :] a_coefs&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cdef class NumVars:&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public bint use_relerror&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nmb_calls&quot;</span><span class="p">,</span> <span class="s2">&quot;idx_method&quot;</span><span class="p">,</span> <span class="s2">&quot;idx_stage&quot;</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;t0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dt_est&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abserror&quot;</span><span class="p">,</span>
                <span class="s2">&quot;relerror&quot;</span><span class="p">,</span>
                <span class="s2">&quot;last_abserror&quot;</span><span class="p">,</span>
                <span class="s2">&quot;last_relerror&quot;</span><span class="p">,</span>
                <span class="s2">&quot;extrapolated_abserror&quot;</span><span class="p">,</span>
                <span class="s2">&quot;extrapolated_relerror&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">TYPE2STR</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span><span class="si">}</span><span class="s2"> f0_ready&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">submodels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Submodel declaration lines.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">submodel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SUBMODELS</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;@cython.final&quot;</span><span class="p">)</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">submodel</span><span class="o">.</span><span class="n">CYTHONBASECLASS</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;cdef class </span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">classname</span><span class="p">(</span><span class="n">submodel</span><span class="p">)</span><span class="si">}</span><span class="s2">(&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">classname</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cpdef public Model model&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;def __init__(self, Model model):&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.model = model&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">submodel</span><span class="o">.</span><span class="n">METHODS</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cpdef double apply_method</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">(self, double x) nogil:&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;return self.model.</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">(x)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">modeldeclarations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The attribute declarations of the model class.&quot;&quot;&quot;</span>
        <span class="n">submodels</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;SUBMODELS&quot;</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;@cython.final&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cdef class Model:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">member</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">IndexProperty</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public int </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public Parameters parameters&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public Sequences sequences&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">submodel</span> <span class="ow">in</span> <span class="n">submodels</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cdef public </span><span class="si">{</span><span class="n">submodel</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">submodel</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;numconsts&quot;</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public NumConsts numconsts&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;numvars&quot;</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cdef public NumVars numvars&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">submodels</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;def __init__(self):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">submodel</span> <span class="ow">in</span> <span class="n">submodels</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">submodel</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">submodel</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(self)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">modelstandardfunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The standard functions of the model class.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulate</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iofunctions</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new2old</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">AdHocModel</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_inlets</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_outlets</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_receivers</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_senders</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_outputs_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">modelnumericfunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Numerical integration functions of the model class.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">SolverModel</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_single_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_full_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_point_states</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_point_states</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_result_states</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sum_fluxes</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_point_fluxes</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_result_fluxes</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrate_fluxes</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_sum_fluxes</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addup_fluxes</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_error</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extrapolate_error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Simulation statements.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                . simulate&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cpdef inline void simulate(self, int idx) </span><span class="si">{</span><span class="n">_nogil</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.idx_sim = idx&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.load_data()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">INLET_METHODS</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.update_inlets()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">SolverModel</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.solve()&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.run()&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.new2old()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">OUTLET_METHODS</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.update_outlets()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.update_outputs()&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iofunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Input/output functions of the model class.</span>

<span class="sd">        The result of property |PyxWriter.iofunctions| depends on the</span>
<span class="sd">        availability of different types of sequences.  So far, the</span>
<span class="sd">        models implemented in *HydPy* do not reflect all possible</span>
<span class="sd">        combinations, which is why we modify the |hland_v1| application</span>
<span class="sd">        model in the following examples:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland_v1 import cythonizer</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter = cythonizer.pyxwriter</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter.iofunctions</span>
<span class="sd">                    . open_files</span>
<span class="sd">                    . close_files</span>
<span class="sd">                    . load_data</span>
<span class="sd">                    . save_data</span>
<span class="sd">            cpdef inline void open_files(self):</span>
<span class="sd">                self.sequences.inputs.open_files(self.idx_sim)</span>
<span class="sd">                self.sequences.fluxes.open_files(self.idx_sim)</span>
<span class="sd">                self.sequences.states.open_files(self.idx_sim)</span>
<span class="sd">            cpdef inline void close_files(self):</span>
<span class="sd">                self.sequences.inputs.close_files()</span>
<span class="sd">                self.sequences.fluxes.close_files()</span>
<span class="sd">                self.sequences.states.close_files()</span>
<span class="sd">            cpdef inline void load_data(self) nogil:</span>
<span class="sd">                self.sequences.inputs.load_data(self.idx_sim)</span>
<span class="sd">            cpdef inline void save_data(self, int idx) nogil:</span>
<span class="sd">                self.sequences.inputs.save_data(self.idx_sim)</span>
<span class="sd">                self.sequences.fluxes.save_data(self.idx_sim)</span>
<span class="sd">                self.sequences.states.save_data(self.idx_sim)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        &gt;&gt;&gt; pyxwriter.model.sequences.fluxes = None</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter.model.sequences.states = None</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter.iofunctions</span>
<span class="sd">                    . open_files</span>
<span class="sd">                    . close_files</span>
<span class="sd">                    . load_data</span>
<span class="sd">                    . save_data</span>
<span class="sd">            cpdef inline void open_files(self):</span>
<span class="sd">                self.sequences.inputs.open_files(self.idx_sim)</span>
<span class="sd">            cpdef inline void close_files(self):</span>
<span class="sd">                self.sequences.inputs.close_files()</span>
<span class="sd">            cpdef inline void load_data(self) nogil:</span>
<span class="sd">                self.sequences.inputs.load_data(self.idx_sim)</span>
<span class="sd">            cpdef inline void save_data(self, int idx) nogil:</span>
<span class="sd">                self.sequences.inputs.save_data(self.idx_sim)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        &gt;&gt;&gt; pyxwriter.model.sequences.inputs = None</span>
<span class="sd">        &gt;&gt;&gt; pyxwriter.iofunctions</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">lines</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;open_files&quot;</span><span class="p">,</span> <span class="s2">&quot;close_files&quot;</span><span class="p">,</span> <span class="s2">&quot;load_data&quot;</span><span class="p">,</span> <span class="s2">&quot;save_data&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;load_data&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            . </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">nogil</span> <span class="o">=</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;load_data&quot;</span><span class="p">,</span> <span class="s2">&quot;save_data&quot;</span><span class="p">)</span>
            <span class="n">idx_as_arg</span> <span class="o">=</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;save_data&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_methodheader</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="n">nogil</span><span class="p">,</span> <span class="n">idxarg</span><span class="o">=</span><span class="n">idx_as_arg</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">subseqs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;load_data&quot;</span><span class="p">:</span>
                    <span class="n">applyfuncs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">applyfuncs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;fluxes&quot;</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subseqs</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">applyfuncs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;close_files&quot;</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.</span><span class="si">{</span><span class="n">subseqs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">()&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.</span><span class="si">{</span><span class="n">subseqs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">(self.idx_sim)&quot;</span>
                        <span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">new2old</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Old states to new states statements.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                . new2old&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_methodheader</span><span class="p">(</span><span class="s2">&quot;new2old&quot;</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;cdef int jdx0, jdx1, jdx2, jdx3, jdx4, jdx5&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="mi">2</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;self.sequences.old_states.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;self.sequences.new_states.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indexing</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">):</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;for jdx</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> in range(self.sequences.states.&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">indexing</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;jdx</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">,&quot;</span>
                    <span class="n">indexing</span> <span class="o">=</span> <span class="n">indexing</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;self.sequences.old_states.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">indexing</span><span class="si">}</span><span class="s2">] = &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;self.sequences.new_states.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">indexing</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">_call_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">idx_as_arg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_methodheader</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">idxarg</span><span class="o">=</span><span class="n">idx_as_arg</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">idx_as_arg</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.idx_sim = idx&quot;</span><span class="p">)</span>
            <span class="n">anything</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">()&quot;</span><span class="p">)</span>
                <span class="n">anything</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">anything</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;pass&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">update_receivers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Lines of the model method with the same name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_methods</span><span class="p">(</span><span class="s2">&quot;update_receivers&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">RECEIVER_METHODS</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">update_inlets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Lines of the model method with the same name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_methods</span><span class="p">(</span><span class="s2">&quot;update_inlets&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">INLET_METHODS</span><span class="p">)</span>

<div class="viewcode-block" id="PyxWriter.run"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;modeltools.AdHocModel&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the lines of the model method with the same name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_methods</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">RUN_METHODS</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">update_outlets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Lines of the model method with the same name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_methods</span><span class="p">(</span><span class="s2">&quot;update_outlets&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">OUTLET_METHODS</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">update_senders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Lines of the model method with the same name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_methods</span><span class="p">(</span><span class="s2">&quot;update_senders&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SENDER_METHODS</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">update_outputs_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Lines of the model method with the same name (except the `_model`</span>
<span class="sd">        suffix).&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">add</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">add</span>
        <span class="n">methodheader</span> <span class="o">=</span> <span class="n">get_methodheader</span><span class="p">(</span>
            <span class="s2">&quot;update_outputs&quot;</span><span class="p">,</span>
            <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">idxarg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">methodheader</span><span class="p">)</span>
        <span class="n">fluxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_outputsequences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_outputsequences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fluxes</span><span class="p">:</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.sequences.fluxes.update_outputs()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;self.sequences.states.update_outputs()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fluxes</span> <span class="ow">or</span> <span class="n">states</span><span class="p">):</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;pass&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

<div class="viewcode-block" id="PyxWriter.update_outputs"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.update_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">update_outputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">OutputSequences</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Lines of the subsequences method with the same name.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">add</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">add</span>
        <span class="n">methodheader</span> <span class="o">=</span> <span class="n">get_methodheader</span><span class="p">(</span>
            <span class="s2">&quot;update_outputs&quot;</span><span class="p">,</span>
            <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">idxarg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">methodheader</span><span class="p">)</span>
        <span class="n">subseqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_outputsequences</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">name</span>
                <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;if self._</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_outputflag:&quot;</span><span class="p">)</span>
                <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self._</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_outputpointer[0] = self.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;pass&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.calculate_single_terms"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.calculate_single_terms">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_single_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;modeltools.SolverModel&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the lines of the model method with the same name.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_methods</span><span class="p">(</span><span class="s2">&quot;calculate_single_terms&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">PART_ODE_METHODS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;        self.numvars.nmb_calls =&quot;</span> <span class="s2">&quot;self.numvars.nmb_calls+1&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="PyxWriter.calculate_full_terms"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.calculate_full_terms">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_full_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;modeltools.SolverModel&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the lines of the model method with the same name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_methods</span><span class="p">(</span><span class="s2">&quot;calculate_full_terms&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">FULL_ODE_METHODS</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">listofmodeluserfunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;User functions of the model class.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;CYTHONIZE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">member</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">modeluserfunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Model-specific functions.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listofmodeluserfunctions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            . </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">funcconverter</span> <span class="o">=</span> <span class="n">FuncConverter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funcconverter</span><span class="o">.</span><span class="n">pyxlines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Lines of the model method with the same name.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">solve</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;solve&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">solve</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . solve&quot;</span><span class="p">)</span>
            <span class="n">funcconverter</span> <span class="o">=</span> <span class="n">FuncConverter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;solve&quot;</span><span class="p">,</span> <span class="n">solve</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funcconverter</span><span class="o">.</span><span class="n">pyxlines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_assign_seqvalues</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">subseqs_name</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">load</span><span class="p">):</span>
        <span class="n">subseqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span>
        <span class="n">from1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.</span><span class="si">{</span><span class="n">subseqs_name</span><span class="si">}</span><span class="s2">.%s&quot;</span>
        <span class="n">to1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.</span><span class="si">{</span><span class="n">subseqs_name</span><span class="si">}</span><span class="s2">._%s_</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">to1</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;[self.numvars.</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
            <span class="n">from1</span><span class="p">,</span> <span class="n">to1</span> <span class="o">=</span> <span class="n">to1</span><span class="p">,</span> <span class="n">from1</span>
        <span class="k">yield from</span> <span class="n">PyxWriter</span><span class="o">.</span><span class="n">_declare_idxs</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">from2</span> <span class="o">=</span> <span class="n">from1</span> <span class="o">%</span> <span class="n">seq</span><span class="o">.</span><span class="n">name</span>
            <span class="n">to2</span> <span class="o">=</span> <span class="n">to1</span> <span class="o">%</span> <span class="n">seq</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to2</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">from2</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in range(self.sequences.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subseqs_name</span><span class="si">}</span><span class="s2">._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">to2</span><span class="si">}</span><span class="s2">[idx0] = </span><span class="si">{</span><span class="n">from2</span><span class="si">}</span><span class="s2">[idx0]&quot;</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in range(self.sequences.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subseqs_name</span><span class="si">}</span><span class="s2">._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length0):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    for idx1 in range(self.sequences.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subseqs_name</span><span class="si">}</span><span class="s2">._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length1):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">to2</span><span class="si">}</span><span class="s2">[idx0, idx1] = </span><span class="si">{</span><span class="n">from2</span><span class="si">}</span><span class="s2">[idx0, idx1]&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;NDIM of sequence `</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` is higher than expected.&quot;</span>
                <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_declare_idxs</span><span class="p">(</span><span class="n">subseqs</span><span class="p">):</span>
        <span class="n">maxdim</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">maxdim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxdim</span><span class="p">,</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxdim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s2">&quot;cdef int idx0&quot;</span>
        <span class="k">elif</span> <span class="n">maxdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s2">&quot;cdef int idx0, idx1&quot;</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">get_point_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get point statements for state sequences.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_seqvalues</span><span class="p">(</span>
            <span class="n">subseqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">,</span>
            <span class="n">subseqs_name</span><span class="o">=</span><span class="s2">&quot;states&quot;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;points&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="s2">&quot;idx_stage&quot;</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">set_point_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set point statements for state sequences.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_seqvalues</span><span class="p">(</span>
            <span class="n">subseqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">,</span>
            <span class="n">subseqs_name</span><span class="o">=</span><span class="s2">&quot;states&quot;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;points&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="s2">&quot;idx_stage&quot;</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">set_result_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get results statements for state sequences.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_seqvalues</span><span class="p">(</span>
            <span class="n">subseqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="p">,</span>
            <span class="n">subseqs_name</span><span class="o">=</span><span class="s2">&quot;states&quot;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;results&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="s2">&quot;idx_method&quot;</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">get_sum_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get sum statements for flux sequences.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_seqvalues</span><span class="p">(</span>
            <span class="n">subseqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">numericsequences</span><span class="p">,</span>
            <span class="n">subseqs_name</span><span class="o">=</span><span class="s2">&quot;fluxes&quot;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">set_point_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set point statements for flux sequences.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_seqvalues</span><span class="p">(</span>
            <span class="n">subseqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">numericsequences</span><span class="p">,</span>
            <span class="n">subseqs_name</span><span class="o">=</span><span class="s2">&quot;fluxes&quot;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;points&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="s2">&quot;idx_stage&quot;</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">set_result_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set result statements for flux sequences.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_seqvalues</span><span class="p">(</span>
            <span class="n">subseqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">numericsequences</span><span class="p">,</span>
            <span class="n">subseqs_name</span><span class="o">=</span><span class="s2">&quot;fluxes&quot;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;results&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="s2">&quot;idx_method&quot;</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">integrate_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Integrate statements for flux sequences.&quot;&quot;&quot;</span>
        <span class="n">max_ndim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">numericsequences</span><span class="p">:</span>
            <span class="n">max_ndim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_ndim</span><span class="p">,</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s2">&quot;cdef int jdx&quot;</span>
        <span class="k">elif</span> <span class="n">max_ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s2">&quot;cdef int jdx, idx0&quot;</span>
        <span class="k">elif</span> <span class="n">max_ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s2">&quot;cdef int jdx, idx0, idx1&quot;</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">numericsequences</span><span class="p">:</span>
            <span class="n">to_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">from_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_points&quot;</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;self.numvars.dt * self.numconsts.a_coefs&quot;</span>
                <span class="s2">&quot;[self.numvars.idx_method-1, self.numvars.idx_stage, jdx]&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2"> = 0.&quot;</span>
                <span class="k">yield</span> <span class="s2">&quot;for jdx in range(self.numvars.idx_method):&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2"> +</span><span class="si">{</span><span class="n">coefs</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">from_</span><span class="si">}</span><span class="s2">[jdx]&quot;</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in &quot;</span> <span class="sa">f</span><span class="s2">&quot;range(self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0] = 0.&quot;</span>
                <span class="k">yield</span> <span class="s2">&quot;    for jdx in range(self.numvars.idx_method):&quot;</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0] = &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0] + </span><span class="si">{</span><span class="n">coefs</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">from_</span><span class="si">}</span><span class="s2">[jdx, idx0]&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in &quot;</span> <span class="sa">f</span><span class="s2">&quot;range(self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length0):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    for idx1 in range(&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length1):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0, idx1] = 0.&quot;</span>
                <span class="k">yield</span> <span class="s2">&quot;        for jdx in range(self.numvars.idx_method):&quot;</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;            </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0, idx1] = &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0, idx1] + </span><span class="si">{</span><span class="n">coefs</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">from_</span><span class="si">}</span><span class="s2">[jdx, idx0, idx1]&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;NDIM of sequence `</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` is higher than expected.&quot;</span>
                <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">reset_sum_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Reset sum statements for flux sequences.&quot;&quot;&quot;</span>
        <span class="n">subseqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">numericsequences</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">PyxWriter</span><span class="o">.</span><span class="n">_declare_idxs</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">to_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_sum&quot;</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2"> = 0.&quot;</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in &quot;</span> <span class="sa">f</span><span class="s2">&quot;range(self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0] = 0.&quot;</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in &quot;</span> <span class="sa">f</span><span class="s2">&quot;range(self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length0):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    for idx1 in &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;range(self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length1):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0, idx1] = 0.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;NDIM of sequence `</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` is higher than expected.&quot;</span>
                <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">addup_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Add up statements for flux sequences.&quot;&quot;&quot;</span>
        <span class="n">subseqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">numericsequences</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">PyxWriter</span><span class="o">.</span><span class="n">_declare_idxs</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">to_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_sum&quot;</span>
            <span class="n">from_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes.</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">from_</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in &quot;</span> <span class="sa">f</span><span class="s2">&quot;range(self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0] = </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0] + </span><span class="si">{</span><span class="n">from_</span><span class="si">}</span><span class="s2">[idx0]&quot;</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in &quot;</span> <span class="sa">f</span><span class="s2">&quot;range(self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length0):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    for idx1 in &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;range(self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length1):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0, idx1] = &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to_</span><span class="si">}</span><span class="s2">[idx0, idx1] + </span><span class="si">{</span><span class="n">from_</span><span class="si">}</span><span class="s2">[idx0, idx1]&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;NDIM of sequence `</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` is higher than expected.&quot;</span>
                <span class="p">)</span>

    <span class="nd">@decorate_method</span>
    <span class="k">def</span> <span class="nf">calculate_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate error statements.&quot;&quot;&quot;</span>
        <span class="n">subseqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">numericsequences</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SOLVERSEQUENCES</span><span class="p">:</span>
            <span class="n">subseqs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">seq</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SOLVERSEQUENCES</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">yield from</span> <span class="n">PyxWriter</span><span class="o">.</span><span class="n">_declare_idxs</span><span class="p">(</span><span class="n">subseqs</span><span class="p">)</span>
        <span class="n">userel</span> <span class="o">=</span> <span class="s2">&quot;self.numvars.use_relerror:&quot;</span>
        <span class="n">abserror</span> <span class="o">=</span> <span class="s2">&quot;self.numvars.abserror&quot;</span>
        <span class="n">relerror</span> <span class="o">=</span> <span class="s2">&quot;self.numvars.relerror&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;self.numvars.idx_method&quot;</span>
        <span class="k">yield</span> <span class="s2">&quot;cdef double abserror&quot;</span>
        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abserror</span><span class="si">}</span><span class="s2"> = 0.&quot;</span>
        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">userel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2"> = 0.&quot;</span>
        <span class="k">yield</span> <span class="s2">&quot;else:&quot;</span>
        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2"> = inf&quot;</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_results&quot;</span>
            <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;abserror = fabs(&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">]-</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">-1])&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abserror</span><span class="si">}</span><span class="s2"> = max(</span><span class="si">{</span><span class="n">abserror</span><span class="si">}</span><span class="s2">, abserror)&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">userel</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    if </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">] == 0.:&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2"> = inf&quot;</span>
                <span class="k">yield</span> <span class="s2">&quot;    else:&quot;</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2"> = max(&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2">, fabs(abserror/</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">]))&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in range(&quot;</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    abserror = fabs(&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">, idx0]-</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">-1, idx0])&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">abserror</span><span class="si">}</span><span class="s2"> = max(</span><span class="si">{</span><span class="n">abserror</span><span class="si">}</span><span class="s2">, abserror)&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;    if </span><span class="si">{</span><span class="n">userel</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;        if </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">, idx0] == 0.:&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;            </span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2"> = inf&quot;</span>
                <span class="k">yield</span> <span class="s2">&quot;        else:&quot;</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;            </span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2"> = max(&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2">, fabs(abserror/</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">, idx0]))&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;for idx0 in range(&quot;</span> <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length0):&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    for idx1 in range(&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;self.sequences.fluxes._</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_length1):&quot;</span>
                <span class="p">)</span>

                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;        abserror = fabs(</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;idx0, idx1]-</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">-1, idx0, idx1])&quot;</span>
                <span class="p">)</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">abserror</span><span class="si">}</span><span class="s2"> = max(</span><span class="si">{</span><span class="n">abserror</span><span class="si">}</span><span class="s2">, abserror)&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;        if </span><span class="si">{</span><span class="n">userel</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;            if </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">, idx0, idx1] == 0.:&quot;</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;                </span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2"> = inf&quot;</span>
                <span class="k">yield</span> <span class="s2">&quot;            else:&quot;</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;                </span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2"> = max(&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">relerror</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;fabs(abserror/</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">, idx0, idx1]))&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;NDIM of sequence `</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` is higher than expected.&quot;</span>
                <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extrapolate_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Extrapolate error statements.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span>
        <span class="n">extrapolate_error</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;extrapolate_error&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extrapolate_error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            . extrapolate_error&quot;</span><span class="p">)</span>
            <span class="n">funcconverter</span> <span class="o">=</span> <span class="n">FuncConverter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;extrapolate_error&quot;</span><span class="p">,</span> <span class="n">extrapolate_error</span>
            <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funcconverter</span><span class="o">.</span><span class="n">pyxlines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

<div class="viewcode-block" id="PyxWriter.write_stubfile"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.PyxWriter.write_stubfile">[docs]</a>    <span class="k">def</span> <span class="nf">write_stubfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="sd">&quot;&quot;&quot;Write a stub file for the actual base or application model.</span>

<span class="sd">        At the moment, *HydPy* creates model objects quite dynamically.</span>
<span class="sd">        In many regards, this comes with lots of conveniences.  However,</span>
<span class="sd">        there two critical drawbacks compared to more static approaches:</span>
<span class="sd">        some amount of additional initialisation time and, more important,</span>
<span class="sd">        much opaqueness for code inspection</span>
<span class="sd">        tools.  In this context, we experiment with &quot;stub files&quot; at</span>
<span class="sd">        the moment.  These could either contain typing information only</span>
<span class="sd">        or define statically predefined model classes.  The following</span>
<span class="sd">        example uses method |PyxWriter.write_stubfile| to write a</span>
<span class="sd">        (far from perfect) prototype stub file for base model |hland|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models.hland import *</span>
<span class="sd">        &gt;&gt;&gt; cythonizer.pyxwriter.write_stubfile()</span>

<span class="sd">        This is the path to the written file:</span>

<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; import hydpy</span>
<span class="sd">        &gt;&gt;&gt; filepath = os.path.join(hydpy.__path__[0], &quot;hland.py&quot;)</span>
<span class="sd">        &gt;&gt;&gt; os.path.exists(filepath)</span>
<span class="sd">        True</span>

<span class="sd">        However, it&#39;s just an experimental prototype, so we better remove it:</span>

<span class="sd">        &gt;&gt;&gt; os.remove(filepath)</span>
<span class="sd">        &gt;&gt;&gt; os.path.exists(filepath)</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hydpypath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore[attr-defined, name-defined]</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hydpypath</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stubfile</span><span class="p">:</span>
            <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;# -*- coding: utf-8 -*-</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;import hydpy</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> import *</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from hydpy.core.parametertools import (</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  FastAccess,)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from hydpy.core.parametertools import (</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  Parameters, FastAccessParameter)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from hydpy.core.sequencetools import (</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    Sequences,)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;FastAccess</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">Parameters&quot;</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">class </span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="s2">(FastAccessParameter):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">partype</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">CLASSES</span><span class="p">:</span>
                    <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">Parameters&quot;</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">class </span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    fastaccess: FastAccess</span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">partype</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">CLASSES</span><span class="p">:</span>
                    <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">class Parameters(Parameters):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">Parameters&quot;</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;FastAccess</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">class </span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="s2">(FastAccess):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">partype</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">CLASSES</span><span class="p">:</span>
                    <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">class </span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    fastaccess: FastAccess</span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">classname</span> <span class="o">==</span> <span class="s2">&quot;StateSequences&quot;</span><span class="p">:</span>
                    <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    fastaccess_old: FastAccess</span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    fastaccess_new: FastAccess</span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">partype</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">CLASSES</span><span class="p">:</span>
                    <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">class Sequences(Sequences):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">class Model(Model):</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    parameters: Parameters</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    sequences: Sequences</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">methodgroup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">METHOD_GROUPS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">methodgroup</span><span class="p">):</span>
                    <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;hydpy.core.modeltools.Method</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">model: Model</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;parameters: Parameters</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sequences: Sequences</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">Parameters&quot;</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">classname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">partype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">CLASSES</span><span class="p">:</span>
                    <span class="n">stubfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">partype</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span></div></div>


<div class="viewcode-block" id="FuncConverter"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.FuncConverter">[docs]</a><span class="k">class</span> <span class="nc">FuncConverter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class for class |PyxWriter| that analyses Python functions</span>
<span class="sd">    and provides the required Cython code via property</span>
<span class="sd">    |FuncConverter.pyxlines|.&quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;modeltools.Model&quot;</span>
    <span class="n">funcname</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;modeltools.Model&quot;</span><span class="p">,</span> <span class="n">funcname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcname</span> <span class="o">=</span> <span class="n">funcname</span>
        <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="s2">&quot;func&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">argnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;The argument names of the current function.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, None, model.calc_tc_v1).argnames</span>
<span class="sd">        [&#39;model&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">varnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;The variable names of the current function.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, None, model.calc_tc_v1).varnames</span>
<span class="sd">        (&#39;self&#39;, &#39;con&#39;, &#39;inp&#39;, &#39;flu&#39;, &#39;k&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">vn</span> <span class="k">if</span> <span class="n">vn</span> <span class="o">!=</span> <span class="s2">&quot;model&quot;</span> <span class="k">else</span> <span class="s2">&quot;self&quot;</span> <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">locnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;The variable names of the handled function except for</span>
<span class="sd">        the argument names.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, None, model.calc_tc_v1).locnames</span>
<span class="sd">        [&#39;self&#39;, &#39;con&#39;, &#39;inp&#39;, &#39;flu&#39;, &#39;k&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">vn</span> <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span> <span class="k">if</span> <span class="n">vn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argnames</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subgroupnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;The complete names of the subgroups relevant for the current</span>
<span class="sd">        function.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, None, model.calc_tc_v1).subgroupnames</span>
<span class="sd">        [&#39;parameters.control&#39;, &#39;sequences.inputs&#39;, &#39;sequences.fluxes&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">groupname</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="s2">&quot;sequences&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subgroup</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">groupname</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">subgroup</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">groupname</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">subgroup</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;old&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sequences.old_states&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;new&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sequences.new_states&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subgroupshortcuts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;The abbreviated names of the subgroups relevant for the current</span>
<span class="sd">        function.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, None, model.calc_tc_v1).subgroupshortcuts</span>
<span class="sd">        [&#39;con&#39;, &#39;inp&#39;, &#39;flu&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroupnames</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">untypedvarnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;The names of the untyped variables used in the current function.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, None, model.calc_tc_v1).untypedvarnames</span>
<span class="sd">        [&#39;k&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroupshortcuts</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">untypedarguments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;The names of the untyped arguments used by the current function.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, None, model.calc_tc_v1).untypedarguments</span>
<span class="sd">        []</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untypedvarnames</span>
            <span class="k">if</span> <span class="p">((</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">,&quot;</span> <span class="ow">in</span> <span class="n">defline</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="ow">in</span> <span class="n">defline</span><span class="p">))</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">untypedinternalvarnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="sd">&quot;&quot;&quot;The names of the untyped variables used in the current function</span>
<span class="sd">        except for those of the arguments.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, None, model.calc_tc_v1).untypedinternalvarnames</span>
<span class="sd">        [&#39;k&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untypedvarnames</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untypedarguments</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cleanlines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The leaned code lines of the current function.</span>

<span class="sd">        The implemented cleanups:</span>
<span class="sd">          * eventually, remove method version</span>
<span class="sd">          * remove all docstrings</span>
<span class="sd">          * remove all comments</span>
<span class="sd">          * remove all empty lines</span>
<span class="sd">          * remove line bracks within brackets</span>
<span class="sd">          * remove the phrase `modelutils`</span>
<span class="sd">          * remove all lines containing the phrase `fastaccess`</span>
<span class="sd">          * replace all shortcuts with complete reference names</span>
<span class="sd">          * replace &quot;model.&quot; with &quot;self.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)[::</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;modelutils.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;model.&quot;</span><span class="p">,</span> <span class="s2">&quot;self.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shortcut</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroupnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroupshortcuts</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shortcut</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_linebreaks_within_equations</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_imath_operators</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># remove @staticmethod</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>  <span class="c1"># unindent</span>
        <span class="n">argnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argnames</span>
        <span class="n">argnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;self&quot;</span>
        <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;def </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">funcname</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argnames</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="s2">&quot;fastaccess&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">Lines</span><span class="p">(</span><span class="o">*</span><span class="n">lines</span><span class="p">)</span>

<div class="viewcode-block" id="FuncConverter.remove_linebreaks_within_equations"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.FuncConverter.remove_linebreaks_within_equations">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_linebreaks_within_equations</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Remove line breaks within equations.</span>

<span class="sd">        The following example is not an exhaustive test but shows</span>
<span class="sd">        how the method works in principle:</span>

<span class="sd">        &gt;&gt;&gt; code = &quot;asdf = \\\n(a\n+b)&quot;</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter.remove_linebreaks_within_equations(code)</span>
<span class="sd">        &#39;asdf = (a+b)&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">):</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">):</span>
                <span class="n">counter</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">counter</span> <span class="ow">and</span> <span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)):</span>
                <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span></div>

<div class="viewcode-block" id="FuncConverter.remove_imath_operators"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.FuncConverter.remove_imath_operators">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_imath_operators</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Remove mathematical expressions that require Pythons global</span>
<span class="sd">        interpreter locking mechanism.</span>

<span class="sd">        The following example is not an exhaustive test but shows</span>
<span class="sd">        how the method works in principle:</span>

<span class="sd">        &gt;&gt;&gt; lines = [&quot;    x += 1*1&quot;]</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter.remove_imath_operators(lines)</span>
<span class="sd">        &gt;&gt;&gt; lines</span>
<span class="sd">        [&#39;    x = x + (1*1)&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;+=&quot;</span><span class="p">,</span> <span class="s2">&quot;-=&quot;</span><span class="p">,</span> <span class="s2">&quot;**=&quot;</span><span class="p">,</span> <span class="s2">&quot;*=&quot;</span><span class="p">,</span> <span class="s2">&quot;//=&quot;</span><span class="p">,</span> <span class="s2">&quot;/=&quot;</span><span class="p">,</span> <span class="s2">&quot;%=&quot;</span><span class="p">):</span>
                <span class="n">sublines</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sublines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">indent</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="n">sublines</span> <span class="o">=</span> <span class="p">[</span><span class="n">sl</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">sublines</span><span class="p">]</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="si">}{</span><span class="n">sublines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> = &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sublines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">operator</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">sublines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                    <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pyxlines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="sd">&quot;&quot;&quot;Cython code lines of the current function.</span>

<span class="sd">        Assumptions:</span>
<span class="sd">          * The function shall be a method.</span>
<span class="sd">          * The method shall be inlined.</span>
<span class="sd">          * Annotations specify all argument and return types.</span>
<span class="sd">          * Local variables are generally of type `int` but of type `double`</span>
<span class="sd">            when their name starts with `d_`.</span>

<span class="sd">        We import some classes and prepare a pure-Python instance of</span>
<span class="sd">        application model |hland_v1|:</span>

<span class="sd">        &gt;&gt;&gt; from types import MethodType</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.modeltools import Method, Model</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.core.typingtools import Vector</span>
<span class="sd">        &gt;&gt;&gt; from hydpy.cythons.modelutils import FuncConverter</span>
<span class="sd">        &gt;&gt;&gt; from hydpy import prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; with pub.options.usecython(False):</span>
<span class="sd">        ...     model = prepare_model(&quot;hland_v1&quot;)</span>

<span class="sd">        First, we show an example on a standard method without additional</span>
<span class="sd">        arguments and returning nothing but requiring two local variables:</span>

<span class="sd">        &gt;&gt;&gt; class Calc_Test_V1(Method):</span>
<span class="sd">        ...     @staticmethod</span>
<span class="sd">        ...     def __call__(model: Model) -&gt; None:</span>
<span class="sd">        ...         con = model.parameters.control.fastaccess</span>
<span class="sd">        ...         flu = model.sequences.fluxes.fastaccess</span>
<span class="sd">        ...         inp = model.sequences.inputs.fastaccess</span>
<span class="sd">        ...         for k in range(con.nmbzones):</span>
<span class="sd">        ...             d_pc = con.kg[k]*inp.p[k]</span>
<span class="sd">        ...             flu.pc[k] = d_pc</span>
<span class="sd">        &gt;&gt;&gt; model.calc_test_v1 = MethodType(Calc_Test_V1.__call__, model)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, &quot;calc_test_v1&quot;, model.calc_test_v1).pyxlines</span>
<span class="sd">            cpdef inline void calc_test_v1(self)  nogil:</span>
<span class="sd">                cdef double d_pc</span>
<span class="sd">                cdef int k</span>
<span class="sd">                for k in range(self.parameters.control.nmbzones):</span>
<span class="sd">                    d_pc = \</span>
<span class="sd">self.parameters.control.kg[k]*self.sequences.inputs.p[k]</span>
<span class="sd">                    self.sequences.fluxes.pc[k] = d_pc</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        The second example shows that `float` and `Vector` annotations</span>
<span class="sd">        translate into `double` and `double[:]` types, respectively:</span>

<span class="sd">        &gt;&gt;&gt; class Calc_Test_V2(Method):</span>
<span class="sd">        ...     @staticmethod</span>
<span class="sd">        ...     def __call__(</span>
<span class="sd">        ...             model: Model, value: float, values: Vector) -&gt; float:</span>
<span class="sd">        ...         con = model.parameters.control.fastaccess</span>
<span class="sd">        ...         return con.kg[0]*value*values[1]</span>
<span class="sd">        &gt;&gt;&gt; model.calc_test_v2 = MethodType(Calc_Test_V2.__call__, model)</span>
<span class="sd">        &gt;&gt;&gt; FuncConverter(model, &quot;calc_test_v2&quot;, model.calc_test_v2).pyxlines</span>
<span class="sd">            cpdef inline double calc_test_v2(\</span>
<span class="sd">self, double value, double[:] values)  nogil:</span>
<span class="sd">                return self.parameters.control.kg[0]*value*values[1]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanlines</span><span class="p">]</span>
        <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__annotations__</span>
        <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;def &quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cpdef inline </span><span class="si">{</span><span class="n">TYPE2STR</span><span class="p">[</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]]</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;):&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;) </span><span class="si">{</span><span class="n">_nogil</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untypedarguments</span><span class="p">:</span>
            <span class="n">type_</span> <span class="o">=</span> <span class="n">TYPE2STR</span><span class="p">[</span><span class="n">annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untypedinternalvarnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;d_&quot;</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;        cdef double &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;        cdef int &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Lines</span><span class="p">(</span><span class="o">*</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="exp"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.exp">[docs]</a><span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.exp| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import exp</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.exp&quot;) as func:</span>
<span class="sd">    ...     _ = exp(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="log"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.log">[docs]</a><span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.log| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import log</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.log&quot;) as func:</span>
<span class="sd">    ...     _ = log(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="fabs"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.fabs">[docs]</a><span class="k">def</span> <span class="nf">fabs</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |math.exp| function of module |math| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import fabs</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;math.fabs&quot;) as func:</span>
<span class="sd">    ...     _ = fabs(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="sin"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.sin">[docs]</a><span class="k">def</span> <span class="nf">sin</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.sin| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import sin</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.sin&quot;) as func:</span>
<span class="sd">    ...     _ = sin(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="cos"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.cos">[docs]</a><span class="k">def</span> <span class="nf">cos</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.cos| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import cos</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.cos&quot;) as func:</span>
<span class="sd">    ...     _ = cos(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="tan"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.tan">[docs]</a><span class="k">def</span> <span class="nf">tan</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.tan| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import tan</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.tan&quot;) as func:</span>
<span class="sd">    ...     _ = tan(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="asin"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.asin">[docs]</a><span class="k">def</span> <span class="nf">asin</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.arcsin| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import asin</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.arcsin&quot;) as func:</span>
<span class="sd">    ...     _ = asin(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="acos"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.acos">[docs]</a><span class="k">def</span> <span class="nf">acos</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.arccos| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import acos</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.arccos&quot;) as func:</span>
<span class="sd">    ...     _ = acos(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="atan"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.atan">[docs]</a><span class="k">def</span> <span class="nf">atan</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.arctan| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import atan</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.arctan&quot;) as func:</span>
<span class="sd">    ...     _ = atan(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="isnan"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.isnan">[docs]</a><span class="k">def</span> <span class="nf">isnan</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.isnan| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import isnan</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.isnan&quot;) as func:</span>
<span class="sd">    ...     _ = isnan(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>


<div class="viewcode-block" id="isinf"><a class="viewcode-back" href="../../../modelutils.html#hydpy.cythons.modelutils.isinf">[docs]</a><span class="k">def</span> <span class="nf">isinf</span><span class="p">(</span><span class="n">double</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cython wrapper for the |numpy.isinf| function of module |numpy| applied</span>
<span class="sd">    on a single |float| object.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.cythons.modelutils import isnan</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; with mock.patch(&quot;numpy.isinf&quot;) as func:</span>
<span class="sd">    ...     _ = isinf(123.4)</span>
<span class="sd">    &gt;&gt;&gt; func.call_args</span>
<span class="sd">    call(123.4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/HydPy_Logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to.html">How to…</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework.html">Framework Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modelcollection.html">Model Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zbibliography.html">Bibliography</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 4.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.cythons.modelutils</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, HydPy Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.2.
    </div>
  </body>
</html>