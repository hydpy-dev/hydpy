<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydpy.core.testtools &#8212; HydPy 6.2dev6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=127cebf3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    
    <script src="../../../_static/documentation_options.js?v=fd5328d9"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 6.2dev6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.core.testtools</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/HydPy_Logo.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="../../../index.html">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example_projects.html">Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference_manual.html">Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zbibliography.html">Bibliography</a></li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hydpy.core.testtools</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module implements tools for testing *HydPy* and its models.&quot;&quot;&quot;</span>

<span class="c1"># import...</span>
<span class="c1"># ...from standard library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">builtins</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">doctest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">types</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="c1"># ...from site-packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>

<span class="c1"># ...from HydPy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hydpy</span>

<span class="c1"># from hydpy import aliases  actual import below</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">docs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.docs</span><span class="w"> </span><span class="kn">import</span> <span class="n">autofigs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">devicetools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">exceptiontools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">filetools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">hydpytools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">importtools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">modeltools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">objecttools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">pubtools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">sequencetools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">timetools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">typingtools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">variabletools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.core.typingtools</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.auxs</span><span class="w"> </span><span class="kn">import</span> <span class="n">ppolytools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.tests</span><span class="w"> </span><span class="kn">import</span> <span class="n">iotesting</span>

<span class="c1"># from hydpy.models import hland  actual import below</span>
<span class="c1"># from hydpy.models import lland  actual import below</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">plotly</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">plotly</span><span class="w"> </span><span class="kn">import</span> <span class="n">subplots</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">TestIOSequence</span><span class="p">(</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|IOSequence| subclass for testing purposes.&quot;&quot;&quot;</span>

        <span class="n">testarray</span><span class="p">:</span> <span class="n">NDArrayFloat</span>
        <span class="n">descr_device</span> <span class="o">=</span> <span class="s2">&quot;just_for_testing&quot;</span>
        <span class="n">descr_sequence</span> <span class="o">=</span> <span class="s2">&quot;just_for_testing&quot;</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">matplotlib</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">OptionalImport</span><span class="p">(</span><span class="s2">&quot;matplotlib&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;matplotlib&quot;</span><span class="p">],</span> <span class="nb">locals</span><span class="p">())</span>
    <span class="n">pyplot</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">OptionalImport</span><span class="p">(</span><span class="s2">&quot;pyplot&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;matplotlib.pyplot&quot;</span><span class="p">],</span> <span class="nb">locals</span><span class="p">())</span>
    <span class="n">pandas</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">OptionalImport</span><span class="p">(</span><span class="s2">&quot;pandas&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;pandas&quot;</span><span class="p">],</span> <span class="nb">locals</span><span class="p">())</span>
    <span class="n">plotly</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">OptionalImport</span><span class="p">(</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;plotly&quot;</span><span class="p">],</span> <span class="nb">locals</span><span class="p">())</span>
    <span class="n">subplots</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">OptionalImport</span><span class="p">(</span><span class="s2">&quot;subplots&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;plotly.subplots&quot;</span><span class="p">],</span> <span class="nb">locals</span><span class="p">())</span>


<div class="viewcode-block" id="StdOutErr">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.StdOutErr">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StdOutErr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replaces `sys.stdout` and `sys.stderr` temporarily when calling</span>
<span class="sd">    method |Tester.perform_tests| of class |Tester|.&quot;&quot;&quot;</span>

    <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="n">indent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
        <span class="c1"># just for testing:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exception_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">exception_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
        <span class="n">traceback</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">TracebackType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="s2">&quot;no failures occurred&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span>

<div class="viewcode-block" id="StdOutErr.write">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.StdOutErr.write">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Memorise the given text for later writing.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="StdOutErr.print_">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.StdOutErr.print_">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the memorised text to the original `sys.stdout`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="StdOutErr.flush">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.StdOutErr.flush">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do nothing.&quot;&quot;&quot;</span></div>
</div>



<div class="viewcode-block" id="Tester">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.Tester">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Tester</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests either a base or an application model.</span>

<span class="sd">    Usually, a |Tester| object is initialised at the end of the `__init__`</span>
<span class="sd">    file of its base model or the end of the module of an application model.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models import hland, hland_96</span>

<span class="sd">    &gt;&gt;&gt; hland.tester.package</span>
<span class="sd">    &#39;hydpy.models.hland&#39;</span>
<span class="sd">    &gt;&gt;&gt; hland_96.tester.package</span>
<span class="sd">    &#39;hydpy.models&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">package</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ispackage</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">&quot;__package__&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispackage</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The filenames which define the considered base or application model.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models import hland, hland_96</span>
<span class="sd">        &gt;&gt;&gt; from pprint import pprint</span>
<span class="sd">        &gt;&gt;&gt; pprint(hland.tester.filenames)</span>
<span class="sd">        [&#39;__init__.py&#39;,</span>
<span class="sd">         &#39;hland_aides.py&#39;,</span>
<span class="sd">         &#39;hland_constants.py&#39;,</span>
<span class="sd">         &#39;hland_control.py&#39;,</span>
<span class="sd">         &#39;hland_derived.py&#39;,</span>
<span class="sd">         &#39;hland_factors.py&#39;,</span>
<span class="sd">         &#39;hland_fixed.py&#39;,</span>
<span class="sd">         &#39;hland_fluxes.py&#39;,</span>
<span class="sd">         &#39;hland_inputs.py&#39;,</span>
<span class="sd">         &#39;hland_masks.py&#39;,</span>
<span class="sd">         &#39;hland_model.py&#39;,</span>
<span class="sd">         &#39;hland_outlets.py&#39;,</span>
<span class="sd">         &#39;hland_parameters.py&#39;,</span>
<span class="sd">         &#39;hland_sequences.py&#39;,</span>
<span class="sd">         &#39;hland_states.py&#39;]</span>
<span class="sd">        &gt;&gt;&gt; hland_96.tester.filenames</span>
<span class="sd">        [&#39;hland_96.py&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispackage</span><span class="p">:</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fn</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">modulenames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The module names to be taken into account for testing.</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models import hland, hland_96</span>
<span class="sd">        &gt;&gt;&gt; from pprint import pprint</span>
<span class="sd">        &gt;&gt;&gt; pprint(hland.tester.modulenames)</span>
<span class="sd">        [&#39;hland_aides&#39;,</span>
<span class="sd">         &#39;hland_constants&#39;,</span>
<span class="sd">         &#39;hland_control&#39;,</span>
<span class="sd">         &#39;hland_derived&#39;,</span>
<span class="sd">         &#39;hland_factors&#39;,</span>
<span class="sd">         &#39;hland_fixed&#39;,</span>
<span class="sd">         &#39;hland_fluxes&#39;,</span>
<span class="sd">         &#39;hland_inputs&#39;,</span>
<span class="sd">         &#39;hland_masks&#39;,</span>
<span class="sd">         &#39;hland_model&#39;,</span>
<span class="sd">         &#39;hland_outlets&#39;,</span>
<span class="sd">         &#39;hland_parameters&#39;,</span>
<span class="sd">         &#39;hland_sequences&#39;,</span>
<span class="sd">         &#39;hland_states&#39;]</span>
<span class="sd">        &gt;&gt;&gt; hland_96.tester.modulenames</span>
<span class="sd">        [&#39;hland_96&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>
        <span class="p">]</span>

<div class="viewcode-block" id="Tester.perform_tests">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.Tester.perform_tests">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">perform_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform all doctests either in Python or in Cython mode depending</span>
<span class="sd">        on the state of |Options.usecython| set in module |pub|.</span>

<span class="sd">        Usually, |Tester.perform_tests| is triggered automatically by a |Cythonizer|</span>
<span class="sd">        object assigned to the same base or application model as a |Tester| object.</span>
<span class="sd">        However, you are free to call it any time when in doubt of the functionality</span>
<span class="sd">        of a particular base or application model.  Doing so might change some of the</span>
<span class="sd">        states of your current configuration, but only temporarily (besides</span>
<span class="sd">        &quot;projectname&quot;) we pick the |Timegrids| object of module |pub| as an example,</span>
<span class="sd">        which is changed multiple times during testing but finally reset to the</span>
<span class="sd">        original value):</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">        &gt;&gt;&gt; pub.projectname = &quot;test&quot;</span>
<span class="sd">        &gt;&gt;&gt; pub.timegrids = &quot;2000-01-01&quot;, &quot;2001-01-01&quot;, &quot;1d&quot;</span>

<span class="sd">        &gt;&gt;&gt; from hydpy.models import hland, hland_96</span>
<span class="sd">        &gt;&gt;&gt; hland.tester.perform_tests()  # doctest: +ELLIPSIS</span>
<span class="sd">        Test package hydpy.models.hland in ...ython mode.</span>
<span class="sd">            * hland_aides:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_constants:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_control:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_derived:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_factors:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_fixed:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_fluxes:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_inputs:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_masks:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_model:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_outlets:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_parameters:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_sequences:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_states:</span>
<span class="sd">                no failures occurred</span>

<span class="sd">        &gt;&gt;&gt; hland_96.tester.perform_tests()  # doctest: +ELLIPSIS</span>
<span class="sd">        Test module hland_96 in ...ython mode.</span>
<span class="sd">            * hland_96:</span>
<span class="sd">                no failures occurred</span>

<span class="sd">        &gt;&gt;&gt; pub.projectname</span>
<span class="sd">        &#39;test&#39;</span>
<span class="sd">        &gt;&gt;&gt; pub.timegrids</span>
<span class="sd">        Timegrids(&quot;2000-01-01 00:00:00&quot;,</span>
<span class="sd">                  &quot;2001-01-01 00:00:00&quot;,</span>
<span class="sd">                  &quot;1d&quot;)</span>

<span class="sd">        To show the reporting of possible errors, we change the string representation</span>
<span class="sd">        of parameter |hland_control.ZoneType| temporarily.  Again, the |Timegrids|</span>
<span class="sd">        object is reset to its initial state after testing:</span>

<span class="sd">        &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">        &gt;&gt;&gt; with mock.patch(</span>
<span class="sd">        ...     &quot;hydpy.models.hland.hland_control.ZoneType.__repr__&quot;,</span>
<span class="sd">        ...     return_value=&quot;damaged&quot;):</span>
<span class="sd">        ...     hland.tester.perform_tests()  # doctest: +ELLIPSIS</span>
<span class="sd">        Test package hydpy.models.hland in ...ython mode.</span>
<span class="sd">            * hland_aides:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_constants:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            * hland_control:</span>
<span class="sd">                ******...hland_control.py&quot;, line ..., in \</span>
<span class="sd">hydpy.models.hland.hland_control.ZoneType</span>
<span class="sd">                Failed example:</span>
<span class="sd">                    zonetype</span>
<span class="sd">                Expected:</span>
<span class="sd">                    zonetype(FIELD, FOREST, GLACIER, ILAKE, ILAKE, FIELD)</span>
<span class="sd">                Got:</span>
<span class="sd">                    damaged</span>
<span class="sd">                ************************************************************\</span>
<span class="sd">**********</span>
<span class="sd">                ...</span>
<span class="sd">            * hland_derived:</span>
<span class="sd">                no failures occurred</span>
<span class="sd">            ...</span>
<span class="sd">            * hland_states:</span>
<span class="sd">                no failures occurred</span>

<span class="sd">        &gt;&gt;&gt; pub.projectname</span>
<span class="sd">        &#39;test&#39;</span>
<span class="sd">        &gt;&gt;&gt; pub.timegrids</span>
<span class="sd">        Timegrids(&quot;2000-01-01 00:00:00&quot;,</span>
<span class="sd">                  &quot;2001-01-01 00:00:00&quot;,</span>
<span class="sd">                  &quot;1d&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Test </span><span class="si">{</span><span class="s1">&#39;package&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">ispackage</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">ispackage</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">modulenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="s1">&#39;C&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">usecython</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;P&#39;</span><span class="si">}</span><span class="s2">ython mode.&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modulenames</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    * </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="p">(</span>
                <span class="n">StdOutErr</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">ellipsis</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">printprogress</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">reprdigits</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">usedefaultvalues</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">utclongitude</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">timestampleft</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">warnsimulationstep</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">warntrim</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s2">&quot;1d&quot;</span><span class="p">)),</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">simulationstep</span><span class="p">(</span><span class="n">timetools</span><span class="o">.</span><span class="n">Period</span><span class="p">()),</span>
                <span class="n">devicetools</span><span class="o">.</span><span class="n">clear_registries_temporarily</span><span class="p">(),</span>
            <span class="p">):</span>
                <span class="n">projectname</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">getattr_</span><span class="p">(</span>
                    <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="p">,</span> <span class="s2">&quot;projectname&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span>
                <span class="p">)</span>
                <span class="k">del</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">projectname</span>
                <span class="n">timegrids</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">getattr_</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="p">,</span> <span class="s2">&quot;timegrids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span>
                <span class="n">plotting_options</span> <span class="o">=</span> <span class="n">IntegrationTest</span><span class="o">.</span><span class="n">plotting_options</span>
                <span class="n">IntegrationTest</span><span class="o">.</span><span class="n">plotting_options</span> <span class="o">=</span> <span class="n">PlottingOptions</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">modulename</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modulename</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                        <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span>
                            <span class="n">module</span><span class="p">,</span>
                            <span class="n">extraglobs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;testing&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                            <span class="n">optionflags</span><span class="o">=</span><span class="n">doctest</span><span class="o">.</span><span class="n">ELLIPSIS</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">projectname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">projectname</span> <span class="o">=</span> <span class="n">projectname</span>
                    <span class="k">if</span> <span class="n">timegrids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span> <span class="o">=</span> <span class="n">timegrids</span>
                    <span class="n">IntegrationTest</span><span class="o">.</span><span class="n">plotting_options</span> <span class="o">=</span> <span class="n">plotting_options</span></div>
</div>



<div class="viewcode-block" id="Array">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.Array">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assures that attributes are |numpy.ndarray| objects.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">NDArrayFloat</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>



<div class="viewcode-block" id="ArrayDescriptor">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.ArrayDescriptor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ArrayDescriptor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A descriptor for handling values of |Array| objects.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">Array</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="n">Test</span><span class="p">,</span>
        <span class="n">sequence2value</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">ConditionSequence</span><span class="p">,</span> <span class="n">ArrayFloat</span><span class="p">]]</span>
        <span class="p">)</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__delete__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sequence2value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sequence2value</span><span class="p">]</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="k">if</span> <span class="n">names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">_</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">sequence2value</span><span class="p">))):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                    <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">devicename</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="k">if</span> <span class="n">names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">_</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">sequence2value</span><span class="p">))):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                    <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">sequence2value</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Test</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">Test</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Test</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>



<div class="viewcode-block" id="Test">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.Test">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Test</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for |IntegrationTest| and |UnitTest|.</span>

<span class="sd">    This base class defines the printing of the test results primarily.</span>
<span class="sd">    How the tests shall be prepared and performed is to be defined in</span>
<span class="sd">    its subclasses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parseqs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="n">HEADER_OF_FIRST_COL</span><span class="p">:</span> <span class="n">Any</span>

    <span class="n">inits</span> <span class="o">=</span> <span class="n">ArrayDescriptor</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores arrays for setting the same values of parameters and/or sequences before </span>
<span class="sd">    each new experiment.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">raw_first_col_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;To be implemented by the subclasses of |Test|.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Test.get_output_array">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.Test.get_output_array">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parseqs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;To be implemented by the subclasses of |Test|.&quot;&quot;&quot;</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nmb_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of rows of the table.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_first_col_strings</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nmb_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of columns in the table.&quot;&quot;&quot;</span>
        <span class="n">nmb</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
            <span class="n">nmb</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parseq</span><span class="o">.</span><span class="n">numberofvalues</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nmb</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">raw_header_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;All raw strings for the tables header.&quot;&quot;&quot;</span>
        <span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HEADER_OF_FIRST_COL</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parseq</span><span class="o">.</span><span class="n">numberofvalues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">parseq</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;sim&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parseq</span><span class="p">,</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">Sequence_</span><span class="p">):</span>
                <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parseq</span><span class="o">.</span><span class="n">subseqs</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parseq</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">strings</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">raw_body_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;All raw strings for the body of the table.&quot;&quot;&quot;</span>
        <span class="n">strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">first_string</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_first_col_strings</span><span class="p">):</span>
            <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">first_string</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_array</span><span class="p">(</span><span class="n">parseq</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parseq</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">strings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parseq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">strings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">strings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">strings</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">raw_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;All raw strings for the complete table.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_header_strings</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_body_strings</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">col_widths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The widths of all columns of the table.&quot;&quot;&quot;</span>
        <span class="n">strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_strings</span>
        <span class="n">widths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmb_cols</span><span class="p">):</span>
            <span class="n">widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmb_rows</span><span class="p">):</span>
                <span class="n">widths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">]),</span> <span class="n">widths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">widths</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">col_separators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The separators for adjacent columns.&quot;&quot;&quot;</span>
        <span class="n">seps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;| &quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
            <span class="n">seps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; | &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parseq</span><span class="o">.</span><span class="n">numberofvalues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">seps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">)</span>
        <span class="n">seps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; |&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seps</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">row_nmb_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of characters of a single row of the table.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_separators</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_interleave</span><span class="p">(</span>
        <span class="n">separators</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">strings</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">widths</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a table line from the given arguments.&quot;&quot;&quot;</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">value</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">separator</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">separators</span><span class="p">,</span> <span class="n">strings</span><span class="p">,</span> <span class="n">widths</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="n">separator</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">separators</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

<div class="viewcode-block" id="Test.make_table">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.Test.make_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">idx2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the result table between the given indices.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">col_widths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_widths</span>
        <span class="n">col_separators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_separators</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interleave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_separators</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_header_strings</span><span class="p">,</span> <span class="n">col_widths</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_nmb_characters</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">strings_in_line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_body_strings</span><span class="p">[</span><span class="n">idx1</span><span class="p">:</span><span class="n">idx2</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interleave</span><span class="p">(</span><span class="n">col_separators</span><span class="p">,</span> <span class="n">strings_in_line</span><span class="p">,</span> <span class="n">col_widths</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="Test.print_table">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.Test.print_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">idx2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the result table between the given indices.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_table</span><span class="p">(</span><span class="n">idx1</span><span class="o">=</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="o">=</span><span class="n">idx2</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="PlottingOptions">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.PlottingOptions">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PlottingOptions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotting options of class |IntegrationTest|.&quot;&quot;&quot;</span>

    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">axis1</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span>
    <span class="n">axis2</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span>
    <span class="n">activated</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis2</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="IntegrationTest">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IntegrationTest</span><span class="p">(</span><span class="n">Test</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Defines model integration doctests.</span>

<span class="sd">    The functionality of |IntegrationTest| is easiest to understand by inspecting</span>
<span class="sd">    doctests like the ones of modules |arma_rimorido|.</span>

<span class="sd">    Note that all condition sequences (state and logging sequences) are initialised in</span>
<span class="sd">    accordance with the values are given as `inits` values.  The values of the</span>
<span class="sd">    simulation sequences of outlet and sender nodes are always set to zero before each</span>
<span class="sd">    test run.  All other parameter and sequence values can be changed between different</span>
<span class="sd">    test runs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">HEADER_OF_FIRST_COL</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The header of the first column containing dates.&quot;&quot;&quot;</span>

    <span class="n">plotting_options</span> <span class="o">=</span> <span class="n">PlottingOptions</span><span class="p">()</span>
    <span class="n">element</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span>
    <span class="n">elements</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Devices</span><span class="p">[</span><span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">]</span>
    <span class="n">nodes</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Devices</span><span class="p">[</span><span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="p">]</span>
    <span class="n">parseqs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">element</span><span class="p">:</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seqs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the element and its nodes, put them into a HydPy object, and make</span>
<span class="sd">        their sequences ready for use for integration testing.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">inits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="o">.</span><span class="n">query_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">query_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydpy</span> <span class="o">=</span> <span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydpy</span><span class="o">.</span><span class="n">update_devices</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydpy</span><span class="o">.</span><span class="n">collectives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_node_sequences</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_input_model_sequences</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span> <span class="o">=</span> <span class="n">seqs</span> <span class="k">if</span> <span class="n">seqs</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_print_sequences</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inits</span> <span class="o">=</span> <span class="n">inits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">axis1</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">axis2</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">update_parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">get_conditions</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">use_conditions</span><span class="p">:</span> <span class="n">ConditionsModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;do not return conditions&quot;&quot;&quot;</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">axis1</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">axis2</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">update_parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">get_conditions</span><span class="p">:</span> <span class="n">timetools</span><span class="o">.</span><span class="n">DateConstrArg</span><span class="p">,</span>
        <span class="n">use_conditions</span><span class="p">:</span> <span class="n">ConditionsModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConditionsModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;do return conditions&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">axis1</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">axis2</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">update_parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">get_conditions</span><span class="p">:</span> <span class="n">timetools</span><span class="o">.</span><span class="n">DateConstrArg</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_conditions</span><span class="p">:</span> <span class="n">ConditionsModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConditionsModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare and perform an integration test and print and eventually plot its</span>
<span class="sd">        results.</span>

<span class="sd">        Note that the conditions defined under |IntegrationTest.inits| override the</span>
<span class="sd">        ones given via keyword `use_conditions`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span>
            <span class="n">update_parameters</span><span class="o">=</span><span class="n">update_parameters</span><span class="p">,</span> <span class="n">use_conditions</span><span class="o">=</span><span class="n">use_conditions</span>
        <span class="p">)</span>
        <span class="n">seq2value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_simulation</span><span class="p">(</span><span class="n">get_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_table</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="n">axis1</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="n">axis2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seq2value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_simulation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">get_conditions</span><span class="p">:</span> <span class="n">timetools</span><span class="o">.</span><span class="n">DateConstrArg</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConditionsModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">get_conditions</span><span class="p">:</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">get_conditions</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">date</span> <span class="o">&gt;</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">firstdate</span><span class="p">:</span>
                <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">lastdate</span> <span class="o">=</span> <span class="n">date</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hydpy</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">conditions</span>
            <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">lastdate</span><span class="p">:</span>
                <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="n">date</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">lastdate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hydpy</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>
            <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">firstdate</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">firstdate</span>
            <span class="k">return</span> <span class="n">conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydpy</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_datetimes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">datetime</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">raw_first_col_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The raw date strings of the first column, except the header.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dateformat</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datetimes</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dateformat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format string for printing dates in the first column of the table.</span>

<span class="sd">        See the documentation on module |datetime| for the format strings allowed.</span>

<span class="sd">        You can query and change property |IntegrationTest.dateformat|:</span>

<span class="sd">        &gt;&gt;&gt; from hydpy import Element, IntegrationTest, prepare_model, pub</span>
<span class="sd">        &gt;&gt;&gt; pub.timegrids = &quot;2000-01-01&quot;, &quot;2001-01-01&quot;, &quot;1d&quot;</span>
<span class="sd">        &gt;&gt;&gt; element = Element(&quot;element&quot;, outlets=&quot;node&quot;)</span>
<span class="sd">        &gt;&gt;&gt; element.model = prepare_model(&quot;hland_96&quot;)</span>
<span class="sd">        &gt;&gt;&gt; __package__ = &quot;testpackage&quot;</span>
<span class="sd">        &gt;&gt;&gt; tester = IntegrationTest(element)</span>
<span class="sd">        &gt;&gt;&gt; tester.dateformat</span>
<span class="sd">        &#39;%Y-%m-%d %H:%M:%S&#39;</span>

<span class="sd">        Passing an ill-defined format string leads to the following error:</span>

<span class="sd">        &gt;&gt;&gt; tester.dateformat = 999</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ValueError: The given date format `999` is not a valid format string for \</span>
<span class="sd">`datetime` objects.  Please read the documentation on module datetime of the Python \</span>
<span class="sd">standard library for for further information.</span>

<span class="sd">        &gt;&gt;&gt; tester.dateformat = &quot;%x&quot;</span>
<span class="sd">        &gt;&gt;&gt; tester.dateformat</span>
<span class="sd">        &#39;%x&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dateformat</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dateformat&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dateformat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">timetools</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">formatstrings</span><span class="p">[</span><span class="s2">&quot;iso2&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dateformat</span>

    <span class="nd">@dateformat</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dateformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dateformat</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dateformat</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The given date format `</span><span class="si">{</span><span class="n">dateformat</span><span class="si">}</span><span class="s2">` is not a valid format string &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for `datetime` objects.  Please read the documentation on module &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;datetime of the Python standard library for for further information.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="s2">&quot;dateformat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dateformat</span>

<div class="viewcode-block" id="IntegrationTest.get_output_array">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.get_output_array">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parseqs</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the array containing the output results of the given sequence.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">parseqs</span><span class="o">.</span><span class="n">series</span></div>


<div class="viewcode-block" id="IntegrationTest.prepare_node_sequences">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.prepare_node_sequences">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_node_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the simulations series of all nodes.</span>

<span class="sd">        This preparation might not be suitable for all types of integration tests.</span>
<span class="sd">        Prepare those node sequences manually, for which this method does not result in</span>
<span class="sd">        the desired outcome.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">deploymode</span> <span class="o">=</span> <span class="s2">&quot;oldsim&quot;</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">sim</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">prepare_series</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">prepare_series</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntegrationTest.prepare_input_model_sequences">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.prepare_input_model_sequences">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_input_model_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure the input sequences of the model in a manner that allows for</span>
<span class="sd">        applying their time series data in integration tests.&quot;&quot;&quot;</span>
        <span class="n">prepare_inputseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">prepare_inputseries</span>
        <span class="n">prepare_inputseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">prepare_inputseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntegrationTest.extract_print_sequences">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.extract_print_sequences">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_print_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of all input, factor, flux, and state sequences of the model</span>
<span class="sd">        and the simulation sequences of all nodes.&quot;&quot;&quot;</span>
        <span class="n">seqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;factors&quot;</span><span class="p">,</span> <span class="s2">&quot;fluxes&quot;</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">):</span>
            <span class="n">subseqs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">subseqs</span><span class="p">:</span>
                <span class="n">seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">seqs</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntegrationTest.prepare_model">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.prepare_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update_parameters</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">use_conditions</span><span class="p">:</span> <span class="n">ConditionsModel</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Derive the secondary parameter values, prepare all required time series and</span>
<span class="sd">        set the initial conditions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_series</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_outputs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_conditions</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">trimvariables</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">use_conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_inits</span><span class="p">()</span></div>


<div class="viewcode-block" id="IntegrationTest.reset_values">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.reset_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the current values of all factor and flux sequences to |numpy.nan|.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_submodels</span><span class="p">(</span><span class="n">include_mainmodel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">seqs</span> <span class="ow">in</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">factors</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">fluxes</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>
                    <span class="n">seq</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="IntegrationTest.reset_series">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.reset_series">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_series</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise all time series with |numpy.nan| values.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">prepare_factorseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="n">flag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">prepare_fluxseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="n">flag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">prepare_stateseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="n">flag</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntegrationTest.reset_outputs">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.reset_outputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the values of the simulation sequences of all outlet nodes to zero.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">outlets</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">senders</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">sim</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span></div>


<div class="viewcode-block" id="IntegrationTest.reset_inits">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.reset_inits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_inits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set all initial conditions of all models.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">trimvariables</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">inits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inits</span>
            <span class="k">for</span> <span class="n">subname</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;states&quot;</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_submodels</span><span class="p">(</span>
                        <span class="n">include_mainmodel</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">,</span> <span class="n">subname</span><span class="p">,</span> <span class="p">()):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inits</span><span class="p">,</span> <span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inits</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seq</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inits</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">seq</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntegrationTest.plot">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.IntegrationTest.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">axis1</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">axis2</span><span class="p">:</span> <span class="n">typingtools</span><span class="o">.</span><span class="n">MayNonerable1</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a plotly HTML file plotting the current test results.</span>

<span class="sd">        (Optional) arguments:</span>
<span class="sd">            * filename: Name of the file.  If necessary, the file ending `html` is</span>
<span class="sd">              added automatically.  The file is stored in the `html_` folder of</span>
<span class="sd">              subpackage `docs`.</span>
<span class="sd">            * act_sequences: List of the sequences to be shown initially (deprecated).</span>
<span class="sd">            * axis1: sequences to be shown initially on the first axis.</span>
<span class="sd">            * axis2: sequences to be shown initially on the second axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update_act_names</span><span class="p">(</span><span class="n">sequence_</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,</span> <span class="n">name_</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence_</span><span class="p">,</span> <span class="n">act_types1</span><span class="p">):</span>
                <span class="n">act_names1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence_</span><span class="p">,</span> <span class="n">act_types2</span><span class="p">):</span>
                <span class="n">act_names2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.html&quot;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;.html&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_options</span><span class="o">.</span><span class="n">activated</span><span class="p">:</span>
            <span class="n">axis1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_options</span><span class="o">.</span><span class="n">activated</span>
            <span class="n">axis2</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">axis1</span> <span class="ow">or</span> <span class="n">axis2</span><span class="p">):</span>
                <span class="n">axis1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_options</span><span class="o">.</span><span class="n">axis1</span>
                <span class="n">axis2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_options</span><span class="o">.</span><span class="n">axis2</span>
            <span class="k">if</span> <span class="n">axis1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span>
            <span class="k">if</span> <span class="n">axis2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis2</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">axis1</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                <span class="n">axis1</span><span class="p">,</span> <span class="p">(</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,)</span>  <span class="c1"># type: ignore[type-abstract]</span>
            <span class="p">)</span>
            <span class="n">axis2</span> <span class="o">=</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                <span class="n">axis2</span><span class="p">,</span> <span class="p">(</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">IOSequence</span><span class="p">,)</span>  <span class="c1"># type: ignore[type-abstract]</span>
            <span class="p">)</span>
        <span class="n">sel_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_options</span><span class="o">.</span><span class="n">selected</span>
        <span class="k">if</span> <span class="n">sel_sequences</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sel_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span>
        <span class="n">sel_sequences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">sel_sequences</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">seq_</span><span class="p">:</span> <span class="n">seq_</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">act_types1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">seq_</span><span class="p">)</span> <span class="k">for</span> <span class="n">seq_</span> <span class="ow">in</span> <span class="n">axis1</span><span class="p">)</span>
        <span class="n">act_types2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">seq_</span><span class="p">)</span> <span class="k">for</span> <span class="n">seq_</span> <span class="ow">in</span> <span class="n">axis2</span><span class="p">)</span>
        <span class="n">sel_names</span><span class="p">,</span> <span class="n">sel_series</span><span class="p">,</span> <span class="n">sel_units</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">act_names1</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">act_names2</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sel_sequences</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">sequence</span><span class="o">.</span><span class="n">NDIM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sel_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">sel_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
                <span class="n">sel_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">series</span><span class="p">))</span>
                <span class="n">_update_act_names</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="n">sel_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">sel_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
                <span class="n">sel_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">series</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
                <span class="n">_update_act_names</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ranges</span> <span class="o">=</span> <span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">ranges</span><span class="p">):</span>
                    <span class="n">subname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">idxs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">sel_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subname</span><span class="p">)</span>
                    <span class="n">sel_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
                    <span class="n">series</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">series</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
                    <span class="n">sel_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">series</span><span class="p">))</span>
                    <span class="n">_update_act_names</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">subname</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">subplots</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;secondary_y&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab20&quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_names</span><span class="p">))</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">pandas</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">eval_</span><span class="o">.</span><span class="n">firstdate</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
                <span class="n">end</span><span class="o">=</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">eval_</span><span class="o">.</span><span class="n">lastdate</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
                <span class="n">freq</span><span class="o">=</span><span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span><span class="o">.</span><span class="n">eval_</span><span class="o">.</span><span class="n">stepsize</span><span class="o">.</span><span class="n">timedelta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">sel_names</span><span class="p">,</span> <span class="n">sel_series</span><span class="p">,</span> <span class="n">sel_units</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">plotly</span><span class="o">.</span><span class="n">graph_objects</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">dates</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">] (1)&quot;</span><span class="p">,</span>
                    <span class="n">visible</span><span class="o">=</span><span class="n">name</span> <span class="ow">in</span> <span class="n">act_names1</span><span class="p">,</span>
                    <span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;axis 1&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">rgb2hex</span><span class="p">(</span><span class="n">cmap</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span><span class="p">))},</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">plotly</span><span class="o">.</span><span class="n">graph_objects</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">dates</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">] (2)&quot;</span><span class="p">,</span>
                    <span class="n">visible</span><span class="o">=</span><span class="n">name</span> <span class="ow">in</span> <span class="n">act_names2</span><span class="p">,</span>
                    <span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;axis 2&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">rgb2hex</span><span class="p">(</span><span class="n">cmap</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))},</span>
                <span class="p">),</span>
                <span class="n">secondary_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">visibles</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;add all to y-axis 1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;remove all&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;add all to y-axis 2&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
        <span class="p">):</span>
            <span class="n">subbuttons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;restyle&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_sequences</span><span class="p">)</span> <span class="o">*</span> <span class="n">visibles</span><span class="p">}],</span>
                <span class="p">}</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_names</span><span class="p">):</span>
                <span class="n">subbuttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;restyle&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="n">visibles</span><span class="p">},</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subbuttons</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;x unified&quot;</span><span class="p">,</span>
            <span class="n">updatemenus</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">,</span>
                    <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">,</span>
                    <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">,</span>
                    <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">],</span>
            <span class="n">legend</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tracegroupgap&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">docspath</span> <span class="o">=</span> <span class="n">docs</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docspath</span><span class="p">,</span> <span class="s2">&quot;html_&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">include_plotlyjs</span><span class="o">=</span><span class="s2">&quot;directory&quot;</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="UnitTest">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.UnitTest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UnitTest</span><span class="p">(</span><span class="n">Test</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Defines unit doctests for a single model method.&quot;&quot;&quot;</span>

    <span class="n">HEADER_OF_FIRST_COL</span> <span class="o">=</span> <span class="s2">&quot;ex.&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The header of the first column containing sequential numbers.&quot;&quot;&quot;</span>

    <span class="n">nexts</span> <span class="o">=</span> <span class="n">ArrayDescriptor</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores arrays for setting different values of parameters and/or</span>
<span class="sd">    sequences before each new experiment.&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">ArrayDescriptor</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores arrays with the resulting values of parameters and/or</span>
<span class="sd">    sequences of each new experiment.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">first_example</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_example</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">parseqs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">inits</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">nexts</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_example_calc</span> <span class="o">=</span> <span class="n">first_example</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_example_calc</span> <span class="o">=</span> <span class="n">last_example</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_example_plot</span> <span class="o">=</span> <span class="n">first_example</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_example_plot</span> <span class="o">=</span> <span class="n">last_example</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span> <span class="o">=</span> <span class="n">parseqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memorise_inits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_output_arrays</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nmb_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of examples to be calculated.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_example_calc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_example_calc</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">idx0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The first index of the examples selected for printing.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_example_plot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_example_calc</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">idx1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The last index of the examples selected for printing.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmb_examples</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_example_calc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_example_plot</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_example</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">last_example</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">first_example</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_example_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_example_calc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_example_plot</span> <span class="o">=</span> <span class="n">first_example</span>
        <span class="k">if</span> <span class="n">last_example</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_example_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_example_calc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_example_plot</span> <span class="o">=</span> <span class="n">last_example</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmb_examples</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_inits</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_inputs</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_outputs</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx1</span><span class="p">)</span>

<div class="viewcode-block" id="UnitTest.get_output_array">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.UnitTest.get_output_array">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parseqs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the array containing the output results of the given</span>
<span class="sd">        parameter or sequence.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">parseqs</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">raw_first_col_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The raw integer strings of the first column, except the header.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_example_plot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_example_plot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

<div class="viewcode-block" id="UnitTest.memorise_inits">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.UnitTest.memorise_inits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">memorise_inits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Memorise all initial conditions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">exceptiontools</span><span class="o">.</span><span class="n">getattr_</span><span class="p">(</span><span class="n">parseq</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inits</span><span class="p">,</span> <span class="n">parseq</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="UnitTest.prepare_output_arrays">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.UnitTest.prepare_output_arrays">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_output_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare arrays for storing the calculated results for the</span>
<span class="sd">        respective parameters and/or sequences.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_first_col_strings</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">parseq</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">type_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parseq</span><span class="p">,</span> <span class="s2">&quot;TYPE&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">init</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">parseq</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span></div>


<div class="viewcode-block" id="UnitTest.reset_inits">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.UnitTest.reset_inits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_inits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set all initial conditions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
            <span class="n">inits</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inits</span><span class="p">,</span> <span class="n">parseq</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parseq</span><span class="p">(</span><span class="n">inits</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the actual values with the |UnitTest.nexts| data of</span>
<span class="sd">        the given index.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nexts</span><span class="p">,</span> <span class="n">parseq</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">parseq</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nexts</span><span class="p">,</span> <span class="n">parseq</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the |UnitTest.results| data with the actual values of</span>
<span class="sd">        the given index.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">parseq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">parseq</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">parseq</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">parseq</span><span class="o">.</span><span class="n">values</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">_Open</span><span class="p">:</span>
    <span class="n">__readingerror</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Reading is not possible at the moment.  Please see the &quot;</span>
        <span class="s2">&quot;documentation on class `Open` of module `testtools` &quot;</span>
        <span class="s2">&quot;for further information.&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="c1"># all further positional and keyword arguments are ignored.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entered</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entered</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">traceback_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raise a |NotImplementedError| in any case.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__readingerror</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raise a |NotImplementedError| in any case.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__readingerror</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raise a |NotImplementedError| in any case.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__readingerror</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace the `write` method of file objects.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace the `writelines` method of file objects.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace the `close` method of file objects.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="p">)</span>
        <span class="n">maxchars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&lt;BLANKLINE&gt;&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">maxchars</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxchars</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;~&quot;</span> <span class="o">*</span> <span class="n">maxchars</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">maxchars</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;~&quot;</span> <span class="o">*</span> <span class="n">maxchars</span><span class="p">)</span>


<div class="viewcode-block" id="Open">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.Open">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Open</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace |open| in doctests temporarily.</span>

<span class="sd">    Class |Open| to intended to make writing to files visible and testable</span>
<span class="sd">    in docstrings.  Therefore, Python&#39;s built-in function |open| is</span>
<span class="sd">    temporarily replaced by another object, printing the filename and the</span>
<span class="sd">    file content, as shown in the following example:</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; path = os.path.join(&quot;folder&quot;, &quot;test.py&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import Open</span>
<span class="sd">    &gt;&gt;&gt; with Open():</span>
<span class="sd">    ...     with open(path, &quot;w&quot;) as file_:</span>
<span class="sd">    ...         file_.write(&quot;first line\\n&quot;)</span>
<span class="sd">    ...         file_.writelines([&quot;\\n&quot;, &quot;third line\\n&quot;])</span>
<span class="sd">    ~~~~~~~~~~~~~~</span>
<span class="sd">    folder/test.py</span>
<span class="sd">    --------------</span>
<span class="sd">    first line</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    third line</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    ~~~~~~~~~~~~~~</span>

<span class="sd">    Note that, for simplicity, the UNIX style path separator `/` is used</span>
<span class="sd">    to print the file path on all systems.</span>

<span class="sd">    Class |Open| is rather restricted at the moment.  Functionalities</span>
<span class="sd">    like reading are not supported so far:</span>

<span class="sd">    &gt;&gt;&gt; with Open():</span>
<span class="sd">    ...     with open(path, &quot;r&quot;) as file_:</span>
<span class="sd">    ...         file_.read()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    NotImplementedError: Reading is not possible at the moment.  \</span>
<span class="sd">Please see the documentation on class `Open` of module `testtools` \</span>
<span class="sd">for further information.</span>

<span class="sd">    &gt;&gt;&gt; with Open():</span>
<span class="sd">    ...     with open(path, &quot;r&quot;) as file_:</span>
<span class="sd">    ...         file_.readline()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    NotImplementedError: Reading is not possible at the moment.  \</span>
<span class="sd">Please see the documentation on class `Open` of module `testtools` \</span>
<span class="sd">for further information.</span>

<span class="sd">    &gt;&gt;&gt; with Open():</span>
<span class="sd">    ...     with open(path, &quot;r&quot;) as file_:</span>
<span class="sd">    ...         file_.readlines()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    NotImplementedError: Reading is not possible at the moment.  \</span>
<span class="sd">Please see the documentation on class `Open` of module `testtools` \</span>
<span class="sd">for further information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">open</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">builtins</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">_Open</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">traceback_</span><span class="p">):</span>
        <span class="n">builtins</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span></div>



<div class="viewcode-block" id="TestIO">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.TestIO">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestIO</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare an environment for testing IO functionalities.</span>

<span class="sd">    Primarily, |TestIO| changes the current working during the</span>
<span class="sd">    execution of with| blocks.  Inspecting your current working</span>
<span class="sd">    directory, |os| will likely find no file called `testfile.txt`:</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; os.path.exists(&quot;testfile.txt&quot;)</span>
<span class="sd">    False</span>

<span class="sd">    If some tests require writing such a file, this should be done</span>
<span class="sd">    within HydPy&#39;s `iotesting` folder in subpackage `tests`, which</span>
<span class="sd">    is achieved by applying the `with` statement on |TestIO|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     open(&quot;testfile.txt&quot;, &quot;w&quot;).close()</span>
<span class="sd">    ...     print(os.path.exists(&quot;testfile.txt&quot;))</span>
<span class="sd">    True</span>

<span class="sd">    After the `with` block, the working directory is reset automatically:</span>

<span class="sd">    &gt;&gt;&gt; os.path.exists(&quot;testfile.txt&quot;)</span>
<span class="sd">    False</span>

<span class="sd">    Nevertheless, `testfile.txt` still exists in the folder `iotesting`:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     print(os.path.exists(&quot;testfile.txt&quot;))</span>
<span class="sd">    True</span>

<span class="sd">    Optionally, files and folders created within the current `with` block</span>
<span class="sd">    can be removed automatically by setting `clear_own` to |True|</span>
<span class="sd">    (modified files and folders are not affected):</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(clear_own=True):</span>
<span class="sd">    ...     open(&quot;testfile.txt&quot;, &quot;w&quot;).close()</span>
<span class="sd">    ...     os.makedirs(&quot;testfolder&quot;)</span>
<span class="sd">    ...     print(os.path.exists(&quot;testfile.txt&quot;),</span>
<span class="sd">    ...           os.path.exists(&quot;testfolder&quot;))</span>
<span class="sd">    True True</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(clear_own=True):</span>
<span class="sd">    ...     print(os.path.exists(&quot;testfile.txt&quot;),</span>
<span class="sd">    ...           os.path.exists(&quot;testfolder&quot;))</span>
<span class="sd">    True False</span>

<span class="sd">    Alternatively, all files and folders contained in folder `iotesting`</span>
<span class="sd">    can be removed after leaving the `with` block:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO(clear_all=True):</span>
<span class="sd">    ...     os.makedirs(&quot;testfolder&quot;)</span>
<span class="sd">    ...     print(os.path.exists(&quot;testfile.txt&quot;),</span>
<span class="sd">    ...           os.path.exists(&quot;testfolder&quot;))</span>
<span class="sd">    True True</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(clear_own=True):</span>
<span class="sd">    ...     print(os.path.exists(&quot;testfile.txt&quot;),</span>
<span class="sd">    ...           os.path.exists(&quot;testfolder&quot;))</span>
<span class="sd">    False False</span>

<span class="sd">    For just clearing the `iofolder`, one can call method |TestIO.clear|</span>
<span class="sd">    alternatively:</span>

<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     open(&quot;testfile.txt&quot;, &quot;w&quot;).close()</span>
<span class="sd">    ...     print(os.path.exists(&quot;testfile.txt&quot;))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; TestIO.clear()</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     print(os.path.exists(&quot;testfile.txt&quot;))</span>
<span class="sd">    False</span>

<span class="sd">    Note that class |TestIO| copies all eventually generated `.coverage`</span>
<span class="sd">    files into the `test` subpackage to assure no covered lines are</span>
<span class="sd">    reported as uncovered.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_clear_own</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">_clear_all</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">_olds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_own</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">clear_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_own</span> <span class="o">=</span> <span class="n">clear_own</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_all</span> <span class="o">=</span> <span class="n">clear_all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_olds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TestIO</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">path</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">iotestingpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">iotesting</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iotestingpath</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clear_own</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_olds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exception_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">exception_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
        <span class="n">traceback_</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">TracebackType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">!=</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clear_all</span>
                <span class="ow">or</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_clear_own</span>
                    <span class="ow">and</span> <span class="p">((</span><span class="n">olds</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_olds</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">olds</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">path</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<div class="viewcode-block" id="TestIO.clear">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.TestIO.clear">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all files from the `iotesting` folder.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="p">(</span><span class="n">clear_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="make_abc_testable">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.make_abc_testable">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_abc_testable</span><span class="p">(</span><span class="n">abstract</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a concrete version of the given abstract base class for testing purposes.</span>

<span class="sd">    Abstract base classes cannot be (and, at least in production code, should not be)</span>
<span class="sd">    instantiated:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.netcdftools import NetCDFVariable</span>
<span class="sd">    &gt;&gt;&gt; var = NetCDFVariable()  # doctest: +ELLIPSIS</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    TypeError: Can&#39;t instantiate abstract class NetCDFVariable with...</span>

<span class="sd">    However, it is convenient to do so for testing (partly) abstract base classes in</span>
<span class="sd">    doctests.  The derived class returned by function |make_abc_testable| is identical</span>
<span class="sd">    with the original one, except that its protection against initialisation is</span>
<span class="sd">    disabled:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import make_abc_testable, classname</span>
<span class="sd">    &gt;&gt;&gt; var = make_abc_testable(NetCDFVariable)(&quot;filepath&quot;)</span>

<span class="sd">    To avoid confusion, |make_abc_testable| appends an underscore to the original class</span>
<span class="sd">    name:</span>

<span class="sd">    &gt;&gt;&gt; classname(var)</span>
<span class="sd">    &#39;NetCDFVariable_&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">concrete</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">abstract</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">abstract</span><span class="p">,),</span> <span class="p">{})</span>
    <span class="n">concrete</span><span class="o">.</span><span class="n">__abstractmethods__</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="k">return</span> <span class="n">concrete</span></div>



<div class="viewcode-block" id="mock_datetime_now">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.mock_datetime_now">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_datetime_now</span><span class="p">(</span><span class="n">testdatetime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Let class method |datetime.datetime.now| of class |datetime.datetime|</span>
<span class="sd">    of module |datetime| return the given date for testing purposes within</span>
<span class="sd">    a &quot;with-block&quot;.</span>

<span class="sd">    &gt;&gt;&gt; import datetime</span>
<span class="sd">    &gt;&gt;&gt; testdate = datetime.datetime(2000, 10, 1, 12, 30, 0, 999)</span>
<span class="sd">    &gt;&gt;&gt; testdate == datetime.datetime.now()</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import classname</span>
<span class="sd">    &gt;&gt;&gt; classname(datetime.datetime)</span>
<span class="sd">    &#39;datetime&#39;</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import mock_datetime_now</span>
<span class="sd">    &gt;&gt;&gt; with mock_datetime_now(testdate):</span>
<span class="sd">    ...     testdate == datetime.datetime.now()</span>
<span class="sd">    ...     classname(datetime.datetime)</span>
<span class="sd">    True</span>
<span class="sd">    &#39;_DateTime&#39;</span>
<span class="sd">    &gt;&gt;&gt; testdate == datetime.datetime.now()</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; classname(datetime.datetime)</span>
<span class="sd">    &#39;datetime&#39;</span>

<span class="sd">    The following test shows that mocking |datetime.datetime| does not</span>
<span class="sd">    interfere with initialising |Date| objects and that the relevant</span>
<span class="sd">    exceptions are properly handled:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import Date</span>
<span class="sd">    &gt;&gt;&gt; with mock_datetime_now(testdate):</span>
<span class="sd">    ...     Date(datetime.datetime(2000, 10, 1, 12, 30, 0, 999))</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: While trying to initialise a `Date` object based on \</span>
<span class="sd">argument `2000-10-01 12:30:00.000999`, the following error occurred: \</span>
<span class="sd">For `Date` instances, the microsecond must be zero, \</span>
<span class="sd">but for the given `datetime` object it is `999` instead.</span>

<span class="sd">    &gt;&gt;&gt; classname(datetime.datetime)</span>
<span class="sd">    &#39;datetime&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">_DateTime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="nd">@classmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">now</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
            <span class="k">return</span> <span class="n">testdatetime</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">_DateTime</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">_datetime</span></div>



<div class="viewcode-block" id="NumericalDifferentiator">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.NumericalDifferentiator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NumericalDifferentiator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Approximate the derivatives of |ModelSequence| values based on the finite</span>
<span class="sd">    difference approach.</span>

<span class="sd">    .. _`here`: https://en.wikipedia.org/wiki/Finite_difference_coefficient</span>

<span class="sd">    Class |NumericalDifferentiator| is thought for testing purposes only.  See, for</span>
<span class="sd">    example, the documentation on method |kinw_model.Calc_RHMDH_V1|, which uses a</span>
<span class="sd">    |NumericalDifferentiator| object to validate that this method calculates the</span>
<span class="sd">    derivative of sequence |kinw_aides.RHM| (`ysequence`) with respect to sequence</span>
<span class="sd">    |kinw_states.H| (`xsequence`) correctly. Therefore, it must know the relationship</span>
<span class="sd">    between |kinw_aides.RHM| and |kinw_states.H|, being defined by method</span>
<span class="sd">    |kinw_model.Calc_RHM_V1|.</span>

<span class="sd">    See also the documentation on method |kinw_model.Calc_AMDH_UMDH_V1|, which explains</span>
<span class="sd">    how to apply class |NumericalDifferentiator| on multiple target sequences</span>
<span class="sd">    (`ysequences`).  Note that, in order to calculate the correct derivatives of</span>
<span class="sd">    sequences |kinw_aides.AM| and |kinw_aides.UM|, we need not only to pass</span>
<span class="sd">    |kinw_model.Calc_AM_UM_V1|, but also methods |kinw_model.Calc_RHM_V1| and</span>
<span class="sd">    |kinw_model.Calc_RHV_V1|, as sequences |kinw_aides.RHM| and |kinw_aides.RHV|, which</span>
<span class="sd">    are required for calculating |kinw_aides.AM| and |kinw_aides.UM|, depend on</span>
<span class="sd">    |kinw_states.H| themselves.</span>

<span class="sd">    Numerical approximations of derivatives are of limited precision.</span>
<span class="sd">    |NumericalDifferentiator| achieves the second order of accuracy due to using the</span>
<span class="sd">    coefficients given `here`_.  If results are too inaccurate, you might improve them</span>
<span class="sd">    by changing the finite difference method (`backward` or `central` instead of</span>
<span class="sd">    `forward`) or by changing the default interval width `dx`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__NMBNODES</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">__XSHIFTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]),</span>
        <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
        <span class="s2">&quot;central&quot;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
    <span class="p">}</span>
    <span class="n">__YCOEFFS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="s2">&quot;central&quot;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">xsequence</span><span class="p">:</span> <span class="n">sequencetools</span><span class="o">.</span><span class="n">ModelSequence</span><span class="p">,</span>
        <span class="n">ysequences</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">ModelSequence</span><span class="p">],</span>
        <span class="n">methods</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">],</span>
        <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;backward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xsequence</span> <span class="o">=</span> <span class="n">xsequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ysequences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ysequences</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_span</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ycoeffs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__YCOEFFS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_span</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_xshifts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArrayFloat</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__XSHIFTS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_span</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_yvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">ModelSequence</span><span class="p">,</span> <span class="n">NDArrayFloat</span><span class="p">]:</span>
        <span class="n">xvalues</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xsequence</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ysequences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NDIM</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">seq</span><span class="o">.</span><span class="n">NDIM</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ysequences</span><span class="p">)</span>
        <span class="n">nmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ysequences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numberofvalues</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">nmb</span> <span class="o">==</span> <span class="n">seq</span><span class="o">.</span><span class="n">numberofvalues</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ysequences</span><span class="p">)</span>
        <span class="n">yvalues</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ysequence</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__NMBNODES</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ysequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ysequences</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xshifts</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_xsequence</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">xvalues</span> <span class="o">+</span> <span class="n">shift</span>
                <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">:</span>
                    <span class="n">method</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ysequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ysequences</span><span class="p">:</span>
                    <span class="n">yvalues</span><span class="p">[</span><span class="n">ysequence</span><span class="p">][:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ysequence</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">yvalues</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xsequence</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">xvalues</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">sequencetools</span><span class="o">.</span><span class="n">ModelSequence</span><span class="p">,</span> <span class="n">NDArrayFloat</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">ysequence</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ycoeffs</span><span class="p">,</span> <span class="n">yvalues</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ysequence</span><span class="p">,</span> <span class="n">yvalues</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yvalues</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ysequence</span><span class="p">,</span> <span class="n">derivatives</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derivatives</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;d_</span><span class="si">{</span><span class="n">ysequence</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/d_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_xsequence</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
            <span class="n">objecttools</span><span class="o">.</span><span class="n">print_vector</span><span class="p">(</span><span class="n">derivatives</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_integrationtests">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.update_integrationtests">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_integrationtests</span><span class="p">(</span>
    <span class="n">applicationmodel</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resultfilepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;update_integrationtests.txt&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write the docstring of the given application model, updated with the current</span>
<span class="sd">    simulation results, to file.</span>

<span class="sd">    Sometimes, even tiny model-related changes bring a great deal of work concerning</span>
<span class="sd">    *HydPy&#39;s* integration test strategy.  For example, if you modify the value of a</span>
<span class="sd">    fixed parameter, the results of possibly dozens of integration tests of your</span>
<span class="sd">    application model might become wrong.  In such situations, function</span>
<span class="sd">    |update_integrationtests| helps you in replacing all integration tests results at</span>
<span class="sd">    once.  Therefore, it calculates the new results, updates the old module docstring</span>
<span class="sd">    and writes it.  You only need to copy-paste the printed result into the affected</span>
<span class="sd">    module.  But be aware that function |update_integrationtests| cannot guarantee the</span>
<span class="sd">    correctness of the new results.  Whenever in doubt if the new results are really</span>
<span class="sd">    correct under all possible conditions, you should inspect and replace each</span>
<span class="sd">    integration test result manually.</span>

<span class="sd">    In the following example, we disable method |hydpytools.HydPy.simulate|</span>
<span class="sd">    temporarily.  Accordingly, application model |conv_nn| does not pass any output to</span>
<span class="sd">    its outlet nodes, which is why the last four columns of both integration test</span>
<span class="sd">    tables now contain zero value only (we can perform this mocking-based test in</span>
<span class="sd">    Python-mode only):</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub, TestIO, update_integrationtests</span>
<span class="sd">    &gt;&gt;&gt; from unittest import mock</span>
<span class="sd">    &gt;&gt;&gt; pass_output = &quot;hydpy.core.hydpytools.HydPy.simulate&quot;</span>
<span class="sd">    &gt;&gt;&gt; with TestIO(), pub.options.usecython(False), mock.patch(pass_output):</span>
<span class="sd">    ...     update_integrationtests(&quot;conv_nn&quot;, &quot;temp.txt&quot;)</span>
<span class="sd">    ...     with open(&quot;temp.txt&quot;) as resultfile:</span>
<span class="sd">    ...         print(resultfile.read())  # doctest: +ELLIPSIS</span>
<span class="sd">    Number of replacements: 2</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    ... test()</span>
<span class="sd">    |       date |      inputs |                outputs | in1 | in2 | out1 | out2 \</span>
<span class="sd">| out3 | out4 |</span>
<span class="sd">    ------------------------------------------------------------------------------\</span>
<span class="sd">---------------</span>
<span class="sd">    | 2000-01-01 | nan     nan | nan  nan  nan      nan | 1.0 | 4.0 |  nan |  nan \</span>
<span class="sd">|  nan |  nan |</span>
<span class="sd">    | 2000-01-02 | nan     nan | nan  nan  nan      nan | 2.0 | nan |  nan |  nan \</span>
<span class="sd">|  nan |  nan |</span>
<span class="sd">    | 2000-01-03 | nan     nan | nan  nan  nan      nan | nan | nan |  nan |  nan \</span>
<span class="sd">|  nan |  nan |</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    ... test()</span>
<span class="sd">    |       date |      inputs |                outputs | in1 | in2 | out1 | out2 \</span>
<span class="sd">| out3 | out4 |</span>
<span class="sd">    ------------------------------------------------------------------------------\</span>
<span class="sd">---------------</span>
<span class="sd">    | 2000-01-01 | nan     nan | nan  nan  nan      nan | 1.0 | 4.0 |  nan |  nan \</span>
<span class="sd">|  nan |  nan |</span>
<span class="sd">    | 2000-01-02 | nan     nan | nan  nan  nan      nan | 2.0 | nan |  nan |  nan \</span>
<span class="sd">|  nan |  nan |</span>
<span class="sd">    | 2000-01-03 | nan     nan | nan  nan  nan      nan | nan | nan |  nan |  nan \</span>
<span class="sd">|  nan |  nan |</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">load_modelmodule</span><span class="p">(</span><span class="n">applicationmodel</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">docstring</span> <span class="o">:=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">stringio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span>
    <span class="k">with</span> <span class="n">stringio</span><span class="p">()</span> <span class="k">as</span> <span class="n">file_</span><span class="p">,</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="n">file_</span><span class="p">):</span>
        <span class="n">module</span><span class="o">.</span><span class="n">tester</span><span class="o">.</span><span class="n">perform_tests</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">file_</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">oldlines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">newlines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">expected</span><span class="p">,</span> <span class="n">got</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
    <span class="n">nmb_replacements</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;Expected:&quot;</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;Got:&quot;</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">got</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">got</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;***********************************&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">got</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">oldlines</span> <span class="ow">or</span> <span class="n">newlines</span><span class="p">:</span>
                <span class="n">nmb_replacements</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">docstring</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oldlines</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newlines</span><span class="p">))</span>
                <span class="n">docstring</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">oldlines</span><span class="p">),</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">newlines</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="n">oldlines</span><span class="p">,</span> <span class="n">newlines</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">expected</span><span class="p">:</span>
            <span class="n">oldlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">got</span><span class="p">:</span>
            <span class="n">newlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultfilepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">resultfile</span><span class="p">:</span>
        <span class="n">resultfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of replacements: </span><span class="si">{</span><span class="n">nmb_replacements</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">resultfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">],</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">objecttools</span><span class="o">.</span><span class="n">enumeration</span><span class="p">(</span>
        <span class="n">v</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variabletools</span><span class="o">.</span><span class="n">sort_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
    <span class="p">)</span>


<div class="viewcode-block" id="check_methodorder">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.check_methodorder">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_methodorder</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that *HydPy* calls the methods of the given application model in the</span>
<span class="sd">    correct order for each simulation step.</span>

<span class="sd">    The purpose of this function is to help model developers ensure that each method</span>
<span class="sd">    uses only the values of those sequences that have been calculated by other methods</span>
<span class="sd">    beforehand.  *HydPy&#39;s* test routines apply |check_methodorder| automatically on</span>
<span class="sd">    each available application model. Alternatively, you can also execute it at the end</span>
<span class="sd">    of the docstring of an individual application model &quot;manually&quot;, which suppresses</span>
<span class="sd">    the automatic execution and allows to check and discuss exceptional cases where</span>
<span class="sd">    |check_methodorder| generates false alarms.</span>

<span class="sd">    Function |check_methodorder| relies on the class constants `REQUIREDSEQUENCES`,</span>
<span class="sd">    `UPDATEDSEQUENCES`, and `RESULTSEQUENCES` of all relevant |Method| subclasses.</span>
<span class="sd">    Hence, the correctness of its results depends on the correctness of these tuples.</span>
<span class="sd">    However, even if those tuples are well-defined, one cannot expect</span>
<span class="sd">    |check_methodorder| to catch all kinds of order-related errors.  For example,</span>
<span class="sd">    consider the case where one method calculates only some values of a</span>
<span class="sd">    multi-dimensional sequence and another method the  remaining ones.</span>
<span class="sd">    |check_methodorder|  would not report anything when a third method, relying on the</span>
<span class="sd">    completeness of the sequence&#39;s values, were called after the first but before the</span>
<span class="sd">    second method.</span>

<span class="sd">    We use the quite complex model |lland_knauf| as an example.  |check_methodorder|</span>
<span class="sd">    does not report any problems:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import check_methodorder</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.models.lland_knauf import Model</span>
<span class="sd">    &gt;&gt;&gt; print(check_methodorder(Model))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    To show how |check_methodorder| reports errors, we modify the `RESULTSEQUENCES`</span>
<span class="sd">    tuples of methods |lland_model.Calc_TKor_V1|, |lland_model.Calc_TZ_V1|, and</span>
<span class="sd">    |lland_model.Calc_QA_V1|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.lland.lland_model import (</span>
<span class="sd">    ...     Calc_TKor_V1, Calc_TZ_V1, Calc_QA_V1)</span>
<span class="sd">    &gt;&gt;&gt; results_tkor = Calc_TKor_V1.RESULTSEQUENCES</span>
<span class="sd">    &gt;&gt;&gt; results_tz = Calc_TZ_V1.RESULTSEQUENCES</span>
<span class="sd">    &gt;&gt;&gt; results_qa = Calc_QA_V1.RESULTSEQUENCES</span>
<span class="sd">    &gt;&gt;&gt; Calc_TKor_V1.RESULTSEQUENCES = ()</span>
<span class="sd">    &gt;&gt;&gt; Calc_TZ_V1.RESULTSEQUENCES = ()</span>
<span class="sd">    &gt;&gt;&gt; Calc_QA_V1.RESULTSEQUENCES += results_tkor</span>

<span class="sd">    Now, none of the relevant models calculates the value of sequence</span>
<span class="sd">    |lland_fluxes.TZ|.  For |lland_fluxes.TKor|, there is still a method</span>
<span class="sd">    (|lland_model.Calc_QA_V1|) calculating its values, but at a too-late stage of the</span>
<span class="sd">    simulation step:</span>

<span class="sd">    &gt;&gt;&gt; print(check_methodorder(Model))  # doctest: +ELLIPSIS</span>
<span class="sd">    Method Calc_SaturationVapourPressure_V1 requires the following sequences, which \</span>
<span class="sd">are not among the result sequences of any of its predecessors: TKor</span>
<span class="sd">    ...</span>
<span class="sd">    Method Update_ESnow_V1 requires the following sequences, which are not among the \</span>
<span class="sd">result sequences of any of its predecessors: TKor and TZ</span>

<span class="sd">    To tidy up, we need to revert the above changes:</span>

<span class="sd">    &gt;&gt;&gt; Calc_TKor_V1.RESULTSEQUENCES = results_tkor</span>
<span class="sd">    &gt;&gt;&gt; Calc_TZ_V1.RESULTSEQUENCES = results_tz</span>
<span class="sd">    &gt;&gt;&gt; Calc_QA_V1.RESULTSEQUENCES = results_qa</span>
<span class="sd">    &gt;&gt;&gt; print(check_methodorder(Model))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">blanks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>
    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sequencetools</span><span class="o">.</span><span class="n">InputSequence</span><span class="p">,</span>
        <span class="n">sequencetools</span><span class="o">.</span><span class="n">InletSequence</span><span class="p">,</span>
        <span class="n">sequencetools</span><span class="o">.</span><span class="n">ObserverSequence</span><span class="p">,</span>
        <span class="n">sequencetools</span><span class="o">.</span><span class="n">ReceiverSequence</span><span class="p">,</span>
        <span class="n">sequencetools</span><span class="o">.</span><span class="n">StateSequence</span><span class="p">,</span>
        <span class="n">sequencetools</span><span class="o">.</span><span class="n">LogSequence</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_methods</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;ADD_METHODS&quot;</span><span class="p">,</span> <span class="s2">&quot;INTERFACE_METHODS&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">method1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">methods</span><span class="p">):</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">seq</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">method1</span><span class="o">.</span><span class="n">REQUIREDSEQUENCES</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">excluded</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">method0</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">[:</span><span class="n">idx</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                <span class="n">method0</span><span class="o">.</span><span class="n">RESULTSEQUENCES</span><span class="p">,</span> <span class="n">method0</span><span class="o">.</span><span class="n">UPDATEDSEQUENCES</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
                    <span class="n">required</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">required</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">Method </span><span class="si">{</span><span class="n">method1</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> requires the following sequences, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which are not among the result sequences of any of its &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;predecessors: </span><span class="si">{</span><span class="n">_enumerate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">required</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_selectedvariables">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.check_selectedvariables">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_selectedvariables</span><span class="p">(</span><span class="n">method</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">modeltools</span><span class="o">.</span><span class="n">Method</span><span class="p">],</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform consistency checks regarding the |Parameter| and |Sequence_|</span>
<span class="sd">    subclasses selected by the given |Method| subclass.</span>

<span class="sd">    The purpose of this function is to help model developers ensure that the class</span>
<span class="sd">    tuples `CONTROLPARAMETERS`, `DERIVEDPARAMETERS`, `FIXEDPARAMETERS`,</span>
<span class="sd">    `SOLVERPARAMETERS`, `REQUIREDSEQUENCES`, `UPDATEDSEQUENCES`, and `RESULTSEQUENCES`</span>
<span class="sd">    contain the correct parameter and sequence subclasses.  *HydPy&#39;s* test routines</span>
<span class="sd">    apply |check_selectedvariables| automatically on each method of each available</span>
<span class="sd">    application model.  Alternatively, you can also execute it at the end of the</span>
<span class="sd">    docstring of an individual |Method| subclass &quot;manually&quot;, which suppresses the</span>
<span class="sd">    automatic execution and allows to check and discuss exceptional cases where</span>
<span class="sd">    |check_selectedvariables| generates false alarms.</span>

<span class="sd">    Do not expect |check_selectedvariables| to catch all possible errors.  Also, false</span>
<span class="sd">    positives might occur.  However, in our experience, function</span>
<span class="sd">    |check_selectedvariables| is of great help to prevent the most common mistakes when</span>
<span class="sd">    defining the parameter and sequence classes relevant for a specific method.</span>

<span class="sd">    As an example, we select method |evap_model.Calc_WindSpeed2m_V1| of base model</span>
<span class="sd">    |evap|.  |check_selectedvariables| does not reportany problems:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import check_selectedvariables</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_model import Calc_WindSpeed10m_V1</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Calc_WindSpeed10m_V1))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    To show how |check_selectedvariables| reports errors, we clear the</span>
<span class="sd">    `RESULTSEQUENCES` tuple of method |evap_model.Calc_WindSpeed10m_V1|.  Now</span>
<span class="sd">    |check_selectedvariables| realises the usage of the factor sequence object</span>
<span class="sd">    `windspeed10m` within the source code of method |evap_model.Calc_WindSpeed10m_V1|,</span>
<span class="sd">    which is neither available within the `REQUIREDSEQUENCES`, the `UPDATEDSEQUENCES`,</span>
<span class="sd">    nor the`RESULTSEQUENCES` tuple:</span>

<span class="sd">    &gt;&gt;&gt; resultseqs = Calc_WindSpeed10m_V1.RESULTSEQUENCES</span>
<span class="sd">    &gt;&gt;&gt; Calc_WindSpeed10m_V1.RESULTSEQUENCES = ()</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Calc_WindSpeed10m_V1))</span>
<span class="sd">    Definitely missing: windspeed10m</span>

<span class="sd">    After putting the wrong flux sequence class |evap_factors.WindSpeed2m| into the</span>
<span class="sd">    tuple, we get an additional warning pointing to our mistake:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_factors import WindSpeed2m</span>
<span class="sd">    &gt;&gt;&gt; Calc_WindSpeed10m_V1.RESULTSEQUENCES = WindSpeed2m,</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Calc_WindSpeed10m_V1))</span>
<span class="sd">    Definitely missing: windspeed10m</span>
<span class="sd">    Possibly erroneously selected (RESULTSEQUENCES): WindSpeed2m</span>

<span class="sd">    Method |evap_model.Calc_WindSpeed10m_V1| uses</span>
<span class="sd">    |evap_model.Return_AdjustedWindSpeed_V1| as a submethod.  Hence,</span>
<span class="sd">    |evap_model.Calc_WindSpeed10m_V1| most likely needs to select each variable</span>
<span class="sd">    selected by |evap_model.Return_AdjustedWindSpeed_V1|.  After adding additional</span>
<span class="sd">    variables to the `DERIVEDPARAMETERS` tuple of</span>
<span class="sd">    |evap_model.Return_AdjustedWindSpeed_V1|, we get another warning message:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_model import Return_AdjustedWindSpeed_V1</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_derived import Days, Hours, Seconds</span>
<span class="sd">    &gt;&gt;&gt; derivedpars = Return_AdjustedWindSpeed_V1.DERIVEDPARAMETERS</span>
<span class="sd">    &gt;&gt;&gt; Return_AdjustedWindSpeed_V1.DERIVEDPARAMETERS = Days, Hours, Seconds</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Calc_WindSpeed10m_V1))</span>
<span class="sd">    Definitely missing: windspeed10m</span>
<span class="sd">    Possibly missing (DERIVEDPARAMETERS):</span>
<span class="sd">        Return_AdjustedWindSpeed_V1: Seconds, Hours, and Days</span>
<span class="sd">    Possibly erroneously selected (RESULTSEQUENCES): WindSpeed2m</span>

<span class="sd">    Finally, |check_selectedvariables| checks for duplicates both within and between</span>
<span class="sd">    the different tuples:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_inputs import WindSpeed, RelativeHumidity</span>
<span class="sd">    &gt;&gt;&gt; requiredseqs = Calc_WindSpeed10m_V1.REQUIREDSEQUENCES</span>
<span class="sd">    &gt;&gt;&gt; Calc_WindSpeed10m_V1.REQUIREDSEQUENCES = WindSpeed, WindSpeed, RelativeHumidity</span>
<span class="sd">    &gt;&gt;&gt; Calc_WindSpeed10m_V1.UPDATEDSEQUENCES = RelativeHumidity,</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Calc_WindSpeed10m_V1))</span>
<span class="sd">    Definitely missing: windspeed10m</span>
<span class="sd">    Possibly missing (DERIVEDPARAMETERS):</span>
<span class="sd">        Return_AdjustedWindSpeed_V1: Seconds, Hours, and Days</span>
<span class="sd">    Possibly erroneously selected (REQUIREDSEQUENCES): RelativeHumidity</span>
<span class="sd">    Possibly erroneously selected (UPDATEDSEQUENCES): RelativeHumidity</span>
<span class="sd">    Possibly erroneously selected (RESULTSEQUENCES): WindSpeed2m</span>
<span class="sd">    Duplicates: RelativeHumidity and WindSpeed</span>

<span class="sd">    To tidy up, we need to revert the above changes:</span>

<span class="sd">    &gt;&gt;&gt; Calc_WindSpeed10m_V1.RESULTSEQUENCES = resultseqs</span>
<span class="sd">    &gt;&gt;&gt; Return_AdjustedWindSpeed_V1.DERIVEDPARAMETERS = derivedpars</span>
<span class="sd">    &gt;&gt;&gt; Calc_WindSpeed10m_V1.REQUIREDSEQUENCES = requiredseqs</span>
<span class="sd">    &gt;&gt;&gt; Calc_WindSpeed10m_V1.UPDATEDSEQUENCES = ()</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Calc_WindSpeed10m_V1))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    Some methods, such as |arma_model.Pick_Q_V1|, of base model |arma| rely on the</span>
<span class="sd">    `len` attribute of 1-dimensional sequences.  Function |check_selectedvariables|</span>
<span class="sd">    does not report false alarms in such cases:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.arma.arma_model import Pick_Q_V1</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Pick_Q_V1))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    Some methods such as |evap_model.Calc_PotentialEvapotranspiration_V1| of base model</span>
<span class="sd">    |evap| rely on the |KeywordParameter1D.entrymin| attribute of |KeywordParameter1D|</span>
<span class="sd">    instances.  Function |check_selectedvariables| does not report false alarms in such</span>
<span class="sd">    cases:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_model import Calc_PotentialEvapotranspiration_V1</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_control import MonthFactor</span>
<span class="sd">    &gt;&gt;&gt; MonthFactor in Calc_PotentialEvapotranspiration_V1.CONTROLPARAMETERS</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Calc_PotentialEvapotranspiration_V1))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    Some methods, such as |evap_model.Calc_PotentialEvapotranspiration_V2| of base</span>
<span class="sd">    model |evap|, rely on the |KeywordParameter2D.rowmin| or the</span>
<span class="sd">    |KeywordParameter2D.columnmin| attribute of |KeywordParameter2D| instances.</span>
<span class="sd">    Function |check_selectedvariables| does not report false alarms in such cases:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_model import Calc_PotentialEvapotranspiration_V2</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_control import LandMonthFactor</span>
<span class="sd">    &gt;&gt;&gt; LandMonthFactor in Calc_PotentialEvapotranspiration_V2.CONTROLPARAMETERS</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Calc_PotentialEvapotranspiration_V2))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    Some methods, such as |lland_model.Update_ESnow_V1| of base model |lland|, update a</span>
<span class="sd">    sequence (meaning, they require its old value and calculate a new one), but their</span>
<span class="sd">    submethods (in this case |lland_model.Return_BackwardEulerError_V1|) just require</span>
<span class="sd">    them as input.  Function |check_selectedvariables| does not report false alarms in</span>
<span class="sd">    such cases:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.lland.lland_model import Update_ESnow_V1</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Update_ESnow_V1))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    Similarly, methods such as |ga_model.Perform_GARTO_V1| calculate sequence values</span>
<span class="sd">    from scratch but require submethods for updating them:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.ga.ga_model import Perform_GARTO_V1</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Perform_GARTO_V1))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    If a |AutoMethod| subclass selects multiple submethods and one requires sequence</span>
<span class="sd">    values that are calculated by another one, |check_selectedvariables| does not</span>
<span class="sd">    report this as a problem if they are listed in the correct order, as is the case</span>
<span class="sd">    for method |evap_model.Determine_InterceptionEvaporation_V1|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.evap.evap_model import Determine_InterceptionEvaporation_V1</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Determine_InterceptionEvaporation_V1))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    However, when reversing the submethod order, |check_selectedvariables| complains</span>
<span class="sd">    that |evap_model.Determine_InterceptionEvaporation_V1| does not specify all</span>
<span class="sd">    requirements of the first submethod |evap_model.Calc_InterceptionEvaporation_V1|,</span>
<span class="sd">    which would be calculated too late by the second</span>
<span class="sd">    (|evap_model.Calc_InterceptedWater_V1|) and the third</span>
<span class="sd">    (|evap_model.Calc_PotentialInterceptionEvaporation_V3|) submethod:</span>

<span class="sd">    &gt;&gt;&gt; submethods = Determine_InterceptionEvaporation_V1.SUBMETHODS</span>
<span class="sd">    &gt;&gt;&gt; Determine_InterceptionEvaporation_V1.SUBMETHODS = tuple(reversed(submethods))</span>
<span class="sd">    &gt;&gt;&gt; print(check_selectedvariables(Determine_InterceptionEvaporation_V1))</span>
<span class="sd">    Possibly missing (REQUIREDSEQUENCES):</span>
<span class="sd">        Calc_InterceptionEvaporation_V1: InterceptedWater and \</span>
<span class="sd">PotentialInterceptionEvaporation</span>

<span class="sd">    &gt;&gt;&gt; Determine_InterceptionEvaporation_V1.SUBMETHODS = submethods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="c1"># ToDo: needs refactoring</span>
    <span class="n">prefixes</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;con&quot;</span><span class="p">,</span>
        <span class="s2">&quot;der&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fix&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fac&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;old&quot;</span><span class="p">,</span>
        <span class="s2">&quot;new&quot;</span><span class="p">,</span>
        <span class="s2">&quot;log&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;out&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sen&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;CONTROLPARAMETERS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DERIVEDPARAMETERS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FIXEDPARAMETERS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SOLVERPARAMETERS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;REQUIREDSEQUENCES&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UPDATEDSEQUENCES&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESULTSEQUENCES&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">blanks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>
    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># search for variables that are used in the source code but not among the selected</span>
    <span class="c1"># variables:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
    <span class="n">varnames_source</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">varnames_candidates</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="fm">__call__</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_names</span><span class="p">)</span>
    <span class="n">names_builtin</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">builtins</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">varnames_candidates</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">varname</span> <span class="ow">in</span> <span class="n">names_builtin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;modelutils.</span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">):</span>
            <span class="n">varnames_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">varnames_candidates</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;len_&quot;</span><span class="p">):</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;_rowmin&quot;</span><span class="p">,</span> <span class="s2">&quot;_columnmin&quot;</span><span class="p">,</span> <span class="s2">&quot;_entrymin&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">varname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                        <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_callback&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">varnames_source</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
    <span class="n">varnames_selected</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">varnames_selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
    <span class="n">varnames_diff</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">varnames_source</span> <span class="o">-</span> <span class="n">varnames_selected</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">varnames_diff</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">Definitely missing: </span><span class="si">{</span><span class="n">objecttools</span><span class="o">.</span><span class="n">enumeration</span><span class="p">(</span><span class="n">varnames_diff</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># search for variables selected by at least one submethod but not by the method</span>
    <span class="c1"># calling these submethods:</span>
    <span class="n">vars_method</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">]]</span>
    <span class="n">vars_submethods</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">vars_method</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
        <span class="n">found_problem</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">idx_submethod</span><span class="p">,</span> <span class="n">submethod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">SUBMETHODS</span><span class="p">):</span>
            <span class="n">vars_submethods</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">submethod</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;REQUIREDSEQUENCES&quot;</span><span class="p">:</span>
                <span class="n">vars_method</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">UPDATEDSEQUENCES</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                        <span class="n">submethod</span><span class="o">.</span><span class="n">REQUIREDSEQUENCES</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span>
                    <span class="n">method</span><span class="p">,</span> <span class="p">(</span><span class="n">modeltools</span><span class="o">.</span><span class="n">AutoMethod</span><span class="p">,</span> <span class="n">modeltools</span><span class="o">.</span><span class="n">SetAutoMethod</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">for</span> <span class="n">previous</span> <span class="ow">in</span> <span class="n">method</span><span class="o">.</span><span class="n">SUBMETHODS</span><span class="p">[:</span><span class="n">idx_submethod</span><span class="p">]:</span>
                        <span class="n">vars_submethods</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">previous</span><span class="o">.</span><span class="n">RESULTSEQUENCES</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">vars_submethods</span> <span class="o">-</span> <span class="n">vars_method</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="ow">and</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;UPDATEDSEQUENCES&quot;</span><span class="p">):</span>
                <span class="n">diff</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">RESULTSEQUENCES</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found_problem</span><span class="p">:</span>
                    <span class="n">found_problem</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">Possibly missing (</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">    </span><span class="si">{</span><span class="n">submethod</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">_enumerate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="c1"># search for selected variables that are neither used within the source code nor</span>
    <span class="c1"># selected by any submethod:</span>
    <span class="n">group2vars_method</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">g</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span>
    <span class="p">}</span>
    <span class="n">group2vars_submethods</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">g</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">submethod</span> <span class="ow">in</span> <span class="n">method</span><span class="o">.</span><span class="n">SUBMETHODS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">vars_submethods</span> <span class="ow">in</span> <span class="n">group2vars_submethods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">vars_submethods</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">submethod</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">vars_method</span> <span class="ow">in</span> <span class="n">group2vars_method</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">vars_submethods</span> <span class="o">=</span> <span class="n">group2vars_submethods</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">diff_</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">method</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">vars_method</span> <span class="o">-</span> <span class="n">vars_submethods</span>
            <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varnames_source</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">diff_</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">Possibly erroneously selected (</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">): &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_enumerate</span><span class="p">(</span><span class="n">diff_</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># search for variables that are selected multiple times:</span>
    <span class="n">vars1</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">vars2</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">dupl</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">variabletools</span><span class="o">.</span><span class="n">Variable</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">group1</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">vars1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">group1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vars1</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dupl</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group2</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">group2</span><span class="p">:</span>
                <span class="n">vars2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">group2</span><span class="p">)</span>
                <span class="n">dupl</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vars1</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">vars2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dupl</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">Duplicates: </span><span class="si">{</span><span class="n">_enumerate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">dupl</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>



<div class="viewcode-block" id="perform_consistencychecks">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.perform_consistencychecks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_consistencychecks</span><span class="p">(</span>
    <span class="n">applicationmodel</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform all available consistency checks for the given application model.</span>

<span class="sd">    At the moment, function |perform_consistencychecks| calls function</span>
<span class="sd">    |check_selectedvariables| for each relevant model method and function</span>
<span class="sd">    |check_methodorder| for the application model itself.  Note that</span>
<span class="sd">    |perform_consistencychecks| executes only those checks not already executed in the</span>
<span class="sd">    doctest of the respective method or model.  This alternative allows model</span>
<span class="sd">    developers to perform the tests themselves whenever exceptional cases result in</span>
<span class="sd">    misleading error reports and discuss any related potential pitfalls in the official</span>
<span class="sd">    documentation.</span>

<span class="sd">    As an example, we apply |perform_consistencychecks| on the application model</span>
<span class="sd">    |lland_knauf|.  It does not report any potential problems (not already discussed in</span>
<span class="sd">    the documentation on the individual model methods):</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import perform_consistencychecks</span>
<span class="sd">    &gt;&gt;&gt; print(perform_consistencychecks(&quot;lland_knauf&quot;))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    To show how |perform_consistencychecks| reports errors, we modify the</span>
<span class="sd">    `RESULTSEQUENCES` tuple of method |lland_model.Calc_NKor_V1|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.models.lland.lland_model import Calc_NKor_V1</span>
<span class="sd">    &gt;&gt;&gt; resultsequences = Calc_NKor_V1.RESULTSEQUENCES</span>
<span class="sd">    &gt;&gt;&gt; Calc_NKor_V1.RESULTSEQUENCES = ()</span>
<span class="sd">    &gt;&gt;&gt; print(perform_consistencychecks(&quot;lland_knauf&quot;))</span>
<span class="sd">    Potential consistency problems for individual methods:</span>
<span class="sd">       Method Calc_NKor_V1:</span>
<span class="sd">            Definitely missing: nkor</span>
<span class="sd">    Potential consistency problems between methods:</span>
<span class="sd">        Method Calc_NBes_Inzp_V1 requires the following sequences, which are not among \</span>
<span class="sd">the result sequences of any of its predecessors: NKor</span>
<span class="sd">        Method Calc_QBGZ_V1 requires the following sequences, which are not among the \</span>
<span class="sd">result sequences of any of its predecessors: NKor</span>
<span class="sd">        Method Calc_QDGZ_V1 requires the following sequences, which are not among the \</span>
<span class="sd">result sequences of any of its predecessors: NKor</span>
<span class="sd">        Method Calc_QAH_V1 requires the following sequences, which are not among the \</span>
<span class="sd">result sequences of any of its predecessors: NKor</span>

<span class="sd">    To tidy up, we need to revert the above changes:</span>

<span class="sd">    &gt;&gt;&gt; Calc_NKor_V1.RESULTSEQUENCES = resultsequences</span>
<span class="sd">    &gt;&gt;&gt; print(perform_consistencychecks(&quot;lland_knauf&quot;))</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">blanks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="n">applicationmodel</span><span class="p">)</span>
    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">method2errors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_methods</span><span class="p">():</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">methoddoc</span> <span class="o">:=</span> <span class="n">method</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;check_selectedvariables(&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methoddoc</span><span class="p">:</span>
            <span class="n">subresult</span> <span class="o">=</span> <span class="n">check_selectedvariables</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subresult</span><span class="p">:</span>
                <span class="n">method2errors</span><span class="p">[</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">subresult</span>
    <span class="k">if</span> <span class="n">method2errors</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">Potential consistency problems for individual methods:&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">errors</span> <span class="ow">in</span> <span class="n">method2errors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">   Method </span><span class="si">{</span><span class="n">methodname</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">modeldoc</span> <span class="o">:=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;check_methodorder(&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modeldoc</span><span class="p">:</span>
        <span class="n">subresult</span> <span class="o">=</span> <span class="n">check_methodorder</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subresult</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s2">Potential consistency problems between methods:&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subresult</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_autofig">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.save_autofig">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_autofig</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">figure</span><span class="p">:</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">Figure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a figure automatically generated during testing in the special `autofig`</span>
<span class="sd">    sub-package so that Sphinx can include it into the documentation later.</span>

<span class="sd">    When passing no figure, function |save_autofig| takes the currently active one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">autofigs</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">figure</span><span class="p">:</span>
        <span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">figure</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="warn_later">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.warn_later">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">warn_later</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Suppress warnings and print them upon exit.</span>

<span class="sd">    The context manager |warn_later| helps demonstrate functionalities in doctests that</span>
<span class="sd">    emit warnings:</span>

<span class="sd">    &gt;&gt;&gt; import warnings</span>
<span class="sd">    &gt;&gt;&gt; def get_number():</span>
<span class="sd">    ...     warnings.warn(&quot;This is a warning.&quot;)</span>
<span class="sd">    ...     return 1</span>

<span class="sd">    &gt;&gt;&gt; get_number()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    UserWarning: This is a warning.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import warn_later</span>
<span class="sd">    &gt;&gt;&gt; with warn_later():</span>
<span class="sd">    ...     get_number()</span>
<span class="sd">    1</span>
<span class="sd">    UserWarning: This is a warning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">records</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
        <span class="k">yield</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;: &quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="print_filestructure">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.print_filestructure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_filestructure</span><span class="p">(</span><span class="n">dirpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print the file structure of the given directory path in alphabetical order.</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; dirpath = os.path.join(data.__path__[0], &quot;HydPy-H-Lahn&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import data</span>
<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import print_filestructure</span>
<span class="sd">    &gt;&gt;&gt; print_filestructure(dirpath)  # doctest: +ELLIPSIS</span>
<span class="sd">    * ...hydpy/data/HydPy-H-Lahn</span>
<span class="sd">        - conditions</span>
<span class="sd">            - init_1996_01_01_00_00_00</span>
<span class="sd">                + land_dill_assl.py</span>
<span class="sd">                ...</span>
<span class="sd">                + stream_lahn_marb_lahn_leun.py</span>
<span class="sd">        - control</span>
<span class="sd">            - default</span>
<span class="sd">                + land.py</span>
<span class="sd">                ...</span>
<span class="sd">                + stream_lahn_marb_lahn_leun.py</span>
<span class="sd">        + multiple_runs.xml</span>
<span class="sd">        + multiple_runs_alpha.xml</span>
<span class="sd">        - network</span>
<span class="sd">            - default</span>
<span class="sd">                + headwaters.py</span>
<span class="sd">                + nonheadwaters.py</span>
<span class="sd">                + streams.py</span>
<span class="sd">        - series</span>
<span class="sd">            - default</span>
<span class="sd">                + dill_assl_obs_q.asc</span>
<span class="sd">                ...</span>
<span class="sd">                + obs_q.nc</span>
<span class="sd">        + single_run.xml</span>
<span class="sd">        + single_run.xmlt</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_filestructure</span><span class="p">(</span><span class="n">dirpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;__pycache__&quot;</span><span class="p">:</span>
                <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">subpath</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">_print_filestructure</span><span class="p">(</span><span class="n">subpath</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">+ </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">objecttools</span><span class="o">.</span><span class="n">repr_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;* </span><span class="si">{</span><span class="n">dirpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="n">_print_filestructure</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></div>



<div class="viewcode-block" id="prepare_io_example_1">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.prepare_io_example_1">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_io_example_1</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">,</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Elements</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare an IO example configuration for testing purposes.</span>

<span class="sd">    Function |prepare_io_example_1| is thought for testing the functioning of *HydPy*</span>
<span class="sd">    and thus should be of interest for framework developers only.  It uses the main</span>
<span class="sd">    models |lland_dd|, |lland_knauf|, and |hland_96| and the submodel</span>
<span class="sd">    |evap_aet_morsim|.  Here, we apply |prepare_io_example_1| and shortly discuss</span>
<span class="sd">    different aspects of its generated data:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_io_example_1</span>
<span class="sd">    &gt;&gt;&gt; nodes, elements = prepare_io_example_1()</span>

<span class="sd">    It defines a short initialisation period of five days:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy import pub</span>
<span class="sd">    &gt;&gt;&gt; pub.timegrids</span>
<span class="sd">    Timegrids(&quot;2000-01-01 00:00:00&quot;,</span>
<span class="sd">              &quot;2000-01-05 00:00:00&quot;,</span>
<span class="sd">              &quot;1d&quot;)</span>

<span class="sd">    It prepares an empty directory for IO testing:</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import repr_, TestIO</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():  # doctest: +ELLIPSIS</span>
<span class="sd">    ...     repr_(pub.sequencemanager.currentpath)</span>
<span class="sd">    ...     os.listdir(&quot;project/series/default&quot;)</span>
<span class="sd">    &#39;...iotesting/project/series/default&#39;</span>
<span class="sd">    []</span>

<span class="sd">    It returns four |Element| objects handling either application model |lland_dd|</span>
<span class="sd">    |lland_knauf|, or |hland_96|:</span>

<span class="sd">    &gt;&gt;&gt; for element in elements:</span>
<span class="sd">    ...     print(element.name, element.model)</span>
<span class="sd">    element1 lland_dd</span>
<span class="sd">    element2 lland_dd</span>
<span class="sd">    element3 lland_knauf</span>
<span class="sd">    element4 hland_96</span>

<span class="sd">    The |lland_knauf| instance has a submodel of type |evap_aet_morsim|:</span>

<span class="sd">    &gt;&gt;&gt; print(elements.element3.model.aetmodel.name)</span>
<span class="sd">    evap_aet_morsim</span>

<span class="sd">    Two |Node| objects handling variables `Q` and `T`:</span>

<span class="sd">    &gt;&gt;&gt; for node in nodes:</span>
<span class="sd">    ...     print(node.name, node.variable)</span>
<span class="sd">    node1 Q</span>
<span class="sd">    node2 T</span>

<span class="sd">    It generates artificial time series data for the input sequence</span>
<span class="sd">    |lland_inputs.Nied|, the flux sequence |lland_fluxes.NKor|, and the state sequence</span>
<span class="sd">    |lland_states.BoWa| of each |lland| model instance, the equally named wind speed</span>
<span class="sd">    sequences of |lland_knauf| and |evap_aet_morsim|, the state sequence</span>
<span class="sd">    |hland_states.SP| of the |hland_96| model instance, and the |Sim| sequence of each</span>
<span class="sd">    node instance.  For precise test results, all generated values are unique:</span>

<span class="sd">    &gt;&gt;&gt; nied1 = elements.element1.model.sequences.inputs.nied</span>
<span class="sd">    &gt;&gt;&gt; nied1.series</span>
<span class="sd">    InfoArray([0., 1., 2., 3.])</span>
<span class="sd">    &gt;&gt;&gt; nkor1 = elements.element1.model.sequences.fluxes.nkor</span>
<span class="sd">    &gt;&gt;&gt; nkor1.series</span>
<span class="sd">    InfoArray([[12.],</span>
<span class="sd">               [13.],</span>
<span class="sd">               [14.],</span>
<span class="sd">               [15.]])</span>
<span class="sd">    &gt;&gt;&gt; bowa3 = elements.element3.model.sequences.states.bowa</span>
<span class="sd">    &gt;&gt;&gt; bowa3.series</span>
<span class="sd">    InfoArray([[48., 49., 50.],</span>
<span class="sd">               [51., 52., 53.],</span>
<span class="sd">               [54., 55., 56.],</span>
<span class="sd">               [57., 58., 59.]])</span>
<span class="sd">    &gt;&gt;&gt; sim2 = nodes.node2.sequences.sim</span>
<span class="sd">    &gt;&gt;&gt; sim2.series</span>
<span class="sd">    InfoArray([64., 65., 66., 67.])</span>
<span class="sd">    &gt;&gt;&gt; sp4 = elements.element4.model.sequences.states.sp</span>
<span class="sd">    &gt;&gt;&gt; sp4.series</span>
<span class="sd">    InfoArray([[[68., 69., 70.],</span>
<span class="sd">                [71., 72., 73.]],</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">               [[74., 75., 76.],</span>
<span class="sd">                [77., 78., 79.]],</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">               [[80., 81., 82.],</span>
<span class="sd">                [83., 84., 85.]],</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">               [[86., 87., 88.],</span>
<span class="sd">                [89., 90., 91.]]])</span>
<span class="sd">    &gt;&gt;&gt; v_l = elements.element3.model.sequences.inputs.windspeed</span>
<span class="sd">    &gt;&gt;&gt; v_l.series</span>
<span class="sd">    InfoArray([68., 69., 70., 71.])</span>
<span class="sd">    &gt;&gt;&gt; v_e = elements.element3.model.aetmodel.sequences.inputs.windspeed</span>
<span class="sd">    &gt;&gt;&gt; v_e.series</span>
<span class="sd">    InfoArray([68., 69., 70., 71.])</span>

<span class="sd">    All sequences carry |numpy.ndarray| objects with (deep) copies of the time</span>
<span class="sd">    series data for testing:</span>

<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(nied1.series == nied1.testarray)</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(nkor1.series == nkor1.testarray)</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(bowa3.series == bowa3.testarray)</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(sim2.series == sim2.testarray)</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(sp4.series == sp4.testarray)</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(v_l.series == v_l.testarray)</span>
<span class="sd">    &gt;&gt;&gt; assert numpy.all(v_e.series == v_e.testarray)</span>
<span class="sd">    &gt;&gt;&gt; bowa3.series[1, 2] = -999.0</span>
<span class="sd">    &gt;&gt;&gt; assert not numpy.all(bowa3.series == bowa3.testarray)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">hland</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">hydpy.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">lland</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>

    <span class="n">TestIO</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
    <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>

    <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">projectname</span> <span class="o">=</span> <span class="s2">&quot;project&quot;</span>
    <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">sequencemanager</span> <span class="o">=</span> <span class="n">filetools</span><span class="o">.</span><span class="n">SequenceManager</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">TestIO</span><span class="p">():</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;project/series/default&quot;</span><span class="p">)</span>

    <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span> <span class="o">=</span> <span class="s2">&quot;2000-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2000-01-05&quot;</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span>

    <span class="n">node1</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s2">&quot;node1&quot;</span><span class="p">)</span>
    <span class="n">node2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s2">&quot;node2&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">)</span>
    <span class="n">element1</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;element1&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">node1</span><span class="p">)</span>
    <span class="n">element2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;element2&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">node1</span><span class="p">)</span>
    <span class="n">element3</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;element3&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">node1</span><span class="p">)</span>
    <span class="n">element4</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;element4&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">node1</span><span class="p">)</span>
    <span class="n">elements_lland</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Elements</span><span class="p">(</span><span class="n">element1</span><span class="p">,</span> <span class="n">element2</span><span class="p">,</span> <span class="n">element3</span><span class="p">)</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="n">elements_lland</span> <span class="o">+</span> <span class="n">element4</span>

    <span class="n">element1</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;lland_dd&quot;</span><span class="p">)</span>
    <span class="n">element2</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;lland_dd&quot;</span><span class="p">)</span>
    <span class="n">element3</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;lland_knauf&quot;</span><span class="p">)</span>
    <span class="n">element4</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;hland_96&quot;</span><span class="p">)</span>

    <span class="n">control3</span> <span class="o">=</span> <span class="n">element3</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
    <span class="n">control3</span><span class="o">.</span><span class="n">nhru</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">control3</span><span class="o">.</span><span class="n">ft</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">control3</span><span class="o">.</span><span class="n">fhru</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">control3</span><span class="o">.</span><span class="n">gh</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
    <span class="n">control3</span><span class="o">.</span><span class="n">lnk</span><span class="p">(</span><span class="n">lland</span><span class="o">.</span><span class="n">ACKER</span><span class="p">)</span>
    <span class="n">control3</span><span class="o">.</span><span class="n">measuringheightwindspeed</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="n">control3</span><span class="o">.</span><span class="n">lai</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
    <span class="n">control3</span><span class="o">.</span><span class="n">wmax</span><span class="p">(</span><span class="mf">300.0</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">element3</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_aetmodel_v1</span><span class="p">(</span><span class="s2">&quot;evap_aet_morsim&quot;</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elements_lland</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">nhru</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">lnk</span><span class="p">(</span><span class="n">lland</span><span class="o">.</span><span class="n">ACKER</span><span class="p">)</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">absfhru</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="n">control4</span> <span class="o">=</span> <span class="n">element4</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
    <span class="n">control4</span><span class="o">.</span><span class="n">nmbzones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">control4</span><span class="o">.</span><span class="n">sclass</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">control4</span><span class="o">.</span><span class="n">zonetype</span><span class="p">(</span><span class="n">hland</span><span class="o">.</span><span class="n">FIELD</span><span class="p">)</span>
    <span class="n">control4</span><span class="o">.</span><span class="n">zonearea</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="mf">10.0</span>

    <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">printprogress</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">prepare_simseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># ToDo: add option &quot;reset&quot;</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">prepare_simseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">prepare_inputseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">prepare_inputseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">prepare_factorseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">prepare_factorseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">prepare_fluxseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">prepare_fluxseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">prepare_stateseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">prepare_stateseries</span><span class="p">(</span><span class="n">allocate_ram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_values</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="n">TestIOSequence</span><span class="p">,</span> <span class="n">value1_</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">value2_</span> <span class="o">=</span> <span class="n">value1_</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">values_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">value1_</span><span class="p">,</span> <span class="n">value2_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">NP_FLOAT</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">testarray</span> <span class="o">=</span> <span class="n">values_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">seriesshape</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">testarray</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value2_</span>

    <span class="n">value1</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">subname</span><span class="p">,</span> <span class="n">seqname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;fluxes&quot;</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;nied&quot;</span><span class="p">,</span> <span class="s2">&quot;nkor&quot;</span><span class="p">,</span> <span class="s2">&quot;bowa&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements_lland</span><span class="p">:</span>
            <span class="n">subseqs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="p">,</span> <span class="n">subname</span><span class="p">)</span>
            <span class="n">value1</span> <span class="o">=</span> <span class="n">init_values</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">subseqs</span><span class="p">,</span> <span class="n">seqname</span><span class="p">),</span> <span class="n">value1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">value1</span> <span class="o">=</span> <span class="n">init_values</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">sim</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
    <span class="n">init_values</span><span class="p">(</span><span class="n">element4</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">sp</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
    <span class="n">init_values</span><span class="p">(</span>
        <span class="n">element3</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">windspeed</span><span class="p">,</span> <span class="n">value1</span>  <span class="c1"># type: ignore[arg-type]</span>
    <span class="p">)</span>
    <span class="n">init_values</span><span class="p">(</span><span class="n">element3</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">aetmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">windspeed</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span></div>



<div class="viewcode-block" id="prepare_full_example_1">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.prepare_full_example_1">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_full_example_1</span><span class="p">(</span><span class="n">dirpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare the `HydPy-H-Lahn` example project on disk.</span>

<span class="sd">    By default, function |prepare_full_example_1| copies the original project data into</span>
<span class="sd">    the `iotesting` directory, thought for performing automated tests on real-world</span>
<span class="sd">    data.  The following doctest shows the generated folder structure:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_full_example_1</span>
<span class="sd">    &gt;&gt;&gt; prepare_full_example_1()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import TestIO</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; with TestIO():</span>
<span class="sd">    ...     print(&quot;root:&quot;, *sorted(os.listdir(&quot;.&quot;)))</span>
<span class="sd">    ...     for folder in (&quot;control&quot;, &quot;conditions&quot;, &quot;series&quot;):</span>
<span class="sd">    ...         print(f&quot;HydPy-H-Lahn/{folder}:&quot;,</span>
<span class="sd">    ...               *sorted(os.listdir(f&quot;HydPy-H-Lahn/{folder}&quot;)))</span>
<span class="sd">    root: HydPy-H-Lahn __init__.py</span>
<span class="sd">    HydPy-H-Lahn/control: default</span>
<span class="sd">    HydPy-H-Lahn/conditions: init_1996_01_01_00_00_00</span>
<span class="sd">    HydPy-H-Lahn/series: default</span>

<span class="sd">    Pass an alternative path if you prefer to work in another directory:</span>

<span class="sd">    .. testsetup::</span>

<span class="sd">        &gt;&gt;&gt; &quot;HydPy-H-Lahn&quot; in os.listdir(&quot;.&quot;)</span>
<span class="sd">        False</span>

<span class="sd">    &gt;&gt;&gt; prepare_full_example_1(dirpath=&quot;.&quot;)</span>

<span class="sd">    .. testsetup::</span>

<span class="sd">        &gt;&gt;&gt; &quot;HydPy-H-Lahn&quot; in os.listdir(&quot;.&quot;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; import shutil</span>
<span class="sd">        &gt;&gt;&gt; shutil.rmtree(&quot;HydPy-H-Lahn&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
    <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dirpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">TestIO</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">iotesting</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="s2">&quot;HydPy-H-Lahn&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s2">&quot;HydPy-H-Lahn&quot;</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="prepare_full_example_2">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.prepare_full_example_2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_full_example_2</span><span class="p">(</span>
    <span class="n">lastdate</span><span class="p">:</span> <span class="n">timetools</span><span class="o">.</span><span class="n">DateConstrArg</span> <span class="o">=</span> <span class="s2">&quot;1996-01-05&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">,</span> <span class="n">pubtools</span><span class="o">.</span><span class="n">Pub</span><span class="p">,</span> <span class="nb">type</span><span class="p">[</span><span class="n">TestIO</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare the `HydPy-H-Lahn` project on disk and in RAM.</span>

<span class="sd">    Function |prepare_full_example_2| is an extensions of function</span>
<span class="sd">    |prepare_full_example_1|.  Besides preparing the project data of the `HydPy-H-Lahn`</span>
<span class="sd">    example project, it performs all necessary steps to start a simulation run.</span>
<span class="sd">    Therefore, it returns a readily prepared |HydPy| instance, as well as, for</span>
<span class="sd">    convenience, module |pub| and class |TestIO|:</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_full_example_2</span>
<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2()</span>
<span class="sd">    &gt;&gt;&gt; hp.nodes</span>
<span class="sd">    Nodes(&quot;dill_assl&quot;, &quot;lahn_kalk&quot;, &quot;lahn_leun&quot;, &quot;lahn_marb&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements</span>
<span class="sd">    Elements(&quot;land_dill_assl&quot;, &quot;land_lahn_kalk&quot;, &quot;land_lahn_leun&quot;,</span>
<span class="sd">             &quot;land_lahn_marb&quot;, &quot;stream_dill_assl_lahn_leun&quot;,</span>
<span class="sd">             &quot;stream_lahn_leun_lahn_kalk&quot;, &quot;stream_lahn_marb_lahn_leun&quot;)</span>
<span class="sd">    &gt;&gt;&gt; pub.timegrids</span>
<span class="sd">    Timegrids(&quot;1996-01-01 00:00:00&quot;,</span>
<span class="sd">              &quot;1996-01-05 00:00:00&quot;,</span>
<span class="sd">              &quot;1d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import classname</span>
<span class="sd">    &gt;&gt;&gt; classname(TestIO)</span>
<span class="sd">    &#39;TestIO&#39;</span>

<span class="sd">    Function |prepare_full_example_2| is primarily thought for testing and thus does</span>
<span class="sd">    not allow for many configurations except changing the end date of the</span>
<span class="sd">    initialisation period:</span>

<span class="sd">    &gt;&gt;&gt; hp, pub, TestIO = prepare_full_example_2(lastdate=&quot;1996-01-02&quot;)</span>
<span class="sd">    &gt;&gt;&gt; pub.timegrids</span>
<span class="sd">    Timegrids(&quot;1996-01-01 00:00:00&quot;,</span>
<span class="sd">              &quot;1996-01-02 00:00:00&quot;,</span>
<span class="sd">              &quot;1d&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prepare_full_example_1</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">TestIO</span><span class="p">():</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">(</span><span class="s2">&quot;HydPy-H-Lahn&quot;</span><span class="p">)</span>
        <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span> <span class="o">=</span> <span class="s2">&quot;1996-01-01&quot;</span><span class="p">,</span> <span class="n">lastdate</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span>
        <span class="n">hp</span><span class="o">.</span><span class="n">prepare_everything</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">hp</span><span class="p">,</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="p">,</span> <span class="n">TestIO</span></div>



<div class="viewcode-block" id="prepare_interpolation_example">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.prepare_interpolation_example">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_interpolation_example</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">,</span> <span class="n">pubtools</span><span class="o">.</span><span class="n">Pub</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare an example project that combines a |conv_nn| model and the</span>
<span class="sd">    input/output node mechanism to interpolate precipitation.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_interpolation_example</span>
<span class="sd">    &gt;&gt;&gt; hp, pub = prepare_interpolation_example()</span>
<span class="sd">    &gt;&gt;&gt; hp.print_networkproperties()</span>
<span class="sd">    Number of nodes: 7</span>
<span class="sd">    Number of elements: 4</span>
<span class="sd">    Number of end nodes: 1</span>
<span class="sd">    Number of distinct networks: 1</span>
<span class="sd">    Applied node variables: P (4) and Q (3)</span>
<span class="sd">    Applied model types: conv_nn (1), dummy_node2node (1), and gland_gr4 (2)</span>

<span class="sd">    The example project consists of two nodes that receive the original precipitation</span>
<span class="sd">    series (`in1` and `in2`), an interpolation element (`conv`) that handles the</span>
<span class="sd">    |conv_nn| model instance, and two nodes (`out1` and `out2`) that pass the</span>
<span class="sd">    interpolated precipitation to two elements (`gr4_1` and `gr4_2`) that handle</span>
<span class="sd">    |gland_gr4| model instances.</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.conv</span>
<span class="sd">    Element(&quot;conv&quot;,</span>
<span class="sd">            inlets=[&quot;in1&quot;, &quot;in2&quot;],</span>
<span class="sd">            outlets=[&quot;out1&quot;, &quot;out2&quot;])</span>

<span class="sd">    The |gland_gr4| models pass their outflows to the nodes `q1` and `q2`, which are</span>
<span class="sd">    then combined by an application model of type |dummy_node2node| handled by element</span>
<span class="sd">    `dummy`:</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.gr4_1</span>
<span class="sd">    Element(&quot;gr4_1&quot;,</span>
<span class="sd">            outlets=&quot;q1&quot;,</span>
<span class="sd">            inputs=&quot;out1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.gr4_2</span>
<span class="sd">    Element(&quot;gr4_2&quot;,</span>
<span class="sd">            outlets=&quot;q2&quot;,</span>
<span class="sd">            inputs=&quot;out2&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.dummy</span>
<span class="sd">    Element(&quot;dummy&quot;,</span>
<span class="sd">            inlets=[&quot;q1&quot;, &quot;q2&quot;],</span>
<span class="sd">            outlets=&quot;q12&quot;)</span>

<span class="sd">    `in1` and `in2` work with different deploy modes:</span>

<span class="sd">    &gt;&gt;&gt; hp.nodes.in1.deploymode</span>
<span class="sd">    &#39;obs&#39;</span>
<span class="sd">    &gt;&gt;&gt; hp.nodes.in2.deploymode</span>
<span class="sd">    &#39;oldsim&#39;</span>

<span class="sd">    The simulation spans only three days:</span>

<span class="sd">    &gt;&gt;&gt; pub.timegrids</span>
<span class="sd">    Timegrids(&quot;2000-01-01 00:00:00&quot;,</span>
<span class="sd">              &quot;2000-01-04 00:00:00&quot;,</span>
<span class="sd">              &quot;1d&quot;)</span>

<span class="sd">    The simulation results:</span>

<span class="sd">    &gt;&gt;&gt; hp.simulate()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import print_vector</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.in1.sequences.obs.series)</span>
<span class="sd">    10.0, 20.0, 30.0</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.in2.sequences.sim.series)</span>
<span class="sd">    40.0, 50.0, 60.0</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.out1.sequences.sim.series)</span>
<span class="sd">    10.0, 20.0, 30.0</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.out2.sequences.sim.series)</span>
<span class="sd">    40.0, 50.0, 60.0</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.q1.sequences.sim.series)</span>
<span class="sd">    0.287977, 0.267212, 0.336692</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.q2.sequences.sim.series)</span>
<span class="sd">    0.565738, 0.597421, 0.700953</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.q12.sequences.sim.series)</span>
<span class="sd">    0.853716, 0.864633, 1.037645</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
    <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">checkprojectstructure</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">(</span><span class="s2">&quot;InterpolationExample&quot;</span><span class="p">)</span>
    <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span> <span class="o">=</span> <span class="s2">&quot;2000-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2000-01-04&quot;</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span>

    <span class="n">n_in1</span><span class="p">,</span> <span class="n">n_in2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span><span class="s2">&quot;in1&quot;</span><span class="p">,</span> <span class="s2">&quot;in2&quot;</span><span class="p">,</span> <span class="n">defaultvariable</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
    <span class="n">n_out1</span><span class="p">,</span> <span class="n">n_out2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span><span class="s2">&quot;out1&quot;</span><span class="p">,</span> <span class="s2">&quot;out2&quot;</span><span class="p">,</span> <span class="n">defaultvariable</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
    <span class="n">n_q1</span><span class="p">,</span> <span class="n">n_q12</span><span class="p">,</span> <span class="n">n_q2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span><span class="s2">&quot;q1&quot;</span><span class="p">,</span> <span class="s2">&quot;q12&quot;</span><span class="p">,</span> <span class="s2">&quot;q2&quot;</span><span class="p">)</span>
    <span class="n">element_conv</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;conv&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="p">(</span><span class="n">n_in1</span><span class="p">,</span> <span class="n">n_in2</span><span class="p">),</span> <span class="n">outlets</span><span class="o">=</span><span class="p">(</span><span class="n">n_out1</span><span class="p">,</span> <span class="n">n_out2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">e_gr4_1</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;gr4_1&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">n_out1</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">n_q1</span><span class="p">)</span>
    <span class="n">e_gr4_2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;gr4_2&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">n_out2</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">n_q2</span><span class="p">)</span>
    <span class="n">e_dummy</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;dummy&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="p">(</span><span class="n">n_q1</span><span class="p">,</span> <span class="n">n_q2</span><span class="p">),</span> <span class="n">outlets</span><span class="o">=</span><span class="n">n_q12</span><span class="p">)</span>

    <span class="n">convmodel</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;conv_nn&quot;</span><span class="p">)</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">convmodel</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
    <span class="n">control</span><span class="o">.</span><span class="n">inputcoordinates</span><span class="p">(</span><span class="n">in1</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span> <span class="n">in2</span><span class="o">=</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">))</span>
    <span class="n">control</span><span class="o">.</span><span class="n">outputcoordinates</span><span class="p">(</span><span class="n">out1</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> <span class="n">out2</span><span class="o">=</span><span class="p">(</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">))</span>
    <span class="n">control</span><span class="o">.</span><span class="n">maxnmbinputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">gr4models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">gr4model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;gland_gr4&quot;</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">gr4model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="s2">&quot;1d&quot;</span><span class="p">):</span>
            <span class="n">control</span><span class="o">.</span><span class="n">area</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">imax</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x1</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x3</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">gr4model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span>
        <span class="n">states</span><span class="o">.</span><span class="n">i</span><span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">imax</span><span class="p">)</span>
        <span class="n">states</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">states</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">x3</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">gr4model</span><span class="o">.</span><span class="n">add_petmodel_v1</span><span class="p">(</span><span class="s2">&quot;evap_ret_io&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">evapmodel</span><span class="p">:</span>
            <span class="n">evapmodel</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">evapotranspirationfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">gr4models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gr4model</span><span class="p">)</span>

    <span class="n">dummymodel</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;dummy_node2node&quot;</span><span class="p">)</span>

    <span class="n">element_conv</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">convmodel</span>
    <span class="n">e_gr4_1</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">gr4models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_gr4_2</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">gr4models</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">e_dummy</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dummymodel</span>

    <span class="n">hp</span><span class="o">.</span><span class="n">update_devices</span><span class="p">(</span>
        <span class="n">nodes</span><span class="o">=</span><span class="p">(</span><span class="n">n_in1</span><span class="p">,</span> <span class="n">n_in2</span><span class="p">,</span> <span class="n">n_out1</span><span class="p">,</span> <span class="n">n_out2</span><span class="p">,</span> <span class="n">n_q1</span><span class="p">,</span> <span class="n">n_q2</span><span class="p">,</span> <span class="n">n_q12</span><span class="p">),</span>
        <span class="n">elements</span><span class="o">=</span><span class="p">(</span><span class="n">element_conv</span><span class="p">,</span> <span class="n">e_gr4_1</span><span class="p">,</span> <span class="n">e_gr4_2</span><span class="p">,</span> <span class="n">e_dummy</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">hp</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>

    <span class="n">hp</span><span class="o">.</span><span class="n">prepare_allseries</span><span class="p">()</span>
    <span class="n">n_in1</span><span class="o">.</span><span class="n">deploymode</span> <span class="o">=</span> <span class="s2">&quot;obs&quot;</span>
    <span class="n">n_in1</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">30.0</span>
    <span class="n">n_in2</span><span class="o">.</span><span class="n">deploymode</span> <span class="o">=</span> <span class="s2">&quot;oldsim&quot;</span>
    <span class="n">n_in2</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mf">40.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">60.0</span>
    <span class="n">e_gr4_1</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">petmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">referenceevapotranspiration</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">e_gr4_2</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">petmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">referenceevapotranspiration</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">hp</span><span class="p">,</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span></div>



<div class="viewcode-block" id="prepare_receiver_example">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.prepare_receiver_example">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_receiver_example</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">,</span> <span class="n">pubtools</span><span class="o">.</span><span class="n">Pub</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare an example project that combines a |dam_v001| model and the receiver</span>
<span class="sd">    node mechanism to simulate the interaction between the controlled water release of</span>
<span class="sd">    a dam and the discharge at a remote downstream gauge.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_receiver_example</span>
<span class="sd">    &gt;&gt;&gt; hp, pub = prepare_receiver_example()</span>
<span class="sd">    &gt;&gt;&gt; hp.print_networkproperties()</span>
<span class="sd">    Number of nodes: 5</span>
<span class="sd">    Number of elements: 7</span>
<span class="sd">    Number of end nodes: 1</span>
<span class="sd">    Number of distinct networks: 1</span>
<span class="sd">    Applied node variables: Q (5)</span>
<span class="sd">    Applied model types: dam_v001 (1), dummy_node2node (3), and gland_gr4 (3)</span>

<span class="sd">    The runoff generation is left to three |gland_gr4| model instances, handled by the</span>
<span class="sd">    elements `l1`, `l2`, and `l3`:</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.l1</span>
<span class="sd">    Element(&quot;l1&quot;,</span>
<span class="sd">            outlets=&quot;n1a&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.l2</span>
<span class="sd">    Element(&quot;l2&quot;,</span>
<span class="sd">            outlets=&quot;n2&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.l3</span>
<span class="sd">    Element(&quot;l3&quot;,</span>
<span class="sd">            outlets=&quot;n3&quot;)</span>

<span class="sd">    The runoff generated by `l1` flows into a dam, represented by a |dam_v001| model</span>
<span class="sd">    instance handled by element `d`:</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.d</span>
<span class="sd">    Element(&quot;d&quot;,</span>
<span class="sd">            inlets=&quot;n1a&quot;,</span>
<span class="sd">            outlets=&quot;n1b&quot;,</span>
<span class="sd">            receivers=&quot;n2&quot;)</span>

<span class="sd">    The uncontrolled outflow of `l2` and `l2` and the controlled water release of `d`</span>
<span class="sd">    reach a channel consisting of three segments, represented by individual</span>
<span class="sd">    |dummy_node2node| model instances handled by elements `s12`, `s23`, and `s34`:</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.s12</span>
<span class="sd">    Element(&quot;s12&quot;,</span>
<span class="sd">            inlets=&quot;n1b&quot;,</span>
<span class="sd">            outlets=&quot;n2&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.s23</span>
<span class="sd">    Element(&quot;s23&quot;,</span>
<span class="sd">            inlets=&quot;n2&quot;,</span>
<span class="sd">            outlets=&quot;n3&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.s34</span>
<span class="sd">    Element(&quot;s34&quot;,</span>
<span class="sd">            inlets=&quot;n3&quot;,</span>
<span class="sd">            outlets=&quot;n4&quot;)</span>

<span class="sd">    Node `n2` is responsible for routing water further downstream and informing the dam</span>
<span class="sd">    about the current discharge via the receiver mechanism, so that it can adjust its</span>
<span class="sd">    release to prevent severe low-flow situations.</span>

<span class="sd">    The simulation results:</span>

<span class="sd">    &gt;&gt;&gt; hp.simulate()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import print_vector</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.n1a.sequences.sim.series)</span>
<span class="sd">    2.324939, 2.0521, 1.834626, 1.657529, 1.510731, 1.387219</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.n1b.sequences.sim.series)</span>
<span class="sd">    0.0, 0.0, 0.0, 0.165374, 0.342471, 0.489269</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.n2.sequences.sim.series)</span>
<span class="sd">    2.324939, 2.0521, 1.834626, 1.822902, 1.853202, 1.876488</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.n3.sequences.sim.series)</span>
<span class="sd">    4.649878, 4.1042, 3.669253, 3.480431, 3.363932, 3.263707</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.n4.sequences.sim.series)</span>
<span class="sd">    4.649878, 4.1042, 3.669253, 3.480431, 3.363932, 3.263707</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
    <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">checkprojectstructure</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">(</span><span class="s2">&quot;ReceiverExample&quot;</span><span class="p">)</span>
    <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span> <span class="o">=</span> <span class="s2">&quot;2000-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2000-01-07&quot;</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span>

    <span class="n">n1a</span><span class="p">,</span> <span class="n">n1b</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span><span class="s2">&quot;n1a&quot;</span><span class="p">,</span> <span class="s2">&quot;n1b&quot;</span><span class="p">,</span> <span class="s2">&quot;n2&quot;</span><span class="p">,</span> <span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="s2">&quot;n4&quot;</span><span class="p">)</span>
    <span class="n">l1_</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;l1&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="s2">&quot;n1a&quot;</span><span class="p">)</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;l2&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="s2">&quot;n2&quot;</span><span class="p">)</span>
    <span class="n">l3</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;l3&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="s2">&quot;n1a&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="s2">&quot;n1b&quot;</span><span class="p">,</span> <span class="n">receivers</span><span class="o">=</span><span class="s2">&quot;n2&quot;</span><span class="p">)</span>
    <span class="n">s12</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;s12&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="s2">&quot;n1b&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="s2">&quot;n2&quot;</span><span class="p">)</span>
    <span class="n">s23</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;s23&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="s2">&quot;n2&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">)</span>
    <span class="n">s34</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;s34&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="s2">&quot;n4&quot;</span><span class="p">)</span>

    <span class="n">lmodels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">lmodel</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;gland_gr4&quot;</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">lmodel</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="s2">&quot;1d&quot;</span><span class="p">):</span>
            <span class="n">control</span><span class="o">.</span><span class="n">area</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">imax</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x1</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x3</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">lmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span>
        <span class="n">states</span><span class="o">.</span><span class="n">i</span><span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">imax</span><span class="p">)</span>
        <span class="n">states</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">control</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">states</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">control</span><span class="o">.</span><span class="n">x3</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lmodel</span><span class="o">.</span><span class="n">add_petmodel_v1</span><span class="p">(</span><span class="s2">&quot;evap_ret_io&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">evapmodel</span><span class="p">:</span>
            <span class="n">evapmodel</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">evapotranspirationfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">lmodels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lmodel</span><span class="p">)</span>

    <span class="n">dmodel</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;dam_v001&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="s2">&quot;1d&quot;</span><span class="p">):</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">dmodel</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
        <span class="n">from_data</span> <span class="o">=</span> <span class="n">ppolytools</span><span class="o">.</span><span class="n">PPoly</span><span class="o">.</span><span class="n">from_data</span>
        <span class="n">control</span><span class="o">.</span><span class="n">watervolume2waterlevel</span><span class="p">(</span><span class="n">from_data</span><span class="p">(</span><span class="n">xs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">ys</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]))</span>
        <span class="n">control</span><span class="o">.</span><span class="n">waterlevel2flooddischarge</span><span class="p">(</span><span class="n">from_data</span><span class="p">(</span><span class="n">xs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">ys</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]))</span>
        <span class="n">control</span><span class="o">.</span><span class="n">catchmentarea</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">surfacearea</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">correctionprecipitation</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">correctionevaporation</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">weightevaporation</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">thresholdevaporation</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">toleranceevaporation</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">nmblogentries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">remotedischargeminimum</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">remotedischargesafety</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">neardischargeminimumthreshold</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">neardischargeminimumtolerance</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">waterlevelminimumthreshold</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">waterlevelminimumtolerance</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">restricttargetedrelease</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">dmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span>
        <span class="n">states</span><span class="o">.</span><span class="n">watervolume</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">dmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span>
        <span class="n">logs</span><span class="o">.</span><span class="n">loggedadjustedevaporation</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">logs</span><span class="o">.</span><span class="n">loggedtotalremotedischarge</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">logs</span><span class="o">.</span><span class="n">loggedoutflow</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">l1_</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">lmodels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">l2</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">lmodels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">l3</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">lmodels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">d</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dmodel</span>
    <span class="n">s12</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;dummy_node2node&quot;</span><span class="p">)</span>
    <span class="n">s23</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;dummy_node2node&quot;</span><span class="p">)</span>
    <span class="n">s34</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;dummy_node2node&quot;</span><span class="p">)</span>

    <span class="n">hp</span><span class="o">.</span><span class="n">update_devices</span><span class="p">(</span>
        <span class="n">nodes</span><span class="o">=</span><span class="p">(</span><span class="n">n1a</span><span class="p">,</span> <span class="n">n1b</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">),</span> <span class="n">elements</span><span class="o">=</span><span class="p">(</span><span class="n">l1_</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span> <span class="n">s23</span><span class="p">,</span> <span class="n">s34</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">hp</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>

    <span class="n">hp</span><span class="o">.</span><span class="n">prepare_allseries</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">lmodel</span> <span class="ow">in</span> <span class="n">lmodels</span><span class="p">:</span>
        <span class="n">lmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">lmodel</span><span class="o">.</span><span class="n">petmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">referenceevapotranspiration</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">hp</span><span class="p">,</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span></div>



<div class="viewcode-block" id="prepare_collective_example">
<a class="viewcode-back" href="../../../testtools.html#hydpy.core.testtools.prepare_collective_example">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_collective_example</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">,</span> <span class="n">pubtools</span><span class="o">.</span><span class="n">Pub</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare a complex example project that consists of multiple |sw1d_channel|</span>
<span class="sd">    models that are combined into a |sw1d_network| model during simulation via the</span>
<span class="sd">    :ref:`collective` approach and involves feedback effects over short and long</span>
<span class="sd">    distances via the receiver mechanism.</span>

<span class="sd">    &gt;&gt;&gt; from hydpy.core.testtools import prepare_collective_example</span>
<span class="sd">    &gt;&gt;&gt; hp, pub = prepare_collective_example()</span>
<span class="sd">    &gt;&gt;&gt; hp.print_networkproperties()</span>
<span class="sd">    Number of nodes: 16</span>
<span class="sd">    Number of elements: 11</span>
<span class="sd">    Number of end nodes: 6</span>
<span class="sd">    Number of distinct networks: 0</span>
<span class="sd">    Applied node variables: Q (3), latq (3), longq (5), owl (3), and rwl (2)</span>
<span class="sd">    Applied model types: dam_sluice (3), gland_gr4 (5), and sw1d_channel (3)</span>

<span class="sd">    The &quot;SW1D&quot; collective consists of three channel segments.  The elements `c1` and</span>
<span class="sd">    `c2` rely on &quot;normal&quot; routing models of type |sw1d_lias|.  Both are directly</span>
<span class="sd">    connected to the outlet reach `c3`, which relies on a |sw1d_gate_out| model</span>
<span class="sd">    instance to use the water levels provided by node `out_c3_s1` as a lower boundary</span>
<span class="sd">    condition for solving the shallow water equations:</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.c1</span>
<span class="sd">    Element(&quot;c1&quot;,</span>
<span class="sd">            collective=&quot;SW1D&quot;,</span>
<span class="sd">            inlets=[&quot;g12_c1&quot;, &quot;s1_c1&quot;],</span>
<span class="sd">            outlets=&quot;c1_c3&quot;,</span>
<span class="sd">            senders=&quot;c1_s1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.c2</span>
<span class="sd">    Element(&quot;c2&quot;,</span>
<span class="sd">            collective=&quot;SW1D&quot;,</span>
<span class="sd">            inlets=[&quot;g22_c2&quot;, &quot;s2_c2&quot;],</span>
<span class="sd">            outlets=&quot;c2_c3&quot;,</span>
<span class="sd">            senders=&quot;c2_s2&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.c3</span>
<span class="sd">    Element(&quot;c3&quot;,</span>
<span class="sd">            collective=&quot;SW1D&quot;,</span>
<span class="sd">            inlets=[&quot;c1_c3&quot;, &quot;c2_c3&quot;, &quot;s3_c3&quot;],</span>
<span class="sd">            outlets=&quot;c3_out&quot;,</span>
<span class="sd">            receivers=&quot;out_c3_s1&quot;,</span>
<span class="sd">            senders=&quot;c3_s3&quot;)</span>

<span class="sd">    `c1` and `c2` receive uncontrolled &quot;longitudinal&quot; inflow generated by |gland_gr4|</span>
<span class="sd">    models handled by the elements `g12` and `g22`:</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.g12</span>
<span class="sd">    Element(&quot;g12&quot;,</span>
<span class="sd">            outlets=&quot;g12_c1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.g22</span>
<span class="sd">    Element(&quot;g22&quot;,</span>
<span class="sd">            outlets=&quot;g22_c2&quot;)</span>

<span class="sd">    Besides this, all channel segments receive the water released by &quot;laterally&quot;</span>
<span class="sd">    connected |dam_sluice| model instances handled by the elements `p1`, `p2`, and</span>
<span class="sd">    `p3`.  Each sluice model requires the water level of its connected channel model to</span>
<span class="sd">    determine the current water level gradient and so its current water release, which</span>
<span class="sd">    is made available via the nodes `c1_s1`, `c2_s2`, and `c3_s3`, respectively.</span>
<span class="sd">    Additionally, the sluice model of element `s1` receives the lower boundary</span>
<span class="sd">    water level provided by node `out_c3_s1`, which allows to stop the release of water</span>
<span class="sd">    as soon as a critical outer water level is exceeded:</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.s1</span>
<span class="sd">    Element(&quot;s1&quot;,</span>
<span class="sd">            inlets=&quot;g11_s1&quot;,</span>
<span class="sd">            outlets=&quot;s1_c1&quot;,</span>
<span class="sd">            receivers=[&quot;c1_s1&quot;, &quot;out_c3_s1&quot;])</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.s2</span>
<span class="sd">    Element(&quot;s2&quot;,</span>
<span class="sd">            inlets=&quot;g21_s2&quot;,</span>
<span class="sd">            outlets=&quot;s2_c2&quot;,</span>
<span class="sd">            receivers=[&quot;c2_s2&quot;, &quot;no_s1&quot;])</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.s3</span>
<span class="sd">    Element(&quot;s3&quot;,</span>
<span class="sd">            inlets=&quot;g31_s3&quot;,</span>
<span class="sd">            outlets=&quot;s3_c3&quot;,</span>
<span class="sd">            receivers=[&quot;c3_s3&quot;, &quot;no_s1&quot;])</span>

<span class="sd">    The inflow of `s1`, `s2`, and `s3` stems also from the |gland_gr4| models, which</span>
<span class="sd">    are handled by the elements `g11`, `g21`, and `g31`:</span>

<span class="sd">    &gt;&gt;&gt; hp.elements.g11</span>
<span class="sd">    Element(&quot;g11&quot;,</span>
<span class="sd">            outlets=&quot;g11_s1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.g21</span>
<span class="sd">    Element(&quot;g21&quot;,</span>
<span class="sd">            outlets=&quot;g21_s2&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hp.elements.g31</span>
<span class="sd">    Element(&quot;g31&quot;,</span>
<span class="sd">            outlets=&quot;g31_s3&quot;)</span>

<span class="sd">    The simulation results:</span>

<span class="sd">    &gt;&gt;&gt; hp.simulate()</span>
<span class="sd">    &gt;&gt;&gt; from hydpy import print_vector</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.g11_s1.sequences.sim.series)</span>
<span class="sd">    0.232494, 0.20521, 0.183463, 0.165753, 0.151073, 0.138722</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.g21_s2.sequences.sim.series)</span>
<span class="sd">    0.232494, 0.20521, 0.183463, 0.165753, 0.151073, 0.138722</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.g31_s3.sequences.sim.series)</span>
<span class="sd">    0.232494, 0.20521, 0.183463, 0.165753, 0.151073, 0.138722</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.g12_c1.sequences.sim.series)</span>
<span class="sd">    0.232494, 0.20521, 0.183463, 0.165753, 0.151073, 0.138722</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.g22_c2.sequences.sim.series)</span>
<span class="sd">    0.232494, 0.20521, 0.183463, 0.165753, 0.151073, 0.138722</span>

<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.s1_c1.sequences.sim.series)</span>
<span class="sd">    0.20014, 0.081896, 0.075122, 0.068673, 0.0, 0.0</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.s2_c2.sequences.sim.series)</span>
<span class="sd">    0.20014, 0.081896, 0.075122, 0.068673, 0.062057, 0.05637</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.s3_c3.sequences.sim.series)</span>
<span class="sd">    0.20014, 0.08195, 0.07516, 0.0687, 0.062074, 0.056383</span>

<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.c1_c3.sequences.sim.series)</span>
<span class="sd">    0.213689, 0.197114, 0.173684, 0.148542, 0.07705, 0.03247</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.c2_c3.sequences.sim.series)</span>
<span class="sd">    0.213689, 0.197114, 0.173684, 0.148542, 0.138743, 0.088823</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.c3_out.sequences.sim.series)</span>
<span class="sd">    0.409196, 0.386017, 0.337494, 0.279784, 0.203433, 0.071322</span>

<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.c1_s1.sequences.sim.series)</span>
<span class="sd">    2.189168, 2.266922, 2.340276, 2.41448, 2.478436, 2.570237</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.c2_s2.sequences.sim.series)</span>
<span class="sd">    2.189168, 2.266922, 2.340276, 2.41448, 2.47875, 2.570566</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.c3_s3.sequences.sim.series)</span>
<span class="sd">    2.188631, 2.266529, 2.339998, 2.414303, 2.478613, 2.570503</span>

<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.no_s1.sequences.sim.series)</span>
<span class="sd">    0.0, 0.0, 0.0, 0.0, 0.0, 0.0</span>
<span class="sd">    &gt;&gt;&gt; print_vector(hp.nodes.out_c3_s1.sequences.sim.series)</span>
<span class="sd">    1.5, 1.7, 1.9, 2.1, 2.3, 2.5</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=too-many-statements</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">hydpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">aliases</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>

    <span class="n">devicetools</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>
    <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="o">.</span><span class="n">clear_all</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">checkprojectstructure</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">hydpytools</span><span class="o">.</span><span class="n">HydPy</span><span class="p">(</span><span class="s2">&quot;CollectiveExample&quot;</span><span class="p">)</span>
    <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">timegrids</span> <span class="o">=</span> <span class="s2">&quot;2000-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2000-01-07&quot;</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span>

    <span class="n">longq</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">FusedVariable</span><span class="p">(</span>
        <span class="s2">&quot;longq&quot;</span><span class="p">,</span>
        <span class="n">aliases</span><span class="o">.</span><span class="n">gland_outlets_Q</span><span class="p">,</span>
        <span class="n">aliases</span><span class="o">.</span><span class="n">sw1d_inlets_LongQ</span><span class="p">,</span>
        <span class="n">aliases</span><span class="o">.</span><span class="n">sw1d_outlets_LongQ</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">latq</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">FusedVariable</span><span class="p">(</span>
        <span class="s2">&quot;latq&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">.</span><span class="n">dam_outlets_Q</span><span class="p">,</span> <span class="n">aliases</span><span class="o">.</span><span class="n">sw1d_inlets_LatQ</span>
    <span class="p">)</span>
    <span class="n">owl</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">FusedVariable</span><span class="p">(</span>
        <span class="s2">&quot;owl&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">.</span><span class="n">sw1d_senders_WaterLevel</span><span class="p">,</span> <span class="n">aliases</span><span class="o">.</span><span class="n">dam_receivers_OWL</span>
    <span class="p">)</span>
    <span class="n">rwl</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">FusedVariable</span><span class="p">(</span>
        <span class="s2">&quot;rwl&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">.</span><span class="n">sw1d_inlets_WaterLevel</span><span class="p">,</span> <span class="n">aliases</span><span class="o">.</span><span class="n">dam_receivers_RWL</span>
    <span class="p">)</span>

    <span class="n">g11_s1</span><span class="p">,</span> <span class="n">g21_s2</span><span class="p">,</span> <span class="n">g31_s3</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span><span class="s2">&quot;g11_s1&quot;</span><span class="p">,</span> <span class="s2">&quot;g21_s2&quot;</span><span class="p">,</span> <span class="s2">&quot;g31_s3&quot;</span><span class="p">)</span>
    <span class="n">g12_c1</span><span class="p">,</span> <span class="n">g22_c2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span><span class="s2">&quot;g12_c1&quot;</span><span class="p">,</span> <span class="s2">&quot;g22_c2&quot;</span><span class="p">,</span> <span class="n">defaultvariable</span><span class="o">=</span><span class="n">longq</span><span class="p">)</span>
    <span class="n">s1_c1</span><span class="p">,</span> <span class="n">s2_c2</span><span class="p">,</span> <span class="n">s3_c3</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span>
        <span class="s2">&quot;s1_c1&quot;</span><span class="p">,</span> <span class="s2">&quot;s2_c2&quot;</span><span class="p">,</span> <span class="s2">&quot;s3_c3&quot;</span><span class="p">,</span> <span class="n">defaultvariable</span><span class="o">=</span><span class="n">latq</span>
    <span class="p">)</span>
    <span class="n">c1_c3</span><span class="p">,</span> <span class="n">c2_c3</span><span class="p">,</span> <span class="n">c3_out</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span>
        <span class="s2">&quot;c1_c3&quot;</span><span class="p">,</span> <span class="s2">&quot;c2_c3&quot;</span><span class="p">,</span> <span class="s2">&quot;c3_out&quot;</span><span class="p">,</span> <span class="n">defaultvariable</span><span class="o">=</span><span class="n">longq</span>
    <span class="p">)</span>
    <span class="n">c1_s1</span><span class="p">,</span> <span class="n">c2_s2</span><span class="p">,</span> <span class="n">c3_s3</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span>
        <span class="s2">&quot;c1_s1&quot;</span><span class="p">,</span> <span class="s2">&quot;c2_s2&quot;</span><span class="p">,</span> <span class="s2">&quot;c3_s3&quot;</span><span class="p">,</span> <span class="n">defaultvariable</span><span class="o">=</span><span class="n">owl</span>
    <span class="p">)</span>
    <span class="n">no_s1</span><span class="p">,</span> <span class="n">out_c3_s1</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Nodes</span><span class="p">(</span><span class="s2">&quot;no_s1&quot;</span><span class="p">,</span> <span class="s2">&quot;out_c3_s1&quot;</span><span class="p">,</span> <span class="n">defaultvariable</span><span class="o">=</span><span class="n">rwl</span><span class="p">)</span>

    <span class="n">g11</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;g11&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">g11_s1</span><span class="p">)</span>
    <span class="n">g12</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;g12&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">g12_c1</span><span class="p">)</span>
    <span class="n">g21</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;g21&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">g21_s2</span><span class="p">)</span>
    <span class="n">g22</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;g22&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">g22_c2</span><span class="p">)</span>
    <span class="n">g31</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;g31&quot;</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">g31_s3</span><span class="p">)</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;s1&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="n">g11_s1</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">s1_c1</span><span class="p">,</span> <span class="n">receivers</span><span class="o">=</span><span class="p">(</span><span class="n">c1_s1</span><span class="p">,</span> <span class="n">out_c3_s1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;s2&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="n">g21_s2</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">s2_c2</span><span class="p">,</span> <span class="n">receivers</span><span class="o">=</span><span class="p">(</span><span class="n">c2_s2</span><span class="p">,</span> <span class="n">no_s1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="n">g31_s3</span><span class="p">,</span> <span class="n">outlets</span><span class="o">=</span><span class="n">s3_c3</span><span class="p">,</span> <span class="n">receivers</span><span class="o">=</span><span class="p">(</span><span class="n">c3_s3</span><span class="p">,</span> <span class="n">no_s1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="p">(</span><span class="n">g12_c1</span><span class="p">,</span> <span class="n">s1_c1</span><span class="p">),</span> <span class="n">outlets</span><span class="o">=</span><span class="n">c1_c3</span><span class="p">,</span> <span class="n">senders</span><span class="o">=</span><span class="n">c1_s1</span><span class="p">,</span> <span class="n">collective</span><span class="o">=</span><span class="s2">&quot;SW1D&quot;</span>
    <span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="n">inlets</span><span class="o">=</span><span class="p">(</span><span class="n">g22_c2</span><span class="p">,</span> <span class="n">s2_c2</span><span class="p">),</span> <span class="n">outlets</span><span class="o">=</span><span class="n">c2_c3</span><span class="p">,</span> <span class="n">senders</span><span class="o">=</span><span class="n">c2_s2</span><span class="p">,</span> <span class="n">collective</span><span class="o">=</span><span class="s2">&quot;SW1D&quot;</span>
    <span class="p">)</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="n">devicetools</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;c3&quot;</span><span class="p">,</span>
        <span class="n">inlets</span><span class="o">=</span><span class="p">(</span><span class="n">s3_c3</span><span class="p">,</span> <span class="n">c1_c3</span><span class="p">,</span> <span class="n">c2_c3</span><span class="p">),</span>
        <span class="n">outlets</span><span class="o">=</span><span class="n">c3_out</span><span class="p">,</span>
        <span class="n">receivers</span><span class="o">=</span><span class="n">out_c3_s1</span><span class="p">,</span>
        <span class="n">senders</span><span class="o">=</span><span class="n">c3_s3</span><span class="p">,</span>
        <span class="n">collective</span><span class="o">=</span><span class="s2">&quot;SW1D&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">gr_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">gr_model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;gland_gr4&quot;</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">gr_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="s2">&quot;1d&quot;</span><span class="p">):</span>
            <span class="n">control</span><span class="o">.</span><span class="n">area</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">imax</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x1</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">x3</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">gr_model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span>
        <span class="n">states</span><span class="o">.</span><span class="n">i</span><span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">imax</span><span class="p">)</span>
        <span class="n">states</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">control</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">states</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">control</span><span class="o">.</span><span class="n">x3</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">gr_model</span><span class="o">.</span><span class="n">add_petmodel_v1</span><span class="p">(</span><span class="s2">&quot;evap_ret_io&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">evap_model</span><span class="p">:</span>
            <span class="n">evap_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">evapotranspirationfactor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">gr_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gr_model</span><span class="p">)</span>

    <span class="n">sluice_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">sluice_model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;dam_sluice&quot;</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">sluice_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
        <span class="k">with</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parameterstep</span><span class="p">(</span><span class="s2">&quot;1d&quot;</span><span class="p">):</span>
            <span class="n">control</span><span class="o">.</span><span class="n">surfacearea</span><span class="p">(</span><span class="mf">1.44</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">catchmentarea</span><span class="p">(</span><span class="mf">86.4</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">watervolume2waterlevel</span><span class="p">(</span>
                <span class="n">ppolytools</span><span class="o">.</span><span class="n">PPoly</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">xs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">ys</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">remotewaterlevelmaximumthreshold</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">remotewaterlevelmaximumtolerance</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">correctionprecipitation</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">correctionevaporation</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">weightevaporation</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">thresholdevaporation</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">toleranceevaporation</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">crestlevel</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">waterleveldifference2maxfreedischarge</span><span class="p">(</span>
                <span class="n">ppolytools</span><span class="o">.</span><span class="n">PPoly</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">xs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">ys</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">crestleveltolerance</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">dischargetolerance</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">sluice_model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">watervolume</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">sluice_model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">logs</span>
        <span class="n">logs</span><span class="o">.</span><span class="n">loggedadjustedevaporation</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">logs</span><span class="o">.</span><span class="n">loggedouterwaterlevel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">logs</span><span class="o">.</span><span class="n">loggedremotewaterlevel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">sluice_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sluice_model</span><span class="p">)</span>

    <span class="n">channel_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">channel_model</span> <span class="o">=</span> <span class="n">importtools</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="s2">&quot;sw1d_channel&quot;</span><span class="p">)</span>
        <span class="n">channel_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">nmbsegments</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">channel_model</span><span class="o">.</span><span class="n">add_storagemodel_v1</span><span class="p">(</span>
            <span class="s2">&quot;sw1d_storage&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">storage_model</span><span class="p">:</span>
            <span class="n">storage_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
            <span class="n">storage_model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">watervolume</span><span class="p">(</span><span class="mf">200.0</span><span class="p">)</span>
        <span class="n">channel_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel_model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">channel_model</span> <span class="o">=</span> <span class="n">channel_models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">channel_model</span><span class="o">.</span><span class="n">add_routingmodel_v1</span><span class="p">(</span><span class="s2">&quot;sw1d_q_in&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">q_model</span><span class="p">:</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">q_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
            <span class="n">control</span><span class="o">.</span><span class="n">lengthdownstream</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">timestepfactor</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">channel_model</span><span class="o">.</span><span class="n">add_routingmodel_v2</span><span class="p">(</span><span class="s2">&quot;sw1d_lias&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">lias_model</span><span class="p">:</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">lias_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
            <span class="n">control</span><span class="o">.</span><span class="n">lengthupstream</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">lengthdownstream</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">stricklercoefficient</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.03</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">timestepfactor</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">diffusionfactor</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">lias_model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">discharge</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">channel_model</span> <span class="o">=</span> <span class="n">channel_models</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">channel_model</span><span class="o">.</span><span class="n">add_routingmodel_v3</span><span class="p">(</span><span class="s2">&quot;sw1d_gate_out&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">gate_model</span><span class="p">:</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">gate_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
        <span class="n">control</span><span class="o">.</span><span class="n">lengthupstream</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">bottomlevel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">gateheight</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">gatewidth</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">flowcoefficient</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">timestepfactor</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">dampingradius</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">channel_model</span> <span class="ow">in</span> <span class="n">channel_models</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">submodel</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">channel_model</span><span class="o">.</span><span class="n">storagemodels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">channel_model</span><span class="o">.</span><span class="n">routingmodels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">channel_model</span><span class="o">.</span><span class="n">routingmodels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">submodel</span><span class="p">,</span> <span class="s2">&quot;add_crosssection_v2&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">submodel</span><span class="o">.</span><span class="n">add_crosssection_v2</span><span class="p">(</span><span class="s2">&quot;wq_trapeze&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">trapeze_model</span><span class="p">:</span>
                    <span class="n">control</span> <span class="o">=</span> <span class="n">trapeze_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">control</span>
                    <span class="n">control</span><span class="o">.</span><span class="n">nmbtrapezes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">control</span><span class="o">.</span><span class="n">bottomlevels</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">control</span><span class="o">.</span><span class="n">bottomwidths</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
                    <span class="n">control</span><span class="o">.</span><span class="n">sideslopes</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># pylint: disable=unbalanced-tuple-unpacking</span>
    <span class="n">g11</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">g12</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">g21</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">g22</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">g31</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">gr_models</span>
    <span class="n">s1</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">s2</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">s3</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">sluice_models</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">c3</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">channel_models</span>

    <span class="n">hp</span><span class="o">.</span><span class="n">update_devices</span><span class="p">(</span>
        <span class="c1"># fmt: off</span>
        <span class="n">nodes</span><span class="o">=</span><span class="p">(</span>
            <span class="n">g11_s1</span><span class="p">,</span> <span class="n">g21_s2</span><span class="p">,</span> <span class="n">g12_c1</span><span class="p">,</span> <span class="n">g22_c2</span><span class="p">,</span> <span class="n">g31_s3</span><span class="p">,</span> <span class="n">s1_c1</span><span class="p">,</span> <span class="n">s2_c2</span><span class="p">,</span> <span class="n">s3_c3</span><span class="p">,</span>
            <span class="n">c1_c3</span><span class="p">,</span> <span class="n">c2_c3</span><span class="p">,</span> <span class="n">c3_out</span><span class="p">,</span> <span class="n">c1_s1</span><span class="p">,</span> <span class="n">c2_s2</span><span class="p">,</span> <span class="n">c3_s3</span><span class="p">,</span> <span class="n">no_s1</span><span class="p">,</span> <span class="n">out_c3_s1</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># fmt: on</span>
        <span class="n">elements</span><span class="o">=</span><span class="p">(</span><span class="n">g11</span><span class="p">,</span> <span class="n">g12</span><span class="p">,</span> <span class="n">g21</span><span class="p">,</span> <span class="n">g22</span><span class="p">,</span> <span class="n">g31</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">hp</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>

    <span class="n">hp</span><span class="o">.</span><span class="n">prepare_allseries</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">gr_model</span> <span class="ow">in</span> <span class="n">gr_models</span><span class="p">:</span>
        <span class="n">gr_model</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">gr_model</span><span class="o">.</span><span class="n">petmodel</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">referenceevapotranspiration</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">out_c3_s1</span><span class="o">.</span><span class="n">deploymode</span> <span class="o">=</span> <span class="s2">&quot;oldsim&quot;</span>
    <span class="n">out_c3_s1</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hp</span><span class="p">,</span> <span class="n">hydpy</span><span class="o">.</span><span class="n">pub</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HydPy 6.2dev6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hydpy.core.testtools</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2013-2025, HydPy Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>